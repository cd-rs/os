<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.30">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Kernel – OS in Rust</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./41_boot.html" rel="next">
<link href="./32_r5.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-a4a11d514c7d463668e07712114998e6.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-fc9c1a4fc1048689359919db0170c3de.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./40_kernel.html">Kernel</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">OS in Rust</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./00_derust.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Derust</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_wc.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">wc</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_cli.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">CLI</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11_unsafe.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Unsafe</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12_split_at.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Splits</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./20_os.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">OS</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./21_xmute.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Transmute</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./22_malloc.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">malloc</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./30_metal.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bare Metal</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./31_linker.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Linker</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./32_r5.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">RISC-V</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./40_kernel.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Kernel</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./41_boot.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Boot</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./42_hello.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Hello</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./50_test.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Text</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./50_text.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Text</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./51_format.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Format</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./52_graphics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Graphics</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#announcements" id="toc-announcements" class="nav-link active" data-scroll-target="#announcements">Announcements</a></li>
  <li><a href="#today" id="toc-today" class="nav-link" data-scroll-target="#today">Today</a></li>
  <li><a href="#citations" id="toc-citations" class="nav-link" data-scroll-target="#citations">Citations</a></li>
  <li><a href="#background" id="toc-background" class="nav-link" data-scroll-target="#background">Background</a>
  <ul class="collapse">
  <li><a href="#the-boot-process" id="toc-the-boot-process" class="nav-link" data-scroll-target="#the-boot-process">The Boot Process</a></li>
  <li><a href="#first-steps" id="toc-first-steps" class="nav-link" data-scroll-target="#first-steps">First Steps</a></li>
  <li><a href="#firmware" id="toc-firmware" class="nav-link" data-scroll-target="#firmware">Firmware</a></li>
  <li><a href="#enter-the-cpu" id="toc-enter-the-cpu" class="nav-link" data-scroll-target="#enter-the-cpu">Enter the CPU</a></li>
  <li><a href="#not-code-but-ware" id="toc-not-code-but-ware" class="nav-link" data-scroll-target="#not-code-but-ware">Not “code” but “ware”</a></li>
  <li><a href="#enter-the-os" id="toc-enter-the-os" class="nav-link" data-scroll-target="#enter-the-os">Enter the OS</a></li>
  <li><a href="#what-it-sounds-like" id="toc-what-it-sounds-like" class="nav-link" data-scroll-target="#what-it-sounds-like">What it sounds like</a></li>
  <li><a href="#aside" id="toc-aside" class="nav-link" data-scroll-target="#aside">Aside</a></li>
  <li><a href="#competing-standards" id="toc-competing-standards" class="nav-link" data-scroll-target="#competing-standards">Competing Standards</a></li>
  <li><a href="#competing-standards-1" id="toc-competing-standards-1" class="nav-link" data-scroll-target="#competing-standards-1">Competing Standards</a></li>
  <li><a href="#bios-boot" id="toc-bios-boot" class="nav-link" data-scroll-target="#bios-boot">BIOS Boot</a></li>
  <li><a href="#upsides" id="toc-upsides" class="nav-link" data-scroll-target="#upsides">Upsides</a></li>
  <li><a href="#bootable-disks" id="toc-bootable-disks" class="nav-link" data-scroll-target="#bootable-disks">Bootable Disks</a></li>
  <li><a href="#bootlaoder" id="toc-bootlaoder" class="nav-link" data-scroll-target="#bootlaoder">Bootlaoder</a></li>
  <li><a href="#data-structures" id="toc-data-structures" class="nav-link" data-scroll-target="#data-structures">Data Structures</a></li>
  <li><a href="#location-location" id="toc-location-location" class="nav-link" data-scroll-target="#location-location">Location, Location</a></li>
  <li><a href="#booting-the-os" id="toc-booting-the-os" class="nav-link" data-scroll-target="#booting-the-os">Booting the OS</a></li>
  <li><a href="#switcheroo" id="toc-switcheroo" class="nav-link" data-scroll-target="#switcheroo">Switcheroo</a></li>
  <li><a href="#hand-wave" id="toc-hand-wave" class="nav-link" data-scroll-target="#hand-wave">Hand-wave</a></li>
  </ul></li>
  <li><a href="#kernel" id="toc-kernel" class="nav-link" data-scroll-target="#kernel">Kernel</a>
  <ul class="collapse">
  <li><a href="#a-minimal-kernel" id="toc-a-minimal-kernel" class="nav-link" data-scroll-target="#a-minimal-kernel">A Minimal Kernel</a></li>
  <li><a href="#target-triple" id="toc-target-triple" class="nav-link" data-scroll-target="#target-triple">Target Triple</a></li>
  <li><a href="#our-target" id="toc-our-target" class="nav-link" data-scroll-target="#our-target">Our Target</a></li>
  <li><a href="#json" id="toc-json" class="nav-link" data-scroll-target="#json">JSON</a></li>
  <li><a href="#some-context" id="toc-some-context" class="nav-link" data-scroll-target="#some-context">Some context</a></li>
  <li><a href="#arm64-take-notes" id="toc-arm64-take-notes" class="nav-link" data-scroll-target="#arm64-take-notes">ARM64 Take Notes</a></li>
  <li><a href="#changes" id="toc-changes" class="nav-link" data-scroll-target="#changes">Changes</a></li>
  <li><a href="#linking" id="toc-linking" class="nav-link" data-scroll-target="#linking">Linking</a></li>
  <li><a href="#panic-abort" id="toc-panic-abort" class="nav-link" data-scroll-target="#panic-abort">Panic Abort</a></li>
  <li><a href="#target-vs.-toml" id="toc-target-vs.-toml" class="nav-link" data-scroll-target="#target-vs.-toml">Target vs.&nbsp;TOML</a></li>
  <li><a href="#red-zone" id="toc-red-zone" class="nav-link" data-scroll-target="#red-zone">Red Zone</a></li>
  <li><a href="#ancient-nemesis" id="toc-ancient-nemesis" class="nav-link" data-scroll-target="#ancient-nemesis">Ancient Nemesis</a></li>
  <li><a href="#turn-off-floats" id="toc-turn-off-floats" class="nav-link" data-scroll-target="#turn-off-floats">Turn off floats</a></li>
  <li><a href="#mmxsse" id="toc-mmxsse" class="nav-link" data-scroll-target="#mmxsse">MMX/SSE</a></li>
  <li><a href="#soft-float" id="toc-soft-float" class="nav-link" data-scroll-target="#soft-float">Soft Float</a></li>
  <li><a href="#aside-1" id="toc-aside-1" class="nav-link" data-scroll-target="#aside-1">Aside</a></li>
  <li><a href="#altogether" id="toc-altogether" class="nav-link" data-scroll-target="#altogether">Altogether</a></li>
  <li><a href="#i-just-curl" id="toc-i-just-curl" class="nav-link" data-scroll-target="#i-just-curl">I just <code>curl</code></a></li>
  <li><a href="#tree" id="toc-tree" class="nav-link" data-scroll-target="#tree">Tree</a></li>
  <li><a href="#back-to-loops" id="toc-back-to-loops" class="nav-link" data-scroll-target="#back-to-loops">Back to loops</a></li>
  <li><a href="#current-main" id="toc-current-main" class="nav-link" data-scroll-target="#current-main">Current main</a></li>
  <li><a href="#a-note" id="toc-a-note" class="nav-link" data-scroll-target="#a-note">A note</a></li>
  <li><a href="#linux-everywhere" id="toc-linux-everywhere" class="nav-link" data-scroll-target="#linux-everywhere">Linux Everywhere</a></li>
  <li><a href="#build-it" id="toc-build-it" class="nav-link" data-scroll-target="#build-it">Build it</a></li>
  <li><a href="#aside-2" id="toc-aside-2" class="nav-link" data-scroll-target="#aside-2">Aside</a></li>
  <li><a href="#okay-so" id="toc-okay-so" class="nav-link" data-scroll-target="#okay-so">Okay so</a></li>
  <li><a href="#fix-it" id="toc-fix-it" class="nav-link" data-scroll-target="#fix-it">Fix it?</a></li>
  <li><a href="#now-it-works" id="toc-now-it-works" class="nav-link" data-scroll-target="#now-it-works">Now it works</a></li>
  <li><a href="#the-core" id="toc-the-core" class="nav-link" data-scroll-target="#the-core">The Core</a></li>
  <li><a href="#wrong-core" id="toc-wrong-core" class="nav-link" data-scroll-target="#wrong-core">Wrong Core</a></li>
  <li><a href="#the-problem" id="toc-the-problem" class="nav-link" data-scroll-target="#the-problem">The Problem</a></li>
  <li><a href="#config" id="toc-config" class="nav-link" data-scroll-target="#config">Config</a></li>
  <li><a href="#check-in" id="toc-check-in" class="nav-link" data-scroll-target="#check-in">Check in</a></li>
  <li><a href="#the-build-std-option" id="toc-the-build-std-option" class="nav-link" data-scroll-target="#the-build-std-option">The <code>build-std</code> Option</a></li>
  <li><a href="#my-config" id="toc-my-config" class="nav-link" data-scroll-target="#my-config">My Config</a></li>
  <li><a href="#oh." id="toc-oh." class="nav-link" data-scroll-target="#oh.">Oh.</a></li>
  <li><a href="#unstable" id="toc-unstable" class="nav-link" data-scroll-target="#unstable">Unstable</a></li>
  <li><a href="#mental-model" id="toc-mental-model" class="nav-link" data-scroll-target="#mental-model">Mental model</a></li>
  <li><a href="#update-config" id="toc-update-config" class="nav-link" data-scroll-target="#update-config">Update config</a></li>
  <li><a href="#oh.-1" id="toc-oh.-1" class="nav-link" data-scroll-target="#oh.-1">Oh.</a></li>
  <li><a href="#nightly" id="toc-nightly" class="nav-link" data-scroll-target="#nightly">Nightly</a></li>
  <li><a href="#try-two-things" id="toc-try-two-things" class="nav-link" data-scroll-target="#try-two-things">Try Two Things</a></li>
  <li><a href="#try-two-things-1" id="toc-try-two-things-1" class="nav-link" data-scroll-target="#try-two-things-1">Try Two Things</a></li>
  <li><a href="#the-problem-1" id="toc-the-problem-1" class="nav-link" data-scroll-target="#the-problem-1">The Problem</a></li>
  <li><a href="#one-solution" id="toc-one-solution" class="nav-link" data-scroll-target="#one-solution">One Solution</a></li>
  <li><a href="#another-solution" id="toc-another-solution" class="nav-link" data-scroll-target="#another-solution">Another Solution</a></li>
  <li><a href="#the-error" id="toc-the-error" class="nav-link" data-scroll-target="#the-error">The error</a></li>
  <li><a href="#aside-3" id="toc-aside-3" class="nav-link" data-scroll-target="#aside-3">Aside</a></li>
  <li><a href="#revert" id="toc-revert" class="nav-link" data-scroll-target="#revert">Revert!</a></li>
  <li><a href="#aside-4" id="toc-aside-4" class="nav-link" data-scroll-target="#aside-4">Aside</a></li>
  <li><a href="#run-again" id="toc-run-again" class="nav-link" data-scroll-target="#run-again">Run again</a></li>
  <li><a href="#aside-nightly" id="toc-aside-nightly" class="nav-link" data-scroll-target="#aside-nightly">Aside: Nightly</a></li>
  <li><a href="#aside-notfutureproofing" id="toc-aside-notfutureproofing" class="nav-link" data-scroll-target="#aside-notfutureproofing">Aside: <span class="math inline">\(\not\)</span>Futureproofing</a></li>
  <li><a href="#aside-notfutureproofing-1" id="toc-aside-notfutureproofing-1" class="nav-link" data-scroll-target="#aside-notfutureproofing-1">Aside: <span class="math inline">\(\not\)</span>Futureproofing</a></li>
  <li><a href="#boot-it" id="toc-boot-it" class="nav-link" data-scroll-target="#boot-it">Boot it</a></li>
  <li><a href="#boot-it-1" id="toc-boot-it-1" class="nav-link" data-scroll-target="#boot-it-1">Boot it</a></li>
  </ul></li>
  <li><a href="#fin" id="toc-fin" class="nav-link" data-scroll-target="#fin">Fin</a>
  <ul class="collapse">
  <li><a href="#main-file" id="toc-main-file" class="nav-link" data-scroll-target="#main-file">Main File</a></li>
  <li><a href="#config-file" id="toc-config-file" class="nav-link" data-scroll-target="#config-file">Config File</a></li>
  <li><a href="#target-file" id="toc-target-file" class="nav-link" data-scroll-target="#target-file">Target File</a></li>
  <li><a href="#cargo-file" id="toc-cargo-file" class="nav-link" data-scroll-target="#cargo-file">Cargo File</a></li>
  </ul></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="40_kernel.rjs.html"><i class="bi bi-file-slides"></i>RevealJS</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Kernel</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i></button></div></div>
<p class="subtitle lead">OS in Rust</p>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="announcements" class="level2">
<h2 class="anchored" data-anchor-id="announcements">Announcements</h2>
<ul>
<li><strong>Action Items</strong>:
<ul>
<li>Is <code>qemu</code> working at all.
<ul>
<li>The coolest assignment ever for a second week in a row.</li>
<li>I’m glad you all love it</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="today" class="level2">
<h2 class="anchored" data-anchor-id="today">Today</h2>
<ul>
<li>Background</li>
<li>Kernel</li>
</ul>
</section>
<section id="citations" class="level2">
<h2 class="anchored" data-anchor-id="citations">Citations</h2>
<ul>
<li>Outright theft:
<ul>
<li><a href="https://os.phil-opp.com/minimal-rust-kernel/">A Minimal Rust Kernel</a></li>
</ul></li>
</ul>
</section>
<section id="background" class="level1">
<h1>Background</h1>
<section id="the-boot-process" class="level2">
<h2 class="anchored" data-anchor-id="the-boot-process">The Boot Process</h2>
<ul>
<li>POV: You are an inanimate piece of silicon.
<ul>
<li>You contain wires connected to logic gates.</li>
<li>Somewhere, a switch is flipped.</li>
<li>Electrons flow into some of your wires, through some gates.</li>
</ul></li>
</ul>
</section>
<section id="first-steps" class="level2">
<h2 class="anchored" data-anchor-id="first-steps">First Steps</h2>
<ul>
<li>What determines the initial arrangement of gates?</li>
<li>Where do electrons flow?</li>
<li>This is determined by the <em>boot process</em>
<ul>
<li>Occurs on <em>every</em> power-up</li>
<li>Determined by <em>hardware</em> design</li>
<li>More fundamental than the OS</li>
</ul></li>
</ul>
</section>
<section id="firmware" class="level2">
<h2 class="anchored" data-anchor-id="firmware">Firmware</h2>
<ul>
<li>What is between hardware and software?
<ul>
<li>Firmware.</li>
</ul></li>
<li>On power-up, devices execute code embedded in physical read only memory (ROM).
<ul>
<li>Read more: <a href="https://en.wikipedia.org/wiki/Read-only_memory">ROM</a></li>
</ul></li>
<li>Is it software? Is it hardware? Who can say.</li>
</ul>
</section>
<section id="enter-the-cpu" class="level2">
<h2 class="anchored" data-anchor-id="enter-the-cpu">Enter the CPU</h2>
<ul>
<li>Usually, power-up occurs on a “motherboard” hosting, among other things, the bus.
<ul>
<li>Named “mother” after the “MU/TH/UR” on ship computer in <em>Alien</em> (1979)</li>
<li>This is a lie.</li>
</ul></li>
</ul>
</section>
<section id="not-code-but-ware" class="level2">
<h2 class="anchored" data-anchor-id="not-code-but-ware">Not “code” but “ware”</h2>
<ul>
<li>So firmware isn’t really like CPU code (like Rust or C), but it does:
<ul>
<li>Tell circuitry where to direct electrons within the CPU.</li>
<li>Also wake up e.g.&nbsp;the MMU.</li>
</ul></li>
</ul>
</section>
<section id="enter-the-os" class="level2">
<h2 class="anchored" data-anchor-id="enter-the-os">Enter the OS</h2>
<ul>
<li>With the CPU primed but not yet ticking through clock cycles, all that remains is to either
<ul>
<li>Execute a bare metal executable, or</li>
<li>Boot an operating system to enable the next higher-level task.</li>
</ul></li>
</ul>
</section>
<section id="what-it-sounds-like" class="level2">
<h2 class="anchored" data-anchor-id="what-it-sounds-like">What it sounds like</h2>
<ul>
<li>We regard, then, the operating system as a <em>system</em> which <em>operates</em> the <em>hardware</em> on behalf of higher level <em>software</em>.
<ul>
<li>Hence, “systems computing”.</li>
<li>Hopefully the contrast to software is a bit more clear here.</li>
</ul></li>
</ul>
</section>
<section id="aside" class="level2">
<h2 class="anchored" data-anchor-id="aside">Aside</h2>
<ul>
<li>I am supposed to teach you about the “power-on self-test”.</li>
<li>A bit electrical engineering for me.</li>
</ul>
<blockquote class="blockquote">
<p><a href="https://en.wikipedia.org/wiki/Power-on_self-test">A <strong>power-on self-test</strong> (POST) is a process performed by firmware or software routines immediately after a computer or other digital electronic device is powered on.</a></p>
</blockquote>
<ul>
<li>Neat! Moving on.</li>
</ul>
</section>
<section id="competing-standards" class="level2">
<h2 class="anchored" data-anchor-id="competing-standards">Competing Standards</h2>
<ul>
<li>Lucky us, there is no widely agreed upon way to do firmware.</li>
<li>There’s the cool, old way that doesn’t work well but is easy.
<ul>
<li>“Basic Input/Output System“ <a href="https://en.wikipedia.org/wiki/BIOS"><strong>BIOS</strong></a></li>
<li>1981</li>
</ul></li>
</ul>
</section>
<section id="competing-standards-1" class="level2">
<h2 class="anchored" data-anchor-id="competing-standards-1">Competing Standards</h2>
<ul>
<li>There’s the new way that is too hard to use for normal people like us.
<ul>
<li>As in people who do anything else ever.</li>
<li>It’s good though we promise.</li>
<li>“Unified Extensible Firmware Interface” <a href="https://en.wikipedia.org/wiki/Unified_Extensible_Firmware_Interface"><strong>UEFI</strong></a>.</li>
<li>May make you use it for a lab. <a href="https://github.com/le-jzr/sisyphos-kernel-uefi-x86_64">More.</a></li>
<li>2006</li>
</ul></li>
</ul>
</section>
<section id="bios-boot" class="level2">
<h2 class="anchored" data-anchor-id="bios-boot">BIOS Boot</h2>
<ul>
<li>I actually started fooling around with the BIOS before UEFI even existed.
<ul>
<li>I was a normal kid though 100%.</li>
</ul></li>
<li>Fortunately it’s still basically around. Quoth Blog:</li>
</ul>
<blockquote class="blockquote">
<p>This is great, because you can use the same boot logic across all machines from the last century.</p>
</blockquote>
</section>
<section id="upsides" class="level2">
<h2 class="anchored" data-anchor-id="upsides">Upsides</h2>
<ul>
<li>Blog says it’s a downside that this means you have to do 16-bit mode.
<ul>
<li>I say: that’s cool.</li>
<li>I can’t count higher than about 0xFFFF anyways.</li>
</ul></li>
<li>The blog impolitely calls 1980s bootloaders “archaic” instead of “vintage”, “retro”, or “foundational”.</li>
</ul>
</section>
<section id="bootable-disks" class="level2">
<h2 class="anchored" data-anchor-id="bootable-disks">Bootable Disks</h2>
<ul>
<li>I should also tell you about <em>bootable disks</em></li>
<li>Nowadays we all boot from SSD or rarely HDD.</li>
<li>But you have probably at some point booted from USB.
<ul>
<li>Usually when removing a virus like Microsoft Windows from your system.</li>
</ul></li>
<li>Olden days computers could boot from floppy disks, etc.</li>
</ul>
</section>
<section id="bootlaoder" class="level2">
<h2 class="anchored" data-anchor-id="bootlaoder">Bootlaoder</h2>
<ul>
<li>I mentioned 1980s bootloaders.
<ul>
<li>No relation to bootleggers or boatloaders.</li>
</ul></li>
<li>512-byte portion of executable code stored at the bootable disk’s “beginning”.
<ul>
<li>On a HDD this is physically the outermost ring of addressable magnetic regions.</li>
<li>I don’t know how SSDs work as Samsung, SK Hynix, or Micron (shout out Boise).</li>
</ul></li>
</ul>
</section>
<section id="data-structures" class="level2">
<h2 class="anchored" data-anchor-id="data-structures">Data Structures</h2>
<ul>
<li>Most bootloaders are larger than 512 bytes.</li>
<li>So bootloaders are commonly split into a 512 byte first stage that loads a latter stage.
<ul>
<li>This is why we should still be teaching linked lists, basically.</li>
</ul></li>
</ul>
</section>
<section id="location-location" class="level2">
<h2 class="anchored" data-anchor-id="location-location">Location, Location</h2>
<ul>
<li>The bootloader lives in a reserved physical (HDD) or logical (SSD) location.</li>
<li>Does the OS?
<ul>
<li>With respect to itself, yes, the OS probably says it lives at memory location zero.</li>
<li>With respect to underlying hardware? Probably not.
<ul>
<li>Gotta find it.</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="booting-the-os" class="level2">
<h2 class="anchored" data-anchor-id="booting-the-os">Booting the OS</h2>
<ul>
<li>The bootloader has to determine the location of the <em>kernel image</em> on disk and load it into memory.
<ul>
<li>Basically this is the definition of the kernel, the minimal OS internal that runs first.</li>
<li>Image here means we have physical bits capturing some information, so copies of the bits may live in different places.
<ul>
<li>SSD and RAM, for example.</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="switcheroo" class="level2">
<h2 class="anchored" data-anchor-id="switcheroo">Switcheroo</h2>
<ul>
<li>The OS probably is not a 16-bit OS.
<ul>
<li>Unless? Lab idea? Hold me back!</li>
</ul></li>
<li>Big OS wants me to tell you that:
<ul>
<li>16-bit mode is called “real mode”</li>
<li>32-bit mode is called “protected mode”</li>
<li>64-bit mode is called “long mode”.</li>
</ul></li>
<li>Recall we were writing 64-bit bare metal.</li>
</ul>
</section>
<section id="hand-wave" class="level2">
<h2 class="anchored" data-anchor-id="hand-wave">Hand-wave</h2>
<blockquote class="blockquote">
<p>Writing a bootloader is a bit cumbersome as it requires assembly language and “write this magic value to this processor register”.</p>
</blockquote>
<blockquote class="blockquote">
<p>Instead use a <a href="https://github.com/rust-osdev/bootimage">bootimage</a> that automatically prepends a bootloader to your kernel.</p>
</blockquote>
<ul>
<li>This is called “cheating” and is a good way to get ahead in life.</li>
</ul>
<!--

## The Multiboot Standard

To avoid that every operating system implements its own bootloader, which is only compatible with a single OS, the [Free Software Foundation] created an open bootloader standard called [Multiboot] in 1995. The standard defines an interface between the bootloader and the operating system, so that any Multiboot-compliant bootloader can load any Multiboot-compliant operating system. The reference implementation is [GNU GRUB], which is the most popular bootloader for Linux systems.

[Free Software Foundation]: https://en.wikipedia.org/wiki/Free_Software_Foundation
[Multiboot]: https://wiki.osdev.org/Multiboot
[GNU GRUB]: https://en.wikipedia.org/wiki/GNU_GRUB

To make a kernel Multiboot compliant, one just needs to insert a so-called [Multiboot header] at the beginning of the kernel file. This makes it very easy to boot an OS from GRUB. However, GRUB and the Multiboot standard have some problems too:

[Multiboot header]: https://www.gnu.org/software/grub/manual/multiboot/multiboot.html#OS-image-format

- They support only the 32-bit protected mode. This means that you still have to do the CPU configuration to switch to the 64-bit long mode.
- They are designed to make the bootloader simple instead of the kernel. For example, the kernel needs to be linked with an [adjusted default page size], because GRUB can't find the Multiboot header otherwise. Another example is that the [boot information], which is passed to the kernel, contains lots of architecture-dependent structures instead of providing clean abstractions.
- Both GRUB and the Multiboot standard are only sparsely documented.
- GRUB needs to be installed on the host system to create a bootable disk image from the kernel file. This makes development on Windows or Mac more difficult.

[adjusted default page size]: https://wiki.osdev.org/Multiboot#Multiboot_2
[boot information]: https://www.gnu.org/software/grub/manual/multiboot/multiboot.html#Boot-information-format

Because of these drawbacks, we decided to not use GRUB or the Multiboot standard. However, we plan to add Multiboot support to our [bootimage] tool, so that it's possible to load your kernel on a GRUB system too. If you're interested in writing a Multiboot compliant kernel, check out the [first edition] of this blog series.

[first edition]: @/edition-1/_index.md

-->
</section>
</section>
<section id="kernel" class="level1">
<h1>Kernel</h1>
<section id="a-minimal-kernel" class="level2">
<h2 class="anchored" data-anchor-id="a-minimal-kernel">A Minimal Kernel</h2>
<ul>
<li>Let’s make a kernel.</li>
<li>Specifically, a disk image that prints a “Hello World!” to the screen when booted.</li>
<li>We extending our bare metal executable.</li>
</ul>
<!--

## Installing Rust Nightly

Rust has three release channels: _stable_, _beta_, and _nightly_. The Rust Book explains the difference between these channels really well, so take a minute and [check it out](https://doc.rust-lang.org/book/appendix-07-nightly-rust.html#choo-choo-release-channels-and-riding-the-trains). For building an operating system, we will need some experimental features that are only available on the nightly channel, so we need to install a nightly version of Rust.

To manage Rust installations, I highly recommend [rustup]. It allows you to install nightly, beta, and stable compilers side-by-side and makes it easy to update them. With rustup, you can use a nightly compiler for the current directory by running `rustup override set nightly`. Alternatively, you can add a file called `rust-toolchain` with the content `nightly` to the project's root directory. You can check that you have a nightly version installed by running `rustc --version`: The version number should contain `-nightly` at the end.

[rustup]: https://www.rustup.rs/

The nightly compiler allows us to opt-in to various experimental features by using so-called _feature flags_ at the top of our file. For example, we could enable the experimental [`asm!` macro] for inline assembly by adding `#![feature(asm)]` to the top of our `main.rs`. Note that such experimental features are completely unstable, which means that future Rust versions might change or remove them without prior warning. For this reason, we will only use them if absolutely necessary.

[`asm!` macro]: https://doc.rust-lang.org/stable/reference/inline-assembly.html

-->
</section>
<section id="target-triple" class="level2">
<h2 class="anchored" data-anchor-id="target-triple">Target Triple</h2>
<ul>
<li>We recall the “<a href="31_linker.md#target-triple">target triple</a>”</li>
<li>Imagine <code>host</code> triple is <code>x86_64-unknown-linux-gnu</code>
<ul>
<li>CPU architecture (<code>x86_64</code>),</li>
<li>Vendor (<code>unknown</code>) - It’s Intel #Portland</li>
<li>Operating system (<code>linux</code>)</li>
<li>The <a href="https://en.wikipedia.org/wiki/Application_binary_interface">ABI</a> (<code>gnu</code>).</li>
</ul></li>
</ul>
</section>
<section id="our-target" class="level2">
<h2 class="anchored" data-anchor-id="our-target">Our Target</h2>
<ul>
<li>I am aware of no existing target triple suitable for this course.</li>
<li>So, make our own.</li>
<li>It’s not too bad, just JSON.
<ul>
<li>We’ll specify some easy stuff, like architecture.</li>
<li>Some weird stuff, like manual memory layouts.</li>
<li>And get on with things.</li>
</ul></li>
</ul>
</section>
<section id="json" class="level2">
<h2 class="anchored" data-anchor-id="json">JSON</h2>
<ul>
<li>JSON rules by the way.</li>
</ul>
<div class="sourceCode" id="cb1"><pre class="sourceCode numberSource json number-lines code-with-copy"><code class="sourceCode json"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">{</span></span>
<span id="cb1-2"><a href="#cb1-2"></a>    <span class="dt">"llvm-target"</span><span class="fu">:</span> <span class="st">"x86_64-unknown-linux-gnu"</span><span class="fu">,</span></span>
<span id="cb1-3"><a href="#cb1-3"></a>    <span class="dt">"data-layout"</span><span class="fu">:</span> <span class="st">"e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-i128:128-f80:128-n8:16:32:64-S128"</span><span class="fu">,</span></span>
<span id="cb1-4"><a href="#cb1-4"></a>    <span class="dt">"arch"</span><span class="fu">:</span> <span class="st">"x86_64"</span><span class="fu">,</span></span>
<span id="cb1-5"><a href="#cb1-5"></a>    <span class="dt">"target-endian"</span><span class="fu">:</span> <span class="st">"little"</span><span class="fu">,</span></span>
<span id="cb1-6"><a href="#cb1-6"></a>    <span class="dt">"target-pointer-width"</span><span class="fu">:</span> <span class="dv">64</span><span class="fu">,</span></span>
<span id="cb1-7"><a href="#cb1-7"></a>    <span class="dt">"target-c-int-width"</span><span class="fu">:</span> <span class="dv">32</span><span class="fu">,</span></span>
<span id="cb1-8"><a href="#cb1-8"></a>    <span class="dt">"os"</span><span class="fu">:</span> <span class="st">"linux"</span><span class="fu">,</span></span>
<span id="cb1-9"><a href="#cb1-9"></a>    <span class="dt">"executables"</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb1-10"><a href="#cb1-10"></a>    <span class="dt">"linker-flavor"</span><span class="fu">:</span> <span class="st">"gcc"</span><span class="fu">,</span></span>
<span id="cb1-11"><a href="#cb1-11"></a>    <span class="dt">"pre-link-args"</span><span class="fu">:</span> <span class="ot">[</span><span class="st">"-m64"</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb1-12"><a href="#cb1-12"></a>    <span class="dt">"morestack"</span><span class="fu">:</span> <span class="kw">false</span></span>
<span id="cb1-13"><a href="#cb1-13"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="some-context" class="level2">
<h2 class="anchored" data-anchor-id="some-context">Some context</h2>
<ul>
<li>Most fields are required by LLVM.</li>
<li>Data layout field defines the size of integer, float (ew), and pointer types.</li>
<li>Rust uses conditional compilation, such as via <code>target-pointer-width</code>.</li>
<li>The <code>pre-link-args</code> field specifies arguments passed to the linker.</li>
</ul>
</section>
<section id="arm64-take-notes" class="level2">
<h2 class="anchored" data-anchor-id="arm64-take-notes">ARM64 Take Notes</h2>
<ul>
<li>We also target <code>x86_64</code>.</li>
<li>Start here:</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>x86_64-osirs.json</strong></pre>
</div>
<div class="sourceCode" id="cb2" data-filename="x86_64-osirs.json"><pre class="sourceCode numberSource json number-lines code-with-copy"><code class="sourceCode json"><span id="cb2-1"><a href="#cb2-1"></a><span class="fu">{</span></span>
<span id="cb2-2"><a href="#cb2-2"></a>    <span class="dt">"llvm-target"</span><span class="fu">:</span> <span class="st">"x86_64-unknown-none"</span><span class="fu">,</span></span>
<span id="cb2-3"><a href="#cb2-3"></a>    <span class="dt">"data-layout"</span><span class="fu">:</span> <span class="st">"e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-i128:128-f80:128-n8:16:32:64-S128"</span><span class="fu">,</span></span>
<span id="cb2-4"><a href="#cb2-4"></a>    <span class="dt">"arch"</span><span class="fu">:</span> <span class="st">"x86_64"</span><span class="fu">,</span></span>
<span id="cb2-5"><a href="#cb2-5"></a>    <span class="dt">"target-endian"</span><span class="fu">:</span> <span class="st">"little"</span><span class="fu">,</span></span>
<span id="cb2-6"><a href="#cb2-6"></a>    <span class="dt">"target-pointer-width"</span><span class="fu">:</span> <span class="dv">64</span><span class="fu">,</span></span>
<span id="cb2-7"><a href="#cb2-7"></a>    <span class="dt">"target-c-int-width"</span><span class="fu">:</span> <span class="dv">32</span><span class="fu">,</span></span>
<span id="cb2-8"><a href="#cb2-8"></a>    <span class="dt">"os"</span><span class="fu">:</span> <span class="st">"none"</span><span class="fu">,</span></span>
<span id="cb2-9"><a href="#cb2-9"></a>    <span class="dt">"executables"</span><span class="fu">:</span> <span class="kw">true</span></span>
<span id="cb2-10"><a href="#cb2-10"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="changes" class="level2">
<h2 class="anchored" data-anchor-id="changes">Changes</h2>
<ul>
<li>Note that we changed the OS in the <code>llvm-target</code> and the <code>os</code> field to <code>none</code>, because we will run on bare metal.</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>x86_64-osirs.json</strong></pre>
</div>
<div class="sourceCode" id="cb3" data-filename="x86_64-osirs.json"><pre class="sourceCode numberSource json number-lines code-with-copy"><code class="sourceCode json"><span id="cb3-1"><a href="#cb3-1"></a><span class="fu">{</span></span>
<span id="cb3-2"><a href="#cb3-2"></a>    <span class="dt">"llvm-target"</span><span class="fu">:</span> <span class="st">"x86_64-unknown-none"</span><span class="fu">,</span></span>
<span id="cb3-3"><a href="#cb3-3"></a>    <span class="er">...</span></span>
<span id="cb3-4"><a href="#cb3-4"></a>    <span class="dt">"os"</span><span class="fu">:</span> <span class="st">"none"</span><span class="fu">,</span></span>
<span id="cb3-5"><a href="#cb3-5"></a>    <span class="er">...</span></span>
<span id="cb3-6"><a href="#cb3-6"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="linking" class="level2">
<h2 class="anchored" data-anchor-id="linking">Linking</h2>
<ul>
<li>We’ll add the following build-related entries:</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>x86_64-osirs.json</strong></pre>
</div>
<div class="sourceCode" id="cb4" data-filename="x86_64-osirs.json"><pre class="sourceCode numberSource json number-lines code-with-copy"><code class="sourceCode json"><span id="cb4-1"><a href="#cb4-1"></a><span class="fu">{</span></span>
<span id="cb4-2"><a href="#cb4-2"></a>    <span class="dt">"linker-flavor"</span><span class="fu">:</span> <span class="st">"ld.lld"</span><span class="fu">,</span></span>
<span id="cb4-3"><a href="#cb4-3"></a>    <span class="dt">"linker"</span><span class="fu">:</span> <span class="st">"rust-lld"</span><span class="fu">,</span></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>For OS-agnosticism, we use the cross-platform “LLD” linker that is shipped with Rust for linking our kernel.
<ul>
<li><a href="https://lld.llvm.org/">More.</a></li>
</ul></li>
</ul>
</section>
<section id="panic-abort" class="level2">
<h2 class="anchored" data-anchor-id="panic-abort">Panic Abort</h2>
<ul>
<li>You know how I feel about unwinding.
<ul>
<li>I have never relaxed in my life.</li>
<li>I’ve only panicked and given up.</li>
</ul></li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>x86_64-osirs.json</strong></pre>
</div>
<div class="sourceCode" id="cb5" data-filename="x86_64-osirs.json"><pre class="sourceCode numberSource json number-lines code-with-copy"><code class="sourceCode json"><span id="cb5-1"><a href="#cb5-1"></a><span class="fu">{</span></span>
<span id="cb5-2"><a href="#cb5-2"></a>    <span class="dt">"panic-strategy"</span><span class="fu">:</span> <span class="st">"abort"</span><span class="fu">,</span></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="target-vs.-toml" class="level2">
<h2 class="anchored" data-anchor-id="target-vs.-toml">Target vs.&nbsp;TOML</h2>
<ul>
<li>This has the same effect as the <code>panic = "abort"</code> option in our Cargo.toml</li>
<li>So we can remove it from there!</li>
<li>This is better though:
<ul>
<li>We will use <code>core</code>, an architecture specific library, and we need <code>core</code> to <em>also</em> panic abort.</li>
<li><a href="https://doc.rust-lang.org/core/">“It is the portable glue between the language and its libraries, defining the intrinsic and primitive building blocks of all Rust code.”</a></li>
</ul></li>
</ul>
</section>
<section id="red-zone" class="level2">
<h2 class="anchored" data-anchor-id="red-zone">Red Zone</h2>
<ul>
<li>Okay red zone is not particularly relevant to this class.</li>
<li>But it is <em>extremely</em> cool.</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>x86_64-osirs.json</strong></pre>
</div>
<div class="sourceCode" id="cb6" data-filename="x86_64-osirs.json"><pre class="sourceCode numberSource json number-lines code-with-copy"><code class="sourceCode json"><span id="cb6-1"><a href="#cb6-1"></a><span class="fu">{</span></span>
<span id="cb6-2"><a href="#cb6-2"></a>    <span class="dt">"disable-redzone"</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!--

- So I'm going to tell you about it.

## The Red Zone

- The **Red Zone** is a 128-byte optimization area below the current stack pointer ($RSP$).
    - "R" for 64 bit.
    - "SP" for "stack pointer"
- It is a specific feature of the x86-64 System V ABI (Application Binary Interface).
- It allows functions to use a small amount of stack space without actually moving the pointer.

## Performance Gains

- Normally, any data written to the stack requires an $RSP$ adjustment to prevent data corruption.
    - `sub rsp, 8`
    - `mov [rsp], rax`
- With the Red Zone, compilers can skip the subtraction for some functions.
- This reduces the number of instructions and speeds up function execution.
    - At the cost of *no longer tracking the stack*.

## Negative Indexing

- Since $RSP$ remains at the "top" of the stack, we access this memory using negative offsets.
- In assembly, this looks like `mov [rsp - 16], rax`.
- This treats the stack as a fixed-base array rather than a stack ADT.
- It is essentially "free" scratch space for short-lived data.

## The Danger of Interrupts

- The Red Zone is dangerous in kernel development because of **hardware interrupts**.
    - The OS has to deal with, say, someone hitting the power off button.
    - Someone plugging in a USB drive.
    - Lightning strikes.
    - Cosmic rays flipping bits
    
## Red Zone to Dead Zone
    
- When an interrupt occurs, the CPU pushes state (like $RIP$ and $RFLAGS$) onto the stack.
    - "Instruction pointer" and "flags".
- This will overwrite those 128 bytes of data.
- This leads to silent, non-deterministic memory corruption.
    - Generally regarded as bad.
    
## Read more

- There are good visuals here.
- [Read more](https://os.phil-opp.com/red-zone/)
- Handwaving now - Better for the compilers class I think!

-->
</section>
<section id="ancient-nemesis" class="level2">
<h2 class="anchored" data-anchor-id="ancient-nemesis">Ancient Nemesis</h2>
<ul>
<li>You all know I love floating point numbers.
<ul>
<li>And with good reason!</li>
</ul></li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>x86_64-osirs.json</strong></pre>
</div>
<div class="sourceCode" id="cb7" data-filename="x86_64-osirs.json"><pre class="sourceCode numberSource json number-lines code-with-copy"><code class="sourceCode json"><span id="cb7-1"><a href="#cb7-1"></a><span class="fu">{</span></span>
<span id="cb7-2"><a href="#cb7-2"></a>    <span class="dt">"features"</span><span class="fu">:</span> <span class="st">"-mmx,-sse,+soft-float"</span><span class="fu">,</span></span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="turn-off-floats" class="level2">
<h2 class="anchored" data-anchor-id="turn-off-floats">Turn off floats</h2>
<ul>
<li><code>features</code> enables/disables target features.</li>
<li>We disable the <code>mmx</code> and <code>sse</code> features by prefixing them with a minus</li>
<li>We enable the <code>soft-float</code> feature by prefixing it with a plus.</li>
<li>Note that there must be no spaces between different flags!</li>
</ul>
</section>
<section id="mmxsse" class="level2">
<h2 class="anchored" data-anchor-id="mmxsse">MMX/SSE</h2>
<ul>
<li>The <code>mmx</code> and <code>sse</code> features are performance optimizing vector operations from when Intel though they’d be able to hold off NVIDIA in the 90s.</li>
<li>These are braodly called <a href="https://en.wikipedia.org/wiki/SIMD">Single Instruction Multiple Data (SIMD)</a> instructions and are historically important.
<ul>
<li>Foundation of <code>numpy</code></li>
</ul></li>
<li>We aren’t using data frames in our kernel.</li>
</ul>
</section>
<section id="soft-float" class="level2">
<h2 class="anchored" data-anchor-id="soft-float">Soft Float</h2>
<ul>
<li>Floating point operations on <code>x86_64</code> require SIMD registers by default.
<ul>
<li>That’s right - floats are worse than you thought!</li>
</ul></li>
<li>To solve this problem, we add the <code>soft-float</code> feature, which emulates all floating point operations through software functions based on normal integers.
<ul>
<li>Just like <a href="https://cd-c89.github.io/rs/51_f16.html"><code>f16</code></a></li>
</ul></li>
</ul>
</section>
<section id="aside-1" class="level2">
<h2 class="anchored" data-anchor-id="aside-1">Aside</h2>
<ul>
<li>We also need to tell the Rust compiler <code>rustc</code> that we want to use the corresponding ABI.</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>x86_64-osirs.json</strong></pre>
</div>
<div class="sourceCode" id="cb8" data-filename="x86_64-osirs.json"><pre class="sourceCode numberSource json number-lines code-with-copy"><code class="sourceCode json"><span id="cb8-1"><a href="#cb8-1"></a><span class="fu">{</span></span>
<span id="cb8-2"><a href="#cb8-2"></a>    <span class="dt">"rustc-abi"</span><span class="fu">:</span> <span class="st">"x86-softfloat"</span></span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>I am 100% sure I can write an OS without hard or soft floats but I haven’t worked far enough ahead to be absolutely certain.</li>
</ul>
</section>
<section id="altogether" class="level2">
<h2 class="anchored" data-anchor-id="altogether">Altogether</h2>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>x86_64-osirs.json</strong></pre>
</div>
<div class="sourceCode" id="cb9" data-filename="x86_64-osirs.json"><pre class="sourceCode numberSource json number-lines code-with-copy"><code class="sourceCode json"><span id="cb9-1"><a href="#cb9-1"></a><span class="fu">{</span></span>
<span id="cb9-2"><a href="#cb9-2"></a>    <span class="dt">"llvm-target"</span><span class="fu">:</span> <span class="st">"x86_64-unknown-none"</span><span class="fu">,</span></span>
<span id="cb9-3"><a href="#cb9-3"></a>    <span class="dt">"data-layout"</span><span class="fu">:</span> <span class="st">"e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-i128:128-f80:128-n8:16:32:64-S128"</span><span class="fu">,</span></span>
<span id="cb9-4"><a href="#cb9-4"></a>    <span class="dt">"arch"</span><span class="fu">:</span> <span class="st">"x86_64"</span><span class="fu">,</span></span>
<span id="cb9-5"><a href="#cb9-5"></a>    <span class="dt">"target-endian"</span><span class="fu">:</span> <span class="st">"little"</span><span class="fu">,</span></span>
<span id="cb9-6"><a href="#cb9-6"></a>    <span class="dt">"target-pointer-width"</span><span class="fu">:</span> <span class="dv">64</span><span class="fu">,</span></span>
<span id="cb9-7"><a href="#cb9-7"></a>    <span class="dt">"target-c-int-width"</span><span class="fu">:</span> <span class="dv">32</span><span class="fu">,</span></span>
<span id="cb9-8"><a href="#cb9-8"></a>    <span class="dt">"os"</span><span class="fu">:</span> <span class="st">"none"</span><span class="fu">,</span></span>
<span id="cb9-9"><a href="#cb9-9"></a>    <span class="dt">"executables"</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb9-10"><a href="#cb9-10"></a>    <span class="dt">"linker-flavor"</span><span class="fu">:</span> <span class="st">"ld.lld"</span><span class="fu">,</span></span>
<span id="cb9-11"><a href="#cb9-11"></a>    <span class="dt">"linker"</span><span class="fu">:</span> <span class="st">"rust-lld"</span><span class="fu">,</span></span>
<span id="cb9-12"><a href="#cb9-12"></a>    <span class="dt">"panic-strategy"</span><span class="fu">:</span> <span class="st">"abort"</span><span class="fu">,</span></span>
<span id="cb9-13"><a href="#cb9-13"></a>    <span class="dt">"disable-redzone"</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb9-14"><a href="#cb9-14"></a>    <span class="dt">"features"</span><span class="fu">:</span> <span class="st">"-mmx,-sse,+soft-float"</span><span class="fu">,</span></span>
<span id="cb9-15"><a href="#cb9-15"></a>    <span class="dt">"rustc-abi"</span><span class="fu">:</span> <span class="st">"x86-softfloat"</span></span>
<span id="cb9-16"><a href="#cb9-16"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="i-just-curl" class="level2">
<h2 class="anchored" data-anchor-id="i-just-curl">I just <code>curl</code></h2>
<div class="sourceCode" id="cb10"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1"></a><span class="ex">curl</span> https://raw.githubusercontent.com/phil-opp/blog_os/refs/heads/post-02/x86_64-blog_os.json <span class="at">-o</span> x86_64-osirs.json</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="tree" class="level2">
<h2 class="anchored" data-anchor-id="tree">Tree</h2>
<ul>
<li>For me looks like this.</li>
</ul>
<div class="sourceCode" id="cb11"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1"></a><span class="ex">$</span> tree</span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="bu">.</span></span>
<span id="cb11-3"><a href="#cb11-3"></a><span class="ex">├──</span> Cargo.lock</span>
<span id="cb11-4"><a href="#cb11-4"></a><span class="ex">├──</span> Cargo.toml</span>
<span id="cb11-5"><a href="#cb11-5"></a><span class="ex">├──</span> src</span>
<span id="cb11-6"><a href="#cb11-6"></a><span class="ex">│&nbsp;&nbsp;</span> ├── main.rs</span>
<span id="cb11-7"><a href="#cb11-7"></a><span class="ex">│&nbsp;&nbsp;</span> └── old.rs</span>
<span id="cb11-8"><a href="#cb11-8"></a><span class="ex">└──</span> x86_64-osirs.json</span>
<span id="cb11-9"><a href="#cb11-9"></a></span>
<span id="cb11-10"><a href="#cb11-10"></a><span class="ex">1</span> directory, 5 files</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="back-to-loops" class="level2">
<h2 class="anchored" data-anchor-id="back-to-loops">Back to loops</h2>
<ul>
<li>By the way, I’ve switched from cool, good recursion back to unexciting, drab loops</li>
<li>Infinite recursion blows up the call stack and instantly segmentation faults.
<ul>
<li>This is because someone other than me wrote <code>rustc</code>.</li>
<li>I am not about to write <code>rustc</code>!</li>
</ul></li>
</ul>
</section>
<section id="current-main" class="level2">
<h2 class="anchored" data-anchor-id="current-main">Current main</h2>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/main.rs</strong></pre>
</div>
<div class="sourceCode" id="cb12" data-filename="src/main.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb12-1"><a href="#cb12-1"></a><span class="at">#![</span>no_std<span class="at">]</span></span>
<span id="cb12-2"><a href="#cb12-2"></a><span class="at">#![</span>no_main<span class="at">]</span></span>
<span id="cb12-3"><a href="#cb12-3"></a></span>
<span id="cb12-4"><a href="#cb12-4"></a><span class="at">#[</span><span class="kw">unsafe</span><span class="at">(</span>no_mangle<span class="at">)]</span></span>
<span id="cb12-5"><a href="#cb12-5"></a><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">"C"</span> <span class="kw">fn</span> _start() <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb12-6"><a href="#cb12-6"></a>    <span class="cf">loop</span> <span class="op">{}</span></span>
<span id="cb12-7"><a href="#cb12-7"></a><span class="op">}</span></span>
<span id="cb12-8"><a href="#cb12-8"></a></span>
<span id="cb12-9"><a href="#cb12-9"></a><span class="at">#[</span>panic_handler<span class="at">]</span></span>
<span id="cb12-10"><a href="#cb12-10"></a><span class="kw">fn</span> panic(_info<span class="op">:</span> <span class="op">&amp;</span><span class="pp">core::panic::</span>PanicInfo) <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb12-11"><a href="#cb12-11"></a>    <span class="cf">loop</span> <span class="op">{}</span></span>
<span id="cb12-12"><a href="#cb12-12"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="a-note" class="level2">
<h2 class="anchored" data-anchor-id="a-note">A note</h2>
<ul>
<li>Remember the earlier mention of <code>core</code>
<ul>
<li>How we need <code>core</code> to also panic abort?</li>
<li>We note when looking at <code>src/main.rs</code> we do have a <code>core</code> reference.</li>
</ul></li>
</ul>
</section>
<section id="linux-everywhere" class="level2">
<h2 class="anchored" data-anchor-id="linux-everywhere">Linux Everywhere</h2>
<ul>
<li>Okay so we aren’t going to use Linux on our device.</li>
<li>But we are going to use Linux <em>conventions</em>
<ul>
<li>Not Linux software, but Linux as a social technology.</li>
</ul></li>
<li>The <code>ld.lld</code> “linker-flavor” instructs LLVM to compile with the <code>-flavor gnu</code> flag.</li>
<li>This means that we need an entry point named <code>_start</code> - same as before!</li>
</ul>
</section>
<section id="build-it" class="level2">
<h2 class="anchored" data-anchor-id="build-it">Build it</h2>
<ul>
<li>I bet it will work now.
<ul>
<li>Use our new target by passing the name of the JSON file as <code>--target</code>:</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb13"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1"></a><span class="ex">$</span> cargo b <span class="at">--target</span> x86_64-osirs.json</span>
<span id="cb13-2"><a href="#cb13-2"></a><span class="ex">error:</span> failed to run <span class="kw">`</span><span class="ex">rustc</span><span class="kw">`</span> to learn about target-specific information</span>
<span id="cb13-3"><a href="#cb13-3"></a></span>
<span id="cb13-4"><a href="#cb13-4"></a><span class="ex">Caused</span> by:</span>
<span id="cb13-5"><a href="#cb13-5"></a>  <span class="ex">process</span> didn<span class="st">'t exit successfully: `/home/user/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/bin/rustc - --crate-name ___ --print=file-names --target /home/user/tmp/32/x86_64-osirs.json --crate-type bin --crate-type rlib --crate-type dylib --crate-type cdylib --crate-type staticlib --crate-type proc-macro --print=sysroot --print=split-debuginfo --print=crate-name --print=cfg -Wwarnings` (exit status: 1)</span></span>
<span id="cb13-6"><a href="#cb13-6"></a><span class="st">  --- stderr</span></span>
<span id="cb13-7"><a href="#cb13-7"></a><span class="st">  error: Error loading target specification: Field target-pointer-width in target specification is required. Run `rustc --print target-list` for a list of built-in targets</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="aside-2" class="level2">
<h2 class="anchored" data-anchor-id="aside-2">Aside</h2>
<ul>
<li>If you did not see that error, that is okay!</li>
<li>It concerns an unstable language feature and may differ.</li>
<li>Just skip two slides!</li>
</ul>
</section>
<section id="okay-so" class="level2">
<h2 class="anchored" data-anchor-id="okay-so">Okay so</h2>
<ul>
<li>Huh?</li>
</ul>
<div class="sourceCode" id="cb14"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1"></a><span class="ex">Field</span> target-pointer-width in target specification is required.</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>We very explicitly included that.</li>
<li>In the most annoying thing in the universe, <code>rustc</code> expect pointer width as a JSON string and not a JSON integer.
<ul>
<li><a href="https://github.com/rust-lang/rust/pull/144218">Read more</a></li>
<li>It’s fixed in Nightly, but I sleep at night, so I’m busy.</li>
</ul></li>
</ul>
</section>
<section id="fix-it" class="level2">
<h2 class="anchored" data-anchor-id="fix-it">Fix it?</h2>
<ul>
<li>I kid you not this is the solution.
<ul>
<li>“Rust has a type system!”</li>
<li>Sure it does.</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb15"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1"></a><span class="ex">$</span> diff bad.wrong x86_64-osirs.json</span>
<span id="cb15-2"><a href="#cb15-2"></a><span class="ex">6,7c6,7</span></span>
<span id="cb15-3"><a href="#cb15-3"></a><span class="op">&lt;</span>     <span class="st">"target-pointer-width"</span>: <span class="ex">64,</span></span>
<span id="cb15-4"><a href="#cb15-4"></a><span class="op">&lt;</span>     <span class="st">"target-c-int-width"</span>: <span class="ex">32,</span></span>
<span id="cb15-5"><a href="#cb15-5"></a><span class="ex">---</span></span>
<span id="cb15-6"><a href="#cb15-6"></a><span class="op">&gt;</span>     <span class="st">"target-pointer-width"</span>: <span class="st">"64"</span><span class="ex">,</span></span>
<span id="cb15-7"><a href="#cb15-7"></a><span class="op">&gt;</span>     <span class="st">"target-c-int-width"</span>: <span class="st">"32"</span><span class="ex">,</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="now-it-works" class="level2">
<h2 class="anchored" data-anchor-id="now-it-works">Now it works</h2>
<ul>
<li>This time it will work.</li>
</ul>
<div class="sourceCode" id="cb16"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1"></a><span class="ex">$</span> cargo b <span class="at">--target</span> x86_64-osirs.json</span>
<span id="cb16-2"><a href="#cb16-2"></a>   <span class="ex">Compiling</span> osirs v0.1.0 <span class="er">(</span><span class="ex">/home/user/tmp/32</span><span class="kw">)</span></span>
<span id="cb16-3"><a href="#cb16-3"></a><span class="va">error</span><span class="op">[</span>E0463<span class="op">]</span><span class="ex">:</span> can<span class="st">'t find crate for `core`</span></span>
<span id="cb16-4"><a href="#cb16-4"></a><span class="st">  |</span></span>
<span id="cb16-5"><a href="#cb16-5"></a><span class="st">  = note: the `x86_64-osirs` target may not be installed</span></span>
<span id="cb16-6"><a href="#cb16-6"></a><span class="st">  = help: consider downloading the target with `rustup target add x86_64-osirs`</span></span>
<span id="cb16-7"><a href="#cb16-7"></a></span>
<span id="cb16-8"><a href="#cb16-8"></a><span class="st">For more information about this error, try `rustc --explain E0463`.</span></span>
<span id="cb16-9"><a href="#cb16-9"></a><span class="st">error: could not compile `osirs` (bin "osirs") due to 1 previous error</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Okay I was bamboozled.</li>
</ul>
</section>
<section id="the-core" class="level2">
<h2 class="anchored" data-anchor-id="the-core">The Core</h2>
<div class="columns">
<div class="column" style="width:70%;">
<blockquote class="blockquote">
<p><a href="https://en.wikipedia.org/wiki/The_Core">The Core is a 2003 American science fiction disaster film directed by Jon Amiel with screenplay written by Cooper Layne and John Rogers.</a></p>
</blockquote>
<ul>
<li>I haven’t seen it but it apparently passes the <a href="https://en.wikipedia.org/wiki/Bechdel_test">Bechdel Test</a></li>
</ul>
</div><div class="column" style="width:30%;">
<p><img src="https://upload.wikimedia.org/wikipedia/en/f/f4/The_Core_poster.jpg" class="img-fluid"></p>
</div>
</div>
</section>
<section id="wrong-core" class="level2">
<h2 class="anchored" data-anchor-id="wrong-core">Wrong Core</h2>
<ul>
<li>We actually meant the Rust compiler <code>core</code> library.
<ul>
<li><a href="https://doc.rust-lang.org/nightly/core/index.html">Read more</a></li>
</ul></li>
<li>This library contains basic Rust types such as <code>Result</code>, <code>Option</code>, and iterators, and is implicitly linked to all <code>no_std</code> crates.</li>
</ul>
</section>
<section id="the-problem" class="level2">
<h2 class="anchored" data-anchor-id="the-problem">The Problem</h2>
<ul>
<li><code>core</code> is usually <em>pre-compiled</em> (and then, of course, linked).</li>
<li>But we made a new target which needs a new core.</li>
<li>No problem, we’ll just tell <code>rustc</code> to do some compilation.</li>
</ul>
</section>
<section id="config" class="level2">
<h2 class="anchored" data-anchor-id="config">Config</h2>
<ul>
<li>The most graceful to do this that <em>I</em> am aware of is with a <code>.cargo/config.toml</code></li>
<li>Basically, we can write down some things we <em>always</em> want <code>cargo</code> to do, and store them in TOML file in the hidden <code>.cargo</code> folder.</li>
<li>I just made the folder then opened it up in my most beloved neon vimothy.</li>
</ul>
<div class="sourceCode" id="cb17"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1"></a><span class="ex">mdkir</span> .cargo</span>
<span id="cb17-2"><a href="#cb17-2"></a><span class="ex">nvim</span> .cargo/config.toml</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="check-in" class="level2">
<h2 class="anchored" data-anchor-id="check-in">Check in</h2>
<div class="sourceCode" id="cb18"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1"></a><span class="ex">mdkir</span> .cargo</span>
<span id="cb18-2"><a href="#cb18-2"></a><span class="ex">nvim</span> .cargo/config.toml</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Understanding check - what happens if you don’t make <code>.cargo</code> first?</li>
</ul>
</section>
<section id="the-build-std-option" class="level2">
<h2 class="anchored" data-anchor-id="the-build-std-option">The <code>build-std</code> Option</h2>
<ul>
<li><code>build-std</code> is a feature of Cargo.</li>
<li>We can recompile <code>core</code> and other standard library crates on demand.
<ul>
<li>Vs. using the precompiled versions shipped with the Rust installation.</li>
</ul></li>
<li><a href="https://doc.rust-lang.org/nightly/cargo/reference/unstable.html#build-std">Read more.</a></li>
</ul>
</section>
<section id="my-config" class="level2">
<h2 class="anchored" data-anchor-id="my-config">My Config</h2>
<ul>
<li>We can use a pretty sparse config though we’ll want to add more latter.</li>
<li>I specify the “build-std” option in TOML.</li>
<li>We want to <code>build-std</code></li>
<li>We want to build the <code>core</code></li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>.cargo/config.toml</strong></pre>
</div>
<div class="sourceCode" id="cb19" data-filename=".cargo/config.toml"><pre class="sourceCode numberSource toml number-lines code-with-copy"><code class="sourceCode toml"><span id="cb19-1"><a href="#cb19-1"></a><span class="er"></span><span class="dt">build-std</span> <span class="op">=</span> <span class="op">[</span><span class="st">"core"</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>I bet this will work.</li>
</ul>
</section>
<section id="oh." class="level2">
<h2 class="anchored" data-anchor-id="oh.">Oh.</h2>
<ul>
<li>The exact same error as before?</li>
</ul>
<div class="sourceCode" id="cb20"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1"></a><span class="ex">$</span> cargo b <span class="at">--target</span> x86_64-osirs.json</span>
<span id="cb20-2"><a href="#cb20-2"></a>   <span class="ex">Compiling</span> osirs v0.1.0 <span class="er">(</span><span class="ex">/home/user/tmp/32</span><span class="kw">)</span></span>
<span id="cb20-3"><a href="#cb20-3"></a><span class="va">error</span><span class="op">[</span>E0463<span class="op">]</span><span class="ex">:</span> can<span class="st">'t find crate for `core`</span></span>
<span id="cb20-4"><a href="#cb20-4"></a><span class="st">  |</span></span>
<span id="cb20-5"><a href="#cb20-5"></a><span class="st">  = note: the `x86_64-osirs` target may not be installed</span></span>
<span id="cb20-6"><a href="#cb20-6"></a><span class="st">  = help: consider downloading the target with `rustup target add x86_64-osirs`</span></span>
<span id="cb20-7"><a href="#cb20-7"></a></span>
<span id="cb20-8"><a href="#cb20-8"></a><span class="st">For more information about this error, try `rustc --explain E0463`.</span></span>
<span id="cb20-9"><a href="#cb20-9"></a><span class="st">error: could not compile `osirs` (bin "osirs") due to 1 previous error</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="unstable" class="level2">
<h2 class="anchored" data-anchor-id="unstable">Unstable</h2>
<ul>
<li>So apparently <code>build-std</code> is not a stable feature of the Rust language.
<ul>
<li>This means the Rust designers can change or remove it at any time.</li>
</ul></li>
<li>To use unstable features, we have to tell <code>cargo</code> they are unstable.</li>
</ul>
</section>
<section id="mental-model" class="level2">
<h2 class="anchored" data-anchor-id="mental-model">Mental model</h2>
<ul>
<li>Think of it a bit like unsafe, but for the language instead of the executables.
<ul>
<li>When an executable is unsafe, it may crash or leak your private key.</li>
<li>When a language is unstable, it may not compile or may compile then leak your private key.</li>
</ul></li>
</ul>
</section>
<section id="update-config" class="level2">
<h2 class="anchored" data-anchor-id="update-config">Update config</h2>
<ul>
<li>We prepend an <code>[unstable]</code> label to our <code>build-std</code> configuration.</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>.cargo/config.toml</strong></pre>
</div>
<div class="sourceCode" id="cb21" data-filename=".cargo/config.toml"><pre class="sourceCode numberSource toml number-lines code-with-copy"><code class="sourceCode toml"><span id="cb21-1"><a href="#cb21-1"></a><span class="er"></span><span class="kw">[unstable]</span></span>
<span id="cb21-2"><a href="#cb21-2"></a><span class="dt">build-std</span> <span class="op">=</span> <span class="op">[</span><span class="st">"core"</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>I bet it will work now (it won’t).</li>
</ul>
</section>
<section id="oh.-1" class="level2">
<h2 class="anchored" data-anchor-id="oh.-1">Oh.</h2>
<ul>
<li>The exact same error as before?</li>
</ul>
<div class="sourceCode" id="cb22"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1"></a><span class="ex">$</span> cargo b <span class="at">--target</span> x86_64-osirs.json</span>
<span id="cb22-2"><a href="#cb22-2"></a>   <span class="ex">Compiling</span> osirs v0.1.0 <span class="er">(</span><span class="ex">/home/user/tmp/32</span><span class="kw">)</span></span>
<span id="cb22-3"><a href="#cb22-3"></a><span class="va">error</span><span class="op">[</span>E0463<span class="op">]</span><span class="ex">:</span> can<span class="st">'t find crate for `core`</span></span>
<span id="cb22-4"><a href="#cb22-4"></a><span class="st">  |</span></span>
<span id="cb22-5"><a href="#cb22-5"></a><span class="st">  = note: the `x86_64-osirs` target may not be installed</span></span>
<span id="cb22-6"><a href="#cb22-6"></a><span class="st">  = help: consider downloading the target with `rustup target add x86_64-osirs`</span></span>
<span id="cb22-7"><a href="#cb22-7"></a></span>
<span id="cb22-8"><a href="#cb22-8"></a><span class="st">For more information about this error, try `rustc --explain E0463`.</span></span>
<span id="cb22-9"><a href="#cb22-9"></a><span class="st">error: could not compile `osirs` (bin "osirs") due to 1 previous error</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="nightly" class="level2">
<h2 class="anchored" data-anchor-id="nightly">Nightly</h2>
<ul>
<li>Okay folks here’s the deal.</li>
<li>I’m not happy about it either.</li>
<li><code>build-std</code> - which we need - is unstable and</li>
<li><code>[unstable]</code> is only available in nightly Rust.
<ul>
<li>The version of Rust for <em>nerds</em>.</li>
</ul></li>
<li>Not to worry, we are nerds and can use it.
<ul>
<li>Simply add a <code>+nightly</code> right after cargo.</li>
</ul></li>
</ul>
</section>
<section id="try-two-things" class="level2">
<h2 class="anchored" data-anchor-id="try-two-things">Try Two Things</h2>
<ul>
<li>Here’s two things that also still won’t work.</li>
</ul>
<div class="sourceCode" id="cb23"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1"></a><span class="ex">cargo</span> +nightly b <span class="at">--target</span> x86_64-osirs.json</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Gives this:</li>
</ul>
<div class="sourceCode" id="cb24"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb24-1"><a href="#cb24-1"></a><span class="ex">error:</span> <span class="kw">`</span><span class="ex">.json</span><span class="kw">`</span> target specs require <span class="at">-Zjson-target-spec</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="try-two-things-1" class="level2">
<h2 class="anchored" data-anchor-id="try-two-things-1">Try Two Things</h2>
<ul>
<li>Here’s two things that also still won’t work.</li>
</ul>
<div class="sourceCode" id="cb25"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1"></a><span class="ex">cargo</span> +nightly b</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Gives this:</li>
</ul>
<div class="sourceCode" id="cb26"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb26-1"><a href="#cb26-1"></a><span class="ex">error:</span> <span class="kw">`</span><span class="ex">.json</span><span class="kw">`</span> target specs require <span class="at">-Zjson-target-spec</span></span>
<span id="cb26-2"><a href="#cb26-2"></a>   <span class="ex">Compiling</span> compiler_builtins v0.1.160 <span class="er">(</span><span class="ex">/home/user/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/compiler-builtins/compiler-builtins</span><span class="kw">)</span></span>
<span id="cb26-3"><a href="#cb26-3"></a>   <span class="ex">Compiling</span> core v0.0.0 <span class="er">(</span><span class="ex">/home/user/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core</span><span class="kw">)</span></span>
<span id="cb26-4"><a href="#cb26-4"></a>   <span class="ex">Compiling</span> osirs v0.1.0 <span class="er">(</span><span class="ex">/home/user/tmp/32</span><span class="kw">)</span></span>
<span id="cb26-5"><a href="#cb26-5"></a><span class="ex">error:</span> linking with <span class="kw">`</span><span class="fu">cc</span><span class="kw">`</span> failed: exit status: 1</span>
<span id="cb26-6"><a href="#cb26-6"></a>  <span class="kw">|</span></span>
<span id="cb26-7"><a href="#cb26-7"></a>  <span class="ex">=</span> note:  <span class="st">"cc"</span> <span class="st">"-m64"</span> <span class="st">"/home/user/tmp/32/target/debug/deps/rustcMmXrbF/symbols.o"</span> <span class="st">"&lt;1 object files omitted&gt;"</span> <span class="st">"-Wl,--as-needed"</span> <span class="st">"-Wl,-Bstatic"</span> <span class="st">"/home/user/tmp/32/target/debug/deps/{libcore-0c26ef2bd74962c1,libcompiler_builtins-40a77a01cbdbd500}.rlib"</span> <span class="st">"-L"</span> <span class="st">"/home/user/tmp/32/target/debug/deps/rustcMmXrbF/raw-dylibs"</span> <span class="st">"-Wl,-Bdynamic"</span> <span class="st">"-B&lt;sysroot&gt;/lib/rustlib/x86_64-unknown-linux-gnu/bin/gcc-ld"</span> <span class="st">"-fuse-ld=lld"</span> <span class="st">"-Wl,--eh-frame-hdr"</span> <span class="st">"-Wl,-z,noexecstack"</span> <span class="st">"-L"</span> <span class="st">"&lt;sysroot&gt;/lib/rustlib/x86_64-unknown-linux-gnu/lib"</span> <span class="st">"-o"</span> <span class="st">"/home/user/tmp/32/target/debug/deps/osirs-62b17f4aa5d3b391"</span> <span class="st">"-Wl,--gc-sections"</span> <span class="st">"-pie"</span> <span class="st">"-Wl,-z,relro,-z,now"</span> <span class="st">"-nodefaultlibs"</span></span>
<span id="cb26-8"><a href="#cb26-8"></a>  <span class="ex">=</span> note: some arguments are omitted. use <span class="kw">`</span><span class="ex">--verbose</span><span class="kw">`</span> to show all linker arguments</span>
<span id="cb26-9"><a href="#cb26-9"></a>  <span class="ex">=</span> note: rust-lld: error: duplicate symbol: _start</span>
<span id="cb26-10"><a href="#cb26-10"></a>          <span class="op">&gt;&gt;&gt;</span> defined <span class="ex">at</span> /usr/lib/gcc/x86_64-linux-gnu/11/../../../x86_64-linux-gnu/Scrt1.o:<span class="er">(</span><span class="ex">_start</span><span class="kw">)</span></span>
<span id="cb26-11"><a href="#cb26-11"></a>          <span class="op">&gt;&gt;&gt;</span> defined <span class="ex">at</span> main.rs:6 <span class="er">(</span><span class="ex">src/main.rs:6</span><span class="kw">)</span></span>
<span id="cb26-12"><a href="#cb26-12"></a>          <span class="op">&gt;&gt;&gt;</span>            /home/user/tmp/32/target/debug/deps/osirs-62b17f4aa5d3b391.3hpwl9lytayxk9wu897na7tu0.0wpyfaj.rcgu.o:<span class="kw">(</span><span class="ex">.text._start+0x0</span><span class="kw">)</span></span>
<span id="cb26-13"><a href="#cb26-13"></a>          <span class="ex">collect2:</span> error: ld returned 1 exit status</span>
<span id="cb26-14"><a href="#cb26-14"></a></span>
<span id="cb26-15"><a href="#cb26-15"></a></span>
<span id="cb26-16"><a href="#cb26-16"></a><span class="ex">error:</span> could not compile <span class="kw">`</span><span class="ex">osirs</span><span class="kw">`</span> <span class="er">(</span><span class="ex">bin</span> <span class="st">"osirs"</span><span class="kw">)</span> <span class="ex">due</span> to 1 previous error</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="the-problem-1" class="level2">
<h2 class="anchored" data-anchor-id="the-problem-1">The Problem</h2>
<ul>
<li>Not everything works the same way with nightly and stable rust.
<ul>
<li>That’s why it’s not stable.</li>
</ul></li>
<li>We will encounter two examples immediately, both related to JSON.</li>
<li>Let’s look at this:</li>
</ul>
<div class="sourceCode" id="cb27"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1"></a><span class="ex">$</span> cargo +nightly b <span class="at">--target</span> x86_64-osirs.json</span>
<span id="cb27-2"><a href="#cb27-2"></a><span class="ex">error:</span> <span class="kw">`</span><span class="ex">.json</span><span class="kw">`</span> target specs require <span class="at">-Zjson-target-spec</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="one-solution" class="level2">
<h2 class="anchored" data-anchor-id="one-solution">One Solution</h2>
<ul>
<li>We can of course just put <code>-Zjson-target-spec</code> in there.</li>
<li>We get an error, but one we are clever enough to handle.</li>
</ul>
<div class="sourceCode" id="cb28"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb28-1"><a href="#cb28-1"></a><span class="ex">$</span> cargo +nightly b <span class="at">--target</span> x86_64-osirs.json <span class="at">-Zjson-target-spec</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Gives this:</li>
</ul>
<div class="sourceCode" id="cb29"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1"></a><span class="ex">error:</span> failed to run <span class="kw">`</span><span class="ex">rustc</span><span class="kw">`</span> to learn about target-specific information</span>
<span id="cb29-2"><a href="#cb29-2"></a></span>
<span id="cb29-3"><a href="#cb29-3"></a><span class="ex">Caused</span> by:</span>
<span id="cb29-4"><a href="#cb29-4"></a>  <span class="ex">process</span> didn<span class="st">'t exit successfully: `/home/user/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/bin/rustc - --crate-name ___ --print=file-names --target /home/user/tmp/32/x86_64-osirs.json -Zunstable-options --crate-type bin --crate-type rlib --crate-type dylib --crate-type cdylib --crate-type staticlib --crate-type proc-macro --print=sysroot --print=split-debuginfo --print=crate-name --print=cfg -Wwarnings` (exit status: 1)</span></span>
<span id="cb29-5"><a href="#cb29-5"></a><span class="st">  --- stderr</span></span>
<span id="cb29-6"><a href="#cb29-6"></a><span class="st">  error: error loading target specification: target-pointer-width: invalid type: string "64", expected u16 at line 6 column 32</span></span>
<span id="cb29-7"><a href="#cb29-7"></a><span class="st">    |</span></span>
<span id="cb29-8"><a href="#cb29-8"></a><span class="st">    = help: run `rustc --print target-list` for a list of built-in targets</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="another-solution" class="level2">
<h2 class="anchored" data-anchor-id="another-solution">Another Solution</h2>
<ul>
<li>However, that <code>-Zjson-target-spec</code> looks an <em>awful</em> lot like a <code>.cargo/config.toml</code> option…
<ul>
<li>I believe that is also unstable…</li>
<li>… after all, it works fine on stable!</li>
</ul></li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>.cargo/config.toml</strong></pre>
</div>
<div class="sourceCode" id="cb30" data-filename=".cargo/config.toml"><pre class="sourceCode numberSource toml number-lines code-with-copy"><code class="sourceCode toml"><span id="cb30-1"><a href="#cb30-1"></a><span class="er"></span><span class="kw">[unstable]</span></span>
<span id="cb30-2"><a href="#cb30-2"></a><span class="dt">build-std</span> <span class="op">=</span> <span class="op">[</span><span class="st">"core"</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>We can then get the same error with less typing:</li>
</ul>
<div class="sourceCode" id="cb31"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb31-1"><a href="#cb31-1"></a><span class="ex">cargo</span> +nightly b <span class="at">--target</span> x86_64-osirs.json</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="the-error" class="level2">
<h2 class="anchored" data-anchor-id="the-error">The error</h2>
<div class="sourceCode" id="cb32"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb32-1"><a href="#cb32-1"></a><span class="ex">error:</span> failed to run <span class="kw">`</span><span class="ex">rustc</span><span class="kw">`</span> to learn about target-specific information</span>
<span id="cb32-2"><a href="#cb32-2"></a></span>
<span id="cb32-3"><a href="#cb32-3"></a><span class="ex">Caused</span> by:</span>
<span id="cb32-4"><a href="#cb32-4"></a>  <span class="ex">process</span> didn<span class="st">'t exit successfully: `/home/user/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/bin/rustc - --crate-name ___ --print=file-names --target /home/user/tmp/32/x86_64-osirs.json -Zunstable-options --crate-type bin --crate-type rlib --crate-type dylib --crate-type cdylib --crate-type staticlib --crate-type proc-macro --print=sysroot --print=split-debuginfo --print=crate-name --print=cfg -Wwarnings` (exit status: 1)</span></span>
<span id="cb32-5"><a href="#cb32-5"></a><span class="st">  --- stderr</span></span>
<span id="cb32-6"><a href="#cb32-6"></a><span class="st">  error: error loading target specification: target-pointer-width: invalid type: string "64", expected u16 at line 6 column 32</span></span>
<span id="cb32-7"><a href="#cb32-7"></a><span class="st">    |</span></span>
<span id="cb32-8"><a href="#cb32-8"></a><span class="st">    = help: run `rustc --print target-list` for a list of built-in targets</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Does that remind you of anything?</li>
</ul>
<div class="sourceCode" id="cb33"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb33-1"><a href="#cb33-1"></a><span class="ex">$</span> diff bad.wrong x86_64-osirs.json</span>
<span id="cb33-2"><a href="#cb33-2"></a><span class="ex">6,7c6,7</span></span>
<span id="cb33-3"><a href="#cb33-3"></a><span class="op">&lt;</span>     <span class="st">"target-pointer-width"</span>: <span class="ex">64,</span></span>
<span id="cb33-4"><a href="#cb33-4"></a><span class="op">&lt;</span>     <span class="st">"target-c-int-width"</span>: <span class="ex">32,</span></span>
<span id="cb33-5"><a href="#cb33-5"></a><span class="ex">---</span></span>
<span id="cb33-6"><a href="#cb33-6"></a><span class="op">&gt;</span>     <span class="st">"target-pointer-width"</span>: <span class="st">"64"</span><span class="ex">,</span></span>
<span id="cb33-7"><a href="#cb33-7"></a><span class="op">&gt;</span>     <span class="st">"target-c-int-width"</span>: <span class="st">"32"</span><span class="ex">,</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="aside-3" class="level2">
<h2 class="anchored" data-anchor-id="aside-3">Aside</h2>
<ul>
<li>If you did not see that error, that is okay!</li>
<li>It concerns an unstable language feature and may differ.</li>
<li>Just skip one slide!</li>
</ul>
</section>
<section id="revert" class="level2">
<h2 class="anchored" data-anchor-id="revert">Revert!</h2>
<ul>
<li>Change the string integers back to integer integers in your JSON file and you will be living a charmed and blessed life.
<ul>
<li>A long one, compilation is 10+ seconds for me.</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb34"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb34-1"><a href="#cb34-1"></a><span class="ex">$</span> cargo +nightly b <span class="at">--target</span> x86_64-osirs.json</span>
<span id="cb34-2"><a href="#cb34-2"></a>   <span class="ex">Compiling</span> compiler_builtins v0.1.160 <span class="er">(</span><span class="ex">/home/user/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/compiler-builtins/compiler-builtins</span><span class="kw">)</span></span>
<span id="cb34-3"><a href="#cb34-3"></a>   <span class="ex">Compiling</span> core v0.0.0 <span class="er">(</span><span class="ex">/home/user/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core</span><span class="kw">)</span></span>
<span id="cb34-4"><a href="#cb34-4"></a><span class="ex">^[[A</span>    Building [==========<span class="op">&gt;</span>                  ] 2/5: core, compiler_builtins                                                                Compiling osirs v0.1.0 <span class="er">(</span><span class="ex">/home/user/tmp/32</span><span class="kw">)</span></span>
<span id="cb34-5"><a href="#cb34-5"></a>    <span class="ex">Finished</span> <span class="kw">`</span><span class="ex">dev</span><span class="kw">`</span> profile [unoptimized + debuginfo] target<span class="er">(</span><span class="ex">s</span><span class="kw">)</span> <span class="er">in</span> <span class="ex">10.18s</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="aside-4" class="level2">
<h2 class="anchored" data-anchor-id="aside-4">Aside</h2>
<ul>
<li>By the way, are you tired of specifying the target every time?
<ul>
<li>Sounds like a problem for <code>.cargo/config.toml</code>!</li>
</ul></li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>.cargo/config.toml</strong></pre>
</div>
<div class="sourceCode" id="cb35" data-filename=".cargo/config.toml"><pre class="sourceCode numberSource toml number-lines code-with-copy"><code class="sourceCode toml"><span id="cb35-1"><a href="#cb35-1"></a><span class="kw">[unstable]</span></span>
<span id="cb35-2"><a href="#cb35-2"></a><span class="dt">build-std</span> <span class="op">=</span> <span class="op">[</span><span class="st">"core"</span><span class="op">]</span></span>
<span id="cb35-3"><a href="#cb35-3"></a><span class="dt">json-target-spec</span> <span class="op">=</span> <span class="cn">true</span></span>
<span id="cb35-4"><a href="#cb35-4"></a></span>
<span id="cb35-5"><a href="#cb35-5"></a><span class="kw">[build]</span></span>
<span id="cb35-6"><a href="#cb35-6"></a><span class="dt">target</span> <span class="op">=</span> <span class="st">"x86_64-osirs.json"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="run-again" class="level2">
<h2 class="anchored" data-anchor-id="run-again">Run again</h2>
<ul>
<li>By the way it will be fast now.</li>
</ul>
<div class="sourceCode" id="cb36"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb36-1"><a href="#cb36-1"></a><span class="ex">$</span> cargo +nightly b</span>
<span id="cb36-2"><a href="#cb36-2"></a>    <span class="ex">Finished</span> <span class="kw">`</span><span class="ex">dev</span><span class="kw">`</span> profile [unoptimized + debuginfo] target<span class="er">(</span><span class="ex">s</span><span class="kw">)</span> <span class="er">in</span> <span class="ex">0.08s</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="aside-nightly" class="level2">
<h2 class="anchored" data-anchor-id="aside-nightly">Aside: Nightly</h2>
<ul>
<li>Surely you can also update <code>.cargo/config.toml</code> to use nightly!
<ul>
<li>You can’t. You can solve the problem other ways though.</li>
<li>Left as an exercise to the interested student.</li>
</ul></li>
</ul>
</section>
<section id="aside-notfutureproofing" class="level2">
<h2 class="anchored" data-anchor-id="aside-notfutureproofing">Aside: <span class="math inline">\(\not\)</span>Futureproofing</h2>
<ul>
<li>I was pretty sure I can make a kernel without floats.</li>
<li>So I removed the two <code>soft-float</code> lines and it still worked for now.</li>
</ul>
<div class="sourceCode" id="cb37"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb37-1"><a href="#cb37-1"></a><span class="ex">$</span> diff old.boring x86_64-osirs.json</span>
<span id="cb37-2"><a href="#cb37-2"></a><span class="ex">13,15c13</span></span>
<span id="cb37-3"><a href="#cb37-3"></a><span class="op">&lt;</span>     <span class="st">"disable-redzone"</span>: <span class="fu">true</span>,</span>
<span id="cb37-4"><a href="#cb37-4"></a><span class="op">&lt;</span>     <span class="st">"features"</span>: <span class="st">"-mmx,-sse,+soft-float"</span><span class="ex">,</span></span>
<span id="cb37-5"><a href="#cb37-5"></a><span class="op">&lt;</span>     <span class="st">"rustc-abi"</span>: <span class="st">"x86-softfloat"</span></span>
<span id="cb37-6"><a href="#cb37-6"></a><span class="ex">---</span></span>
<span id="cb37-7"><a href="#cb37-7"></a><span class="op">&gt;</span>     <span class="st">"disable-redzone"</span>: <span class="fu">true</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="aside-notfutureproofing-1" class="level2">
<h2 class="anchored" data-anchor-id="aside-notfutureproofing-1">Aside: <span class="math inline">\(\not\)</span>Futureproofing</h2>
<ul>
<li>I was pretty sure I could make a kernel without <code>compiler-builtins</code></li>
<li>These are memory related functions where Rust often uses linked C implementations.</li>
<li>I’m leaving them out for now and will add them in when I need them.</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>.cargo/config.toml</strong></pre>
</div>
<div class="sourceCode" id="cb38" data-filename=".cargo/config.toml"><pre class="sourceCode numberSource toml number-lines code-with-copy"><code class="sourceCode toml"><span id="cb38-1"><a href="#cb38-1"></a><span class="kw">[unstable]</span></span>
<span id="cb38-2"><a href="#cb38-2"></a><span class="dt">build-std-features</span> <span class="op">=</span> <span class="op">[</span><span class="st">"compiler-builtins-mem"</span><span class="op">]</span></span>
<span id="cb38-3"><a href="#cb38-3"></a><span class="dt">build-std</span> <span class="op">=</span> <span class="op">[</span><span class="st">"core"</span><span class="op">,</span> <span class="st">"compiler_builtins"</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="boot-it" class="level2">
<h2 class="anchored" data-anchor-id="boot-it">Boot it</h2>
<ul>
<li>And with that, I bet this will totally work.</li>
<li>Let’s break out <code>qemu</code></li>
</ul>
<div class="sourceCode" id="cb39"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb39-1"><a href="#cb39-1"></a><span class="ex">$</span> qemu-system-x86_64 <span class="at">-kernel</span> target/x86_64-osirs/debug/osirs</span>
<span id="cb39-2"><a href="#cb39-2"></a><span class="ex">Command</span> <span class="st">'qemu-system-x86_64'</span> not found, but can be installed with:</span>
<span id="cb39-3"><a href="#cb39-3"></a><span class="fu">sudo</span> apt install qemu-system-x86      <span class="co"># version 1:6.2+dfsg-2ubuntu6.27, or</span></span>
<span id="cb39-4"><a href="#cb39-4"></a><span class="fu">sudo</span> apt install qemu-system-x86-xen  <span class="co"># version 1:6.2+dfsg-2ubuntu6.27</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Oh right, we only installed “misc” <code>qemu</code>
<ul>
<li>Real ones will use <code>apt</code></li>
</ul>
<div class="sourceCode" id="cb40"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb40-1"><a href="#cb40-1"></a><span class="fu">sudo</span> apt install qemu-system-x86</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul>
</section>
<section id="boot-it-1" class="level2">
<h2 class="anchored" data-anchor-id="boot-it-1">Boot it</h2>
<div class="sourceCode" id="cb41"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb41-1"><a href="#cb41-1"></a><span class="ex">$</span> qemu-system-x86_64 <span class="at">-kernel</span> target/x86_64-osirs/debug/osirs</span>
<span id="cb41-2"><a href="#cb41-2"></a><span class="ex">qemu-system-x86_64:</span> Error loading uncompressed kernel without PVH ELF Note</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Oh right, we did precisely <em>nothing</em> with the BIOS and the bootloader and all that and still need to do those things.
<ul>
<li>I bet that would be a fun topic for a lab.</li>
</ul></li>
</ul>
</section>
</section>
<section id="fin" class="level1">
<h1>Fin</h1>
<section id="main-file" class="level2">
<h2 class="anchored" data-anchor-id="main-file">Main File</h2>
<ul>
<li>Unaltered except loops for stability.</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/main.rs</strong></pre>
</div>
<div class="sourceCode" id="cb42" data-filename="src/main.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb42-1"><a href="#cb42-1"></a><span class="at">#![</span>no_std<span class="at">]</span></span>
<span id="cb42-2"><a href="#cb42-2"></a><span class="at">#![</span>no_main<span class="at">]</span></span>
<span id="cb42-3"><a href="#cb42-3"></a></span>
<span id="cb42-4"><a href="#cb42-4"></a><span class="at">#[</span><span class="kw">unsafe</span><span class="at">(</span>no_mangle<span class="at">)]</span></span>
<span id="cb42-5"><a href="#cb42-5"></a><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">"C"</span> <span class="kw">fn</span> _start() <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb42-6"><a href="#cb42-6"></a>    <span class="cf">loop</span> <span class="op">{}</span></span>
<span id="cb42-7"><a href="#cb42-7"></a><span class="op">}</span></span>
<span id="cb42-8"><a href="#cb42-8"></a></span>
<span id="cb42-9"><a href="#cb42-9"></a><span class="at">#[</span>panic_handler<span class="at">]</span></span>
<span id="cb42-10"><a href="#cb42-10"></a><span class="kw">fn</span> panic(_info<span class="op">:</span> <span class="op">&amp;</span><span class="pp">core::panic::</span>PanicInfo) <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb42-11"><a href="#cb42-11"></a>    <span class="cf">loop</span> <span class="op">{}</span></span>
<span id="cb42-12"><a href="#cb42-12"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="config-file" class="level2">
<h2 class="anchored" data-anchor-id="config-file">Config File</h2>
<ul>
<li>All new, only works with nightly.</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>.cargo/config.toml</strong></pre>
</div>
<div class="sourceCode" id="cb43" data-filename=".cargo/config.toml"><pre class="sourceCode numberSource toml number-lines code-with-copy"><code class="sourceCode toml"><span id="cb43-1"><a href="#cb43-1"></a><span class="kw">[unstable]</span></span>
<span id="cb43-2"><a href="#cb43-2"></a><span class="dt">build-std</span> <span class="op">=</span> <span class="op">[</span><span class="st">"core"</span><span class="op">]</span></span>
<span id="cb43-3"><a href="#cb43-3"></a><span class="dt">json-target-spec</span> <span class="op">=</span> <span class="cn">true</span></span>
<span id="cb43-4"><a href="#cb43-4"></a></span>
<span id="cb43-5"><a href="#cb43-5"></a><span class="kw">[build]</span></span>
<span id="cb43-6"><a href="#cb43-6"></a><span class="dt">target</span> <span class="op">=</span> <span class="st">"x86_64-osirs.json"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="target-file" class="level2">
<h2 class="anchored" data-anchor-id="target-file">Target File</h2>
<ul>
<li>All new, this is the nightly version.</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>x86_64-osirs.json</strong></pre>
</div>
<div class="sourceCode" id="cb44" data-filename="x86_64-osirs.json"><pre class="sourceCode numberSource json number-lines code-with-copy"><code class="sourceCode json"><span id="cb44-1"><a href="#cb44-1"></a><span class="fu">{</span></span>
<span id="cb44-2"><a href="#cb44-2"></a>    <span class="dt">"llvm-target"</span><span class="fu">:</span> <span class="st">"x86_64-unknown-none"</span><span class="fu">,</span></span>
<span id="cb44-3"><a href="#cb44-3"></a>    <span class="dt">"data-layout"</span><span class="fu">:</span> <span class="st">"e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-i128:128-f80:128-n8:16:32:64-S128"</span><span class="fu">,</span></span>
<span id="cb44-4"><a href="#cb44-4"></a>    <span class="dt">"arch"</span><span class="fu">:</span> <span class="st">"x86_64"</span><span class="fu">,</span></span>
<span id="cb44-5"><a href="#cb44-5"></a>    <span class="dt">"target-endian"</span><span class="fu">:</span> <span class="st">"little"</span><span class="fu">,</span></span>
<span id="cb44-6"><a href="#cb44-6"></a>    <span class="dt">"target-pointer-width"</span><span class="fu">:</span> <span class="dv">64</span><span class="fu">,</span></span>
<span id="cb44-7"><a href="#cb44-7"></a>    <span class="dt">"target-c-int-width"</span><span class="fu">:</span> <span class="dv">32</span><span class="fu">,</span></span>
<span id="cb44-8"><a href="#cb44-8"></a>    <span class="dt">"os"</span><span class="fu">:</span> <span class="st">"none"</span><span class="fu">,</span></span>
<span id="cb44-9"><a href="#cb44-9"></a>    <span class="dt">"executables"</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb44-10"><a href="#cb44-10"></a>    <span class="dt">"linker-flavor"</span><span class="fu">:</span> <span class="st">"ld.lld"</span><span class="fu">,</span></span>
<span id="cb44-11"><a href="#cb44-11"></a>    <span class="dt">"linker"</span><span class="fu">:</span> <span class="st">"rust-lld"</span><span class="fu">,</span></span>
<span id="cb44-12"><a href="#cb44-12"></a>    <span class="dt">"panic-strategy"</span><span class="fu">:</span> <span class="st">"abort"</span><span class="fu">,</span></span>
<span id="cb44-13"><a href="#cb44-13"></a>    <span class="dt">"disable-redzone"</span><span class="fu">:</span> <span class="kw">true</span></span>
<span id="cb44-14"><a href="#cb44-14"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="cargo-file" class="level2">
<h2 class="anchored" data-anchor-id="cargo-file">Cargo File</h2>
<ul>
<li>Move panic specification to target.</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Cargo.toml</strong></pre>
</div>
<div class="sourceCode" id="cb45" data-filename="Cargo.toml"><pre class="sourceCode numberSource toml number-lines code-with-copy"><code class="sourceCode toml"><span id="cb45-1"><a href="#cb45-1"></a><span class="kw">[package]</span></span>
<span id="cb45-2"><a href="#cb45-2"></a><span class="dt">name</span> <span class="op">=</span> <span class="st">"osirs"</span></span>
<span id="cb45-3"><a href="#cb45-3"></a><span class="dt">version</span> <span class="op">=</span> <span class="st">"0.1.0"</span></span>
<span id="cb45-4"><a href="#cb45-4"></a><span class="dt">edition</span> <span class="op">=</span> <span class="st">"2024"</span></span>
<span id="cb45-5"><a href="#cb45-5"></a></span>
<span id="cb45-6"><a href="#cb45-6"></a><span class="kw">[dependencies]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


<!-- -->

</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./32_r5.html" class="pagination-link" aria-label="RISC-V">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">RISC-V</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./41_boot.html" class="pagination-link" aria-label="Boot">
        <span class="nav-page-text">Boot</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb46" data-shortcodes="false"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb46-1"><a href="#cb46-1"></a><span class="co">---</span></span>
<span id="cb46-2"><a href="#cb46-2"></a><span class="an">title:</span><span class="co"> Kernel</span></span>
<span id="cb46-3"><a href="#cb46-3"></a><span class="co">---</span></span>
<span id="cb46-4"><a href="#cb46-4"></a></span>
<span id="cb46-5"><a href="#cb46-5"></a><span class="fu">## Announcements</span></span>
<span id="cb46-6"><a href="#cb46-6"></a></span>
<span id="cb46-7"><a href="#cb46-7"></a><span class="ss">- </span>**Action Items**:</span>
<span id="cb46-8"><a href="#cb46-8"></a><span class="ss">  - </span>Is <span class="in">`qemu`</span> working at all.</span>
<span id="cb46-9"><a href="#cb46-9"></a><span class="ss">    - </span>The coolest assignment ever for a second week in a row.</span>
<span id="cb46-10"><a href="#cb46-10"></a><span class="ss">    - </span>I'm glad you all love it</span>
<span id="cb46-11"><a href="#cb46-11"></a></span>
<span id="cb46-12"><a href="#cb46-12"></a><span class="fu">## Today</span></span>
<span id="cb46-13"><a href="#cb46-13"></a></span>
<span id="cb46-14"><a href="#cb46-14"></a><span class="ss">- </span>Background</span>
<span id="cb46-15"><a href="#cb46-15"></a><span class="ss">- </span>Kernel</span>
<span id="cb46-16"><a href="#cb46-16"></a>    </span>
<span id="cb46-17"><a href="#cb46-17"></a><span class="fu">## Citations</span></span>
<span id="cb46-18"><a href="#cb46-18"></a></span>
<span id="cb46-19"><a href="#cb46-19"></a><span class="ss">- </span>Outright theft:</span>
<span id="cb46-20"><a href="#cb46-20"></a><span class="ss">    - </span><span class="co">[</span><span class="ot">A Minimal Rust Kernel</span><span class="co">](https://os.phil-opp.com/minimal-rust-kernel/)</span></span>
<span id="cb46-21"><a href="#cb46-21"></a></span>
<span id="cb46-22"><a href="#cb46-22"></a><span class="fu"># Background</span></span>
<span id="cb46-23"><a href="#cb46-23"></a></span>
<span id="cb46-24"><a href="#cb46-24"></a><span class="fu">## The Boot Process</span></span>
<span id="cb46-25"><a href="#cb46-25"></a></span>
<span id="cb46-26"><a href="#cb46-26"></a><span class="ss">- </span>POV: You are an inanimate piece of silicon.</span>
<span id="cb46-27"><a href="#cb46-27"></a><span class="ss">    - </span>You contain wires connected to logic gates.</span>
<span id="cb46-28"><a href="#cb46-28"></a><span class="ss">    - </span>Somewhere, a switch is flipped.</span>
<span id="cb46-29"><a href="#cb46-29"></a><span class="ss">    - </span>Electrons flow into some of your wires, through some gates.</span>
<span id="cb46-30"><a href="#cb46-30"></a></span>
<span id="cb46-31"><a href="#cb46-31"></a><span class="fu">## First Steps</span></span>
<span id="cb46-32"><a href="#cb46-32"></a></span>
<span id="cb46-33"><a href="#cb46-33"></a><span class="ss">- </span>What determines the initial arrangement of gates?</span>
<span id="cb46-34"><a href="#cb46-34"></a><span class="ss">- </span>Where do electrons flow?</span>
<span id="cb46-35"><a href="#cb46-35"></a><span class="ss">- </span>This is determined by the *boot process*</span>
<span id="cb46-36"><a href="#cb46-36"></a><span class="ss">    - </span>Occurs on *every* power-up</span>
<span id="cb46-37"><a href="#cb46-37"></a><span class="ss">    - </span>Determined by *hardware* design</span>
<span id="cb46-38"><a href="#cb46-38"></a><span class="ss">    - </span>More fundamental than the OS</span>
<span id="cb46-39"><a href="#cb46-39"></a>    </span>
<span id="cb46-40"><a href="#cb46-40"></a><span class="fu">## Firmware</span></span>
<span id="cb46-41"><a href="#cb46-41"></a></span>
<span id="cb46-42"><a href="#cb46-42"></a><span class="ss">- </span>What is between hardware and software?</span>
<span id="cb46-43"><a href="#cb46-43"></a><span class="ss">    - </span>Firmware.</span>
<span id="cb46-44"><a href="#cb46-44"></a><span class="ss">- </span>On power-up, devices execute code embedded in physical read only memory (ROM). </span>
<span id="cb46-45"><a href="#cb46-45"></a><span class="ss">    - </span>Read more: <span class="co">[</span><span class="ot">ROM</span><span class="co">](https://en.wikipedia.org/wiki/Read-only_memory)</span></span>
<span id="cb46-46"><a href="#cb46-46"></a><span class="ss">- </span>Is it software? Is it hardware? Who can say.</span>
<span id="cb46-47"><a href="#cb46-47"></a></span>
<span id="cb46-48"><a href="#cb46-48"></a><span class="fu">## Enter the CPU</span></span>
<span id="cb46-49"><a href="#cb46-49"></a></span>
<span id="cb46-50"><a href="#cb46-50"></a><span class="ss">- </span>Usually, power-up occurs on a "motherboard" hosting, among other things, the bus.</span>
<span id="cb46-51"><a href="#cb46-51"></a><span class="ss">    - </span>Named "mother" after the "MU/TH/UR" on ship computer in *Alien* (1979)</span>
<span id="cb46-52"><a href="#cb46-52"></a><span class="ss">    - </span>This is a lie.</span>
<span id="cb46-53"><a href="#cb46-53"></a>    </span>
<span id="cb46-54"><a href="#cb46-54"></a><span class="fu">## Not "code" but "ware"</span></span>
<span id="cb46-55"><a href="#cb46-55"></a>    </span>
<span id="cb46-56"><a href="#cb46-56"></a><span class="ss">- </span>So firmware isn't really like CPU code (like Rust or C), but it does:</span>
<span id="cb46-57"><a href="#cb46-57"></a><span class="ss">    - </span>Tell circuitry where to direct electrons within the CPU.</span>
<span id="cb46-58"><a href="#cb46-58"></a><span class="ss">    - </span>Also wake up e.g. the MMU.</span>
<span id="cb46-59"><a href="#cb46-59"></a></span>
<span id="cb46-60"><a href="#cb46-60"></a><span class="fu">## Enter the OS</span></span>
<span id="cb46-61"><a href="#cb46-61"></a></span>
<span id="cb46-62"><a href="#cb46-62"></a><span class="ss">- </span>With the CPU primed but not yet ticking through clock cycles, all that remains is to either</span>
<span id="cb46-63"><a href="#cb46-63"></a><span class="ss">    - </span>Execute a bare metal executable, or</span>
<span id="cb46-64"><a href="#cb46-64"></a><span class="ss">    - </span>Boot an operating system to enable the next higher-level task.</span>
<span id="cb46-65"><a href="#cb46-65"></a>    </span>
<span id="cb46-66"><a href="#cb46-66"></a><span class="fu">## What it sounds like</span></span>
<span id="cb46-67"><a href="#cb46-67"></a>    </span>
<span id="cb46-68"><a href="#cb46-68"></a><span class="ss">- </span>We regard, then, the operating system as a *system* which *operates* the *hardware* on behalf of higher level *software*.</span>
<span id="cb46-69"><a href="#cb46-69"></a><span class="ss">    - </span>Hence, "systems computing".</span>
<span id="cb46-70"><a href="#cb46-70"></a><span class="ss">    - </span>Hopefully the contrast to software is a bit more clear here.</span>
<span id="cb46-71"><a href="#cb46-71"></a>    </span>
<span id="cb46-72"><a href="#cb46-72"></a><span class="fu">## Aside</span></span>
<span id="cb46-73"><a href="#cb46-73"></a></span>
<span id="cb46-74"><a href="#cb46-74"></a><span class="ss">- </span>I am supposed to teach you about the "power-on self-test".</span>
<span id="cb46-75"><a href="#cb46-75"></a><span class="ss">- </span>A bit electrical engineering for me.</span>
<span id="cb46-76"><a href="#cb46-76"></a></span>
<span id="cb46-77"><a href="#cb46-77"></a><span class="at">&gt; </span><span class="co">[</span><span class="ot">A **power-on self-test** (POST) is a process performed by firmware or software routines immediately after a computer or other digital electronic device is powered on.</span><span class="co">](https://en.wikipedia.org/wiki/Power-on_self-test)</span></span>
<span id="cb46-78"><a href="#cb46-78"></a></span>
<span id="cb46-79"><a href="#cb46-79"></a><span class="ss">- </span>Neat! Moving on.</span>
<span id="cb46-80"><a href="#cb46-80"></a></span>
<span id="cb46-81"><a href="#cb46-81"></a><span class="fu">## Competing Standards</span></span>
<span id="cb46-82"><a href="#cb46-82"></a></span>
<span id="cb46-83"><a href="#cb46-83"></a><span class="ss">- </span>Lucky us, there is no widely agreed upon way to do firmware.</span>
<span id="cb46-84"><a href="#cb46-84"></a><span class="ss">- </span>There's the cool, old way that doesn't work well but is easy.</span>
<span id="cb46-85"><a href="#cb46-85"></a><span class="ss">    - </span>“Basic Input/Output System“ <span class="co">[</span><span class="ot">**BIOS**</span><span class="co">](https://en.wikipedia.org/wiki/BIOS)</span></span>
<span id="cb46-86"><a href="#cb46-86"></a><span class="ss">    - </span>1981</span>
<span id="cb46-87"><a href="#cb46-87"></a>    </span>
<span id="cb46-88"><a href="#cb46-88"></a><span class="fu">## Competing Standards</span></span>
<span id="cb46-89"><a href="#cb46-89"></a>    </span>
<span id="cb46-90"><a href="#cb46-90"></a><span class="ss">- </span>There's the new way that is too hard to use for normal people like us.</span>
<span id="cb46-91"><a href="#cb46-91"></a><span class="ss">    - </span>As in people who do anything else ever.</span>
<span id="cb46-92"><a href="#cb46-92"></a><span class="ss">    - </span>It's good though we promise.</span>
<span id="cb46-93"><a href="#cb46-93"></a><span class="ss">    - </span>“Unified Extensible Firmware Interface” <span class="co">[</span><span class="ot">**UEFI**</span><span class="co">](https://en.wikipedia.org/wiki/Unified_Extensible_Firmware_Interface)</span>.</span>
<span id="cb46-94"><a href="#cb46-94"></a><span class="ss">    - </span>May make you use it for a lab. <span class="co">[</span><span class="ot">More.</span><span class="co">](https://github.com/le-jzr/sisyphos-kernel-uefi-x86_64)</span></span>
<span id="cb46-95"><a href="#cb46-95"></a><span class="ss">    - </span>2006</span>
<span id="cb46-96"><a href="#cb46-96"></a></span>
<span id="cb46-97"><a href="#cb46-97"></a><span class="fu">## BIOS Boot</span></span>
<span id="cb46-98"><a href="#cb46-98"></a></span>
<span id="cb46-99"><a href="#cb46-99"></a><span class="ss">- </span>I actually started fooling around with the BIOS before UEFI even existed.</span>
<span id="cb46-100"><a href="#cb46-100"></a><span class="ss">    - </span>I was a normal kid though 100%.</span>
<span id="cb46-101"><a href="#cb46-101"></a><span class="ss">- </span>Fortunately it's still basically around. Quoth Blog:</span>
<span id="cb46-102"><a href="#cb46-102"></a></span>
<span id="cb46-103"><a href="#cb46-103"></a><span class="at">&gt; This is great, because you can use the same boot logic across all machines from the last century. </span></span>
<span id="cb46-104"><a href="#cb46-104"></a></span>
<span id="cb46-105"><a href="#cb46-105"></a><span class="fu">## Upsides</span></span>
<span id="cb46-106"><a href="#cb46-106"></a></span>
<span id="cb46-107"><a href="#cb46-107"></a><span class="ss">- </span>Blog says it's a downside that this means you have to do 16-bit mode.</span>
<span id="cb46-108"><a href="#cb46-108"></a><span class="ss">    - </span>I say: that's cool.</span>
<span id="cb46-109"><a href="#cb46-109"></a><span class="ss">    - </span>I can't count higher than about 0xFFFF anyways.</span>
<span id="cb46-110"><a href="#cb46-110"></a><span class="ss">- </span>The blog impolitely calls 1980s bootloaders "archaic" instead of "vintage", "retro", or "foundational".</span>
<span id="cb46-111"><a href="#cb46-111"></a></span>
<span id="cb46-112"><a href="#cb46-112"></a><span class="fu">## Bootable Disks</span></span>
<span id="cb46-113"><a href="#cb46-113"></a></span>
<span id="cb46-114"><a href="#cb46-114"></a><span class="ss">- </span>I should also tell you about *bootable disks*</span>
<span id="cb46-115"><a href="#cb46-115"></a><span class="ss">- </span>Nowadays we all boot from SSD or rarely HDD.</span>
<span id="cb46-116"><a href="#cb46-116"></a><span class="ss">- </span>But you have probably at some point booted from USB.</span>
<span id="cb46-117"><a href="#cb46-117"></a><span class="ss">    - </span>Usually when removing a virus like Microsoft Windows from your system.</span>
<span id="cb46-118"><a href="#cb46-118"></a><span class="ss">- </span>Olden days computers could boot from floppy disks, etc.</span>
<span id="cb46-119"><a href="#cb46-119"></a></span>
<span id="cb46-120"><a href="#cb46-120"></a><span class="fu">## Bootlaoder</span></span>
<span id="cb46-121"><a href="#cb46-121"></a></span>
<span id="cb46-122"><a href="#cb46-122"></a><span class="ss">- </span>I mentioned 1980s bootloaders.</span>
<span id="cb46-123"><a href="#cb46-123"></a><span class="ss">    - </span>No relation to bootleggers or boatloaders.</span>
<span id="cb46-124"><a href="#cb46-124"></a><span class="ss">- </span>512-byte portion of executable code stored at the bootable disk's "beginning". </span>
<span id="cb46-125"><a href="#cb46-125"></a><span class="ss">    - </span>On a HDD this is physically the outermost ring of addressable magnetic regions.</span>
<span id="cb46-126"><a href="#cb46-126"></a><span class="ss">    - </span>I don't know how SSDs work as Samsung, SK Hynix, or Micron (shout out Boise).</span>
<span id="cb46-127"><a href="#cb46-127"></a></span>
<span id="cb46-128"><a href="#cb46-128"></a><span class="fu">## Data Structures</span></span>
<span id="cb46-129"><a href="#cb46-129"></a></span>
<span id="cb46-130"><a href="#cb46-130"></a><span class="ss">- </span>Most bootloaders are larger than 512 bytes.</span>
<span id="cb46-131"><a href="#cb46-131"></a><span class="ss">- </span>So bootloaders are commonly split into a 512 byte first stage that loads a latter stage.</span>
<span id="cb46-132"><a href="#cb46-132"></a><span class="ss">    - </span>This is why we should still be teaching linked lists, basically.</span>
<span id="cb46-133"><a href="#cb46-133"></a>    </span>
<span id="cb46-134"><a href="#cb46-134"></a><span class="fu">## Location, Location</span></span>
<span id="cb46-135"><a href="#cb46-135"></a></span>
<span id="cb46-136"><a href="#cb46-136"></a><span class="ss">- </span>The bootloader lives in a reserved physical (HDD) or logical (SSD) location.</span>
<span id="cb46-137"><a href="#cb46-137"></a><span class="ss">- </span>Does the OS?</span>
<span id="cb46-138"><a href="#cb46-138"></a><span class="ss">    - </span>With respect to itself, yes, the OS probably says it lives at memory location zero.</span>
<span id="cb46-139"><a href="#cb46-139"></a><span class="ss">    - </span>With respect to underlying hardware? Probably not.</span>
<span id="cb46-140"><a href="#cb46-140"></a><span class="ss">        - </span>Gotta find it.</span>
<span id="cb46-141"><a href="#cb46-141"></a>        </span>
<span id="cb46-142"><a href="#cb46-142"></a><span class="fu">## Booting the OS</span></span>
<span id="cb46-143"><a href="#cb46-143"></a></span>
<span id="cb46-144"><a href="#cb46-144"></a><span class="ss">- </span>The bootloader has to determine the location of the *kernel image* on disk and load it into memory.</span>
<span id="cb46-145"><a href="#cb46-145"></a><span class="ss">    - </span>Basically this is the definition of the kernel, the minimal OS internal that runs first.</span>
<span id="cb46-146"><a href="#cb46-146"></a><span class="ss">    - </span>Image here means we have physical bits capturing some information, so copies of the bits may live in different places.</span>
<span id="cb46-147"><a href="#cb46-147"></a><span class="ss">        - </span>SSD and RAM, for example.</span>
<span id="cb46-148"><a href="#cb46-148"></a>        </span>
<span id="cb46-149"><a href="#cb46-149"></a><span class="fu">## Switcheroo</span></span>
<span id="cb46-150"><a href="#cb46-150"></a></span>
<span id="cb46-151"><a href="#cb46-151"></a><span class="ss">- </span>The OS probably is not a 16-bit OS.</span>
<span id="cb46-152"><a href="#cb46-152"></a><span class="ss">    - </span>Unless? Lab idea? Hold me back!</span>
<span id="cb46-153"><a href="#cb46-153"></a><span class="ss">- </span>Big OS wants me to tell you that:</span>
<span id="cb46-154"><a href="#cb46-154"></a><span class="ss">    - </span>16-bit mode is called "real mode"</span>
<span id="cb46-155"><a href="#cb46-155"></a><span class="ss">    - </span>32-bit mode is called "protected mode"</span>
<span id="cb46-156"><a href="#cb46-156"></a><span class="ss">    - </span>64-bit mode is called "long mode".</span>
<span id="cb46-157"><a href="#cb46-157"></a><span class="ss">- </span>Recall we were writing 64-bit bare metal.</span>
<span id="cb46-158"><a href="#cb46-158"></a></span>
<span id="cb46-159"><a href="#cb46-159"></a><span class="fu">## Hand-wave</span></span>
<span id="cb46-160"><a href="#cb46-160"></a></span>
<span id="cb46-161"><a href="#cb46-161"></a><span class="at">&gt; Writing a bootloader is a bit cumbersome as it requires assembly language and “write this magic value to this processor register”. </span></span>
<span id="cb46-162"><a href="#cb46-162"></a></span>
<span id="cb46-163"><a href="#cb46-163"></a><span class="at">&gt; Instead use a </span><span class="co">[</span><span class="ot">bootimage</span><span class="co">](https://github.com/rust-osdev/bootimage)</span><span class="at"> that automatically prepends a bootloader to your kernel.</span></span>
<span id="cb46-164"><a href="#cb46-164"></a></span>
<span id="cb46-165"><a href="#cb46-165"></a><span class="ss">- </span>This is called "cheating" and is a good way to get ahead in life.</span>
<span id="cb46-166"><a href="#cb46-166"></a></span>
<span id="cb46-167"><a href="#cb46-167"></a><span class="co">&lt;!--</span></span>
<span id="cb46-168"><a href="#cb46-168"></a></span>
<span id="cb46-169"><a href="#cb46-169"></a><span class="co">## The Multiboot Standard</span></span>
<span id="cb46-170"><a href="#cb46-170"></a></span>
<span id="cb46-171"><a href="#cb46-171"></a><span class="co">To avoid that every operating system implements its own bootloader, which is only compatible with a single OS, the [Free Software Foundation] created an open bootloader standard called [Multiboot] in 1995. The standard defines an interface between the bootloader and the operating system, so that any Multiboot-compliant bootloader can load any Multiboot-compliant operating system. The reference implementation is [GNU GRUB], which is the most popular bootloader for Linux systems.</span></span>
<span id="cb46-172"><a href="#cb46-172"></a></span>
<span id="cb46-173"><a href="#cb46-173"></a><span class="co">[Free Software Foundation]: https://en.wikipedia.org/wiki/Free_Software_Foundation</span></span>
<span id="cb46-174"><a href="#cb46-174"></a><span class="co">[Multiboot]: https://wiki.osdev.org/Multiboot</span></span>
<span id="cb46-175"><a href="#cb46-175"></a><span class="co">[GNU GRUB]: https://en.wikipedia.org/wiki/GNU_GRUB</span></span>
<span id="cb46-176"><a href="#cb46-176"></a></span>
<span id="cb46-177"><a href="#cb46-177"></a><span class="co">To make a kernel Multiboot compliant, one just needs to insert a so-called [Multiboot header] at the beginning of the kernel file. This makes it very easy to boot an OS from GRUB. However, GRUB and the Multiboot standard have some problems too:</span></span>
<span id="cb46-178"><a href="#cb46-178"></a></span>
<span id="cb46-179"><a href="#cb46-179"></a><span class="co">[Multiboot header]: https://www.gnu.org/software/grub/manual/multiboot/multiboot.html#OS-image-format</span></span>
<span id="cb46-180"><a href="#cb46-180"></a></span>
<span id="cb46-181"><a href="#cb46-181"></a><span class="co">- They support only the 32-bit protected mode. This means that you still have to do the CPU configuration to switch to the 64-bit long mode.</span></span>
<span id="cb46-182"><a href="#cb46-182"></a><span class="co">- They are designed to make the bootloader simple instead of the kernel. For example, the kernel needs to be linked with an [adjusted default page size], because GRUB can't find the Multiboot header otherwise. Another example is that the [boot information], which is passed to the kernel, contains lots of architecture-dependent structures instead of providing clean abstractions.</span></span>
<span id="cb46-183"><a href="#cb46-183"></a><span class="co">- Both GRUB and the Multiboot standard are only sparsely documented.</span></span>
<span id="cb46-184"><a href="#cb46-184"></a><span class="co">- GRUB needs to be installed on the host system to create a bootable disk image from the kernel file. This makes development on Windows or Mac more difficult.</span></span>
<span id="cb46-185"><a href="#cb46-185"></a></span>
<span id="cb46-186"><a href="#cb46-186"></a><span class="co">[adjusted default page size]: https://wiki.osdev.org/Multiboot#Multiboot_2</span></span>
<span id="cb46-187"><a href="#cb46-187"></a><span class="co">[boot information]: https://www.gnu.org/software/grub/manual/multiboot/multiboot.html#Boot-information-format</span></span>
<span id="cb46-188"><a href="#cb46-188"></a></span>
<span id="cb46-189"><a href="#cb46-189"></a><span class="co">Because of these drawbacks, we decided to not use GRUB or the Multiboot standard. However, we plan to add Multiboot support to our [bootimage] tool, so that it's possible to load your kernel on a GRUB system too. If you're interested in writing a Multiboot compliant kernel, check out the [first edition] of this blog series.</span></span>
<span id="cb46-190"><a href="#cb46-190"></a></span>
<span id="cb46-191"><a href="#cb46-191"></a><span class="co">[first edition]: @/edition-1/_index.md</span></span>
<span id="cb46-192"><a href="#cb46-192"></a></span>
<span id="cb46-193"><a href="#cb46-193"></a><span class="co">--&gt;</span></span>
<span id="cb46-194"><a href="#cb46-194"></a></span>
<span id="cb46-195"><a href="#cb46-195"></a><span class="fu"># Kernel</span></span>
<span id="cb46-196"><a href="#cb46-196"></a></span>
<span id="cb46-197"><a href="#cb46-197"></a><span class="fu">## A Minimal Kernel</span></span>
<span id="cb46-198"><a href="#cb46-198"></a></span>
<span id="cb46-199"><a href="#cb46-199"></a><span class="ss">- </span>Let's make a kernel.</span>
<span id="cb46-200"><a href="#cb46-200"></a><span class="ss">- </span>Specifically, a disk image that prints a “Hello World!” to the screen when booted.</span>
<span id="cb46-201"><a href="#cb46-201"></a><span class="ss">- </span>We extending our bare metal executable.</span>
<span id="cb46-202"><a href="#cb46-202"></a></span>
<span id="cb46-203"><a href="#cb46-203"></a><span class="co">&lt;!--</span></span>
<span id="cb46-204"><a href="#cb46-204"></a></span>
<span id="cb46-205"><a href="#cb46-205"></a><span class="co">## Installing Rust Nightly</span></span>
<span id="cb46-206"><a href="#cb46-206"></a></span>
<span id="cb46-207"><a href="#cb46-207"></a><span class="co">Rust has three release channels: _stable_, _beta_, and _nightly_. The Rust Book explains the difference between these channels really well, so take a minute and [check it out](https://doc.rust-lang.org/book/appendix-07-nightly-rust.html#choo-choo-release-channels-and-riding-the-trains). For building an operating system, we will need some experimental features that are only available on the nightly channel, so we need to install a nightly version of Rust.</span></span>
<span id="cb46-208"><a href="#cb46-208"></a></span>
<span id="cb46-209"><a href="#cb46-209"></a><span class="co">To manage Rust installations, I highly recommend [rustup]. It allows you to install nightly, beta, and stable compilers side-by-side and makes it easy to update them. With rustup, you can use a nightly compiler for the current directory by running `rustup override set nightly`. Alternatively, you can add a file called `rust-toolchain` with the content `nightly` to the project's root directory. You can check that you have a nightly version installed by running `rustc --version`: The version number should contain `-nightly` at the end.</span></span>
<span id="cb46-210"><a href="#cb46-210"></a></span>
<span id="cb46-211"><a href="#cb46-211"></a><span class="co">[rustup]: https://www.rustup.rs/</span></span>
<span id="cb46-212"><a href="#cb46-212"></a></span>
<span id="cb46-213"><a href="#cb46-213"></a><span class="co">The nightly compiler allows us to opt-in to various experimental features by using so-called _feature flags_ at the top of our file. For example, we could enable the experimental [`asm!` macro] for inline assembly by adding `#![feature(asm)]` to the top of our `main.rs`. Note that such experimental features are completely unstable, which means that future Rust versions might change or remove them without prior warning. For this reason, we will only use them if absolutely necessary.</span></span>
<span id="cb46-214"><a href="#cb46-214"></a></span>
<span id="cb46-215"><a href="#cb46-215"></a><span class="co">[`asm!` macro]: https://doc.rust-lang.org/stable/reference/inline-assembly.html</span></span>
<span id="cb46-216"><a href="#cb46-216"></a></span>
<span id="cb46-217"><a href="#cb46-217"></a><span class="co">--&gt;</span></span>
<span id="cb46-218"><a href="#cb46-218"></a></span>
<span id="cb46-219"><a href="#cb46-219"></a><span class="fu">## Target Triple</span></span>
<span id="cb46-220"><a href="#cb46-220"></a></span>
<span id="cb46-221"><a href="#cb46-221"></a><span class="ss">- </span>We recall the "<span class="co">[</span><span class="ot">target triple</span><span class="co">](31_linker.md#target-triple)</span>"</span>
<span id="cb46-222"><a href="#cb46-222"></a><span class="ss">- </span>Imagine <span class="in">`host`</span> triple is <span class="in">`x86_64-unknown-linux-gnu`</span></span>
<span id="cb46-223"><a href="#cb46-223"></a><span class="ss">    - </span>CPU architecture (<span class="in">`x86_64`</span>), </span>
<span id="cb46-224"><a href="#cb46-224"></a><span class="ss">    - </span>Vendor (<span class="in">`unknown`</span>) - It's Intel #Portland</span>
<span id="cb46-225"><a href="#cb46-225"></a><span class="ss">    - </span>Operating system (<span class="in">`linux`</span>)</span>
<span id="cb46-226"><a href="#cb46-226"></a><span class="ss">    - </span>The <span class="co">[</span><span class="ot">ABI</span><span class="co">](https://en.wikipedia.org/wiki/Application_binary_interface)</span> (<span class="in">`gnu`</span>).</span>
<span id="cb46-227"><a href="#cb46-227"></a></span>
<span id="cb46-228"><a href="#cb46-228"></a></span>
<span id="cb46-229"><a href="#cb46-229"></a><span class="fu">## Our Target</span></span>
<span id="cb46-230"><a href="#cb46-230"></a></span>
<span id="cb46-231"><a href="#cb46-231"></a><span class="ss">- </span>I am aware of no existing target triple suitable for this course.</span>
<span id="cb46-232"><a href="#cb46-232"></a><span class="ss">- </span>So, make our own.</span>
<span id="cb46-233"><a href="#cb46-233"></a><span class="ss">- </span>It's not too bad, just JSON.</span>
<span id="cb46-234"><a href="#cb46-234"></a><span class="ss">    - </span>We'll specify some easy stuff, like architecture.</span>
<span id="cb46-235"><a href="#cb46-235"></a><span class="ss">    - </span>Some weird stuff, like manual memory layouts.</span>
<span id="cb46-236"><a href="#cb46-236"></a><span class="ss">    - </span>And get on with things.</span>
<span id="cb46-237"><a href="#cb46-237"></a>    </span>
<span id="cb46-238"><a href="#cb46-238"></a><span class="fu">## JSON</span></span>
<span id="cb46-239"><a href="#cb46-239"></a></span>
<span id="cb46-240"><a href="#cb46-240"></a><span class="ss">- </span>JSON rules by the way.</span>
<span id="cb46-241"><a href="#cb46-241"></a></span>
<span id="cb46-242"><a href="#cb46-242"></a><span class="in">```{.json}</span></span>
<span id="cb46-243"><a href="#cb46-243"></a><span class="in">{</span></span>
<span id="cb46-244"><a href="#cb46-244"></a><span class="in">    "llvm-target": "x86_64-unknown-linux-gnu",</span></span>
<span id="cb46-245"><a href="#cb46-245"></a><span class="in">    "data-layout": "e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-i128:128-f80:128-n8:16:32:64-S128",</span></span>
<span id="cb46-246"><a href="#cb46-246"></a><span class="in">    "arch": "x86_64",</span></span>
<span id="cb46-247"><a href="#cb46-247"></a><span class="in">    "target-endian": "little",</span></span>
<span id="cb46-248"><a href="#cb46-248"></a><span class="in">    "target-pointer-width": 64,</span></span>
<span id="cb46-249"><a href="#cb46-249"></a><span class="in">    "target-c-int-width": 32,</span></span>
<span id="cb46-250"><a href="#cb46-250"></a><span class="in">    "os": "linux",</span></span>
<span id="cb46-251"><a href="#cb46-251"></a><span class="in">    "executables": true,</span></span>
<span id="cb46-252"><a href="#cb46-252"></a><span class="in">    "linker-flavor": "gcc",</span></span>
<span id="cb46-253"><a href="#cb46-253"></a><span class="in">    "pre-link-args": ["-m64"],</span></span>
<span id="cb46-254"><a href="#cb46-254"></a><span class="in">    "morestack": false</span></span>
<span id="cb46-255"><a href="#cb46-255"></a><span class="in">}</span></span>
<span id="cb46-256"><a href="#cb46-256"></a><span class="in">```</span></span>
<span id="cb46-257"><a href="#cb46-257"></a></span>
<span id="cb46-258"><a href="#cb46-258"></a><span class="fu">## Some context</span></span>
<span id="cb46-259"><a href="#cb46-259"></a></span>
<span id="cb46-260"><a href="#cb46-260"></a><span class="ss">- </span>Most fields are required by LLVM. </span>
<span id="cb46-261"><a href="#cb46-261"></a><span class="ss">- </span>Data layout field defines the size of integer, float (ew), and pointer types. </span>
<span id="cb46-262"><a href="#cb46-262"></a><span class="ss">- </span>Rust uses conditional compilation, such as via <span class="in">`target-pointer-width`</span>. </span>
<span id="cb46-263"><a href="#cb46-263"></a><span class="ss">- </span>The <span class="in">`pre-link-args`</span> field specifies arguments passed to the linker.</span>
<span id="cb46-264"><a href="#cb46-264"></a></span>
<span id="cb46-265"><a href="#cb46-265"></a><span class="fu">## ARM64 Take Notes</span></span>
<span id="cb46-266"><a href="#cb46-266"></a></span>
<span id="cb46-267"><a href="#cb46-267"></a><span class="ss">- </span>We also target <span class="in">`x86_64`</span>.</span>
<span id="cb46-268"><a href="#cb46-268"></a><span class="ss">- </span>Start here:</span>
<span id="cb46-269"><a href="#cb46-269"></a></span>
<span id="cb46-270"><a href="#cb46-270"></a><span class="in">```{.json filename="x86_64-osirs.json"}</span></span>
<span id="cb46-271"><a href="#cb46-271"></a><span class="in">{</span></span>
<span id="cb46-272"><a href="#cb46-272"></a><span class="in">    "llvm-target": "x86_64-unknown-none",</span></span>
<span id="cb46-273"><a href="#cb46-273"></a><span class="in">    "data-layout": "e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-i128:128-f80:128-n8:16:32:64-S128",</span></span>
<span id="cb46-274"><a href="#cb46-274"></a><span class="in">    "arch": "x86_64",</span></span>
<span id="cb46-275"><a href="#cb46-275"></a><span class="in">    "target-endian": "little",</span></span>
<span id="cb46-276"><a href="#cb46-276"></a><span class="in">    "target-pointer-width": 64,</span></span>
<span id="cb46-277"><a href="#cb46-277"></a><span class="in">    "target-c-int-width": 32,</span></span>
<span id="cb46-278"><a href="#cb46-278"></a><span class="in">    "os": "none",</span></span>
<span id="cb46-279"><a href="#cb46-279"></a><span class="in">    "executables": true</span></span>
<span id="cb46-280"><a href="#cb46-280"></a><span class="in">}</span></span>
<span id="cb46-281"><a href="#cb46-281"></a><span class="in">```</span></span>
<span id="cb46-282"><a href="#cb46-282"></a></span>
<span id="cb46-283"><a href="#cb46-283"></a><span class="fu">## Changes</span></span>
<span id="cb46-284"><a href="#cb46-284"></a></span>
<span id="cb46-285"><a href="#cb46-285"></a><span class="ss">- </span>Note that we changed the OS in the <span class="in">`llvm-target`</span> and the <span class="in">`os`</span> field to <span class="in">`none`</span>, because we will run on bare metal.</span>
<span id="cb46-286"><a href="#cb46-286"></a></span>
<span id="cb46-287"><a href="#cb46-287"></a><span class="in">```{.json filename="x86_64-osirs.json" code-line-numbers="2, 8"}</span></span>
<span id="cb46-288"><a href="#cb46-288"></a><span class="in">{</span></span>
<span id="cb46-289"><a href="#cb46-289"></a><span class="in">    "llvm-target": "x86_64-unknown-none",</span></span>
<span id="cb46-290"><a href="#cb46-290"></a><span class="in">    ...</span></span>
<span id="cb46-291"><a href="#cb46-291"></a><span class="in">    "os": "none",</span></span>
<span id="cb46-292"><a href="#cb46-292"></a><span class="in">    ...</span></span>
<span id="cb46-293"><a href="#cb46-293"></a><span class="in">}</span></span>
<span id="cb46-294"><a href="#cb46-294"></a><span class="in">```</span></span>
<span id="cb46-295"><a href="#cb46-295"></a></span>
<span id="cb46-296"><a href="#cb46-296"></a><span class="fu">## Linking</span></span>
<span id="cb46-297"><a href="#cb46-297"></a></span>
<span id="cb46-298"><a href="#cb46-298"></a><span class="ss">- </span>We'll add the following build-related entries:</span>
<span id="cb46-299"><a href="#cb46-299"></a></span>
<span id="cb46-300"><a href="#cb46-300"></a></span>
<span id="cb46-301"><a href="#cb46-301"></a><span class="in">```{.json filename="x86_64-osirs.json"}</span></span>
<span id="cb46-302"><a href="#cb46-302"></a><span class="in">{</span></span>
<span id="cb46-303"><a href="#cb46-303"></a><span class="in">    "linker-flavor": "ld.lld",</span></span>
<span id="cb46-304"><a href="#cb46-304"></a><span class="in">    "linker": "rust-lld",</span></span>
<span id="cb46-305"><a href="#cb46-305"></a><span class="in">}</span></span>
<span id="cb46-306"><a href="#cb46-306"></a><span class="in">```</span></span>
<span id="cb46-307"><a href="#cb46-307"></a></span>
<span id="cb46-308"><a href="#cb46-308"></a><span class="ss">- </span>For OS-agnosticism, we use the cross-platform "LLD" linker that is shipped with Rust for linking our kernel.</span>
<span id="cb46-309"><a href="#cb46-309"></a><span class="ss">    - </span><span class="co">[</span><span class="ot">More.</span><span class="co">](https://lld.llvm.org/)</span></span>
<span id="cb46-310"><a href="#cb46-310"></a></span>
<span id="cb46-311"><a href="#cb46-311"></a><span class="fu">## Panic Abort</span></span>
<span id="cb46-312"><a href="#cb46-312"></a></span>
<span id="cb46-313"><a href="#cb46-313"></a><span class="ss">- </span>You know how I feel about unwinding.</span>
<span id="cb46-314"><a href="#cb46-314"></a><span class="ss">    - </span>I have never relaxed in my life.</span>
<span id="cb46-315"><a href="#cb46-315"></a><span class="ss">    - </span>I've only panicked and given up.</span>
<span id="cb46-316"><a href="#cb46-316"></a></span>
<span id="cb46-317"><a href="#cb46-317"></a><span class="in">```{.json filename="x86_64-osirs.json"}</span></span>
<span id="cb46-318"><a href="#cb46-318"></a><span class="in">{</span></span>
<span id="cb46-319"><a href="#cb46-319"></a><span class="in">    "panic-strategy": "abort",</span></span>
<span id="cb46-320"><a href="#cb46-320"></a><span class="in">}</span></span>
<span id="cb46-321"><a href="#cb46-321"></a><span class="in">```</span></span>
<span id="cb46-322"><a href="#cb46-322"></a></span>
<span id="cb46-323"><a href="#cb46-323"></a><span class="fu">## Target vs. TOML</span></span>
<span id="cb46-324"><a href="#cb46-324"></a></span>
<span id="cb46-325"><a href="#cb46-325"></a><span class="ss">- </span>This has the same effect as the <span class="in">`panic = "abort"`</span> option in our Cargo.toml </span>
<span id="cb46-326"><a href="#cb46-326"></a><span class="ss">- </span>So we can remove it from there! </span>
<span id="cb46-327"><a href="#cb46-327"></a><span class="ss">- </span>This is better though:</span>
<span id="cb46-328"><a href="#cb46-328"></a><span class="ss">    - </span>We will use <span class="in">`core`</span>, an architecture specific library, and we need <span class="in">`core`</span> to *also* panic abort.</span>
<span id="cb46-329"><a href="#cb46-329"></a><span class="ss">    - </span><span class="co">[</span><span class="ot">"It is the portable glue between the language and its libraries, defining the intrinsic and primitive building blocks of all Rust code."</span><span class="co">](https://doc.rust-lang.org/core/)</span></span>
<span id="cb46-330"><a href="#cb46-330"></a></span>
<span id="cb46-331"><a href="#cb46-331"></a></span>
<span id="cb46-332"><a href="#cb46-332"></a><span class="fu">## Red Zone</span></span>
<span id="cb46-333"><a href="#cb46-333"></a></span>
<span id="cb46-334"><a href="#cb46-334"></a><span class="ss">- </span>Okay red zone is not particularly relevant to this class.</span>
<span id="cb46-335"><a href="#cb46-335"></a><span class="ss">- </span>But it is *extremely* cool.</span>
<span id="cb46-336"><a href="#cb46-336"></a></span>
<span id="cb46-337"><a href="#cb46-337"></a><span class="in">```{.json filename="x86_64-osirs.json"}</span></span>
<span id="cb46-338"><a href="#cb46-338"></a><span class="in">{</span></span>
<span id="cb46-339"><a href="#cb46-339"></a><span class="in">    "disable-redzone": true,</span></span>
<span id="cb46-340"><a href="#cb46-340"></a><span class="in">}</span></span>
<span id="cb46-341"><a href="#cb46-341"></a><span class="in">```</span></span>
<span id="cb46-342"><a href="#cb46-342"></a></span>
<span id="cb46-343"><a href="#cb46-343"></a><span class="co">&lt;!--</span></span>
<span id="cb46-344"><a href="#cb46-344"></a></span>
<span id="cb46-345"><a href="#cb46-345"></a><span class="co">- So I'm going to tell you about it.</span></span>
<span id="cb46-346"><a href="#cb46-346"></a></span>
<span id="cb46-347"><a href="#cb46-347"></a><span class="co">## The Red Zone</span></span>
<span id="cb46-348"><a href="#cb46-348"></a></span>
<span id="cb46-349"><a href="#cb46-349"></a><span class="co">- The **Red Zone** is a 128-byte optimization area below the current stack pointer ($RSP$).</span></span>
<span id="cb46-350"><a href="#cb46-350"></a><span class="co">    - "R" for 64 bit.</span></span>
<span id="cb46-351"><a href="#cb46-351"></a><span class="co">    - "SP" for "stack pointer"</span></span>
<span id="cb46-352"><a href="#cb46-352"></a><span class="co">- It is a specific feature of the x86-64 System V ABI (Application Binary Interface).</span></span>
<span id="cb46-353"><a href="#cb46-353"></a><span class="co">- It allows functions to use a small amount of stack space without actually moving the pointer.</span></span>
<span id="cb46-354"><a href="#cb46-354"></a></span>
<span id="cb46-355"><a href="#cb46-355"></a><span class="co">## Performance Gains</span></span>
<span id="cb46-356"><a href="#cb46-356"></a></span>
<span id="cb46-357"><a href="#cb46-357"></a><span class="co">- Normally, any data written to the stack requires an $RSP$ adjustment to prevent data corruption.</span></span>
<span id="cb46-358"><a href="#cb46-358"></a><span class="co">    - `sub rsp, 8`</span></span>
<span id="cb46-359"><a href="#cb46-359"></a><span class="co">    - `mov [rsp], rax`</span></span>
<span id="cb46-360"><a href="#cb46-360"></a><span class="co">- With the Red Zone, compilers can skip the subtraction for some functions.</span></span>
<span id="cb46-361"><a href="#cb46-361"></a><span class="co">- This reduces the number of instructions and speeds up function execution.</span></span>
<span id="cb46-362"><a href="#cb46-362"></a><span class="co">    - At the cost of *no longer tracking the stack*.</span></span>
<span id="cb46-363"><a href="#cb46-363"></a></span>
<span id="cb46-364"><a href="#cb46-364"></a><span class="co">## Negative Indexing</span></span>
<span id="cb46-365"><a href="#cb46-365"></a></span>
<span id="cb46-366"><a href="#cb46-366"></a><span class="co">- Since $RSP$ remains at the "top" of the stack, we access this memory using negative offsets.</span></span>
<span id="cb46-367"><a href="#cb46-367"></a><span class="co">- In assembly, this looks like `mov [rsp - 16], rax`.</span></span>
<span id="cb46-368"><a href="#cb46-368"></a><span class="co">- This treats the stack as a fixed-base array rather than a stack ADT.</span></span>
<span id="cb46-369"><a href="#cb46-369"></a><span class="co">- It is essentially "free" scratch space for short-lived data.</span></span>
<span id="cb46-370"><a href="#cb46-370"></a></span>
<span id="cb46-371"><a href="#cb46-371"></a><span class="co">## The Danger of Interrupts</span></span>
<span id="cb46-372"><a href="#cb46-372"></a></span>
<span id="cb46-373"><a href="#cb46-373"></a><span class="co">- The Red Zone is dangerous in kernel development because of **hardware interrupts**.</span></span>
<span id="cb46-374"><a href="#cb46-374"></a><span class="co">    - The OS has to deal with, say, someone hitting the power off button.</span></span>
<span id="cb46-375"><a href="#cb46-375"></a><span class="co">    - Someone plugging in a USB drive.</span></span>
<span id="cb46-376"><a href="#cb46-376"></a><span class="co">    - Lightning strikes.</span></span>
<span id="cb46-377"><a href="#cb46-377"></a><span class="co">    - Cosmic rays flipping bits</span></span>
<span id="cb46-378"><a href="#cb46-378"></a><span class="co">    </span></span>
<span id="cb46-379"><a href="#cb46-379"></a><span class="co">## Red Zone to Dead Zone</span></span>
<span id="cb46-380"><a href="#cb46-380"></a><span class="co">    </span></span>
<span id="cb46-381"><a href="#cb46-381"></a><span class="co">- When an interrupt occurs, the CPU pushes state (like $RIP$ and $RFLAGS$) onto the stack.</span></span>
<span id="cb46-382"><a href="#cb46-382"></a><span class="co">    - "Instruction pointer" and "flags".</span></span>
<span id="cb46-383"><a href="#cb46-383"></a><span class="co">- This will overwrite those 128 bytes of data.</span></span>
<span id="cb46-384"><a href="#cb46-384"></a><span class="co">- This leads to silent, non-deterministic memory corruption.</span></span>
<span id="cb46-385"><a href="#cb46-385"></a><span class="co">    - Generally regarded as bad.</span></span>
<span id="cb46-386"><a href="#cb46-386"></a><span class="co">    </span></span>
<span id="cb46-387"><a href="#cb46-387"></a><span class="co">## Read more</span></span>
<span id="cb46-388"><a href="#cb46-388"></a></span>
<span id="cb46-389"><a href="#cb46-389"></a><span class="co">- There are good visuals here.</span></span>
<span id="cb46-390"><a href="#cb46-390"></a><span class="co">- [Read more](https://os.phil-opp.com/red-zone/)</span></span>
<span id="cb46-391"><a href="#cb46-391"></a><span class="co">- Handwaving now - Better for the compilers class I think!</span></span>
<span id="cb46-392"><a href="#cb46-392"></a></span>
<span id="cb46-393"><a href="#cb46-393"></a><span class="co">--&gt;</span></span>
<span id="cb46-394"><a href="#cb46-394"></a></span>
<span id="cb46-395"><a href="#cb46-395"></a><span class="fu">## Ancient Nemesis</span></span>
<span id="cb46-396"><a href="#cb46-396"></a></span>
<span id="cb46-397"><a href="#cb46-397"></a><span class="ss">- </span>You all know I love floating point numbers.</span>
<span id="cb46-398"><a href="#cb46-398"></a><span class="ss">    - </span>And with good reason!</span>
<span id="cb46-399"><a href="#cb46-399"></a></span>
<span id="cb46-400"><a href="#cb46-400"></a><span class="in">```{.json filename="x86_64-osirs.json"}</span></span>
<span id="cb46-401"><a href="#cb46-401"></a><span class="in">{</span></span>
<span id="cb46-402"><a href="#cb46-402"></a><span class="in">    "features": "-mmx,-sse,+soft-float",</span></span>
<span id="cb46-403"><a href="#cb46-403"></a><span class="in">}</span></span>
<span id="cb46-404"><a href="#cb46-404"></a><span class="in">```</span></span>
<span id="cb46-405"><a href="#cb46-405"></a></span>
<span id="cb46-406"><a href="#cb46-406"></a><span class="fu">## Turn off floats</span></span>
<span id="cb46-407"><a href="#cb46-407"></a></span>
<span id="cb46-408"><a href="#cb46-408"></a><span class="ss">- </span><span class="in">`features`</span> enables/disables target features. </span>
<span id="cb46-409"><a href="#cb46-409"></a><span class="ss">- </span>We disable the <span class="in">`mmx`</span> and <span class="in">`sse`</span> features by prefixing them with a minus</span>
<span id="cb46-410"><a href="#cb46-410"></a><span class="ss">- </span>We enable the <span class="in">`soft-float`</span> feature by prefixing it with a plus. </span>
<span id="cb46-411"><a href="#cb46-411"></a><span class="ss">- </span>Note that there must be no spaces between different flags!</span>
<span id="cb46-412"><a href="#cb46-412"></a></span>
<span id="cb46-413"><a href="#cb46-413"></a><span class="fu">## MMX/SSE</span></span>
<span id="cb46-414"><a href="#cb46-414"></a></span>
<span id="cb46-415"><a href="#cb46-415"></a><span class="ss">- </span>The <span class="in">`mmx`</span> and <span class="in">`sse`</span> features are performance optimizing vector operations from when Intel though they'd be able to hold off NVIDIA in the 90s.</span>
<span id="cb46-416"><a href="#cb46-416"></a><span class="ss">- </span>These are braodly called <span class="co">[</span><span class="ot">Single Instruction Multiple Data (SIMD)</span><span class="co">](https://en.wikipedia.org/wiki/SIMD)</span> instructions and are historically important.</span>
<span id="cb46-417"><a href="#cb46-417"></a><span class="ss">    - </span>Foundation of <span class="in">`numpy`</span></span>
<span id="cb46-418"><a href="#cb46-418"></a><span class="ss">- </span>We aren't using data frames in our kernel.</span>
<span id="cb46-419"><a href="#cb46-419"></a></span>
<span id="cb46-420"><a href="#cb46-420"></a><span class="fu">## Soft Float</span></span>
<span id="cb46-421"><a href="#cb46-421"></a></span>
<span id="cb46-422"><a href="#cb46-422"></a><span class="ss">- </span>Floating point operations on <span class="in">`x86_64`</span> require SIMD registers by default. </span>
<span id="cb46-423"><a href="#cb46-423"></a><span class="ss">    - </span>That's right - floats are worse than you thought!</span>
<span id="cb46-424"><a href="#cb46-424"></a><span class="ss">- </span>To solve this problem, we add the <span class="in">`soft-float`</span> feature, which emulates all floating point operations through software functions based on normal integers.</span>
<span id="cb46-425"><a href="#cb46-425"></a><span class="ss">    - </span>Just like <span class="co">[</span><span class="ot">`f16`</span><span class="co">](https://cd-c89.github.io/rs/51_f16.html)</span></span>
<span id="cb46-426"><a href="#cb46-426"></a></span>
<span id="cb46-427"><a href="#cb46-427"></a><span class="fu">## Aside</span></span>
<span id="cb46-428"><a href="#cb46-428"></a></span>
<span id="cb46-429"><a href="#cb46-429"></a></span>
<span id="cb46-430"><a href="#cb46-430"></a><span class="ss">- </span>We also need to tell the Rust compiler <span class="in">`rustc`</span> that we want to use the corresponding ABI.</span>
<span id="cb46-431"><a href="#cb46-431"></a></span>
<span id="cb46-432"><a href="#cb46-432"></a><span class="in">```{.json filename="x86_64-osirs.json"}</span></span>
<span id="cb46-433"><a href="#cb46-433"></a><span class="in">{</span></span>
<span id="cb46-434"><a href="#cb46-434"></a><span class="in">    "rustc-abi": "x86-softfloat"</span></span>
<span id="cb46-435"><a href="#cb46-435"></a><span class="in">}</span></span>
<span id="cb46-436"><a href="#cb46-436"></a><span class="in">```</span></span>
<span id="cb46-437"><a href="#cb46-437"></a><span class="ss">- </span>I am 100% sure I can write an OS without hard or soft floats but I haven't worked far enough ahead to be absolutely certain.</span>
<span id="cb46-438"><a href="#cb46-438"></a></span>
<span id="cb46-439"><a href="#cb46-439"></a><span class="fu">## Altogether</span></span>
<span id="cb46-440"><a href="#cb46-440"></a></span>
<span id="cb46-441"><a href="#cb46-441"></a><span class="in">```{.json filename="x86_64-osirs.json"}</span></span>
<span id="cb46-442"><a href="#cb46-442"></a><span class="in">{</span></span>
<span id="cb46-443"><a href="#cb46-443"></a><span class="in">    "llvm-target": "x86_64-unknown-none",</span></span>
<span id="cb46-444"><a href="#cb46-444"></a><span class="in">    "data-layout": "e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-i128:128-f80:128-n8:16:32:64-S128",</span></span>
<span id="cb46-445"><a href="#cb46-445"></a><span class="in">    "arch": "x86_64",</span></span>
<span id="cb46-446"><a href="#cb46-446"></a><span class="in">    "target-endian": "little",</span></span>
<span id="cb46-447"><a href="#cb46-447"></a><span class="in">    "target-pointer-width": 64,</span></span>
<span id="cb46-448"><a href="#cb46-448"></a><span class="in">    "target-c-int-width": 32,</span></span>
<span id="cb46-449"><a href="#cb46-449"></a><span class="in">    "os": "none",</span></span>
<span id="cb46-450"><a href="#cb46-450"></a><span class="in">    "executables": true,</span></span>
<span id="cb46-451"><a href="#cb46-451"></a><span class="in">    "linker-flavor": "ld.lld",</span></span>
<span id="cb46-452"><a href="#cb46-452"></a><span class="in">    "linker": "rust-lld",</span></span>
<span id="cb46-453"><a href="#cb46-453"></a><span class="in">    "panic-strategy": "abort",</span></span>
<span id="cb46-454"><a href="#cb46-454"></a><span class="in">    "disable-redzone": true,</span></span>
<span id="cb46-455"><a href="#cb46-455"></a><span class="in">    "features": "-mmx,-sse,+soft-float",</span></span>
<span id="cb46-456"><a href="#cb46-456"></a><span class="in">    "rustc-abi": "x86-softfloat"</span></span>
<span id="cb46-457"><a href="#cb46-457"></a><span class="in">}</span></span>
<span id="cb46-458"><a href="#cb46-458"></a><span class="in">```</span></span>
<span id="cb46-459"><a href="#cb46-459"></a></span>
<span id="cb46-460"><a href="#cb46-460"></a><span class="fu">## I just `curl`</span></span>
<span id="cb46-461"><a href="#cb46-461"></a></span>
<span id="cb46-462"><a href="#cb46-462"></a><span class="in">```{.sh}</span></span>
<span id="cb46-463"><a href="#cb46-463"></a><span class="in">curl https://raw.githubusercontent.com/phil-opp/blog_os/refs/heads/post-02/x86_64-blog_os.json -o x86_64-osirs.json</span></span>
<span id="cb46-464"><a href="#cb46-464"></a><span class="in">```</span></span>
<span id="cb46-465"><a href="#cb46-465"></a></span>
<span id="cb46-466"><a href="#cb46-466"></a><span class="fu">## Tree</span></span>
<span id="cb46-467"><a href="#cb46-467"></a></span>
<span id="cb46-468"><a href="#cb46-468"></a><span class="ss">- </span>For me looks like this.</span>
<span id="cb46-469"><a href="#cb46-469"></a></span>
<span id="cb46-470"><a href="#cb46-470"></a><span class="in">```{.sh}</span></span>
<span id="cb46-471"><a href="#cb46-471"></a><span class="in">$ tree</span></span>
<span id="cb46-472"><a href="#cb46-472"></a><span class="in">.</span></span>
<span id="cb46-473"><a href="#cb46-473"></a><span class="in">├── Cargo.lock</span></span>
<span id="cb46-474"><a href="#cb46-474"></a><span class="in">├── Cargo.toml</span></span>
<span id="cb46-475"><a href="#cb46-475"></a><span class="in">├── src</span></span>
<span id="cb46-476"><a href="#cb46-476"></a><span class="in">│&nbsp;&nbsp; ├── main.rs</span></span>
<span id="cb46-477"><a href="#cb46-477"></a><span class="in">│&nbsp;&nbsp; └── old.rs</span></span>
<span id="cb46-478"><a href="#cb46-478"></a><span class="in">└── x86_64-osirs.json</span></span>
<span id="cb46-479"><a href="#cb46-479"></a></span>
<span id="cb46-480"><a href="#cb46-480"></a><span class="in">1 directory, 5 files</span></span>
<span id="cb46-481"><a href="#cb46-481"></a><span class="in">```</span></span>
<span id="cb46-482"><a href="#cb46-482"></a></span>
<span id="cb46-483"><a href="#cb46-483"></a><span class="fu">## Back to loops</span></span>
<span id="cb46-484"><a href="#cb46-484"></a></span>
<span id="cb46-485"><a href="#cb46-485"></a><span class="ss">- </span>By the way, I've switched from cool, good recursion back to unexciting, drab loops</span>
<span id="cb46-486"><a href="#cb46-486"></a><span class="ss">- </span>Infinite recursion blows up the call stack and instantly segmentation faults.</span>
<span id="cb46-487"><a href="#cb46-487"></a><span class="ss">    - </span>This is because someone other than me wrote <span class="in">`rustc`</span>.</span>
<span id="cb46-488"><a href="#cb46-488"></a><span class="ss">    - </span>I am not about to write <span class="in">`rustc`</span>!</span>
<span id="cb46-489"><a href="#cb46-489"></a>    </span>
<span id="cb46-490"><a href="#cb46-490"></a><span class="fu">## Current main</span></span>
<span id="cb46-491"><a href="#cb46-491"></a></span>
<span id="cb46-492"><a href="#cb46-492"></a><span class="in">```{.rs filename="src/main.rs"}</span></span>
<span id="cb46-493"><a href="#cb46-493"></a><span class="in">#![no_std]</span></span>
<span id="cb46-494"><a href="#cb46-494"></a><span class="in">#![no_main]</span></span>
<span id="cb46-495"><a href="#cb46-495"></a></span>
<span id="cb46-496"><a href="#cb46-496"></a><span class="in">#[unsafe(no_mangle)]</span></span>
<span id="cb46-497"><a href="#cb46-497"></a><span class="in">pub extern "C" fn _start() -&gt; ! {</span></span>
<span id="cb46-498"><a href="#cb46-498"></a><span class="in">    loop {}</span></span>
<span id="cb46-499"><a href="#cb46-499"></a><span class="in">}</span></span>
<span id="cb46-500"><a href="#cb46-500"></a></span>
<span id="cb46-501"><a href="#cb46-501"></a><span class="in">#[panic_handler]</span></span>
<span id="cb46-502"><a href="#cb46-502"></a><span class="in">fn panic(_info: &amp;core::panic::PanicInfo) -&gt; ! {</span></span>
<span id="cb46-503"><a href="#cb46-503"></a><span class="in">    loop {}</span></span>
<span id="cb46-504"><a href="#cb46-504"></a><span class="in">}</span></span>
<span id="cb46-505"><a href="#cb46-505"></a><span class="in">```</span></span>
<span id="cb46-506"><a href="#cb46-506"></a></span>
<span id="cb46-507"><a href="#cb46-507"></a><span class="fu">## A note</span></span>
<span id="cb46-508"><a href="#cb46-508"></a></span>
<span id="cb46-509"><a href="#cb46-509"></a><span class="ss">- </span>Remember the earlier mention of <span class="in">`core`</span></span>
<span id="cb46-510"><a href="#cb46-510"></a><span class="ss">    - </span>How we need <span class="in">`core`</span> to also panic abort?</span>
<span id="cb46-511"><a href="#cb46-511"></a><span class="ss">    - </span>We note when looking at <span class="in">`src/main.rs`</span> we do have a <span class="in">`core`</span> reference.</span>
<span id="cb46-512"><a href="#cb46-512"></a></span>
<span id="cb46-513"><a href="#cb46-513"></a><span class="fu">## Linux Everywhere</span></span>
<span id="cb46-514"><a href="#cb46-514"></a></span>
<span id="cb46-515"><a href="#cb46-515"></a><span class="ss">- </span>Okay so we aren't going to use Linux on our device.</span>
<span id="cb46-516"><a href="#cb46-516"></a><span class="ss">- </span>But we are going to use Linux *conventions*</span>
<span id="cb46-517"><a href="#cb46-517"></a><span class="ss">    - </span>Not Linux software, but Linux as a social technology.</span>
<span id="cb46-518"><a href="#cb46-518"></a><span class="ss">- </span>The <span class="in">`ld.lld`</span> "linker-flavor" instructs LLVM to compile with the <span class="in">`-flavor gnu`</span> flag.</span>
<span id="cb46-519"><a href="#cb46-519"></a><span class="ss">- </span>This means that we need an entry point named <span class="in">`_start`</span> - same as before!</span>
<span id="cb46-520"><a href="#cb46-520"></a></span>
<span id="cb46-521"><a href="#cb46-521"></a><span class="fu">## Build it</span></span>
<span id="cb46-522"><a href="#cb46-522"></a></span>
<span id="cb46-523"><a href="#cb46-523"></a><span class="ss">- </span>I bet it will work now.</span>
<span id="cb46-524"><a href="#cb46-524"></a><span class="ss">    - </span>Use our new target by passing the name of the JSON file as <span class="in">`--target`</span>:</span>
<span id="cb46-525"><a href="#cb46-525"></a></span>
<span id="cb46-526"><a href="#cb46-526"></a><span class="in">```{.sh}</span></span>
<span id="cb46-527"><a href="#cb46-527"></a><span class="in">$ cargo b --target x86_64-osirs.json</span></span>
<span id="cb46-528"><a href="#cb46-528"></a><span class="in">error: failed to run `rustc` to learn about target-specific information</span></span>
<span id="cb46-529"><a href="#cb46-529"></a></span>
<span id="cb46-530"><a href="#cb46-530"></a><span class="in">Caused by:</span></span>
<span id="cb46-531"><a href="#cb46-531"></a><span class="in">  process didn't exit successfully: `/home/user/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/bin/rustc - --crate-name ___ --print=file-names --target /home/user/tmp/32/x86_64-osirs.json --crate-type bin --crate-type rlib --crate-type dylib --crate-type cdylib --crate-type staticlib --crate-type proc-macro --print=sysroot --print=split-debuginfo --print=crate-name --print=cfg -Wwarnings` (exit status: 1)</span></span>
<span id="cb46-532"><a href="#cb46-532"></a><span class="in">  --- stderr</span></span>
<span id="cb46-533"><a href="#cb46-533"></a><span class="in">  error: Error loading target specification: Field target-pointer-width in target specification is required. Run `rustc --print target-list` for a list of built-in targets</span></span>
<span id="cb46-534"><a href="#cb46-534"></a><span class="in">```</span></span>
<span id="cb46-535"><a href="#cb46-535"></a></span>
<span id="cb46-536"><a href="#cb46-536"></a><span class="fu">## Aside</span></span>
<span id="cb46-537"><a href="#cb46-537"></a></span>
<span id="cb46-538"><a href="#cb46-538"></a><span class="ss">- </span>If you did not see that error, that is okay!</span>
<span id="cb46-539"><a href="#cb46-539"></a><span class="ss">- </span>It concerns an unstable language feature and may differ.</span>
<span id="cb46-540"><a href="#cb46-540"></a><span class="ss">- </span>Just skip two slides!</span>
<span id="cb46-541"><a href="#cb46-541"></a></span>
<span id="cb46-542"><a href="#cb46-542"></a><span class="fu">## Okay so</span></span>
<span id="cb46-543"><a href="#cb46-543"></a></span>
<span id="cb46-544"><a href="#cb46-544"></a><span class="ss">- </span>Huh?</span>
<span id="cb46-545"><a href="#cb46-545"></a></span>
<span id="cb46-546"><a href="#cb46-546"></a><span class="in">```{.sh}</span></span>
<span id="cb46-547"><a href="#cb46-547"></a><span class="in">Field target-pointer-width in target specification is required.</span></span>
<span id="cb46-548"><a href="#cb46-548"></a><span class="in">```</span></span>
<span id="cb46-549"><a href="#cb46-549"></a></span>
<span id="cb46-550"><a href="#cb46-550"></a><span class="ss">- </span>We very explicitly included that.</span>
<span id="cb46-551"><a href="#cb46-551"></a><span class="ss">- </span>In the most annoying thing in the universe, <span class="in">`rustc`</span> expect pointer width as a JSON string and not a JSON integer.</span>
<span id="cb46-552"><a href="#cb46-552"></a><span class="ss">    - </span><span class="co">[</span><span class="ot">Read more</span><span class="co">](https://github.com/rust-lang/rust/pull/144218)</span></span>
<span id="cb46-553"><a href="#cb46-553"></a><span class="ss">    - </span>It's fixed in Nightly, but I sleep at night, so I'm busy.</span>
<span id="cb46-554"><a href="#cb46-554"></a>        </span>
<span id="cb46-555"><a href="#cb46-555"></a><span class="fu">## Fix it?</span></span>
<span id="cb46-556"><a href="#cb46-556"></a></span>
<span id="cb46-557"><a href="#cb46-557"></a><span class="ss">- </span>I kid you not this is the solution.   </span>
<span id="cb46-558"><a href="#cb46-558"></a><span class="ss">    - </span>"Rust has a type system!"</span>
<span id="cb46-559"><a href="#cb46-559"></a><span class="ss">    - </span>Sure it does.</span>
<span id="cb46-560"><a href="#cb46-560"></a>    </span>
<span id="cb46-561"><a href="#cb46-561"></a><span class="in">```{.sh}</span></span>
<span id="cb46-562"><a href="#cb46-562"></a><span class="in">$ diff bad.wrong x86_64-osirs.json</span></span>
<span id="cb46-563"><a href="#cb46-563"></a><span class="in">6,7c6,7</span></span>
<span id="cb46-564"><a href="#cb46-564"></a><span class="in">&lt;     "target-pointer-width": 64,</span></span>
<span id="cb46-565"><a href="#cb46-565"></a><span class="in">&lt;     "target-c-int-width": 32,</span></span>
<span id="cb46-566"><a href="#cb46-566"></a><span class="in">---</span></span>
<span id="cb46-567"><a href="#cb46-567"></a><span class="in">&gt;     "target-pointer-width": "64",</span></span>
<span id="cb46-568"><a href="#cb46-568"></a><span class="in">&gt;     "target-c-int-width": "32",</span></span>
<span id="cb46-569"><a href="#cb46-569"></a><span class="in">```</span></span>
<span id="cb46-570"><a href="#cb46-570"></a></span>
<span id="cb46-571"><a href="#cb46-571"></a><span class="fu">## Now it works</span></span>
<span id="cb46-572"><a href="#cb46-572"></a></span>
<span id="cb46-573"><a href="#cb46-573"></a><span class="ss">- </span>This time it will work.</span>
<span id="cb46-574"><a href="#cb46-574"></a></span>
<span id="cb46-575"><a href="#cb46-575"></a><span class="in">```{.sh}</span></span>
<span id="cb46-576"><a href="#cb46-576"></a><span class="in">$ cargo b --target x86_64-osirs.json</span></span>
<span id="cb46-577"><a href="#cb46-577"></a><span class="in">   Compiling osirs v0.1.0 (/home/user/tmp/32)</span></span>
<span id="cb46-578"><a href="#cb46-578"></a><span class="in">error[E0463]: can't find crate for `core`</span></span>
<span id="cb46-579"><a href="#cb46-579"></a><span class="in">  |</span></span>
<span id="cb46-580"><a href="#cb46-580"></a><span class="in">  = note: the `x86_64-osirs` target may not be installed</span></span>
<span id="cb46-581"><a href="#cb46-581"></a><span class="in">  = help: consider downloading the target with `rustup target add x86_64-osirs`</span></span>
<span id="cb46-582"><a href="#cb46-582"></a></span>
<span id="cb46-583"><a href="#cb46-583"></a><span class="in">For more information about this error, try `rustc --explain E0463`.</span></span>
<span id="cb46-584"><a href="#cb46-584"></a><span class="in">error: could not compile `osirs` (bin "osirs") due to 1 previous error</span></span>
<span id="cb46-585"><a href="#cb46-585"></a><span class="in">```</span></span>
<span id="cb46-586"><a href="#cb46-586"></a></span>
<span id="cb46-587"><a href="#cb46-587"></a><span class="ss">- </span>Okay I was bamboozled.</span>
<span id="cb46-588"><a href="#cb46-588"></a></span>
<span id="cb46-589"><a href="#cb46-589"></a><span class="fu">## The Core</span></span>
<span id="cb46-590"><a href="#cb46-590"></a></span>
<span id="cb46-591"><a href="#cb46-591"></a>:::: {.columns}</span>
<span id="cb46-592"><a href="#cb46-592"></a></span>
<span id="cb46-593"><a href="#cb46-593"></a>::: {.column width="70%"}</span>
<span id="cb46-594"><a href="#cb46-594"></a></span>
<span id="cb46-595"><a href="#cb46-595"></a><span class="at">&gt; </span><span class="co">[</span><span class="ot">The Core is a 2003 American science fiction disaster film directed by Jon Amiel with screenplay written by Cooper Layne and John Rogers.</span><span class="co">](https://en.wikipedia.org/wiki/The_Core)</span></span>
<span id="cb46-596"><a href="#cb46-596"></a></span>
<span id="cb46-597"><a href="#cb46-597"></a><span class="ss">- </span>I haven't seen it but it apparently passes the <span class="co">[</span><span class="ot">Bechdel Test</span><span class="co">](https://en.wikipedia.org/wiki/Bechdel_test)</span></span>
<span id="cb46-598"><a href="#cb46-598"></a></span>
<span id="cb46-599"><a href="#cb46-599"></a>:::</span>
<span id="cb46-600"><a href="#cb46-600"></a></span>
<span id="cb46-601"><a href="#cb46-601"></a>::: {.column width="30%"}</span>
<span id="cb46-602"><a href="#cb46-602"></a></span>
<span id="cb46-603"><a href="#cb46-603"></a><span class="al">![](https://upload.wikimedia.org/wikipedia/en/f/f4/The_Core_poster.jpg)</span></span>
<span id="cb46-604"><a href="#cb46-604"></a></span>
<span id="cb46-605"><a href="#cb46-605"></a>:::</span>
<span id="cb46-606"><a href="#cb46-606"></a></span>
<span id="cb46-607"><a href="#cb46-607"></a>::::</span>
<span id="cb46-608"><a href="#cb46-608"></a></span>
<span id="cb46-609"><a href="#cb46-609"></a><span class="fu">## Wrong Core</span></span>
<span id="cb46-610"><a href="#cb46-610"></a></span>
<span id="cb46-611"><a href="#cb46-611"></a><span class="ss">- </span>We actually meant the Rust compiler <span class="in">`core`</span> library.</span>
<span id="cb46-612"><a href="#cb46-612"></a><span class="ss">    - </span><span class="co">[</span><span class="ot">Read more</span><span class="co">](https://doc.rust-lang.org/nightly/core/index.html)</span></span>
<span id="cb46-613"><a href="#cb46-613"></a><span class="ss">- </span>This library contains basic Rust types such as <span class="in">`Result`</span>, <span class="in">`Option`</span>, and iterators, and is implicitly linked to all <span class="in">`no_std`</span> crates.</span>
<span id="cb46-614"><a href="#cb46-614"></a></span>
<span id="cb46-615"><a href="#cb46-615"></a><span class="fu">## The Problem</span></span>
<span id="cb46-616"><a href="#cb46-616"></a></span>
<span id="cb46-617"><a href="#cb46-617"></a><span class="ss">- </span><span class="in">`core`</span> is usually *pre-compiled* (and then, of course, linked).</span>
<span id="cb46-618"><a href="#cb46-618"></a><span class="ss">- </span>But we made a new target which needs a new core.</span>
<span id="cb46-619"><a href="#cb46-619"></a><span class="ss">- </span>No problem, we'll just tell <span class="in">`rustc`</span> to do some compilation.</span>
<span id="cb46-620"><a href="#cb46-620"></a></span>
<span id="cb46-621"><a href="#cb46-621"></a><span class="fu">## Config</span></span>
<span id="cb46-622"><a href="#cb46-622"></a></span>
<span id="cb46-623"><a href="#cb46-623"></a><span class="ss">- </span>The most graceful to do this that *I* am aware of is with a <span class="in">`.cargo/config.toml`</span></span>
<span id="cb46-624"><a href="#cb46-624"></a><span class="ss">- </span>Basically, we can write down some things we *always* want <span class="in">`cargo`</span> to do, and store them in TOML file in the hidden <span class="in">`.cargo`</span> folder.</span>
<span id="cb46-625"><a href="#cb46-625"></a><span class="ss">- </span>I just made the folder then opened it up in my most beloved neon vimothy.</span>
<span id="cb46-626"><a href="#cb46-626"></a></span>
<span id="cb46-627"><a href="#cb46-627"></a><span class="in">```{.sh}</span></span>
<span id="cb46-628"><a href="#cb46-628"></a><span class="in">mdkir .cargo</span></span>
<span id="cb46-629"><a href="#cb46-629"></a><span class="in">nvim .cargo/config.toml</span></span>
<span id="cb46-630"><a href="#cb46-630"></a><span class="in">```</span></span>
<span id="cb46-631"><a href="#cb46-631"></a></span>
<span id="cb46-632"><a href="#cb46-632"></a><span class="fu">## Check in</span></span>
<span id="cb46-633"><a href="#cb46-633"></a></span>
<span id="cb46-634"><a href="#cb46-634"></a><span class="in">```{.sh}</span></span>
<span id="cb46-635"><a href="#cb46-635"></a><span class="in">mdkir .cargo</span></span>
<span id="cb46-636"><a href="#cb46-636"></a><span class="in">nvim .cargo/config.toml</span></span>
<span id="cb46-637"><a href="#cb46-637"></a><span class="in">```</span></span>
<span id="cb46-638"><a href="#cb46-638"></a></span>
<span id="cb46-639"><a href="#cb46-639"></a><span class="ss">- </span>Understanding check - what happens if you don't make <span class="in">`.cargo`</span> first?</span>
<span id="cb46-640"><a href="#cb46-640"></a></span>
<span id="cb46-641"><a href="#cb46-641"></a><span class="fu">## The `build-std` Option</span></span>
<span id="cb46-642"><a href="#cb46-642"></a></span>
<span id="cb46-643"><a href="#cb46-643"></a><span class="ss">- </span><span class="in">`build-std`</span> is a feature of Cargo.</span>
<span id="cb46-644"><a href="#cb46-644"></a><span class="ss">- </span>We can recompile <span class="in">`core`</span> and other standard library crates on demand.</span>
<span id="cb46-645"><a href="#cb46-645"></a><span class="ss">    - </span>Vs. using the precompiled versions shipped with the Rust installation. </span>
<span id="cb46-646"><a href="#cb46-646"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Read more.</span><span class="co">](https://doc.rust-lang.org/nightly/cargo/reference/unstable.html#build-std)</span></span>
<span id="cb46-647"><a href="#cb46-647"></a></span>
<span id="cb46-648"><a href="#cb46-648"></a><span class="fu">## My Config</span></span>
<span id="cb46-649"><a href="#cb46-649"></a></span>
<span id="cb46-650"><a href="#cb46-650"></a><span class="ss">- </span>We can use a pretty sparse config though we'll want to add more latter.</span>
<span id="cb46-651"><a href="#cb46-651"></a><span class="ss">- </span>I specify the "build-std" option in TOML.</span>
<span id="cb46-652"><a href="#cb46-652"></a><span class="ss">- </span>We want to <span class="in">`build-std`</span></span>
<span id="cb46-653"><a href="#cb46-653"></a><span class="ss">- </span>We want to build the <span class="in">`core`</span></span>
<span id="cb46-654"><a href="#cb46-654"></a></span>
<span id="cb46-655"><a href="#cb46-655"></a><span class="in">```{.toml filename=".cargo/config.toml"}</span></span>
<span id="cb46-656"><a href="#cb46-656"></a><span class="in">build-std = ["core"]</span></span>
<span id="cb46-657"><a href="#cb46-657"></a><span class="in">```</span></span>
<span id="cb46-658"><a href="#cb46-658"></a></span>
<span id="cb46-659"><a href="#cb46-659"></a><span class="ss">- </span>I bet this will work.</span>
<span id="cb46-660"><a href="#cb46-660"></a></span>
<span id="cb46-661"><a href="#cb46-661"></a><span class="fu">## Oh.</span></span>
<span id="cb46-662"><a href="#cb46-662"></a></span>
<span id="cb46-663"><a href="#cb46-663"></a><span class="ss">- </span>The exact same error as before?</span>
<span id="cb46-664"><a href="#cb46-664"></a></span>
<span id="cb46-665"><a href="#cb46-665"></a><span class="in">```{.sh}</span></span>
<span id="cb46-666"><a href="#cb46-666"></a><span class="in">$ cargo b --target x86_64-osirs.json</span></span>
<span id="cb46-667"><a href="#cb46-667"></a><span class="in">   Compiling osirs v0.1.0 (/home/user/tmp/32)</span></span>
<span id="cb46-668"><a href="#cb46-668"></a><span class="in">error[E0463]: can't find crate for `core`</span></span>
<span id="cb46-669"><a href="#cb46-669"></a><span class="in">  |</span></span>
<span id="cb46-670"><a href="#cb46-670"></a><span class="in">  = note: the `x86_64-osirs` target may not be installed</span></span>
<span id="cb46-671"><a href="#cb46-671"></a><span class="in">  = help: consider downloading the target with `rustup target add x86_64-osirs`</span></span>
<span id="cb46-672"><a href="#cb46-672"></a></span>
<span id="cb46-673"><a href="#cb46-673"></a><span class="in">For more information about this error, try `rustc --explain E0463`.</span></span>
<span id="cb46-674"><a href="#cb46-674"></a><span class="in">error: could not compile `osirs` (bin "osirs") due to 1 previous error</span></span>
<span id="cb46-675"><a href="#cb46-675"></a><span class="in">```</span></span>
<span id="cb46-676"><a href="#cb46-676"></a></span>
<span id="cb46-677"><a href="#cb46-677"></a><span class="fu">## Unstable</span></span>
<span id="cb46-678"><a href="#cb46-678"></a></span>
<span id="cb46-679"><a href="#cb46-679"></a><span class="ss">- </span>So apparently <span class="in">`build-std`</span> is not a stable feature of the Rust language.</span>
<span id="cb46-680"><a href="#cb46-680"></a><span class="ss">    - </span>This means the Rust designers can change or remove it at any time.</span>
<span id="cb46-681"><a href="#cb46-681"></a><span class="ss">- </span>To use unstable features, we have to tell <span class="in">`cargo`</span> they are unstable.</span>
<span id="cb46-682"><a href="#cb46-682"></a></span>
<span id="cb46-683"><a href="#cb46-683"></a><span class="fu">## Mental model</span></span>
<span id="cb46-684"><a href="#cb46-684"></a></span>
<span id="cb46-685"><a href="#cb46-685"></a><span class="ss">- </span>Think of it a bit like unsafe, but for the language instead of the executables.</span>
<span id="cb46-686"><a href="#cb46-686"></a><span class="ss">    - </span>When an executable is unsafe, it may crash or leak your private key.</span>
<span id="cb46-687"><a href="#cb46-687"></a><span class="ss">    - </span>When a language is unstable, it may not compile or may compile then leak your private key.</span>
<span id="cb46-688"><a href="#cb46-688"></a></span>
<span id="cb46-689"><a href="#cb46-689"></a><span class="fu">## Update config</span></span>
<span id="cb46-690"><a href="#cb46-690"></a></span>
<span id="cb46-691"><a href="#cb46-691"></a><span class="ss">- </span>We prepend an <span class="in">`[unstable]`</span> label to our <span class="in">`build-std`</span> configuration.</span>
<span id="cb46-692"><a href="#cb46-692"></a></span>
<span id="cb46-693"><a href="#cb46-693"></a><span class="in">```{.toml filename=".cargo/config.toml"}</span></span>
<span id="cb46-694"><a href="#cb46-694"></a><span class="in">[unstable]</span></span>
<span id="cb46-695"><a href="#cb46-695"></a><span class="in">build-std = ["core"]</span></span>
<span id="cb46-696"><a href="#cb46-696"></a><span class="in">```</span></span>
<span id="cb46-697"><a href="#cb46-697"></a></span>
<span id="cb46-698"><a href="#cb46-698"></a><span class="ss">- </span>I bet it will work now (it won't).</span>
<span id="cb46-699"><a href="#cb46-699"></a></span>
<span id="cb46-700"><a href="#cb46-700"></a><span class="fu">## Oh.</span></span>
<span id="cb46-701"><a href="#cb46-701"></a></span>
<span id="cb46-702"><a href="#cb46-702"></a><span class="ss">- </span>The exact same error as before?</span>
<span id="cb46-703"><a href="#cb46-703"></a></span>
<span id="cb46-704"><a href="#cb46-704"></a><span class="in">```{.sh}</span></span>
<span id="cb46-705"><a href="#cb46-705"></a><span class="in">$ cargo b --target x86_64-osirs.json</span></span>
<span id="cb46-706"><a href="#cb46-706"></a><span class="in">   Compiling osirs v0.1.0 (/home/user/tmp/32)</span></span>
<span id="cb46-707"><a href="#cb46-707"></a><span class="in">error[E0463]: can't find crate for `core`</span></span>
<span id="cb46-708"><a href="#cb46-708"></a><span class="in">  |</span></span>
<span id="cb46-709"><a href="#cb46-709"></a><span class="in">  = note: the `x86_64-osirs` target may not be installed</span></span>
<span id="cb46-710"><a href="#cb46-710"></a><span class="in">  = help: consider downloading the target with `rustup target add x86_64-osirs`</span></span>
<span id="cb46-711"><a href="#cb46-711"></a></span>
<span id="cb46-712"><a href="#cb46-712"></a><span class="in">For more information about this error, try `rustc --explain E0463`.</span></span>
<span id="cb46-713"><a href="#cb46-713"></a><span class="in">error: could not compile `osirs` (bin "osirs") due to 1 previous error</span></span>
<span id="cb46-714"><a href="#cb46-714"></a><span class="in">```</span></span>
<span id="cb46-715"><a href="#cb46-715"></a></span>
<span id="cb46-716"><a href="#cb46-716"></a><span class="fu">## Nightly</span></span>
<span id="cb46-717"><a href="#cb46-717"></a></span>
<span id="cb46-718"><a href="#cb46-718"></a><span class="ss">- </span>Okay folks here's the deal.</span>
<span id="cb46-719"><a href="#cb46-719"></a><span class="ss">- </span>I'm not happy about it either.</span>
<span id="cb46-720"><a href="#cb46-720"></a><span class="ss">- </span><span class="in">`build-std`</span> - which we need - is unstable and </span>
<span id="cb46-721"><a href="#cb46-721"></a><span class="ss">- </span><span class="in">`[unstable]`</span> is only available in nightly Rust.</span>
<span id="cb46-722"><a href="#cb46-722"></a><span class="ss">    - </span>The version of Rust for *nerds*.</span>
<span id="cb46-723"><a href="#cb46-723"></a><span class="ss">- </span>Not to worry, we are nerds and can use it.</span>
<span id="cb46-724"><a href="#cb46-724"></a><span class="ss">    - </span>Simply add a <span class="in">`+nightly`</span> right after cargo.</span>
<span id="cb46-725"><a href="#cb46-725"></a>    </span>
<span id="cb46-726"><a href="#cb46-726"></a><span class="fu">## Try Two Things</span></span>
<span id="cb46-727"><a href="#cb46-727"></a></span>
<span id="cb46-728"><a href="#cb46-728"></a><span class="ss">- </span>Here's two things that also still won't work.</span>
<span id="cb46-729"><a href="#cb46-729"></a><span class="in">```{.sh}</span></span>
<span id="cb46-730"><a href="#cb46-730"></a><span class="in">cargo +nightly b --target x86_64-osirs.json</span></span>
<span id="cb46-731"><a href="#cb46-731"></a><span class="in">```</span></span>
<span id="cb46-732"><a href="#cb46-732"></a><span class="ss">- </span>Gives this:</span>
<span id="cb46-733"><a href="#cb46-733"></a><span class="in">```{.sh}</span></span>
<span id="cb46-734"><a href="#cb46-734"></a><span class="in">error: `.json` target specs require -Zjson-target-spec</span></span>
<span id="cb46-735"><a href="#cb46-735"></a><span class="in">```</span></span>
<span id="cb46-736"><a href="#cb46-736"></a>    </span>
<span id="cb46-737"><a href="#cb46-737"></a><span class="fu">## Try Two Things</span></span>
<span id="cb46-738"><a href="#cb46-738"></a></span>
<span id="cb46-739"><a href="#cb46-739"></a><span class="ss">- </span>Here's two things that also still won't work.</span>
<span id="cb46-740"><a href="#cb46-740"></a><span class="in">```{.sh}</span></span>
<span id="cb46-741"><a href="#cb46-741"></a><span class="in">cargo +nightly b</span></span>
<span id="cb46-742"><a href="#cb46-742"></a><span class="in">```</span></span>
<span id="cb46-743"><a href="#cb46-743"></a><span class="ss">- </span>Gives this:</span>
<span id="cb46-744"><a href="#cb46-744"></a><span class="in">```{.sh}</span></span>
<span id="cb46-745"><a href="#cb46-745"></a><span class="in">error: `.json` target specs require -Zjson-target-spec</span></span>
<span id="cb46-746"><a href="#cb46-746"></a><span class="in">   Compiling compiler_builtins v0.1.160 (/home/user/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/compiler-builtins/compiler-builtins)</span></span>
<span id="cb46-747"><a href="#cb46-747"></a><span class="in">   Compiling core v0.0.0 (/home/user/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core)</span></span>
<span id="cb46-748"><a href="#cb46-748"></a><span class="in">   Compiling osirs v0.1.0 (/home/user/tmp/32)</span></span>
<span id="cb46-749"><a href="#cb46-749"></a><span class="in">error: linking with `cc` failed: exit status: 1</span></span>
<span id="cb46-750"><a href="#cb46-750"></a><span class="in">  |</span></span>
<span id="cb46-751"><a href="#cb46-751"></a><span class="in">  = note:  "cc" "-m64" "/home/user/tmp/32/target/debug/deps/rustcMmXrbF/symbols.o" "&lt;1 object files omitted&gt;" "-Wl,--as-needed" "-Wl,-Bstatic" "/home/user/tmp/32/target/debug/deps/{libcore-0c26ef2bd74962c1,libcompiler_builtins-40a77a01cbdbd500}.rlib" "-L" "/home/user/tmp/32/target/debug/deps/rustcMmXrbF/raw-dylibs" "-Wl,-Bdynamic" "-B&lt;sysroot&gt;/lib/rustlib/x86_64-unknown-linux-gnu/bin/gcc-ld" "-fuse-ld=lld" "-Wl,--eh-frame-hdr" "-Wl,-z,noexecstack" "-L" "&lt;sysroot&gt;/lib/rustlib/x86_64-unknown-linux-gnu/lib" "-o" "/home/user/tmp/32/target/debug/deps/osirs-62b17f4aa5d3b391" "-Wl,--gc-sections" "-pie" "-Wl,-z,relro,-z,now" "-nodefaultlibs"</span></span>
<span id="cb46-752"><a href="#cb46-752"></a><span class="in">  = note: some arguments are omitted. use `--verbose` to show all linker arguments</span></span>
<span id="cb46-753"><a href="#cb46-753"></a><span class="in">  = note: rust-lld: error: duplicate symbol: _start</span></span>
<span id="cb46-754"><a href="#cb46-754"></a><span class="in">          &gt;&gt;&gt; defined at /usr/lib/gcc/x86_64-linux-gnu/11/../../../x86_64-linux-gnu/Scrt1.o:(_start)</span></span>
<span id="cb46-755"><a href="#cb46-755"></a><span class="in">          &gt;&gt;&gt; defined at main.rs:6 (src/main.rs:6)</span></span>
<span id="cb46-756"><a href="#cb46-756"></a><span class="in">          &gt;&gt;&gt;            /home/user/tmp/32/target/debug/deps/osirs-62b17f4aa5d3b391.3hpwl9lytayxk9wu897na7tu0.0wpyfaj.rcgu.o:(.text._start+0x0)</span></span>
<span id="cb46-757"><a href="#cb46-757"></a><span class="in">          collect2: error: ld returned 1 exit status</span></span>
<span id="cb46-758"><a href="#cb46-758"></a></span>
<span id="cb46-759"><a href="#cb46-759"></a></span>
<span id="cb46-760"><a href="#cb46-760"></a><span class="in">error: could not compile `osirs` (bin "osirs") due to 1 previous error</span></span>
<span id="cb46-761"><a href="#cb46-761"></a><span class="in">```</span></span>
<span id="cb46-762"><a href="#cb46-762"></a></span>
<span id="cb46-763"><a href="#cb46-763"></a><span class="fu">## The Problem</span></span>
<span id="cb46-764"><a href="#cb46-764"></a></span>
<span id="cb46-765"><a href="#cb46-765"></a><span class="ss">- </span>Not everything works the same way with nightly and stable rust.</span>
<span id="cb46-766"><a href="#cb46-766"></a><span class="ss">    - </span>That's why it's not stable.</span>
<span id="cb46-767"><a href="#cb46-767"></a><span class="ss">- </span>We will encounter two examples immediately, both related to JSON.</span>
<span id="cb46-768"><a href="#cb46-768"></a><span class="ss">- </span>Let's look at this:</span>
<span id="cb46-769"><a href="#cb46-769"></a></span>
<span id="cb46-770"><a href="#cb46-770"></a><span class="in">```{.sh}</span></span>
<span id="cb46-771"><a href="#cb46-771"></a><span class="in">$ cargo +nightly b --target x86_64-osirs.json</span></span>
<span id="cb46-772"><a href="#cb46-772"></a><span class="in">error: `.json` target specs require -Zjson-target-spec</span></span>
<span id="cb46-773"><a href="#cb46-773"></a><span class="in">```</span></span>
<span id="cb46-774"><a href="#cb46-774"></a></span>
<span id="cb46-775"><a href="#cb46-775"></a><span class="fu">## One Solution</span></span>
<span id="cb46-776"><a href="#cb46-776"></a></span>
<span id="cb46-777"><a href="#cb46-777"></a><span class="ss">- </span>We can of course just put <span class="in">`-Zjson-target-spec`</span> in there.</span>
<span id="cb46-778"><a href="#cb46-778"></a><span class="ss">- </span>We get an error, but one we are clever enough to handle.</span>
<span id="cb46-779"><a href="#cb46-779"></a></span>
<span id="cb46-780"><a href="#cb46-780"></a><span class="in">```{.sh}</span></span>
<span id="cb46-781"><a href="#cb46-781"></a><span class="in">$ cargo +nightly b --target x86_64-osirs.json -Zjson-target-spec</span></span>
<span id="cb46-782"><a href="#cb46-782"></a><span class="in">```</span></span>
<span id="cb46-783"><a href="#cb46-783"></a><span class="ss">- </span>Gives this:</span>
<span id="cb46-784"><a href="#cb46-784"></a><span class="in">```{.sh}</span></span>
<span id="cb46-785"><a href="#cb46-785"></a><span class="in">error: failed to run `rustc` to learn about target-specific information</span></span>
<span id="cb46-786"><a href="#cb46-786"></a></span>
<span id="cb46-787"><a href="#cb46-787"></a><span class="in">Caused by:</span></span>
<span id="cb46-788"><a href="#cb46-788"></a><span class="in">  process didn't exit successfully: `/home/user/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/bin/rustc - --crate-name ___ --print=file-names --target /home/user/tmp/32/x86_64-osirs.json -Zunstable-options --crate-type bin --crate-type rlib --crate-type dylib --crate-type cdylib --crate-type staticlib --crate-type proc-macro --print=sysroot --print=split-debuginfo --print=crate-name --print=cfg -Wwarnings` (exit status: 1)</span></span>
<span id="cb46-789"><a href="#cb46-789"></a><span class="in">  --- stderr</span></span>
<span id="cb46-790"><a href="#cb46-790"></a><span class="in">  error: error loading target specification: target-pointer-width: invalid type: string "64", expected u16 at line 6 column 32</span></span>
<span id="cb46-791"><a href="#cb46-791"></a><span class="in">    |</span></span>
<span id="cb46-792"><a href="#cb46-792"></a><span class="in">    = help: run `rustc --print target-list` for a list of built-in targets</span></span>
<span id="cb46-793"><a href="#cb46-793"></a><span class="in">```</span></span>
<span id="cb46-794"><a href="#cb46-794"></a></span>
<span id="cb46-795"><a href="#cb46-795"></a><span class="fu">## Another Solution</span></span>
<span id="cb46-796"><a href="#cb46-796"></a></span>
<span id="cb46-797"><a href="#cb46-797"></a><span class="ss">- </span>However, that <span class="in">`-Zjson-target-spec`</span> looks an *awful* lot like a <span class="in">`.cargo/config.toml`</span> option...</span>
<span id="cb46-798"><a href="#cb46-798"></a><span class="ss">    - </span>I believe that is also unstable...</span>
<span id="cb46-799"><a href="#cb46-799"></a><span class="ss">    - </span>... after all, it works fine on stable!</span>
<span id="cb46-800"><a href="#cb46-800"></a></span>
<span id="cb46-801"><a href="#cb46-801"></a><span class="in">```{.toml filename=".cargo/config.toml"}</span></span>
<span id="cb46-802"><a href="#cb46-802"></a><span class="in">[unstable]</span></span>
<span id="cb46-803"><a href="#cb46-803"></a><span class="in">build-std = ["core"]</span></span>
<span id="cb46-804"><a href="#cb46-804"></a><span class="in">```</span></span>
<span id="cb46-805"><a href="#cb46-805"></a><span class="ss">- </span>We can then get the same error with less typing:</span>
<span id="cb46-806"><a href="#cb46-806"></a></span>
<span id="cb46-807"><a href="#cb46-807"></a><span class="in">```{.sh}</span></span>
<span id="cb46-808"><a href="#cb46-808"></a><span class="in">cargo +nightly b --target x86_64-osirs.json</span></span>
<span id="cb46-809"><a href="#cb46-809"></a><span class="in">```</span></span>
<span id="cb46-810"><a href="#cb46-810"></a></span>
<span id="cb46-811"><a href="#cb46-811"></a><span class="fu">## The error</span></span>
<span id="cb46-812"><a href="#cb46-812"></a></span>
<span id="cb46-813"><a href="#cb46-813"></a><span class="in">```{.sh code-line-numbers="6"}</span></span>
<span id="cb46-814"><a href="#cb46-814"></a><span class="in">error: failed to run `rustc` to learn about target-specific information</span></span>
<span id="cb46-815"><a href="#cb46-815"></a></span>
<span id="cb46-816"><a href="#cb46-816"></a><span class="in">Caused by:</span></span>
<span id="cb46-817"><a href="#cb46-817"></a><span class="in">  process didn't exit successfully: `/home/user/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/bin/rustc - --crate-name ___ --print=file-names --target /home/user/tmp/32/x86_64-osirs.json -Zunstable-options --crate-type bin --crate-type rlib --crate-type dylib --crate-type cdylib --crate-type staticlib --crate-type proc-macro --print=sysroot --print=split-debuginfo --print=crate-name --print=cfg -Wwarnings` (exit status: 1)</span></span>
<span id="cb46-818"><a href="#cb46-818"></a><span class="in">  --- stderr</span></span>
<span id="cb46-819"><a href="#cb46-819"></a><span class="in">  error: error loading target specification: target-pointer-width: invalid type: string "64", expected u16 at line 6 column 32</span></span>
<span id="cb46-820"><a href="#cb46-820"></a><span class="in">    |</span></span>
<span id="cb46-821"><a href="#cb46-821"></a><span class="in">    = help: run `rustc --print target-list` for a list of built-in targets</span></span>
<span id="cb46-822"><a href="#cb46-822"></a><span class="in">```</span></span>
<span id="cb46-823"><a href="#cb46-823"></a></span>
<span id="cb46-824"><a href="#cb46-824"></a><span class="ss">- </span>Does that remind you of anything?</span>
<span id="cb46-825"><a href="#cb46-825"></a></span>
<span id="cb46-826"><a href="#cb46-826"></a><span class="in">```{.sh}</span></span>
<span id="cb46-827"><a href="#cb46-827"></a><span class="in">$ diff bad.wrong x86_64-osirs.json</span></span>
<span id="cb46-828"><a href="#cb46-828"></a><span class="in">6,7c6,7</span></span>
<span id="cb46-829"><a href="#cb46-829"></a><span class="in">&lt;     "target-pointer-width": 64,</span></span>
<span id="cb46-830"><a href="#cb46-830"></a><span class="in">&lt;     "target-c-int-width": 32,</span></span>
<span id="cb46-831"><a href="#cb46-831"></a><span class="in">---</span></span>
<span id="cb46-832"><a href="#cb46-832"></a><span class="in">&gt;     "target-pointer-width": "64",</span></span>
<span id="cb46-833"><a href="#cb46-833"></a><span class="in">&gt;     "target-c-int-width": "32",</span></span>
<span id="cb46-834"><a href="#cb46-834"></a><span class="in">```</span></span>
<span id="cb46-835"><a href="#cb46-835"></a></span>
<span id="cb46-836"><a href="#cb46-836"></a></span>
<span id="cb46-837"><a href="#cb46-837"></a><span class="fu">## Aside</span></span>
<span id="cb46-838"><a href="#cb46-838"></a></span>
<span id="cb46-839"><a href="#cb46-839"></a><span class="ss">- </span>If you did not see that error, that is okay!</span>
<span id="cb46-840"><a href="#cb46-840"></a><span class="ss">- </span>It concerns an unstable language feature and may differ.</span>
<span id="cb46-841"><a href="#cb46-841"></a><span class="ss">- </span>Just skip one slide!</span>
<span id="cb46-842"><a href="#cb46-842"></a></span>
<span id="cb46-843"><a href="#cb46-843"></a><span class="fu">## Revert!</span></span>
<span id="cb46-844"><a href="#cb46-844"></a></span>
<span id="cb46-845"><a href="#cb46-845"></a><span class="ss">- </span>Change the string integers back to integer integers in your JSON file and you will be living a charmed and blessed life.</span>
<span id="cb46-846"><a href="#cb46-846"></a><span class="ss">    - </span>A long one, compilation is 10+ seconds for me.</span>
<span id="cb46-847"><a href="#cb46-847"></a></span>
<span id="cb46-848"><a href="#cb46-848"></a><span class="in">```{.sh}</span></span>
<span id="cb46-849"><a href="#cb46-849"></a><span class="in">$ cargo +nightly b --target x86_64-osirs.json</span></span>
<span id="cb46-850"><a href="#cb46-850"></a><span class="in">   Compiling compiler_builtins v0.1.160 (/home/user/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/compiler-builtins/compiler-builtins)</span></span>
<span id="cb46-851"><a href="#cb46-851"></a><span class="in">   Compiling core v0.0.0 (/home/user/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core)</span></span>
<span id="cb46-852"><a href="#cb46-852"></a><span class="in">^[[A    Building [==========&gt;                  ] 2/5: core, compiler_builtins                                                                Compiling osirs v0.1.0 (/home/user/tmp/32)</span></span>
<span id="cb46-853"><a href="#cb46-853"></a><span class="in">    Finished `dev` profile [unoptimized + debuginfo] target(s) in 10.18s</span></span>
<span id="cb46-854"><a href="#cb46-854"></a><span class="in">```</span></span>
<span id="cb46-855"><a href="#cb46-855"></a></span>
<span id="cb46-856"><a href="#cb46-856"></a><span class="fu">## Aside</span></span>
<span id="cb46-857"><a href="#cb46-857"></a></span>
<span id="cb46-858"><a href="#cb46-858"></a><span class="ss">- </span>By the way, are you tired of specifying the target every time?</span>
<span id="cb46-859"><a href="#cb46-859"></a><span class="ss">    - </span>Sounds like a problem for <span class="in">`.cargo/config.toml`</span>!</span>
<span id="cb46-860"><a href="#cb46-860"></a></span>
<span id="cb46-861"><a href="#cb46-861"></a><span class="in">```{.toml filename=".cargo/config.toml" code-line-numbers="5-6"}</span></span>
<span id="cb46-862"><a href="#cb46-862"></a><span class="in">[unstable]</span></span>
<span id="cb46-863"><a href="#cb46-863"></a><span class="in">build-std = ["core"]</span></span>
<span id="cb46-864"><a href="#cb46-864"></a><span class="in">json-target-spec = true</span></span>
<span id="cb46-865"><a href="#cb46-865"></a></span>
<span id="cb46-866"><a href="#cb46-866"></a><span class="in">[build]</span></span>
<span id="cb46-867"><a href="#cb46-867"></a><span class="in">target = "x86_64-osirs.json"</span></span>
<span id="cb46-868"><a href="#cb46-868"></a><span class="in">```</span></span>
<span id="cb46-869"><a href="#cb46-869"></a></span>
<span id="cb46-870"><a href="#cb46-870"></a><span class="fu">## Run again</span></span>
<span id="cb46-871"><a href="#cb46-871"></a></span>
<span id="cb46-872"><a href="#cb46-872"></a><span class="ss">- </span>By the way it will be fast now.</span>
<span id="cb46-873"><a href="#cb46-873"></a></span>
<span id="cb46-874"><a href="#cb46-874"></a><span class="in">```{.sh}</span></span>
<span id="cb46-875"><a href="#cb46-875"></a><span class="in">$ cargo +nightly b</span></span>
<span id="cb46-876"><a href="#cb46-876"></a><span class="in">    Finished `dev` profile [unoptimized + debuginfo] target(s) in 0.08s</span></span>
<span id="cb46-877"><a href="#cb46-877"></a><span class="in">```</span></span>
<span id="cb46-878"><a href="#cb46-878"></a></span>
<span id="cb46-879"><a href="#cb46-879"></a><span class="fu">## Aside: Nightly</span></span>
<span id="cb46-880"><a href="#cb46-880"></a></span>
<span id="cb46-881"><a href="#cb46-881"></a><span class="ss">- </span>Surely you can also update <span class="in">`.cargo/config.toml`</span> to use nightly!</span>
<span id="cb46-882"><a href="#cb46-882"></a><span class="ss">    - </span>You can't. You can solve the problem other ways though.</span>
<span id="cb46-883"><a href="#cb46-883"></a><span class="ss">    - </span>Left as an exercise to the interested student.</span>
<span id="cb46-884"><a href="#cb46-884"></a>    </span>
<span id="cb46-885"><a href="#cb46-885"></a><span class="fu">## Aside: $\not$Futureproofing</span></span>
<span id="cb46-886"><a href="#cb46-886"></a></span>
<span id="cb46-887"><a href="#cb46-887"></a><span class="ss">- </span>I was pretty sure I can make a kernel without floats.</span>
<span id="cb46-888"><a href="#cb46-888"></a><span class="ss">- </span>So I removed the two <span class="in">`soft-float`</span> lines and it still worked for now.</span>
<span id="cb46-889"><a href="#cb46-889"></a></span>
<span id="cb46-890"><a href="#cb46-890"></a><span class="in">```{.sh}</span></span>
<span id="cb46-891"><a href="#cb46-891"></a><span class="in">$ diff old.boring x86_64-osirs.json</span></span>
<span id="cb46-892"><a href="#cb46-892"></a><span class="in">13,15c13</span></span>
<span id="cb46-893"><a href="#cb46-893"></a><span class="in">&lt;     "disable-redzone": true,</span></span>
<span id="cb46-894"><a href="#cb46-894"></a><span class="in">&lt;     "features": "-mmx,-sse,+soft-float",</span></span>
<span id="cb46-895"><a href="#cb46-895"></a><span class="in">&lt;     "rustc-abi": "x86-softfloat"</span></span>
<span id="cb46-896"><a href="#cb46-896"></a><span class="in">---</span></span>
<span id="cb46-897"><a href="#cb46-897"></a><span class="in">&gt;     "disable-redzone": true</span></span>
<span id="cb46-898"><a href="#cb46-898"></a><span class="in">```</span></span>
<span id="cb46-899"><a href="#cb46-899"></a></span>
<span id="cb46-900"><a href="#cb46-900"></a><span class="fu">## Aside: $\not$Futureproofing</span></span>
<span id="cb46-901"><a href="#cb46-901"></a></span>
<span id="cb46-902"><a href="#cb46-902"></a><span class="ss">- </span>I was pretty sure I could make a kernel without <span class="in">`compiler-builtins`</span></span>
<span id="cb46-903"><a href="#cb46-903"></a><span class="ss">- </span>These are memory related functions where Rust often uses linked C implementations.</span>
<span id="cb46-904"><a href="#cb46-904"></a><span class="ss">- </span>I'm leaving them out for now and will add them in when I need them.</span>
<span id="cb46-905"><a href="#cb46-905"></a></span>
<span id="cb46-906"><a href="#cb46-906"></a><span class="in">```{.toml filename=".cargo/config.toml"}</span></span>
<span id="cb46-907"><a href="#cb46-907"></a><span class="in">[unstable]</span></span>
<span id="cb46-908"><a href="#cb46-908"></a><span class="in">build-std-features = ["compiler-builtins-mem"]</span></span>
<span id="cb46-909"><a href="#cb46-909"></a><span class="in">build-std = ["core", "compiler_builtins"]</span></span>
<span id="cb46-910"><a href="#cb46-910"></a><span class="in">```</span></span>
<span id="cb46-911"><a href="#cb46-911"></a></span>
<span id="cb46-912"><a href="#cb46-912"></a><span class="fu">## Boot it</span></span>
<span id="cb46-913"><a href="#cb46-913"></a></span>
<span id="cb46-914"><a href="#cb46-914"></a><span class="ss">- </span>And with that, I bet this will totally work.</span>
<span id="cb46-915"><a href="#cb46-915"></a><span class="ss">- </span>Let's break out <span class="in">`qemu`</span></span>
<span id="cb46-916"><a href="#cb46-916"></a><span class="in">```{.sh}</span></span>
<span id="cb46-917"><a href="#cb46-917"></a><span class="in">$ qemu-system-x86_64 -kernel target/x86_64-osirs/debug/osirs</span></span>
<span id="cb46-918"><a href="#cb46-918"></a><span class="in">Command 'qemu-system-x86_64' not found, but can be installed with:</span></span>
<span id="cb46-919"><a href="#cb46-919"></a><span class="in">sudo apt install qemu-system-x86      # version 1:6.2+dfsg-2ubuntu6.27, or</span></span>
<span id="cb46-920"><a href="#cb46-920"></a><span class="in">sudo apt install qemu-system-x86-xen  # version 1:6.2+dfsg-2ubuntu6.27</span></span>
<span id="cb46-921"><a href="#cb46-921"></a><span class="in">```</span></span>
<span id="cb46-922"><a href="#cb46-922"></a><span class="ss">- </span>Oh right, we only installed "misc" <span class="in">`qemu`</span></span>
<span id="cb46-923"><a href="#cb46-923"></a><span class="ss">    - </span>Real ones will use <span class="in">`apt`</span></span>
<span id="cb46-924"><a href="#cb46-924"></a><span class="in">```{.sh}</span></span>
<span id="cb46-925"><a href="#cb46-925"></a><span class="in">sudo apt install qemu-system-x86</span></span>
<span id="cb46-926"><a href="#cb46-926"></a><span class="in">```</span></span>
<span id="cb46-927"><a href="#cb46-927"></a></span>
<span id="cb46-928"><a href="#cb46-928"></a><span class="fu">## Boot it</span></span>
<span id="cb46-929"><a href="#cb46-929"></a></span>
<span id="cb46-930"><a href="#cb46-930"></a><span class="in">```{.sh}</span></span>
<span id="cb46-931"><a href="#cb46-931"></a><span class="in">$ qemu-system-x86_64 -kernel target/x86_64-osirs/debug/osirs</span></span>
<span id="cb46-932"><a href="#cb46-932"></a><span class="in">qemu-system-x86_64: Error loading uncompressed kernel without PVH ELF Note</span></span>
<span id="cb46-933"><a href="#cb46-933"></a><span class="in">```</span></span>
<span id="cb46-934"><a href="#cb46-934"></a></span>
<span id="cb46-935"><a href="#cb46-935"></a><span class="ss">- </span>Oh right, we did precisely *nothing* with the BIOS and the bootloader and all that and still need to do those things.</span>
<span id="cb46-936"><a href="#cb46-936"></a><span class="ss">    - </span>I bet that would be a fun topic for a lab.</span>
<span id="cb46-937"><a href="#cb46-937"></a>    </span>
<span id="cb46-938"><a href="#cb46-938"></a><span class="fu"># Fin</span></span>
<span id="cb46-939"><a href="#cb46-939"></a></span>
<span id="cb46-940"><a href="#cb46-940"></a><span class="fu">## Main File</span></span>
<span id="cb46-941"><a href="#cb46-941"></a></span>
<span id="cb46-942"><a href="#cb46-942"></a><span class="ss">- </span>Unaltered except loops for stability.</span>
<span id="cb46-943"><a href="#cb46-943"></a></span>
<span id="cb46-944"><a href="#cb46-944"></a><span class="in">```{.rs filename="src/main.rs"}</span></span>
<span id="cb46-945"><a href="#cb46-945"></a><span class="in">#![no_std]</span></span>
<span id="cb46-946"><a href="#cb46-946"></a><span class="in">#![no_main]</span></span>
<span id="cb46-947"><a href="#cb46-947"></a></span>
<span id="cb46-948"><a href="#cb46-948"></a><span class="in">#[unsafe(no_mangle)]</span></span>
<span id="cb46-949"><a href="#cb46-949"></a><span class="in">pub extern "C" fn _start() -&gt; ! {</span></span>
<span id="cb46-950"><a href="#cb46-950"></a><span class="in">    loop {}</span></span>
<span id="cb46-951"><a href="#cb46-951"></a><span class="in">}</span></span>
<span id="cb46-952"><a href="#cb46-952"></a></span>
<span id="cb46-953"><a href="#cb46-953"></a><span class="in">#[panic_handler]</span></span>
<span id="cb46-954"><a href="#cb46-954"></a><span class="in">fn panic(_info: &amp;core::panic::PanicInfo) -&gt; ! {</span></span>
<span id="cb46-955"><a href="#cb46-955"></a><span class="in">    loop {}</span></span>
<span id="cb46-956"><a href="#cb46-956"></a><span class="in">}</span></span>
<span id="cb46-957"><a href="#cb46-957"></a><span class="in">```</span></span>
<span id="cb46-958"><a href="#cb46-958"></a></span>
<span id="cb46-959"><a href="#cb46-959"></a><span class="fu">## Config File</span></span>
<span id="cb46-960"><a href="#cb46-960"></a></span>
<span id="cb46-961"><a href="#cb46-961"></a><span class="ss">- </span>All new, only works with nightly.</span>
<span id="cb46-962"><a href="#cb46-962"></a></span>
<span id="cb46-963"><a href="#cb46-963"></a><span class="in">```{.toml filename=".cargo/config.toml"}</span></span>
<span id="cb46-964"><a href="#cb46-964"></a><span class="in">[unstable]</span></span>
<span id="cb46-965"><a href="#cb46-965"></a><span class="in">build-std = ["core"]</span></span>
<span id="cb46-966"><a href="#cb46-966"></a><span class="in">json-target-spec = true</span></span>
<span id="cb46-967"><a href="#cb46-967"></a></span>
<span id="cb46-968"><a href="#cb46-968"></a><span class="in">[build]</span></span>
<span id="cb46-969"><a href="#cb46-969"></a><span class="in">target = "x86_64-osirs.json"</span></span>
<span id="cb46-970"><a href="#cb46-970"></a><span class="in">```</span></span>
<span id="cb46-971"><a href="#cb46-971"></a></span>
<span id="cb46-972"><a href="#cb46-972"></a><span class="fu">## Target File</span></span>
<span id="cb46-973"><a href="#cb46-973"></a></span>
<span id="cb46-974"><a href="#cb46-974"></a><span class="ss">- </span>All new, this is the nightly version.</span>
<span id="cb46-975"><a href="#cb46-975"></a></span>
<span id="cb46-976"><a href="#cb46-976"></a><span class="in">```{.json filename="x86_64-osirs.json"}</span></span>
<span id="cb46-977"><a href="#cb46-977"></a><span class="in">{</span></span>
<span id="cb46-978"><a href="#cb46-978"></a><span class="in">    "llvm-target": "x86_64-unknown-none",</span></span>
<span id="cb46-979"><a href="#cb46-979"></a><span class="in">    "data-layout": "e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-i128:128-f80:128-n8:16:32:64-S128",</span></span>
<span id="cb46-980"><a href="#cb46-980"></a><span class="in">    "arch": "x86_64",</span></span>
<span id="cb46-981"><a href="#cb46-981"></a><span class="in">    "target-endian": "little",</span></span>
<span id="cb46-982"><a href="#cb46-982"></a><span class="in">    "target-pointer-width": 64,</span></span>
<span id="cb46-983"><a href="#cb46-983"></a><span class="in">    "target-c-int-width": 32,</span></span>
<span id="cb46-984"><a href="#cb46-984"></a><span class="in">    "os": "none",</span></span>
<span id="cb46-985"><a href="#cb46-985"></a><span class="in">    "executables": true,</span></span>
<span id="cb46-986"><a href="#cb46-986"></a><span class="in">    "linker-flavor": "ld.lld",</span></span>
<span id="cb46-987"><a href="#cb46-987"></a><span class="in">    "linker": "rust-lld",</span></span>
<span id="cb46-988"><a href="#cb46-988"></a><span class="in">    "panic-strategy": "abort",</span></span>
<span id="cb46-989"><a href="#cb46-989"></a><span class="in">    "disable-redzone": true</span></span>
<span id="cb46-990"><a href="#cb46-990"></a><span class="in">}</span></span>
<span id="cb46-991"><a href="#cb46-991"></a><span class="in">```</span></span>
<span id="cb46-992"><a href="#cb46-992"></a></span>
<span id="cb46-993"><a href="#cb46-993"></a><span class="fu">## Cargo File</span></span>
<span id="cb46-994"><a href="#cb46-994"></a></span>
<span id="cb46-995"><a href="#cb46-995"></a><span class="ss">- </span>Move panic specification to target.</span>
<span id="cb46-996"><a href="#cb46-996"></a></span>
<span id="cb46-997"><a href="#cb46-997"></a><span class="in">```{.toml filename="Cargo.toml"}</span></span>
<span id="cb46-998"><a href="#cb46-998"></a><span class="in">[package]</span></span>
<span id="cb46-999"><a href="#cb46-999"></a><span class="in">name = "osirs"</span></span>
<span id="cb46-1000"><a href="#cb46-1000"></a><span class="in">version = "0.1.0"</span></span>
<span id="cb46-1001"><a href="#cb46-1001"></a><span class="in">edition = "2024"</span></span>
<span id="cb46-1002"><a href="#cb46-1002"></a></span>
<span id="cb46-1003"><a href="#cb46-1003"></a><span class="in">[dependencies]</span></span>
<span id="cb46-1004"><a href="#cb46-1004"></a><span class="in">```</span></span>
<span id="cb46-1005"><a href="#cb46-1005"></a></span></code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>