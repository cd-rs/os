<!DOCTYPE html>
<html lang="en"><head>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-html/tabby.min.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/light-border.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-707d8167ce6003fca903bfe2be84ab7f.css" rel="stylesheet" id="quarto-text-highlighting-styles"><meta charset="utf-8">
  <meta name="generator" content="quarto-1.8.25">

  <title>OS in Rust – Kernel</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="site_libs/revealjs/dist/reset.css">
  <link rel="stylesheet" href="site_libs/revealjs/dist/reveal.css">
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    html { -webkit-text-size-adjust: 100%; }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
      }
    pre.numberSource { margin-left: 3em;  padding-left: 4px; }
    div.sourceCode
      { color: #f8f8f2;  }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span { color: #f8f8f2; } /* Normal */
    code span.al { color: #f07178; } /* Alert */
    code span.an { color: #d4d0ab; } /* Annotation */
    code span.at { color: #00e0e0; } /* Attribute */
    code span.bn { color: #d4d0ab; } /* BaseN */
    code span.bu { color: #abe338; } /* BuiltIn */
    code span.cf { color: #ffa07a; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #abe338; } /* Char */
    code span.cn { color: #ffd700; } /* Constant */
    code span.co { color: #f8f8f2; font-style: italic; } /* Comment */
    code span.cv { color: #ffd700; } /* CommentVar */
    code span.do { color: #f8f8f2; } /* Documentation */
    code span.dt { color: #ffa07a; } /* DataType */
    code span.dv { color: #d4d0ab; } /* DecVal */
    code span.er { color: #f07178; text-decoration: underline; } /* Error */
    code span.ex { color: #00e0e0; font-weight: bold; } /* Extension */
    code span.fl { color: #d4d0ab; } /* Float */
    code span.fu { color: #ffa07a; } /* Function */
    code span.im { color: #abe338; } /* Import */
    code span.in { color: #d4d0ab; } /* Information */
    code span.kw { color: #ffa07a; font-weight: bold; } /* Keyword */
    code span.op { color: #ffa07a; } /* Operator */
    code span.ot { color: #00e0e0; } /* Other */
    code span.pp { color: #dcc6e0; } /* Preprocessor */
    code span.re { color: #00e0e0; background-color: #f8f8f2; } /* RegionMarker */
    code span.sc { color: #abe338; } /* SpecialChar */
    code span.ss { color: #abe338; } /* SpecialString */
    code span.st { color: #abe338; } /* String */
    code span.va { color: #00e0e0; } /* Variable */
    code span.vs { color: #abe338; } /* VerbatimString */
    code span.wa { color: #dcc6e0; } /* Warning */
  </style>
  <link rel="stylesheet" href="site_libs/revealjs/dist/theme/quarto-1d86d68c35eb7061f9efcb6a994936f6.css">
  <link href="site_libs/revealjs/plugin/quarto-line-highlight/line-highlight.css" rel="stylesheet">
  <link href="site_libs/revealjs/plugin/reveal-menu/menu.css" rel="stylesheet">
  <link href="site_libs/revealjs/plugin/reveal-menu/quarto-menu.css" rel="stylesheet">
  <link href="site_libs/revealjs/plugin/quarto-support/footer.css" rel="stylesheet">
  <style type="text/css">
    .reveal div.sourceCode {
      margin: 0;
      overflow: auto;
    }
    .reveal div.hanging-indent {
      margin-left: 1em;
      text-indent: -1em;
    }
    .reveal .slide:not(.center) {
      height: 100%;
    }
    .reveal .slide.scrollable {
      overflow-y: auto;
    }
    .reveal .footnotes {
      height: 100%;
      overflow-y: auto;
    }
    .reveal .slide .absolute {
      position: absolute;
      display: block;
    }
    .reveal .footnotes ol {
      counter-reset: ol;
      list-style-type: none; 
      margin-left: 0;
    }
    .reveal .footnotes ol li:before {
      counter-increment: ol;
      content: counter(ol) ". "; 
    }
    .reveal .footnotes ol li > p:first-child {
      display: inline-block;
    }
    .reveal .slide ul,
    .reveal .slide ol {
      margin-bottom: 0.5em;
    }
    .reveal .slide ul li,
    .reveal .slide ol li {
      margin-top: 0.4em;
      margin-bottom: 0.2em;
    }
    .reveal .slide ul[role="tablist"] li {
      margin-bottom: 0;
    }
    .reveal .slide ul li > *:first-child,
    .reveal .slide ol li > *:first-child {
      margin-block-start: 0;
    }
    .reveal .slide ul li > *:last-child,
    .reveal .slide ol li > *:last-child {
      margin-block-end: 0;
    }
    .reveal .slide .columns:nth-child(3) {
      margin-block-start: 0.8em;
    }
    .reveal blockquote {
      box-shadow: none;
    }
    .reveal .tippy-content>* {
      margin-top: 0.2em;
      margin-bottom: 0.7em;
    }
    .reveal .tippy-content>*:last-child {
      margin-bottom: 0.2em;
    }
    .reveal .slide > img.stretch.quarto-figure-center,
    .reveal .slide > img.r-stretch.quarto-figure-center {
      display: block;
      margin-left: auto;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-left,
    .reveal .slide > img.r-stretch.quarto-figure-left  {
      display: block;
      margin-left: 0;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-right,
    .reveal .slide > img.r-stretch.quarto-figure-right  {
      display: block;
      margin-left: auto;
      margin-right: 0; 
    }
  </style>
</head>
<body class="quarto-dark">
  <div class="reveal">
    <div class="slides">

<section id="title-slide" class="quarto-title-block center">
  <h1 class="title">Kernel</h1>
  <p class="subtitle">OS in Rust</p>

<div class="quarto-title-authors">
</div>

</section>
<section id="announcements" class="slide level2">
<h2>Announcements</h2>
<ul>
<li><strong>Action Items</strong>:
<ul>
<li>Is <code>qemu</code> working at all.
<ul>
<li>The coolest assignment ever for a second week in a row.</li>
<li>I’m glad you all love it</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="today" class="slide level2">
<h2>Today</h2>
<ul>
<li>Background</li>
<li>Kernel</li>
</ul>
</section>
<section id="citations" class="slide level2">
<h2>Citations</h2>
<ul>
<li>Outright theft:
<ul>
<li><a href="https://os.phil-opp.com/minimal-rust-kernel/">A Minimal Rust Kernel</a></li>
</ul></li>
</ul>
</section>
<section>
<section id="background" class="title-slide slide level1 center">
<h1>Background</h1>

</section>
<section id="the-boot-process" class="slide level2">
<h2>The Boot Process</h2>
<ul>
<li>POV: You are an inanimate piece of silicon.
<ul>
<li>You contain wires connected to logic gates.</li>
<li>Somewhere, a switch is flipped.</li>
<li>Electrons flow into some of your wires, through some gates.</li>
</ul></li>
</ul>
</section>
<section id="first-steps" class="slide level2">
<h2>First Steps</h2>
<ul>
<li>What determines the initial arrangement of gates?</li>
<li>Where do electrons flow?</li>
<li>This is determined by the <em>boot process</em>
<ul>
<li>Occurs on <em>every</em> power-up</li>
<li>Determined by <em>hardware</em> design</li>
<li>More fundamental than the OS</li>
</ul></li>
</ul>
</section>
<section id="firmware" class="slide level2">
<h2>Firmware</h2>
<ul>
<li>What is between hardware and software?
<ul>
<li>Firmware.</li>
</ul></li>
<li>On power-up, devices execute code embedded in physical read only memory (ROM).
<ul>
<li>Read more: <a href="https://en.wikipedia.org/wiki/Read-only_memory">ROM</a></li>
</ul></li>
<li>Is it software? Is it hardware? Who can say.</li>
</ul>
</section>
<section id="enter-the-cpu" class="slide level2">
<h2>Enter the CPU</h2>
<ul>
<li>Usually, power-up occurs on a “motherboard” hosting, among other things, the bus.
<ul>
<li>Named “mother” after the “MU/TH/UR” on ship computer in <em>Alien</em> (1979)</li>
<li>This is a lie.</li>
</ul></li>
</ul>
</section>
<section id="not-code-but-ware" class="slide level2">
<h2>Not “code” but “ware”</h2>
<ul>
<li>So firmware isn’t really like CPU code (like Rust or C), but it does:
<ul>
<li>Tell circuitry where to direct electrons within the CPU.</li>
<li>Also wake up e.g.&nbsp;the MMU.</li>
</ul></li>
</ul>
</section>
<section id="enter-the-os" class="slide level2">
<h2>Enter the OS</h2>
<ul>
<li>With the CPU primed but not yet ticking through clock cycles, all that remains is to either
<ul>
<li>Execute a bare metal executable, or</li>
<li>Boot an operating system to enable the next higher-level task.</li>
</ul></li>
</ul>
</section>
<section id="what-it-sounds-like" class="slide level2">
<h2>What it sounds like</h2>
<ul>
<li>We regard, then, the operating system as a <em>system</em> which <em>operates</em> the <em>hardware</em> on behalf of higher level <em>software</em>.
<ul>
<li>Hence, “systems computing”.</li>
<li>Hopefully the contrast to software is a bit more clear here.</li>
</ul></li>
</ul>
</section>
<section id="aside" class="slide level2">
<h2>Aside</h2>
<ul>
<li>I am supposed to teach you about the “power-on self-test”.</li>
<li>A bit electrical engineering for me.</li>
</ul>
<blockquote>
<p><a href="https://en.wikipedia.org/wiki/Power-on_self-test">A <strong>power-on self-test</strong> (POST) is a process performed by firmware or software routines immediately after a computer or other digital electronic device is powered on.</a></p>
</blockquote>
<ul>
<li>Neat! Moving on.</li>
</ul>
</section>
<section id="competing-standards" class="slide level2">
<h2>Competing Standards</h2>
<ul>
<li>Lucky us, there is no widely agreed upon way to do firmware.</li>
<li>There’s the cool, old way that doesn’t work well but is easy.
<ul>
<li>“Basic Input/Output System“ <a href="https://en.wikipedia.org/wiki/BIOS"><strong>BIOS</strong></a></li>
<li>1981</li>
</ul></li>
</ul>
</section>
<section id="competing-standards-1" class="slide level2">
<h2>Competing Standards</h2>
<ul>
<li>There’s the new way that is too hard to use for normal people like us.
<ul>
<li>As in people who do anything else ever.</li>
<li>It’s good though we promise.</li>
<li>“Unified Extensible Firmware Interface” <a href="https://en.wikipedia.org/wiki/Unified_Extensible_Firmware_Interface"><strong>UEFI</strong></a>.</li>
<li>May make you use it for a lab. <a href="https://github.com/le-jzr/sisyphos-kernel-uefi-x86_64">More.</a></li>
<li>2006</li>
</ul></li>
</ul>
</section>
<section id="bios-boot" class="slide level2">
<h2>BIOS Boot</h2>
<ul>
<li>I actually started fooling around with the BIOS before UEFI even existed.
<ul>
<li>I was a normal kid though 100%.</li>
</ul></li>
<li>Fortunately it’s still basically around. Quoth Blog:</li>
</ul>
<blockquote>
<p>This is great, because you can use the same boot logic across all machines from the last century.</p>
</blockquote>
</section>
<section id="upsides" class="slide level2">
<h2>Upsides</h2>
<ul>
<li>Blog says it’s a downside that this means you have to do 16-bit mode.
<ul>
<li>I say: that’s cool.</li>
<li>I can’t count higher than about 0xFFFF anyways.</li>
</ul></li>
<li>The blog impolitely calls 1980s bootloaders “archaic” instead of “vintage”, “retro”, or “foundational”.</li>
</ul>
</section>
<section id="bootable-disks" class="slide level2">
<h2>Bootable Disks</h2>
<ul>
<li>I should also tell you about <em>bootable disks</em></li>
<li>Nowadays we all boot from SSD or rarely HDD.</li>
<li>But you have probably at some point booted from USB.
<ul>
<li>Usually when removing a virus like Microsoft Windows from your system.</li>
</ul></li>
<li>Olden days computers could boot from floppy disks, etc.</li>
</ul>
</section>
<section id="bootlaoder" class="slide level2">
<h2>Bootlaoder</h2>
<ul>
<li>I mentioned 1980s bootloaders.
<ul>
<li>No relation to bootleggers or boatloaders.</li>
</ul></li>
<li>512-byte portion of executable code stored at the bootable disk’s “beginning”.
<ul>
<li>On a HDD this is physically the outermost ring of addressable magnetic regions.</li>
<li>I don’t know how SSDs work as Samsung, SK Hynix, or Micron (shout out Boise).</li>
</ul></li>
</ul>
</section>
<section id="data-structures" class="slide level2">
<h2>Data Structures</h2>
<ul>
<li>Most bootloaders are larger than 512 bytes.</li>
<li>So bootloaders are commonly split into a 512 byte first stage that loads a latter stage.
<ul>
<li>This is why we should still be teaching linked lists, basically.</li>
</ul></li>
</ul>
</section>
<section id="location-location" class="slide level2">
<h2>Location, Location</h2>
<ul>
<li>The bootloader lives in a reserved physical (HDD) or logical (SSD) location.</li>
<li>Does the OS?
<ul>
<li>With respect to itself, yes, the OS probably says it lives at memory location zero.</li>
<li>With respect to underlying hardware? Probably not.
<ul>
<li>Gotta find it.</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="booting-the-os" class="slide level2">
<h2>Booting the OS</h2>
<ul>
<li>The bootloader has to determine the location of the <em>kernel image</em> on disk and load it into memory.
<ul>
<li>Basically this is the definition of the kernel, the minimal OS internal that runs first.</li>
<li>Image here means we have physical bits capturing some information, so copies of the bits may live in different places.
<ul>
<li>SSD and RAM, for example.</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="switcheroo" class="slide level2">
<h2>Switcheroo</h2>
<ul>
<li>The OS probably is not a 16-bit OS.
<ul>
<li>Unless? Lab idea? Hold me back!</li>
</ul></li>
<li>Big OS wants me to tell you that:
<ul>
<li>16-bit mode is called “real mode”</li>
<li>32-bit mode is called “protected mode”</li>
<li>64-bit mode is called “long mode”.</li>
</ul></li>
<li>Recall we were writing 64-bit bare metal.</li>
</ul>
</section>
<section id="hand-wave" class="slide level2">
<h2>Hand-wave</h2>
<blockquote>
<p>Writing a bootloader is a bit cumbersome as it requires assembly language and “write this magic value to this processor register”.</p>
</blockquote>
<blockquote>
<p>Instead use a <a href="https://github.com/rust-osdev/bootimage">bootimage</a> that automatically prepends a bootloader to your kernel.</p>
</blockquote>
<ul>
<li>This is called “cheating” and is a good way to get ahead in life.</li>
</ul>
<!--

## The Multiboot Standard

To avoid that every operating system implements its own bootloader, which is only compatible with a single OS, the [Free Software Foundation] created an open bootloader standard called [Multiboot] in 1995. The standard defines an interface between the bootloader and the operating system, so that any Multiboot-compliant bootloader can load any Multiboot-compliant operating system. The reference implementation is [GNU GRUB], which is the most popular bootloader for Linux systems.

[Free Software Foundation]: https://en.wikipedia.org/wiki/Free_Software_Foundation
[Multiboot]: https://wiki.osdev.org/Multiboot
[GNU GRUB]: https://en.wikipedia.org/wiki/GNU_GRUB

To make a kernel Multiboot compliant, one just needs to insert a so-called [Multiboot header] at the beginning of the kernel file. This makes it very easy to boot an OS from GRUB. However, GRUB and the Multiboot standard have some problems too:

[Multiboot header]: https://www.gnu.org/software/grub/manual/multiboot/multiboot.html#OS-image-format

- They support only the 32-bit protected mode. This means that you still have to do the CPU configuration to switch to the 64-bit long mode.
- They are designed to make the bootloader simple instead of the kernel. For example, the kernel needs to be linked with an [adjusted default page size], because GRUB can't find the Multiboot header otherwise. Another example is that the [boot information], which is passed to the kernel, contains lots of architecture-dependent structures instead of providing clean abstractions.
- Both GRUB and the Multiboot standard are only sparsely documented.
- GRUB needs to be installed on the host system to create a bootable disk image from the kernel file. This makes development on Windows or Mac more difficult.

[adjusted default page size]: https://wiki.osdev.org/Multiboot#Multiboot_2
[boot information]: https://www.gnu.org/software/grub/manual/multiboot/multiboot.html#Boot-information-format

Because of these drawbacks, we decided to not use GRUB or the Multiboot standard. However, we plan to add Multiboot support to our [bootimage] tool, so that it's possible to load your kernel on a GRUB system too. If you're interested in writing a Multiboot compliant kernel, check out the [first edition] of this blog series.

[first edition]: @/edition-1/_index.md

-->
</section></section>
<section>
<section id="kernel" class="title-slide slide level1 center">
<h1>Kernel</h1>

</section>
<section id="a-minimal-kernel" class="slide level2">
<h2>A Minimal Kernel</h2>
<ul>
<li>Let’s make a kernel.</li>
<li>Specifically, a disk image that prints a “Hello World!” to the screen when booted.</li>
<li>We extending our bare metal executable.</li>
</ul>
<!--

## Installing Rust Nightly

Rust has three release channels: _stable_, _beta_, and _nightly_. The Rust Book explains the difference between these channels really well, so take a minute and [check it out](https://doc.rust-lang.org/book/appendix-07-nightly-rust.html#choo-choo-release-channels-and-riding-the-trains). For building an operating system, we will need some experimental features that are only available on the nightly channel, so we need to install a nightly version of Rust.

To manage Rust installations, I highly recommend [rustup]. It allows you to install nightly, beta, and stable compilers side-by-side and makes it easy to update them. With rustup, you can use a nightly compiler for the current directory by running `rustup override set nightly`. Alternatively, you can add a file called `rust-toolchain` with the content `nightly` to the project's root directory. You can check that you have a nightly version installed by running `rustc --version`: The version number should contain `-nightly` at the end.

[rustup]: https://www.rustup.rs/

The nightly compiler allows us to opt-in to various experimental features by using so-called _feature flags_ at the top of our file. For example, we could enable the experimental [`asm!` macro] for inline assembly by adding `#![feature(asm)]` to the top of our `main.rs`. Note that such experimental features are completely unstable, which means that future Rust versions might change or remove them without prior warning. For this reason, we will only use them if absolutely necessary.

[`asm!` macro]: https://doc.rust-lang.org/stable/reference/inline-assembly.html

-->
</section>
<section id="target-triple" class="slide level2">
<h2>Target Triple</h2>
<ul>
<li>We recall the “<a href="31_linker.md#target-triple">target triple</a>”</li>
<li>Imagine <code>host</code> triple is <code>x86_64-unknown-linux-gnu</code>
<ul>
<li>CPU architecture (<code>x86_64</code>),</li>
<li>Vendor (<code>unknown</code>) - It’s Intel #Portland</li>
<li>Operating system (<code>linux</code>)</li>
<li>The <a href="https://en.wikipedia.org/wiki/Application_binary_interface">ABI</a> (<code>gnu</code>).</li>
</ul></li>
</ul>
</section>
<section id="our-target" class="slide level2">
<h2>Our Target</h2>
<ul>
<li>I am aware of no existing target triple suitable for this course.</li>
<li>So, make our own.</li>
<li>It’s not too bad, just JSON.
<ul>
<li>We’ll specify some easy stuff, like architecture.</li>
<li>Some weird stuff, like manual memory layouts.</li>
<li>And get on with things.</li>
</ul></li>
</ul>
</section>
<section id="json" class="slide level2">
<h2>JSON</h2>
<ul>
<li>JSON rules by the way.</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="sourceCode numberSource json number-lines code-with-copy"><code class="sourceCode json"><span id="cb1-1"><a></a><span class="fu">{</span></span>
<span id="cb1-2"><a></a>    <span class="dt">"llvm-target"</span><span class="fu">:</span> <span class="st">"x86_64-unknown-linux-gnu"</span><span class="fu">,</span></span>
<span id="cb1-3"><a></a>    <span class="dt">"data-layout"</span><span class="fu">:</span> <span class="st">"e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-i128:128-f80:128-n8:16:32:64-S128"</span><span class="fu">,</span></span>
<span id="cb1-4"><a></a>    <span class="dt">"arch"</span><span class="fu">:</span> <span class="st">"x86_64"</span><span class="fu">,</span></span>
<span id="cb1-5"><a></a>    <span class="dt">"target-endian"</span><span class="fu">:</span> <span class="st">"little"</span><span class="fu">,</span></span>
<span id="cb1-6"><a></a>    <span class="dt">"target-pointer-width"</span><span class="fu">:</span> <span class="dv">64</span><span class="fu">,</span></span>
<span id="cb1-7"><a></a>    <span class="dt">"target-c-int-width"</span><span class="fu">:</span> <span class="dv">32</span><span class="fu">,</span></span>
<span id="cb1-8"><a></a>    <span class="dt">"os"</span><span class="fu">:</span> <span class="st">"linux"</span><span class="fu">,</span></span>
<span id="cb1-9"><a></a>    <span class="dt">"executables"</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb1-10"><a></a>    <span class="dt">"linker-flavor"</span><span class="fu">:</span> <span class="st">"gcc"</span><span class="fu">,</span></span>
<span id="cb1-11"><a></a>    <span class="dt">"pre-link-args"</span><span class="fu">:</span> <span class="ot">[</span><span class="st">"-m64"</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb1-12"><a></a>    <span class="dt">"morestack"</span><span class="fu">:</span> <span class="kw">false</span></span>
<span id="cb1-13"><a></a><span class="fu">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="some-context" class="slide level2">
<h2>Some context</h2>
<ul>
<li>Most fields are required by LLVM.</li>
<li>Data layout field defines the size of integer, float (ew), and pointer types.</li>
<li>Rust uses conditional compilation, such as via <code>target-pointer-width</code>.</li>
<li>The <code>pre-link-args</code> field specifies arguments passed to the linker.</li>
</ul>
</section>
<section id="arm64-take-notes" class="slide level2">
<h2>ARM64 Take Notes</h2>
<ul>
<li>We also target <code>x86_64</code>.</li>
<li>Start here:</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>x86_64-osirs.json</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" data-filename="x86_64-osirs.json"><pre class="sourceCode numberSource json number-lines code-with-copy"><code class="sourceCode json"><span id="cb2-1"><a></a><span class="fu">{</span></span>
<span id="cb2-2"><a></a>    <span class="dt">"llvm-target"</span><span class="fu">:</span> <span class="st">"x86_64-unknown-none"</span><span class="fu">,</span></span>
<span id="cb2-3"><a></a>    <span class="dt">"data-layout"</span><span class="fu">:</span> <span class="st">"e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-i128:128-f80:128-n8:16:32:64-S128"</span><span class="fu">,</span></span>
<span id="cb2-4"><a></a>    <span class="dt">"arch"</span><span class="fu">:</span> <span class="st">"x86_64"</span><span class="fu">,</span></span>
<span id="cb2-5"><a></a>    <span class="dt">"target-endian"</span><span class="fu">:</span> <span class="st">"little"</span><span class="fu">,</span></span>
<span id="cb2-6"><a></a>    <span class="dt">"target-pointer-width"</span><span class="fu">:</span> <span class="dv">64</span><span class="fu">,</span></span>
<span id="cb2-7"><a></a>    <span class="dt">"target-c-int-width"</span><span class="fu">:</span> <span class="dv">32</span><span class="fu">,</span></span>
<span id="cb2-8"><a></a>    <span class="dt">"os"</span><span class="fu">:</span> <span class="st">"none"</span><span class="fu">,</span></span>
<span id="cb2-9"><a></a>    <span class="dt">"executables"</span><span class="fu">:</span> <span class="kw">true</span></span>
<span id="cb2-10"><a></a><span class="fu">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="changes" class="slide level2">
<h2>Changes</h2>
<ul>
<li>Note that we changed the OS in the <code>llvm-target</code> and the <code>os</code> field to <code>none</code>, because we will run on bare metal.</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>x86_64-osirs.json</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" data-filename="x86_64-osirs.json" data-code-line-numbers="2, 8"><pre class="sourceCode numberSource json number-lines code-with-copy"><code class="sourceCode json"><span id="cb3-1"><a></a><span class="fu">{</span></span>
<span id="cb3-2"><a></a>    <span class="dt">"llvm-target"</span><span class="fu">:</span> <span class="st">"x86_64-unknown-none"</span><span class="fu">,</span></span>
<span id="cb3-3"><a></a>    <span class="er">...</span></span>
<span id="cb3-4"><a></a>    <span class="dt">"os"</span><span class="fu">:</span> <span class="st">"none"</span><span class="fu">,</span></span>
<span id="cb3-5"><a></a>    <span class="er">...</span></span>
<span id="cb3-6"><a></a><span class="fu">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="linking" class="slide level2">
<h2>Linking</h2>
<ul>
<li>We’ll add the following build-related entries:</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>x86_64-osirs.json</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" data-filename="x86_64-osirs.json"><pre class="sourceCode numberSource json number-lines code-with-copy"><code class="sourceCode json"><span id="cb4-1"><a></a><span class="fu">{</span></span>
<span id="cb4-2"><a></a>    <span class="dt">"linker-flavor"</span><span class="fu">:</span> <span class="st">"ld.lld"</span><span class="fu">,</span></span>
<span id="cb4-3"><a></a>    <span class="dt">"linker"</span><span class="fu">:</span> <span class="st">"rust-lld"</span><span class="fu">,</span></span>
<span id="cb4-4"><a></a><span class="fu">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<ul>
<li>For OS-agnosticism, we use the cross-platform “LLD” linker that is shipped with Rust for linking our kernel.
<ul>
<li><a href="https://lld.llvm.org/">More.</a></li>
</ul></li>
</ul>
</section>
<section id="panic-abort" class="slide level2">
<h2>Panic Abort</h2>
<ul>
<li>You know how I feel about unwinding.
<ul>
<li>I have never relaxed in my life.</li>
<li>I’ve only panicked and given up.</li>
</ul></li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>x86_64-osirs.json</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5" data-filename="x86_64-osirs.json"><pre class="sourceCode numberSource json number-lines code-with-copy"><code class="sourceCode json"><span id="cb5-1"><a></a><span class="fu">{</span></span>
<span id="cb5-2"><a></a>    <span class="dt">"panic-strategy"</span><span class="fu">:</span> <span class="st">"abort"</span><span class="fu">,</span></span>
<span id="cb5-3"><a></a><span class="fu">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="target-vs.-toml" class="slide level2">
<h2>Target vs.&nbsp;TOML</h2>
<ul>
<li>This has the same effect as the <code>panic = "abort"</code> option in our Cargo.toml</li>
<li>So we can remove it from there!</li>
<li>This is better though:
<ul>
<li>We will use <code>core</code>, an architecture specific library, and we need <code>core</code> to <em>also</em> panic abort.</li>
<li><a href="https://doc.rust-lang.org/core/">“It is the portable glue between the language and its libraries, defining the intrinsic and primitive building blocks of all Rust code.”</a></li>
</ul></li>
</ul>
</section>
<section id="red-zone" class="slide level2">
<h2>Red Zone</h2>
<ul>
<li>Okay red zone is not particularly relevant to this class.</li>
<li>But it is <em>extremely</em> cool.</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>x86_64-osirs.json</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6" data-filename="x86_64-osirs.json"><pre class="sourceCode numberSource json number-lines code-with-copy"><code class="sourceCode json"><span id="cb6-1"><a></a><span class="fu">{</span></span>
<span id="cb6-2"><a></a>    <span class="dt">"disable-redzone"</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb6-3"><a></a><span class="fu">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<!--

- So I'm going to tell you about it.

## The Red Zone

- The **Red Zone** is a 128-byte optimization area below the current stack pointer ($RSP$).
    - "R" for 64 bit.
    - "SP" for "stack pointer"
- It is a specific feature of the x86-64 System V ABI (Application Binary Interface).
- It allows functions to use a small amount of stack space without actually moving the pointer.

## Performance Gains

- Normally, any data written to the stack requires an $RSP$ adjustment to prevent data corruption.
    - `sub rsp, 8`
    - `mov [rsp], rax`
- With the Red Zone, compilers can skip the subtraction for some functions.
- This reduces the number of instructions and speeds up function execution.
    - At the cost of *no longer tracking the stack*.

## Negative Indexing

- Since $RSP$ remains at the "top" of the stack, we access this memory using negative offsets.
- In assembly, this looks like `mov [rsp - 16], rax`.
- This treats the stack as a fixed-base array rather than a stack ADT.
- It is essentially "free" scratch space for short-lived data.

## The Danger of Interrupts

- The Red Zone is dangerous in kernel development because of **hardware interrupts**.
    - The OS has to deal with, say, someone hitting the power off button.
    - Someone plugging in a USB drive.
    - Lightning strikes.
    - Cosmic rays flipping bits
    
## Red Zone to Dead Zone
    
- When an interrupt occurs, the CPU pushes state (like $RIP$ and $RFLAGS$) onto the stack.
    - "Instruction pointer" and "flags".
- This will overwrite those 128 bytes of data.
- This leads to silent, non-deterministic memory corruption.
    - Generally regarded as bad.
    
## Read more

- There are good visuals here.
- [Read more](https://os.phil-opp.com/red-zone/)
- Handwaving now - Better for the compilers class I think!

-->
</section>
<section id="ancient-nemesis" class="slide level2">
<h2>Ancient Nemesis</h2>
<ul>
<li>You all know I love floating point numbers.
<ul>
<li>And with good reason!</li>
</ul></li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>x86_64-osirs.json</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7" data-filename="x86_64-osirs.json"><pre class="sourceCode numberSource json number-lines code-with-copy"><code class="sourceCode json"><span id="cb7-1"><a></a><span class="fu">{</span></span>
<span id="cb7-2"><a></a>    <span class="dt">"features"</span><span class="fu">:</span> <span class="st">"-mmx,-sse,+soft-float"</span><span class="fu">,</span></span>
<span id="cb7-3"><a></a><span class="fu">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="turn-off-floats" class="slide level2">
<h2>Turn off floats</h2>
<ul>
<li><code>features</code> enables/disables target features.</li>
<li>We disable the <code>mmx</code> and <code>sse</code> features by prefixing them with a minus</li>
<li>We enable the <code>soft-float</code> feature by prefixing it with a plus.</li>
<li>Note that there must be no spaces between different flags!</li>
</ul>
</section>
<section id="mmxsse" class="slide level2">
<h2>MMX/SSE</h2>
<ul>
<li>The <code>mmx</code> and <code>sse</code> features are performance optimizing vector operations from when Intel though they’d be able to hold off NVIDIA in the 90s.</li>
<li>These are braodly called <a href="https://en.wikipedia.org/wiki/SIMD">Single Instruction Multiple Data (SIMD)</a> instructions and are historically important.
<ul>
<li>Foundation of <code>numpy</code></li>
</ul></li>
<li>We aren’t using data frames in our kernel.</li>
</ul>
</section>
<section id="soft-float" class="slide level2">
<h2>Soft Float</h2>
<ul>
<li>Floating point operations on <code>x86_64</code> require SIMD registers by default.
<ul>
<li>That’s right - floats are worse than you thought!</li>
</ul></li>
<li>To solve this problem, we add the <code>soft-float</code> feature, which emulates all floating point operations through software functions based on normal integers.
<ul>
<li>Just like <a href="https://cd-c89.github.io/rs/51_f16.html"><code>f16</code></a></li>
</ul></li>
</ul>
</section>
<section id="aside-1" class="slide level2">
<h2>Aside</h2>
<ul>
<li>We also need to tell the Rust compiler <code>rustc</code> that we want to use the corresponding ABI.</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>x86_64-osirs.json</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8" data-filename="x86_64-osirs.json"><pre class="sourceCode numberSource json number-lines code-with-copy"><code class="sourceCode json"><span id="cb8-1"><a></a><span class="fu">{</span></span>
<span id="cb8-2"><a></a>    <span class="dt">"rustc-abi"</span><span class="fu">:</span> <span class="st">"x86-softfloat"</span></span>
<span id="cb8-3"><a></a><span class="fu">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<ul>
<li>I am 100% sure I can write an OS without hard or soft floats but I haven’t worked far enough ahead to be absolutely certain.</li>
</ul>
</section>
<section id="altogether" class="slide level2">
<h2>Altogether</h2>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>x86_64-osirs.json</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9" data-filename="x86_64-osirs.json"><pre class="sourceCode numberSource json number-lines code-with-copy"><code class="sourceCode json"><span id="cb9-1"><a></a><span class="fu">{</span></span>
<span id="cb9-2"><a></a>    <span class="dt">"llvm-target"</span><span class="fu">:</span> <span class="st">"x86_64-unknown-none"</span><span class="fu">,</span></span>
<span id="cb9-3"><a></a>    <span class="dt">"data-layout"</span><span class="fu">:</span> <span class="st">"e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-i128:128-f80:128-n8:16:32:64-S128"</span><span class="fu">,</span></span>
<span id="cb9-4"><a></a>    <span class="dt">"arch"</span><span class="fu">:</span> <span class="st">"x86_64"</span><span class="fu">,</span></span>
<span id="cb9-5"><a></a>    <span class="dt">"target-endian"</span><span class="fu">:</span> <span class="st">"little"</span><span class="fu">,</span></span>
<span id="cb9-6"><a></a>    <span class="dt">"target-pointer-width"</span><span class="fu">:</span> <span class="dv">64</span><span class="fu">,</span></span>
<span id="cb9-7"><a></a>    <span class="dt">"target-c-int-width"</span><span class="fu">:</span> <span class="dv">32</span><span class="fu">,</span></span>
<span id="cb9-8"><a></a>    <span class="dt">"os"</span><span class="fu">:</span> <span class="st">"none"</span><span class="fu">,</span></span>
<span id="cb9-9"><a></a>    <span class="dt">"executables"</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb9-10"><a></a>    <span class="dt">"linker-flavor"</span><span class="fu">:</span> <span class="st">"ld.lld"</span><span class="fu">,</span></span>
<span id="cb9-11"><a></a>    <span class="dt">"linker"</span><span class="fu">:</span> <span class="st">"rust-lld"</span><span class="fu">,</span></span>
<span id="cb9-12"><a></a>    <span class="dt">"panic-strategy"</span><span class="fu">:</span> <span class="st">"abort"</span><span class="fu">,</span></span>
<span id="cb9-13"><a></a>    <span class="dt">"disable-redzone"</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb9-14"><a></a>    <span class="dt">"features"</span><span class="fu">:</span> <span class="st">"-mmx,-sse,+soft-float"</span><span class="fu">,</span></span>
<span id="cb9-15"><a></a>    <span class="dt">"rustc-abi"</span><span class="fu">:</span> <span class="st">"x86-softfloat"</span></span>
<span id="cb9-16"><a></a><span class="fu">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="i-just-curl" class="slide level2">
<h2>I just <code>curl</code></h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><a></a><span class="ex">curl</span> https://raw.githubusercontent.com/phil-opp/blog_os/refs/heads/post-02/x86_64-blog_os.json <span class="at">-o</span> x86_64-osirs.json</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="tree" class="slide level2">
<h2>Tree</h2>
<ul>
<li>For me looks like this.</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><a></a><span class="ex">$</span> tree</span>
<span id="cb11-2"><a></a><span class="bu">.</span></span>
<span id="cb11-3"><a></a><span class="ex">├──</span> Cargo.lock</span>
<span id="cb11-4"><a></a><span class="ex">├──</span> Cargo.toml</span>
<span id="cb11-5"><a></a><span class="ex">├──</span> src</span>
<span id="cb11-6"><a></a><span class="ex">│&nbsp;&nbsp;</span> ├── main.rs</span>
<span id="cb11-7"><a></a><span class="ex">│&nbsp;&nbsp;</span> └── old.rs</span>
<span id="cb11-8"><a></a><span class="ex">└──</span> x86_64-osirs.json</span>
<span id="cb11-9"><a></a></span>
<span id="cb11-10"><a></a><span class="ex">1</span> directory, 5 files</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="back-to-loops" class="slide level2">
<h2>Back to loops</h2>
<ul>
<li>By the way, I’ve switched from cool, good recursion back to unexciting, drab loops</li>
<li>Infinite recursion blows up the call stack and instantly segmentation faults.
<ul>
<li>This is because someone other than me wrote <code>rustc</code>.</li>
<li>I am not about to write <code>rustc</code>!</li>
</ul></li>
</ul>
</section>
<section id="current-main" class="slide level2">
<h2>Current main</h2>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/main.rs</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12" data-filename="src/main.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb12-1"><a></a><span class="at">#![</span>no_std<span class="at">]</span></span>
<span id="cb12-2"><a></a><span class="at">#![</span>no_main<span class="at">]</span></span>
<span id="cb12-3"><a></a></span>
<span id="cb12-4"><a></a><span class="at">#[</span><span class="kw">unsafe</span><span class="at">(</span>no_mangle<span class="at">)]</span></span>
<span id="cb12-5"><a></a><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">"C"</span> <span class="kw">fn</span> _start() <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb12-6"><a></a>    <span class="cf">loop</span> <span class="op">{}</span></span>
<span id="cb12-7"><a></a><span class="op">}</span></span>
<span id="cb12-8"><a></a></span>
<span id="cb12-9"><a></a><span class="at">#[</span>panic_handler<span class="at">]</span></span>
<span id="cb12-10"><a></a><span class="kw">fn</span> panic(_info<span class="op">:</span> <span class="op">&amp;</span><span class="pp">core::panic::</span>PanicInfo) <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb12-11"><a></a>    <span class="cf">loop</span> <span class="op">{}</span></span>
<span id="cb12-12"><a></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="a-note" class="slide level2">
<h2>A note</h2>
<ul>
<li>Remember the earlier mention of <code>core</code>
<ul>
<li>How we need <code>core</code> to also panic abort?</li>
<li>We note when looking at <code>src/main.rs</code> we do have a <code>core</code> reference.</li>
</ul></li>
</ul>
</section>
<section id="linux-everywhere" class="slide level2">
<h2>Linux Everywhere</h2>
<ul>
<li>Okay so we aren’t going to use Linux on our device.</li>
<li>But we are going to use Linux <em>conventions</em>
<ul>
<li>Not Linux software, but Linux as a social technology.</li>
</ul></li>
<li>The <code>ld.lld</code> “linker-flavor” instructs LLVM to compile with the <code>-flavor gnu</code> flag.</li>
<li>This means that we need an entry point named <code>_start</code> - same as before!</li>
</ul>
</section>
<section id="build-it" class="slide level2">
<h2>Build it</h2>
<ul>
<li>I bet it will work now.
<ul>
<li>Use our new target by passing the name of the JSON file as <code>--target</code>:</li>
</ul></li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb13-1"><a></a><span class="ex">$</span> cargo b <span class="at">--target</span> x86_64-osirs.json</span>
<span id="cb13-2"><a></a><span class="ex">error:</span> failed to run <span class="kw">`</span><span class="ex">rustc</span><span class="kw">`</span> to learn about target-specific information</span>
<span id="cb13-3"><a></a></span>
<span id="cb13-4"><a></a><span class="ex">Caused</span> by:</span>
<span id="cb13-5"><a></a>  <span class="ex">process</span> didn<span class="st">'t exit successfully: `/home/user/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/bin/rustc - --crate-name ___ --print=file-names --target /home/user/tmp/32/x86_64-osirs.json --crate-type bin --crate-type rlib --crate-type dylib --crate-type cdylib --crate-type staticlib --crate-type proc-macro --print=sysroot --print=split-debuginfo --print=crate-name --print=cfg -Wwarnings` (exit status: 1)</span></span>
<span id="cb13-6"><a></a><span class="st">  --- stderr</span></span>
<span id="cb13-7"><a></a><span class="st">  error: Error loading target specification: Field target-pointer-width in target specification is required. Run `rustc --print target-list` for a list of built-in targets</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="aside-2" class="slide level2">
<h2>Aside</h2>
<ul>
<li>If you did not see that error, that is okay!</li>
<li>It concerns an unstable language feature and may differ.</li>
<li>Just skip two slides!</li>
</ul>
</section>
<section id="okay-so" class="slide level2">
<h2>Okay so</h2>
<ul>
<li>Huh?</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb14-1"><a></a><span class="ex">Field</span> target-pointer-width in target specification is required.</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li>We very explicitly included that.</li>
<li>In the most annoying thing in the universe, <code>rustc</code> expect pointer width as a JSON string and not a JSON integer.
<ul>
<li><a href="https://github.com/rust-lang/rust/pull/144218">Read more</a></li>
<li>It’s fixed in Nightly, but I sleep at night, so I’m busy.</li>
</ul></li>
</ul>
</section>
<section id="fix-it" class="slide level2">
<h2>Fix it?</h2>
<ul>
<li>I kid you not this is the solution.
<ul>
<li>“Rust has a type system!”</li>
<li>Sure it does.</li>
</ul></li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb15-1"><a></a><span class="ex">$</span> diff bad.wrong x86_64-osirs.json</span>
<span id="cb15-2"><a></a><span class="ex">6,7c6,7</span></span>
<span id="cb15-3"><a></a><span class="op">&lt;</span>     <span class="st">"target-pointer-width"</span>: <span class="ex">64,</span></span>
<span id="cb15-4"><a></a><span class="op">&lt;</span>     <span class="st">"target-c-int-width"</span>: <span class="ex">32,</span></span>
<span id="cb15-5"><a></a><span class="ex">---</span></span>
<span id="cb15-6"><a></a><span class="op">&gt;</span>     <span class="st">"target-pointer-width"</span>: <span class="st">"64"</span><span class="ex">,</span></span>
<span id="cb15-7"><a></a><span class="op">&gt;</span>     <span class="st">"target-c-int-width"</span>: <span class="st">"32"</span><span class="ex">,</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="now-it-works" class="slide level2">
<h2>Now it works</h2>
<ul>
<li>This time it will work.</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb16"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb16-1"><a></a><span class="ex">$</span> cargo b <span class="at">--target</span> x86_64-osirs.json</span>
<span id="cb16-2"><a></a>   <span class="ex">Compiling</span> osirs v0.1.0 <span class="er">(</span><span class="ex">/home/user/tmp/32</span><span class="kw">)</span></span>
<span id="cb16-3"><a></a><span class="va">error</span><span class="op">[</span>E0463<span class="op">]</span><span class="ex">:</span> can<span class="st">'t find crate for `core`</span></span>
<span id="cb16-4"><a></a><span class="st">  |</span></span>
<span id="cb16-5"><a></a><span class="st">  = note: the `x86_64-osirs` target may not be installed</span></span>
<span id="cb16-6"><a></a><span class="st">  = help: consider downloading the target with `rustup target add x86_64-osirs`</span></span>
<span id="cb16-7"><a></a></span>
<span id="cb16-8"><a></a><span class="st">For more information about this error, try `rustc --explain E0463`.</span></span>
<span id="cb16-9"><a></a><span class="st">error: could not compile `osirs` (bin "osirs") due to 1 previous error</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li>Okay I was bamboozled.</li>
</ul>
</section>
<section id="the-core" class="slide level2">
<h2>The Core</h2>
<div class="columns">
<div class="column" style="width:70%;">
<blockquote>
<p><a href="https://en.wikipedia.org/wiki/The_Core">The Core is a 2003 American science fiction disaster film directed by Jon Amiel with screenplay written by Cooper Layne and John Rogers.</a></p>
</blockquote>
<ul>
<li>I haven’t seen it but it apparently passes the <a href="https://en.wikipedia.org/wiki/Bechdel_test">Bechdel Test</a></li>
</ul>
</div><div class="column" style="width:30%;">
<p><img data-src="https://upload.wikimedia.org/wikipedia/en/f/f4/The_Core_poster.jpg"></p>
</div></div>
</section>
<section id="wrong-core" class="slide level2">
<h2>Wrong Core</h2>
<ul>
<li>We actually meant the Rust compiler <code>core</code> library.
<ul>
<li><a href="https://doc.rust-lang.org/nightly/core/index.html">Read more</a></li>
</ul></li>
<li>This library contains basic Rust types such as <code>Result</code>, <code>Option</code>, and iterators, and is implicitly linked to all <code>no_std</code> crates.</li>
</ul>
</section>
<section id="the-problem" class="slide level2">
<h2>The Problem</h2>
<ul>
<li><code>core</code> is usually <em>pre-compiled</em> (and then, of course, linked).</li>
<li>But we made a new target which needs a new core.</li>
<li>No problem, we’ll just tell <code>rustc</code> to do some compilation.</li>
</ul>
</section>
<section id="config" class="slide level2">
<h2>Config</h2>
<ul>
<li>The most graceful to do this that <em>I</em> am aware of is with a <code>.cargo/config.toml</code></li>
<li>Basically, we can write down some things we <em>always</em> want <code>cargo</code> to do, and store them in TOML file in the hidden <code>.cargo</code> folder.</li>
<li>I just made the folder then opened it up in my most beloved neon vimothy.</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb17"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb17-1"><a></a><span class="ex">mdkir</span> .cargo</span>
<span id="cb17-2"><a></a><span class="ex">nvim</span> .cargo/config.toml</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="check-in" class="slide level2">
<h2>Check in</h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb18"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb18-1"><a></a><span class="ex">mdkir</span> .cargo</span>
<span id="cb18-2"><a></a><span class="ex">nvim</span> .cargo/config.toml</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li>Understanding check - what happens if you don’t make <code>.cargo</code> first?</li>
</ul>
</section>
<section id="the-build-std-option" class="slide level2">
<h2>The <code>build-std</code> Option</h2>
<ul>
<li><code>build-std</code> is a feature of Cargo.</li>
<li>We can recompile <code>core</code> and other standard library crates on demand.
<ul>
<li>Vs. using the precompiled versions shipped with the Rust installation.</li>
</ul></li>
<li><a href="https://doc.rust-lang.org/nightly/cargo/reference/unstable.html#build-std">Read more.</a></li>
</ul>
</section>
<section id="my-config" class="slide level2">
<h2>My Config</h2>
<ul>
<li>We can use a pretty sparse config though we’ll want to add more latter.</li>
<li>I specify the “build-std” option in TOML.</li>
<li>We want to <code>build-std</code></li>
<li>We want to build the <code>core</code></li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>.cargo/config.toml</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb19" data-filename=".cargo/config.toml"><pre class="sourceCode numberSource toml number-lines code-with-copy"><code class="sourceCode toml"><span id="cb19-1"><a></a><span class="er"></span><span class="dt">build-std</span> <span class="op">=</span> <span class="op">[</span><span class="st">"core"</span><span class="op">]</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<ul>
<li>I bet this will work.</li>
</ul>
</section>
<section id="oh." class="slide level2">
<h2>Oh.</h2>
<ul>
<li>The exact same error as before?</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb20"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb20-1"><a></a><span class="ex">$</span> cargo b <span class="at">--target</span> x86_64-osirs.json</span>
<span id="cb20-2"><a></a>   <span class="ex">Compiling</span> osirs v0.1.0 <span class="er">(</span><span class="ex">/home/user/tmp/32</span><span class="kw">)</span></span>
<span id="cb20-3"><a></a><span class="va">error</span><span class="op">[</span>E0463<span class="op">]</span><span class="ex">:</span> can<span class="st">'t find crate for `core`</span></span>
<span id="cb20-4"><a></a><span class="st">  |</span></span>
<span id="cb20-5"><a></a><span class="st">  = note: the `x86_64-osirs` target may not be installed</span></span>
<span id="cb20-6"><a></a><span class="st">  = help: consider downloading the target with `rustup target add x86_64-osirs`</span></span>
<span id="cb20-7"><a></a></span>
<span id="cb20-8"><a></a><span class="st">For more information about this error, try `rustc --explain E0463`.</span></span>
<span id="cb20-9"><a></a><span class="st">error: could not compile `osirs` (bin "osirs") due to 1 previous error</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="unstable" class="slide level2">
<h2>Unstable</h2>
<ul>
<li>So apparently <code>build-std</code> is not a stable feature of the Rust language.
<ul>
<li>This means the Rust designers can change or remove it at any time.</li>
</ul></li>
<li>To use unstable features, we have to tell <code>cargo</code> they are unstable.</li>
</ul>
</section>
<section id="mental-model" class="slide level2">
<h2>Mental model</h2>
<ul>
<li>Think of it a bit like unsafe, but for the language instead of the executables.
<ul>
<li>When an executable is unsafe, it may crash or leak your private key.</li>
<li>When a language is unstable, it may not compile or may compile then leak your private key.</li>
</ul></li>
</ul>
</section>
<section id="update-config" class="slide level2">
<h2>Update config</h2>
<ul>
<li>We prepend an <code>[unstable]</code> label to our <code>build-std</code> configuration.</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>.cargo/config.toml</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb21" data-filename=".cargo/config.toml"><pre class="sourceCode numberSource toml number-lines code-with-copy"><code class="sourceCode toml"><span id="cb21-1"><a></a><span class="er"></span><span class="kw">[unstable]</span></span>
<span id="cb21-2"><a></a><span class="dt">build-std</span> <span class="op">=</span> <span class="op">[</span><span class="st">"core"</span><span class="op">]</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<ul>
<li>I bet it will work now (it won’t).</li>
</ul>
</section>
<section id="oh.-1" class="slide level2">
<h2>Oh.</h2>
<ul>
<li>The exact same error as before?</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb22"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb22-1"><a></a><span class="ex">$</span> cargo b <span class="at">--target</span> x86_64-osirs.json</span>
<span id="cb22-2"><a></a>   <span class="ex">Compiling</span> osirs v0.1.0 <span class="er">(</span><span class="ex">/home/user/tmp/32</span><span class="kw">)</span></span>
<span id="cb22-3"><a></a><span class="va">error</span><span class="op">[</span>E0463<span class="op">]</span><span class="ex">:</span> can<span class="st">'t find crate for `core`</span></span>
<span id="cb22-4"><a></a><span class="st">  |</span></span>
<span id="cb22-5"><a></a><span class="st">  = note: the `x86_64-osirs` target may not be installed</span></span>
<span id="cb22-6"><a></a><span class="st">  = help: consider downloading the target with `rustup target add x86_64-osirs`</span></span>
<span id="cb22-7"><a></a></span>
<span id="cb22-8"><a></a><span class="st">For more information about this error, try `rustc --explain E0463`.</span></span>
<span id="cb22-9"><a></a><span class="st">error: could not compile `osirs` (bin "osirs") due to 1 previous error</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="nightly" class="slide level2">
<h2>Nightly</h2>
<ul>
<li>Okay folks here’s the deal.</li>
<li>I’m not happy about it either.</li>
<li><code>build-std</code> - which we need - is unstable and</li>
<li><code>[unstable]</code> is only available in nightly Rust.
<ul>
<li>The version of Rust for <em>nerds</em>.</li>
</ul></li>
<li>Not to worry, we are nerds and can use it.
<ul>
<li>Simply add a <code>+nightly</code> right after cargo.</li>
</ul></li>
</ul>
</section>
<section id="try-two-things" class="slide level2">
<h2>Try Two Things</h2>
<ul>
<li>Here’s two things that also still won’t work.</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb23"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb23-1"><a></a><span class="ex">cargo</span> +nightly b <span class="at">--target</span> x86_64-osirs.json</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li>Gives this:</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb24"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb24-1"><a></a><span class="ex">error:</span> <span class="kw">`</span><span class="ex">.json</span><span class="kw">`</span> target specs require <span class="at">-Zjson-target-spec</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="try-two-things-1" class="slide level2">
<h2>Try Two Things</h2>
<ul>
<li>Here’s two things that also still won’t work.</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb25"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb25-1"><a></a><span class="ex">cargo</span> +nightly b</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li>Gives this:</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb26"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb26-1"><a></a><span class="ex">error:</span> <span class="kw">`</span><span class="ex">.json</span><span class="kw">`</span> target specs require <span class="at">-Zjson-target-spec</span></span>
<span id="cb26-2"><a></a>   <span class="ex">Compiling</span> compiler_builtins v0.1.160 <span class="er">(</span><span class="ex">/home/user/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/compiler-builtins/compiler-builtins</span><span class="kw">)</span></span>
<span id="cb26-3"><a></a>   <span class="ex">Compiling</span> core v0.0.0 <span class="er">(</span><span class="ex">/home/user/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core</span><span class="kw">)</span></span>
<span id="cb26-4"><a></a>   <span class="ex">Compiling</span> osirs v0.1.0 <span class="er">(</span><span class="ex">/home/user/tmp/32</span><span class="kw">)</span></span>
<span id="cb26-5"><a></a><span class="ex">error:</span> linking with <span class="kw">`</span><span class="fu">cc</span><span class="kw">`</span> failed: exit status: 1</span>
<span id="cb26-6"><a></a>  <span class="kw">|</span></span>
<span id="cb26-7"><a></a>  <span class="ex">=</span> note:  <span class="st">"cc"</span> <span class="st">"-m64"</span> <span class="st">"/home/user/tmp/32/target/debug/deps/rustcMmXrbF/symbols.o"</span> <span class="st">"&lt;1 object files omitted&gt;"</span> <span class="st">"-Wl,--as-needed"</span> <span class="st">"-Wl,-Bstatic"</span> <span class="st">"/home/user/tmp/32/target/debug/deps/{libcore-0c26ef2bd74962c1,libcompiler_builtins-40a77a01cbdbd500}.rlib"</span> <span class="st">"-L"</span> <span class="st">"/home/user/tmp/32/target/debug/deps/rustcMmXrbF/raw-dylibs"</span> <span class="st">"-Wl,-Bdynamic"</span> <span class="st">"-B&lt;sysroot&gt;/lib/rustlib/x86_64-unknown-linux-gnu/bin/gcc-ld"</span> <span class="st">"-fuse-ld=lld"</span> <span class="st">"-Wl,--eh-frame-hdr"</span> <span class="st">"-Wl,-z,noexecstack"</span> <span class="st">"-L"</span> <span class="st">"&lt;sysroot&gt;/lib/rustlib/x86_64-unknown-linux-gnu/lib"</span> <span class="st">"-o"</span> <span class="st">"/home/user/tmp/32/target/debug/deps/osirs-62b17f4aa5d3b391"</span> <span class="st">"-Wl,--gc-sections"</span> <span class="st">"-pie"</span> <span class="st">"-Wl,-z,relro,-z,now"</span> <span class="st">"-nodefaultlibs"</span></span>
<span id="cb26-8"><a></a>  <span class="ex">=</span> note: some arguments are omitted. use <span class="kw">`</span><span class="ex">--verbose</span><span class="kw">`</span> to show all linker arguments</span>
<span id="cb26-9"><a></a>  <span class="ex">=</span> note: rust-lld: error: duplicate symbol: _start</span>
<span id="cb26-10"><a></a>          <span class="op">&gt;&gt;&gt;</span> defined <span class="ex">at</span> /usr/lib/gcc/x86_64-linux-gnu/11/../../../x86_64-linux-gnu/Scrt1.o:<span class="er">(</span><span class="ex">_start</span><span class="kw">)</span></span>
<span id="cb26-11"><a></a>          <span class="op">&gt;&gt;&gt;</span> defined <span class="ex">at</span> main.rs:6 <span class="er">(</span><span class="ex">src/main.rs:6</span><span class="kw">)</span></span>
<span id="cb26-12"><a></a>          <span class="op">&gt;&gt;&gt;</span>            /home/user/tmp/32/target/debug/deps/osirs-62b17f4aa5d3b391.3hpwl9lytayxk9wu897na7tu0.0wpyfaj.rcgu.o:<span class="kw">(</span><span class="ex">.text._start+0x0</span><span class="kw">)</span></span>
<span id="cb26-13"><a></a>          <span class="ex">collect2:</span> error: ld returned 1 exit status</span>
<span id="cb26-14"><a></a></span>
<span id="cb26-15"><a></a></span>
<span id="cb26-16"><a></a><span class="ex">error:</span> could not compile <span class="kw">`</span><span class="ex">osirs</span><span class="kw">`</span> <span class="er">(</span><span class="ex">bin</span> <span class="st">"osirs"</span><span class="kw">)</span> <span class="ex">due</span> to 1 previous error</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="the-problem-1" class="slide level2">
<h2>The Problem</h2>
<ul>
<li>Not everything works the same way with nightly and stable rust.
<ul>
<li>That’s why it’s not stable.</li>
</ul></li>
<li>We will encounter two examples immediately, both related to JSON.</li>
<li>Let’s look at this:</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb27"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb27-1"><a></a><span class="ex">$</span> cargo +nightly b <span class="at">--target</span> x86_64-osirs.json</span>
<span id="cb27-2"><a></a><span class="ex">error:</span> <span class="kw">`</span><span class="ex">.json</span><span class="kw">`</span> target specs require <span class="at">-Zjson-target-spec</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="one-solution" class="slide level2">
<h2>One Solution</h2>
<ul>
<li>We can of course just put <code>-Zjson-target-spec</code> in there.</li>
<li>We get an error, but one we are clever enough to handle.</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb28"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb28-1"><a></a><span class="ex">$</span> cargo +nightly b <span class="at">--target</span> x86_64-osirs.json <span class="at">-Zjson-target-spec</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li>Gives this:</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb29"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb29-1"><a></a><span class="ex">error:</span> failed to run <span class="kw">`</span><span class="ex">rustc</span><span class="kw">`</span> to learn about target-specific information</span>
<span id="cb29-2"><a></a></span>
<span id="cb29-3"><a></a><span class="ex">Caused</span> by:</span>
<span id="cb29-4"><a></a>  <span class="ex">process</span> didn<span class="st">'t exit successfully: `/home/user/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/bin/rustc - --crate-name ___ --print=file-names --target /home/user/tmp/32/x86_64-osirs.json -Zunstable-options --crate-type bin --crate-type rlib --crate-type dylib --crate-type cdylib --crate-type staticlib --crate-type proc-macro --print=sysroot --print=split-debuginfo --print=crate-name --print=cfg -Wwarnings` (exit status: 1)</span></span>
<span id="cb29-5"><a></a><span class="st">  --- stderr</span></span>
<span id="cb29-6"><a></a><span class="st">  error: error loading target specification: target-pointer-width: invalid type: string "64", expected u16 at line 6 column 32</span></span>
<span id="cb29-7"><a></a><span class="st">    |</span></span>
<span id="cb29-8"><a></a><span class="st">    = help: run `rustc --print target-list` for a list of built-in targets</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="another-solution" class="slide level2">
<h2>Another Solution</h2>
<ul>
<li>However, that <code>-Zjson-target-spec</code> looks an <em>awful</em> lot like a <code>.cargo/config.toml</code> option…
<ul>
<li>I believe that is also unstable…</li>
<li>… after all, it works fine on stable!</li>
</ul></li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>.cargo/config.toml</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb30" data-filename=".cargo/config.toml"><pre class="sourceCode numberSource toml number-lines code-with-copy"><code class="sourceCode toml"><span id="cb30-1"><a></a><span class="er"></span><span class="kw">[unstable]</span></span>
<span id="cb30-2"><a></a><span class="dt">build-std</span> <span class="op">=</span> <span class="op">[</span><span class="st">"core"</span><span class="op">]</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<ul>
<li>We can then get the same error with less typing:</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb31"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb31-1"><a></a><span class="ex">cargo</span> +nightly b <span class="at">--target</span> x86_64-osirs.json</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="the-error" class="slide level2">
<h2>The error</h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb32" data-code-line-numbers="6"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb32-1"><a></a><span class="ex">error:</span> failed to run <span class="kw">`</span><span class="ex">rustc</span><span class="kw">`</span> to learn about target-specific information</span>
<span id="cb32-2"><a></a></span>
<span id="cb32-3"><a></a><span class="ex">Caused</span> by:</span>
<span id="cb32-4"><a></a>  <span class="ex">process</span> didn<span class="st">'t exit successfully: `/home/user/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/bin/rustc - --crate-name ___ --print=file-names --target /home/user/tmp/32/x86_64-osirs.json -Zunstable-options --crate-type bin --crate-type rlib --crate-type dylib --crate-type cdylib --crate-type staticlib --crate-type proc-macro --print=sysroot --print=split-debuginfo --print=crate-name --print=cfg -Wwarnings` (exit status: 1)</span></span>
<span id="cb32-5"><a></a><span class="st">  --- stderr</span></span>
<span id="cb32-6"><a></a><span class="st">  error: error loading target specification: target-pointer-width: invalid type: string "64", expected u16 at line 6 column 32</span></span>
<span id="cb32-7"><a></a><span class="st">    |</span></span>
<span id="cb32-8"><a></a><span class="st">    = help: run `rustc --print target-list` for a list of built-in targets</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li>Does that remind you of anything?</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb33"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb33-1"><a></a><span class="ex">$</span> diff bad.wrong x86_64-osirs.json</span>
<span id="cb33-2"><a></a><span class="ex">6,7c6,7</span></span>
<span id="cb33-3"><a></a><span class="op">&lt;</span>     <span class="st">"target-pointer-width"</span>: <span class="ex">64,</span></span>
<span id="cb33-4"><a></a><span class="op">&lt;</span>     <span class="st">"target-c-int-width"</span>: <span class="ex">32,</span></span>
<span id="cb33-5"><a></a><span class="ex">---</span></span>
<span id="cb33-6"><a></a><span class="op">&gt;</span>     <span class="st">"target-pointer-width"</span>: <span class="st">"64"</span><span class="ex">,</span></span>
<span id="cb33-7"><a></a><span class="op">&gt;</span>     <span class="st">"target-c-int-width"</span>: <span class="st">"32"</span><span class="ex">,</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="aside-3" class="slide level2">
<h2>Aside</h2>
<ul>
<li>If you did not see that error, that is okay!</li>
<li>It concerns an unstable language feature and may differ.</li>
<li>Just skip one slide!</li>
</ul>
</section>
<section id="revert" class="slide level2">
<h2>Revert!</h2>
<ul>
<li>Change the string integers back to integer integers in your JSON file and you will be living a charmed and blessed life.
<ul>
<li>A long one, compilation is 10+ seconds for me.</li>
</ul></li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb34"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb34-1"><a></a><span class="ex">$</span> cargo +nightly b <span class="at">--target</span> x86_64-osirs.json</span>
<span id="cb34-2"><a></a>   <span class="ex">Compiling</span> compiler_builtins v0.1.160 <span class="er">(</span><span class="ex">/home/user/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/compiler-builtins/compiler-builtins</span><span class="kw">)</span></span>
<span id="cb34-3"><a></a>   <span class="ex">Compiling</span> core v0.0.0 <span class="er">(</span><span class="ex">/home/user/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core</span><span class="kw">)</span></span>
<span id="cb34-4"><a></a><span class="ex">^[[A</span>    Building [==========<span class="op">&gt;</span>                  ] 2/5: core, compiler_builtins                                                                Compiling osirs v0.1.0 <span class="er">(</span><span class="ex">/home/user/tmp/32</span><span class="kw">)</span></span>
<span id="cb34-5"><a></a>    <span class="ex">Finished</span> <span class="kw">`</span><span class="ex">dev</span><span class="kw">`</span> profile [unoptimized + debuginfo] target<span class="er">(</span><span class="ex">s</span><span class="kw">)</span> <span class="er">in</span> <span class="ex">10.18s</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="aside-4" class="slide level2">
<h2>Aside</h2>
<ul>
<li>By the way, are you tired of specifying the target every time?
<ul>
<li>Sounds like a problem for <code>.cargo/config.toml</code>!</li>
</ul></li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>.cargo/config.toml</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb35" data-filename=".cargo/config.toml" data-code-line-numbers="5-6"><pre class="sourceCode numberSource toml number-lines code-with-copy"><code class="sourceCode toml"><span id="cb35-1"><a></a><span class="kw">[unstable]</span></span>
<span id="cb35-2"><a></a><span class="dt">build-std</span> <span class="op">=</span> <span class="op">[</span><span class="st">"core"</span><span class="op">]</span></span>
<span id="cb35-3"><a></a><span class="dt">json-target-spec</span> <span class="op">=</span> <span class="cn">true</span></span>
<span id="cb35-4"><a></a></span>
<span id="cb35-5"><a></a><span class="kw">[build]</span></span>
<span id="cb35-6"><a></a><span class="dt">target</span> <span class="op">=</span> <span class="st">"x86_64-osirs.json"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="run-again" class="slide level2">
<h2>Run again</h2>
<ul>
<li>By the way it will be fast now.</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb36"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb36-1"><a></a><span class="ex">$</span> cargo +nightly b</span>
<span id="cb36-2"><a></a>    <span class="ex">Finished</span> <span class="kw">`</span><span class="ex">dev</span><span class="kw">`</span> profile [unoptimized + debuginfo] target<span class="er">(</span><span class="ex">s</span><span class="kw">)</span> <span class="er">in</span> <span class="ex">0.08s</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="aside-nightly" class="slide level2">
<h2>Aside: Nightly</h2>
<ul>
<li>Surely you can also update <code>.cargo/config.toml</code> to use nightly!
<ul>
<li>You can’t. You can solve the problem other ways though.</li>
<li>Left as an exercise to the interested student.</li>
</ul></li>
</ul>
</section>
<section id="aside-notfutureproofing" class="slide level2">
<h2>Aside: <span class="math inline">\(\not\)</span>Futureproofing</h2>
<ul>
<li>I was pretty sure I can make a kernel without floats.</li>
<li>So I removed the two <code>soft-float</code> lines and it still worked for now.</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb37"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb37-1"><a></a><span class="ex">$</span> diff old.boring x86_64-osirs.json</span>
<span id="cb37-2"><a></a><span class="ex">13,15c13</span></span>
<span id="cb37-3"><a></a><span class="op">&lt;</span>     <span class="st">"disable-redzone"</span>: <span class="fu">true</span>,</span>
<span id="cb37-4"><a></a><span class="op">&lt;</span>     <span class="st">"features"</span>: <span class="st">"-mmx,-sse,+soft-float"</span><span class="ex">,</span></span>
<span id="cb37-5"><a></a><span class="op">&lt;</span>     <span class="st">"rustc-abi"</span>: <span class="st">"x86-softfloat"</span></span>
<span id="cb37-6"><a></a><span class="ex">---</span></span>
<span id="cb37-7"><a></a><span class="op">&gt;</span>     <span class="st">"disable-redzone"</span>: <span class="fu">true</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="aside-notfutureproofing-1" class="slide level2">
<h2>Aside: <span class="math inline">\(\not\)</span>Futureproofing</h2>
<ul>
<li>I was pretty sure I could make a kernel without <code>compiler-builtins</code></li>
<li>These are memory related functions where Rust often uses linked C implementations.</li>
<li>I’m leaving them out for now and will add them in when I need them.</li>
</ul>
<p><code>{.toml filename=".cargo/config.toml} [unstable] build-std-features = ["compiler-builtins-mem"] build-std = ["core", "compiler_builtins"]</code></p>
</section>
<section id="boot-it" class="slide level2">
<h2>Boot it</h2>
<ul>
<li>And with that, I bet this will totally work.</li>
<li>Let’s break out <code>qemu</code></li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb38"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb38-1"><a></a><span class="ex">$</span> qemu-system-x86_64 <span class="at">-kernel</span> target/x86_64-osirs/debug/osirs</span>
<span id="cb38-2"><a></a><span class="ex">Command</span> <span class="st">'qemu-system-x86_64'</span> not found, but can be installed with:</span>
<span id="cb38-3"><a></a><span class="fu">sudo</span> apt install qemu-system-x86      <span class="co"># version 1:6.2+dfsg-2ubuntu6.27, or</span></span>
<span id="cb38-4"><a></a><span class="fu">sudo</span> apt install qemu-system-x86-xen  <span class="co"># version 1:6.2+dfsg-2ubuntu6.27</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li>Oh right, we only installed “misc” <code>qemu</code>
<ul>
<li>Real ones will use <code>apt</code></li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb39"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb39-1"><a></a><span class="fu">sudo</span> apt install qemu-system-x86</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div></li>
</ul>
</section>
<section id="boot-it-1" class="slide level2">
<h2>Boot it</h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb40"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb40-1"><a></a><span class="ex">$</span> qemu-system-x86_64 <span class="at">-kernel</span> target/x86_64-osirs/debug/osirs</span>
<span id="cb40-2"><a></a><span class="ex">qemu-system-x86_64:</span> Error loading uncompressed kernel without PVH ELF Note</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li>Oh right, we did precisely <em>nothing</em> with the BIOS and the bootloader and all that and still need to do those things.
<ul>
<li>I bet that would be a fun topic for a lab.</li>
</ul></li>
</ul>
</section></section>
<section>
<section id="fin" class="title-slide slide level1 center">
<h1>Fin</h1>

</section>
<section id="main-file" class="slide level2">
<h2>Main File</h2>
<ul>
<li>Unaltered except loops for stability.</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/main.rs</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb41" data-filename="src/main.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb41-1"><a></a><span class="at">#![</span>no_std<span class="at">]</span></span>
<span id="cb41-2"><a></a><span class="at">#![</span>no_main<span class="at">]</span></span>
<span id="cb41-3"><a></a></span>
<span id="cb41-4"><a></a><span class="at">#[</span><span class="kw">unsafe</span><span class="at">(</span>no_mangle<span class="at">)]</span></span>
<span id="cb41-5"><a></a><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">"C"</span> <span class="kw">fn</span> _start() <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb41-6"><a></a>    <span class="cf">loop</span> <span class="op">{}</span></span>
<span id="cb41-7"><a></a><span class="op">}</span></span>
<span id="cb41-8"><a></a></span>
<span id="cb41-9"><a></a><span class="at">#[</span>panic_handler<span class="at">]</span></span>
<span id="cb41-10"><a></a><span class="kw">fn</span> panic(_info<span class="op">:</span> <span class="op">&amp;</span><span class="pp">core::panic::</span>PanicInfo) <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb41-11"><a></a>    <span class="cf">loop</span> <span class="op">{}</span></span>
<span id="cb41-12"><a></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="config-file" class="slide level2">
<h2>Config File</h2>
<ul>
<li>All new, only works with nightly.</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>.cargo/config.toml</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb42" data-filename=".cargo/config.toml"><pre class="sourceCode numberSource toml number-lines code-with-copy"><code class="sourceCode toml"><span id="cb42-1"><a></a><span class="kw">[unstable]</span></span>
<span id="cb42-2"><a></a><span class="dt">build-std</span> <span class="op">=</span> <span class="op">[</span><span class="st">"core"</span><span class="op">]</span></span>
<span id="cb42-3"><a></a><span class="dt">json-target-spec</span> <span class="op">=</span> <span class="cn">true</span></span>
<span id="cb42-4"><a></a></span>
<span id="cb42-5"><a></a><span class="kw">[build]</span></span>
<span id="cb42-6"><a></a><span class="dt">target</span> <span class="op">=</span> <span class="st">"x86_64-osirs.json"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="target-file" class="slide level2">
<h2>Target File</h2>
<ul>
<li>All new, this is the nightly version.</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>x86_64-osirs.json</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb43" data-filename="x86_64-osirs.json"><pre class="sourceCode numberSource json number-lines code-with-copy"><code class="sourceCode json"><span id="cb43-1"><a></a><span class="fu">{</span></span>
<span id="cb43-2"><a></a>    <span class="dt">"llvm-target"</span><span class="fu">:</span> <span class="st">"x86_64-unknown-none"</span><span class="fu">,</span></span>
<span id="cb43-3"><a></a>    <span class="dt">"data-layout"</span><span class="fu">:</span> <span class="st">"e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-i128:128-f80:128-n8:16:32:64-S128"</span><span class="fu">,</span></span>
<span id="cb43-4"><a></a>    <span class="dt">"arch"</span><span class="fu">:</span> <span class="st">"x86_64"</span><span class="fu">,</span></span>
<span id="cb43-5"><a></a>    <span class="dt">"target-endian"</span><span class="fu">:</span> <span class="st">"little"</span><span class="fu">,</span></span>
<span id="cb43-6"><a></a>    <span class="dt">"target-pointer-width"</span><span class="fu">:</span> <span class="dv">64</span><span class="fu">,</span></span>
<span id="cb43-7"><a></a>    <span class="dt">"target-c-int-width"</span><span class="fu">:</span> <span class="dv">32</span><span class="fu">,</span></span>
<span id="cb43-8"><a></a>    <span class="dt">"os"</span><span class="fu">:</span> <span class="st">"none"</span><span class="fu">,</span></span>
<span id="cb43-9"><a></a>    <span class="dt">"executables"</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb43-10"><a></a>    <span class="dt">"linker-flavor"</span><span class="fu">:</span> <span class="st">"ld.lld"</span><span class="fu">,</span></span>
<span id="cb43-11"><a></a>    <span class="dt">"linker"</span><span class="fu">:</span> <span class="st">"rust-lld"</span><span class="fu">,</span></span>
<span id="cb43-12"><a></a>    <span class="dt">"panic-strategy"</span><span class="fu">:</span> <span class="st">"abort"</span><span class="fu">,</span></span>
<span id="cb43-13"><a></a>    <span class="dt">"disable-redzone"</span><span class="fu">:</span> <span class="kw">true</span></span>
<span id="cb43-14"><a></a><span class="fu">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="cargo-file" class="slide level2">
<h2>Cargo File</h2>
<ul>
<li>Move panic specification to target.</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Cargo.toml</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb44" data-filename="Cargo.toml"><pre class="sourceCode numberSource toml number-lines code-with-copy"><code class="sourceCode toml"><span id="cb44-1"><a></a><span class="kw">[package]</span></span>
<span id="cb44-2"><a></a><span class="dt">name</span> <span class="op">=</span> <span class="st">"osirs"</span></span>
<span id="cb44-3"><a></a><span class="dt">version</span> <span class="op">=</span> <span class="st">"0.1.0"</span></span>
<span id="cb44-4"><a></a><span class="dt">edition</span> <span class="op">=</span> <span class="st">"2024"</span></span>
<span id="cb44-5"><a></a></span>
<span id="cb44-6"><a></a><span class="kw">[dependencies]</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>


</section></section>
    </div>
  <div class="quarto-auto-generated-content" style="display: none;">
<div class="footer footer-default">
<p><a href="index.html">Home</a></p>
</div>
</div></div>

  <script>window.backupDefine = window.define; window.define = undefined;</script>
  <script src="site_libs/revealjs/dist/reveal.js"></script>
  <!-- reveal.js plugins -->
  <script src="site_libs/revealjs/plugin/quarto-line-highlight/line-highlight.js"></script>
  <script src="site_libs/revealjs/plugin/pdf-export/pdfexport.js"></script>
  <script src="site_libs/revealjs/plugin/reveal-menu/menu.js"></script>
  <script src="site_libs/revealjs/plugin/reveal-menu/quarto-menu.js"></script>
  <script src="site_libs/revealjs/plugin/quarto-support/support.js"></script>
  

  <script src="site_libs/revealjs/plugin/notes/notes.js"></script>
  <script src="site_libs/revealjs/plugin/search/search.js"></script>
  <script src="site_libs/revealjs/plugin/zoom/zoom.js"></script>
  <script src="site_libs/revealjs/plugin/math/math.js"></script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script>

  <script>

      // Full list of configuration options available at:
      // https://revealjs.com/config/
      Reveal.initialize({
'controlsAuto': true,
'previewLinksAuto': false,
'pdfSeparateFragments': false,
'autoAnimateEasing': "ease",
'autoAnimateDuration': 1,
'autoAnimateUnmatched': true,
'jumpToSlide': true,
'menu': {"side":"left","useTextContentForMissingTitles":true,"markers":false,"loadIcons":false,"custom":[{"title":"Tools","icon":"<i class=\"fas fa-gear\"></i>","content":"<ul class=\"slide-menu-items\">\n<li class=\"slide-tool-item active\" data-item=\"0\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.fullscreen(event)\"><kbd>f</kbd> Fullscreen</a></li>\n<li class=\"slide-tool-item\" data-item=\"1\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.speakerMode(event)\"><kbd>s</kbd> Speaker View</a></li>\n<li class=\"slide-tool-item\" data-item=\"2\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.overview(event)\"><kbd>o</kbd> Slide Overview</a></li>\n<li class=\"slide-tool-item\" data-item=\"3\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.togglePdfExport(event)\"><kbd>e</kbd> PDF Export Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"4\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleScrollView(event)\"><kbd>r</kbd> Scroll View Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"5\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.keyboardHelp(event)\"><kbd>?</kbd> Keyboard Help</a></li>\n</ul>"}],"openButton":true},
'smaller': false,
 
        // Display controls in the bottom right corner
        controls: false,

        // Help the user learn the controls by providing hints, for example by
        // bouncing the down arrow when they first encounter a vertical slide
        controlsTutorial: false,

        // Determines where controls appear, "edges" or "bottom-right"
        controlsLayout: 'edges',

        // Visibility rule for backwards navigation arrows; "faded", "hidden"
        // or "visible"
        controlsBackArrows: 'faded',

        // Display a presentation progress bar
        progress: true,

        // Display the page number of the current slide
        slideNumber: 'c/t',

        // 'all', 'print', or 'speaker'
        showSlideNumber: 'all',

        // Add the current slide number to the URL hash so that reloading the
        // page/copying the URL will return you to the same slide
        hash: true,

        // Start with 1 for the hash rather than 0
        hashOneBasedIndex: false,

        // Flags if we should monitor the hash and change slides accordingly
        respondToHashChanges: true,

        // Push each slide change to the browser history
        history: true,

        // Enable keyboard shortcuts for navigation
        keyboard: true,

        // Enable the slide overview mode
        overview: true,

        // Disables the default reveal.js slide layout (scaling and centering)
        // so that you can use custom CSS layout
        disableLayout: false,

        // Vertical centering of slides
        center: false,

        // Enables touch navigation on devices with touch input
        touch: true,

        // Loop the presentation
        loop: false,

        // Change the presentation direction to be RTL
        rtl: false,

        // see https://revealjs.com/vertical-slides/#navigation-mode
        navigationMode: 'linear',

        // Randomizes the order of slides each time the presentation loads
        shuffle: false,

        // Turns fragments on and off globally
        fragments: true,

        // Flags whether to include the current fragment in the URL,
        // so that reloading brings you to the same fragment position
        fragmentInURL: false,

        // Flags if the presentation is running in an embedded mode,
        // i.e. contained within a limited portion of the screen
        embedded: false,

        // Flags if we should show a help overlay when the questionmark
        // key is pressed
        help: true,

        // Flags if it should be possible to pause the presentation (blackout)
        pause: true,

        // Flags if speaker notes should be visible to all viewers
        showNotes: false,

        // Global override for autoplaying embedded media (null/true/false)
        autoPlayMedia: null,

        // Global override for preloading lazy-loaded iframes (null/true/false)
        preloadIframes: null,

        // Number of milliseconds between automatically proceeding to the
        // next slide, disabled when set to 0, this value can be overwritten
        // by using a data-autoslide attribute on your slides
        autoSlide: 0,

        // Stop auto-sliding after user input
        autoSlideStoppable: true,

        // Use this method for navigation when auto-sliding
        autoSlideMethod: null,

        // Specify the average time in seconds that you think you will spend
        // presenting each slide. This is used to show a pacing timer in the
        // speaker view
        defaultTiming: null,

        // Enable slide navigation via mouse wheel
        mouseWheel: false,

        // The display mode that will be used to show slides
        display: 'block',

        // Hide cursor if inactive
        hideInactiveCursor: true,

        // Time before the cursor is hidden (in ms)
        hideCursorTime: 5000,

        // Opens links in an iframe preview overlay
        previewLinks: false,

        // Transition style (none/fade/slide/convex/concave/zoom)
        transition: 'none',

        // Transition speed (default/fast/slow)
        transitionSpeed: 'default',

        // Transition style for full page slide backgrounds
        // (none/fade/slide/convex/concave/zoom)
        backgroundTransition: 'none',

        // Number of slides away from the current that are visible
        viewDistance: 3,

        // Number of slides away from the current that are visible on mobile
        // devices. It is advisable to set this to a lower number than
        // viewDistance in order to save resources.
        mobileViewDistance: 2,

        // The "normal" size of the presentation, aspect ratio will be preserved
        // when the presentation is scaled to fit different resolutions. Can be
        // specified using percentage units.
        width: 1050,

        height: 700,

        // Factor of the display size that should remain empty around the content
        margin: 0.1,

        math: {
          mathjax: 'https://cdn.jsdelivr.net/npm/mathjax@2.7.9/MathJax.js',
          config: 'TeX-AMS_HTML-full',
          tex2jax: {
            inlineMath: [['\\(','\\)']],
            displayMath: [['\\[','\\]']],
            balanceBraces: true,
            processEscapes: false,
            processRefs: true,
            processEnvironments: true,
            preview: 'TeX',
            skipTags: ['script','noscript','style','textarea','pre','code'],
            ignoreClass: 'tex2jax_ignore',
            processClass: 'tex2jax_process'
          },
        },

        // reveal.js plugins
        plugins: [QuartoLineHighlight, PdfExport, RevealMenu, QuartoSupport,

          RevealMath,
          RevealNotes,
          RevealSearch,
          RevealZoom
        ]
      });
    </script>
    <script id="quarto-html-after-body" type="application/javascript">
      window.document.addEventListener("DOMContentLoaded", function (event) {
        const tabsets =  window.document.querySelectorAll(".panel-tabset-tabby")
        tabsets.forEach(function(tabset) {
          const tabby = new Tabby('#' + tabset.id);
        });
        const isCodeAnnotation = (el) => {
          for (const clz of el.classList) {
            if (clz.startsWith('code-annotation-')) {                     
              return true;
            }
          }
          return false;
        }
        const onCopySuccess = function(e) {
          // button target
          const button = e.trigger;
          // don't keep focus
          button.blur();
          // flash "checked"
          button.classList.add('code-copy-button-checked');
          var currentTitle = button.getAttribute("title");
          button.setAttribute("title", "Copied!");
          let tooltip;
          if (window.bootstrap) {
            button.setAttribute("data-bs-toggle", "tooltip");
            button.setAttribute("data-bs-placement", "left");
            button.setAttribute("data-bs-title", "Copied!");
            tooltip = new bootstrap.Tooltip(button, 
              { trigger: "manual", 
                customClass: "code-copy-button-tooltip",
                offset: [0, -8]});
            tooltip.show();    
          }
          setTimeout(function() {
            if (tooltip) {
              tooltip.hide();
              button.removeAttribute("data-bs-title");
              button.removeAttribute("data-bs-toggle");
              button.removeAttribute("data-bs-placement");
            }
            button.setAttribute("title", currentTitle);
            button.classList.remove('code-copy-button-checked');
          }, 1000);
          // clear code selection
          e.clearSelection();
        }
        const getTextToCopy = function(trigger) {
          const outerScaffold = trigger.parentElement.cloneNode(true);
          const codeEl = outerScaffold.querySelector('code');
          for (const childEl of codeEl.children) {
            if (isCodeAnnotation(childEl)) {
              childEl.remove();
            }
          }
          return codeEl.innerText;
        }
        const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
          text: getTextToCopy
        });
        clipboard.on('success', onCopySuccess);
        if (window.document.getElementById('quarto-embedded-source-code-modal')) {
          const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
            text: getTextToCopy,
            container: window.document.getElementById('quarto-embedded-source-code-modal')
          });
          clipboardModal.on('success', onCopySuccess);
        }
          var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
          var mailtoRegex = new RegExp(/^mailto:/);
            var filterRegex = new RegExp('/' + window.location.host + '/');
          var isInternal = (href) => {
              return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
          }
          // Inspect non-navigation links and adorn them if external
         var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
          for (var i=0; i<links.length; i++) {
            const link = links[i];
            if (!isInternal(link.href)) {
              // undo the damage that might have been done by quarto-nav.js in the case of
              // links that we want to consider external
              if (link.dataset.originalHref !== undefined) {
                link.href = link.dataset.originalHref;
              }
            }
          }
        function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
          const config = {
            allowHTML: true,
            maxWidth: 500,
            delay: 100,
            arrow: false,
            appendTo: function(el) {
                return el.closest('section.slide') || el.parentElement;
            },
            interactive: true,
            interactiveBorder: 10,
            theme: 'light-border',
            placement: 'bottom-start',
          };
          if (contentFn) {
            config.content = contentFn;
          }
          if (onTriggerFn) {
            config.onTrigger = onTriggerFn;
          }
          if (onUntriggerFn) {
            config.onUntrigger = onUntriggerFn;
          }
            config['offset'] = [0,0];
            config['maxWidth'] = 700;
          window.tippy(el, config); 
        }
        const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
        for (var i=0; i<noterefs.length; i++) {
          const ref = noterefs[i];
          tippyHover(ref, function() {
            // use id or data attribute instead here
            let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
            try { href = new URL(href).hash; } catch {}
            const id = href.replace(/^#\/?/, "");
            const note = window.document.getElementById(id);
            if (note) {
              return note.innerHTML;
            } else {
              return "";
            }
          });
        }
        const findCites = (el) => {
          const parentEl = el.parentElement;
          if (parentEl) {
            const cites = parentEl.dataset.cites;
            if (cites) {
              return {
                el,
                cites: cites.split(' ')
              };
            } else {
              return findCites(el.parentElement)
            }
          } else {
            return undefined;
          }
        };
        var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
        for (var i=0; i<bibliorefs.length; i++) {
          const ref = bibliorefs[i];
          const citeInfo = findCites(ref);
          if (citeInfo) {
            tippyHover(citeInfo.el, function() {
              var popup = window.document.createElement('div');
              citeInfo.cites.forEach(function(cite) {
                var citeDiv = window.document.createElement('div');
                citeDiv.classList.add('hanging-indent');
                citeDiv.classList.add('csl-entry');
                var biblioDiv = window.document.getElementById('ref-' + cite);
                if (biblioDiv) {
                  citeDiv.innerHTML = biblioDiv.innerHTML;
                }
                popup.appendChild(citeDiv);
              });
              return popup.innerHTML;
            });
          }
        }
      });
      </script>
    

</body></html>