<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Unsafe – OS in Rust</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./12_split_at.html" rel="next">
<link href="./02_cli.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-707d8167ce6003fca903bfe2be84ab7f.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-40a160e28a8c0a8ad2fc184c8ba4238c.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./11_unsafe.html">Unsafe</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
      <a href="./index.html" class="sidebar-logo-link">
      </a>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./00_derust.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Derust</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_wc.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">wc</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_cli.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">CLI</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11_unsafe.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Unsafe</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12_split_at.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Splits</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./20_os.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">OS</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./21_xmute.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Transmute</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#announcements" id="toc-announcements" class="nav-link active" data-scroll-target="#announcements">Announcements</a></li>
  <li><a href="#today" id="toc-today" class="nav-link" data-scroll-target="#today">Today</a></li>
  <li><a href="#unsafe" id="toc-unsafe" class="nav-link" data-scroll-target="#unsafe">Unsafe</a>
  <ul class="collapse">
  <li><a href="#the-dark-arts-of-unsafe-rust" id="toc-the-dark-arts-of-unsafe-rust" class="nav-link" data-scroll-target="#the-dark-arts-of-unsafe-rust">The Dark Arts of Unsafe Rust</a></li>
  <li><a href="#motivation" id="toc-motivation" class="nav-link" data-scroll-target="#motivation">Motivation</a></li>
  <li><a href="#sometimes-it-matters" id="toc-sometimes-it-matters" class="nav-link" data-scroll-target="#sometimes-it-matters">Sometimes it matters…</a></li>
  <li><a href="#legacy" id="toc-legacy" class="nav-link" data-scroll-target="#legacy">Legacy</a></li>
  <li><a href="#rust-on-c" id="toc-rust-on-c" class="nav-link" data-scroll-target="#rust-on-c">Rust on C</a></li>
  <li><a href="#both-and" id="toc-both-and" class="nav-link" data-scroll-target="#both-and">Both, and</a></li>
  <li><a href="#safe-rust" id="toc-safe-rust" class="nav-link" data-scroll-target="#safe-rust">Safe Rust</a></li>
  <li><a href="#unsafe-rust" id="toc-unsafe-rust" class="nav-link" data-scroll-target="#unsafe-rust">Unsafe Rust</a></li>
  <li><a href="#warning" id="toc-warning" class="nav-link" data-scroll-target="#warning">Warning</a></li>
  <li><a href="#true-rust" id="toc-true-rust" class="nav-link" data-scroll-target="#true-rust">True Rust</a></li>
  <li><a href="#std" id="toc-std" class="nav-link" data-scroll-target="#std"><code>std</code></a></li>
  <li><a href="#twinsies" id="toc-twinsies" class="nav-link" data-scroll-target="#twinsies">Twinsies</a></li>
  <li><a href="#payoffs" id="toc-payoffs" class="nav-link" data-scroll-target="#payoffs">Payoffs</a></li>
  </ul></li>
  <li><a href="#undefined-behavior" id="toc-undefined-behavior" class="nav-link" data-scroll-target="#undefined-behavior">Undefined Behavior</a>
  <ul class="collapse">
  <li><a href="#safe-rust-1" id="toc-safe-rust-1" class="nav-link" data-scroll-target="#safe-rust-1">Safe Rust</a></li>
  <li><a href="#safe-prevents" id="toc-safe-prevents" class="nav-link" data-scroll-target="#safe-prevents">Safe Prevents</a></li>
  <li><a href="#safe-allows" id="toc-safe-allows" class="nav-link" data-scroll-target="#safe-allows">Safe Allows</a></li>
  <li><a href="#unsafe-allows" id="toc-unsafe-allows" class="nav-link" data-scroll-target="#unsafe-allows">Unsafe allows:</a></li>
  <li><a href="#simply" id="toc-simply" class="nav-link" data-scroll-target="#simply">Simply…</a></li>
  <li><a href="#unions" id="toc-unions" class="nav-link" data-scroll-target="#unions">Unions</a></li>
  <li><a href="#dangling" id="toc-dangling" class="nav-link" data-scroll-target="#dangling">Dangling</a></li>
  <li><a href="#the-reference" id="toc-the-reference" class="nav-link" data-scroll-target="#the-reference">The Reference</a></li>
  </ul></li>
  <li><a href="#dangling-1" id="toc-dangling-1" class="nav-link" data-scroll-target="#dangling-1">Dangling</a>
  <ul class="collapse">
  <li><a href="#previously-in-rust" id="toc-previously-in-rust" class="nav-link" data-scroll-target="#previously-in-rust">Previously in Rust</a></li>
  <li><a href="#the-frontier" id="toc-the-frontier" class="nav-link" data-scroll-target="#the-frontier">The Frontier</a></li>
  <li><a href="#differences" id="toc-differences" class="nav-link" data-scroll-target="#differences">Differences</a></li>
  <li><a href="#example" id="toc-example" class="nav-link" data-scroll-target="#example">Example</a></li>
  <li><a href="#this-is-safe" id="toc-this-is-safe" class="nav-link" data-scroll-target="#this-is-safe">This is safe!</a></li>
  <li><a href="#casts" id="toc-casts" class="nav-link" data-scroll-target="#casts">Casts</a></li>
  <li><a href="#dereference" id="toc-dereference" class="nav-link" data-scroll-target="#dereference">Dereference</a></li>
  <li><a href="#runtime-crash" id="toc-runtime-crash" class="nav-link" data-scroll-target="#runtime-crash">Runtime Crash</a></li>
  </ul></li>
  <li><a href="#fin" id="toc-fin" class="nav-link" data-scroll-target="#fin">Fin</a>
  <ul class="collapse">
  <li><a href="#announcements-1" id="toc-announcements-1" class="nav-link" data-scroll-target="#announcements-1">Announcements</a></li>
  </ul></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="11_unsafe.rjs.html"><i class="bi bi-file-slides"></i>RevealJS</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Unsafe</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i></button></div></div>
<p class="subtitle lead">OS in Rust</p>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="announcements" class="level2">
<h2 class="anchored" data-anchor-id="announcements">Announcements</h2>
<ul>
<li><strong>Welcome</strong> to OS in Rust</li>
<li><strong>Action Items</strong>:
<ul>
<li><code>wc</code> ongoing.</li>
<li>Due Friday, 5 Sept.&nbsp;at 1440 PT.</li>
<li>Just a quick demo for HW this week, check it out whenever.</li>
</ul></li>
</ul>
</section>
<section id="today" class="level2">
<h2 class="anchored" data-anchor-id="today">Today</h2>
<ul>
<li>Unsafe</li>
<li>UB</li>
<li>Dereferencing</li>
</ul>
</section>
<section id="unsafe" class="level1">
<h1>Unsafe</h1>
<section id="the-dark-arts-of-unsafe-rust" class="level2">
<h2 class="anchored" data-anchor-id="the-dark-arts-of-unsafe-rust">The Dark Arts of Unsafe Rust</h2>
<blockquote class="blockquote">
<p>THE KNOWLEDGE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF UNLEASHING INDESCRIBABLE HORRORS THAT SHATTER YOUR PSYCHE AND SET YOUR MIND ADRIFT IN THE UNKNOWABLY INFINITE COSMOS.</p>
</blockquote>
</section>
<section id="motivation" class="level2">
<h2 class="anchored" data-anchor-id="motivation">Motivation</h2>
<ul>
<li>Often we don’t worry about low-level implementation details.
<ul>
<li>How many bits is an integer in Python?</li>
<li>How many bits is this array in Rust?</li>
</ul></li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw">let</span> <span class="kw">mut</span> array<span class="op">:</span> [<span class="dt">i32</span><span class="op">;</span> <span class="dv">3</span>] <span class="op">=</span> [<span class="dv">0</span><span class="op">;</span> <span class="dv">3</span>]<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li>Who could possibly care how much space the empty tuple occupies?</li>
</ul>
</section>
<section id="sometimes-it-matters" class="level2">
<h2 class="anchored" data-anchor-id="sometimes-it-matters">Sometimes it matters…</h2>
<ul>
<li>The most common reason is performance, but</li>
<li>More importantly, these details can become a matter of correctness when interfacing directly with
<ul>
<li>hardware,</li>
<li>operating systems, or</li>
<li>other languages (by which we mean C)</li>
</ul></li>
</ul>
</section>
<section id="legacy" class="level2">
<h2 class="anchored" data-anchor-id="legacy">Legacy</h2>
<p>When implementation details start to matter in a safe programming language, programmers usually have three options:</p>
<ul>
<li>fiddle with the code to “encourage” the compiler/runtime to perform an optimization</li>
<li>adopt a more unidiomatic or cumbersome design to get the desired implementation</li>
<li>rewrite the implementation in a language that lets you deal with those details</li>
</ul>
</section>
<section id="rust-on-c" class="level2">
<h2 class="anchored" data-anchor-id="rust-on-c">Rust on C</h2>
<blockquote class="blockquote">
<p>Unfortunately, C is incredibly unsafe to use (sometimes for good reason), and this unsafety is magnified when trying to interoperate with another language. Care must be taken to ensure C and the other language agree on what’s happening, and that they don’t step on each other’s toes.</p>
</blockquote>
</section>
<section id="both-and" class="level2">
<h2 class="anchored" data-anchor-id="both-and">Both, and</h2>
<ul>
<li>So what does this have to do with Rust?
<ul>
<li>Well, unlike C, Rust is a safe programming language.</li>
<li>But, like C, Rust is an unsafe programming language.</li>
</ul></li>
<li>More accurately, Rust <em>contains</em> both a safe and unsafe programming language.</li>
</ul>
<blockquote class="blockquote">
<p>Rust can be thought of as a combination of two programming languages: <em>Safe Rust</em> and <em>Unsafe Rust</em>.</p>
</blockquote>
</section>
<section id="safe-rust" class="level2">
<h2 class="anchored" data-anchor-id="safe-rust">Safe Rust</h2>
<ul>
<li>The default case</li>
<li>What we’ve used to far, at least officially
<ul>
<li>You may have incidentally dabbled in unsafe.</li>
<li>Good for you.</li>
</ul></li>
<li>Safe Rust only really makes <em>one</em> guarantee.</li>
</ul>
<blockquote class="blockquote">
<p>Rust’s memory safety guarantees enforced at compile time</p>
</blockquote>
<ul>
<li>That is, you can never try to read something that doesn’t exist.</li>
</ul>
</section>
<section id="unsafe-rust" class="level2">
<h2 class="anchored" data-anchor-id="unsafe-rust">Unsafe Rust</h2>
<ul>
<li>Sometimes, you may want to have two reference to an object that are both mutable.
<ul>
<li>For example, if you are implementing a suffix tree, a task I didn’t assign last term because it was <em>miserable</em> in safe Rust.</li>
</ul></li>
<li>Sometimes, you want to do so in a way that can’t possibly break anything.
<ul>
<li>For example, you may only be using provably correct algorithms (whatever that means).</li>
<li>But of course, <code>rustc</code> isn’t a theorem prover…</li>
</ul></li>
</ul>
</section>
<section id="warning" class="level2">
<h2 class="anchored" data-anchor-id="warning">Warning</h2>
<blockquote class="blockquote">
<p>Unsafe Rust is, well, not (safe). In fact, Unsafe Rust lets us do some <em>really</em> unsafe things. Things the Rust authors will implore you not to do, but we’ll do anyway.</p>
</blockquote>
</section>
<section id="true-rust" class="level2">
<h2 class="anchored" data-anchor-id="true-rust">True Rust</h2>
<ul>
<li>Safe Rust is the <em>true</em> Rust programming language.</li>
<li>If all you do is write Safe Rust, you will never have to worry about type-safety or memory-safety.</li>
<li>You will never endure
<ul>
<li>a dangling pointer,</li>
<li>a use-after-free, or</li>
<li>any other kind of Undefined Behavior (a.k.a. UB).</li>
</ul></li>
</ul>
</section>
<section id="std" class="level2">
<h2 class="anchored" data-anchor-id="std"><code>std</code></h2>
<ul>
<li>The standard library also gives you enough utilities out of the box that you’ll be able to write high-performance applications and libraries in pure idiomatic Safe Rust.</li>
<li>Assuming, of course, you are working on a system where <code>std</code> is already implemented.</li>
<li>Not, you know, writing your own OS or own <code>std</code>.</li>
</ul>
</section>
<section id="twinsies" class="level2">
<h2 class="anchored" data-anchor-id="twinsies">Twinsies</h2>
<ul>
<li>Unsafe Rust is exactly like Safe Rust with all the same rules and semantics.</li>
<li>It just lets you do some <em>extra</em> things that are Definitely Not Safe.</li>
</ul>
</section>
<section id="payoffs" class="level2">
<h2 class="anchored" data-anchor-id="payoffs">Payoffs</h2>
<ul>
<li>The value of this separation is that we gain the benefits of using an unsafe language like C
<ul>
<li>low level control over implementation details</li>
</ul></li>
<li>…without most (citation needed) of the problems that come with trying to integrate it with a completely different safe language.</li>
</ul>
</section>
</section>
<section id="undefined-behavior" class="level1">
<h1>Undefined Behavior</h1>
<section id="safe-rust-1" class="level2">
<h2 class="anchored" data-anchor-id="safe-rust-1">Safe Rust</h2>
<ul>
<li>Safe Rust guarantees certain things about your code.
<ul>
<li>Most of these won’t even make sense to you unless you write C</li>
</ul></li>
</ul>
</section>
<section id="safe-prevents" class="level2">
<h2 class="anchored" data-anchor-id="safe-prevents">Safe Prevents</h2>
<ul>
<li>Dereferencing (using the <code>*</code> operator on) dangling or unaligned pointers (see below)</li>
<li>Breaking the “pointer aliasing rules” using <code>&amp;</code> (borrow) and <code>mut</code></li>
<li>Calling a function with the wrong call types</li>
<li>Causing a data race when multithreading</li>
<li>Executing code compiled for hardware other than currently hosting the process not support</li>
<li>Producing invalid values like something other than <code>0</code> or <code>1</code> for a boolean.</li>
</ul>
</section>
<section id="safe-allows" class="level2">
<h2 class="anchored" data-anchor-id="safe-allows">Safe Allows</h2>
<ul>
<li>Deadlocks when multithreading</li>
<li>Leaks of memory and other resources</li>
<li>Exiting without calling destructors</li>
<li>Exposing randomized base addresses through pointer leaks</li>
<li>Integer overflow (recall SHA wrapping)</li>
<li>Logic errors</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb2-1"><a href="#cb2-1"></a><span class="kw">let</span> val <span class="op">=</span> <span class="dv">7</span><span class="op">;</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="kw">let</span> val_is_even <span class="op">=</span> <span class="cf">if</span> val <span class="op">%</span> <span class="dv">2</span> <span class="op">==</span> <span class="dv">1</span> <span class="op">{</span> <span class="cn">true</span> <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span> <span class="cn">false</span> <span class="op">};</span> </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="unsafe-allows" class="level2">
<h2 class="anchored" data-anchor-id="unsafe-allows">Unsafe allows:</h2>
<ol type="1">
<li>Dereference a raw pointer.</li>
<li>Call an unsafe function or method.</li>
<li>Access or modify a mutable static variable.</li>
<li>Implement an unsafe trait.</li>
<li>Access fields of <code>union</code>s.</li>
</ol>
</section>
<section id="simply" class="level2">
<h2 class="anchored" data-anchor-id="simply">Simply…</h2>
<ol type="1">
<li>Write Rust code normally.</li>
<li>If you are doing something unsafe, include it in an <code>unsafe</code> block.</li>
</ol>
</section>
<section id="unions" class="level2">
<h2 class="anchored" data-anchor-id="unions">Unions</h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb3-1"><a href="#cb3-1"></a><span class="kw">union</span> MyUnion <span class="op">{</span></span>
<span id="cb3-2"><a href="#cb3-2"></a>    f<span class="op">:</span> <span class="dt">f32</span><span class="op">,</span></span>
<span id="cb3-3"><a href="#cb3-3"></a>    u<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="op">}</span></span>
<span id="cb3-5"><a href="#cb3-5"></a></span>
<span id="cb3-6"><a href="#cb3-6"></a><span class="kw">fn</span> main() <span class="op">{</span></span>
<span id="cb3-7"><a href="#cb3-7"></a>    <span class="kw">let</span> <span class="kw">mut</span> u <span class="op">=</span> MyUnion <span class="op">{</span> f<span class="op">:</span> <span class="dv">0.0</span> <span class="op">};</span></span>
<span id="cb3-8"><a href="#cb3-8"></a></span>
<span id="cb3-9"><a href="#cb3-9"></a>    <span class="kw">unsafe</span> <span class="op">{</span></span>
<span id="cb3-10"><a href="#cb3-10"></a>        <span class="pp">println!</span>(<span class="st">"Bits as float: {}"</span><span class="op">,</span> u<span class="op">.</span>f)<span class="op">;</span></span>
<span id="cb3-11"><a href="#cb3-11"></a>        <span class="pp">println!</span>(<span class="st">"Bits as integer: {:#x}"</span><span class="op">,</span> u<span class="op">.</span>u)<span class="op">;</span></span>
<span id="cb3-12"><a href="#cb3-12"></a>    <span class="op">}</span></span>
<span id="cb3-13"><a href="#cb3-13"></a></span>
<span id="cb3-14"><a href="#cb3-14"></a>    u<span class="op">.</span>u <span class="op">=</span> <span class="dv">0x3F800000</span><span class="op">;</span> <span class="co">// This is the bit pattern for 1.0 in IEEE 754</span></span>
<span id="cb3-15"><a href="#cb3-15"></a></span>
<span id="cb3-16"><a href="#cb3-16"></a>    <span class="kw">unsafe</span> <span class="op">{</span></span>
<span id="cb3-17"><a href="#cb3-17"></a>        <span class="pp">println!</span>(<span class="st">"After manual bit update, float is: {}"</span><span class="op">,</span> u<span class="op">.</span>f)<span class="op">;</span></span>
<span id="cb3-18"><a href="#cb3-18"></a>    <span class="op">}</span></span>
<span id="cb3-19"><a href="#cb3-19"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="dangling" class="level2">
<h2 class="anchored" data-anchor-id="dangling">Dangling</h2>
<ul>
<li>This worked fine for me, but technically isn’t supported.</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/main.rs</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" data-filename="src/main.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb4-1"><a href="#cb4-1"></a><span class="kw">fn</span> main() <span class="op">{</span>    </span>
<span id="cb4-2"><a href="#cb4-2"></a>    <span class="kw">let</span> ptr<span class="op">:</span> <span class="op">*</span><span class="kw">const</span> <span class="dt">i32</span><span class="op">;</span></span>
<span id="cb4-3"><a href="#cb4-3"></a></span>
<span id="cb4-4"><a href="#cb4-4"></a>    <span class="op">{</span></span>
<span id="cb4-5"><a href="#cb4-5"></a>        <span class="kw">let</span> x <span class="op">=</span> <span class="dv">1234</span><span class="op">;</span></span>
<span id="cb4-6"><a href="#cb4-6"></a>        ptr <span class="op">=</span> <span class="op">&amp;</span>x <span class="kw">as</span> <span class="op">*</span><span class="kw">const</span> <span class="dt">i32</span><span class="op">;</span></span>
<span id="cb4-7"><a href="#cb4-7"></a>        <span class="kw">unsafe</span> <span class="op">{</span></span>
<span id="cb4-8"><a href="#cb4-8"></a>            <span class="pp">println!</span>(<span class="st">"Value at ptr: {}"</span><span class="op">,</span> <span class="op">*</span>ptr)<span class="op">;</span></span>
<span id="cb4-9"><a href="#cb4-9"></a>        <span class="op">}</span></span>
<span id="cb4-10"><a href="#cb4-10"></a>    <span class="op">}</span></span>
<span id="cb4-11"><a href="#cb4-11"></a></span>
<span id="cb4-12"><a href="#cb4-12"></a>    <span class="kw">unsafe</span> <span class="op">{</span></span>
<span id="cb4-13"><a href="#cb4-13"></a>        <span class="pp">println!</span>(<span class="st">"Value at ptr: {}"</span><span class="op">,</span> <span class="op">*</span>ptr)<span class="op">;</span></span>
<span id="cb4-14"><a href="#cb4-14"></a>    <span class="op">}</span></span>
<span id="cb4-15"><a href="#cb4-15"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="the-reference" class="level2">
<h2 class="anchored" data-anchor-id="the-reference">The Reference</h2>
<ul>
<li>The reference is much more… verbose.</li>
<li>It’s <a href="https://doc.rust-lang.org/reference/behavior-considered-undefined.html">here</a></li>
</ul>
<blockquote class="blockquote">
<p>Breaking the pointer aliasing rules. The exact aliasing rules are not determined yet, but here is an outline of the general principles:</p>
</blockquote>
<blockquote class="blockquote">
<p>Violating assumptions of the Rust runtime. Most assumptions of the Rust runtime are currently not explicitly documented.</p>
</blockquote>
</section>
</section>
<section id="dangling-1" class="level1">
<h1>Dangling</h1>
<section id="previously-in-rust" class="level2">
<h2 class="anchored" data-anchor-id="previously-in-rust">Previously in Rust</h2>
<ul>
<li><em>Safe</em> Rust ensures that references are always valid
<ul>
<li>That is, borrows via <code>&amp;</code></li>
<li>These always have some plausible correct value in them (if the code compiles)</li>
</ul></li>
</ul>
</section>
<section id="the-frontier" class="level2">
<h2 class="anchored" data-anchor-id="the-frontier">The Frontier</h2>
<ul>
<li>At the edge of Safe and Unsafe Rust are <em>raw</em> pointers.
<ul>
<li>Can be immutable <code>*const T</code> or mutable <code>*mut T</code>.</li>
<li>Vs. C, the asterisk is part of the name and not an operator.
<ul>
<li>This is annoying.</li>
</ul></li>
</ul></li>
<li>Raw pointers are inherently unsafe, so they can be created in safe Rust.</li>
</ul>
</section>
<section id="differences" class="level2">
<h2 class="anchored" data-anchor-id="differences">Differences</h2>
<ul>
<li>These <em>raw</em> pointers:
<ul>
<li>Are allowed to ignore the borrowing rules by having both immutable and mutable pointers or multiple mutable pointers to the same location</li>
<li>Aren’t guaranteed to point to valid memory</li>
<li>Are allowed to be null</li>
<li>Don’t implement any automatic cleanup</li>
</ul></li>
</ul>
</section>
<section id="example" class="level2">
<h2 class="anchored" data-anchor-id="example">Example</h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb5-1"><a href="#cb5-1"></a>    <span class="kw">let</span> <span class="kw">mut</span> num <span class="op">=</span> <span class="dv">5</span><span class="op">;</span></span>
<span id="cb5-2"><a href="#cb5-2"></a></span>
<span id="cb5-3"><a href="#cb5-3"></a>    <span class="kw">let</span> r1 <span class="op">=</span> <span class="op">&amp;</span>raw <span class="kw">const</span> num<span class="op">;</span></span>
<span id="cb5-4"><a href="#cb5-4"></a>    <span class="kw">let</span> r2 <span class="op">=</span> <span class="op">&amp;</span>raw <span class="kw">mut</span> num<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="this-is-safe" class="level2">
<h2 class="anchored" data-anchor-id="this-is-safe">This is safe!</h2>
<ul>
<li>There is nothing unsafe and creating a variable that refers to some value.</li>
<li>After all, what’s the worst thing that can happen?</li>
<li>These lines of code only facilitate novel possible ways of interfacing with the underlying data.</li>
<li>In this case, we <em>know</em> these pointers are valid and point to 5.</li>
</ul>
</section>
<section id="casts" class="level2">
<h2 class="anchored" data-anchor-id="casts">Casts</h2>
<ul>
<li>We can get a potentially invalid reference using “casts” with the <code>as</code> keyword.
<ul>
<li>We take a numeric value and treat it as a reference.</li>
<li>This numerical value represents a location in numerical organized computer memory.</li>
</ul></li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb6-1"><a href="#cb6-1"></a>    <span class="kw">let</span> address <span class="op">=</span> <span class="dv">0x012345usize</span><span class="op">;</span></span>
<span id="cb6-2"><a href="#cb6-2"></a>    <span class="kw">let</span> r <span class="op">=</span> address <span class="kw">as</span> <span class="op">*</span><span class="kw">const</span> <span class="dt">i32</span><span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li>This is still safe so far!</li>
</ul>
</section>
<section id="dereference" class="level2">
<h2 class="anchored" data-anchor-id="dereference">Dereference</h2>
<ul>
<li>We now can use the dereference asterisk <code>*</code> operator.</li>
<li>This is decidedly unsafe.</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb7-1"><a href="#cb7-1"></a>    <span class="kw">let</span> <span class="kw">mut</span> num <span class="op">=</span> <span class="dv">5</span><span class="op">;</span></span>
<span id="cb7-2"><a href="#cb7-2"></a></span>
<span id="cb7-3"><a href="#cb7-3"></a>    <span class="kw">let</span> r1 <span class="op">=</span> <span class="op">&amp;</span>raw <span class="kw">const</span> num<span class="op">;</span></span>
<span id="cb7-4"><a href="#cb7-4"></a>    <span class="kw">let</span> r2 <span class="op">=</span> <span class="op">&amp;</span>raw <span class="kw">mut</span> num<span class="op">;</span></span>
<span id="cb7-5"><a href="#cb7-5"></a></span>
<span id="cb7-6"><a href="#cb7-6"></a>    <span class="kw">unsafe</span> <span class="op">{</span></span>
<span id="cb7-7"><a href="#cb7-7"></a>        <span class="pp">println!</span>(<span class="st">"r1 is: {}"</span><span class="op">,</span> <span class="op">*</span>r1)<span class="op">;</span></span>
<span id="cb7-8"><a href="#cb7-8"></a>        <span class="pp">println!</span>(<span class="st">"r2 is: {}"</span><span class="op">,</span> <span class="op">*</span>r2)<span class="op">;</span></span>
<span id="cb7-9"><a href="#cb7-9"></a>    <span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li>Unsafe <em>to Rust</em> but we know it will work.</li>
</ul>
</section>
<section id="runtime-crash" class="level2">
<h2 class="anchored" data-anchor-id="runtime-crash">Runtime Crash</h2>
<ul>
<li>This is both unsafe and (almost certainly) won’t work.</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/main.rs</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8" data-filename="src/main.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb8-1"><a href="#cb8-1"></a><span class="kw">fn</span> main() <span class="op">{</span></span>
<span id="cb8-2"><a href="#cb8-2"></a>    <span class="kw">let</span> address <span class="op">=</span> <span class="dv">0x0usize</span><span class="op">;</span></span>
<span id="cb8-3"><a href="#cb8-3"></a>    <span class="kw">let</span> r <span class="op">=</span> address <span class="kw">as</span> <span class="op">*</span><span class="kw">const</span> <span class="dt">i32</span><span class="op">;</span></span>
<span id="cb8-4"><a href="#cb8-4"></a>    <span class="kw">unsafe</span> <span class="op">{</span></span>
<span id="cb8-5"><a href="#cb8-5"></a>        <span class="pp">dbg!</span>(<span class="op">*</span>r)<span class="op">;</span></span>
<span id="cb8-6"><a href="#cb8-6"></a>    <span class="op">}</span></span>
<span id="cb8-7"><a href="#cb8-7"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<ul>
<li>Fun exercise: try to take the deferences out of the <code>unsafe</code> block.</li>
</ul>
</section>
</section>
<section id="fin" class="level1">
<h1>Fin</h1>
<section id="announcements-1" class="level2">
<h2 class="anchored" data-anchor-id="announcements-1">Announcements</h2>
<ul>
<li><strong>Action Items</strong>:
<ul>
<li><code>wc</code> ongoing.</li>
<li>Due Friday, 5 Sept.&nbsp;at 1440 PT.</li>
<li>Just a quick demo for HW this week, check it out whenever.</li>
</ul></li>
</ul>


<!-- -->

</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./02_cli.html" class="pagination-link" aria-label="CLI">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">CLI</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./12_split_at.html" class="pagination-link" aria-label="Splits">
        <span class="nav-page-text">Splits</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9" data-shortcodes="false"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb9-1"><a href="#cb9-1"></a><span class="co">---</span></span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="an">title:</span><span class="co"> Unsafe</span></span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="co">---</span></span>
<span id="cb9-4"><a href="#cb9-4"></a></span>
<span id="cb9-5"><a href="#cb9-5"></a><span class="fu">## Announcements</span></span>
<span id="cb9-6"><a href="#cb9-6"></a></span>
<span id="cb9-7"><a href="#cb9-7"></a><span class="ss">- </span>**Welcome** to OS in Rust</span>
<span id="cb9-8"><a href="#cb9-8"></a><span class="ss">- </span>**Action Items**:</span>
<span id="cb9-9"><a href="#cb9-9"></a><span class="ss">  - </span><span class="in">`wc`</span> ongoing.</span>
<span id="cb9-10"><a href="#cb9-10"></a><span class="ss">  - </span>Due Friday, 5 Sept. at 1440 PT.</span>
<span id="cb9-11"><a href="#cb9-11"></a><span class="ss">  - </span>Just a quick demo for HW this week, check it out whenever.</span>
<span id="cb9-12"><a href="#cb9-12"></a></span>
<span id="cb9-13"><a href="#cb9-13"></a><span class="fu">## Today</span></span>
<span id="cb9-14"><a href="#cb9-14"></a></span>
<span id="cb9-15"><a href="#cb9-15"></a><span class="ss">- </span>Unsafe</span>
<span id="cb9-16"><a href="#cb9-16"></a><span class="ss">- </span>UB</span>
<span id="cb9-17"><a href="#cb9-17"></a><span class="ss">- </span>Dereferencing</span>
<span id="cb9-18"><a href="#cb9-18"></a></span>
<span id="cb9-19"><a href="#cb9-19"></a><span class="fu"># Unsafe</span></span>
<span id="cb9-20"><a href="#cb9-20"></a></span>
<span id="cb9-21"><a href="#cb9-21"></a><span class="fu">## The Dark Arts of Unsafe Rust</span></span>
<span id="cb9-22"><a href="#cb9-22"></a></span>
<span id="cb9-23"><a href="#cb9-23"></a><span class="at">&gt; THE KNOWLEDGE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF UNLEASHING INDESCRIBABLE HORRORS THAT SHATTER YOUR PSYCHE AND SET YOUR MIND ADRIFT IN THE UNKNOWABLY INFINITE COSMOS.</span></span>
<span id="cb9-24"><a href="#cb9-24"></a></span>
<span id="cb9-25"><a href="#cb9-25"></a><span class="fu">## Motivation</span></span>
<span id="cb9-26"><a href="#cb9-26"></a></span>
<span id="cb9-27"><a href="#cb9-27"></a><span class="ss">- </span>Often we don't worry about low-level implementation details.</span>
<span id="cb9-28"><a href="#cb9-28"></a><span class="ss">    - </span>How many bits is an integer in Python?</span>
<span id="cb9-29"><a href="#cb9-29"></a><span class="ss">    - </span>How many bits is this array in Rust?</span>
<span id="cb9-30"><a href="#cb9-30"></a></span>
<span id="cb9-31"><a href="#cb9-31"></a><span class="in">```{.rs}</span></span>
<span id="cb9-32"><a href="#cb9-32"></a>let mut array<span class="sc">:</span> [i32; <span class="dv">3</span>] <span class="ot">=</span> [<span class="dv">0</span>; <span class="dv">3</span>];</span>
<span id="cb9-33"><a href="#cb9-33"></a><span class="in">```</span> </span>
<span id="cb9-34"><a href="#cb9-34"></a><span class="ss">- </span>Who could possibly care how much space the empty tuple occupies? </span>
<span id="cb9-35"><a href="#cb9-35"></a></span>
<span id="cb9-36"><a href="#cb9-36"></a><span class="fu">## Sometimes it matters...</span></span>
<span id="cb9-37"><a href="#cb9-37"></a></span>
<span id="cb9-38"><a href="#cb9-38"></a><span class="ss">- </span>The most common reason is performance, but </span>
<span id="cb9-39"><a href="#cb9-39"></a><span class="ss">- </span>More importantly, these details can become a matter of correctness when interfacing</span>
<span id="cb9-40"><a href="#cb9-40"></a>directly with </span>
<span id="cb9-41"><a href="#cb9-41"></a><span class="ss">    - </span>hardware, </span>
<span id="cb9-42"><a href="#cb9-42"></a><span class="ss">    - </span>operating systems, or </span>
<span id="cb9-43"><a href="#cb9-43"></a><span class="ss">    - </span>other languages (by which we mean C)</span>
<span id="cb9-44"><a href="#cb9-44"></a></span>
<span id="cb9-45"><a href="#cb9-45"></a><span class="fu">## Legacy</span></span>
<span id="cb9-46"><a href="#cb9-46"></a></span>
<span id="cb9-47"><a href="#cb9-47"></a>When implementation details start to matter in a safe programming language,</span>
<span id="cb9-48"><a href="#cb9-48"></a>programmers usually have three options:</span>
<span id="cb9-49"><a href="#cb9-49"></a></span>
<span id="cb9-50"><a href="#cb9-50"></a><span class="ss">* </span>fiddle with the code to "encourage" the compiler/runtime to perform an optimization</span>
<span id="cb9-51"><a href="#cb9-51"></a><span class="ss">* </span>adopt a more unidiomatic or cumbersome design to get the desired implementation</span>
<span id="cb9-52"><a href="#cb9-52"></a><span class="ss">* </span>rewrite the implementation in a language  that lets you deal with those details</span>
<span id="cb9-53"><a href="#cb9-53"></a></span>
<span id="cb9-54"><a href="#cb9-54"></a><span class="fu">## Rust on C</span></span>
<span id="cb9-55"><a href="#cb9-55"></a></span>
<span id="cb9-56"><a href="#cb9-56"></a><span class="at">&gt; Unfortunately, C is incredibly unsafe to use (sometimes for good reason),</span></span>
<span id="cb9-57"><a href="#cb9-57"></a><span class="at">and this unsafety is magnified when trying to interoperate with another</span></span>
<span id="cb9-58"><a href="#cb9-58"></a><span class="at">language. Care must be taken to ensure C and the other language agree on</span></span>
<span id="cb9-59"><a href="#cb9-59"></a><span class="at">what's happening, and that they don't step on each other's toes.</span></span>
<span id="cb9-60"><a href="#cb9-60"></a></span>
<span id="cb9-61"><a href="#cb9-61"></a><span class="fu">## Both, and</span></span>
<span id="cb9-62"><a href="#cb9-62"></a></span>
<span id="cb9-63"><a href="#cb9-63"></a><span class="ss">- </span>So what does this have to do with Rust?</span>
<span id="cb9-64"><a href="#cb9-64"></a><span class="ss">    - </span>Well, unlike C, Rust is a safe programming language.</span>
<span id="cb9-65"><a href="#cb9-65"></a><span class="ss">    - </span>But, like C, Rust is an unsafe programming language.</span>
<span id="cb9-66"><a href="#cb9-66"></a><span class="ss">- </span>More accurately, Rust *contains* both a safe and unsafe programming language.</span>
<span id="cb9-67"><a href="#cb9-67"></a></span>
<span id="cb9-68"><a href="#cb9-68"></a><span class="at">&gt; Rust can be thought of as a combination of two programming languages: *Safe</span></span>
<span id="cb9-69"><a href="#cb9-69"></a><span class="at">Rust* and *Unsafe Rust*. </span></span>
<span id="cb9-70"><a href="#cb9-70"></a></span>
<span id="cb9-71"><a href="#cb9-71"></a><span class="fu">## Safe Rust</span></span>
<span id="cb9-72"><a href="#cb9-72"></a></span>
<span id="cb9-73"><a href="#cb9-73"></a><span class="ss">- </span>The default case</span>
<span id="cb9-74"><a href="#cb9-74"></a><span class="ss">- </span>What we've used to far, at least officially</span>
<span id="cb9-75"><a href="#cb9-75"></a><span class="ss">    - </span>You may have incidentally dabbled in unsafe.</span>
<span id="cb9-76"><a href="#cb9-76"></a><span class="ss">    - </span>Good for you.</span>
<span id="cb9-77"><a href="#cb9-77"></a><span class="ss">- </span>Safe Rust only really makes *one* guarantee.</span>
<span id="cb9-78"><a href="#cb9-78"></a></span>
<span id="cb9-79"><a href="#cb9-79"></a><span class="at">&gt; Rust’s memory safety guarantees enforced at compile time</span></span>
<span id="cb9-80"><a href="#cb9-80"></a></span>
<span id="cb9-81"><a href="#cb9-81"></a><span class="ss">- </span>That is, you can never try to read something that doesn't exist.</span>
<span id="cb9-82"><a href="#cb9-82"></a></span>
<span id="cb9-83"><a href="#cb9-83"></a><span class="fu">## Unsafe Rust</span></span>
<span id="cb9-84"><a href="#cb9-84"></a></span>
<span id="cb9-85"><a href="#cb9-85"></a><span class="ss">- </span>Sometimes, you may want to have two reference to an object that are both mutable.</span>
<span id="cb9-86"><a href="#cb9-86"></a><span class="ss">    - </span>For example, if you are implementing a suffix tree, a task I didn't assign last term because it was *miserable* in safe Rust.</span>
<span id="cb9-87"><a href="#cb9-87"></a><span class="ss">- </span>Sometimes, you want to do so in a way that can't possibly break anything.</span>
<span id="cb9-88"><a href="#cb9-88"></a><span class="ss">    - </span>For example, you may only be using provably correct algorithms (whatever that means).</span>
<span id="cb9-89"><a href="#cb9-89"></a><span class="ss">    - </span>But of course, <span class="in">`rustc`</span> isn't a theorem prover...</span>
<span id="cb9-90"><a href="#cb9-90"></a>    </span>
<span id="cb9-91"><a href="#cb9-91"></a><span class="fu">## Warning</span></span>
<span id="cb9-92"><a href="#cb9-92"></a></span>
<span id="cb9-93"><a href="#cb9-93"></a><span class="at">&gt; Unsafe Rust is, well, not (safe). In fact, Unsafe Rust lets us</span></span>
<span id="cb9-94"><a href="#cb9-94"></a><span class="at">do some *really* unsafe things. Things the Rust authors will implore you not to</span></span>
<span id="cb9-95"><a href="#cb9-95"></a><span class="at">do, but we'll do anyway.</span></span>
<span id="cb9-96"><a href="#cb9-96"></a></span>
<span id="cb9-97"><a href="#cb9-97"></a><span class="fu">## True Rust</span></span>
<span id="cb9-98"><a href="#cb9-98"></a></span>
<span id="cb9-99"><a href="#cb9-99"></a><span class="ss">- </span>Safe Rust is the *true* Rust programming language. </span>
<span id="cb9-100"><a href="#cb9-100"></a><span class="ss">- </span>If all you do is write Safe</span>
<span id="cb9-101"><a href="#cb9-101"></a>Rust, you will never have to worry about type-safety or memory-safety. </span>
<span id="cb9-102"><a href="#cb9-102"></a><span class="ss">- </span>You will</span>
<span id="cb9-103"><a href="#cb9-103"></a>never endure </span>
<span id="cb9-104"><a href="#cb9-104"></a><span class="ss">    - </span>a dangling pointer, </span>
<span id="cb9-105"><a href="#cb9-105"></a><span class="ss">    - </span>a use-after-free, or </span>
<span id="cb9-106"><a href="#cb9-106"></a><span class="ss">    - </span>any other kind of Undefined Behavior (a.k.a. UB).</span>
<span id="cb9-107"><a href="#cb9-107"></a>   </span>
<span id="cb9-108"><a href="#cb9-108"></a></span>
<span id="cb9-109"><a href="#cb9-109"></a></span>
<span id="cb9-110"><a href="#cb9-110"></a><span class="fu">## `std`</span></span>
<span id="cb9-111"><a href="#cb9-111"></a></span>
<span id="cb9-112"><a href="#cb9-112"></a><span class="ss">- </span>The standard library also gives you enough utilities out of the box that you'll</span>
<span id="cb9-113"><a href="#cb9-113"></a>be able to write high-performance applications and libraries in pure idiomatic</span>
<span id="cb9-114"><a href="#cb9-114"></a>Safe Rust.</span>
<span id="cb9-115"><a href="#cb9-115"></a><span class="ss">- </span>Assuming, of course, you are working on a system where <span class="in">`std`</span> is already implemented.</span>
<span id="cb9-116"><a href="#cb9-116"></a><span class="ss">- </span>Not, you know, writing your own OS or own <span class="in">`std`</span>.</span>
<span id="cb9-117"><a href="#cb9-117"></a></span>
<span id="cb9-118"><a href="#cb9-118"></a><span class="fu">## Twinsies</span></span>
<span id="cb9-119"><a href="#cb9-119"></a></span>
<span id="cb9-120"><a href="#cb9-120"></a><span class="ss">- </span>Unsafe Rust is exactly like Safe Rust with all the same rules and semantics.</span>
<span id="cb9-121"><a href="#cb9-121"></a><span class="ss">- </span>It just lets you do some *extra* things that are Definitely Not Safe.</span>
<span id="cb9-122"><a href="#cb9-122"></a></span>
<span id="cb9-123"><a href="#cb9-123"></a><span class="fu">## Payoffs</span></span>
<span id="cb9-124"><a href="#cb9-124"></a></span>
<span id="cb9-125"><a href="#cb9-125"></a><span class="ss">- </span>The value of this separation is that we gain the benefits of using an unsafe</span>
<span id="cb9-126"><a href="#cb9-126"></a>language like C </span>
<span id="cb9-127"><a href="#cb9-127"></a><span class="ss">    - </span>low level control over implementation details</span>
<span id="cb9-128"><a href="#cb9-128"></a></span>
<span id="cb9-129"><a href="#cb9-129"></a><span class="ss">- </span>...without most (citation needed) of the problems that come with trying to integrate it with a completely different safe language.</span>
<span id="cb9-130"><a href="#cb9-130"></a></span>
<span id="cb9-131"><a href="#cb9-131"></a><span class="fu"># Undefined Behavior</span></span>
<span id="cb9-132"><a href="#cb9-132"></a></span>
<span id="cb9-133"><a href="#cb9-133"></a><span class="fu">## Safe Rust</span></span>
<span id="cb9-134"><a href="#cb9-134"></a></span>
<span id="cb9-135"><a href="#cb9-135"></a><span class="ss">- </span>Safe Rust guarantees certain things about your code.</span>
<span id="cb9-136"><a href="#cb9-136"></a><span class="ss">  - </span>Most of these won't even make sense to you unless you write C</span>
<span id="cb9-137"><a href="#cb9-137"></a></span>
<span id="cb9-138"><a href="#cb9-138"></a><span class="fu">## Safe Prevents</span></span>
<span id="cb9-139"><a href="#cb9-139"></a></span>
<span id="cb9-140"><a href="#cb9-140"></a><span class="ss">- </span>Dereferencing (using the <span class="in">`*`</span> operator on) dangling or unaligned pointers (see below)</span>
<span id="cb9-141"><a href="#cb9-141"></a><span class="ss">- </span>Breaking the "pointer aliasing rules" using <span class="in">`&amp;`</span> (borrow) and <span class="in">`mut`</span></span>
<span id="cb9-142"><a href="#cb9-142"></a><span class="ss">- </span>Calling a function with the wrong call types </span>
<span id="cb9-143"><a href="#cb9-143"></a><span class="ss">- </span>Causing a data race when multithreading</span>
<span id="cb9-144"><a href="#cb9-144"></a><span class="ss">- </span>Executing code compiled for hardware other than currently hosting the process</span>
<span id="cb9-145"><a href="#cb9-145"></a> not support</span>
<span id="cb9-146"><a href="#cb9-146"></a><span class="ss">- </span>Producing invalid values like something other than <span class="in">`0`</span> or <span class="in">`1`</span> for a boolean.</span>
<span id="cb9-147"><a href="#cb9-147"></a></span>
<span id="cb9-148"><a href="#cb9-148"></a><span class="fu">## Safe Allows</span></span>
<span id="cb9-149"><a href="#cb9-149"></a></span>
<span id="cb9-150"><a href="#cb9-150"></a></span>
<span id="cb9-151"><a href="#cb9-151"></a><span class="ss">-    </span>Deadlocks when multithreading</span>
<span id="cb9-152"><a href="#cb9-152"></a><span class="ss">-    </span>Leaks of memory and other resources</span>
<span id="cb9-153"><a href="#cb9-153"></a><span class="ss">-    </span>Exiting without calling destructors</span>
<span id="cb9-154"><a href="#cb9-154"></a><span class="ss">-    </span>Exposing randomized base addresses through pointer leaks</span>
<span id="cb9-155"><a href="#cb9-155"></a><span class="ss">-    </span>Integer overflow (recall SHA wrapping)</span>
<span id="cb9-156"><a href="#cb9-156"></a><span class="ss">-    </span>Logic errors</span>
<span id="cb9-157"><a href="#cb9-157"></a><span class="in">```{.rs}</span></span>
<span id="cb9-158"><a href="#cb9-158"></a>let val <span class="ot">=</span> <span class="dv">7</span>;</span>
<span id="cb9-159"><a href="#cb9-159"></a>let val_is_even <span class="ot">=</span> <span class="cf">if</span> val % <span class="dv">2</span> <span class="sc">==</span> <span class="dv">1</span> { true } <span class="cf">else</span> { false }; </span>
<span id="cb9-160"><a href="#cb9-160"></a><span class="in">```</span></span>
<span id="cb9-161"><a href="#cb9-161"></a></span>
<span id="cb9-162"><a href="#cb9-162"></a><span class="fu">## Unsafe allows:</span></span>
<span id="cb9-163"><a href="#cb9-163"></a></span>
<span id="cb9-164"><a href="#cb9-164"></a><span class="ss">1. </span>Dereference a raw pointer.</span>
<span id="cb9-165"><a href="#cb9-165"></a><span class="ss">1. </span>Call an unsafe function or method.</span>
<span id="cb9-166"><a href="#cb9-166"></a><span class="ss">1. </span>Access or modify a mutable static variable.</span>
<span id="cb9-167"><a href="#cb9-167"></a><span class="ss">1. </span>Implement an unsafe trait.</span>
<span id="cb9-168"><a href="#cb9-168"></a><span class="ss">1. </span>Access fields of <span class="in">`union`</span>s.</span>
<span id="cb9-169"><a href="#cb9-169"></a></span>
<span id="cb9-170"><a href="#cb9-170"></a></span>
<span id="cb9-171"><a href="#cb9-171"></a><span class="fu">## Simply...</span></span>
<span id="cb9-172"><a href="#cb9-172"></a></span>
<span id="cb9-173"><a href="#cb9-173"></a><span class="ss">1. </span>Write Rust code normally.</span>
<span id="cb9-174"><a href="#cb9-174"></a><span class="ss">2. </span>If you are doing something unsafe, include it in an <span class="in">`unsafe`</span> block.</span>
<span id="cb9-175"><a href="#cb9-175"></a></span>
<span id="cb9-176"><a href="#cb9-176"></a><span class="fu">## Unions</span></span>
<span id="cb9-177"><a href="#cb9-177"></a></span>
<span id="cb9-178"><a href="#cb9-178"></a><span class="in">```{.rs}</span></span>
<span id="cb9-179"><a href="#cb9-179"></a>union MyUnion {</span>
<span id="cb9-180"><a href="#cb9-180"></a>    f<span class="sc">:</span> f32,</span>
<span id="cb9-181"><a href="#cb9-181"></a>    u<span class="sc">:</span> u32,</span>
<span id="cb9-182"><a href="#cb9-182"></a>}</span>
<span id="cb9-183"><a href="#cb9-183"></a></span>
<span id="cb9-184"><a href="#cb9-184"></a>fn <span class="fu">main</span>() {</span>
<span id="cb9-185"><a href="#cb9-185"></a>    let mut u <span class="ot">=</span> MyUnion { f<span class="sc">:</span> <span class="fl">0.0</span> };</span>
<span id="cb9-186"><a href="#cb9-186"></a></span>
<span id="cb9-187"><a href="#cb9-187"></a>    unsafe {</span>
<span id="cb9-188"><a href="#cb9-188"></a>        println<span class="sc">!</span>(<span class="st">"Bits as float: {}"</span>, u.f);</span>
<span id="cb9-189"><a href="#cb9-189"></a>        println<span class="sc">!</span>(<span class="st">"Bits as integer: {:#x}"</span>, u.u);</span>
<span id="cb9-190"><a href="#cb9-190"></a>    }</span>
<span id="cb9-191"><a href="#cb9-191"></a></span>
<span id="cb9-192"><a href="#cb9-192"></a>    u.u <span class="ot">=</span> <span class="dv">0x3F800000</span>; <span class="sc">/</span><span class="er">/</span> This is the bit pattern <span class="cf">for</span> <span class="fl">1.0</span> <span class="cf">in</span> IEEE <span class="dv">754</span></span>
<span id="cb9-193"><a href="#cb9-193"></a></span>
<span id="cb9-194"><a href="#cb9-194"></a>    unsafe {</span>
<span id="cb9-195"><a href="#cb9-195"></a>        println<span class="sc">!</span>(<span class="st">"After manual bit update, float is: {}"</span>, u.f);</span>
<span id="cb9-196"><a href="#cb9-196"></a>    }</span>
<span id="cb9-197"><a href="#cb9-197"></a>}</span>
<span id="cb9-198"><a href="#cb9-198"></a><span class="in">```</span></span>
<span id="cb9-199"><a href="#cb9-199"></a></span>
<span id="cb9-200"><a href="#cb9-200"></a><span class="fu">## Dangling</span></span>
<span id="cb9-201"><a href="#cb9-201"></a></span>
<span id="cb9-202"><a href="#cb9-202"></a><span class="ss">- </span>This worked fine for me, but technically isn't supported.</span>
<span id="cb9-203"><a href="#cb9-203"></a></span>
<span id="cb9-204"><a href="#cb9-204"></a><span class="in">```{.rs filename="src/main.rs"}</span></span>
<span id="cb9-205"><a href="#cb9-205"></a>fn <span class="fu">main</span>() {    </span>
<span id="cb9-206"><a href="#cb9-206"></a>    let ptr<span class="sc">:</span> <span class="er">*</span>const i32;</span>
<span id="cb9-207"><a href="#cb9-207"></a></span>
<span id="cb9-208"><a href="#cb9-208"></a>    {</span>
<span id="cb9-209"><a href="#cb9-209"></a>        let x <span class="ot">=</span> <span class="dv">1234</span>;</span>
<span id="cb9-210"><a href="#cb9-210"></a>        ptr <span class="ot">=</span> <span class="er">&amp;</span>x as <span class="sc">*</span>const i32;</span>
<span id="cb9-211"><a href="#cb9-211"></a>        unsafe {</span>
<span id="cb9-212"><a href="#cb9-212"></a>            println<span class="sc">!</span>(<span class="st">"Value at ptr: {}"</span>, <span class="sc">*</span>ptr);</span>
<span id="cb9-213"><a href="#cb9-213"></a>        }</span>
<span id="cb9-214"><a href="#cb9-214"></a>    }</span>
<span id="cb9-215"><a href="#cb9-215"></a></span>
<span id="cb9-216"><a href="#cb9-216"></a>    unsafe {</span>
<span id="cb9-217"><a href="#cb9-217"></a>        println<span class="sc">!</span>(<span class="st">"Value at ptr: {}"</span>, <span class="sc">*</span>ptr);</span>
<span id="cb9-218"><a href="#cb9-218"></a>    }</span>
<span id="cb9-219"><a href="#cb9-219"></a>}</span>
<span id="cb9-220"><a href="#cb9-220"></a><span class="in">```</span></span>
<span id="cb9-221"><a href="#cb9-221"></a></span>
<span id="cb9-222"><a href="#cb9-222"></a><span class="fu">## The Reference</span></span>
<span id="cb9-223"><a href="#cb9-223"></a></span>
<span id="cb9-224"><a href="#cb9-224"></a><span class="ss">- </span>The reference is much more... verbose.</span>
<span id="cb9-225"><a href="#cb9-225"></a><span class="ss">- </span>It's <span class="co">[</span><span class="ot">here</span><span class="co">](https://doc.rust-lang.org/reference/behavior-considered-undefined.html)</span></span>
<span id="cb9-226"><a href="#cb9-226"></a></span>
<span id="cb9-227"><a href="#cb9-227"></a><span class="at">&gt; Breaking the pointer aliasing rules. The exact aliasing rules are not determined yet, but here is an outline of the general principles:</span></span>
<span id="cb9-228"><a href="#cb9-228"></a></span>
<span id="cb9-229"><a href="#cb9-229"></a><span class="at">&gt; Violating assumptions of the Rust runtime. Most assumptions of the Rust runtime are currently not explicitly documented. </span></span>
<span id="cb9-230"><a href="#cb9-230"></a></span>
<span id="cb9-231"><a href="#cb9-231"></a><span class="fu"># Dangling</span></span>
<span id="cb9-232"><a href="#cb9-232"></a></span>
<span id="cb9-233"><a href="#cb9-233"></a><span class="fu">## Previously in Rust</span></span>
<span id="cb9-234"><a href="#cb9-234"></a></span>
<span id="cb9-235"><a href="#cb9-235"></a><span class="ss">- </span>*Safe* Rust ensures that references are always valid</span>
<span id="cb9-236"><a href="#cb9-236"></a><span class="ss">    - </span>That is, borrows via <span class="in">`&amp;`</span></span>
<span id="cb9-237"><a href="#cb9-237"></a><span class="ss">    - </span>These always have some plausible correct value in them (if the code compiles)</span>
<span id="cb9-238"><a href="#cb9-238"></a></span>
<span id="cb9-239"><a href="#cb9-239"></a><span class="fu">## The Frontier</span></span>
<span id="cb9-240"><a href="#cb9-240"></a></span>
<span id="cb9-241"><a href="#cb9-241"></a><span class="ss">- </span>At the edge of Safe and Unsafe Rust are *raw* pointers.</span>
<span id="cb9-242"><a href="#cb9-242"></a><span class="ss">    - </span>Can be immutable <span class="in">`*const T`</span> or mutable <span class="in">`*mut T`</span>.</span>
<span id="cb9-243"><a href="#cb9-243"></a><span class="ss">    - </span>Vs. C, the asterisk is part of the name and not an operator.</span>
<span id="cb9-244"><a href="#cb9-244"></a><span class="ss">        - </span>This is annoying.</span>
<span id="cb9-245"><a href="#cb9-245"></a><span class="ss">- </span>Raw pointers are inherently unsafe, so they can be created in safe Rust.</span>
<span id="cb9-246"><a href="#cb9-246"></a></span>
<span id="cb9-247"><a href="#cb9-247"></a><span class="fu">## Differences</span></span>
<span id="cb9-248"><a href="#cb9-248"></a></span>
<span id="cb9-249"><a href="#cb9-249"></a><span class="ss">- </span>These *raw* pointers:</span>
<span id="cb9-250"><a href="#cb9-250"></a><span class="ss">  - </span>Are allowed to ignore the borrowing rules by having both immutable and</span>
<span id="cb9-251"><a href="#cb9-251"></a>  mutable pointers or multiple mutable pointers to the same location</span>
<span id="cb9-252"><a href="#cb9-252"></a><span class="ss">  - </span>Aren’t guaranteed to point to valid memory</span>
<span id="cb9-253"><a href="#cb9-253"></a><span class="ss">  - </span>Are allowed to be null</span>
<span id="cb9-254"><a href="#cb9-254"></a><span class="ss">  - </span>Don’t implement any automatic cleanup</span>
<span id="cb9-255"><a href="#cb9-255"></a></span>
<span id="cb9-256"><a href="#cb9-256"></a><span class="fu">## Example</span></span>
<span id="cb9-257"><a href="#cb9-257"></a></span>
<span id="cb9-258"><a href="#cb9-258"></a><span class="in">```{.rs}</span></span>
<span id="cb9-259"><a href="#cb9-259"></a>    let mut num <span class="ot">=</span> <span class="dv">5</span>;</span>
<span id="cb9-260"><a href="#cb9-260"></a></span>
<span id="cb9-261"><a href="#cb9-261"></a>    let r1 <span class="ot">=</span> <span class="er">&amp;</span>raw const num;</span>
<span id="cb9-262"><a href="#cb9-262"></a>    let r2 <span class="ot">=</span> <span class="er">&amp;</span>raw mut num;</span>
<span id="cb9-263"><a href="#cb9-263"></a><span class="in">```</span></span>
<span id="cb9-264"><a href="#cb9-264"></a></span>
<span id="cb9-265"><a href="#cb9-265"></a><span class="fu">## This is safe!</span></span>
<span id="cb9-266"><a href="#cb9-266"></a></span>
<span id="cb9-267"><a href="#cb9-267"></a><span class="ss">- </span>There is nothing unsafe and creating a variable that refers to some value.</span>
<span id="cb9-268"><a href="#cb9-268"></a><span class="ss">- </span>After all, what's the worst thing that can happen?</span>
<span id="cb9-269"><a href="#cb9-269"></a><span class="ss">- </span>These lines of code only facilitate novel possible ways of interfacing with the underlying data.</span>
<span id="cb9-270"><a href="#cb9-270"></a><span class="ss">- </span>In this case, we *know* these pointers are valid and point to 5.</span>
<span id="cb9-271"><a href="#cb9-271"></a></span>
<span id="cb9-272"><a href="#cb9-272"></a><span class="fu">## Casts</span></span>
<span id="cb9-273"><a href="#cb9-273"></a></span>
<span id="cb9-274"><a href="#cb9-274"></a><span class="ss">- </span>We can get a potentially invalid reference using "casts" with the <span class="in">`as`</span> keyword.</span>
<span id="cb9-275"><a href="#cb9-275"></a><span class="ss">    - </span>We take a numeric value and treat it as a reference.</span>
<span id="cb9-276"><a href="#cb9-276"></a><span class="ss">    - </span>This numerical value represents a location in numerical organized computer memory.</span>
<span id="cb9-277"><a href="#cb9-277"></a></span>
<span id="cb9-278"><a href="#cb9-278"></a><span class="in">```{.rs}</span></span>
<span id="cb9-279"><a href="#cb9-279"></a>    let address <span class="ot">=</span> <span class="dv">0x012345</span>usize;</span>
<span id="cb9-280"><a href="#cb9-280"></a>    let r <span class="ot">=</span> address as <span class="sc">*</span>const i32;</span>
<span id="cb9-281"><a href="#cb9-281"></a><span class="in">```</span></span>
<span id="cb9-282"><a href="#cb9-282"></a><span class="ss">- </span>This is still safe so far!</span>
<span id="cb9-283"><a href="#cb9-283"></a></span>
<span id="cb9-284"><a href="#cb9-284"></a><span class="fu">## Dereference</span></span>
<span id="cb9-285"><a href="#cb9-285"></a></span>
<span id="cb9-286"><a href="#cb9-286"></a><span class="ss">- </span>We now can use the dereference asterisk <span class="in">`*`</span> operator.</span>
<span id="cb9-287"><a href="#cb9-287"></a><span class="ss">- </span>This is decidedly unsafe.</span>
<span id="cb9-288"><a href="#cb9-288"></a></span>
<span id="cb9-289"><a href="#cb9-289"></a><span class="in">```{.rs}</span></span>
<span id="cb9-290"><a href="#cb9-290"></a>    let mut num <span class="ot">=</span> <span class="dv">5</span>;</span>
<span id="cb9-291"><a href="#cb9-291"></a></span>
<span id="cb9-292"><a href="#cb9-292"></a>    let r1 <span class="ot">=</span> <span class="er">&amp;</span>raw const num;</span>
<span id="cb9-293"><a href="#cb9-293"></a>    let r2 <span class="ot">=</span> <span class="er">&amp;</span>raw mut num;</span>
<span id="cb9-294"><a href="#cb9-294"></a></span>
<span id="cb9-295"><a href="#cb9-295"></a>    unsafe {</span>
<span id="cb9-296"><a href="#cb9-296"></a>        println<span class="sc">!</span>(<span class="st">"r1 is: {}"</span>, <span class="sc">*</span>r1);</span>
<span id="cb9-297"><a href="#cb9-297"></a>        println<span class="sc">!</span>(<span class="st">"r2 is: {}"</span>, <span class="sc">*</span>r2);</span>
<span id="cb9-298"><a href="#cb9-298"></a>    }</span>
<span id="cb9-299"><a href="#cb9-299"></a><span class="in">```</span></span>
<span id="cb9-300"><a href="#cb9-300"></a><span class="ss">- </span>Unsafe *to Rust* but we know it will work.</span>
<span id="cb9-301"><a href="#cb9-301"></a></span>
<span id="cb9-302"><a href="#cb9-302"></a><span class="fu">## Runtime Crash</span></span>
<span id="cb9-303"><a href="#cb9-303"></a></span>
<span id="cb9-304"><a href="#cb9-304"></a><span class="ss">- </span>This is both unsafe and (almost certainly) won't work.</span>
<span id="cb9-305"><a href="#cb9-305"></a></span>
<span id="cb9-306"><a href="#cb9-306"></a><span class="in">```{.rs filename="src/main.rs"}</span></span>
<span id="cb9-307"><a href="#cb9-307"></a>fn <span class="fu">main</span>() {</span>
<span id="cb9-308"><a href="#cb9-308"></a>    let address <span class="ot">=</span> <span class="dv">0x0</span>usize;</span>
<span id="cb9-309"><a href="#cb9-309"></a>    let r <span class="ot">=</span> address as <span class="sc">*</span>const i32;</span>
<span id="cb9-310"><a href="#cb9-310"></a>    unsafe {</span>
<span id="cb9-311"><a href="#cb9-311"></a>        dbg<span class="sc">!</span>(<span class="sc">*</span>r);</span>
<span id="cb9-312"><a href="#cb9-312"></a>    }</span>
<span id="cb9-313"><a href="#cb9-313"></a>}</span>
<span id="cb9-314"><a href="#cb9-314"></a><span class="in">```</span></span>
<span id="cb9-315"><a href="#cb9-315"></a><span class="ss">- </span>Fun exercise: try to take the deferences out of the <span class="in">`unsafe`</span> block.</span>
<span id="cb9-316"><a href="#cb9-316"></a></span>
<span id="cb9-317"><a href="#cb9-317"></a><span class="fu"># Fin</span></span>
<span id="cb9-318"><a href="#cb9-318"></a></span>
<span id="cb9-319"><a href="#cb9-319"></a><span class="fu">## Announcements</span></span>
<span id="cb9-320"><a href="#cb9-320"></a></span>
<span id="cb9-321"><a href="#cb9-321"></a><span class="ss">- </span>**Action Items**:</span>
<span id="cb9-322"><a href="#cb9-322"></a><span class="ss">  - </span><span class="in">`wc`</span> ongoing.</span>
<span id="cb9-323"><a href="#cb9-323"></a><span class="ss">  - </span>Due Friday, 5 Sept. at 1440 PT.</span>
<span id="cb9-324"><a href="#cb9-324"></a><span class="ss">  - </span>Just a quick demo for HW this week, check it out whenever.</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>