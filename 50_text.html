<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Text – OS in Rust</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./51_format.html" rel="next">
<link href="./42_hello.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-707d8167ce6003fca903bfe2be84ab7f.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-40a160e28a8c0a8ad2fc184c8ba4238c.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./50_text.html">Text</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
      <a href="./index.html" class="sidebar-logo-link">
      </a>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./00_derust.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Derust</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_wc.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">wc</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_cli.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">CLI</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11_unsafe.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Unsafe</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12_split_at.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Splits</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./20_os.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">OS</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./21_xmute.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Transmute</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./22_malloc.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">malloc</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./30_metal.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bare Metal</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./31_linker.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Linker</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./32_r5.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">RISC-V</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./40_kernel.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Kernel</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./41_boot.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Boot</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./42_hello.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Hello</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./50_text.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Text</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./51_format.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Format</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./52_graphics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Graphics</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./60_test.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Test</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./61_serial.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Serial</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#announcements" id="toc-announcements" class="nav-link active" data-scroll-target="#announcements">Announcements</a></li>
  <li><a href="#citations" id="toc-citations" class="nav-link" data-scroll-target="#citations">Citations</a></li>
  <li><a href="#background" id="toc-background" class="nav-link" data-scroll-target="#background">Background</a>
  <ul class="collapse">
  <li><a href="#vga-text-mode" id="toc-vga-text-mode" class="nav-link" data-scroll-target="#vga-text-mode">VGA Text Mode</a></li>
  <li><a href="#the-buffer" id="toc-the-buffer" class="nav-link" data-scroll-target="#the-buffer">The Buffer</a></li>
  <li><a href="#d-or-2d" id="toc-d-or-2d" class="nav-link" data-scroll-target="#d-or-2d">1d or 2d</a></li>
  <li><a href="#format" id="toc-format" class="nav-link" data-scroll-target="#format">Format</a></li>
  <li><a href="#first-byte" id="toc-first-byte" class="nav-link" data-scroll-target="#first-byte">First Byte</a></li>
  <li><a href="#except" id="toc-except" class="nav-link" data-scroll-target="#except">Except</a></li>
  <li><a href="#second-byte" id="toc-second-byte" class="nav-link" data-scroll-target="#second-byte">Second Byte</a></li>
  <li><a href="#colors" id="toc-colors" class="nav-link" data-scroll-target="#colors">Colors</a></li>
  <li><a href="#brightblink" id="toc-brightblink" class="nav-link" data-scroll-target="#brightblink">Bright/Blink</a></li>
  <li><a href="#memory-mapped-io" id="toc-memory-mapped-io" class="nav-link" data-scroll-target="#memory-mapped-io">Memory-mapped I/O</a></li>
  <li><a href="#isolated-io" id="toc-isolated-io" class="nav-link" data-scroll-target="#isolated-io">Isolated I/O</a></li>
  <li><a href="#this-isnt-cool" id="toc-this-isnt-cool" class="nav-link" data-scroll-target="#this-isnt-cool">This isn’t cool</a></li>
  <li><a href="#memory-mapped-io-1" id="toc-memory-mapped-io-1" class="nav-link" data-scroll-target="#memory-mapped-io-1">Memory-Mapped I/O</a></li>
  <li><a href="#altogether" id="toc-altogether" class="nav-link" data-scroll-target="#altogether">Altogether</a></li>
  <li><a href="#downsides" id="toc-downsides" class="nav-link" data-scroll-target="#downsides">Downsides</a></li>
  </ul></li>
  <li><a href="#x86_64" id="toc-x86_64" class="nav-link" data-scroll-target="#x86_64">x86_64</a>
  <ul class="collapse">
  <li><a href="#in-x86_64" id="toc-in-x86_64" class="nav-link" data-scroll-target="#in-x86_64">In x86_64</a></li>
  <li><a href="#alert" id="toc-alert" class="nav-link" data-scroll-target="#alert">Alert!</a></li>
  <li><a href="#a-rust-module" id="toc-a-rust-module" class="nav-link" data-scroll-target="#a-rust-module">A Rust Module</a></li>
  <li><a href="#standard-out" id="toc-standard-out" class="nav-link" data-scroll-target="#standard-out">Standard Out</a></li>
  <li><a href="#location" id="toc-location" class="nav-link" data-scroll-target="#location">Location</a></li>
  <li><a href="#color" id="toc-color" class="nav-link" data-scroll-target="#color">Color</a></li>
  <li><a href="#character-wise" id="toc-character-wise" class="nav-link" data-scroll-target="#character-wise">Character-wise</a></li>
  <li><a href="#stepwise" id="toc-stepwise" class="nav-link" data-scroll-target="#stepwise">Stepwise</a></li>
  <li><a href="#stepwise-1" id="toc-stepwise-1" class="nav-link" data-scroll-target="#stepwise-1">Stepwise</a></li>
  <li><a href="#stepwise-2" id="toc-stepwise-2" class="nav-link" data-scroll-target="#stepwise-2">Stepwise</a></li>
  <li><a href="#stepwise-3" id="toc-stepwise-3" class="nav-link" data-scroll-target="#stepwise-3">Stepwise</a></li>
  <li><a href="#test-it" id="toc-test-it" class="nav-link" data-scroll-target="#test-it">Test it</a></li>
  <li><a href="#annoying" id="toc-annoying" class="nav-link" data-scroll-target="#annoying">Annoying</a></li>
  <li><a href="#target-str" id="toc-target-str" class="nav-link" data-scroll-target="#target-str">Target <code>&amp;str</code></a></li>
  <li><a href="#aside" id="toc-aside" class="nav-link" data-scroll-target="#aside">Aside</a></li>
  <li><a href="#aside-1" id="toc-aside-1" class="nav-link" data-scroll-target="#aside-1">Aside</a></li>
  <li><a href="#update-main" id="toc-update-main" class="nav-link" data-scroll-target="#update-main">Update main</a></li>
  <li><a href="#i-bet" id="toc-i-bet" class="nav-link" data-scroll-target="#i-bet">I bet…</a></li>
  <li><a href="#escape-codes" id="toc-escape-codes" class="nav-link" data-scroll-target="#escape-codes">Escape Codes</a></li>
  <li><a href="#revisit-implementation" id="toc-revisit-implementation" class="nav-link" data-scroll-target="#revisit-implementation">Revisit Implementation</a></li>
  <li><a href="#case-analysis" id="toc-case-analysis" class="nav-link" data-scroll-target="#case-analysis">Case analysis</a></li>
  <li><a href="#trust-but-verify" id="toc-trust-but-verify" class="nav-link" data-scroll-target="#trust-but-verify">Trust but verify</a></li>
  <li><a href="#now-it-works" id="toc-now-it-works" class="nav-link" data-scroll-target="#now-it-works">Now it works!</a></li>
  <li><a href="#good-thing" id="toc-good-thing" class="nav-link" data-scroll-target="#good-thing">Good thing…</a></li>
  <li><a href="#were-doomed" id="toc-were-doomed" class="nav-link" data-scroll-target="#were-doomed">We’re doomed</a></li>
  <li><a href="#unless" id="toc-unless" class="nav-link" data-scroll-target="#unless">Unless?</a></li>
  <li><a href="#scroll" id="toc-scroll" class="nav-link" data-scroll-target="#scroll">Scroll</a></li>
  <li><a href="#execution" id="toc-execution" class="nav-link" data-scroll-target="#execution">Execution</a></li>
  <li><a href="#my-code" id="toc-my-code" class="nav-link" data-scroll-target="#my-code">My Code</a></li>
  <li><a href="#my-test" id="toc-my-test" class="nav-link" data-scroll-target="#my-test">My Test</a></li>
  <li><a href="#a-better-test" id="toc-a-better-test" class="nav-link" data-scroll-target="#a-better-test">A better test</a></li>
  <li><a href="#does-it-work" id="toc-does-it-work" class="nav-link" data-scroll-target="#does-it-work">Does it work?</a></li>
  <li><a href="#why-do-we-blank-out" id="toc-why-do-we-blank-out" class="nav-link" data-scroll-target="#why-do-we-blank-out">Why do we blank out?</a></li>
  <li><a href="#we-set-color-bytes" id="toc-we-set-color-bytes" class="nav-link" data-scroll-target="#we-set-color-bytes">We set color bytes?</a></li>
  <li><a href="#this-is-unsafe" id="toc-this-is-unsafe" class="nav-link" data-scroll-target="#this-is-unsafe">This is unsafe!</a></li>
  <li><a href="#im-loopy" id="toc-im-loopy" class="nav-link" data-scroll-target="#im-loopy">I’m loopy</a></li>
  <li><a href="#caution" id="toc-caution" class="nav-link" data-scroll-target="#caution">Caution!</a></li>
  <li><a href="#my-solution" id="toc-my-solution" class="nav-link" data-scroll-target="#my-solution">My solution</a></li>
  </ul></li>
  <li><a href="#volatile" id="toc-volatile" class="nav-link" data-scroll-target="#volatile">Volatile</a>
  <ul class="collapse">
  <li><a href="#best-practice" id="toc-best-practice" class="nav-link" data-scroll-target="#best-practice">Best Practice</a></li>
  <li><a href="#quote-blog" id="toc-quote-blog" class="nav-link" data-scroll-target="#quote-blog">Quote Blog</a></li>
  <li><a href="#volatile-1" id="toc-volatile-1" class="nav-link" data-scroll-target="#volatile-1">Volatile</a></li>
  <li><a href="#interested-students" id="toc-interested-students" class="nav-link" data-scroll-target="#interested-students">Interested Students</a></li>
  </ul></li>
  <li><a href="#fin" id="toc-fin" class="nav-link" data-scroll-target="#fin">Fin</a></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="50_text.rjs.html"><i class="bi bi-file-slides"></i>RevealJS</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Text</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i></button></div></div>
<p class="subtitle lead">OS in Rust</p>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="announcements" class="level2">
<h2 class="anchored" data-anchor-id="announcements">Announcements</h2>
<ul>
<li><strong>Action Items</strong>:
<ul>
<li>Do you text output yet?
<ul>
<li>The coolest assignment ever for a third week in a row.</li>
<li>How do I keep getting away with it.</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="citations" class="level2">
<h2 class="anchored" data-anchor-id="citations">Citations</h2>
<ul>
<li>I tried to steal this but I thought it was too bad and changed everything.
<ul>
<li><a href="https://os.phil-opp.com/vga-text-mode/">VGA Text Mode</a></li>
</ul></li>
</ul>
</section>
<section id="background" class="level1">
<h1>Background</h1>
<section id="vga-text-mode" class="level2">
<h2 class="anchored" data-anchor-id="vga-text-mode">VGA Text Mode</h2>
<ul>
<li>We recall <a href="https://en.wikipedia.org/wiki/VGA-compatible_text_mode">VGA text mode</a> from the homework.
<ul>
<li>A simple way to print text to the screen.</li>
</ul></li>
<li>We recall that Rust prints via a “macro”</li>
<li>Now we:
<ul>
<li>Create an interface to encapsulating all unsafety in a separate module.</li>
<li>We also implement support for Rust’s <a href="https://en.wikipedia.org/wiki/VGA-compatible_text_mode">formatting macros</a></li>
</ul></li>
</ul>
</section>
<section id="the-buffer" class="level2">
<h2 class="anchored" data-anchor-id="the-buffer">The Buffer</h2>
<ul>
<li>To print a character to the screen in VGA text mode, one has to write it to the text buffer of the VGA hardware.
<ul>
<li>A byte passing over a bus to fixed location will render as ASCII on a screen.</li>
</ul></li>
</ul>
</section>
<section id="d-or-2d" class="level2">
<h2 class="anchored" data-anchor-id="d-or-2d">1d or 2d</h2>
<ul>
<li>The VGA text buffer renders as two-dimensional array.
<ul>
<li>Addressed as a one dimensional array.</li>
<li>Safe to assume 25 rows and 80 columns.</li>
<li>Each position is an ASCII (<em>not</em> unicode) character.</li>
</ul></li>
</ul>
</section>
<section id="format" class="level2">
<h2 class="anchored" data-anchor-id="format">Format</h2>
<ul>
<li>Describes a single screen character through the following format:</li>
</ul>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Bit(s)</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0-7</td>
<td>ASCII code point</td>
</tr>
<tr class="even">
<td>8-11</td>
<td>Foreground color</td>
</tr>
<tr class="odd">
<td>12-14</td>
<td>Background color</td>
</tr>
<tr class="even">
<td>15</td>
<td>Blink</td>
</tr>
</tbody>
</table>
<ul>
<li>I did not see blinking.</li>
</ul>
</section>
<section id="first-byte" class="level2">
<h2 class="anchored" data-anchor-id="first-byte">First Byte</h2>
<ul>
<li>The first byte represents the character that should be printed in the [ASCII encoding].
<ul>
<li>We recall we say many mentions of Python in firmware jobs.</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1"></a><span class="ex">python3</span> <span class="at">-c</span> <span class="st">"[print(chr(a), ':', a) for a in range(ord('A'), ord('z')+1)]"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div></li>
</ul>
</section>
<section id="except" class="level2">
<h2 class="anchored" data-anchor-id="except">Except</h2>
<ul>
<li>Okay it isn’t actually ASCII.</li>
<li>It’s <a href="https://en.wikipedia.org/wiki/Code_page_437"><em>code page 437</em></a></li>
<li>We think of it as an IBM specific ASCII extension and just use the ASCII subset.</li>
</ul>
</section>
<section id="second-byte" class="level2">
<h2 class="anchored" data-anchor-id="second-byte">Second Byte</h2>
<ul>
<li>The second <strong>byte</strong> defines how the character is displayed.
<ul>
<li>The first <strong>four</strong> bits define the foreground color.</li>
<li>The next three bits the background color</li>
<li><em>Nominally</em> the last bit whether the character should blink.
<ul>
<li>I did not see blinking.</li>
<li>May be a <code>qemu</code> thing I’m not sure.</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="colors" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="colors">Colors</h2>
<ul>
<li>Using octal.</li>
</ul>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Number</th>
<th>Color</th>
<th>Bright</th>
<th>Bright Color</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0o00</td>
<td>Black</td>
<td>0o10</td>
<td>Dark Gray</td>
</tr>
<tr class="even">
<td>0o01</td>
<td>Blue</td>
<td>0o11</td>
<td>Light Blue</td>
</tr>
<tr class="odd">
<td>0o02</td>
<td>Green</td>
<td>0o12</td>
<td>Light Green</td>
</tr>
<tr class="even">
<td>0o03</td>
<td>Cyan</td>
<td>0o13</td>
<td>Light Cyan</td>
</tr>
<tr class="odd">
<td>0o04</td>
<td>Red</td>
<td>0o14</td>
<td>Light Red</td>
</tr>
<tr class="even">
<td>0o05</td>
<td>Magenta</td>
<td>0o15</td>
<td>Pink</td>
</tr>
<tr class="odd">
<td>0o06</td>
<td>Brown</td>
<td>0o16</td>
<td>Yellow</td>
</tr>
<tr class="even">
<td>0o07</td>
<td>Light Gray</td>
<td>0o17</td>
<td>White</td>
</tr>
</tbody>
</table>
</section>
<section id="brightblink" class="level2">
<h2 class="anchored" data-anchor-id="brightblink">Bright/Blink</h2>
<ul>
<li>Bit 4 is the <em>bright bit</em>.
<ul>
<li>For example, blue into light blue.</li>
</ul></li>
<li>For the background color, this bit is nominally repurposed as the blink bit.</li>
</ul>
</section>
<section id="memory-mapped-io" class="level2">
<h2 class="anchored" data-anchor-id="memory-mapped-io">Memory-mapped I/O</h2>
<ul>
<li>Okay so this is cool.</li>
<li>Recall the bus!</li>
<li>We are going to steal some diagrams.
<ul>
<li>Thanks <a href="https://www.geeksforgeeks.org/computer-organization-architecture/memory-mapped-i-o-and-isolated-i-o/">Geeks for Geeks</a></li>
</ul></li>
</ul>
</section>
<section id="isolated-io" class="level2">
<h2 class="anchored" data-anchor-id="isolated-io">Isolated I/O</h2>
<ul>
<li>Imagine a form of I/O that isn’t cool.</li>
<li>It may have separate address spaces.
<ul>
<li>So there may be a <code>0x64</code> memory location and also <code>0x64</code> device.</li>
</ul></li>
</ul>
<p><img src="https://media.geeksforgeeks.org/wp-content/uploads/20250506151408311194/isolate-io.webp" class="img-fluid"></p>
</section>
<section id="this-isnt-cool" class="level2">
<h2 class="anchored" data-anchor-id="this-isnt-cool">This isn’t cool</h2>
<ul>
<li>We already discussed Harvard vs.&nbsp;von Neumann architecture.</li>
<li>Having two memory spaces is not at all cool.</li>
<li>So we don’t do it.</li>
<li>There’s also port-mapped I/O (similarly not cool.</li>
</ul>
</section>
<section id="memory-mapped-io-1" class="level2">
<h2 class="anchored" data-anchor-id="memory-mapped-io-1">Memory-Mapped I/O</h2>
<ul>
<li>Imagine the following.
<ul>
<li>The bootloader lives at <code>0x0</code></li>
<li>The OS lives at <code>0x1</code></li>
<li>The keyboard lives at <code>0x2</code></li>
<li>The internet (via a network card) at <code>0x3</code></li>
<li>The monitor at <code>0x4</code></li>
</ul></li>
<li>This obviously cool.</li>
</ul>
</section>
<section id="altogether" class="level2">
<h2 class="anchored" data-anchor-id="altogether">Altogether</h2>
<ul>
<li>One Big Happy Memory Space</li>
</ul>
<p><img src="https://media.geeksforgeeks.org/wp-content/uploads/20250506151651561116/memory-io.webp" class="img-fluid"></p>
</section>
<section id="downsides" class="level2">
<h2 class="anchored" data-anchor-id="downsides">Downsides</h2>
<ul>
<li>MMIO is a helpful <em>abstraction</em> - we already know how to think about memory, so we don’t need to learn much to do I/O.
<ul>
<li>There’s downsides.</li>
<li>We shouldn’t be able to write to keyboard, probably.</li>
<li>Or read from a monitor.</li>
</ul></li>
<li>But its fast and easy, like BIOS vs.&nbsp;UEFI.</li>
</ul>
</section>
</section>
<section id="x86_64" class="level1">
<h1>x86_64</h1>
<section id="in-x86_64" class="level2">
<h2 class="anchored" data-anchor-id="in-x86_64">In x86_64</h2>
<ul>
<li>On our emulated device, VGA text buffer lives at address <code>0xb8000</code>.
<ul>
<li>Absolute geniuses will crack open C and get into trouble.</li>
</ul></li>
<li>So any read to this location:
<ul>
<li>Doesn’t go to MMU/RAM/SSD</li>
<li>Does go to VGA hardware</li>
</ul></li>
</ul>
</section>
<section id="alert" class="level2">
<h2 class="anchored" data-anchor-id="alert">Alert!</h2>
<ul>
<li>MMIO, especially older devices, might not support all normal operations.</li>
<li>For example, a device could only support byte-wise reads and return junk when a <code>u64</code> is read.
<ul>
<li>Block-write “Hello world!” is a homework extension.</li>
</ul></li>
<li><a href="https://web.stanford.edu/class/cs140/projects/pintos/specs/freevga/vga/vgamem.htm#manip">Read more</a></li>
</ul>
</section>
<section id="a-rust-module" class="level2">
<h2 class="anchored" data-anchor-id="a-rust-module">A Rust Module</h2>
<ul>
<li>Now we “know” how the VGA buffer works.</li>
<li>We can create a Rust module to handle print and standard out:</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/main.rs</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" data-filename="src/main.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb2-1"><a href="#cb2-1"></a><span class="kw">mod</span> vga<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<ul>
<li>We also must create a new <code>src/vga.rs</code> file.</li>
</ul>
<!--

## Colors

- Represent colors using an `enum`:

```{.rs filename="src/vga.rs"}
#[allow(dead_code)]
#[derive(Debug, Clone, Copy, PartialEq, Eq)]
#[repr(u8)]
pub enum Color {
    Blck = 0o00,
    Blue = 0o01,
    Gren = 0o02,
    Cyan = 0o03,
    Redd = 0o04,
    Mgnt = 0o05,
    Brwn = 0o06,
    LGry = 0o07,
    DGry = 0o10,
    LBlu = 0o11,
    LGrn = 0o12,
    LCyn = 0o13,
    LRed = 0o14,
    Pink = 0o15,
    Yelo = 0o16,
    Whte = 0o17,
}
```

## Notes

- We use a [C-like enum] here to explicitly specify the number for each color. 
- Because of the `repr(u8)` attribute, each enum variant is stored as a `u8`. 
    - I would use `u4` type (a nib) if I was allowed to.
-  Rust on the [C-like enum](https://doc.rust-lang.org/rust-by-example/custom_types/enum/c_like.html)
    - At some point we have to figure out why we aren't writing C.

## Suppress Warnings

- Normally the compiler would issue a warning for each unused variant. 
    - This seems obviously annoying to me.
- By using the `#[allow(dead_code)]` attribute, we disable these warnings for the `Color` enum.

## Comparisons

- By [deriving] the [`Copy`], [`Clone`], [`Debug`], [`PartialEq`], and [`Eq`] traits, we:
    - Get stack-like (vs. heap-like) behavior.
    - Make it printable.
    - Make it comparable (e.g. via double-equals-equality `==`)
- I would obviously just use an u8 here but don't be like me, I am wrong in some way that may be important latter.

## Links

- [deriving](https://doc.rust-lang.org/rust-by-example/trait/derive.html)
- [`Copy`](https://doc.rust-lang.org/nightly/core/marker/trait.Copy.html)
- [`Clone`](https://doc.rust-lang.org/nightly/core/clone/trait.Clone.html)
- [`Debug`](https://doc.rust-lang.org/nightly/core/fmt/trait.Debug.html)
- [`PartialEq`](https://doc.rust-lang.org/nightly/core/cmp/trait.PartialEq.html)
- [`Eq`](https://doc.rust-lang.org/nightly/core/cmp/trait.Eq.html)
- [copy semantics](https://doc.rust-lang.org/1.30.0/book/first-edition/ownership.html#copy-types)


## New Type

- A full color code specifies foreground *and* background color
- We create a [newtype](https://doc.rust-lang.org/rust-by-example/generics/new_types.html) on top of `u8`


```{.rs filename="src/vga.rs"}
#[derive(Debug, Clone, Copy, PartialEq, Eq)]
#[repr(transparent)]
struct ColorCode(u8);

impl ColorCode {
    fn new(fg: Color, b: Color) -> ColorCode {
        ColorCode((bg as u8) << 4 | (fg as u8))
    }
}
```

## Transparency

- Again, we derive the `Copy` and `Debug` traits for it. 
- When working with low level devices, we need to ensure bits are where we expect them to be.
- To ensure that the `ColorCode` has the exact same data layout as a `u8`, we use the [`repr(transparent)`] attribute.
    - [Read more](https://doc.rust-lang.org/nomicon/other-reprs.html#reprtransparent)
<!--
## Text Buffer

- Now we can add structures to represent a screen character and the text buffer:

```{.rs filename="src/vga.rs"}
#[derive(Debug, Clone, Copy, PartialEq, Eq)]
#[repr(C)]
struct ScreenChar {
    ascii_character: u8,
    color_code: ColorCode,
}

const BUFFER_HEIGHT: usize = 25;
const BUFFER_WIDTH: usize = 80;

#[repr(transparent)]
struct Buffer {
    chars: [[ScreenChar; BUFFER_WIDTH]; BUFFER_HEIGHT],
}
```

## C Representation

- Field ordering in default structs is undefined in Rust!
- Not so in the good language, C.
- We use the [`repr(C)`] attribute. 
  - It guarantees that the struct's fields are laid out in order. `
  - [`repr(C)`](https://doc.rust-lang.org/nightly/nomicon/other-reprs.html#reprc)
- For the `Buffer` struct, we use [`repr(transparent)`] again to ensure that it has the same memory layout as its single field.
-->
</section>
<section id="standard-out" class="level2">
<h2 class="anchored" data-anchor-id="standard-out">Standard Out</h2>
<ul>
<li>To provide “standard out” like functionality, I will:
<ul>
<li>Maintain the most recent position to which a character has been written.</li>
</ul></li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/vga.rs</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" data-filename="src/vga.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb3-1"><a href="#cb3-1"></a><span class="kw">static</span> <span class="kw">mut</span> latest<span class="op">:</span> <span class="dt">usize</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="location" class="level2">
<h2 class="anchored" data-anchor-id="location">Location</h2>
<ul>
<li>To provide “standard out” like functionality, I will:
<ul>
<li>Maintain the most recent position to which a character has been written.</li>
<li>Have a constant referring to to the VGA buffer address.</li>
</ul></li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/vga.rs</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" data-filename="src/vga.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb4-1"><a href="#cb4-1"></a><span class="kw">static</span> <span class="kw">mut</span> latest<span class="op">:</span> <span class="dt">usize</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="kw">const</span> MMIO<span class="op">:</span> <span class="dt">usize</span> <span class="op">=</span> <span class="dv">0xb8000</span><span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="color" class="level2">
<h2 class="anchored" data-anchor-id="color">Color</h2>
<ul>
<li>To provide “standard out” like functionality, I will:
<ul>
<li>Provide a way to write a character.
<ul>
<li>I will use a <code>const</code> for color and not worry about.</li>
</ul></li>
</ul></li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/vga.rs</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5" data-filename="src/vga.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb5-1"><a href="#cb5-1"></a><span class="kw">static</span> <span class="kw">mut</span> latest<span class="op">:</span> <span class="dt">usize</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="kw">const</span> MMIO<span class="op">:</span> <span class="dt">usize</span> <span class="op">=</span> <span class="dv">0xb8000</span><span class="op">;</span></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="kw">const</span> COLOR<span class="op">:</span> <span class="dt">u8</span> <span class="op">=</span> <span class="dv">0xF</span><span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="character-wise" class="level2">
<h2 class="anchored" data-anchor-id="character-wise">Character-wise</h2>
<ul>
<li>To provide “standard out” like functionality, I will:
<ul>
<li>Provide a way to write a character.
<ul>
<li>I will write a function to push one character.</li>
</ul></li>
</ul></li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/vga.rs</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6" data-filename="src/vga.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb6-1"><a href="#cb6-1"></a><span class="co">// Public for now</span></span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="kw">pub</span> <span class="kw">fn</span> char_to_vga(a<span class="op">:</span> <span class="dt">u8</span>) <span class="op">{</span></span>
<span id="cb6-3"><a href="#cb6-3"></a>    <span class="pp">todo!</span>()<span class="op">;</span></span>
<span id="cb6-4"><a href="#cb6-4"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="stepwise" class="level2">
<h2 class="anchored" data-anchor-id="stepwise">Stepwise</h2>
<ol type="1">
<li>Compute absolute location from relative location.</li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/vga.rs</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7" data-filename="src/vga.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb7-1"><a href="#cb7-1"></a><span class="co">// Public for now</span></span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="kw">pub</span> <span class="kw">fn</span> char_to_vga(a<span class="op">:</span> <span class="dt">u8</span>) <span class="op">{</span></span>
<span id="cb7-3"><a href="#cb7-3"></a>    <span class="kw">let</span> rel<span class="op">:</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">u8</span> <span class="op">=</span> (MMIO <span class="op">+</span> (latest <span class="op">*</span> <span class="dv">2</span>)) <span class="kw">as</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">u8</span><span class="op">;</span></span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="stepwise-1" class="level2">
<h2 class="anchored" data-anchor-id="stepwise-1">Stepwise</h2>
<ol type="1">
<li>Compute absolute location from relative location.</li>
<li>Store a value at that location.</li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/vga.rs</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8" data-filename="src/vga.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb8-1"><a href="#cb8-1"></a><span class="co">// Public for now</span></span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="kw">pub</span> <span class="kw">fn</span> char_to_vga(a<span class="op">:</span> <span class="dt">u8</span>) <span class="op">{</span></span>
<span id="cb8-3"><a href="#cb8-3"></a>    <span class="kw">let</span> rel<span class="op">:</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">u8</span> <span class="op">=</span> (MMIO <span class="op">+</span> (latest <span class="op">*</span> <span class="dv">2</span>)) <span class="kw">as</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">u8</span><span class="op">;</span></span>
<span id="cb8-4"><a href="#cb8-4"></a>    <span class="op">*</span>rel <span class="op">=</span> a<span class="op">;</span></span>
<span id="cb8-5"><a href="#cb8-5"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="stepwise-2" class="level2">
<h2 class="anchored" data-anchor-id="stepwise-2">Stepwise</h2>
<ol type="1">
<li>Compute absolute location from relative location.</li>
<li>Store a value at that location.</li>
<li>Store a color at the next location.</li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/vga.rs</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9" data-filename="src/vga.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb9-1"><a href="#cb9-1"></a><span class="co">// Public for now</span></span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="kw">pub</span> <span class="kw">fn</span> char_to_vga(a<span class="op">:</span> <span class="dt">u8</span>) <span class="op">{</span></span>
<span id="cb9-3"><a href="#cb9-3"></a>    <span class="kw">let</span> rel<span class="op">:</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">u8</span> <span class="op">=</span> (MMIO <span class="op">+</span> (latest <span class="op">*</span> <span class="dv">2</span>)) <span class="kw">as</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">u8</span><span class="op">;</span></span>
<span id="cb9-4"><a href="#cb9-4"></a>    <span class="op">*</span>rel <span class="op">=</span> a<span class="op">;</span></span>
<span id="cb9-5"><a href="#cb9-5"></a>    <span class="op">*</span>((rel <span class="kw">as</span> <span class="dt">usize</span> <span class="op">+</span> <span class="dv">1</span>) <span class="kw">as</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">u8</span>) <span class="op">=</span> COLOR<span class="op">;</span></span>
<span id="cb9-6"><a href="#cb9-6"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="stepwise-3" class="level2">
<h2 class="anchored" data-anchor-id="stepwise-3">Stepwise</h2>
<ol type="1">
<li>Compute absolute location from relative location.</li>
<li>Store a value at that location.</li>
<li>Store a color at the next location.</li>
<li>Increment the latest.</li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/vga.rs</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10" data-filename="src/vga.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb10-1"><a href="#cb10-1"></a><span class="co">// Public for now</span></span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="kw">pub</span> <span class="kw">fn</span> char_to_vga(a<span class="op">:</span> <span class="dt">u8</span>) <span class="op">{</span></span>
<span id="cb10-3"><a href="#cb10-3"></a>    <span class="kw">let</span> rel<span class="op">:</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">u8</span> <span class="op">=</span> (MMIO <span class="op">+</span> (latest <span class="op">*</span> <span class="dv">2</span>)) <span class="kw">as</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">u8</span><span class="op">;</span></span>
<span id="cb10-4"><a href="#cb10-4"></a>    <span class="op">*</span>rel <span class="op">=</span> a<span class="op">;</span></span>
<span id="cb10-5"><a href="#cb10-5"></a>    <span class="op">*</span>((rel <span class="kw">as</span> <span class="dt">usize</span> <span class="op">+</span> <span class="dv">1</span>) <span class="kw">as</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">u8</span>) <span class="op">=</span> COLOR<span class="op">;</span></span>
<span id="cb10-6"><a href="#cb10-6"></a>    LATEST <span class="op">=</span> LATEST <span class="op">+</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb10-7"><a href="#cb10-7"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="test-it" class="level2">
<h2 class="anchored" data-anchor-id="test-it">Test it</h2>
<ul>
<li>It is trivial to test.</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/main.rs</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11" data-filename="src/main.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb11-1"><a href="#cb11-1"></a>    <span class="kw">let</span> hi<span class="op">:</span> <span class="op">&amp;</span>[<span class="dt">u8</span>] <span class="op">=</span> <span class="st">b"Hello World!"</span><span class="op">;</span></span>
<span id="cb11-2"><a href="#cb11-2"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="dv">0</span><span class="op">..</span><span class="dv">12</span> <span class="op">{</span></span>
<span id="cb11-3"><a href="#cb11-3"></a>        <span class="pp">vga::</span>char_to_vga(hi[i])<span class="op">;</span></span>
<span id="cb11-4"><a href="#cb11-4"></a>    <span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<ul>
<li>“Works on my machine!” - me
<ul>
<li>Unless?</li>
<li>We’ll come back to this.</li>
</ul></li>
</ul>
</section>
<section id="annoying" class="level2">
<h2 class="anchored" data-anchor-id="annoying">Annoying</h2>
<ul>
<li>Some of you may lack a strong work ethic and want to show entire a whole <em>string</em> rather than just a character at a time.
<ul>
<li>Especially since using characters of a string in Rust is ludicrously opaque.</li>
</ul></li>
<li>Not to worry.</li>
</ul>
</section>
<section id="target-str" class="level2">
<h2 class="anchored" data-anchor-id="target-str">Target <code>&amp;str</code></h2>
<ul>
<li>We can abstract to loop into <code>src/vga.rs</code></li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/vga.rs</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12" data-filename="src/vga.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb12-1"><a href="#cb12-1"></a><span class="kw">pub</span> <span class="kw">fn</span> str_to_vga(s<span class="op">:</span> <span class="op">&amp;</span><span class="dt">str</span>) <span class="op">{</span></span>
<span id="cb12-2"><a href="#cb12-2"></a>    <span class="kw">let</span> v <span class="op">=</span> s<span class="op">.</span>as_bytes()<span class="op">;</span></span>
<span id="cb12-3"><a href="#cb12-3"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="dv">0</span><span class="op">..</span>v<span class="op">.</span>len() <span class="op">{</span></span>
<span id="cb12-4"><a href="#cb12-4"></a>        char_to_vga(v[i])<span class="op">;</span></span>
<span id="cb12-5"><a href="#cb12-5"></a>    <span class="op">}</span></span>
<span id="cb12-6"><a href="#cb12-6"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="aside" class="level2">
<h2 class="anchored" data-anchor-id="aside">Aside</h2>
<ul>
<li>I am opinionated on <code>as_bytes</code>.</li>
<li>Let’s check some links.
<ul>
<li><a href="https://doc.rust-lang.org/std/?search=to_bytes"><code>to_bytes</code></a></li>
<li><a href="https://doc.rust-lang.org/std/?search=as_bytes"><code>as_bytes</code></a></li>
<li><a href="https://doc.rust-lang.org/std/?search=bytes"><code>bytes</code></a></li>
</ul></li>
<li>Can you guess what always works?</li>
</ul>
</section>
<section id="aside-1" class="level2">
<h2 class="anchored" data-anchor-id="aside-1">Aside</h2>
<ul>
<li>Big Rust doesn’t want you to know you can use pointers.</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/vga.rs</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13" data-filename="src/vga.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb13-1"><a href="#cb13-1"></a>    <span class="kw">let</span> ptr <span class="op">=</span> s<span class="op">.</span>as_ptr() <span class="kw">as</span> <span class="dt">usize</span><span class="op">;</span></span>
<span id="cb13-2"><a href="#cb13-2"></a>    <span class="kw">unsafe</span> <span class="op">{</span></span>
<span id="cb13-3"><a href="#cb13-3"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="dv">0</span><span class="op">..</span>s<span class="op">.</span>len() <span class="op">{</span></span>
<span id="cb13-4"><a href="#cb13-4"></a>            char_to_vga(<span class="op">*</span>((ptr <span class="op">+</span> i) <span class="kw">as</span> <span class="op">*</span><span class="kw">const</span> <span class="dt">u8</span>))<span class="op">;</span></span>
<span id="cb13-5"><a href="#cb13-5"></a>        <span class="op">}</span></span>
<span id="cb13-6"><a href="#cb13-6"></a>    <span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<ul>
<li>I could make this even worse but I didn’t.</li>
<li>Anyways don’t do this.</li>
</ul>
</section>
<section id="update-main" class="level2">
<h2 class="anchored" data-anchor-id="update-main">Update main</h2>
<ul>
<li>Look how nice that is!</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/main.rs</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14" data-filename="src/main.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb14-1"><a href="#cb14-1"></a><span class="at">#[</span><span class="kw">unsafe</span><span class="at">(</span>no_mangle<span class="at">)]</span></span>
<span id="cb14-2"><a href="#cb14-2"></a><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">"C"</span> <span class="kw">fn</span> _start() <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb14-3"><a href="#cb14-3"></a>    <span class="pp">vga::</span>str_to_vga(<span class="st">"Hello, world!"</span>)<span class="op">;</span></span>
<span id="cb14-4"><a href="#cb14-4"></a>    <span class="cf">loop</span> <span class="op">{}</span></span>
<span id="cb14-5"><a href="#cb14-5"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="i-bet" class="level2">
<h2 class="anchored" data-anchor-id="i-bet">I bet…</h2>
<ul>
<li>I bet we can print <em>any</em> string.</li>
<li>Let’s do like a comically easy string that will definitely print.</li>
<li>There’s no way it will fail.</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/main.rs</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15" data-filename="src/main.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb15-1"><a href="#cb15-1"></a>    <span class="pp">vga::</span>str_to_vga(<span class="st">"Hello</span><span class="sc">\n</span><span class="st">world!"</span>)<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<ul>
<li>It worked right?</li>
</ul>
</section>
<section id="escape-codes" class="level2">
<h2 class="anchored" data-anchor-id="escape-codes">Escape Codes</h2>
<ul>
<li>Okay so there’s some things we need to treat differently.
<ul>
<li>Minimally <code>\n</code>.</li>
<li>And therefore also <code>\\</code> to show a single backslash.</li>
<li>I don’t even know if we need anything else, but I’ll show the design pattern.</li>
</ul></li>
</ul>
</section>
<section id="revisit-implementation" class="level2">
<h2 class="anchored" data-anchor-id="revisit-implementation">Revisit Implementation</h2>
<ul>
<li>Recall our naive implementation.</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/vga.rs</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb16" data-filename="src/vga.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb16-1"><a href="#cb16-1"></a><span class="kw">pub</span> <span class="kw">fn</span> str_to_vga(s<span class="op">:</span> <span class="op">&amp;</span><span class="dt">str</span>) <span class="op">{</span></span>
<span id="cb16-2"><a href="#cb16-2"></a>    <span class="kw">let</span> v <span class="op">=</span> s<span class="op">.</span>as_bytes()<span class="op">;</span></span>
<span id="cb16-3"><a href="#cb16-3"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="dv">0</span><span class="op">..</span>v<span class="op">.</span>len() <span class="op">{</span></span>
<span id="cb16-4"><a href="#cb16-4"></a>        char_to_vga(v[i])<span class="op">;</span></span>
<span id="cb16-5"><a href="#cb16-5"></a>    <span class="op">}</span></span>
<span id="cb16-6"><a href="#cb16-6"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="case-analysis" class="level2">
<h2 class="anchored" data-anchor-id="case-analysis">Case analysis</h2>
<ul>
<li>As far as I know (I didn’t check) we only have to look for is:
<ul>
<li><code>\n</code></li>
<li><code>10</code> (I think?)</li>
<li><code>0xa</code></li>
</ul></li>
<li>It will be a <code>u8</code> within the loop (since we <code>as_bytes</code> first)</li>
</ul>
</section>
<section id="trust-but-verify" class="level2">
<h2 class="anchored" data-anchor-id="trust-but-verify">Trust but verify</h2>
<ul>
<li>I just checked in a different crate.</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>../???/src/main.rs</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb17" data-filename="../???/src/main.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb17-1"><a href="#cb17-1"></a><span class="kw">fn</span> main() <span class="op">{</span></span>
<span id="cb17-2"><a href="#cb17-2"></a>    <span class="kw">let</span> s <span class="op">=</span> <span class="st">"Hello</span><span class="sc">\n</span><span class="st">world!"</span><span class="op">;</span></span>
<span id="cb17-3"><a href="#cb17-3"></a>    <span class="pp">dbg!</span>(s<span class="op">.</span>as_bytes())<span class="op">;</span></span>
<span id="cb17-4"><a href="#cb17-4"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<ul>
<li>Looked like 10 to me.</li>
</ul>
</section>
<section id="now-it-works" class="level2">
<h2 class="anchored" data-anchor-id="now-it-works">Now it works!</h2>
<ul>
<li>We can write vertically!
<ul>
<li>I guess this could be a helper function or something.</li>
</ul></li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/main.rs</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb18" data-filename="src/main.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb18-1"><a href="#cb18-1"></a>    <span class="pp">vga::</span>str_to_vga(<span class="st">"H</span><span class="sc">\n</span><span class="st">e</span><span class="sc">\n</span><span class="st">l</span><span class="sc">\n</span><span class="st">l</span><span class="sc">\n</span><span class="st">o</span><span class="sc">\n\n</span><span class="st">w</span><span class="sc">\n</span><span class="st">o</span><span class="sc">\n</span><span class="st">r</span><span class="sc">\n</span><span class="st">l</span><span class="sc">\n</span><span class="st">d</span><span class="sc">\n</span><span class="st">!"</span>)<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="good-thing" class="level2">
<h2 class="anchored" data-anchor-id="good-thing">Good thing…</h2>
<ul>
<li>I can print that more than once!</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/main.rs</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb19" data-filename="src/main.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb19-1"><a href="#cb19-1"></a>    <span class="cf">for</span> _i <span class="kw">in</span> <span class="dv">0</span><span class="op">..</span><span class="dv">3</span> <span class="op">{</span></span>
<span id="cb19-2"><a href="#cb19-2"></a>        <span class="pp">vga::</span>str_to_vga(<span class="st">"H</span><span class="sc">\n</span><span class="st">e</span><span class="sc">\n</span><span class="st">l</span><span class="sc">\n</span><span class="st">l</span><span class="sc">\n</span><span class="st">o</span><span class="sc">\n\n</span><span class="st">w</span><span class="sc">\n</span><span class="st">o</span><span class="sc">\n</span><span class="st">r</span><span class="sc">\n</span><span class="st">l</span><span class="sc">\n</span><span class="st">d</span><span class="sc">\n</span><span class="st">!"</span>)<span class="op">;</span></span>
<span id="cb19-3"><a href="#cb19-3"></a>    <span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<ul>
<li>Wait a minute!</li>
</ul>
</section>
<section id="were-doomed" class="level2">
<h2 class="anchored" data-anchor-id="were-doomed">We’re doomed</h2>
<ul>
<li>We didn’t save what was written to the previous lines.</li>
<li>Real ones know.</li>
</ul>
<p><img src="https://upload.wikimedia.org/wikipedia/en/1/16/BladeRunnerRoyBattySpeech.jpeg" class="img-fluid"></p>
</section>
<section id="unless" class="level2">
<h2 class="anchored" data-anchor-id="unless">Unless?</h2>
<ul>
<li>No way can we <em>read</em> from the VGA text buffer right.</li>
<li>That would be… extraordinary.</li>
<li>You can do whatever you want, I just want to show you one possible design choice.
<ul>
<li>Mostly as a proof of concept.</li>
</ul></li>
</ul>
</section>
<section id="scroll" class="level2">
<h2 class="anchored" data-anchor-id="scroll">Scroll</h2>
<ul>
<li>I’ll add some <code>const</code>s and write a helper.</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/vga.rs</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb20" data-filename="src/vga.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb20-1"><a href="#cb20-1"></a><span class="kw">const</span> ROWS<span class="op">:</span> <span class="dt">usize</span> <span class="op">=</span> <span class="dv">80</span><span class="op">;</span></span>
<span id="cb20-2"><a href="#cb20-2"></a><span class="kw">const</span> COLS<span class="op">:</span> <span class="dt">usize</span> <span class="op">=</span> <span class="dv">25</span><span class="op">;</span></span>
<span id="cb20-3"><a href="#cb20-3"></a><span class="kw">const</span> <span class="cn">MAX</span><span class="op">:</span> <span class="dt">usize</span> <span class="op">=</span> ROWS <span class="op">*</span> COLS<span class="op">;</span></span>
<span id="cb20-4"><a href="#cb20-4"></a></span>
<span id="cb20-5"><a href="#cb20-5"></a><span class="kw">fn</span> scroll() <span class="op">{</span></span>
<span id="cb20-6"><a href="#cb20-6"></a>    <span class="pp">todo!</span>()<span class="op">;</span></span>
<span id="cb20-7"><a href="#cb20-7"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="execution" class="level2">
<h2 class="anchored" data-anchor-id="execution">Execution</h2>
<ul>
<li>Start at the first character that will remain visible.</li>
<li>Copy it to the earliest visible slot (start of buffer).</li>
<li>Iterate until the full buffer is moved.</li>
<li>We note this could be executed in a single <code>memmove</code>
<ul>
<li><a href="https://man7.org/linux/man-pages/man3/memmove.3.html">Read more</a></li>
</ul></li>
</ul>
</section>
<section id="my-code" class="level2">
<h2 class="anchored" data-anchor-id="my-code">My Code</h2>
<ul>
<li>Public just to test.</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/vga.rs</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb21" data-filename="src/vga.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb21-1"><a href="#cb21-1"></a><span class="kw">pub</span> <span class="kw">fn</span> scroll() <span class="op">{</span></span>
<span id="cb21-2"><a href="#cb21-2"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="dv">80</span><span class="op">..</span><span class="cn">MAX</span> <span class="op">{</span></span>
<span id="cb21-3"><a href="#cb21-3"></a>        <span class="kw">unsafe</span> <span class="op">{</span></span>
<span id="cb21-4"><a href="#cb21-4"></a>            <span class="kw">let</span> src<span class="op">:</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">u8</span> <span class="op">=</span> ((MMIO <span class="kw">as</span> <span class="dt">usize</span>) <span class="op">+</span> (i <span class="op">*</span> <span class="dv">2</span>)) <span class="kw">as</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">u8</span><span class="op">;</span></span>
<span id="cb21-5"><a href="#cb21-5"></a>            <span class="kw">let</span> dst<span class="op">:</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">u8</span> <span class="op">=</span> ((MMIO <span class="kw">as</span> <span class="dt">usize</span>) <span class="op">+</span> ((i <span class="op">-</span> <span class="dv">80</span>) <span class="op">*</span> <span class="dv">2</span>)) <span class="kw">as</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">u8</span><span class="op">;</span></span>
<span id="cb21-6"><a href="#cb21-6"></a>            <span class="op">*</span>dst <span class="op">=</span> <span class="op">*</span>src<span class="op">;</span></span>
<span id="cb21-7"><a href="#cb21-7"></a>        <span class="op">}</span></span>
<span id="cb21-8"><a href="#cb21-8"></a>    <span class="op">}</span></span>
<span id="cb21-9"><a href="#cb21-9"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="my-test" class="level2">
<h2 class="anchored" data-anchor-id="my-test">My Test</h2>
<ul>
<li>I just sent line numbers then manually scrolled.</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/main.rs</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb22" data-filename="src/main.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb22-1"><a href="#cb22-1"></a>    <span class="pp">vga::</span>str_to_vga(<span class="st">"0</span><span class="sc">\n</span><span class="st">1</span><span class="sc">\n</span><span class="st">2</span><span class="sc">\n</span><span class="st">3</span><span class="sc">\n</span><span class="st">4</span><span class="sc">\n</span><span class="st">5</span><span class="sc">\n</span><span class="st">6</span><span class="sc">\n</span><span class="st">7</span><span class="sc">\n</span><span class="st">8</span><span class="sc">\n</span><span class="st">9</span><span class="sc">\n</span><span class="st">A</span><span class="sc">\n</span><span class="st">B"</span>)<span class="op">;</span></span>
<span id="cb22-2"><a href="#cb22-2"></a>    <span class="pp">vga::</span>scroll()<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="a-better-test" class="level2">
<h2 class="anchored" data-anchor-id="a-better-test">A better test</h2>
<ul>
<li>Here is a copy of the Project Gutenburg ebook of <em>Pride and Prejudice</em>.</li>
<li>It contains some quotes which might be a problem.</li>
<li><a href="https://raw.githubusercontent.com/cd-public/books/main/pg1342.txt">Link</a></li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb23"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1"></a><span class="ex">https://raw.githubusercontent.com/cd-public/books/main/pg1342.txt</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="does-it-work" class="level2">
<h2 class="anchored" data-anchor-id="does-it-work">Does it work?</h2>
<ul>
<li>What do we have to do?</li>
</ul>
<details>
<ol type="1">
<li>Add <code>scroll</code> to <code>str_to_vga</code></li>
<li>Update <code>LATEST</code> in <code>scroll</code></li>
<li>Blank out the last line, I used space (<code>0x20</code> or <code>32</code>)</li>
<li>Make sure <strong>all</strong> color bytes are set.</li>
</ol>
</details>
</section>
<section id="why-do-we-blank-out" class="level2">
<h2 class="anchored" data-anchor-id="why-do-we-blank-out">Why do we blank out?</h2>
<ul>
<li>Recall we are writing to MMIO.</li>
<li>As soon as we exceed the MMIO range, we can <em>make no claims</em> about what memory we are vviewing.</li>
<li>So if we copy in data past the buffer, we could get <em>anything</em>.</li>
<li>So if we don’t overwrite the buffer, we could get <em>anything</em>.</li>
</ul>
</section>
<section id="we-set-color-bytes" class="level2">
<h2 class="anchored" data-anchor-id="we-set-color-bytes">We set color bytes?</h2>
<ul>
<li>Like lines off the MMIO range, the color bytes have no known value.</li>
<li>So if we e.g.&nbsp;have a newline anywhere and end up not initially setting colors…</li>
<li>Then copy text up to that line…</li>
<li>We will be showing text in an <em>unset</em> color.
<ul>
<li>Just whatever bits happened to be there!</li>
</ul></li>
</ul>
</section>
<section id="this-is-unsafe" class="level2">
<h2 class="anchored" data-anchor-id="this-is-unsafe">This is unsafe!</h2>
<ul>
<li>Astute learners will notice this is all very unsafe.</li>
</ul>
</section>
<section id="im-loopy" class="level2">
<h2 class="anchored" data-anchor-id="im-loopy">I’m loopy</h2>
<ul>
<li>I should not I do everything with <code>for</code> loops and “single-equals-assignment”
<ul>
<li>I mostly am teaching you <em>how to code</em></li>
<li>This is NOT teaching you <em>how to Rust</em> (or C)</li>
</ul></li>
<li>Who needs <code>memmove</code> (a C function) when we have the humble <code>for</code> loop.</li>
<li>Read more: <a href="https://doc.rust-lang.org/core/ptr/fn.copy.html">core::ptr::copy</a></li>
</ul>
</section>
<section id="caution" class="level2">
<h2 class="anchored" data-anchor-id="caution">Caution!</h2>
<ul>
<li>I am building my crate without access to <code>memmove</code>.</li>
<li>You may need to go back and add some configuration.</li>
<li>This was covered in the “Kernel” lecture.
<ul>
<li><a href="./40_kernel.html#aside-notfutureproofing-1">Here</a></li>
</ul></li>
</ul>
</section>
<section id="my-solution" class="level2">
<h2 class="anchored" data-anchor-id="my-solution">My solution</h2>
<details>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/vga.rs</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb24" data-filename="src/vga.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb24-1"><a href="#cb24-1"></a><span class="kw">const</span> ROWS<span class="op">:</span> <span class="dt">usize</span> <span class="op">=</span> <span class="dv">80</span><span class="op">;</span></span>
<span id="cb24-2"><a href="#cb24-2"></a><span class="kw">const</span> COLS<span class="op">:</span> <span class="dt">usize</span> <span class="op">=</span> <span class="dv">25</span><span class="op">;</span></span>
<span id="cb24-3"><a href="#cb24-3"></a><span class="kw">const</span> <span class="cn">MAX</span><span class="op">:</span> <span class="dt">usize</span> <span class="op">=</span> ROWS <span class="op">*</span> COLS<span class="op">;</span></span>
<span id="cb24-4"><a href="#cb24-4"></a></span>
<span id="cb24-5"><a href="#cb24-5"></a><span class="kw">fn</span> scroll() <span class="op">{</span></span>
<span id="cb24-6"><a href="#cb24-6"></a>    <span class="kw">unsafe</span> <span class="op">{</span></span>
<span id="cb24-7"><a href="#cb24-7"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="dv">80</span><span class="op">..</span><span class="cn">MAX</span> <span class="op">{</span></span>
<span id="cb24-8"><a href="#cb24-8"></a>            <span class="kw">let</span> src<span class="op">:</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">u8</span> <span class="op">=</span> (MMIO <span class="op">+</span> i <span class="op">*</span> <span class="dv">2</span>) <span class="kw">as</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">u8</span><span class="op">;</span></span>
<span id="cb24-9"><a href="#cb24-9"></a>            <span class="kw">let</span> dst<span class="op">:</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">u8</span> <span class="op">=</span> (MMIO <span class="op">+</span> (i <span class="op">-</span> <span class="dv">80</span>) <span class="op">*</span> <span class="dv">2</span>)) <span class="kw">as</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">u8</span><span class="op">;</span></span>
<span id="cb24-10"><a href="#cb24-10"></a>            <span class="op">*</span>dst <span class="op">=</span> <span class="op">*</span>src<span class="op">;</span></span>
<span id="cb24-11"><a href="#cb24-11"></a>            <span class="op">*</span>((dst <span class="kw">as</span> <span class="dt">usize</span> <span class="op">+</span> <span class="dv">1</span>) <span class="kw">as</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">u8</span>) <span class="op">=</span> COLOR<span class="op">;</span></span>
<span id="cb24-12"><a href="#cb24-12"></a>        <span class="op">}</span></span>
<span id="cb24-13"><a href="#cb24-13"></a>        <span class="cf">for</span> i <span class="kw">in</span> (<span class="cn">MAX</span><span class="op">-</span><span class="dv">80</span>)<span class="op">..</span><span class="cn">MAX</span> <span class="op">{</span></span>
<span id="cb24-14"><a href="#cb24-14"></a>            <span class="kw">let</span> dst<span class="op">:</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">u8</span> <span class="op">=</span> (MMIO <span class="op">+</span> i <span class="op">*</span> <span class="dv">2</span>) <span class="kw">as</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">u8</span><span class="op">;</span></span>
<span id="cb24-15"><a href="#cb24-15"></a>            <span class="op">*</span>dst <span class="op">=</span> <span class="dv">32</span><span class="op">;</span></span>
<span id="cb24-16"><a href="#cb24-16"></a>            <span class="op">*</span>((dst <span class="kw">as</span> <span class="dt">usize</span> <span class="op">+</span> <span class="dv">1</span>) <span class="kw">as</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">u8</span>) <span class="op">=</span> COLOR<span class="op">;</span></span>
<span id="cb24-17"><a href="#cb24-17"></a>        <span class="op">}</span></span>
<span id="cb24-18"><a href="#cb24-18"></a>        LATEST <span class="op">=</span> LATEST <span class="op">-</span> <span class="dv">80</span><span class="op">;</span></span>
<span id="cb24-19"><a href="#cb24-19"></a>    <span class="op">}</span></span>
<span id="cb24-20"><a href="#cb24-20"></a><span class="op">}</span></span>
<span id="cb24-21"><a href="#cb24-21"></a></span>
<span id="cb24-22"><a href="#cb24-22"></a><span class="kw">pub</span> <span class="kw">fn</span> str_to_vga(s<span class="op">:</span> <span class="op">&amp;</span><span class="dt">str</span>) <span class="op">{</span></span>
<span id="cb24-23"><a href="#cb24-23"></a>    <span class="kw">let</span> v <span class="op">=</span> s<span class="op">.</span>as_bytes()<span class="op">;</span></span>
<span id="cb24-24"><a href="#cb24-24"></a>    <span class="kw">unsafe</span> <span class="op">{</span></span>
<span id="cb24-25"><a href="#cb24-25"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="dv">0</span><span class="op">..</span>v<span class="op">.</span>len() <span class="op">{</span></span>
<span id="cb24-26"><a href="#cb24-26"></a>            <span class="cf">if</span> LATEST <span class="op">&gt;</span> <span class="cn">MAX</span> <span class="op">{</span></span>
<span id="cb24-27"><a href="#cb24-27"></a>                scroll()<span class="op">;</span></span>
<span id="cb24-28"><a href="#cb24-28"></a>            <span class="op">}</span></span>
<span id="cb24-29"><a href="#cb24-29"></a>            <span class="cf">match</span> v[i] <span class="op">{</span></span>
<span id="cb24-30"><a href="#cb24-30"></a>                <span class="dv">10</span> <span class="op">=&gt;</span> LATEST <span class="op">=</span> ((LATEST <span class="op">/</span> <span class="dv">80</span>) <span class="op">+</span> <span class="dv">1</span>) <span class="op">*</span> <span class="dv">80</span><span class="op">,</span></span>
<span id="cb24-31"><a href="#cb24-31"></a>                _ <span class="op">=&gt;</span> char_to_vga(v[i])<span class="op">,</span></span>
<span id="cb24-32"><a href="#cb24-32"></a>            <span class="op">}</span></span>
<span id="cb24-33"><a href="#cb24-33"></a>        <span class="op">}</span></span>
<span id="cb24-34"><a href="#cb24-34"></a>    <span class="op">}</span></span>
<span id="cb24-35"><a href="#cb24-35"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</details>
</section>
</section>
<section id="volatile" class="level1">
<h1>Volatile</h1>
<section id="best-practice" class="level2">
<h2 class="anchored" data-anchor-id="best-practice">Best Practice</h2>
<ul>
<li>This works on my machine.</li>
<li>It may not always work.</li>
<li>Why? <code>rustc</code> is a bit too smart.
<ul>
<li>There is no obvious externally observable reason to write to fixed memory location.</li>
<li>The compiler may optimize out such writes.</li>
<li>I say “sure it will.”</li>
</ul></li>
</ul>
</section>
<section id="quote-blog" class="level2">
<h2 class="anchored" data-anchor-id="quote-blog">Quote Blog</h2>
<blockquote class="blockquote">
<p>The problem is that we only write to the buffer and never read from it again.</p>
</blockquote>
<ul>
<li>Okay so but here me out.</li>
<li>Our implementation does read from the buffer again.
<ul>
<li>Sometimes the best way to do things is also the simplest.</li>
<li>For some reason blog kept a local copy and only used that?</li>
</ul></li>
</ul>
</section>
<section id="volatile-1" class="level2">
<h2 class="anchored" data-anchor-id="volatile-1">Volatile</h2>
<ul>
<li>If we lacked the skill and bravery of the instructor of this course, we may have a problem.</li>
<li>To avoid an erroneous optimization omitting all writes, we need to specify writes as <em><a href="#volatile">volatile</a></em>.</li>
<li>This tells the compiler that the write has side effects and should not be optimized away.</li>
<li><a href="https://en.wikipedia.org/wiki/Volatile_(computer_programming)">Read more</a></li>
</ul>
</section>
<section id="interested-students" class="level2">
<h2 class="anchored" data-anchor-id="interested-students">Interested Students</h2>
<ul>
<li>There’s a <code>read_volatile</code> and <code>write_volatile</code> in <code>std::ptr</code> and another in <code>core::ptr</code>, we might be able to use those.</li>
</ul>
</section>
</section>
<section id="fin" class="level1">
<h1>Fin</h1>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./42_hello.html" class="pagination-link" aria-label="Hello">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Hello</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./51_format.html" class="pagination-link" aria-label="Format">
        <span class="nav-page-text">Format</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb25" data-shortcodes="false"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb25-1"><a href="#cb25-1"></a><span class="co">---</span></span>
<span id="cb25-2"><a href="#cb25-2"></a><span class="an">title:</span><span class="co"> Text</span></span>
<span id="cb25-3"><a href="#cb25-3"></a><span class="co">---</span></span>
<span id="cb25-4"><a href="#cb25-4"></a></span>
<span id="cb25-5"><a href="#cb25-5"></a><span class="fu">## Announcements</span></span>
<span id="cb25-6"><a href="#cb25-6"></a></span>
<span id="cb25-7"><a href="#cb25-7"></a><span class="ss">- </span>**Action Items**:</span>
<span id="cb25-8"><a href="#cb25-8"></a><span class="ss">  - </span>Do you text output yet?</span>
<span id="cb25-9"><a href="#cb25-9"></a><span class="ss">    - </span>The coolest assignment ever for a third week in a row.</span>
<span id="cb25-10"><a href="#cb25-10"></a><span class="ss">    - </span>How do I keep getting away with it.</span>
<span id="cb25-11"><a href="#cb25-11"></a></span>
<span id="cb25-12"><a href="#cb25-12"></a><span class="fu">## Citations</span></span>
<span id="cb25-13"><a href="#cb25-13"></a></span>
<span id="cb25-14"><a href="#cb25-14"></a><span class="ss">- </span>I tried to steal this but I thought it was too bad and changed everything. </span>
<span id="cb25-15"><a href="#cb25-15"></a><span class="ss">    - </span><span class="co">[</span><span class="ot">VGA Text Mode</span><span class="co">](https://os.phil-opp.com/vga-text-mode/)</span></span>
<span id="cb25-16"><a href="#cb25-16"></a></span>
<span id="cb25-17"><a href="#cb25-17"></a><span class="fu"># Background</span></span>
<span id="cb25-18"><a href="#cb25-18"></a></span>
<span id="cb25-19"><a href="#cb25-19"></a><span class="fu">## VGA Text Mode</span></span>
<span id="cb25-20"><a href="#cb25-20"></a></span>
<span id="cb25-21"><a href="#cb25-21"></a><span class="ss">- </span>We recall <span class="co">[</span><span class="ot">VGA text mode</span><span class="co">](https://en.wikipedia.org/wiki/VGA-compatible_text_mode)</span> from the homework. </span>
<span id="cb25-22"><a href="#cb25-22"></a><span class="ss">    - </span>A simple way to print text to the screen. </span>
<span id="cb25-23"><a href="#cb25-23"></a><span class="ss">- </span>We recall that Rust prints via a "macro"</span>
<span id="cb25-24"><a href="#cb25-24"></a><span class="ss">- </span>Now we:</span>
<span id="cb25-25"><a href="#cb25-25"></a><span class="ss">    - </span>Create an interface to encapsulating all unsafety in a separate module. </span>
<span id="cb25-26"><a href="#cb25-26"></a><span class="ss">    - </span>We also implement support for Rust's <span class="co">[</span><span class="ot">formatting macros</span><span class="co">](https://en.wikipedia.org/wiki/VGA-compatible_text_mode)</span></span>
<span id="cb25-27"><a href="#cb25-27"></a>    </span>
<span id="cb25-28"><a href="#cb25-28"></a><span class="fu">## The Buffer</span></span>
<span id="cb25-29"><a href="#cb25-29"></a></span>
<span id="cb25-30"><a href="#cb25-30"></a><span class="ss">- </span>To print a character to the screen in VGA text mode, one has to write it to the text buffer of the VGA hardware. </span>
<span id="cb25-31"><a href="#cb25-31"></a><span class="ss">    - </span>A byte passing over a bus to fixed location will render as ASCII on a screen.</span>
<span id="cb25-32"><a href="#cb25-32"></a></span>
<span id="cb25-33"><a href="#cb25-33"></a><span class="fu">## 1d or 2d</span></span>
<span id="cb25-34"><a href="#cb25-34"></a></span>
<span id="cb25-35"><a href="#cb25-35"></a><span class="ss">- </span>The VGA text buffer renders as two-dimensional array.</span>
<span id="cb25-36"><a href="#cb25-36"></a><span class="ss">    - </span>Addressed as a one dimensional array.</span>
<span id="cb25-37"><a href="#cb25-37"></a><span class="ss">    - </span>Safe to assume 25 rows and 80 columns.</span>
<span id="cb25-38"><a href="#cb25-38"></a><span class="ss">    - </span>Each position is an ASCII (*not* unicode) character.</span>
<span id="cb25-39"><a href="#cb25-39"></a>    </span>
<span id="cb25-40"><a href="#cb25-40"></a><span class="fu">## Format</span></span>
<span id="cb25-41"><a href="#cb25-41"></a></span>
<span id="cb25-42"><a href="#cb25-42"></a><span class="ss">- </span>Describes a single screen character through the following format:</span>
<span id="cb25-43"><a href="#cb25-43"></a></span>
<span id="cb25-44"><a href="#cb25-44"></a><span class="pp">|</span> Bit(s) <span class="pp">|</span> Value            <span class="pp">|</span></span>
<span id="cb25-45"><a href="#cb25-45"></a><span class="pp">| ------</span> <span class="pp">| ----------------</span> <span class="pp">|</span></span>
<span id="cb25-46"><a href="#cb25-46"></a><span class="pp">|</span> 0-7    <span class="pp">|</span> ASCII code point <span class="pp">|</span></span>
<span id="cb25-47"><a href="#cb25-47"></a><span class="pp">|</span> 8-11   <span class="pp">|</span> Foreground color <span class="pp">|</span></span>
<span id="cb25-48"><a href="#cb25-48"></a><span class="pp">|</span> 12-14  <span class="pp">|</span> Background color <span class="pp">|</span></span>
<span id="cb25-49"><a href="#cb25-49"></a><span class="pp">|</span> 15     <span class="pp">|</span> Blink            <span class="pp">|</span></span>
<span id="cb25-50"><a href="#cb25-50"></a></span>
<span id="cb25-51"><a href="#cb25-51"></a><span class="ss">- </span>I did not see blinking. </span>
<span id="cb25-52"><a href="#cb25-52"></a></span>
<span id="cb25-53"><a href="#cb25-53"></a><span class="fu">## First Byte</span></span>
<span id="cb25-54"><a href="#cb25-54"></a></span>
<span id="cb25-55"><a href="#cb25-55"></a><span class="ss">- </span>The first byte represents the character that should be printed in the <span class="co">[</span><span class="ot">ASCII encoding</span><span class="co">]</span>. </span>
<span id="cb25-56"><a href="#cb25-56"></a><span class="ss">    - </span>We recall we say many mentions of Python in firmware jobs.</span>
<span id="cb25-57"><a href="#cb25-57"></a><span class="in">```{.sh}</span></span>
<span id="cb25-58"><a href="#cb25-58"></a><span class="ex">python3</span> <span class="at">-c</span> <span class="st">"[print(chr(a), ':', a) for a in range(ord('A'), ord('z')+1)]"</span></span>
<span id="cb25-59"><a href="#cb25-59"></a><span class="in">```</span></span>
<span id="cb25-60"><a href="#cb25-60"></a></span>
<span id="cb25-61"><a href="#cb25-61"></a><span class="fu">## Except</span></span>
<span id="cb25-62"><a href="#cb25-62"></a></span>
<span id="cb25-63"><a href="#cb25-63"></a><span class="ss">- </span>Okay it isn't actually ASCII.</span>
<span id="cb25-64"><a href="#cb25-64"></a><span class="ss">- </span>It's <span class="co">[</span><span class="ot">_code page 437_</span><span class="co">](https://en.wikipedia.org/wiki/Code_page_437)</span></span>
<span id="cb25-65"><a href="#cb25-65"></a><span class="ss">- </span>We think of it as an IBM specific ASCII extension and just use the ASCII subset.</span>
<span id="cb25-66"><a href="#cb25-66"></a></span>
<span id="cb25-67"><a href="#cb25-67"></a><span class="fu">## Second Byte</span></span>
<span id="cb25-68"><a href="#cb25-68"></a></span>
<span id="cb25-69"><a href="#cb25-69"></a><span class="ss">- </span>The second **byte** defines how the character is displayed. </span>
<span id="cb25-70"><a href="#cb25-70"></a><span class="ss">    - </span>The first **four** bits define the foreground color.</span>
<span id="cb25-71"><a href="#cb25-71"></a><span class="ss">    - </span>The next three bits the background color</span>
<span id="cb25-72"><a href="#cb25-72"></a><span class="ss">    - </span>*Nominally* the last bit whether the character should blink.</span>
<span id="cb25-73"><a href="#cb25-73"></a><span class="ss">        - </span>I did not see blinking.</span>
<span id="cb25-74"><a href="#cb25-74"></a><span class="ss">        - </span>May be a <span class="in">`qemu`</span> thing I'm not sure.</span>
<span id="cb25-75"><a href="#cb25-75"></a></span>
<span id="cb25-76"><a href="#cb25-76"></a><span class="fu">## Colors {.smaller} </span></span>
<span id="cb25-77"><a href="#cb25-77"></a>        </span>
<span id="cb25-78"><a href="#cb25-78"></a><span class="ss">- </span>Using octal.</span>
<span id="cb25-79"><a href="#cb25-79"></a></span>
<span id="cb25-80"><a href="#cb25-80"></a><span class="pp">|</span> Number <span class="pp">|</span> Color      <span class="pp">|</span> Bright   <span class="pp">|</span> Bright Color <span class="pp">|</span></span>
<span id="cb25-81"><a href="#cb25-81"></a><span class="pp">| ------</span> <span class="pp">| ----------</span> <span class="pp">| -------------------</span> <span class="pp">| ------------</span> <span class="pp">|</span></span>
<span id="cb25-82"><a href="#cb25-82"></a><span class="pp">|</span> 0o00    <span class="pp">|</span> Black      <span class="pp">|</span> 0o10                 <span class="pp">|</span> Dark Gray    <span class="pp">|</span></span>
<span id="cb25-83"><a href="#cb25-83"></a><span class="pp">|</span> 0o01    <span class="pp">|</span> Blue       <span class="pp">|</span> 0o11                 <span class="pp">|</span> Light Blue   <span class="pp">|</span></span>
<span id="cb25-84"><a href="#cb25-84"></a><span class="pp">|</span> 0o02    <span class="pp">|</span> Green      <span class="pp">|</span> 0o12                 <span class="pp">|</span> Light Green  <span class="pp">|</span></span>
<span id="cb25-85"><a href="#cb25-85"></a><span class="pp">|</span> 0o03    <span class="pp">|</span> Cyan       <span class="pp">|</span> 0o13                 <span class="pp">|</span> Light Cyan   <span class="pp">|</span></span>
<span id="cb25-86"><a href="#cb25-86"></a><span class="pp">|</span> 0o04    <span class="pp">|</span> Red        <span class="pp">|</span> 0o14                 <span class="pp">|</span> Light Red    <span class="pp">|</span></span>
<span id="cb25-87"><a href="#cb25-87"></a><span class="pp">|</span> 0o05    <span class="pp">|</span> Magenta    <span class="pp">|</span> 0o15                 <span class="pp">|</span> Pink         <span class="pp">|</span></span>
<span id="cb25-88"><a href="#cb25-88"></a><span class="pp">|</span> 0o06    <span class="pp">|</span> Brown      <span class="pp">|</span> 0o16                 <span class="pp">|</span> Yellow       <span class="pp">|</span></span>
<span id="cb25-89"><a href="#cb25-89"></a><span class="pp">|</span> 0o07    <span class="pp">|</span> Light Gray <span class="pp">|</span> 0o17                 <span class="pp">|</span> White        <span class="pp">|</span></span>
<span id="cb25-90"><a href="#cb25-90"></a></span>
<span id="cb25-91"><a href="#cb25-91"></a><span class="fu">## Bright/Blink</span></span>
<span id="cb25-92"><a href="#cb25-92"></a></span>
<span id="cb25-93"><a href="#cb25-93"></a><span class="ss">- </span>Bit 4 is the _bright bit_.</span>
<span id="cb25-94"><a href="#cb25-94"></a><span class="ss">    - </span>For example, blue into light blue. </span>
<span id="cb25-95"><a href="#cb25-95"></a><span class="ss">- </span>For the background color, this bit is nominally repurposed as the blink bit.</span>
<span id="cb25-96"><a href="#cb25-96"></a></span>
<span id="cb25-97"><a href="#cb25-97"></a><span class="fu">## Memory-mapped I/O</span></span>
<span id="cb25-98"><a href="#cb25-98"></a></span>
<span id="cb25-99"><a href="#cb25-99"></a><span class="ss">- </span>Okay so this is cool.</span>
<span id="cb25-100"><a href="#cb25-100"></a><span class="ss">- </span>Recall the bus!</span>
<span id="cb25-101"><a href="#cb25-101"></a><span class="ss">- </span>We are going to steal some diagrams.</span>
<span id="cb25-102"><a href="#cb25-102"></a><span class="ss">    - </span>Thanks <span class="co">[</span><span class="ot">Geeks for Geeks</span><span class="co">](https://www.geeksforgeeks.org/computer-organization-architecture/memory-mapped-i-o-and-isolated-i-o/)</span></span>
<span id="cb25-103"><a href="#cb25-103"></a>    </span>
<span id="cb25-104"><a href="#cb25-104"></a><span class="fu">## Isolated I/O</span></span>
<span id="cb25-105"><a href="#cb25-105"></a></span>
<span id="cb25-106"><a href="#cb25-106"></a><span class="ss">- </span>Imagine a form of I/O that isn't cool.</span>
<span id="cb25-107"><a href="#cb25-107"></a><span class="ss">- </span>It may have separate address spaces.</span>
<span id="cb25-108"><a href="#cb25-108"></a><span class="ss">    - </span>So there may be a <span class="in">`0x64`</span> memory location and also <span class="in">`0x64`</span> device.</span>
<span id="cb25-109"><a href="#cb25-109"></a></span>
<span id="cb25-110"><a href="#cb25-110"></a><span class="al">![](https://media.geeksforgeeks.org/wp-content/uploads/20250506151408311194/isolate-io.webp)</span></span>
<span id="cb25-111"><a href="#cb25-111"></a></span>
<span id="cb25-112"><a href="#cb25-112"></a><span class="fu">## This isn't cool</span></span>
<span id="cb25-113"><a href="#cb25-113"></a></span>
<span id="cb25-114"><a href="#cb25-114"></a><span class="ss">- </span>We already discussed Harvard vs. von Neumann architecture.</span>
<span id="cb25-115"><a href="#cb25-115"></a><span class="ss">- </span>Having two memory spaces is not at all cool.</span>
<span id="cb25-116"><a href="#cb25-116"></a><span class="ss">- </span>So we don't do it.</span>
<span id="cb25-117"><a href="#cb25-117"></a><span class="ss">- </span>There's also port-mapped I/O (similarly not cool.</span>
<span id="cb25-118"><a href="#cb25-118"></a></span>
<span id="cb25-119"><a href="#cb25-119"></a><span class="fu">## Memory-Mapped I/O</span></span>
<span id="cb25-120"><a href="#cb25-120"></a></span>
<span id="cb25-121"><a href="#cb25-121"></a><span class="ss">- </span>Imagine the following.</span>
<span id="cb25-122"><a href="#cb25-122"></a><span class="ss">  - </span>The bootloader lives at <span class="in">`0x0`</span></span>
<span id="cb25-123"><a href="#cb25-123"></a><span class="ss">  - </span>The OS lives at <span class="in">`0x1`</span></span>
<span id="cb25-124"><a href="#cb25-124"></a><span class="ss">  - </span>The keyboard lives at <span class="in">`0x2`</span></span>
<span id="cb25-125"><a href="#cb25-125"></a><span class="ss">  - </span>The internet (via a network card) at <span class="in">`0x3`</span></span>
<span id="cb25-126"><a href="#cb25-126"></a><span class="ss">  - </span>The monitor at <span class="in">`0x4`</span></span>
<span id="cb25-127"><a href="#cb25-127"></a><span class="ss">- </span>This obviously cool.</span>
<span id="cb25-128"><a href="#cb25-128"></a></span>
<span id="cb25-129"><a href="#cb25-129"></a><span class="fu">## Altogether </span></span>
<span id="cb25-130"><a href="#cb25-130"></a></span>
<span id="cb25-131"><a href="#cb25-131"></a><span class="ss">- </span>One Big Happy Memory Space </span>
<span id="cb25-132"><a href="#cb25-132"></a></span>
<span id="cb25-133"><a href="#cb25-133"></a><span class="al">![](https://media.geeksforgeeks.org/wp-content/uploads/20250506151651561116/memory-io.webp)</span></span>
<span id="cb25-134"><a href="#cb25-134"></a></span>
<span id="cb25-135"><a href="#cb25-135"></a><span class="fu">## Downsides</span></span>
<span id="cb25-136"><a href="#cb25-136"></a></span>
<span id="cb25-137"><a href="#cb25-137"></a><span class="ss">- </span>MMIO is a helpful *abstraction* - we already know how to think about memory, so we don't need to learn much to do I/O.</span>
<span id="cb25-138"><a href="#cb25-138"></a><span class="ss">    - </span>There's downsides.</span>
<span id="cb25-139"><a href="#cb25-139"></a><span class="ss">    - </span>We shouldn't be able to write to keyboard, probably.</span>
<span id="cb25-140"><a href="#cb25-140"></a><span class="ss">    - </span>Or read from a monitor.</span>
<span id="cb25-141"><a href="#cb25-141"></a><span class="ss">- </span>But its fast and easy, like BIOS vs. UEFI.</span>
<span id="cb25-142"><a href="#cb25-142"></a></span>
<span id="cb25-143"><a href="#cb25-143"></a><span class="fu"># x86_64</span></span>
<span id="cb25-144"><a href="#cb25-144"></a></span>
<span id="cb25-145"><a href="#cb25-145"></a><span class="fu">## In x86_64</span></span>
<span id="cb25-146"><a href="#cb25-146"></a></span>
<span id="cb25-147"><a href="#cb25-147"></a><span class="ss">- </span>On our emulated device, VGA text buffer lives at address <span class="in">`0xb8000`</span>. </span>
<span id="cb25-148"><a href="#cb25-148"></a><span class="ss">    - </span>Absolute geniuses will crack open C and get into trouble.</span>
<span id="cb25-149"><a href="#cb25-149"></a><span class="ss">- </span>So any read to this location:</span>
<span id="cb25-150"><a href="#cb25-150"></a><span class="ss">    - </span>Doesn't go to MMU/RAM/SSD</span>
<span id="cb25-151"><a href="#cb25-151"></a><span class="ss">    - </span>Does go to VGA hardware</span>
<span id="cb25-152"><a href="#cb25-152"></a></span>
<span id="cb25-153"><a href="#cb25-153"></a></span>
<span id="cb25-154"><a href="#cb25-154"></a><span class="fu">## Alert!</span></span>
<span id="cb25-155"><a href="#cb25-155"></a></span>
<span id="cb25-156"><a href="#cb25-156"></a><span class="ss">- </span>MMIO, especially older devices, might not support all normal operations. </span>
<span id="cb25-157"><a href="#cb25-157"></a><span class="ss">- </span>For example, a device could only support byte-wise reads and return junk when a <span class="in">`u64`</span> is read. </span>
<span id="cb25-158"><a href="#cb25-158"></a><span class="ss">    - </span>Block-write "Hello world!" is a homework extension. </span>
<span id="cb25-159"><a href="#cb25-159"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Read more</span><span class="co">](https://web.stanford.edu/class/cs140/projects/pintos/specs/freevga/vga/vgamem.htm#manip)</span></span>
<span id="cb25-160"><a href="#cb25-160"></a></span>
<span id="cb25-161"><a href="#cb25-161"></a><span class="fu">## A Rust Module</span></span>
<span id="cb25-162"><a href="#cb25-162"></a></span>
<span id="cb25-163"><a href="#cb25-163"></a><span class="ss">- </span>Now we "know" how the VGA buffer works.</span>
<span id="cb25-164"><a href="#cb25-164"></a><span class="ss">- </span>We can create a Rust module to handle print and standard out:</span>
<span id="cb25-165"><a href="#cb25-165"></a></span>
<span id="cb25-166"><a href="#cb25-166"></a><span class="in">```{.rs filename="src/main.rs"}</span></span>
<span id="cb25-167"><a href="#cb25-167"></a>mod vga;</span>
<span id="cb25-168"><a href="#cb25-168"></a><span class="in">```</span></span>
<span id="cb25-169"><a href="#cb25-169"></a></span>
<span id="cb25-170"><a href="#cb25-170"></a><span class="ss">- </span>We also must create a new <span class="in">`src/vga.rs`</span> file.</span>
<span id="cb25-171"><a href="#cb25-171"></a></span>
<span id="cb25-172"><a href="#cb25-172"></a><span class="co">&lt;!--</span></span>
<span id="cb25-173"><a href="#cb25-173"></a></span>
<span id="cb25-174"><a href="#cb25-174"></a><span class="co">## Colors</span></span>
<span id="cb25-175"><a href="#cb25-175"></a></span>
<span id="cb25-176"><a href="#cb25-176"></a><span class="co">- Represent colors using an `enum`:</span></span>
<span id="cb25-177"><a href="#cb25-177"></a></span>
<span id="cb25-178"><a href="#cb25-178"></a><span class="co">```{.rs filename="src/vga.rs"}</span></span>
<span id="cb25-179"><a href="#cb25-179"></a><span class="co">#[allow(dead_code)]</span></span>
<span id="cb25-180"><a href="#cb25-180"></a><span class="co">#[derive(Debug, Clone, Copy, PartialEq, Eq)]</span></span>
<span id="cb25-181"><a href="#cb25-181"></a><span class="co">#[repr(u8)]</span></span>
<span id="cb25-182"><a href="#cb25-182"></a><span class="co">pub enum Color {</span></span>
<span id="cb25-183"><a href="#cb25-183"></a><span class="co">    Blck = 0o00,</span></span>
<span id="cb25-184"><a href="#cb25-184"></a><span class="co">    Blue = 0o01,</span></span>
<span id="cb25-185"><a href="#cb25-185"></a><span class="co">    Gren = 0o02,</span></span>
<span id="cb25-186"><a href="#cb25-186"></a><span class="co">    Cyan = 0o03,</span></span>
<span id="cb25-187"><a href="#cb25-187"></a><span class="co">    Redd = 0o04,</span></span>
<span id="cb25-188"><a href="#cb25-188"></a><span class="co">    Mgnt = 0o05,</span></span>
<span id="cb25-189"><a href="#cb25-189"></a><span class="co">    Brwn = 0o06,</span></span>
<span id="cb25-190"><a href="#cb25-190"></a><span class="co">    LGry = 0o07,</span></span>
<span id="cb25-191"><a href="#cb25-191"></a><span class="co">    DGry = 0o10,</span></span>
<span id="cb25-192"><a href="#cb25-192"></a><span class="co">    LBlu = 0o11,</span></span>
<span id="cb25-193"><a href="#cb25-193"></a><span class="co">    LGrn = 0o12,</span></span>
<span id="cb25-194"><a href="#cb25-194"></a><span class="co">    LCyn = 0o13,</span></span>
<span id="cb25-195"><a href="#cb25-195"></a><span class="co">    LRed = 0o14,</span></span>
<span id="cb25-196"><a href="#cb25-196"></a><span class="co">    Pink = 0o15,</span></span>
<span id="cb25-197"><a href="#cb25-197"></a><span class="co">    Yelo = 0o16,</span></span>
<span id="cb25-198"><a href="#cb25-198"></a><span class="co">    Whte = 0o17,</span></span>
<span id="cb25-199"><a href="#cb25-199"></a><span class="co">}</span></span>
<span id="cb25-200"><a href="#cb25-200"></a><span class="co">```</span></span>
<span id="cb25-201"><a href="#cb25-201"></a></span>
<span id="cb25-202"><a href="#cb25-202"></a><span class="co">## Notes</span></span>
<span id="cb25-203"><a href="#cb25-203"></a></span>
<span id="cb25-204"><a href="#cb25-204"></a><span class="co">- We use a [C-like enum] here to explicitly specify the number for each color. </span></span>
<span id="cb25-205"><a href="#cb25-205"></a><span class="co">- Because of the `repr(u8)` attribute, each enum variant is stored as a `u8`. </span></span>
<span id="cb25-206"><a href="#cb25-206"></a><span class="co">    - I would use `u4` type (a nib) if I was allowed to.</span></span>
<span id="cb25-207"><a href="#cb25-207"></a><span class="co">-  Rust on the [C-like enum](https://doc.rust-lang.org/rust-by-example/custom_types/enum/c_like.html)</span></span>
<span id="cb25-208"><a href="#cb25-208"></a><span class="co">    - At some point we have to figure out why we aren't writing C.</span></span>
<span id="cb25-209"><a href="#cb25-209"></a></span>
<span id="cb25-210"><a href="#cb25-210"></a><span class="co">## Suppress Warnings</span></span>
<span id="cb25-211"><a href="#cb25-211"></a></span>
<span id="cb25-212"><a href="#cb25-212"></a><span class="co">- Normally the compiler would issue a warning for each unused variant. </span></span>
<span id="cb25-213"><a href="#cb25-213"></a><span class="co">    - This seems obviously annoying to me.</span></span>
<span id="cb25-214"><a href="#cb25-214"></a><span class="co">- By using the `#[allow(dead_code)]` attribute, we disable these warnings for the `Color` enum.</span></span>
<span id="cb25-215"><a href="#cb25-215"></a></span>
<span id="cb25-216"><a href="#cb25-216"></a><span class="co">## Comparisons</span></span>
<span id="cb25-217"><a href="#cb25-217"></a></span>
<span id="cb25-218"><a href="#cb25-218"></a><span class="co">- By [deriving] the [`Copy`], [`Clone`], [`Debug`], [`PartialEq`], and [`Eq`] traits, we:</span></span>
<span id="cb25-219"><a href="#cb25-219"></a><span class="co">    - Get stack-like (vs. heap-like) behavior.</span></span>
<span id="cb25-220"><a href="#cb25-220"></a><span class="co">    - Make it printable.</span></span>
<span id="cb25-221"><a href="#cb25-221"></a><span class="co">    - Make it comparable (e.g. via double-equals-equality `==`)</span></span>
<span id="cb25-222"><a href="#cb25-222"></a><span class="co">- I would obviously just use an u8 here but don't be like me, I am wrong in some way that may be important latter.</span></span>
<span id="cb25-223"><a href="#cb25-223"></a></span>
<span id="cb25-224"><a href="#cb25-224"></a><span class="co">## Links</span></span>
<span id="cb25-225"><a href="#cb25-225"></a></span>
<span id="cb25-226"><a href="#cb25-226"></a><span class="co">- [deriving](https://doc.rust-lang.org/rust-by-example/trait/derive.html)</span></span>
<span id="cb25-227"><a href="#cb25-227"></a><span class="co">- [`Copy`](https://doc.rust-lang.org/nightly/core/marker/trait.Copy.html)</span></span>
<span id="cb25-228"><a href="#cb25-228"></a><span class="co">- [`Clone`](https://doc.rust-lang.org/nightly/core/clone/trait.Clone.html)</span></span>
<span id="cb25-229"><a href="#cb25-229"></a><span class="co">- [`Debug`](https://doc.rust-lang.org/nightly/core/fmt/trait.Debug.html)</span></span>
<span id="cb25-230"><a href="#cb25-230"></a><span class="co">- [`PartialEq`](https://doc.rust-lang.org/nightly/core/cmp/trait.PartialEq.html)</span></span>
<span id="cb25-231"><a href="#cb25-231"></a><span class="co">- [`Eq`](https://doc.rust-lang.org/nightly/core/cmp/trait.Eq.html)</span></span>
<span id="cb25-232"><a href="#cb25-232"></a><span class="co">- [copy semantics](https://doc.rust-lang.org/1.30.0/book/first-edition/ownership.html#copy-types)</span></span>
<span id="cb25-233"><a href="#cb25-233"></a></span>
<span id="cb25-234"><a href="#cb25-234"></a></span>
<span id="cb25-235"><a href="#cb25-235"></a><span class="co">## New Type</span></span>
<span id="cb25-236"><a href="#cb25-236"></a></span>
<span id="cb25-237"><a href="#cb25-237"></a><span class="co">- A full color code specifies foreground *and* background color</span></span>
<span id="cb25-238"><a href="#cb25-238"></a><span class="co">- We create a [newtype](https://doc.rust-lang.org/rust-by-example/generics/new_types.html) on top of `u8`</span></span>
<span id="cb25-239"><a href="#cb25-239"></a></span>
<span id="cb25-240"><a href="#cb25-240"></a></span>
<span id="cb25-241"><a href="#cb25-241"></a><span class="co">```{.rs filename="src/vga.rs"}</span></span>
<span id="cb25-242"><a href="#cb25-242"></a><span class="co">#[derive(Debug, Clone, Copy, PartialEq, Eq)]</span></span>
<span id="cb25-243"><a href="#cb25-243"></a><span class="co">#[repr(transparent)]</span></span>
<span id="cb25-244"><a href="#cb25-244"></a><span class="co">struct ColorCode(u8);</span></span>
<span id="cb25-245"><a href="#cb25-245"></a></span>
<span id="cb25-246"><a href="#cb25-246"></a><span class="co">impl ColorCode {</span></span>
<span id="cb25-247"><a href="#cb25-247"></a><span class="co">    fn new(fg: Color, b: Color) -&gt; ColorCode {</span></span>
<span id="cb25-248"><a href="#cb25-248"></a><span class="co">        ColorCode((bg as u8) &lt;&lt; 4 | (fg as u8))</span></span>
<span id="cb25-249"><a href="#cb25-249"></a><span class="co">    }</span></span>
<span id="cb25-250"><a href="#cb25-250"></a><span class="co">}</span></span>
<span id="cb25-251"><a href="#cb25-251"></a><span class="co">```</span></span>
<span id="cb25-252"><a href="#cb25-252"></a></span>
<span id="cb25-253"><a href="#cb25-253"></a><span class="co">## Transparency</span></span>
<span id="cb25-254"><a href="#cb25-254"></a></span>
<span id="cb25-255"><a href="#cb25-255"></a><span class="co">- Again, we derive the `Copy` and `Debug` traits for it. </span></span>
<span id="cb25-256"><a href="#cb25-256"></a><span class="co">- When working with low level devices, we need to ensure bits are where we expect them to be.</span></span>
<span id="cb25-257"><a href="#cb25-257"></a><span class="co">- To ensure that the `ColorCode` has the exact same data layout as a `u8`, we use the [`repr(transparent)`] attribute.</span></span>
<span id="cb25-258"><a href="#cb25-258"></a><span class="co">    - [Read more](https://doc.rust-lang.org/nomicon/other-reprs.html#reprtransparent)</span></span>
<span id="cb25-259"><a href="#cb25-259"></a><span class="co">&lt;!--</span></span>
<span id="cb25-260"><a href="#cb25-260"></a><span class="co">## Text Buffer</span></span>
<span id="cb25-261"><a href="#cb25-261"></a></span>
<span id="cb25-262"><a href="#cb25-262"></a><span class="co">- Now we can add structures to represent a screen character and the text buffer:</span></span>
<span id="cb25-263"><a href="#cb25-263"></a></span>
<span id="cb25-264"><a href="#cb25-264"></a><span class="co">```{.rs filename="src/vga.rs"}</span></span>
<span id="cb25-265"><a href="#cb25-265"></a><span class="co">#[derive(Debug, Clone, Copy, PartialEq, Eq)]</span></span>
<span id="cb25-266"><a href="#cb25-266"></a><span class="co">#[repr(C)]</span></span>
<span id="cb25-267"><a href="#cb25-267"></a><span class="co">struct ScreenChar {</span></span>
<span id="cb25-268"><a href="#cb25-268"></a><span class="co">    ascii_character: u8,</span></span>
<span id="cb25-269"><a href="#cb25-269"></a><span class="co">    color_code: ColorCode,</span></span>
<span id="cb25-270"><a href="#cb25-270"></a><span class="co">}</span></span>
<span id="cb25-271"><a href="#cb25-271"></a></span>
<span id="cb25-272"><a href="#cb25-272"></a><span class="co">const BUFFER_HEIGHT: usize = 25;</span></span>
<span id="cb25-273"><a href="#cb25-273"></a><span class="co">const BUFFER_WIDTH: usize = 80;</span></span>
<span id="cb25-274"><a href="#cb25-274"></a></span>
<span id="cb25-275"><a href="#cb25-275"></a><span class="co">#[repr(transparent)]</span></span>
<span id="cb25-276"><a href="#cb25-276"></a><span class="co">struct Buffer {</span></span>
<span id="cb25-277"><a href="#cb25-277"></a><span class="co">    chars: [[ScreenChar; BUFFER_WIDTH]; BUFFER_HEIGHT],</span></span>
<span id="cb25-278"><a href="#cb25-278"></a><span class="co">}</span></span>
<span id="cb25-279"><a href="#cb25-279"></a><span class="co">```</span></span>
<span id="cb25-280"><a href="#cb25-280"></a></span>
<span id="cb25-281"><a href="#cb25-281"></a><span class="co">## C Representation</span></span>
<span id="cb25-282"><a href="#cb25-282"></a></span>
<span id="cb25-283"><a href="#cb25-283"></a><span class="co">- Field ordering in default structs is undefined in Rust!</span></span>
<span id="cb25-284"><a href="#cb25-284"></a><span class="co">- Not so in the good language, C.</span></span>
<span id="cb25-285"><a href="#cb25-285"></a><span class="co">- We use the [`repr(C)`] attribute. </span></span>
<span id="cb25-286"><a href="#cb25-286"></a><span class="co">  - It guarantees that the struct's fields are laid out in order. `</span></span>
<span id="cb25-287"><a href="#cb25-287"></a><span class="co">  - [`repr(C)`](https://doc.rust-lang.org/nightly/nomicon/other-reprs.html#reprc)</span></span>
<span id="cb25-288"><a href="#cb25-288"></a><span class="co">- For the `Buffer` struct, we use [`repr(transparent)`] again to ensure that it has the same memory layout as its single field.</span></span>
<span id="cb25-289"><a href="#cb25-289"></a><span class="co">--&gt;</span></span>
<span id="cb25-290"><a href="#cb25-290"></a></span>
<span id="cb25-291"><a href="#cb25-291"></a></span>
<span id="cb25-292"><a href="#cb25-292"></a><span class="fu">## Standard Out</span></span>
<span id="cb25-293"><a href="#cb25-293"></a></span>
<span id="cb25-294"><a href="#cb25-294"></a><span class="ss">- </span>To provide "standard out" like functionality, I will:</span>
<span id="cb25-295"><a href="#cb25-295"></a><span class="ss">    - </span>Maintain the most recent position to which a character has been written.</span>
<span id="cb25-296"><a href="#cb25-296"></a></span>
<span id="cb25-297"><a href="#cb25-297"></a></span>
<span id="cb25-298"><a href="#cb25-298"></a><span class="in">```{.rs filename="src/vga.rs"}</span></span>
<span id="cb25-299"><a href="#cb25-299"></a>static mut latest<span class="sc">:</span> usize <span class="ot">=</span> <span class="dv">0</span>;</span>
<span id="cb25-300"><a href="#cb25-300"></a><span class="in">```</span></span>
<span id="cb25-301"><a href="#cb25-301"></a></span>
<span id="cb25-302"><a href="#cb25-302"></a><span class="fu">## Location</span></span>
<span id="cb25-303"><a href="#cb25-303"></a></span>
<span id="cb25-304"><a href="#cb25-304"></a><span class="ss">- </span>To provide "standard out" like functionality, I will:</span>
<span id="cb25-305"><a href="#cb25-305"></a><span class="ss">    - </span>Maintain the most recent position to which a character has been written.</span>
<span id="cb25-306"><a href="#cb25-306"></a><span class="ss">    - </span>Have a constant referring to to the VGA buffer address.</span>
<span id="cb25-307"><a href="#cb25-307"></a></span>
<span id="cb25-308"><a href="#cb25-308"></a><span class="in">```{.rs filename="src/vga.rs"}</span></span>
<span id="cb25-309"><a href="#cb25-309"></a>static mut latest<span class="sc">:</span> usize <span class="ot">=</span> <span class="dv">0</span>;</span>
<span id="cb25-310"><a href="#cb25-310"></a>const MMIO<span class="sc">:</span> usize <span class="ot">=</span> <span class="dv">0xb8000</span>;</span>
<span id="cb25-311"><a href="#cb25-311"></a><span class="in">```</span></span>
<span id="cb25-312"><a href="#cb25-312"></a></span>
<span id="cb25-313"><a href="#cb25-313"></a><span class="fu">## Color</span></span>
<span id="cb25-314"><a href="#cb25-314"></a></span>
<span id="cb25-315"><a href="#cb25-315"></a><span class="ss">- </span>To provide "standard out" like functionality, I will:</span>
<span id="cb25-316"><a href="#cb25-316"></a><span class="ss">    - </span>Provide a way to write a character.</span>
<span id="cb25-317"><a href="#cb25-317"></a><span class="ss">        - </span>I will use a <span class="in">`const`</span> for color and not worry about.</span>
<span id="cb25-318"><a href="#cb25-318"></a></span>
<span id="cb25-319"><a href="#cb25-319"></a><span class="in">```{.rs filename="src/vga.rs"}</span></span>
<span id="cb25-320"><a href="#cb25-320"></a>static mut latest<span class="sc">:</span> usize <span class="ot">=</span> <span class="dv">0</span>;</span>
<span id="cb25-321"><a href="#cb25-321"></a>const MMIO<span class="sc">:</span> usize <span class="ot">=</span> <span class="dv">0xb8000</span>;</span>
<span id="cb25-322"><a href="#cb25-322"></a>const COLOR<span class="sc">:</span> u8 <span class="ot">=</span> <span class="dv">0xF</span>;</span>
<span id="cb25-323"><a href="#cb25-323"></a><span class="in">```</span></span>
<span id="cb25-324"><a href="#cb25-324"></a></span>
<span id="cb25-325"><a href="#cb25-325"></a><span class="fu">## Character-wise</span></span>
<span id="cb25-326"><a href="#cb25-326"></a></span>
<span id="cb25-327"><a href="#cb25-327"></a><span class="ss">- </span>To provide "standard out" like functionality, I will:</span>
<span id="cb25-328"><a href="#cb25-328"></a><span class="ss">    - </span>Provide a way to write a character.</span>
<span id="cb25-329"><a href="#cb25-329"></a><span class="ss">        - </span>I will write a function to push one character.</span>
<span id="cb25-330"><a href="#cb25-330"></a></span>
<span id="cb25-331"><a href="#cb25-331"></a><span class="in">```{.rs filename="src/vga.rs"}</span></span>
<span id="cb25-332"><a href="#cb25-332"></a><span class="sc">/</span><span class="er">/</span> Public <span class="cf">for</span> now</span>
<span id="cb25-333"><a href="#cb25-333"></a>pub fn <span class="fu">char_to_vga</span>(a<span class="sc">:</span> u8) {</span>
<span id="cb25-334"><a href="#cb25-334"></a>    todo<span class="sc">!</span>();</span>
<span id="cb25-335"><a href="#cb25-335"></a>}</span>
<span id="cb25-336"><a href="#cb25-336"></a><span class="in">```</span></span>
<span id="cb25-337"><a href="#cb25-337"></a></span>
<span id="cb25-338"><a href="#cb25-338"></a><span class="fu">## Stepwise</span></span>
<span id="cb25-339"><a href="#cb25-339"></a></span>
<span id="cb25-340"><a href="#cb25-340"></a><span class="ss">1. </span>Compute absolute location from relative location.</span>
<span id="cb25-341"><a href="#cb25-341"></a></span>
<span id="cb25-342"><a href="#cb25-342"></a><span class="in">```{.rs filename="src/vga.rs"}</span></span>
<span id="cb25-343"><a href="#cb25-343"></a><span class="sc">/</span><span class="er">/</span> Public <span class="cf">for</span> now</span>
<span id="cb25-344"><a href="#cb25-344"></a>pub fn <span class="fu">char_to_vga</span>(a<span class="sc">:</span> u8) {</span>
<span id="cb25-345"><a href="#cb25-345"></a>    let rel<span class="sc">:</span> <span class="er">*</span>mut u8 <span class="ot">=</span> (MMIO <span class="sc">+</span> (latest <span class="sc">*</span> <span class="dv">2</span>)) as <span class="sc">*</span>mut u8;</span>
<span id="cb25-346"><a href="#cb25-346"></a>}</span>
<span id="cb25-347"><a href="#cb25-347"></a><span class="in">```</span></span>
<span id="cb25-348"><a href="#cb25-348"></a></span>
<span id="cb25-349"><a href="#cb25-349"></a><span class="fu">## Stepwise</span></span>
<span id="cb25-350"><a href="#cb25-350"></a></span>
<span id="cb25-351"><a href="#cb25-351"></a><span class="ss">1. </span>Compute absolute location from relative location.</span>
<span id="cb25-352"><a href="#cb25-352"></a><span class="ss">2. </span>Store a value at that location.</span>
<span id="cb25-353"><a href="#cb25-353"></a></span>
<span id="cb25-354"><a href="#cb25-354"></a><span class="in">```{.rs filename="src/vga.rs"}</span></span>
<span id="cb25-355"><a href="#cb25-355"></a><span class="sc">/</span><span class="er">/</span> Public <span class="cf">for</span> now</span>
<span id="cb25-356"><a href="#cb25-356"></a>pub fn <span class="fu">char_to_vga</span>(a<span class="sc">:</span> u8) {</span>
<span id="cb25-357"><a href="#cb25-357"></a>    let rel<span class="sc">:</span> <span class="er">*</span>mut u8 <span class="ot">=</span> (MMIO <span class="sc">+</span> (latest <span class="sc">*</span> <span class="dv">2</span>)) as <span class="sc">*</span>mut u8;</span>
<span id="cb25-358"><a href="#cb25-358"></a>    <span class="sc">*</span>rel <span class="ot">=</span> a;</span>
<span id="cb25-359"><a href="#cb25-359"></a>}</span>
<span id="cb25-360"><a href="#cb25-360"></a><span class="in">```</span></span>
<span id="cb25-361"><a href="#cb25-361"></a></span>
<span id="cb25-362"><a href="#cb25-362"></a><span class="fu">## Stepwise</span></span>
<span id="cb25-363"><a href="#cb25-363"></a></span>
<span id="cb25-364"><a href="#cb25-364"></a><span class="ss">1. </span>Compute absolute location from relative location.</span>
<span id="cb25-365"><a href="#cb25-365"></a><span class="ss">2. </span>Store a value at that location.</span>
<span id="cb25-366"><a href="#cb25-366"></a><span class="ss">3. </span>Store a color at the next location.</span>
<span id="cb25-367"><a href="#cb25-367"></a></span>
<span id="cb25-368"><a href="#cb25-368"></a><span class="in">```{.rs filename="src/vga.rs"}</span></span>
<span id="cb25-369"><a href="#cb25-369"></a><span class="sc">/</span><span class="er">/</span> Public <span class="cf">for</span> now</span>
<span id="cb25-370"><a href="#cb25-370"></a>pub fn <span class="fu">char_to_vga</span>(a<span class="sc">:</span> u8) {</span>
<span id="cb25-371"><a href="#cb25-371"></a>    let rel<span class="sc">:</span> <span class="er">*</span>mut u8 <span class="ot">=</span> (MMIO <span class="sc">+</span> (latest <span class="sc">*</span> <span class="dv">2</span>)) as <span class="sc">*</span>mut u8;</span>
<span id="cb25-372"><a href="#cb25-372"></a>    <span class="sc">*</span>rel <span class="ot">=</span> a;</span>
<span id="cb25-373"><a href="#cb25-373"></a>    <span class="sc">*</span>((rel as usize <span class="sc">+</span> <span class="dv">1</span>) as <span class="sc">*</span>mut u8) <span class="ot">=</span> COLOR;</span>
<span id="cb25-374"><a href="#cb25-374"></a>}</span>
<span id="cb25-375"><a href="#cb25-375"></a><span class="in">```</span></span>
<span id="cb25-376"><a href="#cb25-376"></a></span>
<span id="cb25-377"><a href="#cb25-377"></a><span class="fu">## Stepwise</span></span>
<span id="cb25-378"><a href="#cb25-378"></a></span>
<span id="cb25-379"><a href="#cb25-379"></a><span class="ss">1. </span>Compute absolute location from relative location.</span>
<span id="cb25-380"><a href="#cb25-380"></a><span class="ss">2. </span>Store a value at that location.</span>
<span id="cb25-381"><a href="#cb25-381"></a><span class="ss">3. </span>Store a color at the next location.</span>
<span id="cb25-382"><a href="#cb25-382"></a><span class="ss">4. </span>Increment the latest.</span>
<span id="cb25-383"><a href="#cb25-383"></a></span>
<span id="cb25-384"><a href="#cb25-384"></a><span class="in">```{.rs filename="src/vga.rs"}</span></span>
<span id="cb25-385"><a href="#cb25-385"></a><span class="sc">/</span><span class="er">/</span> Public <span class="cf">for</span> now</span>
<span id="cb25-386"><a href="#cb25-386"></a>pub fn <span class="fu">char_to_vga</span>(a<span class="sc">:</span> u8) {</span>
<span id="cb25-387"><a href="#cb25-387"></a>    let rel<span class="sc">:</span> <span class="er">*</span>mut u8 <span class="ot">=</span> (MMIO <span class="sc">+</span> (latest <span class="sc">*</span> <span class="dv">2</span>)) as <span class="sc">*</span>mut u8;</span>
<span id="cb25-388"><a href="#cb25-388"></a>    <span class="sc">*</span>rel <span class="ot">=</span> a;</span>
<span id="cb25-389"><a href="#cb25-389"></a>    <span class="sc">*</span>((rel as usize <span class="sc">+</span> <span class="dv">1</span>) as <span class="sc">*</span>mut u8) <span class="ot">=</span> COLOR;</span>
<span id="cb25-390"><a href="#cb25-390"></a>    LATEST <span class="ot">=</span> LATEST <span class="sc">+</span> <span class="dv">1</span>;</span>
<span id="cb25-391"><a href="#cb25-391"></a>}</span>
<span id="cb25-392"><a href="#cb25-392"></a><span class="in">```</span></span>
<span id="cb25-393"><a href="#cb25-393"></a></span>
<span id="cb25-394"><a href="#cb25-394"></a><span class="fu">## Test it</span></span>
<span id="cb25-395"><a href="#cb25-395"></a></span>
<span id="cb25-396"><a href="#cb25-396"></a><span class="ss">- </span>It is trivial to test.</span>
<span id="cb25-397"><a href="#cb25-397"></a></span>
<span id="cb25-398"><a href="#cb25-398"></a><span class="in">```{.rs filename="src/main.rs"}</span></span>
<span id="cb25-399"><a href="#cb25-399"></a>    let hi<span class="sc">:</span> <span class="er">&amp;</span>[u8] <span class="ot">=</span> b<span class="st">"Hello World!"</span>;</span>
<span id="cb25-400"><a href="#cb25-400"></a>    <span class="cf">for</span> i <span class="cf">in</span> <span class="dv">0</span>..<span class="dv">12</span> {</span>
<span id="cb25-401"><a href="#cb25-401"></a>        vga<span class="sc">::</span><span class="fu">char_to_vga</span>(hi[i]);</span>
<span id="cb25-402"><a href="#cb25-402"></a>    }</span>
<span id="cb25-403"><a href="#cb25-403"></a><span class="in">```</span></span>
<span id="cb25-404"><a href="#cb25-404"></a></span>
<span id="cb25-405"><a href="#cb25-405"></a><span class="ss">- </span>"Works on my machine!" - me</span>
<span id="cb25-406"><a href="#cb25-406"></a><span class="ss">    - </span>Unless?</span>
<span id="cb25-407"><a href="#cb25-407"></a><span class="ss">    - </span>We'll come back to this.</span>
<span id="cb25-408"><a href="#cb25-408"></a></span>
<span id="cb25-409"><a href="#cb25-409"></a><span class="fu">## Annoying</span></span>
<span id="cb25-410"><a href="#cb25-410"></a></span>
<span id="cb25-411"><a href="#cb25-411"></a><span class="ss">- </span>Some of you may lack a strong work ethic and want to show entire a whole *string* rather than just a character at a time.</span>
<span id="cb25-412"><a href="#cb25-412"></a><span class="ss">    - </span>Especially since using characters of a string in Rust is ludicrously opaque.</span>
<span id="cb25-413"><a href="#cb25-413"></a><span class="ss">- </span>Not to worry.</span>
<span id="cb25-414"><a href="#cb25-414"></a></span>
<span id="cb25-415"><a href="#cb25-415"></a><span class="fu">## Target `&amp;str`</span></span>
<span id="cb25-416"><a href="#cb25-416"></a></span>
<span id="cb25-417"><a href="#cb25-417"></a><span class="ss">- </span>We can abstract to loop into <span class="in">`src/vga.rs`</span></span>
<span id="cb25-418"><a href="#cb25-418"></a></span>
<span id="cb25-419"><a href="#cb25-419"></a><span class="in">```{.rs filename="src/vga.rs"}</span></span>
<span id="cb25-420"><a href="#cb25-420"></a>pub fn <span class="fu">str_to_vga</span>(s<span class="sc">:</span> <span class="er">&amp;</span>str) {</span>
<span id="cb25-421"><a href="#cb25-421"></a>    let v <span class="ot">=</span> <span class="fu">s.as_bytes</span>();</span>
<span id="cb25-422"><a href="#cb25-422"></a>    <span class="cf">for</span> i <span class="cf">in</span> <span class="dv">0</span><span class="fu">..v.len</span>() {</span>
<span id="cb25-423"><a href="#cb25-423"></a>        <span class="fu">char_to_vga</span>(v[i]);</span>
<span id="cb25-424"><a href="#cb25-424"></a>    }</span>
<span id="cb25-425"><a href="#cb25-425"></a>}</span>
<span id="cb25-426"><a href="#cb25-426"></a><span class="in">```</span></span>
<span id="cb25-427"><a href="#cb25-427"></a></span>
<span id="cb25-428"><a href="#cb25-428"></a><span class="fu">## Aside</span></span>
<span id="cb25-429"><a href="#cb25-429"></a></span>
<span id="cb25-430"><a href="#cb25-430"></a><span class="ss">- </span>I am opinionated on <span class="in">`as_bytes`</span>.</span>
<span id="cb25-431"><a href="#cb25-431"></a><span class="ss">- </span>Let's check some links.</span>
<span id="cb25-432"><a href="#cb25-432"></a><span class="ss">    - </span><span class="co">[</span><span class="ot">`to_bytes`</span><span class="co">](https://doc.rust-lang.org/std/?search=to_bytes)</span></span>
<span id="cb25-433"><a href="#cb25-433"></a><span class="ss">    - </span><span class="co">[</span><span class="ot">`as_bytes`</span><span class="co">](https://doc.rust-lang.org/std/?search=as_bytes)</span></span>
<span id="cb25-434"><a href="#cb25-434"></a><span class="ss">    - </span><span class="co">[</span><span class="ot">`bytes`</span><span class="co">](https://doc.rust-lang.org/std/?search=bytes)</span></span>
<span id="cb25-435"><a href="#cb25-435"></a><span class="ss">- </span>Can you guess what always works?</span>
<span id="cb25-436"><a href="#cb25-436"></a></span>
<span id="cb25-437"><a href="#cb25-437"></a><span class="fu">## Aside</span></span>
<span id="cb25-438"><a href="#cb25-438"></a></span>
<span id="cb25-439"><a href="#cb25-439"></a><span class="ss">- </span>Big Rust doesn't want you to know you can use pointers.</span>
<span id="cb25-440"><a href="#cb25-440"></a></span>
<span id="cb25-441"><a href="#cb25-441"></a><span class="in">```{.rs filename="src/vga.rs"}</span></span>
<span id="cb25-442"><a href="#cb25-442"></a>    let ptr <span class="ot">=</span> <span class="fu">s.as_ptr</span>() as usize;</span>
<span id="cb25-443"><a href="#cb25-443"></a>    unsafe {</span>
<span id="cb25-444"><a href="#cb25-444"></a>        <span class="cf">for</span> i <span class="cf">in</span> <span class="dv">0</span><span class="fu">..s.len</span>() {</span>
<span id="cb25-445"><a href="#cb25-445"></a>            <span class="fu">char_to_vga</span>(<span class="sc">*</span>((ptr <span class="sc">+</span> i) as <span class="sc">*</span>const u8));</span>
<span id="cb25-446"><a href="#cb25-446"></a>        }</span>
<span id="cb25-447"><a href="#cb25-447"></a>    }</span>
<span id="cb25-448"><a href="#cb25-448"></a><span class="in">```</span></span>
<span id="cb25-449"><a href="#cb25-449"></a></span>
<span id="cb25-450"><a href="#cb25-450"></a><span class="ss">- </span>I could make this even worse but I didn't.</span>
<span id="cb25-451"><a href="#cb25-451"></a><span class="ss">- </span>Anyways don't do this.</span>
<span id="cb25-452"><a href="#cb25-452"></a></span>
<span id="cb25-453"><a href="#cb25-453"></a><span class="fu">## Update main</span></span>
<span id="cb25-454"><a href="#cb25-454"></a></span>
<span id="cb25-455"><a href="#cb25-455"></a><span class="ss">- </span>Look how nice that is!</span>
<span id="cb25-456"><a href="#cb25-456"></a></span>
<span id="cb25-457"><a href="#cb25-457"></a><span class="in">```{.rs filename="src/main.rs"}</span></span>
<span id="cb25-458"><a href="#cb25-458"></a><span class="co">#[unsafe(no_mangle)]</span></span>
<span id="cb25-459"><a href="#cb25-459"></a>pub extern <span class="st">"C"</span> fn <span class="fu">_start</span>() <span class="ot">-&gt;</span> <span class="sc">!</span> {</span>
<span id="cb25-460"><a href="#cb25-460"></a>    vga<span class="sc">::</span><span class="fu">str_to_vga</span>(<span class="st">"Hello, world!"</span>);</span>
<span id="cb25-461"><a href="#cb25-461"></a>    loop {}</span>
<span id="cb25-462"><a href="#cb25-462"></a>}</span>
<span id="cb25-463"><a href="#cb25-463"></a><span class="in">```</span></span>
<span id="cb25-464"><a href="#cb25-464"></a></span>
<span id="cb25-465"><a href="#cb25-465"></a><span class="fu">## I bet...</span></span>
<span id="cb25-466"><a href="#cb25-466"></a></span>
<span id="cb25-467"><a href="#cb25-467"></a><span class="ss">- </span>I bet we can print *any* string.</span>
<span id="cb25-468"><a href="#cb25-468"></a><span class="ss">- </span>Let's do like a comically easy string that will definitely print.</span>
<span id="cb25-469"><a href="#cb25-469"></a><span class="ss">- </span>There's no way it will fail.</span>
<span id="cb25-470"><a href="#cb25-470"></a></span>
<span id="cb25-471"><a href="#cb25-471"></a><span class="in">```{.rs filename="src/main.rs"}</span></span>
<span id="cb25-472"><a href="#cb25-472"></a>    vga<span class="sc">::</span><span class="fu">str_to_vga</span>(<span class="st">"Hello</span><span class="sc">\n</span><span class="st">world!"</span>);</span>
<span id="cb25-473"><a href="#cb25-473"></a><span class="in">```</span></span>
<span id="cb25-474"><a href="#cb25-474"></a></span>
<span id="cb25-475"><a href="#cb25-475"></a><span class="ss">- </span>It worked right?</span>
<span id="cb25-476"><a href="#cb25-476"></a></span>
<span id="cb25-477"><a href="#cb25-477"></a><span class="fu">## Escape Codes</span></span>
<span id="cb25-478"><a href="#cb25-478"></a></span>
<span id="cb25-479"><a href="#cb25-479"></a><span class="ss">- </span>Okay so there's some things we need to treat differently.</span>
<span id="cb25-480"><a href="#cb25-480"></a><span class="ss">    - </span>Minimally <span class="in">`\n`</span>.</span>
<span id="cb25-481"><a href="#cb25-481"></a><span class="ss">    - </span>And therefore also <span class="in">`\\`</span> to show a single backslash.</span>
<span id="cb25-482"><a href="#cb25-482"></a><span class="ss">    - </span>I don't even know if we need anything else, but I'll show the design pattern.</span>
<span id="cb25-483"><a href="#cb25-483"></a></span>
<span id="cb25-484"><a href="#cb25-484"></a><span class="fu">## Revisit Implementation</span></span>
<span id="cb25-485"><a href="#cb25-485"></a></span>
<span id="cb25-486"><a href="#cb25-486"></a><span class="ss">- </span>Recall our naive implementation.</span>
<span id="cb25-487"><a href="#cb25-487"></a></span>
<span id="cb25-488"><a href="#cb25-488"></a><span class="in">```{.rs filename="src/vga.rs"}</span></span>
<span id="cb25-489"><a href="#cb25-489"></a>pub fn <span class="fu">str_to_vga</span>(s<span class="sc">:</span> <span class="er">&amp;</span>str) {</span>
<span id="cb25-490"><a href="#cb25-490"></a>    let v <span class="ot">=</span> <span class="fu">s.as_bytes</span>();</span>
<span id="cb25-491"><a href="#cb25-491"></a>    <span class="cf">for</span> i <span class="cf">in</span> <span class="dv">0</span><span class="fu">..v.len</span>() {</span>
<span id="cb25-492"><a href="#cb25-492"></a>        <span class="fu">char_to_vga</span>(v[i]);</span>
<span id="cb25-493"><a href="#cb25-493"></a>    }</span>
<span id="cb25-494"><a href="#cb25-494"></a>}</span>
<span id="cb25-495"><a href="#cb25-495"></a><span class="in">```</span></span>
<span id="cb25-496"><a href="#cb25-496"></a></span>
<span id="cb25-497"><a href="#cb25-497"></a><span class="fu">## Case analysis</span></span>
<span id="cb25-498"><a href="#cb25-498"></a></span>
<span id="cb25-499"><a href="#cb25-499"></a><span class="ss">- </span>As far as I know (I didn't check) we only have to look for is:</span>
<span id="cb25-500"><a href="#cb25-500"></a><span class="ss">    - </span><span class="in">`\n`</span></span>
<span id="cb25-501"><a href="#cb25-501"></a><span class="ss">    - </span><span class="in">`10`</span> (I think?)</span>
<span id="cb25-502"><a href="#cb25-502"></a><span class="ss">    - </span><span class="in">`0xa`</span></span>
<span id="cb25-503"><a href="#cb25-503"></a><span class="ss">- </span>It will be a <span class="in">`u8`</span> within the loop (since we <span class="in">`as_bytes`</span> first)</span>
<span id="cb25-504"><a href="#cb25-504"></a></span>
<span id="cb25-505"><a href="#cb25-505"></a></span>
<span id="cb25-506"><a href="#cb25-506"></a><span class="fu">## Trust but verify</span></span>
<span id="cb25-507"><a href="#cb25-507"></a></span>
<span id="cb25-508"><a href="#cb25-508"></a><span class="ss">- </span>I just checked in a different crate.</span>
<span id="cb25-509"><a href="#cb25-509"></a></span>
<span id="cb25-510"><a href="#cb25-510"></a><span class="in">```{.rs filename="../???/src/main.rs"}</span></span>
<span id="cb25-511"><a href="#cb25-511"></a>fn <span class="fu">main</span>() {</span>
<span id="cb25-512"><a href="#cb25-512"></a>    let s <span class="ot">=</span> <span class="st">"Hello</span><span class="sc">\n</span><span class="st">world!"</span>;</span>
<span id="cb25-513"><a href="#cb25-513"></a>    dbg<span class="sc">!</span>(<span class="fu">s.as_bytes</span>());</span>
<span id="cb25-514"><a href="#cb25-514"></a>}</span>
<span id="cb25-515"><a href="#cb25-515"></a><span class="in">```</span></span>
<span id="cb25-516"><a href="#cb25-516"></a><span class="ss">- </span>Looked like 10 to me.</span>
<span id="cb25-517"><a href="#cb25-517"></a></span>
<span id="cb25-518"><a href="#cb25-518"></a><span class="fu">## Now it works!</span></span>
<span id="cb25-519"><a href="#cb25-519"></a></span>
<span id="cb25-520"><a href="#cb25-520"></a><span class="ss">- </span>We can write vertically!</span>
<span id="cb25-521"><a href="#cb25-521"></a><span class="ss">  - </span>I guess this could be a helper function or something.</span>
<span id="cb25-522"><a href="#cb25-522"></a></span>
<span id="cb25-523"><a href="#cb25-523"></a><span class="in">```{.rs filename="src/main.rs"}</span></span>
<span id="cb25-524"><a href="#cb25-524"></a>    vga<span class="sc">::</span><span class="fu">str_to_vga</span>(<span class="st">"H</span><span class="sc">\n</span><span class="st">e</span><span class="sc">\n</span><span class="st">l</span><span class="sc">\n</span><span class="st">l</span><span class="sc">\n</span><span class="st">o</span><span class="sc">\n\n</span><span class="st">w</span><span class="sc">\n</span><span class="st">o</span><span class="sc">\n</span><span class="st">r</span><span class="sc">\n</span><span class="st">l</span><span class="sc">\n</span><span class="st">d</span><span class="sc">\n</span><span class="st">!"</span>);</span>
<span id="cb25-525"><a href="#cb25-525"></a><span class="in">```</span></span>
<span id="cb25-526"><a href="#cb25-526"></a></span>
<span id="cb25-527"><a href="#cb25-527"></a><span class="fu">## Good thing...</span></span>
<span id="cb25-528"><a href="#cb25-528"></a></span>
<span id="cb25-529"><a href="#cb25-529"></a><span class="ss">- </span>I can print that more than once!</span>
<span id="cb25-530"><a href="#cb25-530"></a></span>
<span id="cb25-531"><a href="#cb25-531"></a><span class="in">```{.rs filename="src/main.rs"}</span></span>
<span id="cb25-532"><a href="#cb25-532"></a>    <span class="cf">for</span> _i <span class="cf">in</span> <span class="dv">0</span>..<span class="dv">3</span> {</span>
<span id="cb25-533"><a href="#cb25-533"></a>        vga<span class="sc">::</span><span class="fu">str_to_vga</span>(<span class="st">"H</span><span class="sc">\n</span><span class="st">e</span><span class="sc">\n</span><span class="st">l</span><span class="sc">\n</span><span class="st">l</span><span class="sc">\n</span><span class="st">o</span><span class="sc">\n\n</span><span class="st">w</span><span class="sc">\n</span><span class="st">o</span><span class="sc">\n</span><span class="st">r</span><span class="sc">\n</span><span class="st">l</span><span class="sc">\n</span><span class="st">d</span><span class="sc">\n</span><span class="st">!"</span>);</span>
<span id="cb25-534"><a href="#cb25-534"></a>    }</span>
<span id="cb25-535"><a href="#cb25-535"></a><span class="in">```</span></span>
<span id="cb25-536"><a href="#cb25-536"></a><span class="ss">- </span>Wait a minute!</span>
<span id="cb25-537"><a href="#cb25-537"></a></span>
<span id="cb25-538"><a href="#cb25-538"></a><span class="fu">## We're doomed</span></span>
<span id="cb25-539"><a href="#cb25-539"></a></span>
<span id="cb25-540"><a href="#cb25-540"></a><span class="ss">- </span>We didn't save what was written to the previous lines.</span>
<span id="cb25-541"><a href="#cb25-541"></a><span class="ss">- </span>Real ones know.</span>
<span id="cb25-542"><a href="#cb25-542"></a></span>
<span id="cb25-543"><a href="#cb25-543"></a><span class="al">![](https://upload.wikimedia.org/wikipedia/en/1/16/BladeRunnerRoyBattySpeech.jpeg)</span></span>
<span id="cb25-544"><a href="#cb25-544"></a></span>
<span id="cb25-545"><a href="#cb25-545"></a><span class="fu">## Unless?</span></span>
<span id="cb25-546"><a href="#cb25-546"></a></span>
<span id="cb25-547"><a href="#cb25-547"></a><span class="ss">- </span>No way can we *read* from the VGA text buffer right.</span>
<span id="cb25-548"><a href="#cb25-548"></a><span class="ss">- </span>That would be... extraordinary.</span>
<span id="cb25-549"><a href="#cb25-549"></a><span class="ss">- </span>You can do whatever you want, I just want to show you one possible design choice.</span>
<span id="cb25-550"><a href="#cb25-550"></a><span class="ss">    - </span>Mostly as a proof of concept.</span>
<span id="cb25-551"><a href="#cb25-551"></a></span>
<span id="cb25-552"><a href="#cb25-552"></a><span class="fu">## Scroll</span></span>
<span id="cb25-553"><a href="#cb25-553"></a></span>
<span id="cb25-554"><a href="#cb25-554"></a><span class="ss">- </span>I'll add some <span class="in">`const`</span>s and write a helper.</span>
<span id="cb25-555"><a href="#cb25-555"></a></span>
<span id="cb25-556"><a href="#cb25-556"></a><span class="in">```{.rs filename="src/vga.rs"}</span></span>
<span id="cb25-557"><a href="#cb25-557"></a>const ROWS<span class="sc">:</span> usize <span class="ot">=</span> <span class="dv">80</span>;</span>
<span id="cb25-558"><a href="#cb25-558"></a>const COLS<span class="sc">:</span> usize <span class="ot">=</span> <span class="dv">25</span>;</span>
<span id="cb25-559"><a href="#cb25-559"></a>const MAX<span class="sc">:</span> usize <span class="ot">=</span> ROWS <span class="sc">*</span> COLS;</span>
<span id="cb25-560"><a href="#cb25-560"></a></span>
<span id="cb25-561"><a href="#cb25-561"></a>fn <span class="fu">scroll</span>() {</span>
<span id="cb25-562"><a href="#cb25-562"></a>    todo<span class="sc">!</span>();</span>
<span id="cb25-563"><a href="#cb25-563"></a>}</span>
<span id="cb25-564"><a href="#cb25-564"></a><span class="in">```</span></span>
<span id="cb25-565"><a href="#cb25-565"></a></span>
<span id="cb25-566"><a href="#cb25-566"></a><span class="fu">## Execution</span></span>
<span id="cb25-567"><a href="#cb25-567"></a></span>
<span id="cb25-568"><a href="#cb25-568"></a><span class="ss">- </span>Start at the first character that will remain visible.</span>
<span id="cb25-569"><a href="#cb25-569"></a><span class="ss">- </span>Copy it to the earliest visible slot (start of buffer).</span>
<span id="cb25-570"><a href="#cb25-570"></a><span class="ss">- </span>Iterate until the full buffer is moved.</span>
<span id="cb25-571"><a href="#cb25-571"></a><span class="ss">- </span>We note this could be executed in a single <span class="in">`memmove`</span></span>
<span id="cb25-572"><a href="#cb25-572"></a><span class="ss">    - </span><span class="co">[</span><span class="ot">Read more</span><span class="co">](https://man7.org/linux/man-pages/man3/memmove.3.html)</span></span>
<span id="cb25-573"><a href="#cb25-573"></a></span>
<span id="cb25-574"><a href="#cb25-574"></a></span>
<span id="cb25-575"><a href="#cb25-575"></a><span class="fu">## My Code</span></span>
<span id="cb25-576"><a href="#cb25-576"></a></span>
<span id="cb25-577"><a href="#cb25-577"></a><span class="ss">- </span>Public just to test.</span>
<span id="cb25-578"><a href="#cb25-578"></a></span>
<span id="cb25-579"><a href="#cb25-579"></a><span class="in">```{.rs filename="src/vga.rs"}</span></span>
<span id="cb25-580"><a href="#cb25-580"></a>pub fn <span class="fu">scroll</span>() {</span>
<span id="cb25-581"><a href="#cb25-581"></a>    <span class="cf">for</span> i <span class="cf">in</span> <span class="dv">80</span>..MAX {</span>
<span id="cb25-582"><a href="#cb25-582"></a>        unsafe {</span>
<span id="cb25-583"><a href="#cb25-583"></a>            let src<span class="sc">:</span> <span class="er">*</span>mut u8 <span class="ot">=</span> ((MMIO as usize) <span class="sc">+</span> (i <span class="sc">*</span> <span class="dv">2</span>)) as <span class="sc">*</span>mut u8;</span>
<span id="cb25-584"><a href="#cb25-584"></a>            let dst<span class="sc">:</span> <span class="er">*</span>mut u8 <span class="ot">=</span> ((MMIO as usize) <span class="sc">+</span> ((i <span class="sc">-</span> <span class="dv">80</span>) <span class="sc">*</span> <span class="dv">2</span>)) as <span class="sc">*</span>mut u8;</span>
<span id="cb25-585"><a href="#cb25-585"></a>            <span class="sc">*</span>dst <span class="ot">=</span> <span class="er">*</span>src;</span>
<span id="cb25-586"><a href="#cb25-586"></a>        }</span>
<span id="cb25-587"><a href="#cb25-587"></a>    }</span>
<span id="cb25-588"><a href="#cb25-588"></a>}</span>
<span id="cb25-589"><a href="#cb25-589"></a><span class="in">```</span></span>
<span id="cb25-590"><a href="#cb25-590"></a></span>
<span id="cb25-591"><a href="#cb25-591"></a><span class="fu">## My Test</span></span>
<span id="cb25-592"><a href="#cb25-592"></a></span>
<span id="cb25-593"><a href="#cb25-593"></a><span class="ss">- </span>I just sent line numbers then manually scrolled.</span>
<span id="cb25-594"><a href="#cb25-594"></a></span>
<span id="cb25-595"><a href="#cb25-595"></a><span class="in">```{.rs filename="src/main.rs"}</span></span>
<span id="cb25-596"><a href="#cb25-596"></a>    vga<span class="sc">::</span><span class="fu">str_to_vga</span>(<span class="st">"0</span><span class="sc">\n</span><span class="st">1</span><span class="sc">\n</span><span class="st">2</span><span class="sc">\n</span><span class="st">3</span><span class="sc">\n</span><span class="st">4</span><span class="sc">\n</span><span class="st">5</span><span class="sc">\n</span><span class="st">6</span><span class="sc">\n</span><span class="st">7</span><span class="sc">\n</span><span class="st">8</span><span class="sc">\n</span><span class="st">9</span><span class="sc">\n</span><span class="st">A</span><span class="sc">\n</span><span class="st">B"</span>);</span>
<span id="cb25-597"><a href="#cb25-597"></a>    vga<span class="sc">::</span><span class="fu">scroll</span>();</span>
<span id="cb25-598"><a href="#cb25-598"></a><span class="in">```</span></span>
<span id="cb25-599"><a href="#cb25-599"></a></span>
<span id="cb25-600"><a href="#cb25-600"></a><span class="fu">## A better test</span></span>
<span id="cb25-601"><a href="#cb25-601"></a></span>
<span id="cb25-602"><a href="#cb25-602"></a><span class="ss">- </span>Here is a copy of the Project Gutenburg ebook of *Pride and Prejudice*.</span>
<span id="cb25-603"><a href="#cb25-603"></a><span class="ss">- </span>It contains some quotes which might be a problem.</span>
<span id="cb25-604"><a href="#cb25-604"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Link</span><span class="co">](https://raw.githubusercontent.com/cd-public/books/main/pg1342.txt)</span></span>
<span id="cb25-605"><a href="#cb25-605"></a><span class="in">```{.sh}</span></span>
<span id="cb25-606"><a href="#cb25-606"></a><span class="ex">https://raw.githubusercontent.com/cd-public/books/main/pg1342.txt</span></span>
<span id="cb25-607"><a href="#cb25-607"></a><span class="in">```</span></span>
<span id="cb25-608"><a href="#cb25-608"></a></span>
<span id="cb25-609"><a href="#cb25-609"></a><span class="fu">## Does it work?</span></span>
<span id="cb25-610"><a href="#cb25-610"></a></span>
<span id="cb25-611"><a href="#cb25-611"></a><span class="ss">- </span>What do we have to do?</span>
<span id="cb25-612"><a href="#cb25-612"></a></span>
<span id="cb25-613"><a href="#cb25-613"></a><span class="dt">&lt;</span><span class="kw">details</span><span class="dt">&gt;</span></span>
<span id="cb25-614"><a href="#cb25-614"></a><span class="ss">1. </span>Add <span class="in">`scroll`</span> to <span class="in">`str_to_vga`</span></span>
<span id="cb25-615"><a href="#cb25-615"></a><span class="ss">2. </span>Update <span class="in">`LATEST`</span> in <span class="in">`scroll`</span></span>
<span id="cb25-616"><a href="#cb25-616"></a><span class="ss">3. </span>Blank out the last line, I used space (<span class="in">`0x20`</span> or <span class="in">`32`</span>)</span>
<span id="cb25-617"><a href="#cb25-617"></a><span class="ss">4. </span>Make sure **all** color bytes are set.</span>
<span id="cb25-618"><a href="#cb25-618"></a><span class="dt">&lt;/</span><span class="kw">details</span><span class="dt">&gt;</span></span>
<span id="cb25-619"><a href="#cb25-619"></a></span>
<span id="cb25-620"><a href="#cb25-620"></a><span class="fu">## Why do we blank out?</span></span>
<span id="cb25-621"><a href="#cb25-621"></a></span>
<span id="cb25-622"><a href="#cb25-622"></a><span class="ss">- </span>Recall we are writing to MMIO.</span>
<span id="cb25-623"><a href="#cb25-623"></a><span class="ss">- </span>As soon as we exceed the MMIO range, we can *make no claims* about what memory we are vviewing.</span>
<span id="cb25-624"><a href="#cb25-624"></a><span class="ss">- </span>So if we copy in data past the buffer, we could get *anything*.</span>
<span id="cb25-625"><a href="#cb25-625"></a><span class="ss">- </span>So if we don't overwrite the buffer, we could get *anything*.</span>
<span id="cb25-626"><a href="#cb25-626"></a></span>
<span id="cb25-627"><a href="#cb25-627"></a><span class="fu">## We set color bytes?</span></span>
<span id="cb25-628"><a href="#cb25-628"></a></span>
<span id="cb25-629"><a href="#cb25-629"></a><span class="ss">- </span>Like lines off the MMIO range, the color bytes have no known value.</span>
<span id="cb25-630"><a href="#cb25-630"></a><span class="ss">- </span>So if we e.g. have a newline anywhere and end up not initially setting colors...</span>
<span id="cb25-631"><a href="#cb25-631"></a><span class="ss">- </span>Then copy text up to that line...</span>
<span id="cb25-632"><a href="#cb25-632"></a><span class="ss">- </span>We will be showing text in an *unset* color.</span>
<span id="cb25-633"><a href="#cb25-633"></a><span class="ss">    - </span>Just whatever bits happened to be there!</span>
<span id="cb25-634"><a href="#cb25-634"></a></span>
<span id="cb25-635"><a href="#cb25-635"></a><span class="fu">## This is unsafe!</span></span>
<span id="cb25-636"><a href="#cb25-636"></a></span>
<span id="cb25-637"><a href="#cb25-637"></a><span class="ss">- </span>Astute learners will notice this is all very unsafe.</span>
<span id="cb25-638"><a href="#cb25-638"></a></span>
<span id="cb25-639"><a href="#cb25-639"></a><span class="fu">## I'm loopy</span></span>
<span id="cb25-640"><a href="#cb25-640"></a></span>
<span id="cb25-641"><a href="#cb25-641"></a><span class="ss">- </span>I should not I do everything with <span class="in">`for`</span> loops and "single-equals-assignment"</span>
<span id="cb25-642"><a href="#cb25-642"></a><span class="ss">    - </span>I mostly am teaching you *how to code*</span>
<span id="cb25-643"><a href="#cb25-643"></a><span class="ss">    - </span>This is NOT teaching you *how to Rust* (or C)</span>
<span id="cb25-644"><a href="#cb25-644"></a><span class="ss">- </span>Who needs <span class="in">`memmove`</span> (a C function) when we have the humble <span class="in">`for`</span> loop.</span>
<span id="cb25-645"><a href="#cb25-645"></a><span class="ss">- </span>Read more: <span class="co">[</span><span class="ot">core::ptr::copy</span><span class="co">](https://doc.rust-lang.org/core/ptr/fn.copy.html)</span></span>
<span id="cb25-646"><a href="#cb25-646"></a></span>
<span id="cb25-647"><a href="#cb25-647"></a><span class="fu">## Caution!</span></span>
<span id="cb25-648"><a href="#cb25-648"></a></span>
<span id="cb25-649"><a href="#cb25-649"></a><span class="ss">- </span>I am building my crate without access to <span class="in">`memmove`</span>.</span>
<span id="cb25-650"><a href="#cb25-650"></a><span class="ss">- </span>You may need to go back and add some configuration.</span>
<span id="cb25-651"><a href="#cb25-651"></a><span class="ss">- </span>This was covered in the "Kernel" lecture.</span>
<span id="cb25-652"><a href="#cb25-652"></a><span class="ss">    - </span><span class="co">[</span><span class="ot">Here</span><span class="co">](40_kernel.qmd#aside-notfutureproofing-1)</span></span>
<span id="cb25-653"><a href="#cb25-653"></a></span>
<span id="cb25-654"><a href="#cb25-654"></a></span>
<span id="cb25-655"><a href="#cb25-655"></a><span class="fu">## My solution</span></span>
<span id="cb25-656"><a href="#cb25-656"></a></span>
<span id="cb25-657"><a href="#cb25-657"></a><span class="dt">&lt;</span><span class="kw">details</span><span class="dt">&gt;</span></span>
<span id="cb25-658"><a href="#cb25-658"></a></span>
<span id="cb25-659"><a href="#cb25-659"></a><span class="in">```{.rs filename="src/vga.rs"}</span></span>
<span id="cb25-660"><a href="#cb25-660"></a>const ROWS<span class="sc">:</span> usize <span class="ot">=</span> <span class="dv">80</span>;</span>
<span id="cb25-661"><a href="#cb25-661"></a>const COLS<span class="sc">:</span> usize <span class="ot">=</span> <span class="dv">25</span>;</span>
<span id="cb25-662"><a href="#cb25-662"></a>const MAX<span class="sc">:</span> usize <span class="ot">=</span> ROWS <span class="sc">*</span> COLS;</span>
<span id="cb25-663"><a href="#cb25-663"></a></span>
<span id="cb25-664"><a href="#cb25-664"></a>fn <span class="fu">scroll</span>() {</span>
<span id="cb25-665"><a href="#cb25-665"></a>    unsafe {</span>
<span id="cb25-666"><a href="#cb25-666"></a>        <span class="cf">for</span> i <span class="cf">in</span> <span class="dv">80</span>..MAX {</span>
<span id="cb25-667"><a href="#cb25-667"></a>            let src<span class="sc">:</span> <span class="er">*</span>mut u8 <span class="ot">=</span> (MMIO <span class="sc">+</span> i <span class="sc">*</span> <span class="dv">2</span>) as <span class="sc">*</span>mut u8;</span>
<span id="cb25-668"><a href="#cb25-668"></a>            let dst<span class="sc">:</span> <span class="er">*</span>mut u8 <span class="ot">=</span> (MMIO <span class="sc">+</span> (i <span class="sc">-</span> <span class="dv">80</span>) <span class="sc">*</span> <span class="dv">2</span>)<span class="er">)</span> as <span class="sc">*</span>mut u8;</span>
<span id="cb25-669"><a href="#cb25-669"></a>            <span class="sc">*</span>dst <span class="ot">=</span> <span class="er">*</span>src;</span>
<span id="cb25-670"><a href="#cb25-670"></a>            <span class="sc">*</span>((dst as usize <span class="sc">+</span> <span class="dv">1</span>) as <span class="sc">*</span>mut u8) <span class="ot">=</span> COLOR;</span>
<span id="cb25-671"><a href="#cb25-671"></a>        }</span>
<span id="cb25-672"><a href="#cb25-672"></a>        <span class="cf">for</span> i <span class="cf">in</span> (MAX<span class="dv">-80</span>)..MAX {</span>
<span id="cb25-673"><a href="#cb25-673"></a>            let dst<span class="sc">:</span> <span class="er">*</span>mut u8 <span class="ot">=</span> (MMIO <span class="sc">+</span> i <span class="sc">*</span> <span class="dv">2</span>) as <span class="sc">*</span>mut u8;</span>
<span id="cb25-674"><a href="#cb25-674"></a>            <span class="sc">*</span>dst <span class="ot">=</span> <span class="dv">32</span>;</span>
<span id="cb25-675"><a href="#cb25-675"></a>            <span class="sc">*</span>((dst as usize <span class="sc">+</span> <span class="dv">1</span>) as <span class="sc">*</span>mut u8) <span class="ot">=</span> COLOR;</span>
<span id="cb25-676"><a href="#cb25-676"></a>        }</span>
<span id="cb25-677"><a href="#cb25-677"></a>        LATEST <span class="ot">=</span> LATEST <span class="sc">-</span> <span class="dv">80</span>;</span>
<span id="cb25-678"><a href="#cb25-678"></a>    }</span>
<span id="cb25-679"><a href="#cb25-679"></a>}</span>
<span id="cb25-680"><a href="#cb25-680"></a></span>
<span id="cb25-681"><a href="#cb25-681"></a>pub fn <span class="fu">str_to_vga</span>(s<span class="sc">:</span> <span class="er">&amp;</span>str) {</span>
<span id="cb25-682"><a href="#cb25-682"></a>    let v <span class="ot">=</span> <span class="fu">s.as_bytes</span>();</span>
<span id="cb25-683"><a href="#cb25-683"></a>    unsafe {</span>
<span id="cb25-684"><a href="#cb25-684"></a>        <span class="cf">for</span> i <span class="cf">in</span> <span class="dv">0</span><span class="fu">..v.len</span>() {</span>
<span id="cb25-685"><a href="#cb25-685"></a>            <span class="cf">if</span> LATEST <span class="sc">&gt;</span> MAX {</span>
<span id="cb25-686"><a href="#cb25-686"></a>                <span class="fu">scroll</span>();</span>
<span id="cb25-687"><a href="#cb25-687"></a>            }</span>
<span id="cb25-688"><a href="#cb25-688"></a>            match v[i] {</span>
<span id="cb25-689"><a href="#cb25-689"></a>                <span class="dv">10</span> <span class="sc">=&gt;</span> LATEST <span class="ot">=</span> ((LATEST <span class="sc">/</span> <span class="dv">80</span>) <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="dv">80</span>,</span>
<span id="cb25-690"><a href="#cb25-690"></a>                _ <span class="sc">=&gt;</span> <span class="fu">char_to_vga</span>(v[i]),</span>
<span id="cb25-691"><a href="#cb25-691"></a>            }</span>
<span id="cb25-692"><a href="#cb25-692"></a>        }</span>
<span id="cb25-693"><a href="#cb25-693"></a>    }</span>
<span id="cb25-694"><a href="#cb25-694"></a>}</span>
<span id="cb25-695"><a href="#cb25-695"></a><span class="in">```</span></span>
<span id="cb25-696"><a href="#cb25-696"></a></span>
<span id="cb25-697"><a href="#cb25-697"></a><span class="dt">&lt;/</span><span class="kw">details</span><span class="dt">&gt;</span></span>
<span id="cb25-698"><a href="#cb25-698"></a></span>
<span id="cb25-699"><a href="#cb25-699"></a><span class="fu"># Volatile</span></span>
<span id="cb25-700"><a href="#cb25-700"></a></span>
<span id="cb25-701"><a href="#cb25-701"></a><span class="fu">## Best Practice</span></span>
<span id="cb25-702"><a href="#cb25-702"></a></span>
<span id="cb25-703"><a href="#cb25-703"></a><span class="ss">- </span>This works on my machine.</span>
<span id="cb25-704"><a href="#cb25-704"></a><span class="ss">- </span>It may not always work.</span>
<span id="cb25-705"><a href="#cb25-705"></a><span class="ss">- </span>Why? <span class="in">`rustc`</span> is a bit too smart.</span>
<span id="cb25-706"><a href="#cb25-706"></a><span class="ss">    - </span>There is no obvious externally observable reason to write to fixed memory location.</span>
<span id="cb25-707"><a href="#cb25-707"></a><span class="ss">    - </span>The compiler may optimize out such writes.</span>
<span id="cb25-708"><a href="#cb25-708"></a><span class="ss">    - </span>I say "sure it will."</span>
<span id="cb25-709"><a href="#cb25-709"></a></span>
<span id="cb25-710"><a href="#cb25-710"></a><span class="fu">## Quote Blog</span></span>
<span id="cb25-711"><a href="#cb25-711"></a></span>
<span id="cb25-712"><a href="#cb25-712"></a><span class="at">&gt; The problem is that we only write to the buffer and never read from it again. </span></span>
<span id="cb25-713"><a href="#cb25-713"></a></span>
<span id="cb25-714"><a href="#cb25-714"></a><span class="ss">- </span>Okay so but here me out.</span>
<span id="cb25-715"><a href="#cb25-715"></a><span class="ss">- </span>Our implementation does read from the buffer again.</span>
<span id="cb25-716"><a href="#cb25-716"></a><span class="ss">    - </span>Sometimes the best way to do things is also the simplest.</span>
<span id="cb25-717"><a href="#cb25-717"></a><span class="ss">    - </span>For some reason blog kept a local copy and only used that?</span>
<span id="cb25-718"><a href="#cb25-718"></a></span>
<span id="cb25-719"><a href="#cb25-719"></a><span class="fu">## Volatile</span></span>
<span id="cb25-720"><a href="#cb25-720"></a></span>
<span id="cb25-721"><a href="#cb25-721"></a><span class="ss">- </span>If we lacked the skill and bravery of the instructor of this course, we may have a problem.</span>
<span id="cb25-722"><a href="#cb25-722"></a><span class="ss">- </span>To avoid an erroneous optimization omitting all writes, we need to specify writes as _[volatile]_. </span>
<span id="cb25-723"><a href="#cb25-723"></a><span class="ss">- </span>This tells the compiler that the write has side effects and should not be optimized away.</span>
<span id="cb25-724"><a href="#cb25-724"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Read more</span><span class="co">]</span>(https://en.wikipedia.org/wiki/Volatile_(computer_programming))</span>
<span id="cb25-725"><a href="#cb25-725"></a></span>
<span id="cb25-726"><a href="#cb25-726"></a><span class="fu">## Interested Students</span></span>
<span id="cb25-727"><a href="#cb25-727"></a></span>
<span id="cb25-728"><a href="#cb25-728"></a><span class="ss">- </span>There's a <span class="in">`read_volatile`</span> and <span class="in">`write_volatile`</span> in <span class="in">`std::ptr`</span> and another in <span class="in">`core::ptr`</span>, we might be able to use those.</span>
<span id="cb25-729"><a href="#cb25-729"></a></span>
<span id="cb25-730"><a href="#cb25-730"></a><span class="fu"># Fin</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>