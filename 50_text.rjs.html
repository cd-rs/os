<!DOCTYPE html>
<html lang="en"><head>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-html/tabby.min.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/light-border.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-707d8167ce6003fca903bfe2be84ab7f.css" rel="stylesheet" id="quarto-text-highlighting-styles"><meta charset="utf-8">
  <meta name="generator" content="quarto-1.8.25">

  <title>OS in Rust – Text</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="site_libs/revealjs/dist/reset.css">
  <link rel="stylesheet" href="site_libs/revealjs/dist/reveal.css">
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    html { -webkit-text-size-adjust: 100%; }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
      }
    pre.numberSource { margin-left: 3em;  padding-left: 4px; }
    div.sourceCode
      { color: #f8f8f2;  }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span { color: #f8f8f2; } /* Normal */
    code span.al { color: #f07178; } /* Alert */
    code span.an { color: #d4d0ab; } /* Annotation */
    code span.at { color: #00e0e0; } /* Attribute */
    code span.bn { color: #d4d0ab; } /* BaseN */
    code span.bu { color: #abe338; } /* BuiltIn */
    code span.cf { color: #ffa07a; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #abe338; } /* Char */
    code span.cn { color: #ffd700; } /* Constant */
    code span.co { color: #f8f8f2; font-style: italic; } /* Comment */
    code span.cv { color: #ffd700; } /* CommentVar */
    code span.do { color: #f8f8f2; } /* Documentation */
    code span.dt { color: #ffa07a; } /* DataType */
    code span.dv { color: #d4d0ab; } /* DecVal */
    code span.er { color: #f07178; text-decoration: underline; } /* Error */
    code span.ex { color: #00e0e0; font-weight: bold; } /* Extension */
    code span.fl { color: #d4d0ab; } /* Float */
    code span.fu { color: #ffa07a; } /* Function */
    code span.im { color: #abe338; } /* Import */
    code span.in { color: #d4d0ab; } /* Information */
    code span.kw { color: #ffa07a; font-weight: bold; } /* Keyword */
    code span.op { color: #ffa07a; } /* Operator */
    code span.ot { color: #00e0e0; } /* Other */
    code span.pp { color: #dcc6e0; } /* Preprocessor */
    code span.re { color: #00e0e0; background-color: #f8f8f2; } /* RegionMarker */
    code span.sc { color: #abe338; } /* SpecialChar */
    code span.ss { color: #abe338; } /* SpecialString */
    code span.st { color: #abe338; } /* String */
    code span.va { color: #00e0e0; } /* Variable */
    code span.vs { color: #abe338; } /* VerbatimString */
    code span.wa { color: #dcc6e0; } /* Warning */
  </style>
  <link rel="stylesheet" href="site_libs/revealjs/dist/theme/quarto-1d86d68c35eb7061f9efcb6a994936f6.css">
  <link href="site_libs/revealjs/plugin/quarto-line-highlight/line-highlight.css" rel="stylesheet">
  <link href="site_libs/revealjs/plugin/reveal-menu/menu.css" rel="stylesheet">
  <link href="site_libs/revealjs/plugin/reveal-menu/quarto-menu.css" rel="stylesheet">
  <link href="site_libs/revealjs/plugin/quarto-support/footer.css" rel="stylesheet">
  <style type="text/css">
    .reveal div.sourceCode {
      margin: 0;
      overflow: auto;
    }
    .reveal div.hanging-indent {
      margin-left: 1em;
      text-indent: -1em;
    }
    .reveal .slide:not(.center) {
      height: 100%;
    }
    .reveal .slide.scrollable {
      overflow-y: auto;
    }
    .reveal .footnotes {
      height: 100%;
      overflow-y: auto;
    }
    .reveal .slide .absolute {
      position: absolute;
      display: block;
    }
    .reveal .footnotes ol {
      counter-reset: ol;
      list-style-type: none; 
      margin-left: 0;
    }
    .reveal .footnotes ol li:before {
      counter-increment: ol;
      content: counter(ol) ". "; 
    }
    .reveal .footnotes ol li > p:first-child {
      display: inline-block;
    }
    .reveal .slide ul,
    .reveal .slide ol {
      margin-bottom: 0.5em;
    }
    .reveal .slide ul li,
    .reveal .slide ol li {
      margin-top: 0.4em;
      margin-bottom: 0.2em;
    }
    .reveal .slide ul[role="tablist"] li {
      margin-bottom: 0;
    }
    .reveal .slide ul li > *:first-child,
    .reveal .slide ol li > *:first-child {
      margin-block-start: 0;
    }
    .reveal .slide ul li > *:last-child,
    .reveal .slide ol li > *:last-child {
      margin-block-end: 0;
    }
    .reveal .slide .columns:nth-child(3) {
      margin-block-start: 0.8em;
    }
    .reveal blockquote {
      box-shadow: none;
    }
    .reveal .tippy-content>* {
      margin-top: 0.2em;
      margin-bottom: 0.7em;
    }
    .reveal .tippy-content>*:last-child {
      margin-bottom: 0.2em;
    }
    .reveal .slide > img.stretch.quarto-figure-center,
    .reveal .slide > img.r-stretch.quarto-figure-center {
      display: block;
      margin-left: auto;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-left,
    .reveal .slide > img.r-stretch.quarto-figure-left  {
      display: block;
      margin-left: 0;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-right,
    .reveal .slide > img.r-stretch.quarto-figure-right  {
      display: block;
      margin-left: auto;
      margin-right: 0; 
    }
  </style>
</head>
<body class="quarto-dark">
  <div class="reveal">
    <div class="slides">

<section id="title-slide" class="quarto-title-block center">
  <h1 class="title">Text</h1>
  <p class="subtitle">OS in Rust</p>

<div class="quarto-title-authors">
</div>

</section>
<section id="announcements" class="slide level2">
<h2>Announcements</h2>
<ul>
<li><strong>Action Items</strong>:
<ul>
<li>Do you text output yet?
<ul>
<li>The coolest assignment ever for a third week in a row.</li>
<li>How do I keep getting away with it.</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="citations" class="slide level2">
<h2>Citations</h2>
<ul>
<li>I tried to steal this but I thought it was too bad and changed everything.
<ul>
<li><a href="https://os.phil-opp.com/vga-text-mode/">VGA Text Mode</a></li>
</ul></li>
</ul>
</section>
<section>
<section id="background" class="title-slide slide level1 center">
<h1>Background</h1>

</section>
<section id="vga-text-mode" class="slide level2">
<h2>VGA Text Mode</h2>
<ul>
<li>We recall <a href="https://en.wikipedia.org/wiki/VGA-compatible_text_mode">VGA text mode</a> from the homework.
<ul>
<li>A simple way to print text to the screen.</li>
</ul></li>
<li>We recall that Rust prints via a “macro”</li>
<li>Now we:
<ul>
<li>Create an interface to encapsulating all unsafety in a separate module.</li>
<li>We also implement support for Rust’s <a href="https://en.wikipedia.org/wiki/VGA-compatible_text_mode">formatting macros</a></li>
</ul></li>
</ul>
</section>
<section id="the-buffer" class="slide level2">
<h2>The Buffer</h2>
<ul>
<li>To print a character to the screen in VGA text mode, one has to write it to the text buffer of the VGA hardware.
<ul>
<li>A byte passing over a bus to fixed location will render as ASCII on a screen.</li>
</ul></li>
</ul>
</section>
<section id="d-or-2d" class="slide level2">
<h2>1d or 2d</h2>
<ul>
<li>The VGA text buffer renders as two-dimensional array.
<ul>
<li>Addressed as a one dimensional array.</li>
<li>Safe to assume 25 rows and 80 columns.</li>
<li>Each position is an ASCII (<em>not</em> unicode) character.</li>
</ul></li>
</ul>
</section>
<section id="format" class="slide level2">
<h2>Format</h2>
<ul>
<li>Describes a single screen character through the following format:</li>
</ul>
<table class="caption-top">
<thead>
<tr class="header">
<th>Bit(s)</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0-7</td>
<td>ASCII code point</td>
</tr>
<tr class="even">
<td>8-11</td>
<td>Foreground color</td>
</tr>
<tr class="odd">
<td>12-14</td>
<td>Background color</td>
</tr>
<tr class="even">
<td>15</td>
<td>Blink</td>
</tr>
</tbody>
</table>
<ul>
<li>I did not see blinking.</li>
</ul>
</section>
<section id="first-byte" class="slide level2">
<h2>First Byte</h2>
<ul>
<li>The first byte represents the character that should be printed in the [ASCII encoding].
<ul>
<li>We recall we say many mentions of Python in firmware jobs.</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a></a><span class="ex">python3</span> <span class="at">-c</span> <span class="st">"[print(chr(a), ':', a) for a in range(ord('A'), ord('z')+1)]"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div></li>
</ul>
</section>
<section id="except" class="slide level2">
<h2>Except</h2>
<ul>
<li>Okay it isn’t actually ASCII.</li>
<li>It’s <a href="https://en.wikipedia.org/wiki/Code_page_437"><em>code page 437</em></a></li>
<li>We think of it as an IBM specific ASCII extension and just use the ASCII subset.</li>
</ul>
</section>
<section id="second-byte" class="slide level2">
<h2>Second Byte</h2>
<ul>
<li>The second <strong>byte</strong> defines how the character is displayed.
<ul>
<li>The first <strong>four</strong> bits define the foreground color.</li>
<li>The next three bits the background color</li>
<li><em>Nominally</em> the last bit whether the character should blink.
<ul>
<li>I did not see blinking.</li>
<li>May be a <code>qemu</code> thing I’m not sure.</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="colors" class="slide level2 smaller">
<h2>Colors</h2>
<ul>
<li>Using octal.</li>
</ul>
<table class="caption-top">
<thead>
<tr class="header">
<th>Number</th>
<th>Color</th>
<th>Bright</th>
<th>Bright Color</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0o00</td>
<td>Black</td>
<td>0o10</td>
<td>Dark Gray</td>
</tr>
<tr class="even">
<td>0o01</td>
<td>Blue</td>
<td>0o11</td>
<td>Light Blue</td>
</tr>
<tr class="odd">
<td>0o02</td>
<td>Green</td>
<td>0o12</td>
<td>Light Green</td>
</tr>
<tr class="even">
<td>0o03</td>
<td>Cyan</td>
<td>0o13</td>
<td>Light Cyan</td>
</tr>
<tr class="odd">
<td>0o04</td>
<td>Red</td>
<td>0o14</td>
<td>Light Red</td>
</tr>
<tr class="even">
<td>0o05</td>
<td>Magenta</td>
<td>0o15</td>
<td>Pink</td>
</tr>
<tr class="odd">
<td>0o06</td>
<td>Brown</td>
<td>0o16</td>
<td>Yellow</td>
</tr>
<tr class="even">
<td>0o07</td>
<td>Light Gray</td>
<td>0o17</td>
<td>White</td>
</tr>
</tbody>
</table>
</section>
<section id="brightblink" class="slide level2">
<h2>Bright/Blink</h2>
<ul>
<li>Bit 4 is the <em>bright bit</em>.
<ul>
<li>For example, blue into light blue.</li>
</ul></li>
<li>For the background color, this bit is nominally repurposed as the blink bit.</li>
</ul>
</section>
<section id="memory-mapped-io" class="slide level2">
<h2>Memory-mapped I/O</h2>
<ul>
<li>Okay so this is cool.</li>
<li>Recall the bus!</li>
<li>We are going to steal some diagrams.
<ul>
<li>Thanks <a href="https://www.geeksforgeeks.org/computer-organization-architecture/memory-mapped-i-o-and-isolated-i-o/">Geeks for Geeks</a></li>
</ul></li>
</ul>
</section>
<section id="isolated-io" class="slide level2">
<h2>Isolated I/O</h2>
<ul>
<li>Imagine a form of I/O that isn’t cool.</li>
<li>It may have separate address spaces.
<ul>
<li>So there may be a <code>0x64</code> memory location and also <code>0x64</code> device.</li>
</ul></li>
</ul>

<img data-src="https://media.geeksforgeeks.org/wp-content/uploads/20250506151408311194/isolate-io.webp" class="r-stretch"></section>
<section id="this-isnt-cool" class="slide level2">
<h2>This isn’t cool</h2>
<ul>
<li>We already discussed Harvard vs.&nbsp;von Neumann architecture.</li>
<li>Having two memory spaces is not at all cool.</li>
<li>So we don’t do it.</li>
<li>There’s also port-mapped I/O (similarly not cool.</li>
</ul>
</section>
<section id="memory-mapped-io-1" class="slide level2">
<h2>Memory-Mapped I/O</h2>
<ul>
<li>Imagine the following.
<ul>
<li>The bootloader lives at <code>0x0</code></li>
<li>The OS lives at <code>0x1</code></li>
<li>The keyboard lives at <code>0x2</code></li>
<li>The internet (via a network card) at <code>0x3</code></li>
<li>The monitor at <code>0x4</code></li>
</ul></li>
<li>This obviously cool.</li>
</ul>
</section>
<section id="altogether" class="slide level2">
<h2>Altogether</h2>
<ul>
<li>One Big Happy Memory Space</li>
</ul>

<img data-src="https://media.geeksforgeeks.org/wp-content/uploads/20250506151651561116/memory-io.webp" class="r-stretch"></section>
<section id="downsides" class="slide level2">
<h2>Downsides</h2>
<ul>
<li>MMIO is a helpful <em>abstraction</em> - we already know how to think about memory, so we don’t need to learn much to do I/O.
<ul>
<li>There’s downsides.</li>
<li>We shouldn’t be able to write to keyboard, probably.</li>
<li>Or read from a monitor.</li>
</ul></li>
<li>But its fast and easy, like BIOS vs.&nbsp;UEFI.</li>
</ul>
</section></section>
<section>
<section id="x86_64" class="title-slide slide level1 center">
<h1>x86_64</h1>

</section>
<section id="in-x86_64" class="slide level2">
<h2>In x86_64</h2>
<ul>
<li>On our emulated device, VGA text buffer lives at address <code>0xb8000</code>.
<ul>
<li>Absolute geniuses will crack open C and get into trouble.</li>
</ul></li>
<li>So any read to this location:
<ul>
<li>Doesn’t go to MMU/RAM/SSD</li>
<li>Does go to VGA hardware</li>
</ul></li>
</ul>
</section>
<section id="alert" class="slide level2">
<h2>Alert!</h2>
<ul>
<li>MMIO, especially older devices, might not support all normal operations.</li>
<li>For example, a device could only support byte-wise reads and return junk when a <code>u64</code> is read.
<ul>
<li>Block-write “Hello world!” is a homework extension.</li>
</ul></li>
<li><a href="https://web.stanford.edu/class/cs140/projects/pintos/specs/freevga/vga/vgamem.htm#manip">Read more</a></li>
</ul>
</section>
<section id="a-rust-module" class="slide level2">
<h2>A Rust Module</h2>
<ul>
<li>Now we “know” how the VGA buffer works.</li>
<li>We can create a Rust module to handle print and standard out:</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/main.rs</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" data-filename="src/main.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb2-1"><a></a><span class="kw">mod</span> vga<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<ul>
<li>We also must create a new <code>src/vga.rs</code> file.</li>
</ul>
<!--

## Colors

- Represent colors using an `enum`:

```{.rs filename="src/vga.rs"}
#[allow(dead_code)]
#[derive(Debug, Clone, Copy, PartialEq, Eq)]
#[repr(u8)]
pub enum Color {
    Blck = 0o00,
    Blue = 0o01,
    Gren = 0o02,
    Cyan = 0o03,
    Redd = 0o04,
    Mgnt = 0o05,
    Brwn = 0o06,
    LGry = 0o07,
    DGry = 0o10,
    LBlu = 0o11,
    LGrn = 0o12,
    LCyn = 0o13,
    LRed = 0o14,
    Pink = 0o15,
    Yelo = 0o16,
    Whte = 0o17,
}
```

## Notes

- We use a [C-like enum] here to explicitly specify the number for each color. 
- Because of the `repr(u8)` attribute, each enum variant is stored as a `u8`. 
    - I would use `u4` type (a nib) if I was allowed to.
-  Rust on the [C-like enum](https://doc.rust-lang.org/rust-by-example/custom_types/enum/c_like.html)
    - At some point we have to figure out why we aren't writing C.

## Suppress Warnings

- Normally the compiler would issue a warning for each unused variant. 
    - This seems obviously annoying to me.
- By using the `#[allow(dead_code)]` attribute, we disable these warnings for the `Color` enum.

## Comparisons

- By [deriving] the [`Copy`], [`Clone`], [`Debug`], [`PartialEq`], and [`Eq`] traits, we:
    - Get stack-like (vs. heap-like) behavior.
    - Make it printable.
    - Make it comparable (e.g. via double-equals-equality `==`)
- I would obviously just use an u8 here but don't be like me, I am wrong in some way that may be important latter.

## Links

- [deriving](https://doc.rust-lang.org/rust-by-example/trait/derive.html)
- [`Copy`](https://doc.rust-lang.org/nightly/core/marker/trait.Copy.html)
- [`Clone`](https://doc.rust-lang.org/nightly/core/clone/trait.Clone.html)
- [`Debug`](https://doc.rust-lang.org/nightly/core/fmt/trait.Debug.html)
- [`PartialEq`](https://doc.rust-lang.org/nightly/core/cmp/trait.PartialEq.html)
- [`Eq`](https://doc.rust-lang.org/nightly/core/cmp/trait.Eq.html)
- [copy semantics](https://doc.rust-lang.org/1.30.0/book/first-edition/ownership.html#copy-types)


## New Type

- A full color code specifies foreground *and* background color
- We create a [newtype](https://doc.rust-lang.org/rust-by-example/generics/new_types.html) on top of `u8`


```{.rs filename="src/vga.rs"}
#[derive(Debug, Clone, Copy, PartialEq, Eq)]
#[repr(transparent)]
struct ColorCode(u8);

impl ColorCode {
    fn new(fg: Color, b: Color) -> ColorCode {
        ColorCode((bg as u8) << 4 | (fg as u8))
    }
}
```

## Transparency

- Again, we derive the `Copy` and `Debug` traits for it. 
- When working with low level devices, we need to ensure bits are where we expect them to be.
- To ensure that the `ColorCode` has the exact same data layout as a `u8`, we use the [`repr(transparent)`] attribute.
    - [Read more](https://doc.rust-lang.org/nomicon/other-reprs.html#reprtransparent)
<!--
## Text Buffer

- Now we can add structures to represent a screen character and the text buffer:

```{.rs filename="src/vga.rs"}
#[derive(Debug, Clone, Copy, PartialEq, Eq)]
#[repr(C)]
struct ScreenChar {
    ascii_character: u8,
    color_code: ColorCode,
}

const BUFFER_HEIGHT: usize = 25;
const BUFFER_WIDTH: usize = 80;

#[repr(transparent)]
struct Buffer {
    chars: [[ScreenChar; BUFFER_WIDTH]; BUFFER_HEIGHT],
}
```

## C Representation

- Field ordering in default structs is undefined in Rust!
- Not so in the good language, C.
- We use the [`repr(C)`] attribute. 
  - It guarantees that the struct's fields are laid out in order. `
  - [`repr(C)`](https://doc.rust-lang.org/nightly/nomicon/other-reprs.html#reprc)
- For the `Buffer` struct, we use [`repr(transparent)`] again to ensure that it has the same memory layout as its single field.
-->
</section>
<section id="standard-out" class="slide level2">
<h2>Standard Out</h2>
<ul>
<li>To provide “standard out” like functionality, I will:
<ul>
<li>Maintain the most recent position to which a character has been written.</li>
</ul></li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/vga.rs</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" data-filename="src/vga.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb3-1"><a></a><span class="kw">static</span> <span class="kw">mut</span> latest<span class="op">:</span> <span class="dt">usize</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="location" class="slide level2">
<h2>Location</h2>
<ul>
<li>To provide “standard out” like functionality, I will:
<ul>
<li>Maintain the most recent position to which a character has been written.</li>
<li>Have a constant referring to to the VGA buffer address.</li>
</ul></li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/vga.rs</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" data-filename="src/vga.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb4-1"><a></a><span class="kw">static</span> <span class="kw">mut</span> latest<span class="op">:</span><span class="dt">usize</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb4-2"><a></a><span class="kw">const</span> MMIO <span class="op">=</span> <span class="dv">0xb8000</span> <span class="kw">as</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">u8</span><span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="color" class="slide level2">
<h2>Color</h2>
<ul>
<li>To provide “standard out” like functionality, I will:
<ul>
<li>Provide a way to write a character.
<ul>
<li>I will use a <code>const</code> for color and not worry about.</li>
</ul></li>
</ul></li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/vga.rs</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5" data-filename="src/vga.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb5-1"><a></a><span class="kw">static</span> <span class="kw">mut</span> latest<span class="op">:</span><span class="dt">usize</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb5-2"><a></a><span class="kw">const</span> MMIO <span class="op">=</span> <span class="dv">0xb8000</span> <span class="kw">as</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">u8</span><span class="op">;</span></span>
<span id="cb5-3"><a></a><span class="kw">const</span> COLOR<span class="op">:</span> u <span class="op">=</span> <span class="dv">0xF</span><span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="character-wise" class="slide level2">
<h2>Character-wise</h2>
<ul>
<li>To provide “standard out” like functionality, I will:
<ul>
<li>Provide a way to write a character.
<ul>
<li>I will write a function to push one character.</li>
</ul></li>
</ul></li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/vga.rs</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6" data-filename="src/vga.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb6-1"><a></a><span class="co">// Public for now</span></span>
<span id="cb6-2"><a></a><span class="kw">pub</span> <span class="kw">fn</span> char_to_vga(a<span class="op">:</span> <span class="dt">u8</span>) <span class="op">{</span></span>
<span id="cb6-3"><a></a>    <span class="pp">todo!</span>()<span class="op">;</span></span>
<span id="cb6-4"><a></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="stepwise" class="slide level2">
<h2>Stepwise</h2>
<ol type="1">
<li>Compute absolute location from relative location.</li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/vga.rs</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7" data-filename="src/vga.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb7-1"><a></a><span class="co">// Public for now</span></span>
<span id="cb7-2"><a></a><span class="kw">pub</span> <span class="kw">fn</span> char_to_vga(a<span class="op">:</span> <span class="dt">u8</span>) <span class="op">{</span></span>
<span id="cb7-3"><a></a>    <span class="kw">let</span> rel<span class="op">:</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">u8</span> <span class="op">=</span> ((MMIO <span class="kw">as</span> <span class="dt">usize</span>) <span class="op">+</span> (latest <span class="op">*</span> <span class="dv">2</span>)) <span class="kw">as</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">u8</span><span class="op">;</span></span>
<span id="cb7-4"><a></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="stepwise-1" class="slide level2">
<h2>Stepwise</h2>
<ol type="1">
<li>Compute absolute location from relative location.</li>
<li>Store a value at that location.</li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/vga.rs</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8" data-filename="src/vga.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb8-1"><a></a><span class="co">// Public for now</span></span>
<span id="cb8-2"><a></a><span class="kw">pub</span> <span class="kw">fn</span> char_to_vga(a<span class="op">:</span> <span class="dt">u8</span>) <span class="op">{</span></span>
<span id="cb8-3"><a></a>    <span class="kw">let</span> rel<span class="op">:</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">u8</span> <span class="op">=</span> ((MMIO <span class="kw">as</span> <span class="dt">usize</span>) <span class="op">+</span> (latest <span class="op">*</span> <span class="dv">2</span>)) <span class="kw">as</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">u8</span><span class="op">;</span></span>
<span id="cb8-4"><a></a>    <span class="op">*</span>rel <span class="op">=</span> a<span class="op">;</span></span>
<span id="cb8-5"><a></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="stepwise-2" class="slide level2">
<h2>Stepwise</h2>
<ol type="1">
<li>Compute absolute location from relative location.</li>
<li>Store a value at that location.</li>
<li>Store a color at the next location.</li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/vga.rs</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9" data-filename="src/vga.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb9-1"><a></a><span class="co">// Public for now</span></span>
<span id="cb9-2"><a></a><span class="kw">pub</span> <span class="kw">fn</span> char_to_vga(a<span class="op">:</span> <span class="dt">u8</span>) <span class="op">{</span></span>
<span id="cb9-3"><a></a>    <span class="kw">let</span> rel<span class="op">:</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">u8</span> <span class="op">=</span> ((MMIO <span class="kw">as</span> <span class="dt">usize</span>) <span class="op">+</span> (latest <span class="op">*</span> <span class="dv">2</span>)) <span class="kw">as</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">u8</span><span class="op">;</span></span>
<span id="cb9-4"><a></a>    <span class="op">*</span>rel <span class="op">=</span> a<span class="op">;</span></span>
<span id="cb9-5"><a></a>        <span class="op">*</span>((rel <span class="kw">as</span> <span class="dt">usize</span> <span class="op">+</span> <span class="dv">1</span>) <span class="kw">as</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">u8</span>) <span class="op">=</span> COLOR<span class="op">;</span></span>
<span id="cb9-6"><a></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="stepwise-3" class="slide level2">
<h2>Stepwise</h2>
<ol type="1">
<li>Compute absolute location from relative location.</li>
<li>Store a value at that location.</li>
<li>Store a color at the next location.</li>
<li>Increment the latest.</li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/vga.rs</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10" data-filename="src/vga.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb10-1"><a></a><span class="co">// Public for now</span></span>
<span id="cb10-2"><a></a><span class="kw">pub</span> <span class="kw">fn</span> char_to_vga(a<span class="op">:</span> <span class="dt">u8</span>) <span class="op">{</span></span>
<span id="cb10-3"><a></a>    <span class="kw">let</span> rel<span class="op">:</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">u8</span> <span class="op">=</span> ((MMIO <span class="kw">as</span> <span class="dt">usize</span>) <span class="op">+</span> (latest <span class="op">*</span> <span class="dv">2</span>)) <span class="kw">as</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">u8</span><span class="op">;</span></span>
<span id="cb10-4"><a></a>    <span class="op">*</span>rel <span class="op">=</span> a<span class="op">;</span></span>
<span id="cb10-5"><a></a>        <span class="op">*</span>((rel <span class="kw">as</span> <span class="dt">usize</span> <span class="op">+</span> <span class="dv">1</span>) <span class="kw">as</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">u8</span>) <span class="op">=</span> COLOR<span class="op">;</span></span>
<span id="cb10-6"><a></a>        LATEST <span class="op">=</span> LATEST <span class="op">+</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb10-7"><a></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="test-it" class="slide level2">
<h2>Test it</h2>
<ul>
<li>It is trivial to test.</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/main.rs</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11" data-filename="src/main.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb11-1"><a></a>    <span class="kw">let</span> hi<span class="op">:</span> <span class="op">&amp;</span>[<span class="dt">u8</span>] <span class="op">=</span> <span class="st">b"Hello World!"</span><span class="op">;</span></span>
<span id="cb11-2"><a></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="dv">0</span><span class="op">..</span><span class="dv">12</span> <span class="op">{</span></span>
<span id="cb11-3"><a></a>        <span class="pp">vga::</span>char_to_vga(hi[i])<span class="op">;</span></span>
<span id="cb11-4"><a></a>    <span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<ul>
<li>“Works on my machine!” - me
<ul>
<li>Unless?</li>
<li>We’ll come back to this.</li>
</ul></li>
</ul>
</section>
<section id="annoying" class="slide level2">
<h2>Annoying</h2>
<ul>
<li>Some of you may lack a strong work ethic and want to show entire a whole <em>string</em> rather than just a character at a time.
<ul>
<li>Especially since using characters of a string in Rust is ludicrously opaque.</li>
</ul></li>
<li>Not to worry.</li>
</ul>
</section>
<section id="target-str" class="slide level2">
<h2>Target <code>&amp;str</code></h2>
<ul>
<li>We can abstract to loop into <code>src/vga.rs</code></li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/vga.rs</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12" data-filename="src/vga.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb12-1"><a></a><span class="kw">pub</span> <span class="kw">fn</span> str_to_vga(s<span class="op">:</span> <span class="op">&amp;</span><span class="dt">str</span>) <span class="op">{</span></span>
<span id="cb12-2"><a></a>    <span class="kw">let</span> v <span class="op">=</span> s<span class="op">.</span>as_bytes()<span class="op">;</span></span>
<span id="cb12-3"><a></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="dv">0</span><span class="op">..</span>v<span class="op">.</span>len() <span class="op">{</span></span>
<span id="cb12-4"><a></a>        char_to_vga(v[i])<span class="op">;</span></span>
<span id="cb12-5"><a></a>    <span class="op">}</span></span>
<span id="cb12-6"><a></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="aside" class="slide level2">
<h2>Aside</h2>
<ul>
<li>I am opinionated on <code>as_bytes</code>.</li>
<li>Let’s check some links.
<ul>
<li><a href="https://doc.rust-lang.org/std/?search=to_bytes"><code>to_bytes</code></a>
<ul>
<li><a href="https://doc.rust-lang.org/std/?search=as_bytes"><code>as_bytes</code></a></li>
</ul></li>
<li><a href="https://doc.rust-lang.org/std/?search=bytes"><code>bytes</code></a></li>
</ul></li>
<li>Can you guess what always works?</li>
</ul>
</section>
<section id="aside-1" class="slide level2">
<h2>Aside</h2>
<ul>
<li>Big Rust doesn’t want you to know you can use pointers.</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/vga.rs</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13" data-filename="src/vga.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb13-1"><a></a>    <span class="kw">let</span> ptr <span class="op">=</span> s<span class="op">.</span>as_ptr() <span class="kw">as</span> <span class="dt">usize</span><span class="op">;</span></span>
<span id="cb13-2"><a></a>    <span class="kw">unsafe</span> <span class="op">{</span></span>
<span id="cb13-3"><a></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="dv">0</span><span class="op">..</span>s<span class="op">.</span>len() <span class="op">{</span></span>
<span id="cb13-4"><a></a>            char_to_vga(<span class="op">*</span>((ptr <span class="op">+</span> i) <span class="kw">as</span> <span class="op">*</span><span class="kw">const</span> <span class="dt">u8</span>))<span class="op">;</span></span>
<span id="cb13-5"><a></a>        <span class="op">}</span></span>
<span id="cb13-6"><a></a>    <span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<ul>
<li>I could make this even worse but I didn’t.</li>
<li>Anyways don’t do this.</li>
</ul>
</section>
<section id="update-main" class="slide level2">
<h2>Update main</h2>
<ul>
<li>Look how nice that is!</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/main.rs</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14" data-filename="src/main.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb14-1"><a></a><span class="at">#[</span><span class="kw">unsafe</span><span class="at">(</span>no_mangle<span class="at">)]</span></span>
<span id="cb14-2"><a></a><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">"C"</span> <span class="kw">fn</span> _start() <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb14-3"><a></a>    <span class="pp">vga::</span>str_to_vga(<span class="st">"Hello, world!"</span>)<span class="op">;</span></span>
<span id="cb14-4"><a></a>    <span class="cf">loop</span> <span class="op">{}</span></span>
<span id="cb14-5"><a></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="i-bet" class="slide level2">
<h2>I bet…</h2>
<ul>
<li>I bet we can print <em>any</em> string.</li>
<li>Let’s do like a comically easy string that will definitely print.</li>
<li>There’s no way it will fail.</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/main.rs</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15" data-filename="src/main.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb15-1"><a></a>    <span class="pp">vga::</span>str_to_vga(<span class="st">"Hello</span><span class="sc">\n</span><span class="st">world!"</span>)<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<ul>
<li>It worked right?</li>
</ul>
</section>
<section id="escape-codes" class="slide level2">
<h2>Escape Codes</h2>
<ul>
<li>Okay so there’s some things we need to treat differently.
<ul>
<li>Minimally <code>\n</code>.</li>
<li>And therefore also <code>\\</code> to show a single backslash.</li>
<li>I don’t even know if we need anything else, but I’ll show the design pattern.</li>
</ul></li>
</ul>
</section>
<section id="revisit-implementation" class="slide level2">
<h2>Revisit Implementation</h2>
<ul>
<li>Recall our naive implementation.</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/vga.rs</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb16" data-filename="src/vga.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb16-1"><a></a><span class="kw">pub</span> <span class="kw">fn</span> str_to_vga(s<span class="op">:</span> <span class="op">&amp;</span><span class="dt">str</span>) <span class="op">{</span></span>
<span id="cb16-2"><a></a>    <span class="kw">let</span> v <span class="op">=</span> s<span class="op">.</span>as_bytes()<span class="op">;</span></span>
<span id="cb16-3"><a></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="dv">0</span><span class="op">..</span>v<span class="op">.</span>len() <span class="op">{</span></span>
<span id="cb16-4"><a></a>        char_to_vga(v[i])<span class="op">;</span></span>
<span id="cb16-5"><a></a>    <span class="op">}</span></span>
<span id="cb16-6"><a></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="case-analysis" class="slide level2">
<h2>Case analysis</h2>
<ul>
<li>As far as I know (I didn’t check) we only have to look for is:
<ul>
<li><code>\n</code></li>
<li><code>10</code> (I think?)</li>
<li><code>0xa</code></li>
</ul></li>
<li>It will be a <code>u8</code> within the loop (since we <code>as_bytes</code> first)</li>
</ul>
</section>
<section id="trust-but-verify" class="slide level2">
<h2>Trust but verify</h2>
<ul>
<li>I just checked in a different crate.</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>../???/src/main.rs</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb17" data-filename="../???/src/main.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb17-1"><a></a><span class="kw">fn</span> main() <span class="op">{</span></span>
<span id="cb17-2"><a></a>    <span class="kw">let</span> s <span class="op">=</span> <span class="st">"Hello</span><span class="sc">\n</span><span class="st">world!"</span><span class="op">;</span></span>
<span id="cb17-3"><a></a>    <span class="pp">dbg!</span>(s<span class="op">.</span>as_bytes())<span class="op">;</span></span>
<span id="cb17-4"><a></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<ul>
<li>Looked like 10 to me.</li>
</ul>
</section>
<section id="now-it-works" class="slide level2">
<h2>Now it works!</h2>
<ul>
<li>We can write vertically!
<ul>
<li>I guess this could be a helper function or something.</li>
</ul></li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/main.rs</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb18" data-filename="src/main.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb18-1"><a></a>    <span class="pp">vga::</span>str_to_vga(<span class="st">"H</span><span class="sc">\n</span><span class="st">e</span><span class="sc">\n</span><span class="st">l</span><span class="sc">\n</span><span class="st">l</span><span class="sc">\n</span><span class="st">o</span><span class="sc">\n\n</span><span class="st">w</span><span class="sc">\n</span><span class="st">o</span><span class="sc">\n</span><span class="st">r</span><span class="sc">\n</span><span class="st">l</span><span class="sc">\n</span><span class="st">d</span><span class="sc">\n</span><span class="st">!"</span>)<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="good-thing" class="slide level2">
<h2>Good thing…</h2>
<ul>
<li>I can print that more than once!</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/main.rs</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb19" data-filename="src/main.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb19-1"><a></a>    <span class="cf">for</span> _i <span class="kw">in</span> <span class="dv">0</span><span class="op">..</span><span class="dv">3</span> <span class="op">{</span></span>
<span id="cb19-2"><a></a>        <span class="pp">vga::</span>str_to_vga(<span class="st">"H</span><span class="sc">\n</span><span class="st">e</span><span class="sc">\n</span><span class="st">l</span><span class="sc">\n</span><span class="st">l</span><span class="sc">\n</span><span class="st">o</span><span class="sc">\n\n</span><span class="st">w</span><span class="sc">\n</span><span class="st">o</span><span class="sc">\n</span><span class="st">r</span><span class="sc">\n</span><span class="st">l</span><span class="sc">\n</span><span class="st">d</span><span class="sc">\n</span><span class="st">!"</span>)<span class="op">;</span></span>
<span id="cb19-3"><a></a>    <span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<ul>
<li>Wait a minute!</li>
</ul>
</section>
<section id="were-doomed" class="slide level2">
<h2>We’re doomed</h2>
<ul>
<li>We didn’t save what was written to the previous lines.</li>
<li>Real ones know.</li>
</ul>

<img data-src="https://upload.wikimedia.org/wikipedia/en/1/16/BladeRunnerRoyBattySpeech.jpeg" class="r-stretch"></section>
<section id="unless" class="slide level2">
<h2>Unless?</h2>
<ul>
<li>No way can we <em>read</em> from the VGA text buffer right.</li>
<li>That would be… extraordinary.</li>
<li>You can do whatever you want, I just want to show you one possible design choice.
<ul>
<li>Mostly as a proof of concept.</li>
</ul></li>
</ul>
</section>
<section id="scroll" class="slide level2">
<h2>Scroll</h2>
<ul>
<li>I’ll add some <code>const</code>s and write a helper.</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/vga.rs</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb20" data-filename="src/vga.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb20-1"><a></a><span class="kw">const</span> ROWS<span class="op">:</span> <span class="dt">usize</span> <span class="op">=</span> <span class="dv">80</span><span class="op">;</span></span>
<span id="cb20-2"><a></a><span class="kw">const</span> COLS<span class="op">:</span> <span class="dt">usize</span> <span class="op">=</span> <span class="dv">25</span><span class="op">;</span></span>
<span id="cb20-3"><a></a><span class="kw">const</span> <span class="cn">MAX</span><span class="op">:</span> <span class="dt">usize</span> <span class="op">=</span> ROWS <span class="op">*</span> COLS<span class="op">;</span></span>
<span id="cb20-4"><a></a></span>
<span id="cb20-5"><a></a><span class="kw">fn</span> scroll() <span class="op">{</span></span>
<span id="cb20-6"><a></a>    </span>
<span id="cb20-7"><a></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="execution" class="slide level2">
<h2>Execution</h2>
<ul>
<li>Start at the first character that will remain visible.</li>
<li>Copy it to the earliest visible slot (start of buffer).</li>
<li>Iterate until the full buffer is moved.</li>
<li>We note this could be executed in a single <code>memmove</code>
<ul>
<li><a href="https://man7.org/linux/man-pages/man3/memmove.3.html">Read more</a></li>
</ul></li>
</ul>
</section>
<section id="my-code" class="slide level2">
<h2>My Code</h2>
<ul>
<li>Public just to test.</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/vga.rs</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb21" data-filename="src/vga.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb21-1"><a></a><span class="kw">pub</span> <span class="kw">fn</span> scroll() <span class="op">{</span></span>
<span id="cb21-2"><a></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="dv">80</span><span class="op">..</span><span class="cn">MAX</span> <span class="op">{</span></span>
<span id="cb21-3"><a></a>        <span class="kw">unsafe</span> <span class="op">{</span></span>
<span id="cb21-4"><a></a>            <span class="kw">let</span> src<span class="op">:</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">u8</span> <span class="op">=</span> ((MMIO <span class="kw">as</span> <span class="dt">usize</span>) <span class="op">+</span> (i <span class="op">*</span> <span class="dv">2</span>)) <span class="kw">as</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">u8</span><span class="op">;</span></span>
<span id="cb21-5"><a></a>            <span class="kw">let</span> dst<span class="op">:</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">u8</span> <span class="op">=</span> ((MMIO <span class="kw">as</span> <span class="dt">usize</span>) <span class="op">+</span> ((i <span class="op">-</span> <span class="dv">80</span>) <span class="op">*</span> <span class="dv">2</span>)) <span class="kw">as</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">u8</span><span class="op">;</span></span>
<span id="cb21-6"><a></a>            <span class="op">*</span>dst <span class="op">=</span> <span class="op">*</span>src<span class="op">;</span></span>
<span id="cb21-7"><a></a>        <span class="op">}</span></span>
<span id="cb21-8"><a></a>    <span class="op">}</span></span>
<span id="cb21-9"><a></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="my-test" class="slide level2">
<h2>My Test</h2>
<ul>
<li>I just sent line numbers then manually scrolled.</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/main.rs</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb22" data-filename="src/main.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb22-1"><a></a>    <span class="pp">vga::</span>str_to_vga(<span class="st">"0</span><span class="sc">\n</span><span class="st">1</span><span class="sc">\n</span><span class="st">2</span><span class="sc">\n</span><span class="st">3</span><span class="sc">\n</span><span class="st">4</span><span class="sc">\n</span><span class="st">5</span><span class="sc">\n</span><span class="st">6</span><span class="sc">\n</span><span class="st">7</span><span class="sc">\n</span><span class="st">8</span><span class="sc">\n</span><span class="st">9</span><span class="sc">\n</span><span class="st">A</span><span class="sc">\n</span><span class="st">B"</span>)<span class="op">;</span></span>
<span id="cb22-2"><a></a>    <span class="pp">vga::</span>scroll()<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="a-better-test" class="slide level2">
<h2>A better test</h2>
<ul>
<li>Here is a copy of the Project Gutenburg ebook of <em>Pride and Prejudice</em>.</li>
<li>It contains some quotes which might be a problem.</li>
<li><a href="https://raw.githubusercontent.com/cd-public/books/main/pg1342.txt">Link</a></li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb23"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb23-1"><a></a><span class="ex">https://raw.githubusercontent.com/cd-public/books/main/pg1342.txt</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="does-it-work" class="slide level2">
<h2>Does it work?</h2>
<ul>
<li>What do we have to do?</li>
</ul>
<details>
<ol type="1">
<li>Add <code>scroll</code> to <code>str_to_vga</code></li>
<li>Update <code>LATEST</code> in <code>scroll</code></li>
<li>Blank out the last line, I used space (<code>0x20</code> or <code>32</code>)</li>
<li>Make sure all color bytes are set.</li>
</ol>
</details>
</section>
<section id="why-do-we-blank-out" class="slide level2">
<h2>Why do we blank out?</h2>
<ul>
<li>Recall we are writing to MMIO.</li>
<li>As soon as we exceed the MMIO range, we can <em>make no claims</em> about what memory we are vviewing.</li>
<li>So if we copy in data past the buffer, we could get <em>anything</em>.</li>
<li>So if we don’t overwrite the buffer, we could get <em>anything</em>.</li>
</ul>
</section>
<section id="we-set-color-bytes" class="slide level2">
<h2>We set color bytes?</h2>
<ul>
<li>Like lines off the MMIO range, the color bytes have no known value.</li>
<li>So if we e.g.&nbsp;have a newline anywhere and end up not initially setting colors…</li>
<li>Then copy text up to that line…</li>
<li>We will be showing text in an <em>unset</em> color.
<ul>
<li>Just whatever bits happened to be there!</li>
</ul></li>
</ul>
</section>
<section id="this-is-unsafe" class="slide level2">
<h2>This is unsafe!</h2>
<ul>
<li>Astute learners will notice this is all very unsafe.</li>
</ul>
</section>
<section id="im-loopy" class="slide level2">
<h2>I’m loopy</h2>
<ul>
<li>I should not I do everything with <code>for</code> loops and “single-equals-assignment”
<ul>
<li>I mostly am teaching you <em>how to code</em></li>
<li>This is NOT teaching you <em>how to Rust</em> (or C)</li>
</ul></li>
<li>Who needs <code>memmove</code> (a C function) when we have the humble <code>for</code> loop.</li>
<li>Read more: <a href="https://doc.rust-lang.org/core/ptr/fn.copy.html">core::ptr::copy</a></li>
</ul>
</section>
<section id="caution" class="slide level2">
<h2>Caution!</h2>
<ul>
<li>I am building my crate without access to <code>memmove</code>.</li>
<li>You may need to go back and add some configuration.</li>
<li>This was covered in the “Kernel” lecture.
<ul>
<li><a href="./40_kernel.html#aside-notfutureproofing-1">Here</a></li>
</ul></li>
</ul>
</section>
<section id="my-solution" class="slide level2">
<h2>My solution</h2>
<details>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/vga.rs</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb24" data-filename="src/vga.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb24-1"><a></a><span class="kw">const</span> ROWS<span class="op">:</span> <span class="dt">usize</span> <span class="op">=</span> <span class="dv">80</span><span class="op">;</span></span>
<span id="cb24-2"><a></a><span class="kw">const</span> COLS<span class="op">:</span> <span class="dt">usize</span> <span class="op">=</span> <span class="dv">25</span><span class="op">;</span></span>
<span id="cb24-3"><a></a><span class="kw">const</span> <span class="cn">MAX</span><span class="op">:</span> <span class="dt">usize</span> <span class="op">=</span> ROWS <span class="op">*</span> COLS<span class="op">;</span></span>
<span id="cb24-4"><a></a></span>
<span id="cb24-5"><a></a><span class="kw">fn</span> scroll() <span class="op">{</span></span>
<span id="cb24-6"><a></a>    <span class="kw">unsafe</span> <span class="op">{</span></span>
<span id="cb24-7"><a></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="dv">80</span><span class="op">..</span><span class="cn">MAX</span> <span class="op">{</span></span>
<span id="cb24-8"><a></a>            <span class="kw">let</span> src<span class="op">:</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">u8</span> <span class="op">=</span> ((MMIO <span class="kw">as</span> <span class="dt">usize</span>) <span class="op">+</span> (i <span class="op">*</span> <span class="dv">2</span>)) <span class="kw">as</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">u8</span><span class="op">;</span></span>
<span id="cb24-9"><a></a>            <span class="kw">let</span> dst<span class="op">:</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">u8</span> <span class="op">=</span> ((MMIO <span class="kw">as</span> <span class="dt">usize</span>) <span class="op">+</span> ((i <span class="op">-</span> <span class="dv">80</span>) <span class="op">*</span> <span class="dv">2</span>)) <span class="kw">as</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">u8</span><span class="op">;</span></span>
<span id="cb24-10"><a></a>            <span class="op">*</span>dst <span class="op">=</span> <span class="op">*</span>src<span class="op">;</span></span>
<span id="cb24-11"><a></a>            <span class="op">*</span>((dst <span class="kw">as</span> <span class="dt">usize</span> <span class="op">+</span> <span class="dv">1</span>) <span class="kw">as</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">u8</span>) <span class="op">=</span> COLOR<span class="op">;</span></span>
<span id="cb24-12"><a></a>        <span class="op">}</span></span>
<span id="cb24-13"><a></a>        <span class="cf">for</span> i <span class="kw">in</span> (<span class="cn">MAX</span><span class="op">-</span><span class="dv">80</span>)<span class="op">..</span><span class="cn">MAX</span> <span class="op">{</span></span>
<span id="cb24-14"><a></a>            <span class="kw">let</span> dst<span class="op">:</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">u8</span> <span class="op">=</span> ((MMIO <span class="kw">as</span> <span class="dt">usize</span>) <span class="op">+</span> ((i) <span class="op">*</span> <span class="dv">2</span>)) <span class="kw">as</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">u8</span><span class="op">;</span></span>
<span id="cb24-15"><a></a>            <span class="op">*</span>dst <span class="op">=</span> <span class="dv">32</span><span class="op">;</span></span>
<span id="cb24-16"><a></a>            <span class="op">*</span>((dst <span class="kw">as</span> <span class="dt">usize</span> <span class="op">+</span> <span class="dv">1</span>) <span class="kw">as</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">u8</span>) <span class="op">=</span> COLOR<span class="op">;</span></span>
<span id="cb24-17"><a></a>        <span class="op">}</span></span>
<span id="cb24-18"><a></a>        LATEST <span class="op">=</span> LATEST <span class="op">-</span> <span class="dv">80</span><span class="op">;</span></span>
<span id="cb24-19"><a></a>    <span class="op">}</span></span>
<span id="cb24-20"><a></a><span class="op">}</span></span>
<span id="cb24-21"><a></a></span>
<span id="cb24-22"><a></a><span class="kw">pub</span> <span class="kw">fn</span> str_to_vga(s<span class="op">:</span> <span class="op">&amp;</span><span class="dt">str</span>) <span class="op">{</span></span>
<span id="cb24-23"><a></a>    <span class="kw">let</span> v <span class="op">=</span> s<span class="op">.</span>as_bytes()<span class="op">;</span></span>
<span id="cb24-24"><a></a>    <span class="kw">unsafe</span> <span class="op">{</span></span>
<span id="cb24-25"><a></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="dv">0</span><span class="op">..</span>v<span class="op">.</span>len() <span class="op">{</span></span>
<span id="cb24-26"><a></a>            <span class="cf">if</span> LATEST <span class="op">&gt;</span> <span class="cn">MAX</span> <span class="op">{</span></span>
<span id="cb24-27"><a></a>                scroll()<span class="op">;</span></span>
<span id="cb24-28"><a></a>            <span class="op">}</span></span>
<span id="cb24-29"><a></a>            <span class="cf">match</span> v[i] <span class="op">{</span></span>
<span id="cb24-30"><a></a>                <span class="dv">10</span> <span class="op">=&gt;</span> LATEST <span class="op">=</span> ((LATEST <span class="op">/</span> <span class="dv">80</span>) <span class="op">+</span> <span class="dv">1</span>) <span class="op">*</span> <span class="dv">80</span><span class="op">,</span></span>
<span id="cb24-31"><a></a>                _ <span class="op">=&gt;</span> char_to_vga(v[i])<span class="op">,</span></span>
<span id="cb24-32"><a></a>            <span class="op">}</span></span>
<span id="cb24-33"><a></a>        <span class="op">}</span></span>
<span id="cb24-34"><a></a>    <span class="op">}</span></span>
<span id="cb24-35"><a></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</details>
</section></section>
<section>
<section id="volatile" class="title-slide slide level1 center">
<h1>Volatile</h1>

</section>
<section id="best-practice" class="slide level2">
<h2>Best Practice</h2>
<ul>
<li>This works on my machine.</li>
<li>It may not always work.</li>
<li>Why? <code>rustc</code> is a bit too smart.
<ul>
<li>There is no obvious externally observable reason to write to fixed memory location.</li>
<li>The compiler may optimize out such writes.</li>
<li>I say “sure it will.”</li>
</ul></li>
</ul>
</section>
<section id="quote-blog" class="slide level2">
<h2>Quote Blog</h2>
<blockquote>
<p>The problem is that we only write to the buffer and never read from it again.</p>
</blockquote>
<ul>
<li>Okay so but here me out.</li>
<li>Our implementation does read from the buffer again.
<ul>
<li>Sometimes the best way to do things is also the simplest.</li>
<li>For some reason blog kept a local copy and only used that?</li>
</ul></li>
</ul>
</section>
<section id="volatile-1" class="slide level2">
<h2>Volatile</h2>
<ul>
<li>If we lacked the skill and bravery of the instructor of this course, we may have a problem.</li>
<li>To avoid an erroneous optimization omitting all writes, we need to specify writes as <em><a href="#/volatile">volatile</a></em>.</li>
<li>This tells the compiler that the write has side effects and should not be optimized away.</li>
<li><a href="https://en.wikipedia.org/wiki/Volatile_(computer_programming)">Read more</a></li>
</ul>
</section>
<section id="interested-students" class="slide level2">
<h2>Interested Students</h2>
<ul>
<li>There’s a <code>read_volatile</code> and <code>write_volatile</code> in <code>std::ptr</code> and another in <code>core::ptr</code>, we might be able to use those.</li>
</ul>
</section></section>
<section>
<section id="fin" class="title-slide slide level1 center">
<h1>Fin</h1>

</section>
<section id="timeout" class="slide level2">
<h2>Timeout</h2>
<ul>
<li>This is 700 lines of markdown source which usually is enough.</li>
<li>Otherwise we proceed to “Format”.</li>
</ul>
</section></section>
<section>
<section id="format-1" class="title-slide slide level1 center">
<h1>Format</h1>

</section>
<section id="formatting-macros" class="slide level2">
<h2>Formatting Macros</h2>
<ul>
<li>It would be nice to support Rust’s formatting macros, too.</li>
<li>We will also discover that Rust is, in point of fact, an object-oriented language.
<ul>
<li>Read: bad.</li>
</ul></li>
<li>I was extremely annoyed by how to get this working, but I did it.</li>
</ul>
</section>
<section id="functionality" class="slide level2">
<h2>Functionality</h2>
<ul>
<li>We need to implement the [<code>core::fmt::Write</code>] trait.
<ul>
<li>I had foolishly assumed we could just use <code>format!</code></li>
<li>That would tragically be too reasonable.</li>
<li>(It also would raise some unanswered questions about memory but whatever).</li>
</ul></li>
<li>The only required method of this trait is <code>write_str</code>:
<ul>
<li><a href="https://doc.rust-lang.org/nightly/core/fmt/trait.Write.html"><code>core::fmt::Write</code></a></li>
</ul></li>
</ul>
</section>
<section id="sketch" class="slide level2">
<h2>Sketch</h2>
<ul>
<li>Basically we need to write this:</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/vga.rs</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb25" data-filename="src/vga.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb25-1"><a></a><span class="kw">impl</span> <span class="pp">core::fmt::</span><span class="bu">Write</span> <span class="cf">for</span> <span class="op">???</span> <span class="op">{</span></span>
<span id="cb25-2"><a></a>    <span class="kw">fn</span> write_str(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> s<span class="op">:</span> <span class="op">&amp;</span><span class="dt">str</span>) <span class="op">-&gt;</span> <span class="pp">fmt::</span><span class="dt">Result</span> <span class="op">{</span></span>
<span id="cb25-3"><a></a>        <span class="co">// Do the thing. </span></span>
<span id="cb25-4"><a></a>        <span class="cf">return</span> <span class="cn">Ok</span>(())<span class="op">;</span></span>
<span id="cb25-5"><a></a>    <span class="op">}</span></span>
<span id="cb25-6"><a></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<ul>
<li>The <code>Ok(())</code> is just a <code>Ok</code> Result containing the <code>()</code> “unit type”.</li>
</ul>
</section>
<section id="workaround" class="slide level2">
<h2>Workaround</h2>
<ul>
<li>I already can write text!</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/vga.rs</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb26" data-filename="src/vga.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb26-1"><a></a><span class="kw">impl</span> <span class="pp">core::fmt::</span><span class="bu">Write</span> <span class="cf">for</span> <span class="op">???</span> <span class="op">{</span></span>
<span id="cb26-2"><a></a>    <span class="kw">fn</span> write_str(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> s<span class="op">:</span> <span class="op">&amp;</span><span class="dt">str</span>) <span class="op">-&gt;</span> <span class="pp">fmt::</span><span class="dt">Result</span> <span class="op">{</span></span>
<span id="cb26-3"><a></a>        str_to_vga(s)<span class="op">;</span> </span>
<span id="cb26-4"><a></a>        <span class="cf">return</span> <span class="cn">Ok</span>(())<span class="op">;</span></span>
<span id="cb26-5"><a></a>    <span class="op">}</span></span>
<span id="cb26-6"><a></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="dummy-struct" class="slide level2">
<h2>Dummy struct</h2>
<ul>
<li>I just make an arbitrary structure.</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/vga.rs</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb27" data-filename="src/vga.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb27-1"><a></a><span class="kw">struct</span> Dummy <span class="op">{</span> <span class="op">}</span> </span>
<span id="cb27-2"><a></a></span>
<span id="cb27-3"><a></a><span class="kw">impl</span> <span class="pp">core::fmt::</span><span class="bu">Write</span> <span class="cf">for</span> Dummy <span class="op">{</span></span>
<span id="cb27-4"><a></a>    <span class="kw">fn</span> write_str(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> s<span class="op">:</span> <span class="op">&amp;</span><span class="dt">str</span>) <span class="op">-&gt;</span> <span class="pp">fmt::</span><span class="dt">Result</span> <span class="op">{</span></span>
<span id="cb27-5"><a></a>        str_to_vga(s)<span class="op">;</span> </span>
<span id="cb27-6"><a></a>        <span class="cf">return</span> <span class="cn">Ok</span>(())<span class="op">;</span></span>
<span id="cb27-7"><a></a>    <span class="op">}</span></span>
<span id="cb27-8"><a></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<ul>
<li>Presumably it is clear why someone would find this an annoying way to do things.</li>
</ul>
</section>
<section id="this-works" class="slide level2">
<h2>This works</h2>
<ul>
<li>I’m not kidding it actually does.</li>
<li>I was surprised too.
<ul>
<li>I did forget to capitalized the W in write but…</li>
</ul></li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/main.rs</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb28" data-filename="src/main.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb28-1"><a></a><span class="at">#[</span><span class="kw">unsafe</span><span class="at">(</span>no_mangle<span class="at">)]</span></span>
<span id="cb28-2"><a></a><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">"C"</span> <span class="kw">fn</span> _start() <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb28-3"><a></a>    <span class="kw">use</span> <span class="pp">core::fmt::</span><span class="bu">Write</span><span class="op">;</span></span>
<span id="cb28-4"><a></a>    <span class="kw">let</span> <span class="kw">mut</span> d <span class="op">=</span> <span class="pp">vga::</span>Dummy <span class="op">{</span> <span class="op">};</span></span>
<span id="cb28-5"><a></a>    <span class="pp">write!</span>(d<span class="op">,</span> <span class="st">"Hello {}!"</span><span class="op">,</span> <span class="st">"world"</span>)<span class="op">;</span></span>
<span id="cb28-6"><a></a>    <span class="cf">loop</span> <span class="op">{}</span></span>
<span id="cb28-7"><a></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<ul>
<li>It throws an uninteresting warning.</li>
</ul>
<h3 id="a-println-macro">A println Macro</h3>
<p>Now that we have a global writer, we can add a <code>println</code> macro that can be used from anywhere in the codebase. Rust’s <a href="https://doc.rust-lang.org/nightly/book/ch20-05-macros.html#declarative-macros-for-general-metaprogramming">macro syntax</a> is a bit strange, so we won’t try to write a macro from scratch. Instead, we look at the source of the <a href="https://doc.rust-lang.org/nightly/std/macro.println!.html"><code>println!</code> macro</a> in the standard library:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb29"><pre class="sourceCode numberSource rust number-lines code-with-copy"><code class="sourceCode rust"><span id="cb29-1"><a></a><span class="at">#[</span>macro_export<span class="at">]</span></span>
<span id="cb29-2"><a></a><span class="pp">macro_rules!</span> println <span class="op">{</span></span>
<span id="cb29-3"><a></a>    () <span class="op">=&gt;</span> (<span class="pp">print!</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>))<span class="op">;</span></span>
<span id="cb29-4"><a></a>    (<span class="op">$</span>(<span class="op">$</span>arg<span class="op">:</span>tt)<span class="op">*</span>) <span class="op">=&gt;</span> (<span class="pp">print!</span>(<span class="st">"{}</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> <span class="pp">format_args!</span>(<span class="op">$</span>(<span class="op">$</span>arg)<span class="op">*</span>)))<span class="op">;</span></span>
<span id="cb29-5"><a></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Macros are defined through one or more rules, similar to <code>match</code> arms. The <code>println</code> macro has two rules: The first rule is for invocations without arguments, e.g., <code>println!()</code>, which is expanded to <code>print!("\n")</code> and thus just prints a newline. The second rule is for invocations with parameters such as <code>println!("Hello")</code> or <code>println!("Number: {}", 4)</code>. It is also expanded to an invocation of the <code>print!</code> macro, passing all arguments and an additional newline <code>\n</code> at the end.</p>
<p>The <code>#[macro_export]</code> attribute makes the macro available to the whole crate (not just the module it is defined in) and external crates. It also places the macro at the crate root, which means we have to import the macro through <code>use std::println</code> instead of <code>std::macros::println</code>.</p>
<p>The <a href="https://doc.rust-lang.org/nightly/std/macro.print!.html"><code>print!</code> macro</a> is defined as:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb30"><pre class="sourceCode numberSource rust number-lines code-with-copy"><code class="sourceCode rust"><span id="cb30-1"><a></a><span class="at">#[</span>macro_export<span class="at">]</span></span>
<span id="cb30-2"><a></a><span class="pp">macro_rules!</span> print <span class="op">{</span></span>
<span id="cb30-3"><a></a>    (<span class="op">$</span>(<span class="op">$</span>arg<span class="op">:</span>tt)<span class="op">*</span>) <span class="op">=&gt;</span> (<span class="op">$</span><span class="pp">crate::io::</span>_print(<span class="pp">format_args!</span>(<span class="op">$</span>(<span class="op">$</span>arg)<span class="op">*</span>)))<span class="op">;</span></span>
<span id="cb30-4"><a></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>The macro expands to a call of the <a href="https://github.com/rust-lang/rust/blob/29f5c699b11a6a148f097f82eaa05202f8799bbc/src/libstd/io/stdio.rs#L698"><code>_print</code> function</a> in the <code>io</code> module. The <a href="https://doc.rust-lang.org/1.30.0/book/first-edition/macros.html#the-variable-crate"><code>$crate</code> variable</a> ensures that the macro also works from outside the <code>std</code> crate by expanding to <code>std</code> when it’s used in other crates.</p>
<p>The <a href="https://doc.rust-lang.org/nightly/std/macro.format_args.html"><code>format_args</code> macro</a> builds a <a href="https://doc.rust-lang.org/nightly/core/fmt/struct.Arguments.html">fmt::Arguments</a> type from the passed arguments, which is passed to <code>_print</code>. The <a href="https://github.com/rust-lang/rust/blob/29f5c699b11a6a148f097f82eaa05202f8799bbc/src/libstd/io/stdio.rs#L698"><code>_print</code> function</a> of libstd calls <code>print_to</code>, which is rather complicated because it supports different <code>Stdout</code> devices. We don’t need that complexity since we just want to print to the VGA buffer.</p>
<p>To print to the VGA buffer, we just copy the <code>println!</code> and <code>print!</code> macros, but modify them to use our own <code>_print</code> function:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb31"><pre class="sourceCode numberSource rust number-lines code-with-copy"><code class="sourceCode rust"><span id="cb31-1"><a></a><span class="co">// in src/vga.rs</span></span>
<span id="cb31-2"><a></a></span>
<span id="cb31-3"><a></a><span class="at">#[</span>macro_export<span class="at">]</span></span>
<span id="cb31-4"><a></a><span class="pp">macro_rules!</span> print <span class="op">{</span></span>
<span id="cb31-5"><a></a>    (<span class="op">$</span>(<span class="op">$</span>arg<span class="op">:</span>tt)<span class="op">*</span>) <span class="op">=&gt;</span> (<span class="op">$</span><span class="pp">crate::vga::</span>_print(<span class="pp">format_args!</span>(<span class="op">$</span>(<span class="op">$</span>arg)<span class="op">*</span>)))<span class="op">;</span></span>
<span id="cb31-6"><a></a><span class="op">}</span></span>
<span id="cb31-7"><a></a></span>
<span id="cb31-8"><a></a><span class="at">#[</span>macro_export<span class="at">]</span></span>
<span id="cb31-9"><a></a><span class="pp">macro_rules!</span> println <span class="op">{</span></span>
<span id="cb31-10"><a></a>    () <span class="op">=&gt;</span> (<span class="op">$</span><span class="pp">crate::print!</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>))<span class="op">;</span></span>
<span id="cb31-11"><a></a>    (<span class="op">$</span>(<span class="op">$</span>arg<span class="op">:</span>tt)<span class="op">*</span>) <span class="op">=&gt;</span> (<span class="op">$</span><span class="pp">crate::print!</span>(<span class="st">"{}</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> <span class="pp">format_args!</span>(<span class="op">$</span>(<span class="op">$</span>arg)<span class="op">*</span>)))<span class="op">;</span></span>
<span id="cb31-12"><a></a><span class="op">}</span></span>
<span id="cb31-13"><a></a></span>
<span id="cb31-14"><a></a><span class="at">#[</span>doc<span class="at">(</span>hidden<span class="at">)]</span></span>
<span id="cb31-15"><a></a><span class="kw">pub</span> <span class="kw">fn</span> _print(args<span class="op">:</span> <span class="pp">fmt::</span>Arguments) <span class="op">{</span></span>
<span id="cb31-16"><a></a>    <span class="kw">use</span> <span class="pp">core::fmt::</span><span class="bu">Write</span><span class="op">;</span></span>
<span id="cb31-17"><a></a>    WRITER<span class="op">.</span>lock()<span class="op">.</span>write_fmt(args)<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb31-18"><a></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>One thing that we changed from the original <code>println</code> definition is that we prefixed the invocations of the <code>print!</code> macro with <code>$crate</code> too. This ensures that we don’t need to import the <code>print!</code> macro too if we only want to use <code>println</code>.</p>
<p>Like in the standard library, we add the <code>#[macro_export]</code> attribute to both macros to make them available everywhere in our crate. Note that this places the macros in the root namespace of the crate, so importing them via <code>use crate::vga::println</code> does not work. Instead, we have to do <code>use crate::println</code>.</p>
<p>The <code>_print</code> function locks our static <code>WRITER</code> and calls the <code>write_fmt</code> method on it. This method is from the <code>Write</code> trait, which we need to import. The additional <code>unwrap()</code> at the end panics if printing isn’t successful. But since we always return <code>Ok</code> in <code>write_str</code>, that should not happen.</p>
<p>Since the macros need to be able to call <code>_print</code> from outside of the module, the function needs to be public. However, since we consider this a private implementation detail, we add the <a href="https://doc.rust-lang.org/nightly/rustdoc/write-documentation/the-doc-attribute.html#hidden"><code>doc(hidden)</code> attribute</a> to hide it from the generated documentation.</p>
<h3 id="hello-world-using-println">Hello World using <code>println</code></h3>
<p>Now we can use <code>println</code> in our <code>_start</code> function:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb32"><pre class="sourceCode numberSource rust number-lines code-with-copy"><code class="sourceCode rust"><span id="cb32-1"><a></a><span class="co">// in src/main.rs</span></span>
<span id="cb32-2"><a></a></span>
<span id="cb32-3"><a></a><span class="at">#[</span><span class="kw">unsafe</span><span class="at">(</span>no_mangle<span class="at">)]</span></span>
<span id="cb32-4"><a></a><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">"C"</span> <span class="kw">fn</span> _start() <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb32-5"><a></a>    <span class="pp">println!</span>(<span class="st">"Hello World{}"</span><span class="op">,</span> <span class="st">"!"</span>)<span class="op">;</span></span>
<span id="cb32-6"><a></a></span>
<span id="cb32-7"><a></a>    <span class="cf">loop</span> <span class="op">{}</span></span>
<span id="cb32-8"><a></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Note that we don’t have to import the macro in the main function, because it already lives in the root namespace.</p>
<p>As expected, we now see a <em>“Hello World!”</em> on the screen:</p>
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="vga-hello-world.png"></p>
<figcaption>QEMU printing “Hello World!”</figcaption>
</figure>
</div>
<h3 id="printing-panic-messages">Printing Panic Messages</h3>
<p>Now that we have a <code>println</code> macro, we can use it in our panic function to print the panic message and the location of the panic:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb33"><pre class="sourceCode numberSource rust number-lines code-with-copy"><code class="sourceCode rust"><span id="cb33-1"><a></a><span class="co">// in main.rs</span></span>
<span id="cb33-2"><a></a></span>
<span id="cb33-3"><a></a><span class="co">/// This function is called on panic.</span></span>
<span id="cb33-4"><a></a><span class="at">#[</span>panic_handler<span class="at">]</span></span>
<span id="cb33-5"><a></a><span class="kw">fn</span> panic(info<span class="op">:</span> <span class="op">&amp;</span>PanicInfo) <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb33-6"><a></a>    <span class="pp">println!</span>(<span class="st">"{}"</span><span class="op">,</span> info)<span class="op">;</span></span>
<span id="cb33-7"><a></a>    <span class="cf">loop</span> <span class="op">{}</span></span>
<span id="cb33-8"><a></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>When we now insert <code>panic!("Some panic message");</code> in our <code>_start</code> function, we get the following output:</p>
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="vga-panic.png"></p>
<figcaption>QEMU printing “panicked at ‘Some panic message’, src/main.rs:28:5</figcaption>
</figure>
</div>
<p>So we know not only that a panic has occurred, but also the panic message and where in the code it happened.</p>
</section>
<section id="summary" class="slide level2">
<h2>Summary</h2>
<p>In this post, we learned about the structure of the VGA text buffer and how it can be written through the memory mapping at address <code>0xb8000</code>. We created a Rust module that encapsulates the unsafety of writing to this memory-mapped buffer and presents a safe and convenient interface to the outside.</p>
<p>Thanks to cargo, we also saw how easy it is to add dependencies on third-party libraries. The two dependencies that we added, <code>lazy_static</code> and <code>spin</code>, are very useful in OS development and we will use them in more places in future posts.</p>
</section>
<section id="whats-next" class="slide level2">
<h2>What’s next?</h2>
<p>The next post explains how to set up Rust’s built-in unit test framework. We will then create some basic unit tests for the VGA buffer module from this post.</p>


</section></section>
    </div>
  <div class="quarto-auto-generated-content" style="display: none;">
<div class="footer footer-default">
<p><a href="index.html">Home</a></p>
</div>
</div></div>

  <script>window.backupDefine = window.define; window.define = undefined;</script>
  <script src="site_libs/revealjs/dist/reveal.js"></script>
  <!-- reveal.js plugins -->
  <script src="site_libs/revealjs/plugin/quarto-line-highlight/line-highlight.js"></script>
  <script src="site_libs/revealjs/plugin/pdf-export/pdfexport.js"></script>
  <script src="site_libs/revealjs/plugin/reveal-menu/menu.js"></script>
  <script src="site_libs/revealjs/plugin/reveal-menu/quarto-menu.js"></script>
  <script src="site_libs/revealjs/plugin/quarto-support/support.js"></script>
  

  <script src="site_libs/revealjs/plugin/notes/notes.js"></script>
  <script src="site_libs/revealjs/plugin/search/search.js"></script>
  <script src="site_libs/revealjs/plugin/zoom/zoom.js"></script>
  <script src="site_libs/revealjs/plugin/math/math.js"></script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script>

  <script>

      // Full list of configuration options available at:
      // https://revealjs.com/config/
      Reveal.initialize({
'controlsAuto': true,
'previewLinksAuto': false,
'pdfSeparateFragments': false,
'autoAnimateEasing': "ease",
'autoAnimateDuration': 1,
'autoAnimateUnmatched': true,
'jumpToSlide': true,
'menu': {"side":"left","useTextContentForMissingTitles":true,"markers":false,"loadIcons":false,"custom":[{"title":"Tools","icon":"<i class=\"fas fa-gear\"></i>","content":"<ul class=\"slide-menu-items\">\n<li class=\"slide-tool-item active\" data-item=\"0\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.fullscreen(event)\"><kbd>f</kbd> Fullscreen</a></li>\n<li class=\"slide-tool-item\" data-item=\"1\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.speakerMode(event)\"><kbd>s</kbd> Speaker View</a></li>\n<li class=\"slide-tool-item\" data-item=\"2\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.overview(event)\"><kbd>o</kbd> Slide Overview</a></li>\n<li class=\"slide-tool-item\" data-item=\"3\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.togglePdfExport(event)\"><kbd>e</kbd> PDF Export Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"4\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleScrollView(event)\"><kbd>r</kbd> Scroll View Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"5\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.keyboardHelp(event)\"><kbd>?</kbd> Keyboard Help</a></li>\n</ul>"}],"openButton":true},
'smaller': false,
 
        // Display controls in the bottom right corner
        controls: false,

        // Help the user learn the controls by providing hints, for example by
        // bouncing the down arrow when they first encounter a vertical slide
        controlsTutorial: false,

        // Determines where controls appear, "edges" or "bottom-right"
        controlsLayout: 'edges',

        // Visibility rule for backwards navigation arrows; "faded", "hidden"
        // or "visible"
        controlsBackArrows: 'faded',

        // Display a presentation progress bar
        progress: true,

        // Display the page number of the current slide
        slideNumber: 'c/t',

        // 'all', 'print', or 'speaker'
        showSlideNumber: 'all',

        // Add the current slide number to the URL hash so that reloading the
        // page/copying the URL will return you to the same slide
        hash: true,

        // Start with 1 for the hash rather than 0
        hashOneBasedIndex: false,

        // Flags if we should monitor the hash and change slides accordingly
        respondToHashChanges: true,

        // Push each slide change to the browser history
        history: true,

        // Enable keyboard shortcuts for navigation
        keyboard: true,

        // Enable the slide overview mode
        overview: true,

        // Disables the default reveal.js slide layout (scaling and centering)
        // so that you can use custom CSS layout
        disableLayout: false,

        // Vertical centering of slides
        center: false,

        // Enables touch navigation on devices with touch input
        touch: true,

        // Loop the presentation
        loop: false,

        // Change the presentation direction to be RTL
        rtl: false,

        // see https://revealjs.com/vertical-slides/#navigation-mode
        navigationMode: 'linear',

        // Randomizes the order of slides each time the presentation loads
        shuffle: false,

        // Turns fragments on and off globally
        fragments: true,

        // Flags whether to include the current fragment in the URL,
        // so that reloading brings you to the same fragment position
        fragmentInURL: false,

        // Flags if the presentation is running in an embedded mode,
        // i.e. contained within a limited portion of the screen
        embedded: false,

        // Flags if we should show a help overlay when the questionmark
        // key is pressed
        help: true,

        // Flags if it should be possible to pause the presentation (blackout)
        pause: true,

        // Flags if speaker notes should be visible to all viewers
        showNotes: false,

        // Global override for autoplaying embedded media (null/true/false)
        autoPlayMedia: null,

        // Global override for preloading lazy-loaded iframes (null/true/false)
        preloadIframes: null,

        // Number of milliseconds between automatically proceeding to the
        // next slide, disabled when set to 0, this value can be overwritten
        // by using a data-autoslide attribute on your slides
        autoSlide: 0,

        // Stop auto-sliding after user input
        autoSlideStoppable: true,

        // Use this method for navigation when auto-sliding
        autoSlideMethod: null,

        // Specify the average time in seconds that you think you will spend
        // presenting each slide. This is used to show a pacing timer in the
        // speaker view
        defaultTiming: null,

        // Enable slide navigation via mouse wheel
        mouseWheel: false,

        // The display mode that will be used to show slides
        display: 'block',

        // Hide cursor if inactive
        hideInactiveCursor: true,

        // Time before the cursor is hidden (in ms)
        hideCursorTime: 5000,

        // Opens links in an iframe preview overlay
        previewLinks: false,

        // Transition style (none/fade/slide/convex/concave/zoom)
        transition: 'none',

        // Transition speed (default/fast/slow)
        transitionSpeed: 'default',

        // Transition style for full page slide backgrounds
        // (none/fade/slide/convex/concave/zoom)
        backgroundTransition: 'none',

        // Number of slides away from the current that are visible
        viewDistance: 3,

        // Number of slides away from the current that are visible on mobile
        // devices. It is advisable to set this to a lower number than
        // viewDistance in order to save resources.
        mobileViewDistance: 2,

        // The "normal" size of the presentation, aspect ratio will be preserved
        // when the presentation is scaled to fit different resolutions. Can be
        // specified using percentage units.
        width: 1050,

        height: 700,

        // Factor of the display size that should remain empty around the content
        margin: 0.1,

        math: {
          mathjax: 'https://cdn.jsdelivr.net/npm/mathjax@2.7.9/MathJax.js',
          config: 'TeX-AMS_HTML-full',
          tex2jax: {
            inlineMath: [['\\(','\\)']],
            displayMath: [['\\[','\\]']],
            balanceBraces: true,
            processEscapes: false,
            processRefs: true,
            processEnvironments: true,
            preview: 'TeX',
            skipTags: ['script','noscript','style','textarea','pre','code'],
            ignoreClass: 'tex2jax_ignore',
            processClass: 'tex2jax_process'
          },
        },

        // reveal.js plugins
        plugins: [QuartoLineHighlight, PdfExport, RevealMenu, QuartoSupport,

          RevealMath,
          RevealNotes,
          RevealSearch,
          RevealZoom
        ]
      });
    </script>
    <script id="quarto-html-after-body" type="application/javascript">
      window.document.addEventListener("DOMContentLoaded", function (event) {
        const tabsets =  window.document.querySelectorAll(".panel-tabset-tabby")
        tabsets.forEach(function(tabset) {
          const tabby = new Tabby('#' + tabset.id);
        });
        const isCodeAnnotation = (el) => {
          for (const clz of el.classList) {
            if (clz.startsWith('code-annotation-')) {                     
              return true;
            }
          }
          return false;
        }
        const onCopySuccess = function(e) {
          // button target
          const button = e.trigger;
          // don't keep focus
          button.blur();
          // flash "checked"
          button.classList.add('code-copy-button-checked');
          var currentTitle = button.getAttribute("title");
          button.setAttribute("title", "Copied!");
          let tooltip;
          if (window.bootstrap) {
            button.setAttribute("data-bs-toggle", "tooltip");
            button.setAttribute("data-bs-placement", "left");
            button.setAttribute("data-bs-title", "Copied!");
            tooltip = new bootstrap.Tooltip(button, 
              { trigger: "manual", 
                customClass: "code-copy-button-tooltip",
                offset: [0, -8]});
            tooltip.show();    
          }
          setTimeout(function() {
            if (tooltip) {
              tooltip.hide();
              button.removeAttribute("data-bs-title");
              button.removeAttribute("data-bs-toggle");
              button.removeAttribute("data-bs-placement");
            }
            button.setAttribute("title", currentTitle);
            button.classList.remove('code-copy-button-checked');
          }, 1000);
          // clear code selection
          e.clearSelection();
        }
        const getTextToCopy = function(trigger) {
          const outerScaffold = trigger.parentElement.cloneNode(true);
          const codeEl = outerScaffold.querySelector('code');
          for (const childEl of codeEl.children) {
            if (isCodeAnnotation(childEl)) {
              childEl.remove();
            }
          }
          return codeEl.innerText;
        }
        const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
          text: getTextToCopy
        });
        clipboard.on('success', onCopySuccess);
        if (window.document.getElementById('quarto-embedded-source-code-modal')) {
          const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
            text: getTextToCopy,
            container: window.document.getElementById('quarto-embedded-source-code-modal')
          });
          clipboardModal.on('success', onCopySuccess);
        }
          var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
          var mailtoRegex = new RegExp(/^mailto:/);
            var filterRegex = new RegExp('/' + window.location.host + '/');
          var isInternal = (href) => {
              return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
          }
          // Inspect non-navigation links and adorn them if external
         var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
          for (var i=0; i<links.length; i++) {
            const link = links[i];
            if (!isInternal(link.href)) {
              // undo the damage that might have been done by quarto-nav.js in the case of
              // links that we want to consider external
              if (link.dataset.originalHref !== undefined) {
                link.href = link.dataset.originalHref;
              }
            }
          }
        function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
          const config = {
            allowHTML: true,
            maxWidth: 500,
            delay: 100,
            arrow: false,
            appendTo: function(el) {
                return el.closest('section.slide') || el.parentElement;
            },
            interactive: true,
            interactiveBorder: 10,
            theme: 'light-border',
            placement: 'bottom-start',
          };
          if (contentFn) {
            config.content = contentFn;
          }
          if (onTriggerFn) {
            config.onTrigger = onTriggerFn;
          }
          if (onUntriggerFn) {
            config.onUntrigger = onUntriggerFn;
          }
            config['offset'] = [0,0];
            config['maxWidth'] = 700;
          window.tippy(el, config); 
        }
        const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
        for (var i=0; i<noterefs.length; i++) {
          const ref = noterefs[i];
          tippyHover(ref, function() {
            // use id or data attribute instead here
            let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
            try { href = new URL(href).hash; } catch {}
            const id = href.replace(/^#\/?/, "");
            const note = window.document.getElementById(id);
            if (note) {
              return note.innerHTML;
            } else {
              return "";
            }
          });
        }
        const findCites = (el) => {
          const parentEl = el.parentElement;
          if (parentEl) {
            const cites = parentEl.dataset.cites;
            if (cites) {
              return {
                el,
                cites: cites.split(' ')
              };
            } else {
              return findCites(el.parentElement)
            }
          } else {
            return undefined;
          }
        };
        var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
        for (var i=0; i<bibliorefs.length; i++) {
          const ref = bibliorefs[i];
          const citeInfo = findCites(ref);
          if (citeInfo) {
            tippyHover(citeInfo.el, function() {
              var popup = window.document.createElement('div');
              citeInfo.cites.forEach(function(cite) {
                var citeDiv = window.document.createElement('div');
                citeDiv.classList.add('hanging-indent');
                citeDiv.classList.add('csl-entry');
                var biblioDiv = window.document.getElementById('ref-' + cite);
                if (biblioDiv) {
                  citeDiv.innerHTML = biblioDiv.innerHTML;
                }
                popup.appendChild(citeDiv);
              });
              return popup.innerHTML;
            });
          }
        }
      });
      </script>
    

</body></html>