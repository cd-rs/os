<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.30">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>RISC-V – OS in Rust</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./31_linker.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-a4a11d514c7d463668e07712114998e6.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-fc9c1a4fc1048689359919db0170c3de.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./32_r5.html">RISC-V</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">OS in Rust</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./00_derust.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Derust</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_wc.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">wc</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_cli.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">CLI</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11_unsafe.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Unsafe</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12_split_at.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Splits</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./20_os.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">OS</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./21_xmute.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Transmute</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./22_malloc.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">malloc</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./30_metal.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bare Metal</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./31_linker.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Linker</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./32_r5.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">RISC-V</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#homework" id="toc-homework" class="nav-link active" data-scroll-target="#homework">Homework</a></li>
  <li><a href="#requirements" id="toc-requirements" class="nav-link" data-scroll-target="#requirements">Requirements</a></li>
  <li><a href="#main" id="toc-main" class="nav-link" data-scroll-target="#main">main</a>
  <ul class="collapse">
  <li><a href="#code" id="toc-code" class="nav-link" data-scroll-target="#code">Code</a></li>
  <li><a href="#other-stuff" id="toc-other-stuff" class="nav-link" data-scroll-target="#other-stuff">Other stuff</a></li>
  <li><a href="#the-working-parts" id="toc-the-working-parts" class="nav-link" data-scroll-target="#the-working-parts">The working parts</a></li>
  <li><a href="#the-internals" id="toc-the-internals" class="nav-link" data-scroll-target="#the-internals">The internals</a></li>
  <li><a href="#starting-point" id="toc-starting-point" class="nav-link" data-scroll-target="#starting-point">Starting Point</a></li>
  <li><a href="#rustc" id="toc-rustc" class="nav-link" data-scroll-target="#rustc"><code>rustc</code></a></li>
  <li><a href="#naively" id="toc-naively" class="nav-link" data-scroll-target="#naively">Naively</a></li>
  <li><a href="#t" id="toc-t" class="nav-link" data-scroll-target="#t"><code>-T</code></a></li>
  <li><a href="#risc-v" id="toc-risc-v" class="nav-link" data-scroll-target="#risc-v">RISC-V</a></li>
  <li><a href="#target" id="toc-target" class="nav-link" data-scroll-target="#target">Target</a></li>
  <li><a href="#main-1" id="toc-main-1" class="nav-link" data-scroll-target="#main-1">Main</a></li>
  <li><a href="#qemu" id="toc-qemu" class="nav-link" data-scroll-target="#qemu">QEMU</a></li>
  <li><a href="#run-qemu" id="toc-run-qemu" class="nav-link" data-scroll-target="#run-qemu">Run QEMU</a></li>
  <li><a href="#run-main" id="toc-run-main" class="nav-link" data-scroll-target="#run-main">Run main</a></li>
  <li><a href="#bios" id="toc-bios" class="nav-link" data-scroll-target="#bios">BIOS</a></li>
  </ul></li>
  <li><a href="#fin" id="toc-fin" class="nav-link" data-scroll-target="#fin">Fin</a>
  <ul class="collapse">
  <li><a href="#todo" id="toc-todo" class="nav-link" data-scroll-target="#todo">TODO</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">RISC-V</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i></button></div></div>
<p class="subtitle lead">OS in Rust</p>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="homework" class="level2">
<h2 class="anchored" data-anchor-id="homework">Homework</h2>
<ul>
<li>Homeworks are due on the Friday <em>after</em> the week they correspond to lecture.</li>
<li>So 9 days after the corresponding lab.</li>
</ul>
</section>
<section id="requirements" class="level2">
<h2 class="anchored" data-anchor-id="requirements">Requirements</h2>
<ul class="task-list">
<li><label><input type="checkbox"><code>371rs/32</code> crate; I named mine “osirs”</label></li>
<li><label><input type="checkbox">Use the <code>src/main.rs</code> from the <a href="./31_linker.html">linker</a> lab.</label></li>
<li><label><input type="checkbox">Run on emulated RISC-V in QEMU.</label></li>
</ul>
</section>
<section id="main" class="level1">
<h1>main</h1>
<section id="code" class="level2">
<h2 class="anchored" data-anchor-id="code">Code</h2>
<div class="callout callout-style-simple callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Don’t be like me
</div>
</div>
<div class="callout-body-container callout-body">
<p>Loops are more stable than recursion I guess.</p>
</div>
</div>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/main.rs</strong></pre>
</div>
<div class="sourceCode" id="cb1" data-filename="src/main.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb1-1"><a href="#cb1-1"></a><span class="at">#![</span>no_main<span class="at">]</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="at">#![</span>no_std<span class="at">]</span></span>
<span id="cb1-3"><a href="#cb1-3"></a></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">"C"</span> <span class="kw">fn</span> _start() <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb1-5"><a href="#cb1-5"></a>    <span class="cf">loop</span> <span class="op">{}</span></span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="op">}</span></span>
<span id="cb1-7"><a href="#cb1-7"></a></span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="at">#[</span>panic_handler<span class="at">]</span></span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="kw">fn</span> panic(_info<span class="op">:</span> <span class="op">&amp;</span><span class="pp">core::panic::</span>PanicInfo) <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb1-10"><a href="#cb1-10"></a>    <span class="cf">loop</span> <span class="op">{}</span></span>
<span id="cb1-11"><a href="#cb1-11"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="other-stuff" class="level2">
<h2 class="anchored" data-anchor-id="other-stuff">Other stuff</h2>
<ul>
<li>I graciously borrrowed some code from this repository.</li>
<li><a href="https://github.com/Alignof/helloworld_in_riscv_and_rust_baremetal/">helloworld_in_riscv_and_rust_baremetal</a></li>
</ul>
<div class="sourceCode" id="cb2"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1"></a><span class="fu">git</span> clone https://github.com/Alignof/helloworld_in_riscv_and_rust_baremetal.git</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Just kidding don’t use that, use this instead.</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1"></a><span class="fu">git</span> clone https://github.com/cd-rs/hwr5.git</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>I made a cool version.</li>
</ul>
</section>
<section id="the-working-parts" class="level2">
<h2 class="anchored" data-anchor-id="the-working-parts">The working parts</h2>
<div class="sourceCode" id="cb4"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1"></a><span class="ex">$</span> tree</span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="bu">.</span></span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="ex">├──</span> Cargo.lock</span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="ex">├──</span> Cargo.toml</span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="ex">├──</span> link.x</span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="ex">├──</span> memory.x</span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="ex">└──</span> src</span>
<span id="cb4-8"><a href="#cb4-8"></a>    <span class="ex">└──</span> main.rs</span>
<span id="cb4-9"><a href="#cb4-9"></a></span>
<span id="cb4-10"><a href="#cb4-10"></a><span class="ex">1</span> directory, 5 files</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Some of this shouldn’t be new to you.
<ul class="task-list">
<li><label><input type="checkbox" checked=""><code>Cargo.lock</code></label></li>
<li><label><input type="checkbox" checked=""><code>Cargo.toml</code></label></li>
<li><label><input type="checkbox" checked=""><code>src/main.rs</code></label></li>
</ul></li>
<li>Some should:
<ul class="task-list">
<li><label><input type="checkbox"><code>link.x</code></label></li>
<li><label><input type="checkbox"><code>memory.x</code></label></li>
</ul></li>
</ul>
</section>
<section id="the-internals" class="level2">
<h2 class="anchored" data-anchor-id="the-internals">The internals</h2>
<ul>
<li>Without dwelling on the details, these <code>.x</code> files are for the <em>linker</em>
<ul>
<li>Remember our good friend the linker.</li>
<li><code>link.x</code> was written by someone that understands linkers.</li>
<li><code>memory.x</code> was written by a script from a crate written by someone that understands linkers.</li>
</ul></li>
<li>From our perspective, they “just work”
<ul>
<li>But how?</li>
</ul></li>
</ul>
</section>
<section id="starting-point" class="level2">
<h2 class="anchored" data-anchor-id="starting-point">Starting Point</h2>
<ul>
<li>At first, probably nothing works.
<ul>
<li>Or at least, <code>cargo b</code> doesn’t work.</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb5"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1"></a><span class="ex">$</span> cargo b</span>
<span id="cb5-2"><a href="#cb5-2"></a>   <span class="ex">Compiling</span> osirs v0.1.0 <span class="er">(</span><span class="ex">/home/user/tmp/hwr5</span><span class="kw">)</span></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="ex">error:</span> linking with <span class="kw">`</span><span class="fu">cc</span><span class="kw">`</span> failed: exit status: 1</span>
<span id="cb5-4"><a href="#cb5-4"></a>  <span class="kw">|</span></span>
<span id="cb5-5"><a href="#cb5-5"></a>  <span class="ex">=</span> note:  <span class="st">"cc"</span> <span class="st">"-m64"</span> <span class="st">"/tmp/rustcwuxfha/symbols.o"</span> <span class="st">"&lt;1 object files omitted&gt;"</span> <span class="st">"-Wl,--as-needed"</span> <span class="st">"-Wl,-Bstatic"</span> <span class="st">"&lt;sysroot&gt;/lib/rustlib/x86_64-unknown-linux-gnu/lib/{librustc_std_workspace_core-*,libcore-*,libcompiler_builtins-*}.rlib"</span> <span class="st">"-L"</span> <span class="st">"/tmp/rustcwuxfha/raw-dylibs"</span> <span class="st">"-Wl,-Bdynamic"</span> <span class="st">"-Wl,--eh-frame-hdr"</span> <span class="st">"-Wl,-z,noexecstack"</span> <span class="st">"-L"</span> <span class="st">"&lt;sysroot&gt;/lib/rustlib/x86_64-unknown-linux-gnu/lib"</span> <span class="st">"-o"</span> <span class="st">"/home/user/tmp/hwr5/target/debug/deps/osirs-80f8eb3240ba748e"</span> <span class="st">"-Wl,--gc-sections"</span> <span class="st">"-pie"</span> <span class="st">"-Wl,-z,relro,-z,now"</span> <span class="st">"-nodefaultlibs"</span></span>
<span id="cb5-6"><a href="#cb5-6"></a>  <span class="ex">=</span> note: some arguments are omitted. use <span class="kw">`</span><span class="ex">--verbose</span><span class="kw">`</span> to show all linker arguments</span>
<span id="cb5-7"><a href="#cb5-7"></a>  <span class="ex">=</span> note: /usr/bin/ld: /home/user/tmp/hwr5/target/debug/deps/osirs-80f8eb3240ba748e.9chdw59nqscmfe0ef1hrxy2nb.rcgu.o: in function <span class="kw">`</span><span class="ex">_start</span><span class="st">':</span></span>
<span id="cb5-8"><a href="#cb5-8"></a><span class="st">          /home/user/tmp/hwr5/src/main.rs:7: multiple definition of `_start'</span><span class="kw">;</span> <span class="ex">/usr/lib/gcc/x86_64-linux-gnu/11/../../../x86_64-linux-gnu/Scrt1.o:</span><span class="er">(</span><span class="ex">.text+0x0</span><span class="kw">)</span><span class="bu">:</span> first defined here</span>
<span id="cb5-9"><a href="#cb5-9"></a>          <span class="ex">/usr/bin/ld:</span> /usr/lib/gcc/x86_64-linux-gnu/11/../../../x86_64-linux-gnu/Scrt1.o: in function <span class="kw">`</span>_start<span class="st">':</span></span>
<span id="cb5-10"><a href="#cb5-10"></a><span class="st">          (.text+0x1b): undefined reference to `main'</span></span>
<span id="cb5-11"><a href="#cb5-11"></a>          <span class="ex">/usr/bin/ld:</span> <span class="er">(</span><span class="ex">.text+0x21</span><span class="kw">)</span><span class="bu">:</span> undefined reference to <span class="kw">`</span><span class="ex">__libc_start_main</span><span class="st">'</span></span>
<span id="cb5-12"><a href="#cb5-12"></a><span class="st">          collect2: error: ld returned 1 exit status</span></span>
<span id="cb5-13"><a href="#cb5-13"></a></span>
<span id="cb5-14"><a href="#cb5-14"></a><span class="st">  = note: some `extern` functions couldn'</span><span class="ex">t</span> be found<span class="kw">;</span> <span class="ex">some</span> native libraries may need to be installed or have their path specified</span>
<span id="cb5-15"><a href="#cb5-15"></a>  <span class="ex">=</span> note: use the <span class="kw">`</span><span class="at">-l</span><span class="kw">`</span> <span class="ex">flag</span> to specify native libraries to link</span>
<span id="cb5-16"><a href="#cb5-16"></a>  <span class="ex">=</span> note: use the <span class="kw">`</span>cargo:rustc-link-lib<span class="kw">`</span> <span class="ex">directive</span> to specify the native libraries to link with Cargo <span class="er">(</span><span class="ex">see</span> https://doc.rust-lang.org/cargo/reference/build-scripts.html#rustc-link-lib<span class="kw">)</span></span>
<span id="cb5-17"><a href="#cb5-17"></a></span>
<span id="cb5-18"><a href="#cb5-18"></a><span class="ex">error:</span> could not compile <span class="kw">`</span>osirs<span class="kw">`</span> <span class="kw">(</span><span class="ex">bin</span> <span class="st">"osirs"</span><span class="kw">)</span> <span class="ex">due</span> to 1 previous error</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="rustc" class="level2">
<h2 class="anchored" data-anchor-id="rustc"><code>rustc</code></h2>
<ul>
<li>I found it easier to get to work with <code>rustc</code>
<ul>
<li>Cargo hater Calvin</li>
</ul></li>
<li>Recall a way we ran the executable in the lab.</li>
</ul>
<div class="sourceCode" id="cb6"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1"></a><span class="ex">cargo</span> rustc <span class="at">--</span> <span class="at">-C</span> link-arg=-nostartfiles</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>We can just go straight to <code>rustc</code></li>
</ul>
<div class="sourceCode" id="cb7"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1"></a><span class="ex">rust</span> <span class="at">-C</span> link-arg=-nostartfiles</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Only one catch.
<ul>
<li>Well, two.</li>
<li>We want to link files.</li>
<li>Specifically, the <code>.x</code> files.</li>
</ul></li>
</ul>
<p><img src="https://upload.wikimedia.org/wikipedia/en/thumb/5/5e/The_X-Files_original_title_screen.webp/412px-The_X-Files_original_title_screen.webp.png" class="img-fluid"></p>
</section>
<section id="naively" class="level2">
<h2 class="anchored" data-anchor-id="naively">Naively</h2>
<ul>
<li>You can give <code>rustc</code> a shot straight-away.</li>
</ul>
<div class="sourceCode" id="cb8"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1"></a><span class="ex">$</span> rustc src/main.rs</span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="ex">error:</span> unwinding panics are not supported without std</span>
<span id="cb8-3"><a href="#cb8-3"></a>  <span class="kw">|</span></span>
<span id="cb8-4"><a href="#cb8-4"></a>  <span class="ex">=</span> help: using nightly cargo, use <span class="at">-Zbuild-std</span> with panic=<span class="st">"abort"</span> to avoid unwinding</span>
<span id="cb8-5"><a href="#cb8-5"></a>  <span class="ex">=</span> note: since the core library is usually precompiled with panic=<span class="st">"unwind"</span>, rebuilding your crate with panic=<span class="st">"abort"</span> may not be enough to fix the problem</span>
<span id="cb8-6"><a href="#cb8-6"></a></span>
<span id="cb8-7"><a href="#cb8-7"></a><span class="ex">error:</span> aborting due to 1 previous error</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>We recall we “fixed” the problem with panics by modifying <code>Cargo.toml</code>.</li>
<li><code>rustc</code> doesn’t care about your <code>Cargo.toml</code>!</li>
<li>We instead have to specify an argument to <code>rustc</code>.</li>
<li>We do so similarly to the <code>link-arg</code>, with the <code>-C</code> flag.
<ul>
<li>We furnish basically the same thing we placed in <code>Cargo.toml</code>.</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb9"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1"></a><span class="ex">rustc</span> src/main.rs <span class="at">-C</span> panic=abort</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Get this working and see if you can get the following error message:</li>
</ul>
<div class="sourceCode" id="cb10"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1"></a><span class="ex">$</span> rustc src/main.rs <span class="at">-C</span> panic=abort</span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="ex">error:</span> linking with <span class="kw">`</span><span class="fu">cc</span><span class="kw">`</span> failed: exit status: 1</span>
<span id="cb10-3"><a href="#cb10-3"></a>  <span class="kw">|</span></span>
<span id="cb10-4"><a href="#cb10-4"></a>  <span class="ex">=</span> note:  <span class="st">"cc"</span> <span class="st">"-m64"</span> <span class="st">"/tmp/rustceBlIYK/symbols.o"</span> <span class="st">"&lt;1 object files omitted&gt;"</span> <span class="st">"-Wl,--as-needed"</span> <span class="st">"-Wl,-Bstatic"</span> <span class="st">"&lt;sysroot&gt;/lib/rustlib/x86_64-unknown-linux-gnu/lib/{librustc_std_workspace_core-*,libcore-*,libcompiler_builtins-*}.rlib"</span> <span class="st">"-L"</span> <span class="st">"/tmp/rustceBlIYK/raw-dylibs"</span> <span class="st">"-Wl,-Bdynamic"</span> <span class="st">"-Wl,--eh-frame-hdr"</span> <span class="st">"-Wl,-z,noexecstack"</span> <span class="st">"-L"</span> <span class="st">"&lt;sysroot&gt;/lib/rustlib/x86_64-unknown-linux-gnu/lib"</span> <span class="st">"-o"</span> <span class="st">"main"</span> <span class="st">"-Wl,--gc-sections"</span> <span class="st">"-pie"</span> <span class="st">"-Wl,-z,relro,-z,now"</span> <span class="st">"-nodefaultlibs"</span></span>
<span id="cb10-5"><a href="#cb10-5"></a>  <span class="ex">=</span> note: some arguments are omitted. use <span class="kw">`</span><span class="ex">--verbose</span><span class="kw">`</span> to show all linker arguments</span>
<span id="cb10-6"><a href="#cb10-6"></a>  <span class="ex">=</span> note: /usr/bin/ld: main.main.5f6bf0c8e9d0afce-cgu.0.rcgu.o: in function <span class="kw">`</span><span class="ex">_start</span><span class="st">':</span></span>
<span id="cb10-7"><a href="#cb10-7"></a><span class="st">          main.5f6bf0c8e9d0afce-cgu.0:(.text._start+0x0): multiple definition of `_start'</span><span class="kw">;</span> <span class="ex">/usr/lib/gcc/x86_64-linux-gnu/11/../../../x86_64-linux-gnu/Scrt1.o:</span><span class="er">(</span><span class="ex">.text+0x0</span><span class="kw">)</span><span class="bu">:</span> first defined here</span>
<span id="cb10-8"><a href="#cb10-8"></a>          <span class="ex">/usr/bin/ld:</span> /usr/lib/gcc/x86_64-linux-gnu/11/../../../x86_64-linux-gnu/Scrt1.o: in function <span class="kw">`</span>_start<span class="st">':</span></span>
<span id="cb10-9"><a href="#cb10-9"></a><span class="st">          (.text+0x1b): undefined reference to `main'</span></span>
<span id="cb10-10"><a href="#cb10-10"></a>          <span class="ex">/usr/bin/ld:</span> <span class="er">(</span><span class="ex">.text+0x21</span><span class="kw">)</span><span class="bu">:</span> undefined reference to <span class="kw">`</span><span class="ex">__libc_start_main</span><span class="st">'</span></span>
<span id="cb10-11"><a href="#cb10-11"></a><span class="st">          collect2: error: ld returned 1 exit status</span></span>
<span id="cb10-12"><a href="#cb10-12"></a></span>
<span id="cb10-13"><a href="#cb10-13"></a><span class="st">  = note: some `extern` functions couldn'</span><span class="ex">t</span> be found<span class="kw">;</span> <span class="ex">some</span> native libraries may need to be installed or have their path specified</span>
<span id="cb10-14"><a href="#cb10-14"></a>  <span class="ex">=</span> note: use the <span class="kw">`</span><span class="at">-l</span><span class="kw">`</span> <span class="ex">flag</span> to specify native libraries to link</span>
<span id="cb10-15"><a href="#cb10-15"></a></span>
<span id="cb10-16"><a href="#cb10-16"></a><span class="ex">error:</span> aborting due to 1 previous error</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Ah hah! A linker error! Just as we hoped.</li>
</ul>
</section>
<section id="t" class="level2">
<h2 class="anchored" data-anchor-id="t"><code>-T</code></h2>
<ul>
<li>The linker complains it’s missing something, and it’s not sure what.</li>
<li>We are sure, it’s the <code>.x</code> files.</li>
<li>To furnish a file by name to the linker, we provide it as a <code>link-arg</code> prefixed with <code>-T</code></li>
</ul>
<div class="sourceCode" id="cb11"><pre class="sourceCode numberSource email number-lines code-with-copy"><code class="sourceCode email"><span id="cb11-1"><a href="#cb11-1"></a>link-arg=-Tlink.x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>If you link both <code>.x</code> files, you will get a different error message.</li>
</ul>
<div class="sourceCode" id="cb12"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1"></a><span class="ex">$</span> rustc <span class="at">-C</span> link-args=-Tmemory.x <span class="at">-C</span> link-args=-Tlink.x <span class="at">-C</span> panic=abort src/main.rs</span>
<span id="cb12-2"><a href="#cb12-2"></a><span class="ex">error:</span> linking with <span class="kw">`</span><span class="fu">cc</span><span class="kw">`</span> failed: exit status: 1</span>
<span id="cb12-3"><a href="#cb12-3"></a>  <span class="kw">|</span></span>
<span id="cb12-4"><a href="#cb12-4"></a>  <span class="ex">=</span> note:  <span class="st">"cc"</span> <span class="st">"-m64"</span> <span class="st">"/tmp/rustczhisJl/symbols.o"</span> <span class="st">"&lt;1 object files omitted&gt;"</span> <span class="st">"-Wl,--as-needed"</span> <span class="st">"-Wl,-Bstatic"</span> <span class="st">"&lt;sysroot&gt;/lib/rustlib/x86_64-unknown-linux-gnu/lib/{librustc_std_workspace_core-*,libcore-*,libcompiler_builtins-*}.rlib"</span> <span class="st">"-L"</span> <span class="st">"/tmp/rustczhisJl/raw-dylibs"</span> <span class="st">"-Wl,-Bdynamic"</span> <span class="st">"-Wl,--eh-frame-hdr"</span> <span class="st">"-Wl,-z,noexecstack"</span> <span class="st">"-L"</span> <span class="st">"&lt;sysroot&gt;/lib/rustlib/x86_64-unknown-linux-gnu/lib"</span> <span class="st">"-o"</span> <span class="st">"main"</span> <span class="st">"-Wl,--gc-sections"</span> <span class="st">"-pie"</span> <span class="st">"-Wl,-z,relro,-z,now"</span> <span class="st">"-nodefaultlibs"</span> <span class="st">"-Tmemory.x"</span> <span class="st">"-Tlink.x"</span></span>
<span id="cb12-5"><a href="#cb12-5"></a>  <span class="ex">=</span> note: some arguments are omitted. use <span class="kw">`</span><span class="ex">--verbose</span><span class="kw">`</span> to show all linker arguments</span>
<span id="cb12-6"><a href="#cb12-6"></a>  <span class="ex">=</span> note: /usr/bin/ld: main.main.5f6bf0c8e9d0afce-cgu.0.rcgu.o: in function <span class="kw">`</span><span class="ex">_start</span><span class="st">':</span></span>
<span id="cb12-7"><a href="#cb12-7"></a><span class="st">          main.5f6bf0c8e9d0afce-cgu.0:(.text._start+0x0): multiple definition of `_start'</span><span class="kw">;</span> <span class="ex">/usr/lib/gcc/x86_64-linux-gnu/11/../../../x86_64-linux-gnu/Scrt1.o:</span><span class="er">(</span><span class="ex">.text+0x0</span><span class="kw">)</span><span class="bu">:</span> first defined here</span>
<span id="cb12-8"><a href="#cb12-8"></a>          <span class="ex">/usr/bin/ld:</span></span>
<span id="cb12-9"><a href="#cb12-9"></a>          <span class="ex">.got</span> section detected in the input files. Dynamic relocations are not</span>
<span id="cb12-10"><a href="#cb12-10"></a>          <span class="ex">supported.</span> If you are linking to C code compiled using the <span class="kw">`</span>gcc<span class="kw">`</span> <span class="ex">crate</span></span>
<span id="cb12-11"><a href="#cb12-11"></a>          <span class="cf">then</span> <span class="ex">modify</span> your build script to compile the C code _without_ the</span>
<span id="cb12-12"><a href="#cb12-12"></a>          <span class="ex">-fPIC</span> flag. See the documentation of the <span class="kw">`</span>gcc::Config.fpic<span class="kw">`</span> <span class="ex">method</span> for</span>
<span id="cb12-13"><a href="#cb12-13"></a>          <span class="ex">details.</span></span>
<span id="cb12-14"><a href="#cb12-14"></a>          <span class="ex">/usr/lib/gcc/x86_64-linux-gnu/11/../../../x86_64-linux-gnu/crti.o:</span> in function <span class="kw">`</span>_init<span class="st">':</span></span>
<span id="cb12-15"><a href="#cb12-15"></a><span class="st">          (.init+0xb): relocation truncated to fit: R_X86_64_REX_GOTPCRELX against undefined symbol `__gmon_start__'</span></span>
<span id="cb12-16"><a href="#cb12-16"></a>          <span class="ex">collect2:</span> error: ld returned 1 exit status</span>
<span id="cb12-17"><a href="#cb12-17"></a></span>
<span id="cb12-18"><a href="#cb12-18"></a></span>
<span id="cb12-19"><a href="#cb12-19"></a><span class="ex">error:</span> aborting due to 1 previous error</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="risc-v" class="level2">
<h2 class="anchored" data-anchor-id="risc-v">RISC-V</h2>
<ul>
<li>RISC-V is what it would be like if hardware were good.
<ul>
<li>By which I mean open-source.</li>
</ul></li>
</ul>
<table class="caption-top table">
<thead>
<tr class="header">
<th></th>
<th>Good (Open Source)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Windows</td>
<td></td>
</tr>
<tr class="even">
<td>Linux</td>
<td>x</td>
</tr>
<tr class="odd">
<td>ICC (Intel C Compiler)</td>
<td></td>
</tr>
<tr class="even">
<td>GCC</td>
<td>x</td>
</tr>
<tr class="odd">
<td>x86-64</td>
<td></td>
</tr>
<tr class="even">
<td>ARM64</td>
<td></td>
</tr>
<tr class="odd">
<td>RISC-V</td>
<td>x</td>
</tr>
</tbody>
</table>
<blockquote class="blockquote">
<p><a href="https://en.wikipedia.org/wiki/RISC-V">RISC-V (pronounced “risk-five”): 1  is a free and open standard instruction set architecture (ISA) based on reduced instruction set computer (RISC) principles. Unlike proprietary ISAs such as x86 and ARM, RISC-V is described as “free and open” because its specifications are released under permissive open-source licenses and can be implemented without paying royalties.</a></p>
</blockquote>
<blockquote class="blockquote">
<p><a href="https://riscv.org/">The RISC-V instruction set architecture (ISA) offers a highly customizable open standard platform, enabling developers to build, port, and optimize software applications, extensions, and hardware. Its simplicity and modularity enables efficient design and optimization, fostering innovation and reducing development time and cost.</a></p>
</blockquote>
<ul>
<li>Also unlike x86 and ARM, it is easy to develop for RISC-V, and that is what we’ve done.</li>
</ul>
<div class="sourceCode" id="cb13"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1"></a><span class="ex">$</span> grep riscv link.x</span>
<span id="cb13-2"><a href="#cb13-2"></a>  <span class="ex">By</span> default uses the riscv crates default trap handler</span>
<span id="cb13-3"><a href="#cb13-3"></a><span class="ex">ERROR</span><span class="er">(</span><span class="ex">riscv-rt</span><span class="kw">)</span><span class="bu">:</span> the start of the REGION_TEXT must be 4-byte aligned<span class="st">");</span></span>
<span id="cb13-4"><a href="#cb13-4"></a><span class="st">ERROR(riscv-rt): the start of the REGION_RODATA must be 4-byte aligned"</span><span class="er">)</span><span class="kw">;</span></span>
<span id="cb13-5"><a href="#cb13-5"></a><span class="ex">ERROR</span><span class="er">(</span><span class="ex">riscv-rt</span><span class="kw">)</span><span class="bu">:</span> the start of the REGION_DATA must be 4-byte aligned<span class="st">");</span></span>
<span id="cb13-6"><a href="#cb13-6"></a><span class="st">ERROR(riscv-rt): the start of the REGION_HEAP must be 4-byte aligned"</span><span class="er">)</span><span class="kw">;</span></span>
<span id="cb13-7"><a href="#cb13-7"></a><span class="ex">ERROR</span><span class="er">(</span><span class="ex">riscv-rt</span><span class="kw">)</span><span class="bu">:</span> the start of the REGION_TEXT must be 4-byte aligned<span class="st">");</span></span>
<span id="cb13-8"><a href="#cb13-8"></a><span class="st">ERROR(riscv-rt): the start of the REGION_STACK must be 4-byte aligned"</span><span class="er">)</span><span class="kw">;</span></span>
<span id="cb13-9"><a href="#cb13-9"></a><span class="ex">ERROR</span><span class="er">(</span><span class="ex">riscv-rt</span><span class="kw">)</span><span class="bu">:</span> <span class="kw">`</span><span class="ex">_stext</span><span class="kw">`</span> must be 4-byte aligned<span class="st">");</span></span>
<span id="cb13-10"><a href="#cb13-10"></a><span class="st">BUG(riscv-rt): .data is not 4-byte aligned"</span><span class="er">)</span><span class="kw">;</span></span>
<span id="cb13-11"><a href="#cb13-11"></a><span class="ex">BUG</span><span class="er">(</span><span class="ex">riscv-rt</span><span class="kw">)</span><span class="bu">:</span> the LMA of .data is not 4-byte aligned<span class="st">");</span></span>
<span id="cb13-12"><a href="#cb13-12"></a><span class="st">BUG(riscv-rt): .bss is not 4-byte aligned"</span><span class="er">)</span><span class="kw">;</span></span>
<span id="cb13-13"><a href="#cb13-13"></a><span class="ex">BUG</span><span class="er">(</span><span class="ex">riscv-rt</span><span class="kw">)</span><span class="bu">:</span> start of .heap is not 4-byte aligned<span class="st">");</span></span>
<span id="cb13-14"><a href="#cb13-14"></a><span class="st">ERROR(riscv-rt): The .text section must be placed inside the REGION_TEXT region.</span></span>
<span id="cb13-15"><a href="#cb13-15"></a><span class="st">ERROR(riscv-rt): .stack section is too small for allocating stacks for all the harts.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>By golly, our <code>.x</code> files are for RISC-V!
<ul>
<li>And therefore <em>good</em>.</li>
</ul></li>
</ul>
</section>
<section id="target" class="level2">
<h2 class="anchored" data-anchor-id="target">Target</h2>
<ul>
<li>We recall the notion of a <em>target triple</em>
<ul>
<li>From the <a href="./31_linker.html#target-triple">linker lab</a></li>
</ul></li>
<li>We note:
<ul>
<li>There are references to x86 (in my case) in the error logs.</li>
<li>There are references to RISC-V in the linker files.</li>
<li>We have to pick one, and…</li>
<li>I didn’t provide appropriate linker files for x86
<ul>
<li>Because it’s bad!</li>
</ul></li>
</ul></li>
<li>You will additionlly need to specify a target.</li>
<li><code>riscv64imac-unknown-none-elf</code></li>
<li>You will figure it out.
<ul>
<li>And you will know when you have, because you will see <em>no errors</em> and a <code>main</code> will have appeared.</li>
</ul></li>
</ul>
</section>
<section id="main-1" class="level2">
<h2 class="anchored" data-anchor-id="main-1">Main</h2>
<ul>
<li>Go ahead and run <code>main</code>, what could go wrong.</li>
</ul>
<div class="sourceCode" id="cb14"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1"></a><span class="ex">$</span> ./main</span>
<span id="cb14-2"><a href="#cb14-2"></a><span class="ex">-bash:</span> ./main: cannot execute binary file: Exec format error</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>If, like me, you foolish use an architecture other than RISC-V as your daily driver (that’s a metaphor, not a reference to device drivers), <code>main</code> won’t work on your system.</li>
</ul>
</section>
<section id="qemu" class="level2">
<h2 class="anchored" data-anchor-id="qemu">QEMU</h2>
<ul>
<li>Well, it will, you just have to bamboozle your system into pretending to be a <em>good</em> system, like RISC-V</li>
</ul>
<div class="sourceCode" id="cb15"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1"></a><span class="fu">sudo</span> apt install qemu-system-misc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>We don’t allow our feelings to be hurt by RISC-V being described as “miscellaneous”.
<ul>
<li>I didn’t properly sandbox my system before debugging so I think this is all you need but I may be wrong if I lost a dependency somewhere.</li>
</ul></li>
</ul>
</section>
<section id="run-qemu" class="level2">
<h2 class="anchored" data-anchor-id="run-qemu">Run QEMU</h2>
<ul>
<li>You can simply launch <code>qemu</code> with no strings attached.</li>
</ul>
<div class="sourceCode" id="cb16"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1"></a><span class="ex">qemu-system-riscv64</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>For me this popped open a new window.
<ul>
<li>This is good, as otherwise you have to deal with processes and I don’t have time to teach that.</li>
<li>If you type “quit” after the prompt of <code>(qemu)</code> it should close.</li>
</ul></li>
</ul>
</section>
<section id="run-main" class="level2">
<h2 class="anchored" data-anchor-id="run-main">Run main</h2>
<ul>
<li>You can specify that you totally wrote a working OS, honest, by providing <code>qemu</code> with a specified kernel, like our <code>main</code></li>
</ul>
<div class="sourceCode" id="cb17"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1"></a><span class="ex">qemu-system-riscv64</span> <span class="at">-kernel</span> main</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-simple callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Forward Pointer
</div>
</div>
<div class="callout-body-container callout-body">
<p>We will properly introduce kernels in the next lecture.</p>
</div>
</div>
<ul>
<li>This will probably work.</li>
</ul>
<div class="sourceCode" id="cb18"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1"></a><span class="ex">$</span> qemu-system-riscv64 <span class="at">-kernel</span> main</span>
<span id="cb18-2"><a href="#cb18-2"></a><span class="ex">qemu-system-riscv64:</span> Some ROM regions are overlapping</span>
<span id="cb18-3"><a href="#cb18-3"></a><span class="ex">These</span> ROM regions might have been loaded by direct user request or by default.</span>
<span id="cb18-4"><a href="#cb18-4"></a><span class="ex">They</span> could be BIOS/firmware images, a guest kernel, initrd or some other file loaded into guest memory.</span>
<span id="cb18-5"><a href="#cb18-5"></a><span class="ex">Check</span> whether you intended to load all this guest code, and whether it has been built to load to the correct addresses.</span>
<span id="cb18-6"><a href="#cb18-6"></a></span>
<span id="cb18-7"><a href="#cb18-7"></a><span class="ex">The</span> following two regions overlap <span class="er">(in</span> <span class="ex">the</span> memory address space<span class="kw">)</span><span class="bu">:</span></span>
<span id="cb18-8"><a href="#cb18-8"></a>  <span class="ex">/usr/share/qemu/opensbi-riscv64-generic-fw_dynamic.elf</span> ELF program header segment 1 <span class="er">(</span><span class="ex">addresses</span> 0x0000000080000000 <span class="at">-</span> 0x0000000080016ce8<span class="kw">)</span></span>
<span id="cb18-9"><a href="#cb18-9"></a>  <span class="ex">main</span> ELF program header segment 0 <span class="er">(</span><span class="ex">addresses</span> 0x0000000080000000 <span class="at">-</span> 0x0000000080000004<span class="kw">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>And by probably I mean with a probability of zero.</li>
</ul>
</section>
<section id="bios" class="level2">
<h2 class="anchored" data-anchor-id="bios">BIOS</h2>
<ul>
<li>The BIOS can be thought of as a tiny bit of read-only memory (ROM) that lives on a computer.</li>
<li>When the computer first turns on, it immediately begins reading instructions from the BIOS (presumably over the bus, or through some other means).</li>
<li>The BIOS will then instruct the device how to procede.</li>
<li>We don’t need any of that, we already wrote an infinite loop and can just start there!</li>
</ul>
<div class="sourceCode" id="cb19"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1"></a><span class="ex">qemu-system-riscv64</span> <span class="at">-kernel</span> main <span class="at">-bios</span> none</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<blockquote class="blockquote">
<p><a href="https://en.wikipedia.org/wiki/BIOS">In computing, BIOS (Basic Input/Output System, also known as the System BIOS, ROM BIOS, BIOS ROM or PC BIOS) is a type of firmware used to provide runtime services for operating systems and programs and to perform hardware initialization during the booting process (power-on startup). On a computer using BIOS firmware, the firmware comes pre-installed on the computer’s motherboard.</a></p>
</blockquote>
</section>
</section>
<section id="fin" class="level1">
<h1>Fin</h1>
<p>For me that worked, hopefully for you too! If not, you have officially entered the fun zone.</p>
<section id="todo" class="level2">
<h2 class="anchored" data-anchor-id="todo">TODO</h2>
<p>For this homework, add a README.md to the crate describing how to get it to work.</p>
<ul>
<li>It should be like this document, but concise.</li>
<li>Use cool markdown checkboxes.</li>
</ul>
<div class="sourceCode" id="cb20"><pre class="sourceCode numberSource md number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb20-1"><a href="#cb20-1"></a><span class="ss">- </span><span class="va">[ ]</span> Do a thing.</span>
<span id="cb20-2"><a href="#cb20-2"></a><span class="ss">- </span><span class="va">[ ]</span> Do another thing.</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>


<!-- -->

</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./31_linker.html" class="pagination-link" aria-label="Linker">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Linker</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb21" data-shortcodes="false"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb21-1"><a href="#cb21-1"></a><span class="co">---</span></span>
<span id="cb21-2"><a href="#cb21-2"></a><span class="an">title:</span><span class="co"> RISC-V</span></span>
<span id="cb21-3"><a href="#cb21-3"></a><span class="an">format:</span><span class="co"> html</span></span>
<span id="cb21-4"><a href="#cb21-4"></a><span class="co">---</span></span>
<span id="cb21-5"><a href="#cb21-5"></a></span>
<span id="cb21-6"><a href="#cb21-6"></a><span class="fu">## Homework</span></span>
<span id="cb21-7"><a href="#cb21-7"></a></span>
<span id="cb21-8"><a href="#cb21-8"></a><span class="ss">- </span>Homeworks are due on the Friday *after* the week they correspond to lecture.</span>
<span id="cb21-9"><a href="#cb21-9"></a><span class="ss">- </span>So 9 days after the corresponding lab.</span>
<span id="cb21-10"><a href="#cb21-10"></a></span>
<span id="cb21-11"><a href="#cb21-11"></a><span class="fu">## Requirements</span></span>
<span id="cb21-12"><a href="#cb21-12"></a></span>
<span id="cb21-13"><a href="#cb21-13"></a><span class="ss">- </span><span class="va">[ ]</span> <span class="in">`371rs/32`</span> crate; I named mine "osirs"</span>
<span id="cb21-14"><a href="#cb21-14"></a><span class="ss">- </span><span class="va">[ ]</span> Use the <span class="in">`src/main.rs`</span> from the <span class="co">[</span><span class="ot">linker</span><span class="co">](31_linker.md)</span> lab.</span>
<span id="cb21-15"><a href="#cb21-15"></a><span class="ss">- </span><span class="va">[ ]</span> Run on emulated RISC-V in QEMU.</span>
<span id="cb21-16"><a href="#cb21-16"></a></span>
<span id="cb21-17"><a href="#cb21-17"></a><span class="fu"># main</span></span>
<span id="cb21-18"><a href="#cb21-18"></a></span>
<span id="cb21-19"><a href="#cb21-19"></a><span class="fu">## Code</span></span>
<span id="cb21-20"><a href="#cb21-20"></a></span>
<span id="cb21-21"><a href="#cb21-21"></a>::: {.callout-note appearance="simple"}</span>
<span id="cb21-22"><a href="#cb21-22"></a></span>
<span id="cb21-23"><a href="#cb21-23"></a><span class="fu">## Don't be like me</span></span>
<span id="cb21-24"><a href="#cb21-24"></a></span>
<span id="cb21-25"><a href="#cb21-25"></a>Loops are more stable than recursion I guess.</span>
<span id="cb21-26"><a href="#cb21-26"></a></span>
<span id="cb21-27"><a href="#cb21-27"></a>:::</span>
<span id="cb21-28"><a href="#cb21-28"></a></span>
<span id="cb21-29"><a href="#cb21-29"></a><span class="in">```{.rs filename="src/main.rs"}</span></span>
<span id="cb21-30"><a href="#cb21-30"></a><span class="in">#![no_main]</span></span>
<span id="cb21-31"><a href="#cb21-31"></a><span class="in">#![no_std]</span></span>
<span id="cb21-32"><a href="#cb21-32"></a></span>
<span id="cb21-33"><a href="#cb21-33"></a><span class="in">pub extern "C" fn _start() -&gt; ! {</span></span>
<span id="cb21-34"><a href="#cb21-34"></a><span class="in">    loop {}</span></span>
<span id="cb21-35"><a href="#cb21-35"></a><span class="in">}</span></span>
<span id="cb21-36"><a href="#cb21-36"></a></span>
<span id="cb21-37"><a href="#cb21-37"></a><span class="in">#[panic_handler]</span></span>
<span id="cb21-38"><a href="#cb21-38"></a><span class="in">fn panic(_info: &amp;core::panic::PanicInfo) -&gt; ! {</span></span>
<span id="cb21-39"><a href="#cb21-39"></a><span class="in">    loop {}</span></span>
<span id="cb21-40"><a href="#cb21-40"></a><span class="in">}</span></span>
<span id="cb21-41"><a href="#cb21-41"></a><span class="in">```</span></span>
<span id="cb21-42"><a href="#cb21-42"></a></span>
<span id="cb21-43"><a href="#cb21-43"></a></span>
<span id="cb21-44"><a href="#cb21-44"></a><span class="fu">## Other stuff</span></span>
<span id="cb21-45"><a href="#cb21-45"></a></span>
<span id="cb21-46"><a href="#cb21-46"></a><span class="ss">- </span>I graciously borrrowed some code from this repository.</span>
<span id="cb21-47"><a href="#cb21-47"></a><span class="ss">- </span>[</span>
<span id="cb21-48"><a href="#cb21-48"></a>helloworld_in_riscv_and_rust_baremetal</span>
<span id="cb21-49"><a href="#cb21-49"></a>](https://github.com/Alignof/helloworld_in_riscv_and_rust_baremetal/)</span>
<span id="cb21-50"><a href="#cb21-50"></a></span>
<span id="cb21-51"><a href="#cb21-51"></a><span class="in">```{.sh}</span></span>
<span id="cb21-52"><a href="#cb21-52"></a><span class="in">git clone https://github.com/Alignof/helloworld_in_riscv_and_rust_baremetal.git</span></span>
<span id="cb21-53"><a href="#cb21-53"></a><span class="in">```</span></span>
<span id="cb21-54"><a href="#cb21-54"></a></span>
<span id="cb21-55"><a href="#cb21-55"></a><span class="ss">- </span>Just kidding don't use that, use this instead.</span>
<span id="cb21-56"><a href="#cb21-56"></a></span>
<span id="cb21-57"><a href="#cb21-57"></a><span class="in">```{.sh}</span></span>
<span id="cb21-58"><a href="#cb21-58"></a><span class="in">git clone https://github.com/cd-rs/hwr5.git</span></span>
<span id="cb21-59"><a href="#cb21-59"></a><span class="in">```</span></span>
<span id="cb21-60"><a href="#cb21-60"></a></span>
<span id="cb21-61"><a href="#cb21-61"></a><span class="ss">- </span>I made a cool version.</span>
<span id="cb21-62"><a href="#cb21-62"></a></span>
<span id="cb21-63"><a href="#cb21-63"></a><span class="fu">## The working parts</span></span>
<span id="cb21-64"><a href="#cb21-64"></a></span>
<span id="cb21-65"><a href="#cb21-65"></a><span class="in">```{.sh}</span></span>
<span id="cb21-66"><a href="#cb21-66"></a><span class="in">$ tree</span></span>
<span id="cb21-67"><a href="#cb21-67"></a><span class="in">.</span></span>
<span id="cb21-68"><a href="#cb21-68"></a><span class="in">├── Cargo.lock</span></span>
<span id="cb21-69"><a href="#cb21-69"></a><span class="in">├── Cargo.toml</span></span>
<span id="cb21-70"><a href="#cb21-70"></a><span class="in">├── link.x</span></span>
<span id="cb21-71"><a href="#cb21-71"></a><span class="in">├── memory.x</span></span>
<span id="cb21-72"><a href="#cb21-72"></a><span class="in">└── src</span></span>
<span id="cb21-73"><a href="#cb21-73"></a><span class="in">    └── main.rs</span></span>
<span id="cb21-74"><a href="#cb21-74"></a></span>
<span id="cb21-75"><a href="#cb21-75"></a><span class="in">1 directory, 5 files</span></span>
<span id="cb21-76"><a href="#cb21-76"></a><span class="in">```</span></span>
<span id="cb21-77"><a href="#cb21-77"></a></span>
<span id="cb21-78"><a href="#cb21-78"></a><span class="ss">- </span>Some of this shouldn't be new to you.</span>
<span id="cb21-79"><a href="#cb21-79"></a><span class="ss">    - </span><span class="va">[x]</span> <span class="in">`Cargo.lock`</span></span>
<span id="cb21-80"><a href="#cb21-80"></a><span class="ss">    - </span><span class="va">[x]</span> <span class="in">`Cargo.toml`</span></span>
<span id="cb21-81"><a href="#cb21-81"></a><span class="ss">    - </span><span class="va">[x]</span> <span class="in">`src/main.rs`</span></span>
<span id="cb21-82"><a href="#cb21-82"></a><span class="ss">- </span>Some should:</span>
<span id="cb21-83"><a href="#cb21-83"></a><span class="ss">    - </span><span class="va">[ ]</span> <span class="in">`link.x`</span></span>
<span id="cb21-84"><a href="#cb21-84"></a><span class="ss">    - </span><span class="va">[ ]</span> <span class="in">`memory.x`</span></span>
<span id="cb21-85"><a href="#cb21-85"></a></span>
<span id="cb21-86"><a href="#cb21-86"></a><span class="fu">## The internals</span></span>
<span id="cb21-87"><a href="#cb21-87"></a></span>
<span id="cb21-88"><a href="#cb21-88"></a><span class="ss">- </span>Without dwelling on the details, these <span class="in">`.x`</span> files are for the *linker*</span>
<span id="cb21-89"><a href="#cb21-89"></a><span class="ss">    - </span>Remember our good friend the linker.</span>
<span id="cb21-90"><a href="#cb21-90"></a><span class="ss">    - </span><span class="in">`link.x`</span> was written by someone that understands linkers.</span>
<span id="cb21-91"><a href="#cb21-91"></a><span class="ss">    - </span><span class="in">`memory.x`</span> was written by a script from a crate written by someone that understands linkers.</span>
<span id="cb21-92"><a href="#cb21-92"></a><span class="ss">- </span>From our perspective, they "just work"</span>
<span id="cb21-93"><a href="#cb21-93"></a><span class="ss">    - </span>But how?</span>
<span id="cb21-94"><a href="#cb21-94"></a>    </span>
<span id="cb21-95"><a href="#cb21-95"></a><span class="fu">## Starting Point</span></span>
<span id="cb21-96"><a href="#cb21-96"></a></span>
<span id="cb21-97"><a href="#cb21-97"></a><span class="ss">- </span>At first, probably nothing works.</span>
<span id="cb21-98"><a href="#cb21-98"></a><span class="ss">    - </span>Or at least, <span class="in">`cargo b`</span> doesn't work.</span>
<span id="cb21-99"><a href="#cb21-99"></a></span>
<span id="cb21-100"><a href="#cb21-100"></a><span class="in">```{.sh}</span></span>
<span id="cb21-101"><a href="#cb21-101"></a><span class="in">$ cargo b</span></span>
<span id="cb21-102"><a href="#cb21-102"></a><span class="in">   Compiling osirs v0.1.0 (/home/user/tmp/hwr5)</span></span>
<span id="cb21-103"><a href="#cb21-103"></a><span class="in">error: linking with `cc` failed: exit status: 1</span></span>
<span id="cb21-104"><a href="#cb21-104"></a><span class="in">  |</span></span>
<span id="cb21-105"><a href="#cb21-105"></a><span class="in">  = note:  "cc" "-m64" "/tmp/rustcwuxfha/symbols.o" "&lt;1 object files omitted&gt;" "-Wl,--as-needed" "-Wl,-Bstatic" "&lt;sysroot&gt;/lib/rustlib/x86_64-unknown-linux-gnu/lib/{librustc_std_workspace_core-*,libcore-*,libcompiler_builtins-*}.rlib" "-L" "/tmp/rustcwuxfha/raw-dylibs" "-Wl,-Bdynamic" "-Wl,--eh-frame-hdr" "-Wl,-z,noexecstack" "-L" "&lt;sysroot&gt;/lib/rustlib/x86_64-unknown-linux-gnu/lib" "-o" "/home/user/tmp/hwr5/target/debug/deps/osirs-80f8eb3240ba748e" "-Wl,--gc-sections" "-pie" "-Wl,-z,relro,-z,now" "-nodefaultlibs"</span></span>
<span id="cb21-106"><a href="#cb21-106"></a><span class="in">  = note: some arguments are omitted. use `--verbose` to show all linker arguments</span></span>
<span id="cb21-107"><a href="#cb21-107"></a><span class="in">  = note: /usr/bin/ld: /home/user/tmp/hwr5/target/debug/deps/osirs-80f8eb3240ba748e.9chdw59nqscmfe0ef1hrxy2nb.rcgu.o: in function `_start':</span></span>
<span id="cb21-108"><a href="#cb21-108"></a><span class="in">          /home/user/tmp/hwr5/src/main.rs:7: multiple definition of `_start'; /usr/lib/gcc/x86_64-linux-gnu/11/../../../x86_64-linux-gnu/Scrt1.o:(.text+0x0): first defined here</span></span>
<span id="cb21-109"><a href="#cb21-109"></a><span class="in">          /usr/bin/ld: /usr/lib/gcc/x86_64-linux-gnu/11/../../../x86_64-linux-gnu/Scrt1.o: in function `_start':</span></span>
<span id="cb21-110"><a href="#cb21-110"></a><span class="in">          (.text+0x1b): undefined reference to `main'</span></span>
<span id="cb21-111"><a href="#cb21-111"></a><span class="in">          /usr/bin/ld: (.text+0x21): undefined reference to `__libc_start_main'</span></span>
<span id="cb21-112"><a href="#cb21-112"></a><span class="in">          collect2: error: ld returned 1 exit status</span></span>
<span id="cb21-113"><a href="#cb21-113"></a></span>
<span id="cb21-114"><a href="#cb21-114"></a><span class="in">  = note: some `extern` functions couldn't be found; some native libraries may need to be installed or have their path specified</span></span>
<span id="cb21-115"><a href="#cb21-115"></a><span class="in">  = note: use the `-l` flag to specify native libraries to link</span></span>
<span id="cb21-116"><a href="#cb21-116"></a><span class="in">  = note: use the `cargo:rustc-link-lib` directive to specify the native libraries to link with Cargo (see https://doc.rust-lang.org/cargo/reference/build-scripts.html#rustc-link-lib)</span></span>
<span id="cb21-117"><a href="#cb21-117"></a></span>
<span id="cb21-118"><a href="#cb21-118"></a><span class="in">error: could not compile `osirs` (bin "osirs") due to 1 previous error</span></span>
<span id="cb21-119"><a href="#cb21-119"></a><span class="in">```</span></span>
<span id="cb21-120"><a href="#cb21-120"></a></span>
<span id="cb21-121"><a href="#cb21-121"></a><span class="fu">## `rustc`</span></span>
<span id="cb21-122"><a href="#cb21-122"></a></span>
<span id="cb21-123"><a href="#cb21-123"></a><span class="ss">- </span>I found it easier to get to work with <span class="in">`rustc`</span></span>
<span id="cb21-124"><a href="#cb21-124"></a><span class="ss">    - </span>Cargo hater Calvin</span>
<span id="cb21-125"><a href="#cb21-125"></a><span class="ss">- </span>Recall a way we ran the executable in the lab.</span>
<span id="cb21-126"><a href="#cb21-126"></a></span>
<span id="cb21-127"><a href="#cb21-127"></a><span class="in">```{.sh}</span></span>
<span id="cb21-128"><a href="#cb21-128"></a><span class="in">cargo rustc -- -C link-arg=-nostartfiles</span></span>
<span id="cb21-129"><a href="#cb21-129"></a><span class="in">```</span></span>
<span id="cb21-130"><a href="#cb21-130"></a></span>
<span id="cb21-131"><a href="#cb21-131"></a><span class="ss">- </span>We can just go straight to <span class="in">`rustc`</span></span>
<span id="cb21-132"><a href="#cb21-132"></a></span>
<span id="cb21-133"><a href="#cb21-133"></a><span class="in">```{.sh}</span></span>
<span id="cb21-134"><a href="#cb21-134"></a><span class="in">rust -C link-arg=-nostartfiles</span></span>
<span id="cb21-135"><a href="#cb21-135"></a><span class="in">```</span></span>
<span id="cb21-136"><a href="#cb21-136"></a></span>
<span id="cb21-137"><a href="#cb21-137"></a><span class="ss">- </span>Only one catch.</span>
<span id="cb21-138"><a href="#cb21-138"></a><span class="ss">    - </span>Well, two.</span>
<span id="cb21-139"><a href="#cb21-139"></a><span class="ss">    - </span>We want to link files.</span>
<span id="cb21-140"><a href="#cb21-140"></a><span class="ss">    - </span>Specifically, the <span class="in">`.x`</span> files.</span>
<span id="cb21-141"><a href="#cb21-141"></a></span>
<span id="cb21-142"><a href="#cb21-142"></a><span class="al">![](https://upload.wikimedia.org/wikipedia/en/thumb/5/5e/The_X-Files_original_title_screen.webp/412px-The_X-Files_original_title_screen.webp.png)</span></span>
<span id="cb21-143"><a href="#cb21-143"></a></span>
<span id="cb21-144"><a href="#cb21-144"></a><span class="fu">## Naively</span></span>
<span id="cb21-145"><a href="#cb21-145"></a></span>
<span id="cb21-146"><a href="#cb21-146"></a><span class="ss">- </span>You can give <span class="in">`rustc`</span> a shot straight-away.</span>
<span id="cb21-147"><a href="#cb21-147"></a></span>
<span id="cb21-148"><a href="#cb21-148"></a><span class="in">```{.sh}</span></span>
<span id="cb21-149"><a href="#cb21-149"></a><span class="in">$ rustc src/main.rs</span></span>
<span id="cb21-150"><a href="#cb21-150"></a><span class="in">error: unwinding panics are not supported without std</span></span>
<span id="cb21-151"><a href="#cb21-151"></a><span class="in">  |</span></span>
<span id="cb21-152"><a href="#cb21-152"></a><span class="in">  = help: using nightly cargo, use -Zbuild-std with panic="abort" to avoid unwinding</span></span>
<span id="cb21-153"><a href="#cb21-153"></a><span class="in">  = note: since the core library is usually precompiled with panic="unwind", rebuilding your crate with panic="abort" may not be enough to fix the problem</span></span>
<span id="cb21-154"><a href="#cb21-154"></a></span>
<span id="cb21-155"><a href="#cb21-155"></a><span class="in">error: aborting due to 1 previous error</span></span>
<span id="cb21-156"><a href="#cb21-156"></a><span class="in">```</span></span>
<span id="cb21-157"><a href="#cb21-157"></a></span>
<span id="cb21-158"><a href="#cb21-158"></a><span class="ss">- </span>We recall we "fixed" the problem with panics by modifying <span class="in">`Cargo.toml`</span>.</span>
<span id="cb21-159"><a href="#cb21-159"></a><span class="ss">- </span><span class="in">`rustc`</span> doesn't care about your <span class="in">`Cargo.toml`</span>!</span>
<span id="cb21-160"><a href="#cb21-160"></a><span class="ss">- </span>We instead have to specify an argument to <span class="in">`rustc`</span>.</span>
<span id="cb21-161"><a href="#cb21-161"></a><span class="ss">- </span>We do so similarly to the <span class="in">`link-arg`</span>, with the <span class="in">`-C`</span> flag.</span>
<span id="cb21-162"><a href="#cb21-162"></a><span class="ss">    - </span>We furnish basically the same thing we placed in <span class="in">`Cargo.toml`</span>.</span>
<span id="cb21-163"><a href="#cb21-163"></a>    </span>
<span id="cb21-164"><a href="#cb21-164"></a><span class="in">```{.sh}</span></span>
<span id="cb21-165"><a href="#cb21-165"></a><span class="in">rustc src/main.rs -C panic=abort</span></span>
<span id="cb21-166"><a href="#cb21-166"></a><span class="in">```</span></span>
<span id="cb21-167"><a href="#cb21-167"></a></span>
<span id="cb21-168"><a href="#cb21-168"></a><span class="ss">- </span>Get this working and see if you can get the following error message:</span>
<span id="cb21-169"><a href="#cb21-169"></a></span>
<span id="cb21-170"><a href="#cb21-170"></a><span class="in">```{.sh}</span></span>
<span id="cb21-171"><a href="#cb21-171"></a><span class="in">$ rustc src/main.rs -C panic=abort</span></span>
<span id="cb21-172"><a href="#cb21-172"></a><span class="in">error: linking with `cc` failed: exit status: 1</span></span>
<span id="cb21-173"><a href="#cb21-173"></a><span class="in">  |</span></span>
<span id="cb21-174"><a href="#cb21-174"></a><span class="in">  = note:  "cc" "-m64" "/tmp/rustceBlIYK/symbols.o" "&lt;1 object files omitted&gt;" "-Wl,--as-needed" "-Wl,-Bstatic" "&lt;sysroot&gt;/lib/rustlib/x86_64-unknown-linux-gnu/lib/{librustc_std_workspace_core-*,libcore-*,libcompiler_builtins-*}.rlib" "-L" "/tmp/rustceBlIYK/raw-dylibs" "-Wl,-Bdynamic" "-Wl,--eh-frame-hdr" "-Wl,-z,noexecstack" "-L" "&lt;sysroot&gt;/lib/rustlib/x86_64-unknown-linux-gnu/lib" "-o" "main" "-Wl,--gc-sections" "-pie" "-Wl,-z,relro,-z,now" "-nodefaultlibs"</span></span>
<span id="cb21-175"><a href="#cb21-175"></a><span class="in">  = note: some arguments are omitted. use `--verbose` to show all linker arguments</span></span>
<span id="cb21-176"><a href="#cb21-176"></a><span class="in">  = note: /usr/bin/ld: main.main.5f6bf0c8e9d0afce-cgu.0.rcgu.o: in function `_start':</span></span>
<span id="cb21-177"><a href="#cb21-177"></a><span class="in">          main.5f6bf0c8e9d0afce-cgu.0:(.text._start+0x0): multiple definition of `_start'; /usr/lib/gcc/x86_64-linux-gnu/11/../../../x86_64-linux-gnu/Scrt1.o:(.text+0x0): first defined here</span></span>
<span id="cb21-178"><a href="#cb21-178"></a><span class="in">          /usr/bin/ld: /usr/lib/gcc/x86_64-linux-gnu/11/../../../x86_64-linux-gnu/Scrt1.o: in function `_start':</span></span>
<span id="cb21-179"><a href="#cb21-179"></a><span class="in">          (.text+0x1b): undefined reference to `main'</span></span>
<span id="cb21-180"><a href="#cb21-180"></a><span class="in">          /usr/bin/ld: (.text+0x21): undefined reference to `__libc_start_main'</span></span>
<span id="cb21-181"><a href="#cb21-181"></a><span class="in">          collect2: error: ld returned 1 exit status</span></span>
<span id="cb21-182"><a href="#cb21-182"></a></span>
<span id="cb21-183"><a href="#cb21-183"></a><span class="in">  = note: some `extern` functions couldn't be found; some native libraries may need to be installed or have their path specified</span></span>
<span id="cb21-184"><a href="#cb21-184"></a><span class="in">  = note: use the `-l` flag to specify native libraries to link</span></span>
<span id="cb21-185"><a href="#cb21-185"></a></span>
<span id="cb21-186"><a href="#cb21-186"></a><span class="in">error: aborting due to 1 previous error</span></span>
<span id="cb21-187"><a href="#cb21-187"></a><span class="in">```</span></span>
<span id="cb21-188"><a href="#cb21-188"></a></span>
<span id="cb21-189"><a href="#cb21-189"></a><span class="ss">- </span>Ah hah! A linker error! Just as we hoped.</span>
<span id="cb21-190"><a href="#cb21-190"></a></span>
<span id="cb21-191"><a href="#cb21-191"></a><span class="fu">## `-T`</span></span>
<span id="cb21-192"><a href="#cb21-192"></a></span>
<span id="cb21-193"><a href="#cb21-193"></a><span class="ss">- </span>The linker complains it's missing something, and it's not sure what.</span>
<span id="cb21-194"><a href="#cb21-194"></a><span class="ss">- </span>We are sure, it's the <span class="in">`.x`</span> files.</span>
<span id="cb21-195"><a href="#cb21-195"></a><span class="ss">- </span>To furnish a file by name to the linker, we provide it as a <span class="in">`link-arg`</span> prefixed with <span class="in">`-T`</span></span>
<span id="cb21-196"><a href="#cb21-196"></a></span>
<span id="cb21-197"><a href="#cb21-197"></a><span class="in">```{.email}</span></span>
<span id="cb21-198"><a href="#cb21-198"></a><span class="in">link-arg=-Tlink.x</span></span>
<span id="cb21-199"><a href="#cb21-199"></a><span class="in">```</span></span>
<span id="cb21-200"><a href="#cb21-200"></a></span>
<span id="cb21-201"><a href="#cb21-201"></a><span class="ss">- </span>If you link both <span class="in">`.x`</span> files, you will get a different error message.</span>
<span id="cb21-202"><a href="#cb21-202"></a></span>
<span id="cb21-203"><a href="#cb21-203"></a><span class="in">```{.sh}</span></span>
<span id="cb21-204"><a href="#cb21-204"></a><span class="in">$ rustc -C link-args=-Tmemory.x -C link-args=-Tlink.x -C panic=abort src/main.rs</span></span>
<span id="cb21-205"><a href="#cb21-205"></a><span class="in">error: linking with `cc` failed: exit status: 1</span></span>
<span id="cb21-206"><a href="#cb21-206"></a><span class="in">  |</span></span>
<span id="cb21-207"><a href="#cb21-207"></a><span class="in">  = note:  "cc" "-m64" "/tmp/rustczhisJl/symbols.o" "&lt;1 object files omitted&gt;" "-Wl,--as-needed" "-Wl,-Bstatic" "&lt;sysroot&gt;/lib/rustlib/x86_64-unknown-linux-gnu/lib/{librustc_std_workspace_core-*,libcore-*,libcompiler_builtins-*}.rlib" "-L" "/tmp/rustczhisJl/raw-dylibs" "-Wl,-Bdynamic" "-Wl,--eh-frame-hdr" "-Wl,-z,noexecstack" "-L" "&lt;sysroot&gt;/lib/rustlib/x86_64-unknown-linux-gnu/lib" "-o" "main" "-Wl,--gc-sections" "-pie" "-Wl,-z,relro,-z,now" "-nodefaultlibs" "-Tmemory.x" "-Tlink.x"</span></span>
<span id="cb21-208"><a href="#cb21-208"></a><span class="in">  = note: some arguments are omitted. use `--verbose` to show all linker arguments</span></span>
<span id="cb21-209"><a href="#cb21-209"></a><span class="in">  = note: /usr/bin/ld: main.main.5f6bf0c8e9d0afce-cgu.0.rcgu.o: in function `_start':</span></span>
<span id="cb21-210"><a href="#cb21-210"></a><span class="in">          main.5f6bf0c8e9d0afce-cgu.0:(.text._start+0x0): multiple definition of `_start'; /usr/lib/gcc/x86_64-linux-gnu/11/../../../x86_64-linux-gnu/Scrt1.o:(.text+0x0): first defined here</span></span>
<span id="cb21-211"><a href="#cb21-211"></a><span class="in">          /usr/bin/ld:</span></span>
<span id="cb21-212"><a href="#cb21-212"></a><span class="in">          .got section detected in the input files. Dynamic relocations are not</span></span>
<span id="cb21-213"><a href="#cb21-213"></a><span class="in">          supported. If you are linking to C code compiled using the `gcc` crate</span></span>
<span id="cb21-214"><a href="#cb21-214"></a><span class="in">          then modify your build script to compile the C code _without_ the</span></span>
<span id="cb21-215"><a href="#cb21-215"></a><span class="in">          -fPIC flag. See the documentation of the `gcc::Config.fpic` method for</span></span>
<span id="cb21-216"><a href="#cb21-216"></a><span class="in">          details.</span></span>
<span id="cb21-217"><a href="#cb21-217"></a><span class="in">          /usr/lib/gcc/x86_64-linux-gnu/11/../../../x86_64-linux-gnu/crti.o: in function `_init':</span></span>
<span id="cb21-218"><a href="#cb21-218"></a><span class="in">          (.init+0xb): relocation truncated to fit: R_X86_64_REX_GOTPCRELX against undefined symbol `__gmon_start__'</span></span>
<span id="cb21-219"><a href="#cb21-219"></a><span class="in">          collect2: error: ld returned 1 exit status</span></span>
<span id="cb21-220"><a href="#cb21-220"></a></span>
<span id="cb21-221"><a href="#cb21-221"></a></span>
<span id="cb21-222"><a href="#cb21-222"></a><span class="in">error: aborting due to 1 previous error</span></span>
<span id="cb21-223"><a href="#cb21-223"></a><span class="in">```</span></span>
<span id="cb21-224"><a href="#cb21-224"></a></span>
<span id="cb21-225"><a href="#cb21-225"></a><span class="fu">## RISC-V</span></span>
<span id="cb21-226"><a href="#cb21-226"></a></span>
<span id="cb21-227"><a href="#cb21-227"></a><span class="ss">- </span>RISC-V is what it would be like if hardware were good.</span>
<span id="cb21-228"><a href="#cb21-228"></a><span class="ss">    - </span>By which I mean open-source.</span>
<span id="cb21-229"><a href="#cb21-229"></a></span>
<span id="cb21-230"><a href="#cb21-230"></a>| |Good (Open Source)|Bad (Not)|</span>
<span id="cb21-231"><a href="#cb21-231"></a>|-|-|</span>
<span id="cb21-232"><a href="#cb21-232"></a>|Windows  ||x|  </span>
<span id="cb21-233"><a href="#cb21-233"></a>|Linux|x||  </span>
<span id="cb21-234"><a href="#cb21-234"></a>|ICC (Intel C Compiler)||x|</span>
<span id="cb21-235"><a href="#cb21-235"></a>|GCC        |x||</span>
<span id="cb21-236"><a href="#cb21-236"></a>|x86-64||x|</span>
<span id="cb21-237"><a href="#cb21-237"></a>|ARM64||x|</span>
<span id="cb21-238"><a href="#cb21-238"></a>|RISC-V |x||</span>
<span id="cb21-239"><a href="#cb21-239"></a></span>
<span id="cb21-240"><a href="#cb21-240"></a><span class="at">&gt; </span><span class="co">[</span><span class="ot">RISC-V (pronounced "risk-five"): 1  is a free and open standard instruction set architecture (ISA) based on reduced instruction set computer (RISC) principles. Unlike proprietary ISAs such as x86 and ARM, RISC-V is described as "free and open" because its specifications are released under permissive open-source licenses and can be implemented without paying royalties.</span><span class="co">](https://en.wikipedia.org/wiki/RISC-V)</span></span>
<span id="cb21-241"><a href="#cb21-241"></a></span>
<span id="cb21-242"><a href="#cb21-242"></a><span class="at">&gt; </span><span class="co">[</span><span class="ot">The RISC-V instruction set architecture (ISA) offers a highly customizable open standard platform, enabling developers to build, port, and optimize software applications, extensions, and hardware. Its simplicity and modularity enables efficient design and optimization, fostering innovation and reducing development time and cost.</span><span class="co">](https://riscv.org/)</span></span>
<span id="cb21-243"><a href="#cb21-243"></a></span>
<span id="cb21-244"><a href="#cb21-244"></a><span class="ss">- </span>Also unlike x86 and ARM, it is easy to develop for RISC-V, and that is what we've done.</span>
<span id="cb21-245"><a href="#cb21-245"></a></span>
<span id="cb21-246"><a href="#cb21-246"></a><span class="in">```{.sh}</span></span>
<span id="cb21-247"><a href="#cb21-247"></a><span class="in">$ grep riscv link.x</span></span>
<span id="cb21-248"><a href="#cb21-248"></a><span class="in">  By default uses the riscv crates default trap handler</span></span>
<span id="cb21-249"><a href="#cb21-249"></a><span class="in">ERROR(riscv-rt): the start of the REGION_TEXT must be 4-byte aligned");</span></span>
<span id="cb21-250"><a href="#cb21-250"></a><span class="in">ERROR(riscv-rt): the start of the REGION_RODATA must be 4-byte aligned");</span></span>
<span id="cb21-251"><a href="#cb21-251"></a><span class="in">ERROR(riscv-rt): the start of the REGION_DATA must be 4-byte aligned");</span></span>
<span id="cb21-252"><a href="#cb21-252"></a><span class="in">ERROR(riscv-rt): the start of the REGION_HEAP must be 4-byte aligned");</span></span>
<span id="cb21-253"><a href="#cb21-253"></a><span class="in">ERROR(riscv-rt): the start of the REGION_TEXT must be 4-byte aligned");</span></span>
<span id="cb21-254"><a href="#cb21-254"></a><span class="in">ERROR(riscv-rt): the start of the REGION_STACK must be 4-byte aligned");</span></span>
<span id="cb21-255"><a href="#cb21-255"></a><span class="in">ERROR(riscv-rt): `_stext` must be 4-byte aligned");</span></span>
<span id="cb21-256"><a href="#cb21-256"></a><span class="in">BUG(riscv-rt): .data is not 4-byte aligned");</span></span>
<span id="cb21-257"><a href="#cb21-257"></a><span class="in">BUG(riscv-rt): the LMA of .data is not 4-byte aligned");</span></span>
<span id="cb21-258"><a href="#cb21-258"></a><span class="in">BUG(riscv-rt): .bss is not 4-byte aligned");</span></span>
<span id="cb21-259"><a href="#cb21-259"></a><span class="in">BUG(riscv-rt): start of .heap is not 4-byte aligned");</span></span>
<span id="cb21-260"><a href="#cb21-260"></a><span class="in">ERROR(riscv-rt): The .text section must be placed inside the REGION_TEXT region.</span></span>
<span id="cb21-261"><a href="#cb21-261"></a><span class="in">ERROR(riscv-rt): .stack section is too small for allocating stacks for all the harts.</span></span>
<span id="cb21-262"><a href="#cb21-262"></a><span class="in">```</span></span>
<span id="cb21-263"><a href="#cb21-263"></a></span>
<span id="cb21-264"><a href="#cb21-264"></a><span class="ss">- </span>By golly, our <span class="in">`.x`</span> files are for RISC-V!</span>
<span id="cb21-265"><a href="#cb21-265"></a><span class="ss">    - </span>And therefore *good*.</span>
<span id="cb21-266"><a href="#cb21-266"></a>    </span>
<span id="cb21-267"><a href="#cb21-267"></a><span class="fu">## Target</span></span>
<span id="cb21-268"><a href="#cb21-268"></a></span>
<span id="cb21-269"><a href="#cb21-269"></a><span class="ss">- </span>We recall the notion of a *target triple*</span>
<span id="cb21-270"><a href="#cb21-270"></a><span class="ss">    - </span>From the <span class="co">[</span><span class="ot">linker lab</span><span class="co">](31_linker.md#target-triple)</span></span>
<span id="cb21-271"><a href="#cb21-271"></a><span class="ss">- </span>We note:</span>
<span id="cb21-272"><a href="#cb21-272"></a><span class="ss">    - </span>There are references to x86 (in my case) in the error logs.</span>
<span id="cb21-273"><a href="#cb21-273"></a><span class="ss">    - </span>There are references to RISC-V in the linker files.</span>
<span id="cb21-274"><a href="#cb21-274"></a><span class="ss">    - </span>We have to pick one, and...</span>
<span id="cb21-275"><a href="#cb21-275"></a><span class="ss">    - </span>I didn't provide appropriate linker files for x86</span>
<span id="cb21-276"><a href="#cb21-276"></a><span class="ss">        - </span>Because it's bad!</span>
<span id="cb21-277"><a href="#cb21-277"></a><span class="ss">- </span>You will additionlly need to specify a target.</span>
<span id="cb21-278"><a href="#cb21-278"></a><span class="ss">- </span><span class="in">`riscv64imac-unknown-none-elf`</span></span>
<span id="cb21-279"><a href="#cb21-279"></a><span class="ss">- </span>You will figure it out.</span>
<span id="cb21-280"><a href="#cb21-280"></a><span class="ss">    - </span>And you will know when you have, because you will see *no errors* and a <span class="in">`main`</span> will have appeared.</span>
<span id="cb21-281"><a href="#cb21-281"></a>    </span>
<span id="cb21-282"><a href="#cb21-282"></a><span class="fu">## Main</span></span>
<span id="cb21-283"><a href="#cb21-283"></a></span>
<span id="cb21-284"><a href="#cb21-284"></a><span class="ss">- </span>Go ahead and run <span class="in">`main`</span>, what could go wrong.</span>
<span id="cb21-285"><a href="#cb21-285"></a></span>
<span id="cb21-286"><a href="#cb21-286"></a><span class="in">```{.sh}</span></span>
<span id="cb21-287"><a href="#cb21-287"></a><span class="in">$ ./main</span></span>
<span id="cb21-288"><a href="#cb21-288"></a><span class="in">-bash: ./main: cannot execute binary file: Exec format error</span></span>
<span id="cb21-289"><a href="#cb21-289"></a><span class="in">```</span></span>
<span id="cb21-290"><a href="#cb21-290"></a></span>
<span id="cb21-291"><a href="#cb21-291"></a><span class="ss">- </span>If, like me, you foolish use an architecture other than RISC-V as your daily driver (that's a metaphor, not a reference to device drivers), <span class="in">`main`</span> won't work on your system.</span>
<span id="cb21-292"><a href="#cb21-292"></a></span>
<span id="cb21-293"><a href="#cb21-293"></a><span class="fu">## QEMU</span></span>
<span id="cb21-294"><a href="#cb21-294"></a></span>
<span id="cb21-295"><a href="#cb21-295"></a><span class="ss">- </span>Well, it will, you just have to bamboozle your system into pretending to be a *good* system, like RISC-V</span>
<span id="cb21-296"><a href="#cb21-296"></a></span>
<span id="cb21-297"><a href="#cb21-297"></a><span class="in">```{.sh}</span></span>
<span id="cb21-298"><a href="#cb21-298"></a><span class="in">sudo apt install qemu-system-misc</span></span>
<span id="cb21-299"><a href="#cb21-299"></a><span class="in">```</span></span>
<span id="cb21-300"><a href="#cb21-300"></a></span>
<span id="cb21-301"><a href="#cb21-301"></a><span class="ss">- </span>We don't allow our feelings to be hurt by RISC-V being described as "miscellaneous". </span>
<span id="cb21-302"><a href="#cb21-302"></a><span class="ss">    - </span>I didn't properly sandbox my system before debugging so I think this is all you need but I may be wrong if I lost a dependency somewhere.</span>
<span id="cb21-303"><a href="#cb21-303"></a></span>
<span id="cb21-304"><a href="#cb21-304"></a><span class="fu">## Run QEMU</span></span>
<span id="cb21-305"><a href="#cb21-305"></a></span>
<span id="cb21-306"><a href="#cb21-306"></a><span class="ss">- </span>You can simply launch <span class="in">`qemu`</span> with no strings attached.</span>
<span id="cb21-307"><a href="#cb21-307"></a></span>
<span id="cb21-308"><a href="#cb21-308"></a><span class="in">```{.sh}</span></span>
<span id="cb21-309"><a href="#cb21-309"></a><span class="in">qemu-system-riscv64</span></span>
<span id="cb21-310"><a href="#cb21-310"></a><span class="in">```</span></span>
<span id="cb21-311"><a href="#cb21-311"></a></span>
<span id="cb21-312"><a href="#cb21-312"></a><span class="ss">- </span>For me this popped open a new window.</span>
<span id="cb21-313"><a href="#cb21-313"></a><span class="ss">    - </span>This is good, as otherwise you have to deal with processes and I don't have time to teach that.</span>
<span id="cb21-314"><a href="#cb21-314"></a><span class="ss">    - </span>If you type "quit" after the prompt of <span class="in">`(qemu)`</span> it should close.</span>
<span id="cb21-315"><a href="#cb21-315"></a></span>
<span id="cb21-316"><a href="#cb21-316"></a><span class="fu">## Run main</span></span>
<span id="cb21-317"><a href="#cb21-317"></a></span>
<span id="cb21-318"><a href="#cb21-318"></a><span class="ss">- </span>You can specify that you totally wrote a working OS, honest, by providing <span class="in">`qemu`</span> with a specified kernel, like our <span class="in">`main`</span></span>
<span id="cb21-319"><a href="#cb21-319"></a></span>
<span id="cb21-320"><a href="#cb21-320"></a><span class="in">```{.sh}</span></span>
<span id="cb21-321"><a href="#cb21-321"></a><span class="in">qemu-system-riscv64 -kernel main</span></span>
<span id="cb21-322"><a href="#cb21-322"></a><span class="in">```</span></span>
<span id="cb21-323"><a href="#cb21-323"></a></span>
<span id="cb21-324"><a href="#cb21-324"></a>::: {.callout-note appearance="simple"}</span>
<span id="cb21-325"><a href="#cb21-325"></a></span>
<span id="cb21-326"><a href="#cb21-326"></a><span class="fu">## Forward Pointer</span></span>
<span id="cb21-327"><a href="#cb21-327"></a></span>
<span id="cb21-328"><a href="#cb21-328"></a>We will properly introduce kernels in the next lecture.</span>
<span id="cb21-329"><a href="#cb21-329"></a></span>
<span id="cb21-330"><a href="#cb21-330"></a>:::</span>
<span id="cb21-331"><a href="#cb21-331"></a></span>
<span id="cb21-332"><a href="#cb21-332"></a></span>
<span id="cb21-333"><a href="#cb21-333"></a><span class="ss">- </span>This will probably work.</span>
<span id="cb21-334"><a href="#cb21-334"></a></span>
<span id="cb21-335"><a href="#cb21-335"></a><span class="in">```{.sh}</span></span>
<span id="cb21-336"><a href="#cb21-336"></a><span class="in">$ qemu-system-riscv64 -kernel main</span></span>
<span id="cb21-337"><a href="#cb21-337"></a><span class="in">qemu-system-riscv64: Some ROM regions are overlapping</span></span>
<span id="cb21-338"><a href="#cb21-338"></a><span class="in">These ROM regions might have been loaded by direct user request or by default.</span></span>
<span id="cb21-339"><a href="#cb21-339"></a><span class="in">They could be BIOS/firmware images, a guest kernel, initrd or some other file loaded into guest memory.</span></span>
<span id="cb21-340"><a href="#cb21-340"></a><span class="in">Check whether you intended to load all this guest code, and whether it has been built to load to the correct addresses.</span></span>
<span id="cb21-341"><a href="#cb21-341"></a></span>
<span id="cb21-342"><a href="#cb21-342"></a><span class="in">The following two regions overlap (in the memory address space):</span></span>
<span id="cb21-343"><a href="#cb21-343"></a><span class="in">  /usr/share/qemu/opensbi-riscv64-generic-fw_dynamic.elf ELF program header segment 1 (addresses 0x0000000080000000 - 0x0000000080016ce8)</span></span>
<span id="cb21-344"><a href="#cb21-344"></a><span class="in">  main ELF program header segment 0 (addresses 0x0000000080000000 - 0x0000000080000004)</span></span>
<span id="cb21-345"><a href="#cb21-345"></a><span class="in">```</span></span>
<span id="cb21-346"><a href="#cb21-346"></a></span>
<span id="cb21-347"><a href="#cb21-347"></a><span class="ss">- </span>And by probably I mean with a probability of zero.</span>
<span id="cb21-348"><a href="#cb21-348"></a></span>
<span id="cb21-349"><a href="#cb21-349"></a><span class="fu">## BIOS</span></span>
<span id="cb21-350"><a href="#cb21-350"></a></span>
<span id="cb21-351"><a href="#cb21-351"></a><span class="ss">- </span>The BIOS can be thought of as a tiny bit of read-only memory (ROM) that lives on a computer.</span>
<span id="cb21-352"><a href="#cb21-352"></a><span class="ss">- </span>When the computer first turns on, it immediately begins reading instructions from the BIOS (presumably over the bus, or through some other means).</span>
<span id="cb21-353"><a href="#cb21-353"></a><span class="ss">- </span>The BIOS will then instruct the device how to procede.</span>
<span id="cb21-354"><a href="#cb21-354"></a><span class="ss">- </span>We don't need any of that, we already wrote an infinite loop and can just start there!</span>
<span id="cb21-355"><a href="#cb21-355"></a></span>
<span id="cb21-356"><a href="#cb21-356"></a><span class="in">```{.sh}</span></span>
<span id="cb21-357"><a href="#cb21-357"></a><span class="in">qemu-system-riscv64 -kernel main -bios none</span></span>
<span id="cb21-358"><a href="#cb21-358"></a><span class="in">```</span></span>
<span id="cb21-359"><a href="#cb21-359"></a></span>
<span id="cb21-360"><a href="#cb21-360"></a><span class="at">&gt; </span><span class="co">[</span><span class="ot">In computing, BIOS (Basic Input/Output System, also known as the System BIOS, ROM BIOS, BIOS ROM or PC BIOS) is a type of firmware used to provide runtime services for operating systems and programs and to perform hardware initialization during the booting process (power-on startup). On a computer using BIOS firmware, the firmware comes pre-installed on the computer's motherboard.</span><span class="co">](https://en.wikipedia.org/wiki/BIOS)</span></span>
<span id="cb21-361"><a href="#cb21-361"></a></span>
<span id="cb21-362"><a href="#cb21-362"></a><span class="fu"># Fin</span></span>
<span id="cb21-363"><a href="#cb21-363"></a></span>
<span id="cb21-364"><a href="#cb21-364"></a>For me that worked, hopefully for you too! If not, you have officially entered the fun zone.</span>
<span id="cb21-365"><a href="#cb21-365"></a></span>
<span id="cb21-366"><a href="#cb21-366"></a><span class="fu">## TODO</span></span>
<span id="cb21-367"><a href="#cb21-367"></a></span>
<span id="cb21-368"><a href="#cb21-368"></a>For this homework, add a README.md to the crate describing how to get it to work.</span>
<span id="cb21-369"><a href="#cb21-369"></a></span>
<span id="cb21-370"><a href="#cb21-370"></a><span class="ss">- </span>It should be like this document, but concise.</span>
<span id="cb21-371"><a href="#cb21-371"></a><span class="ss">- </span>Use cool markdown checkboxes.</span>
<span id="cb21-372"><a href="#cb21-372"></a></span>
<span id="cb21-373"><a href="#cb21-373"></a><span class="in">```md</span></span>
<span id="cb21-374"><a href="#cb21-374"></a><span class="ss">- </span><span class="va">[ ]</span> Do a thing.</span>
<span id="cb21-375"><a href="#cb21-375"></a><span class="ss">- </span><span class="va">[ ]</span> Do another thing.</span>
<span id="cb21-376"><a href="#cb21-376"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>