<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.30">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Test – OS in Rust</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./52_graphics.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-a4a11d514c7d463668e07712114998e6.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-fc9c1a4fc1048689359919db0170c3de.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./60_test.html">Test</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">OS in Rust</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./00_derust.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Derust</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_wc.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">wc</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_cli.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">CLI</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11_unsafe.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Unsafe</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12_split_at.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Splits</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./20_os.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">OS</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./21_xmute.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Transmute</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./22_malloc.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">malloc</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./30_metal.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bare Metal</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./31_linker.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Linker</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./32_r5.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">RISC-V</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./40_kernel.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Kernel</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./41_boot.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Boot</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./42_hello.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Hello</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./50_text.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Text</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./51_format.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Format</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./52_graphics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Graphics</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./60_test.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Test</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#announcements" id="toc-announcements" class="nav-link active" data-scroll-target="#announcements">Announcements</a></li>
  <li><a href="#citations" id="toc-citations" class="nav-link" data-scroll-target="#citations">Citations</a></li>
  <li><a href="#today" id="toc-today" class="nav-link" data-scroll-target="#today">Today</a></li>
  <li><a href="#pre-work" id="toc-pre-work" class="nav-link" data-scroll-target="#pre-work">Pre-work</a></li>
  <li><a href="#modern-language" id="toc-modern-language" class="nav-link" data-scroll-target="#modern-language">Modern Language</a></li>
  <li><a href="#framework" id="toc-framework" class="nav-link" data-scroll-target="#framework">Framework</a></li>
  <li><a href="#review" id="toc-review" class="nav-link" data-scroll-target="#review">Review</a></li>
  <li><a href="#enable" id="toc-enable" class="nav-link" data-scroll-target="#enable">Enable</a></li>
  <li><a href="#on-bin" id="toc-on-bin" class="nav-link" data-scroll-target="#on-bin">On <code>[[bin]]</code></a></li>
  <li><a href="#working-within-no_std" id="toc-working-within-no_std" class="nav-link" data-scroll-target="#working-within-no_std">Working within <code>no_std</code></a></li>
  <li><a href="#what-we-lose" id="toc-what-we-lose" class="nav-link" data-scroll-target="#what-we-lose">What We Lose</a></li>
  <li><a href="#to-main" id="toc-to-main" class="nav-link" data-scroll-target="#to-main">To Main</a></li>
  <li><a href="#just-a-note" id="toc-just-a-note" class="nav-link" data-scroll-target="#just-a-note">Just a note</a></li>
  <li><a href="#todays-starting-point" id="toc-todays-starting-point" class="nav-link" data-scroll-target="#todays-starting-point">Today’s Starting Point</a></li>
  <li><a href="#adding-to-main" id="toc-adding-to-main" class="nav-link" data-scroll-target="#adding-to-main">Adding to Main</a></li>
  <li><a href="#wait-a-minute" id="toc-wait-a-minute" class="nav-link" data-scroll-target="#wait-a-minute">Wait a minute</a></li>
  <li><a href="#dynamic-dispatch" id="toc-dynamic-dispatch" class="nav-link" data-scroll-target="#dynamic-dispatch">Dynamic Dispatch</a></li>
  <li><a href="#oop" id="toc-oop" class="nav-link" data-scroll-target="#oop">OOP</a></li>
  <li><a href="#write-two-functions" id="toc-write-two-functions" class="nav-link" data-scroll-target="#write-two-functions">Write Two Functions</a></li>
  <li><a href="#make-an-array" id="toc-make-an-array" class="nav-link" data-scroll-target="#make-an-array">Make an array</a></li>
  <li><a href="#loop-over-the-array" id="toc-loop-over-the-array" class="nav-link" data-scroll-target="#loop-over-the-array">Loop over the array</a></li>
  <li><a href="#call-each-function" id="toc-call-each-function" class="nav-link" data-scroll-target="#call-each-function">Call each function</a></li>
  <li><a href="#sample-out" id="toc-sample-out" class="nav-link" data-scroll-target="#sample-out">Sample out</a></li>
  <li><a href="#aside-bits" id="toc-aside-bits" class="nav-link" data-scroll-target="#aside-bits">Aside: Bits</a>
  <ul class="collapse">
  <li><a href="#pulling-back-the-curtain" id="toc-pulling-back-the-curtain" class="nav-link" data-scroll-target="#pulling-back-the-curtain">Pulling back the curtain</a></li>
  <li><a href="#its-tiny" id="toc-its-tiny" class="nav-link" data-scroll-target="#its-tiny">It’s tiny!</a></li>
  <li><a href="#to-html" id="toc-to-html" class="nav-link" data-scroll-target="#to-html">To HTML</a></li>
  <li><a href="#here-it-is" id="toc-here-it-is" class="nav-link" data-scroll-target="#here-it-is">Here it is</a></li>
  <li><a href="#by-the-way" id="toc-by-the-way" class="nav-link" data-scroll-target="#by-the-way">By the way</a></li>
  <li><a href="#wait-just-kidding" id="toc-wait-just-kidding" class="nav-link" data-scroll-target="#wait-just-kidding">Wait Just Kidding</a></li>
  <li><a href="#quote-me" id="toc-quote-me" class="nav-link" data-scroll-target="#quote-me">Quote Me</a></li>
  </ul></li>
  <li><a href="#back-to-work" id="toc-back-to-work" class="nav-link" data-scroll-target="#back-to-work">Back to Work</a>
  <ul class="collapse">
  <li><a href="#recall" id="toc-recall" class="nav-link" data-scroll-target="#recall">Recall</a></li>
  <li><a href="#outsmart-rust" id="toc-outsmart-rust" class="nav-link" data-scroll-target="#outsmart-rust">Outsmart Rust</a></li>
  <li><a href="#check-it" id="toc-check-it" class="nav-link" data-scroll-target="#check-it">Check it</a></li>
  </ul></li>
  <li><a href="#aside-nightly" id="toc-aside-nightly" class="nav-link" data-scroll-target="#aside-nightly">Aside: Nightly</a>
  <ul class="collapse">
  <li><a href="#back-to-stack" id="toc-back-to-stack" class="nav-link" data-scroll-target="#back-to-stack">Back to Stack</a></li>
  <li><a href="#it-states" id="toc-it-states" class="nav-link" data-scroll-target="#it-states">It states</a></li>
  <li><a href="#what-i-see" id="toc-what-i-see" class="nav-link" data-scroll-target="#what-i-see">What I see</a></li>
  <li><a href="#the-other-way" id="toc-the-other-way" class="nav-link" data-scroll-target="#the-other-way">The other way</a></li>
  </ul></li>
  <li><a href="#back-to-work-1" id="toc-back-to-work-1" class="nav-link" data-scroll-target="#back-to-work-1">Back to Work</a>
  <ul class="collapse">
  <li><a href="#recall-1" id="toc-recall-1" class="nav-link" data-scroll-target="#recall-1">Recall</a></li>
  <li><a href="#surprise" id="toc-surprise" class="nav-link" data-scroll-target="#surprise">Surprise!</a></li>
  <li><a href="#the-problem" id="toc-the-problem" class="nav-link" data-scroll-target="#the-problem">The Problem</a></li>
  <li><a href="#maybe-problem" id="toc-maybe-problem" class="nav-link" data-scroll-target="#maybe-problem">Maybe problem</a></li>
  <li><a href="#fine-ill-do-it-myself" id="toc-fine-ill-do-it-myself" class="nav-link" data-scroll-target="#fine-ill-do-it-myself">Fine, I’ll do it myself</a></li>
  <li><a href="#only-problem" id="toc-only-problem" class="nav-link" data-scroll-target="#only-problem">Only problem</a></li>
  <li><a href="#conditional-compilation" id="toc-conditional-compilation" class="nav-link" data-scroll-target="#conditional-compilation">Conditional Compilation</a></li>
  <li><a href="#only-problem-1" id="toc-only-problem-1" class="nav-link" data-scroll-target="#only-problem-1">Only problem</a></li>
  <li><a href="#correct-way" id="toc-correct-way" class="nav-link" data-scroll-target="#correct-way">Correct Way</a></li>
  <li><a href="#todo" id="toc-todo" class="nav-link" data-scroll-target="#todo">Todo</a></li>
  <li><a href="#exiting-qemu" id="toc-exiting-qemu" class="nav-link" data-scroll-target="#exiting-qemu">Exiting QEMU</a>
  <ul class="collapse">
  <li><a href="#io-ports" id="toc-io-ports" class="nav-link" data-scroll-target="#io-ports">I/O Ports</a></li>
  <li><a href="#using-the-exit-device" id="toc-using-the-exit-device" class="nav-link" data-scroll-target="#using-the-exit-device">Using the Exit Device</a></li>
  <li><a href="#success-exit-code" id="toc-success-exit-code" class="nav-link" data-scroll-target="#success-exit-code">Success Exit Code</a></li>
  </ul></li>
  <li><a href="#printing-to-the-console" id="toc-printing-to-the-console" class="nav-link" data-scroll-target="#printing-to-the-console">Printing to the Console</a>
  <ul class="collapse">
  <li><a href="#serial-port" id="toc-serial-port" class="nav-link" data-scroll-target="#serial-port">Serial Port</a></li>
  <li><a href="#qemu-arguments" id="toc-qemu-arguments" class="nav-link" data-scroll-target="#qemu-arguments">QEMU Arguments</a></li>
  <li><a href="#print-an-error-message-on-panic" id="toc-print-an-error-message-on-panic" class="nav-link" data-scroll-target="#print-an-error-message-on-panic">Print an Error Message on Panic</a></li>
  <li><a href="#hiding-qemu" id="toc-hiding-qemu" class="nav-link" data-scroll-target="#hiding-qemu">Hiding QEMU</a></li>
  <li><a href="#timeouts" id="toc-timeouts" class="nav-link" data-scroll-target="#timeouts">Timeouts</a></li>
  <li><a href="#insert-printing-automatically" id="toc-insert-printing-automatically" class="nav-link" data-scroll-target="#insert-printing-automatically">Insert Printing Automatically</a></li>
  </ul></li>
  <li><a href="#testing-the-vga-buffer" id="toc-testing-the-vga-buffer" class="nav-link" data-scroll-target="#testing-the-vga-buffer">Testing the VGA Buffer</a></li>
  <li><a href="#integration-tests" id="toc-integration-tests" class="nav-link" data-scroll-target="#integration-tests">Integration Tests</a>
  <ul class="collapse">
  <li><a href="#create-a-library" id="toc-create-a-library" class="nav-link" data-scroll-target="#create-a-library">Create a Library</a></li>
  <li><a href="#completing-the-integration-test" id="toc-completing-the-integration-test" class="nav-link" data-scroll-target="#completing-the-integration-test">Completing the Integration Test</a></li>
  <li><a href="#future-tests" id="toc-future-tests" class="nav-link" data-scroll-target="#future-tests">Future Tests</a></li>
  <li><a href="#tests-that-should-panic" id="toc-tests-that-should-panic" class="nav-link" data-scroll-target="#tests-that-should-panic">Tests that Should Panic</a></li>
  <li><a href="#no-harness-tests" id="toc-no-harness-tests" class="nav-link" data-scroll-target="#no-harness-tests">No Harness Tests</a></li>
  </ul></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  <li><a href="#whats-next" id="toc-whats-next" class="nav-link" data-scroll-target="#whats-next">What’s next?</a></li>
  </ul></li>
  <li><a href="#fin" id="toc-fin" class="nav-link" data-scroll-target="#fin">Fin</a>
  <ul class="collapse">
  <li><a href="#timeout" id="toc-timeout" class="nav-link" data-scroll-target="#timeout">Timeout</a></li>
  </ul></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="60_test.rjs.html"><i class="bi bi-file-slides"></i>RevealJS</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Test</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i></button></div></div>
<p class="subtitle lead">OS in Rust</p>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="announcements" class="level2">
<h2 class="anchored" data-anchor-id="announcements">Announcements</h2>
<ul>
<li><strong>Action Items</strong>:
<ul>
<li>How is graphics?
<ul>
<li>Are you learning NumPy?</li>
<li>Anyone using CUDA?</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="citations" class="level2">
<h2 class="anchored" data-anchor-id="citations">Citations</h2>
<ul>
<li>I am geniunely convinced of the usefulness of automated testing when developing a system.</li>
<li>The most high profile case of this is the testing framework for <a href="https://cd-public.github.io/crypto/qmd/bigadd.html"><code>4096_t.c</code></a></li>
<li>Hard to persuade students of the usefulness of this on small class assignments.</li>
<li><span class="math inline">\(\therefore\)</span> I’ve never written anything of any reasonable size in Rust, so</li>
<li><a href="https://os.phil-opp.com/testing/">Testing</a></li>
</ul>
</section>
<section id="today" class="level2">
<h2 class="anchored" data-anchor-id="today">Today</h2>
<ul>
<li>Testing under <code>no_std</code></li>
<li>QEMU</li>
<li><code>bootimage</code>
<ul>
<li>Still not in love with this dependency, but we do what we can.</li>
</ul></li>
</ul>
</section>
<section id="pre-work" class="level2">
<h2 class="anchored" data-anchor-id="pre-work">Pre-work</h2>
<ul>
<li>Make sure you have a <code>.cargo/config.toml</code></li>
<li>No idea how you wouldn’t have one of these yet!</li>
<li>Just make sure you have it.</li>
</ul>
</section>
<section id="modern-language" class="level2">
<h2 class="anchored" data-anchor-id="modern-language">Modern Language</h2>
<ul>
<li>Like Python with Pytest, and unlike the only other systems language, Rust has a testing framework.</li>
<li>It’s covered in <a href="https://doc.rust-lang.org/book/ch11-00-testing.html">Rust book</a></li>
<li>Naturally I skipped this chapter.</li>
</ul>
</section>
<section id="framework" class="level2">
<h2 class="anchored" data-anchor-id="framework">Framework</h2>
<ul>
<li>Use the <code>#[test]</code> attribute on some functions.</li>
<li>Including <em>assertions</em> within those functions.</li>
<li><code>cargo test</code> or, if you see someone around, <code>cargo t</code>, will check the assertions.</li>
<li>The crate will otherwise be non-impacted.</li>
</ul>
</section>
<section id="review" class="level2">
<h2 class="anchored" data-anchor-id="review">Review</h2>
<ul>
<li>To enable testing for our kernel binary, we can set the <code>test</code> flag in the Cargo.toml to <code>true</code>.</li>
<li>We recall our <code>Cargo.toml</code> - mine no longer has an allusions to panic with the introduction of a JSON target.</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Cargo.toml</strong></pre>
</div>
<div class="sourceCode" id="cb1" data-filename="Cargo.toml"><pre class="sourceCode numberSource toml number-lines code-with-copy"><code class="sourceCode toml"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw">[package]</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="dt">name</span> <span class="op">=</span> <span class="st">"osirs"</span></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="dt">version</span> <span class="op">=</span> <span class="st">"0.1.0"</span></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="dt">edition</span> <span class="op">=</span> <span class="st">"2024"</span></span>
<span id="cb1-5"><a href="#cb1-5"></a></span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="kw">[dependencies]</span></span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="dt">bootloader</span> <span class="op">=</span> <span class="st">"0.9"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="enable" class="level2">
<h2 class="anchored" data-anchor-id="enable">Enable</h2>
<ul>
<li>This is necessary but not sufficient.</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Cargo.toml</strong></pre>
</div>
<div class="sourceCode" id="cb2" data-filename="Cargo.toml"><pre class="sourceCode numberSource toml number-lines code-with-copy"><code class="sourceCode toml"><span id="cb2-1"><a href="#cb2-1"></a><span class="kw">[package]</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="dt">name</span> <span class="op">=</span> <span class="st">"osirs"</span></span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="dt">version</span> <span class="op">=</span> <span class="st">"0.1.0"</span></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="dt">edition</span> <span class="op">=</span> <span class="st">"2024"</span></span>
<span id="cb2-5"><a href="#cb2-5"></a></span>
<span id="cb2-6"><a href="#cb2-6"></a><span class="kw">[dependencies]</span></span>
<span id="cb2-7"><a href="#cb2-7"></a><span class="dt">bootloader</span> <span class="op">=</span> <span class="st">"0.9"</span></span>
<span id="cb2-8"><a href="#cb2-8"></a></span>
<span id="cb2-9"><a href="#cb2-9"></a><span class="kw">[[bin]]</span></span>
<span id="cb2-10"><a href="#cb2-10"></a><span class="dt">name</span> <span class="op">=</span> <span class="st">"osirs"</span></span>
<span id="cb2-11"><a href="#cb2-11"></a><span class="dt">test</span> <span class="op">=</span> <span class="cn">true</span></span>
<span id="cb2-12"><a href="#cb2-12"></a><span class="dt">bench</span> <span class="op">=</span> <span class="cn">false</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="on-bin" class="level2">
<h2 class="anchored" data-anchor-id="on-bin">On <code>[[bin]]</code></h2>
<blockquote class="blockquote">
<p><a href="https://doc.rust-lang.org/cargo/reference/cargo-targets.html#configuring-a-target">The double-bracket sections like <code>[[bin]]</code> are array-of-table of TOML, which means you can write more than one <code>[[bin]]</code> section to make several executables in your crate.</a></p>
</blockquote>
<ul>
<li>Just one for us for now.</li>
</ul>
</section>
<section id="working-within-no_std" class="level2">
<h2 class="anchored" data-anchor-id="working-within-no_std">Working within <code>no_std</code></h2>
<ul>
<li>Testing is complicated by <code>no_std</code>.</li>
<li>Rust implicitly uses the <code>test</code> library, which depends on <code>std</code>
<ul>
<li><a href="https://doc.rust-lang.org/test/index.html">More on <code>test</code></a></li>
</ul></li>
</ul>
<div class="sourceCode" id="cb3"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1"></a><span class="ex">$</span> cargo t</span>
<span id="cb3-2"><a href="#cb3-2"></a>   <span class="ex">Compiling</span> bootloader v0.9.34</span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="va">error</span><span class="op">[</span>E0463<span class="op">]</span><span class="ex">:</span> can<span class="st">'t find crate for `core`</span></span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="st">  |</span></span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="st">  = note: the `x86_64-osirs` target may not be installed</span></span>
<span id="cb3-6"><a href="#cb3-6"></a><span class="st">  = help: consider downloading the target with `rustup target add x86_64-osirs`</span></span>
<span id="cb3-7"><a href="#cb3-7"></a></span>
<span id="cb3-8"><a href="#cb3-8"></a><span class="st">For more information about this error, try `rustc --explain E0463`.</span></span>
<span id="cb3-9"><a href="#cb3-9"></a><span class="st">error: could not compile `bootloader` (lib) due to 1 previous error</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="what-we-lose" class="level2">
<h2 class="anchored" data-anchor-id="what-we-lose">What We Lose</h2>
<ul>
<li>Vs. <code>std</code>, we lose e.g.&nbsp;<code>should_panic</code> tests.
<ul>
<li><a href="https://doc.rust-lang.org/book/ch11-01-writing-tests.html#checking-for-panics-with-should_panic">On those</a></li>
</ul></li>
<li>That’s okay, we are crafty (and wrote our own panic handler anyway).</li>
</ul>
</section>
<section id="to-main" class="level2">
<h2 class="anchored" data-anchor-id="to-main">To Main</h2>
<ul>
<li>My main looks like this:</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/main.rs</strong></pre>
</div>
<div class="sourceCode" id="cb4" data-filename="src/main.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb4-1"><a href="#cb4-1"></a><span class="at">#![</span>no_std<span class="at">]</span></span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="at">#![</span>no_main<span class="at">]</span></span>
<span id="cb4-3"><a href="#cb4-3"></a></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="kw">mod</span> colors<span class="op">;</span></span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="kw">mod</span> vga<span class="op">;</span></span>
<span id="cb4-6"><a href="#cb4-6"></a></span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="at">#[</span>panic_handler<span class="at">]</span></span>
<span id="cb4-8"><a href="#cb4-8"></a><span class="kw">fn</span> panic(info<span class="op">:</span> <span class="op">&amp;</span><span class="pp">core::panic::</span>PanicInfo) <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb4-9"><a href="#cb4-9"></a>    <span class="pp">println!</span>(<span class="st">"{}"</span><span class="op">,</span> info)<span class="op">;</span></span>
<span id="cb4-10"><a href="#cb4-10"></a>    <span class="cf">loop</span> <span class="op">{}</span></span>
<span id="cb4-11"><a href="#cb4-11"></a><span class="op">}</span></span>
<span id="cb4-12"><a href="#cb4-12"></a></span>
<span id="cb4-13"><a href="#cb4-13"></a><span class="at">#[</span><span class="kw">unsafe</span><span class="at">(</span>no_mangle<span class="at">)]</span></span>
<span id="cb4-14"><a href="#cb4-14"></a><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">"C"</span> <span class="kw">fn</span> _start() <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb4-15"><a href="#cb4-15"></a>    <span class="pp">colors::</span>colors()<span class="op">;</span></span>
<span id="cb4-16"><a href="#cb4-16"></a>    <span class="pp">colors::</span>image()<span class="op">;</span></span>
<span id="cb4-17"><a href="#cb4-17"></a>    <span class="cf">loop</span> <span class="op">{}</span></span>
<span id="cb4-18"><a href="#cb4-18"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="just-a-note" class="level2">
<h2 class="anchored" data-anchor-id="just-a-note">Just a note</h2>
<ul>
<li>When you make a new version for today (<code>60</code>)
<ul>
<li>Probably leave out colors (<code>52</code>) and</li>
<li>Instead start with something with <code>println!</code> (likely <code>51</code>)</li>
</ul></li>
</ul>
</section>
<section id="todays-starting-point" class="level2">
<h2 class="anchored" data-anchor-id="todays-starting-point">Today’s Starting Point</h2>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/main.rs</strong></pre>
</div>
<div class="sourceCode" id="cb5" data-filename="src/main.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb5-1"><a href="#cb5-1"></a><span class="at">#![</span>no_std<span class="at">]</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="at">#![</span>no_main<span class="at">]</span></span>
<span id="cb5-3"><a href="#cb5-3"></a></span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="kw">mod</span> vga<span class="op">;</span></span>
<span id="cb5-5"><a href="#cb5-5"></a></span>
<span id="cb5-6"><a href="#cb5-6"></a><span class="at">#[</span>panic_handler<span class="at">]</span></span>
<span id="cb5-7"><a href="#cb5-7"></a><span class="kw">fn</span> panic(info<span class="op">:</span> <span class="op">&amp;</span><span class="pp">core::panic::</span>PanicInfo) <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb5-8"><a href="#cb5-8"></a>    <span class="pp">println!</span>(<span class="st">"{}"</span><span class="op">,</span> info)<span class="op">;</span></span>
<span id="cb5-9"><a href="#cb5-9"></a>    <span class="cf">loop</span> <span class="op">{}</span></span>
<span id="cb5-10"><a href="#cb5-10"></a><span class="op">}</span></span>
<span id="cb5-11"><a href="#cb5-11"></a></span>
<span id="cb5-12"><a href="#cb5-12"></a><span class="at">#[</span><span class="kw">unsafe</span><span class="at">(</span>no_mangle<span class="at">)]</span></span>
<span id="cb5-13"><a href="#cb5-13"></a><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">"C"</span> <span class="kw">fn</span> _start() <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb5-14"><a href="#cb5-14"></a>    <span class="pp">println!</span>(<span class="st">"Hello world!"</span>)<span class="op">;</span></span>
<span id="cb5-15"><a href="#cb5-15"></a>    <span class="cf">loop</span> <span class="op">{}</span></span>
<span id="cb5-16"><a href="#cb5-16"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="adding-to-main" class="level2">
<h2 class="anchored" data-anchor-id="adding-to-main">Adding to Main</h2>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/main.rs</strong></pre>
</div>
<div class="sourceCode" id="cb6" data-filename="src/main.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb6-1"><a href="#cb6-1"></a><span class="at">#![</span>no_std<span class="at">]</span></span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="at">#![</span>no_main<span class="at">]</span></span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="at">#![</span>feature<span class="at">(</span>custom_test_frameworks<span class="at">)]</span></span>
<span id="cb6-4"><a href="#cb6-4"></a><span class="at">#![</span>test_runner<span class="at">(</span><span class="kw">crate</span><span class="pp">::</span>test_runner<span class="at">)]</span></span>
<span id="cb6-5"><a href="#cb6-5"></a></span>
<span id="cb6-6"><a href="#cb6-6"></a><span class="kw">mod</span> vga<span class="op">;</span></span>
<span id="cb6-7"><a href="#cb6-7"></a></span>
<span id="cb6-8"><a href="#cb6-8"></a><span class="at">#[</span>cfg<span class="at">(</span>test<span class="at">)]</span></span>
<span id="cb6-9"><a href="#cb6-9"></a><span class="kw">pub</span> <span class="kw">fn</span> test_runner(tests<span class="op">:</span> <span class="op">&amp;</span>[<span class="op">&amp;</span><span class="kw">dyn</span> <span class="bu">Fn</span>()]) <span class="op">{</span></span>
<span id="cb6-10"><a href="#cb6-10"></a>    <span class="pp">println!</span>(<span class="st">"Running {} tests"</span><span class="op">,</span> tests<span class="op">.</span>len())<span class="op">;</span></span>
<span id="cb6-11"><a href="#cb6-11"></a>    <span class="cf">for</span> test <span class="kw">in</span> tests <span class="op">{</span></span>
<span id="cb6-12"><a href="#cb6-12"></a>        test()<span class="op">;</span></span>
<span id="cb6-13"><a href="#cb6-13"></a>    <span class="op">}</span></span>
<span id="cb6-14"><a href="#cb6-14"></a><span class="op">}</span></span>
<span id="cb6-15"><a href="#cb6-15"></a></span>
<span id="cb6-16"><a href="#cb6-16"></a><span class="at">#[</span>panic_handler<span class="at">]</span></span>
<span id="cb6-17"><a href="#cb6-17"></a><span class="kw">fn</span> panic(info<span class="op">:</span> <span class="op">&amp;</span><span class="pp">core::panic::</span>PanicInfo) <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb6-18"><a href="#cb6-18"></a>    <span class="pp">println!</span>(<span class="st">"{}"</span><span class="op">,</span> info)<span class="op">;</span></span>
<span id="cb6-19"><a href="#cb6-19"></a>    <span class="cf">loop</span> <span class="op">{}</span></span>
<span id="cb6-20"><a href="#cb6-20"></a><span class="op">}</span></span>
<span id="cb6-21"><a href="#cb6-21"></a></span>
<span id="cb6-22"><a href="#cb6-22"></a><span class="at">#[</span><span class="kw">unsafe</span><span class="at">(</span>no_mangle<span class="at">)]</span></span>
<span id="cb6-23"><a href="#cb6-23"></a><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">"C"</span> <span class="kw">fn</span> _start() <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb6-24"><a href="#cb6-24"></a>    <span class="pp">println!</span>(<span class="st">"Hello world!"</span>)<span class="op">;</span></span>
<span id="cb6-25"><a href="#cb6-25"></a>    <span class="cf">loop</span> <span class="op">{}</span></span>
<span id="cb6-26"><a href="#cb6-26"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="wait-a-minute" class="level2">
<h2 class="anchored" data-anchor-id="wait-a-minute">Wait a minute</h2>
<ul>
<li>What is <code>&amp;dyn</code>?</li>
<li><a href="https://doc.rust-lang.org/std/keyword.dyn.html">“Keyword <code>dyn</code></a></li>
</ul>
<blockquote class="blockquote">
<p>The <code>dyn</code> keyword is used to highlight that calls to methods on the associated <code>Trait</code> are dynamically dispatched.</p>
</blockquote>
</section>
<section id="dynamic-dispatch" class="level2">
<h2 class="anchored" data-anchor-id="dynamic-dispatch">Dynamic Dispatch</h2>
<blockquote class="blockquote">
<p><a href="https://en.wikipedia.org/wiki/Dynamic_dispatch">In computer science, <strong>dynamic dispatch</strong> is the process of selecting which implementation of a polymorphic operation (method or function) to call at run time. It is commonly employed in, and considered a prime characteristic of, object-oriented programming (OOP) languages and systems.</a></p>
</blockquote>
</section>
<section id="oop" class="level2">
<h2 class="anchored" data-anchor-id="oop">OOP</h2>
<ul>
<li>Yeah I’m not doing that.</li>
<li>We’ll maintain a list of functions.</li>
<li>If you want to learn about OOP, here is a tutorial on writing a Java app for Android.
<ul>
<li><a href="https://developer.android.com/codelabs/basic-android-kotlin-compose-first-app?continue=https%3A%2F%2Fdeveloper.android.com%2Fcourses%2Fpathways%2Fandroid-basics-compose-unit-1-pathway-2%23codelab-https%3A%2F%2Fdeveloper.android.com%2Fcodelabs%2Fbasic-android-kotlin-compose-first-app#0">Create your first Android app</a></li>
<li>Whoops its Kotlin (multi-paradigm).</li>
<li>Yet more evidence of the correctness of OOP.</li>
</ul></li>
</ul>
</section>
<section id="write-two-functions" class="level2">
<h2 class="anchored" data-anchor-id="write-two-functions">Write Two Functions</h2>
<ul>
<li>Doesn’t matter but nice to have externally observable functions.</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/main.rs</strong></pre>
</div>
<div class="sourceCode" id="cb7" data-filename="src/main.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb7-1"><a href="#cb7-1"></a><span class="kw">fn</span> hi() <span class="op">{</span></span>
<span id="cb7-2"><a href="#cb7-2"></a>    <span class="pp">println!</span>(<span class="st">"Hello world!"</span>)<span class="op">;</span></span>
<span id="cb7-3"><a href="#cb7-3"></a>    <span class="cf">return</span><span class="op">;</span></span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="op">}</span></span>
<span id="cb7-5"><a href="#cb7-5"></a></span>
<span id="cb7-6"><a href="#cb7-6"></a><span class="kw">fn</span> bye() <span class="op">{</span></span>
<span id="cb7-7"><a href="#cb7-7"></a>    <span class="pp">println!</span>(<span class="st">"Goodbye space!"</span>)<span class="op">;</span></span>
<span id="cb7-8"><a href="#cb7-8"></a>    <span class="cf">return</span><span class="op">;</span></span>
<span id="cb7-9"><a href="#cb7-9"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="make-an-array" class="level2">
<h2 class="anchored" data-anchor-id="make-an-array">Make an array</h2>
<ul>
<li>Just in <code>_start</code> for now.</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/main.rs</strong></pre>
</div>
<div class="sourceCode" id="cb8" data-filename="src/main.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb8-1"><a href="#cb8-1"></a><span class="at">#[</span><span class="kw">unsafe</span><span class="at">(</span>no_mangle<span class="at">)]</span></span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">"C"</span> <span class="kw">fn</span> _start() <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb8-3"><a href="#cb8-3"></a>    <span class="kw">let</span> fs <span class="op">=</span> [hi<span class="op">,</span> bye]<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="loop-over-the-array" class="level2">
<h2 class="anchored" data-anchor-id="loop-over-the-array">Loop over the array</h2>
<ul>
<li>Same as any other for each loop.
<ul>
<li>I am willing to use the for each loop, but still regard it with suspicion.</li>
</ul></li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/main.rs</strong></pre>
</div>
<div class="sourceCode" id="cb9" data-filename="src/main.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb9-1"><a href="#cb9-1"></a>    <span class="kw">let</span> fs <span class="op">=</span> [hi<span class="op">,</span> bye]<span class="op">;</span></span>
<span id="cb9-2"><a href="#cb9-2"></a>    <span class="cf">for</span> f <span class="kw">in</span> fs <span class="op">{</span></span>
<span id="cb9-3"><a href="#cb9-3"></a>        <span class="pp">todo!</span>()<span class="op">;</span></span>
<span id="cb9-4"><a href="#cb9-4"></a>    <span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="call-each-function" class="level2">
<h2 class="anchored" data-anchor-id="call-each-function">Call each function</h2>
<ul>
<li>What do you see?</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/main.rs</strong></pre>
</div>
<div class="sourceCode" id="cb10" data-filename="src/main.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb10-1"><a href="#cb10-1"></a>    <span class="kw">let</span> fs <span class="op">=</span> [hi<span class="op">,</span> bye]<span class="op">;</span></span>
<span id="cb10-2"><a href="#cb10-2"></a>    <span class="cf">for</span> f <span class="kw">in</span> fs <span class="op">{</span></span>
<span id="cb10-3"><a href="#cb10-3"></a>        f()<span class="op">;</span></span>
<span id="cb10-4"><a href="#cb10-4"></a>    <span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="sample-out" class="level2">
<h2 class="anchored" data-anchor-id="sample-out">Sample out</h2>
<p><img src="data:image/png;base64, iVBORw0KGgoAAAANSUhEUgAAAtAAAAGQCAIAAAAIhcA6AAAFJ0lEQVR4nO3dyXaDIBQAUMzp//9y
ujAlVgw+p4TovasaFKEb8DGlBAAAAPDtuvv9nlLquq6/Hl3W9TdP3l9JakS9hLNVa7ZeANCg25aH
K41u++1xvYSvUnNHJP8BAMza1OEAAIj4qSePvuO3xy1WZFgOYQx/eZVhvmfF4I7oBQDs6xHhuP8Z
puU2u5c2t8TvzHB4uehd9Ska+ff2x4wAoB2PCMcoMDD07Z/7i3oGJoQCwBFmhlRSS63vlt5AO7UA
gAua73Awou8CAEstWKVSTvJ4p3bWo372/wAA32hm46/6opJhajBp3bKXcu7nbAkrZQuWMK9wmaya
OAcAAAA0pKuMDviIBwB2YadRAAAAAAAAAIDPiy4iXaE8NW3FOWqnYTEtAFd2S/+PQEv77axVNq6X
bW7b2bUMAD7iNvryvmyfAAA4zsRZKsGNQeObkJbK8YUtG57W31I+lTOfHOIJbp9aeSpeQgC4iNo+
HMOhltFoSyUpBeYrLBq7qb9rxVP5cjLD2Uot/W8kASQALu8Z4dhr3mhwdmQfYOhb/Xi2caP84zUK
vqjM0PwMAHjl2eHYd8bo7lb0gXKfI/54eUrcoSUEgIs4+dbmuy+92V4SALigWyPtcVwOWsRvO6KO
lWJMJgWLDQCnNLEl13Bexbp1GaPchqnxDINPVXyw8K9meAhyAEBDjo4HiDcAwDu1OIdDMAAATqaV
Rv2dG2cdcXAMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAZ/ULzGetS97yp6YAAAAA
SUVORK5CYII="></p>
</section>
<section id="aside-bits" class="level1">
<h1>Aside: Bits</h1>
<section id="pulling-back-the-curtain" class="level2">
<h2 class="anchored" data-anchor-id="pulling-back-the-curtain">Pulling back the curtain</h2>
<ul>
<li>I’m insane.</li>
<li>I ran this then screendumped (in QEMU) to <code>fs.ppm</code></li>
<li>I converted to <code>.png</code></li>
</ul>
<div class="sourceCode" id="cb11"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1"></a><span class="ex">python3</span> <span class="at">-c</span> <span class="st">"from PIL import Image; Image.open('fs.ppm').save('fs.png')"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>I <code>base64</code> the PNG.
<ul>
<li>See next slide.</li>
</ul></li>
</ul>
</section>
<section id="its-tiny" class="level2">
<h2 class="anchored" data-anchor-id="its-tiny">It’s tiny!</h2>
<div class="sourceCode" id="cb12"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1"></a><span class="ex">$</span> base64 fs.png <span class="kw">|</span> <span class="fu">wc</span></span>
<span id="cb12-2"><a href="#cb12-2"></a>     <span class="ex">25</span>      25    1861</span>
<span id="cb12-3"><a href="#cb12-3"></a><span class="ex">$</span> base64 fs.png</span>
<span id="cb12-4"><a href="#cb12-4"></a><span class="ex">iVBORw0KGgoAAAANSUhEUgAAAtAAAAGQCAIAAAAIhcA6AAAFJ0lEQVR4nO3dyXaDIBQAUMzp//9y</span></span>
<span id="cb12-5"><a href="#cb12-5"></a><span class="ex">ujAlVgw+p4TovasaFKEb8DGlBAAAAPDtuvv9nlLquq6/Hl3W9TdP3l9JakS9hLNVa7ZeANCg25aH</span></span>
<span id="cb12-6"><a href="#cb12-6"></a><span class="ex">K41u++1xvYSvUnNHJP8BAMza1OEAAIj4qSePvuO3xy1WZFgOYQx/eZVhvmfF4I7oBQDs6xHhuP8Z</span></span>
<span id="cb12-7"><a href="#cb12-7"></a><span class="ex">puU2u5c2t8TvzHB4uehd9Ska+ff2x4wAoB2PCMcoMDD07Z/7i3oGJoQCwBFmhlRSS63vlt5AO7UA</span></span>
<span id="cb12-8"><a href="#cb12-8"></a><span class="ex">gAua73Awou8CAEstWKVSTvJ4p3bWo372/wAA32hm46/6opJhajBp3bKXcu7nbAkrZQuWMK9wmaya</span></span>
<span id="cb12-9"><a href="#cb12-9"></a><span class="ex">OAcAAAA0pKuMDviIBwB2YadRAAAAAAAAAIDPiy4iXaE8NW3FOWqnYTEtAFd2S/+PQEv77axVNq6X</span></span>
<span id="cb12-10"><a href="#cb12-10"></a><span class="ex">bW7b2bUMAD7iNvryvmyfAAA4zsRZKsGNQeObkJbK8YUtG57W31I+lTOfHOIJbp9aeSpeQgC4iNo+</span></span>
<span id="cb12-11"><a href="#cb12-11"></a><span class="ex">HMOhltFoSyUpBeYrLBq7qb9rxVP5cjLD2Uot/W8kASQALu8Z4dhr3mhwdmQfYOhb/Xi2caP84zUK</span></span>
<span id="cb12-12"><a href="#cb12-12"></a><span class="ex">vqjM0PwMAHjl2eHYd8bo7lb0gXKfI/54eUrcoSUEgIs4+dbmuy+92V4SALigWyPtcVwOWsRvO6KO</span></span>
<span id="cb12-13"><a href="#cb12-13"></a><span class="ex">lWJMJgWLDQCnNLEl13Bexbp1GaPchqnxDINPVXyw8K9meAhyAEBDjo4HiDcAwDu1OIdDMAAATqaV</span></span>
<span id="cb12-14"><a href="#cb12-14"></a><span class="ex">Rv2dG2cdcXAMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span></span>
<span id="cb12-15"><a href="#cb12-15"></a><span class="ex">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span></span>
<span id="cb12-16"><a href="#cb12-16"></a><span class="ex">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span></span>
<span id="cb12-17"><a href="#cb12-17"></a><span class="ex">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span></span>
<span id="cb12-18"><a href="#cb12-18"></a><span class="ex">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span></span>
<span id="cb12-19"><a href="#cb12-19"></a><span class="ex">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span></span>
<span id="cb12-20"><a href="#cb12-20"></a><span class="ex">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span></span>
<span id="cb12-21"><a href="#cb12-21"></a><span class="ex">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span></span>
<span id="cb12-22"><a href="#cb12-22"></a><span class="ex">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span></span>
<span id="cb12-23"><a href="#cb12-23"></a><span class="ex">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span></span>
<span id="cb12-24"><a href="#cb12-24"></a><span class="ex">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span></span>
<span id="cb12-25"><a href="#cb12-25"></a><span class="ex">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span></span>
<span id="cb12-26"><a href="#cb12-26"></a><span class="ex">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span></span>
<span id="cb12-27"><a href="#cb12-27"></a><span class="ex">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAZ/ULzGetS97yp6YAAAAA</span></span>
<span id="cb12-28"><a href="#cb12-28"></a><span class="va">SUVORK5CYII</span><span class="op">=</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="to-html" class="level2">
<h2 class="anchored" data-anchor-id="to-html">To HTML</h2>
<ul>
<li>I read <a href="https://stackoverflow.com/a/8499716">this stackoverflow answer</a></li>
<li>It contains this snippet</li>
</ul>
<div class="sourceCode" id="cb13"><pre class="sourceCode numberSource html number-lines code-with-copy"><code class="sourceCode html"><span id="cb13-1"><a href="#cb13-1"></a><span class="dt">&lt;</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb13-2"><a href="#cb13-2"></a>  <span class="dt">&lt;</span><span class="kw">p</span><span class="dt">&gt;</span>Taken from wikpedia<span class="dt">&lt;/</span><span class="kw">p</span><span class="dt">&gt;</span></span>
<span id="cb13-3"><a href="#cb13-3"></a>  <span class="dt">&lt;</span><span class="kw">img</span><span class="ot"> src</span><span class="op">=</span><span class="st">"data:image/png;base64, iVBORw0KGgoAAAANSUhEUgAAAAUA</span></span>
<span id="cb13-4"><a href="#cb13-4"></a><span class="st">    AAAFCAYAAACNbyblAAAAHElEQVQI12P4//8/w38GIAXDIBKE0DHxgljNBAAO</span></span>
<span id="cb13-5"><a href="#cb13-5"></a><span class="st">        9TXL0Y4OHwAAAABJRU5ErkJggg=="</span><span class="ot"> alt</span><span class="op">=</span><span class="st">"Red dot"</span><span class="ot"> </span><span class="dt">/&gt;</span></span>
<span id="cb13-6"><a href="#cb13-6"></a><span class="dt">&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>I only need this:</li>
</ul>
<div class="sourceCode" id="cb14"><pre class="sourceCode numberSource html number-lines code-with-copy"><code class="sourceCode html"><span id="cb14-1"><a href="#cb14-1"></a><span class="dt">&lt;</span><span class="kw">img</span><span class="ot"> src</span><span class="op">=</span><span class="st">"data:image/png;base64, "</span><span class="dt">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="here-it-is" class="level2">
<h2 class="anchored" data-anchor-id="here-it-is">Here it is</h2>
<ul>
<li>And then I placed that exact HTML within my Markdown.
<ul>
<li>With the <code>base64</code> PNG data within.</li>
</ul></li>
</ul>
<p><img src="data:image/png;base64, iVBORw0KGgoAAAANSUhEUgAAAtAAAAGQCAIAAAAIhcA6AAAFJ0lEQVR4nO3dyXaDIBQAUMzp//9y
ujAlVgw+p4TovasaFKEb8DGlBAAAAPDtuvv9nlLquq6/Hl3W9TdP3l9JakS9hLNVa7ZeANCg25aH
K41u++1xvYSvUnNHJP8BAMza1OEAAIj4qSePvuO3xy1WZFgOYQx/eZVhvmfF4I7oBQDs6xHhuP8Z
puU2u5c2t8TvzHB4uehd9Ska+ff2x4wAoB2PCMcoMDD07Z/7i3oGJoQCwBFmhlRSS63vlt5AO7UA
gAua73Awou8CAEstWKVSTvJ4p3bWo372/wAA32hm46/6opJhajBp3bKXcu7nbAkrZQuWMK9wmaya
OAcAAAA0pKuMDviIBwB2YadRAAAAAAAAAIDPiy4iXaE8NW3FOWqnYTEtAFd2S/+PQEv77axVNq6X
bW7b2bUMAD7iNvryvmyfAAA4zsRZKsGNQeObkJbK8YUtG57W31I+lTOfHOIJbp9aeSpeQgC4iNo+
HMOhltFoSyUpBeYrLBq7qb9rxVP5cjLD2Uot/W8kASQALu8Z4dhr3mhwdmQfYOhb/Xi2caP84zUK
vqjM0PwMAHjl2eHYd8bo7lb0gXKfI/54eUrcoSUEgIs4+dbmuy+92V4SALigWyPtcVwOWsRvO6KO
lWJMJgWLDQCnNLEl13Bexbp1GaPchqnxDINPVXyw8K9meAhyAEBDjo4HiDcAwDu1OIdDMAAATqaV
Rv2dG2cdcXAMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAZ/ULzGetS97yp6YAAAAA
SUVORK5CYII="></p>
</section>
<section id="by-the-way" class="level2">
<h2 class="anchored" data-anchor-id="by-the-way">By the way</h2>
<ul>
<li>You can use that as a URL.</li>
<li><a href="data:image/png;base64,%20iVBORw0KGgoAAAANSUhEUgAAAtAAAAGQCAIAAAAIhcA6AAAFJ0lEQVR4nO3dyXaDIBQAUMzp//9y%20ujAlVgw+p4TovasaFKEb8DGlBAAAAPDtuvv9nlLquq6/Hl3W9TdP3l9JakS9hLNVa7ZeANCg25aH%20K41u++1xvYSvUnNHJP8BAMza1OEAAIj4qSePvuO3xy1WZFgOYQx/eZVhvmfF4I7oBQDs6xHhuP8Z%20puU2u5c2t8TvzHB4uehd9Ska+ff2x4wAoB2PCMcoMDD07Z/7i3oGJoQCwBFmhlRSS63vlt5AO7UA%20gAua73Awou8CAEstWKVSTvJ4p3bWo372/wAA32hm46/6opJhajBp3bKXcu7nbAkrZQuWMK9wmaya%20OAcAAAA0pKuMDviIBwB2YadRAAAAAAAAAIDPiy4iXaE8NW3FOWqnYTEtAFd2S/+PQEv77axVNq6X%20bW7b2bUMAD7iNvryvmyfAAA4zsRZKsGNQeObkJbK8YUtG57W31I+lTOfHOIJbp9aeSpeQgC4iNo+%20HMOhltFoSyUpBeYrLBq7qb9rxVP5cjLD2Uot/W8kASQALu8Z4dhr3mhwdmQfYOhb/Xi2caP84zUK%20vqjM0PwMAHjl2eHYd8bo7lb0gXKfI/54eUrcoSUEgIs4+dbmuy+92V4SALigWyPtcVwOWsRvO6KO%20lWJMJgWLDQCnNLEl13Bexbp1GaPchqnxDINPVXyw8K9meAhyAEBDjo4HiDcAwDu1OIdDMAAATqaV%20Rv2dG2cdcXAMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA%20AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA%20AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA%20AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA%20AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA%20AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA%20AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA%20AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA%20AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA%20AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA%20AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA%20AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA%20AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA%20AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAZ/ULzGetS97yp6YAAAAA%20SUVORK5CYII=">Click me</a></li>
<li>Okay back to work.</li>
</ul>
</section>
<section id="wait-just-kidding" class="level2">
<h2 class="anchored" data-anchor-id="wait-just-kidding">Wait Just Kidding</h2>
<ul>
<li>Manually edit the data.</li>
<li>Delete <em>exactly</em> 24 <code>A</code> values in the big block.
<ul>
<li>24 values at 6 bits of information each yields 144 bits or 18 bytes.</li>
<li>What do you see?</li>
<li>What if you delete not a multiple of 24?</li>
<li>What if you delete a different 24?</li>
</ul></li>
</ul>
</section>
<section id="quote-me" class="level2">
<h2 class="anchored" data-anchor-id="quote-me">Quote Me</h2>
<blockquote class="blockquote">
<p>“They’re my bits, in my computer - let me use them!”</p>
</blockquote>
</section>
</section>
<section id="back-to-work" class="level1">
<h1>Back to Work</h1>
<section id="recall" class="level2">
<h2 class="anchored" data-anchor-id="recall">Recall</h2>
<ul>
<li>Rust is trying to get us to write Java instead of C.</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/main.rs</strong></pre>
</div>
<div class="sourceCode" id="cb15" data-filename="src/main.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb15-1"><a href="#cb15-1"></a><span class="at">#[</span>cfg<span class="at">(</span>test<span class="at">)]</span></span>
<span id="cb15-2"><a href="#cb15-2"></a><span class="kw">pub</span> <span class="kw">fn</span> test_runner(tests<span class="op">:</span> <span class="op">&amp;</span>[<span class="op">&amp;</span><span class="kw">dyn</span> <span class="bu">Fn</span>()]) <span class="op">{</span></span>
<span id="cb15-3"><a href="#cb15-3"></a>    <span class="pp">println!</span>(<span class="st">"Running {} tests"</span><span class="op">,</span> tests<span class="op">.</span>len())<span class="op">;</span></span>
<span id="cb15-4"><a href="#cb15-4"></a>    <span class="cf">for</span> test <span class="kw">in</span> tests <span class="op">{</span></span>
<span id="cb15-5"><a href="#cb15-5"></a>        test()<span class="op">;</span></span>
<span id="cb15-6"><a href="#cb15-6"></a>    <span class="op">}</span></span>
<span id="cb15-7"><a href="#cb15-7"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="outsmart-rust" class="level2">
<h2 class="anchored" data-anchor-id="outsmart-rust">Outsmart Rust</h2>
<ul>
<li>Ignore the argument via <code>_</code></li>
<li>Include the stuff from inside <code>_start</code>.</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/main.rs</strong></pre>
</div>
<div class="sourceCode" id="cb16" data-filename="src/main.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb16-1"><a href="#cb16-1"></a><span class="at">#[</span>cfg<span class="at">(</span>test<span class="at">)]</span></span>
<span id="cb16-2"><a href="#cb16-2"></a><span class="kw">pub</span> <span class="kw">fn</span> test_runner(_tests<span class="op">:</span> <span class="op">&amp;</span>[<span class="op">&amp;</span><span class="kw">dyn</span> <span class="bu">Fn</span>()]) <span class="op">{</span></span>
<span id="cb16-3"><a href="#cb16-3"></a>    <span class="kw">let</span> fs <span class="op">=</span> [hi<span class="op">,</span> bye]<span class="op">;</span></span>
<span id="cb16-4"><a href="#cb16-4"></a>    <span class="pp">println!</span>(<span class="st">"Running {} tests"</span><span class="op">,</span> fs<span class="op">.</span>len())<span class="op">;</span></span>
<span id="cb16-5"><a href="#cb16-5"></a>    <span class="cf">for</span> f <span class="kw">in</span> fs <span class="op">{</span></span>
<span id="cb16-6"><a href="#cb16-6"></a>        f()<span class="op">;</span></span>
<span id="cb16-7"><a href="#cb16-7"></a>    <span class="op">}</span></span>
<span id="cb16-8"><a href="#cb16-8"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Probably change <code>main</code> too so you know what is running, mine says “I’m main”.</li>
</ul>
</section>
<section id="check-it" class="level2">
<h2 class="anchored" data-anchor-id="check-it">Check it</h2>
<ul>
<li>You can run the tests via:</li>
</ul>
<div class="sourceCode" id="cb17"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1"></a><span class="ex">cargo</span> +nightly t</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Wow that <code>+nightly</code> is getting annoying.
<ul>
<li>Time for an aside.</li>
</ul></li>
</ul>
</section>
</section>
<section id="aside-nightly" class="level1">
<h1>Aside: Nightly</h1>
<section id="back-to-stack" class="level2">
<h2 class="anchored" data-anchor-id="back-to-stack">Back to Stack</h2>
<ul>
<li>I love stackoverflow.
<ul>
<li>Too bad it is slowly being incinerated by generative AI</li>
<li>Surely this will lead to no long-term problems.</li>
</ul></li>
<li>Check out <a href="https://stackoverflow.com/questions/67094650/set-a-project-to-use-nightly-by-default">this answer</a></li>
</ul>
</section>
<section id="it-states" class="level2">
<h2 class="anchored" data-anchor-id="it-states">It states</h2>
<blockquote class="blockquote">
<p>you can add a rust-toolchain.toml file, for example</p>
</blockquote>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>rust-toolchain.toml</strong></pre>
</div>
<div class="sourceCode" id="cb18" data-filename="rust-toolchain.toml"><pre class="sourceCode numberSource toml number-lines code-with-copy"><code class="sourceCode toml"><span id="cb18-1"><a href="#cb18-1"></a><span class="kw">[toolchain]</span></span>
<span id="cb18-2"><a href="#cb18-2"></a><span class="dt">channel</span> <span class="op">=</span> <span class="st">"nightly"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>I am doing this now.</li>
</ul>
</section>
<section id="what-i-see" class="level2">
<h2 class="anchored" data-anchor-id="what-i-see">What I see</h2>
<ul>
<li>I removed my <code>target</code> for clarity.</li>
</ul>
<div class="sourceCode" id="cb19"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1"></a><span class="ex">$</span> rm <span class="at">-rf</span> target/</span>
<span id="cb19-2"><a href="#cb19-2"></a><span class="ex">$</span> tree</span>
<span id="cb19-3"><a href="#cb19-3"></a><span class="bu">.</span></span>
<span id="cb19-4"><a href="#cb19-4"></a><span class="ex">├──</span> Cargo.lock</span>
<span id="cb19-5"><a href="#cb19-5"></a><span class="ex">├──</span> Cargo.toml</span>
<span id="cb19-6"><a href="#cb19-6"></a><span class="ex">├──</span> rust-toolchain.toml</span>
<span id="cb19-7"><a href="#cb19-7"></a><span class="ex">├──</span> src</span>
<span id="cb19-8"><a href="#cb19-8"></a><span class="ex">│&nbsp;&nbsp;</span> ├── main.rs</span>
<span id="cb19-9"><a href="#cb19-9"></a><span class="ex">│&nbsp;&nbsp;</span> └── vga.rs</span>
<span id="cb19-10"><a href="#cb19-10"></a><span class="ex">└──</span> x86_64-osirs.json</span>
<span id="cb19-11"><a href="#cb19-11"></a></span>
<span id="cb19-12"><a href="#cb19-12"></a><span class="ex">1</span> directory, 6 files</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="the-other-way" class="level2">
<h2 class="anchored" data-anchor-id="the-other-way">The other way</h2>
<ul>
<li>If you wish to use nightly in all projects, you can check <a href="https://stackoverflow.com/a/65644807">this answer</a>.</li>
<li>There are a variety of intermediate ways, of course.</li>
<li>Okay back to work.</li>
</ul>
</section>
</section>
<section id="back-to-work-1" class="level1">
<h1>Back to Work</h1>
<section id="recall-1" class="level2">
<h2 class="anchored" data-anchor-id="recall-1">Recall</h2>
<ul>
<li>We were trying to run tests.</li>
</ul>
<div class="sourceCode" id="cb20"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1"></a><span class="ex">cargo</span> t <span class="co"># FINALLY</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>You may notice this is just running <code>_start</code>.</li>
<li>That is because <code>src/main.rs</code> is a fan of the Black Eyed Peas.
<ul>
<li><a href="https://www.youtube.com/watch?v=IKqV7DB8Iwg">Learn more</a></li>
<li>Note to Calvin - do not click that in class.</li>
</ul></li>
</ul>
</section>
<section id="surprise" class="level2">
<h2 class="anchored" data-anchor-id="surprise">Surprise!</h2>
<ul>
<li>Something not going as planned on the first try?</li>
<li>Our <code>_start</code> function is still used as entry point.
<ul>
<li>It is, after all, the <code>_start</code> function.</li>
</ul></li>
</ul>
</section>
<section id="the-problem" class="level2">
<h2 class="anchored" data-anchor-id="the-problem">The Problem</h2>
<ul>
<li>The custom test frameworks feature generates a <code>main</code> function that calls <code>test_runner</code>
<ul>
<li>What is it for? Software?</li>
<li>Might as well use Kotlin!</li>
</ul></li>
<li>Our OS, of course, never calls <code>main</code>.</li>
</ul>
</section>
<section id="maybe-problem" class="level2">
<h2 class="anchored" data-anchor-id="maybe-problem">Maybe problem</h2>
<ul>
<li>If you see “duplicate lang item” expand:</li>
</ul>
<details>
<p><strong>Note:</strong> There is currently a bug in cargo that leads to “duplicate lang item” errors on <code>cargo test</code> in some cases. It occurs when you have set <code>panic = "abort"</code> for a profile in your <code>Cargo.toml</code>. Try removing it, then <code>cargo test</code> should work. Alternatively, if that doesn’t work, then add <code>panic-abort-tests = true</code> to the <code>[unstable]</code> section of your <code>.cargo/config.toml</code> file. See the <a href="https://github.com/rust-lang/cargo/issues/7359">cargo issue</a> for more information on this.</p>
</details>
</section>
<section id="fine-ill-do-it-myself" class="level2">
<h2 class="anchored" data-anchor-id="fine-ill-do-it-myself">Fine, I’ll do it myself</h2>
<ul>
<li>Simply call <code>test_runner</code> from <code>_start</code>
<ul>
<li>It needs a borrowed array of whatevers, so give it one.</li>
</ul></li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/main.rs</strong></pre>
</div>
<div class="sourceCode" id="cb21" data-filename="src/main.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb21-1"><a href="#cb21-1"></a><span class="at">#[</span><span class="kw">unsafe</span><span class="at">(</span>no_mangle<span class="at">)]</span></span>
<span id="cb21-2"><a href="#cb21-2"></a><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">"C"</span> <span class="kw">fn</span> _start() <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb21-3"><a href="#cb21-3"></a>    <span class="pp">println!</span>(<span class="st">"I'm main."</span>)<span class="op">;</span></span>
<span id="cb21-4"><a href="#cb21-4"></a>    test_runner(<span class="op">&amp;</span>[])<span class="op">;</span></span>
<span id="cb21-5"><a href="#cb21-5"></a>    <span class="cf">loop</span> <span class="op">{}</span></span>
<span id="cb21-6"><a href="#cb21-6"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="only-problem" class="level2">
<h2 class="anchored" data-anchor-id="only-problem">Only problem</h2>
<ul>
<li>What if we <code>run</code> instead of <code>test</code>?</li>
</ul>
<div class="sourceCode" id="cb22"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1"></a><span class="ex">$</span> cargo r</span>
<span id="cb22-2"><a href="#cb22-2"></a>   <span class="ex">Compiling</span> osirs v0.1.0 <span class="er">(</span><span class="ex">/home/user/tmp/work</span><span class="kw">)</span></span>
<span id="cb22-3"><a href="#cb22-3"></a><span class="va">error</span><span class="op">[</span>E0423<span class="op">]</span><span class="ex">:</span> expected function, found built-in attribute <span class="kw">`</span><span class="ex">test_runner</span><span class="kw">`</span></span>
<span id="cb22-4"><a href="#cb22-4"></a>  <span class="ex">--</span><span class="op">&gt;</span> src/main.rs:26:5</span>
<span id="cb22-5"><a href="#cb22-5"></a>   <span class="kw">|</span></span>
<span id="cb22-6"><a href="#cb22-6"></a><span class="ex">26</span> <span class="kw">|</span>     <span class="ex">test_runner</span><span class="er">(</span><span class="kw">&amp;</span><span class="ex">[]</span><span class="kw">);</span></span>
<span id="cb22-7"><a href="#cb22-7"></a>   <span class="kw">|</span>     <span class="ex">^^^^^^^^^^^</span> not a function</span>
<span id="cb22-8"><a href="#cb22-8"></a>   <span class="kw">|</span></span>
<span id="cb22-9"><a href="#cb22-9"></a><span class="ex">note:</span> found an item that was configured out</span>
<span id="cb22-10"><a href="#cb22-10"></a>  <span class="ex">--</span><span class="op">&gt;</span> src/main.rs:9:4</span>
<span id="cb22-11"><a href="#cb22-11"></a>   <span class="kw">|</span></span>
<span id="cb22-12"><a href="#cb22-12"></a> <span class="ex">8</span> <span class="kw">|</span> <span class="co">#[cfg(test)]</span></span>
<span id="cb22-13"><a href="#cb22-13"></a>   <span class="kw">|</span>       <span class="ex">----</span> the item is gated here</span>
<span id="cb22-14"><a href="#cb22-14"></a> <span class="ex">9</span> <span class="kw">|</span> <span class="ex">fn</span> test_runner<span class="er">(</span><span class="ex">_tests:</span> <span class="kw">&amp;</span><span class="ex">[</span><span class="kw">&amp;</span><span class="ex">dyn</span> Fn<span class="er">(</span><span class="kw">)</span><span class="ex">]</span><span class="kw">)</span> <span class="kw">{</span></span>
<span id="cb22-15"><a href="#cb22-15"></a>   <span class="kw">|</span>    <span class="ex">^^^^^^^^^^^</span></span>
<span id="cb22-16"><a href="#cb22-16"></a></span>
<span id="cb22-17"><a href="#cb22-17"></a><span class="ex">For</span> more information about this error, try <span class="kw">`</span><span class="ex">rustc</span> <span class="at">--explain</span> E0423<span class="kw">`</span>.</span>
<span id="cb22-18"><a href="#cb22-18"></a><span class="ex">error:</span> could not compile <span class="kw">`</span><span class="ex">osirs</span><span class="kw">`</span> <span class="er">(</span><span class="ex">bin</span> <span class="st">"osirs"</span><span class="kw">)</span> <span class="ex">due</span> to 1 previous error</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="conditional-compilation" class="level2">
<h2 class="anchored" data-anchor-id="conditional-compilation">Conditional Compilation</h2>
<ul>
<li>We need to <em>conditionally</em> compile <code>_start</code> to either call <code>test_runner</code> or not.</li>
<li>No problem, we already know how to do this!</li>
<li><code>#[cfg(test)]</code></li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/main.rs</strong></pre>
</div>
<div class="sourceCode" id="cb23" data-filename="src/main.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb23-1"><a href="#cb23-1"></a><span class="at">#[</span><span class="kw">unsafe</span><span class="at">(</span>no_mangle<span class="at">)]</span></span>
<span id="cb23-2"><a href="#cb23-2"></a><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">"C"</span> <span class="kw">fn</span> _start() <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb23-3"><a href="#cb23-3"></a>    <span class="pp">println!</span>(<span class="st">"I'm main{}"</span><span class="op">,</span> <span class="st">"."</span>)<span class="op">;</span></span>
<span id="cb23-4"><a href="#cb23-4"></a></span>
<span id="cb23-5"><a href="#cb23-5"></a>    <span class="at">#[</span>cfg<span class="at">(</span>test<span class="at">)]</span></span>
<span id="cb23-6"><a href="#cb23-6"></a>    test_runner(<span class="op">&amp;</span>[])<span class="op">;</span></span>
<span id="cb23-7"><a href="#cb23-7"></a></span>
<span id="cb23-8"><a href="#cb23-8"></a>    <span class="cf">loop</span> <span class="op">{}</span></span>
<span id="cb23-9"><a href="#cb23-9"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="only-problem-1" class="level2">
<h2 class="anchored" data-anchor-id="only-problem-1">Only problem</h2>
<ul>
<li>What if we <code>run</code> instead of <code>test</code>?</li>
</ul>
<div class="sourceCode" id="cb24"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb24-1"><a href="#cb24-1"></a><span class="ex">$</span> cargo r</span>
<span id="cb24-2"><a href="#cb24-2"></a>   <span class="ex">Compiling</span> osirs v0.1.0 <span class="er">(</span><span class="ex">/home/user/tmp/work</span><span class="kw">)</span></span>
<span id="cb24-3"><a href="#cb24-3"></a><span class="ex">warning:</span> function <span class="kw">`</span><span class="ex">hi</span><span class="kw">`</span> is never used</span>
<span id="cb24-4"><a href="#cb24-4"></a>  <span class="ex">--</span><span class="op">&gt;</span> src/main.rs:32:4</span>
<span id="cb24-5"><a href="#cb24-5"></a>   <span class="kw">|</span></span>
<span id="cb24-6"><a href="#cb24-6"></a><span class="ex">32</span> <span class="kw">|</span> <span class="ex">fn</span> hi<span class="er">(</span><span class="kw">)</span> <span class="kw">{</span></span>
<span id="cb24-7"><a href="#cb24-7"></a>   <span class="kw">|</span>    <span class="ex">^^</span></span>
<span id="cb24-8"><a href="#cb24-8"></a>   <span class="kw">|</span></span>
<span id="cb24-9"><a href="#cb24-9"></a>   <span class="ex">=</span> note: <span class="kw">`</span><span class="co">#[warn(dead_code)]</span><span class="kw">`</span> <span class="er">(</span><span class="ex">part</span> of <span class="kw">`</span><span class="co">#[warn(unused)]</span><span class="kw">`)</span> <span class="ex">on</span> by default</span>
<span id="cb24-10"><a href="#cb24-10"></a></span>
<span id="cb24-11"><a href="#cb24-11"></a><span class="ex">warning:</span> function <span class="kw">`</span><span class="ex">bye</span><span class="kw">`</span> is never used</span>
<span id="cb24-12"><a href="#cb24-12"></a>  <span class="ex">--</span><span class="op">&gt;</span> src/main.rs:37:4</span>
<span id="cb24-13"><a href="#cb24-13"></a>   <span class="kw">|</span></span>
<span id="cb24-14"><a href="#cb24-14"></a><span class="ex">37</span> <span class="kw">|</span> <span class="ex">fn</span> bye<span class="er">(</span><span class="kw">)</span> <span class="kw">{</span></span>
<span id="cb24-15"><a href="#cb24-15"></a>   <span class="kw">|</span>    <span class="ex">^^^</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="correct-way" class="level2">
<h2 class="anchored" data-anchor-id="correct-way">Correct Way</h2>
<ul>
<li>There is a correct way to solve this.</li>
<li>Separately, there is the opposite: my way.</li>
<li>I renamed them with a <code>_</code> prefix.</li>
</ul>
<div class="sourceCode" id="cb25"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb25-1"><a href="#cb25-1"></a>    <span class="cf">for</span> f <span class="kw">in</span> [_hi<span class="op">,</span> _bye] <span class="op">{</span></span>
<span id="cb25-2"><a href="#cb25-2"></a>        f()<span class="op">;</span></span>
<span id="cb25-3"><a href="#cb25-3"></a>    <span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="todo" class="level2">
<h2 class="anchored" data-anchor-id="todo">Todo</h2>
<p>We are now ready to create our first test function:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode numberSource rust number-lines code-with-copy"><code class="sourceCode rust"><span id="cb26-1"><a href="#cb26-1"></a><span class="co">// in src/main.rs</span></span>
<span id="cb26-2"><a href="#cb26-2"></a></span>
<span id="cb26-3"><a href="#cb26-3"></a><span class="at">#[</span>test_case<span class="at">]</span></span>
<span id="cb26-4"><a href="#cb26-4"></a><span class="kw">fn</span> trivial_assertion() <span class="op">{</span></span>
<span id="cb26-5"><a href="#cb26-5"></a>    <span class="pp">print!</span>(<span class="st">"trivial assertion... "</span>)<span class="op">;</span></span>
<span id="cb26-6"><a href="#cb26-6"></a>    <span class="pp">assert_eq!</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb26-7"><a href="#cb26-7"></a>    <span class="pp">println!</span>(<span class="st">"[ok]"</span>)<span class="op">;</span></span>
<span id="cb26-8"><a href="#cb26-8"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>When we run <code>cargo test</code> now, we see the following output:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="qemu-test-runner-output.png" class="img-fluid figure-img"></p>
<figcaption>QEMU printing “Hello World!”, “Running 1 tests”, and “trivial assertion… [ok]”</figcaption>
</figure>
</div>
<p>The <code>tests</code> slice passed to our <code>test_runner</code> function now contains a reference to the <code>trivial_assertion</code> function. From the <code>trivial assertion... [ok]</code> output on the screen, we see that the test was called and that it succeeded.</p>
<p>After executing the tests, our <code>test_runner</code> returns to the <code>test_main</code> function, which in turn returns to our <code>_start</code> entry point function. At the end of <code>_start</code>, we enter an endless loop because the entry point function is not allowed to return. This is a problem, because we want <code>cargo test</code> to exit after running all tests.</p>
</section>
<section id="exiting-qemu" class="level2">
<h2 class="anchored" data-anchor-id="exiting-qemu">Exiting QEMU</h2>
<p>Right now, we have an endless loop at the end of our <code>_start</code> function and need to close QEMU manually on each execution of <code>cargo test</code>. This is unfortunate because we also want to run <code>cargo test</code> in scripts without user interaction. The clean solution to this would be to implement a proper way to shutdown our OS. Unfortunately, this is relatively complex because it requires implementing support for either the <a href="https://wiki.osdev.org/APM">APM</a> or <a href="https://wiki.osdev.org/ACPI">ACPI</a> power management standard.</p>
<p>Luckily, there is an escape hatch: QEMU supports a special <code>isa-debug-exit</code> device, which provides an easy way to exit QEMU from the guest system. To enable it, we need to pass a <code>-device</code> argument to QEMU. We can do so by adding a <code>package.metadata.bootimage.test-args</code> configuration key in our <code>Cargo.toml</code>:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode numberSource toml number-lines code-with-copy"><code class="sourceCode toml"><span id="cb27-1"><a href="#cb27-1"></a><span class="co"># in Cargo.toml</span></span>
<span id="cb27-2"><a href="#cb27-2"></a></span>
<span id="cb27-3"><a href="#cb27-3"></a><span class="kw">[package.metadata.bootimage]</span></span>
<span id="cb27-4"><a href="#cb27-4"></a><span class="dt">test-args</span> <span class="op">=</span> <span class="op">[</span><span class="st">"-device"</span><span class="op">,</span> <span class="st">"isa-debug-exit,iobase=0xf4,iosize=0x04"</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>bootimage runner</code> appends the <code>test-args</code> to the default QEMU command for all test executables. For a normal <code>cargo run</code>, the arguments are ignored.</p>
<p>Together with the device name (<code>isa-debug-exit</code>), we pass the two parameters <code>iobase</code> and <code>iosize</code> that specify the <em>I/O port</em> through which the device can be reached from our kernel.</p>
<section id="io-ports" class="level3">
<h3 class="anchored" data-anchor-id="io-ports">I/O Ports</h3>
<p>There are two different approaches for communicating between the CPU and peripheral hardware on x86, <strong>memory-mapped I/O</strong> and <strong>port-mapped I/O</strong>. We already used memory-mapped I/O for accessing the <a href="@/edition-2/posts/03-vga-text-buffer/index.md">VGA text buffer</a> through the memory address <code>0xb8000</code>. This address is not mapped to RAM but to some memory on the VGA device.</p>
<p>In contrast, port-mapped I/O uses a separate I/O bus for communication. Each connected peripheral has one or more port numbers. To communicate with such an I/O port, there are special CPU instructions called <code>in</code> and <code>out</code>, which take a port number and a data byte (there are also variations of these commands that allow sending a <code>u16</code> or <code>u32</code>).</p>
<p>The <code>isa-debug-exit</code> device uses port-mapped I/O. The <code>iobase</code> parameter specifies on which port address the device should live (<code>0xf4</code> is a <a href="https://wiki.osdev.org/I/O_Ports#The_list">generally unused</a> port on the x86’s IO bus) and the <code>iosize</code> specifies the port size (<code>0x04</code> means four bytes).</p>
</section>
<section id="using-the-exit-device" class="level3">
<h3 class="anchored" data-anchor-id="using-the-exit-device">Using the Exit Device</h3>
<p>The functionality of the <code>isa-debug-exit</code> device is very simple. When a <code>value</code> is written to the I/O port specified by <code>iobase</code>, it causes QEMU to exit with <a href="https://en.wikipedia.org/wiki/Exit_status">exit status</a> <code>(value &lt;&lt; 1) | 1</code>. So when we write <code>0</code> to the port, QEMU will exit with exit status <code>(0 &lt;&lt; 1) | 1 = 1</code>, and when we write <code>1</code> to the port, it will exit with exit status <code>(1 &lt;&lt; 1) | 1 = 3</code>.</p>
<p>Instead of manually invoking the <code>in</code> and <code>out</code> assembly instructions, we use the abstractions provided by the <a href="https://docs.rs/x86_64/0.14.2/x86_64/"><code>x86_64</code></a> crate. To add a dependency on that crate, we add it to the <code>dependencies</code> section in our <code>Cargo.toml</code>:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode numberSource toml number-lines code-with-copy"><code class="sourceCode toml"><span id="cb28-1"><a href="#cb28-1"></a><span class="co"># in Cargo.toml</span></span>
<span id="cb28-2"><a href="#cb28-2"></a></span>
<span id="cb28-3"><a href="#cb28-3"></a><span class="kw">[dependencies]</span></span>
<span id="cb28-4"><a href="#cb28-4"></a><span class="dt">x86_64</span> <span class="op">=</span> <span class="st">"0.14.2"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now we can use the <a href="https://docs.rs/x86_64/0.14.2/x86_64/instructions/port/struct.Port.html"><code>Port</code></a> type provided by the crate to create an <code>exit_qemu</code> function:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode numberSource rust number-lines code-with-copy"><code class="sourceCode rust"><span id="cb29-1"><a href="#cb29-1"></a><span class="co">// in src/main.rs</span></span>
<span id="cb29-2"><a href="#cb29-2"></a></span>
<span id="cb29-3"><a href="#cb29-3"></a><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="op">,</span> <span class="bu">Clone</span><span class="op">,</span> <span class="bu">Copy</span><span class="op">,</span> <span class="bu">PartialEq</span><span class="op">,</span> <span class="bu">Eq</span><span class="at">)]</span></span>
<span id="cb29-4"><a href="#cb29-4"></a><span class="at">#[</span>repr<span class="at">(</span><span class="dt">u32</span><span class="at">)]</span></span>
<span id="cb29-5"><a href="#cb29-5"></a><span class="kw">pub</span> <span class="kw">enum</span> QemuExitCode <span class="op">{</span></span>
<span id="cb29-6"><a href="#cb29-6"></a>    <span class="cn">Success</span> <span class="op">=</span> <span class="dv">0x10</span><span class="op">,</span></span>
<span id="cb29-7"><a href="#cb29-7"></a>    Failed <span class="op">=</span> <span class="dv">0x11</span><span class="op">,</span></span>
<span id="cb29-8"><a href="#cb29-8"></a><span class="op">}</span></span>
<span id="cb29-9"><a href="#cb29-9"></a></span>
<span id="cb29-10"><a href="#cb29-10"></a><span class="kw">pub</span> <span class="kw">fn</span> exit_qemu(exit_code<span class="op">:</span> QemuExitCode) <span class="op">{</span></span>
<span id="cb29-11"><a href="#cb29-11"></a>    <span class="kw">use</span> <span class="pp">x86_64::instructions::port::</span>Port<span class="op">;</span></span>
<span id="cb29-12"><a href="#cb29-12"></a></span>
<span id="cb29-13"><a href="#cb29-13"></a>    <span class="kw">unsafe</span> <span class="op">{</span></span>
<span id="cb29-14"><a href="#cb29-14"></a>        <span class="kw">let</span> <span class="kw">mut</span> port <span class="op">=</span> <span class="pp">Port::</span>new(<span class="dv">0xf4</span>)<span class="op">;</span></span>
<span id="cb29-15"><a href="#cb29-15"></a>        port<span class="op">.</span>write(exit_code <span class="kw">as</span> <span class="dt">u32</span>)<span class="op">;</span></span>
<span id="cb29-16"><a href="#cb29-16"></a>    <span class="op">}</span></span>
<span id="cb29-17"><a href="#cb29-17"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The function creates a new <a href="https://docs.rs/x86_64/0.14.2/x86_64/instructions/port/struct.Port.html"><code>Port</code></a> at <code>0xf4</code>, which is the <code>iobase</code> of the <code>isa-debug-exit</code> device. Then it writes the passed exit code to the port. We use <code>u32</code> because we specified the <code>iosize</code> of the <code>isa-debug-exit</code> device as 4 bytes. Both operations are unsafe because writing to an I/O port can generally result in arbitrary behavior.</p>
<p>To specify the exit status, we create a <code>QemuExitCode</code> enum. The idea is to exit with the success exit code if all tests succeeded and with the failure exit code otherwise. The enum is marked as <code>#[repr(u32)]</code> to represent each variant by a <code>u32</code> integer. We use the exit code <code>0x10</code> for success and <code>0x11</code> for failure. The actual exit codes don’t matter much, as long as they don’t clash with the default exit codes of QEMU. For example, using exit code <code>0</code> for success is not a good idea because it becomes <code>(0 &lt;&lt; 1) | 1 = 1</code> after the transformation, which is the default exit code when QEMU fails to run. So we could not differentiate a QEMU error from a successful test run.</p>
<p>We can now update our <code>test_runner</code> to exit QEMU after all tests have run:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode numberSource rust number-lines code-with-copy"><code class="sourceCode rust"><span id="cb30-1"><a href="#cb30-1"></a><span class="co">// in src/main.rs</span></span>
<span id="cb30-2"><a href="#cb30-2"></a></span>
<span id="cb30-3"><a href="#cb30-3"></a><span class="kw">fn</span> test_runner(tests<span class="op">:</span> <span class="op">&amp;</span>[<span class="op">&amp;</span><span class="kw">dyn</span> <span class="bu">Fn</span>()]) <span class="op">{</span></span>
<span id="cb30-4"><a href="#cb30-4"></a>    <span class="pp">println!</span>(<span class="st">"Running {} tests"</span><span class="op">,</span> tests<span class="op">.</span>len())<span class="op">;</span></span>
<span id="cb30-5"><a href="#cb30-5"></a>    <span class="cf">for</span> test <span class="kw">in</span> tests <span class="op">{</span></span>
<span id="cb30-6"><a href="#cb30-6"></a>        test()<span class="op">;</span></span>
<span id="cb30-7"><a href="#cb30-7"></a>    <span class="op">}</span></span>
<span id="cb30-8"><a href="#cb30-8"></a>    <span class="co">/// new</span></span>
<span id="cb30-9"><a href="#cb30-9"></a>    exit_qemu(<span class="pp">QemuExitCode::</span><span class="cn">Success</span>)<span class="op">;</span></span>
<span id="cb30-10"><a href="#cb30-10"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>When we run <code>cargo test</code> now, we see that QEMU immediately closes after executing the tests. The problem is that <code>cargo test</code> interprets the test as failed even though we passed our <code>Success</code> exit code:</p>
<pre><code>&gt; cargo test
    Finished dev [unoptimized + debuginfo] target(s) in 0.03s
     Running target/x86_64-blog_os/debug/deps/blog_os-5804fc7d2dd4c9be
Building bootloader
   Compiling bootloader v0.5.3 (/home/philipp/Documents/bootloader)
    Finished release [optimized + debuginfo] target(s) in 1.07s
Running: `qemu-system-x86_64 -drive format=raw,file=/…/target/x86_64-blog_os/debug/
    deps/bootimage-blog_os-5804fc7d2dd4c9be.bin -device isa-debug-exit,iobase=0xf4,
    iosize=0x04`
error: test failed, to rerun pass '--bin blog_os'</code></pre>
<p>The problem is that <code>cargo test</code> considers all error codes other than <code>0</code> as failure.</p>
</section>
<section id="success-exit-code" class="level3">
<h3 class="anchored" data-anchor-id="success-exit-code">Success Exit Code</h3>
<p>To work around this, <code>bootimage</code> provides a <code>test-success-exit-code</code> configuration key that maps a specified exit code to the exit code <code>0</code>:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode numberSource toml number-lines code-with-copy"><code class="sourceCode toml"><span id="cb32-1"><a href="#cb32-1"></a><span class="co"># in Cargo.toml</span></span>
<span id="cb32-2"><a href="#cb32-2"></a></span>
<span id="cb32-3"><a href="#cb32-3"></a><span class="kw">[package.metadata.bootimage]</span></span>
<span id="cb32-4"><a href="#cb32-4"></a><span class="dt">test-args</span> <span class="op">=</span> <span class="op">[</span><span class="er">…</span><span class="op">]</span></span>
<span id="cb32-5"><a href="#cb32-5"></a><span class="dt">test-success-exit-code</span> <span class="op">=</span> <span class="dv">33</span>         <span class="co"># (0x10 &lt;&lt; 1) | 1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With this configuration, <code>bootimage</code> maps our success exit code to exit code 0, so that <code>cargo test</code> correctly recognizes the success case and does not count the test as failed.</p>
<p>Our test runner now automatically closes QEMU and correctly reports the test results. We still see the QEMU window open for a very short time, but it does not suffice to read the results. It would be nice if we could print the test results to the console instead, so we can still see them after QEMU exits.</p>
</section>
</section>
<section id="printing-to-the-console" class="level2">
<h2 class="anchored" data-anchor-id="printing-to-the-console">Printing to the Console</h2>
<p>To see the test output on the console, we need to send the data from our kernel to the host system somehow. There are various ways to achieve this, for example, by sending the data over a TCP network interface. However, setting up a networking stack is quite a complex task, so we will choose a simpler solution instead.</p>
<section id="serial-port" class="level3">
<h3 class="anchored" data-anchor-id="serial-port">Serial Port</h3>
<p>A simple way to send the data is to use the <a href="https://en.wikipedia.org/wiki/Serial_port">serial port</a>, an old interface standard which is no longer found in modern computers. It is easy to program and QEMU can redirect the bytes sent over serial to the host’s standard output or a file.</p>
<p>The chips implementing a serial interface are called <a href="https://en.wikipedia.org/wiki/Universal_asynchronous_receiver-transmitter">UARTs</a>. There are <a href="https://en.wikipedia.org/wiki/Universal_asynchronous_receiver-transmitter#Models">lots of UART models</a> on x86, but fortunately the only differences between them are some advanced features we don’t need. The common UARTs today are all compatible with the <a href="https://en.wikipedia.org/wiki/16550_UART">16550 UART</a>, so we will use that model for our testing framework.</p>
<p>We will use the <a href="https://docs.rs/uart_16550"><code>uart_16550</code></a> crate to initialize the UART and send data over the serial port. To add it as a dependency, we update our <code>Cargo.toml</code> and <code>main.rs</code>:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode numberSource toml number-lines code-with-copy"><code class="sourceCode toml"><span id="cb33-1"><a href="#cb33-1"></a><span class="co"># in Cargo.toml</span></span>
<span id="cb33-2"><a href="#cb33-2"></a></span>
<span id="cb33-3"><a href="#cb33-3"></a><span class="kw">[dependencies]</span></span>
<span id="cb33-4"><a href="#cb33-4"></a><span class="dt">uart_16550</span> <span class="op">=</span> <span class="st">"0.2.0"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>uart_16550</code> crate contains a <code>SerialPort</code> struct that represents the UART registers, but we still need to construct an instance of it ourselves. For that, we create a new <code>serial</code> module with the following content:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode numberSource rust number-lines code-with-copy"><code class="sourceCode rust"><span id="cb34-1"><a href="#cb34-1"></a><span class="co">// in src/main.rs</span></span>
<span id="cb34-2"><a href="#cb34-2"></a></span>
<span id="cb34-3"><a href="#cb34-3"></a><span class="kw">mod</span> serial<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb35"><pre class="sourceCode numberSource rust number-lines code-with-copy"><code class="sourceCode rust"><span id="cb35-1"><a href="#cb35-1"></a><span class="co">// in src/serial.rs</span></span>
<span id="cb35-2"><a href="#cb35-2"></a></span>
<span id="cb35-3"><a href="#cb35-3"></a><span class="kw">use</span> <span class="pp">uart_16550::</span>SerialPort<span class="op">;</span></span>
<span id="cb35-4"><a href="#cb35-4"></a><span class="kw">use</span> <span class="pp">spin::</span>Mutex<span class="op">;</span></span>
<span id="cb35-5"><a href="#cb35-5"></a><span class="kw">use</span> <span class="pp">lazy_static::</span>lazy_static<span class="op">;</span></span>
<span id="cb35-6"><a href="#cb35-6"></a></span>
<span id="cb35-7"><a href="#cb35-7"></a><span class="pp">lazy_static!</span> <span class="op">{</span></span>
<span id="cb35-8"><a href="#cb35-8"></a>    <span class="kw">pub</span> <span class="kw">static</span> <span class="kw">ref</span> SERIAL1<span class="op">:</span> Mutex<span class="op">&lt;</span>SerialPort<span class="op">&gt;</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb35-9"><a href="#cb35-9"></a>        <span class="kw">let</span> <span class="kw">mut</span> serial_port <span class="op">=</span> <span class="kw">unsafe</span> <span class="op">{</span> <span class="pp">SerialPort::</span>new(<span class="dv">0x3F8</span>) <span class="op">};</span></span>
<span id="cb35-10"><a href="#cb35-10"></a>        serial_port<span class="op">.</span>init()<span class="op">;</span></span>
<span id="cb35-11"><a href="#cb35-11"></a>        <span class="pp">Mutex::</span>new(serial_port)</span>
<span id="cb35-12"><a href="#cb35-12"></a>    <span class="op">};</span></span>
<span id="cb35-13"><a href="#cb35-13"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Like with the <a href="@/edition-2/posts/03-vga-text-buffer/index.md#lazy-statics">VGA text buffer</a>, we use <code>lazy_static</code> and a spinlock to create a <code>static</code> writer instance. By using <code>lazy_static</code> we can ensure that the <code>init</code> method is called exactly once on its first use.</p>
<p>Like the <code>isa-debug-exit</code> device, the UART is programmed using port I/O. Since the UART is more complex, it uses multiple I/O ports for programming different device registers. The unsafe <code>SerialPort::new</code> function expects the address of the first I/O port of the UART as an argument, from which it can calculate the addresses of all needed ports. We’re passing the port address <code>0x3F8</code>, which is the standard port number for the first serial interface.</p>
<p>To make the serial port easily usable, we add <code>serial_print!</code> and <code>serial_println!</code> macros:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode numberSource rust number-lines code-with-copy"><code class="sourceCode rust"><span id="cb36-1"><a href="#cb36-1"></a><span class="co">// in src/serial.rs</span></span>
<span id="cb36-2"><a href="#cb36-2"></a></span>
<span id="cb36-3"><a href="#cb36-3"></a><span class="at">#[</span>doc<span class="at">(</span>hidden<span class="at">)]</span></span>
<span id="cb36-4"><a href="#cb36-4"></a><span class="kw">pub</span> <span class="kw">fn</span> _print(args<span class="op">:</span> <span class="pp">::core::fmt::</span>Arguments) <span class="op">{</span></span>
<span id="cb36-5"><a href="#cb36-5"></a>    <span class="kw">use</span> <span class="pp">core::fmt::</span><span class="bu">Write</span><span class="op">;</span></span>
<span id="cb36-6"><a href="#cb36-6"></a>    SERIAL1<span class="op">.</span>lock()<span class="op">.</span>write_fmt(args)<span class="op">.</span>expect(<span class="st">"Printing to serial failed"</span>)<span class="op">;</span></span>
<span id="cb36-7"><a href="#cb36-7"></a><span class="op">}</span></span>
<span id="cb36-8"><a href="#cb36-8"></a></span>
<span id="cb36-9"><a href="#cb36-9"></a><span class="co">/// Prints to the host through the serial interface.</span></span>
<span id="cb36-10"><a href="#cb36-10"></a><span class="at">#[</span>macro_export<span class="at">]</span></span>
<span id="cb36-11"><a href="#cb36-11"></a><span class="pp">macro_rules!</span> serial_print <span class="op">{</span></span>
<span id="cb36-12"><a href="#cb36-12"></a>    (<span class="op">$</span>(<span class="op">$</span>arg<span class="op">:</span>tt)<span class="op">*</span>) <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb36-13"><a href="#cb36-13"></a>        <span class="op">$</span><span class="pp">crate::serial::</span>_print(<span class="pp">format_args!</span>(<span class="op">$</span>(<span class="op">$</span>arg)<span class="op">*</span>))<span class="op">;</span></span>
<span id="cb36-14"><a href="#cb36-14"></a>    <span class="op">};</span></span>
<span id="cb36-15"><a href="#cb36-15"></a><span class="op">}</span></span>
<span id="cb36-16"><a href="#cb36-16"></a></span>
<span id="cb36-17"><a href="#cb36-17"></a><span class="co">/// Prints to the host through the serial interface, appending a newline.</span></span>
<span id="cb36-18"><a href="#cb36-18"></a><span class="at">#[</span>macro_export<span class="at">]</span></span>
<span id="cb36-19"><a href="#cb36-19"></a><span class="pp">macro_rules!</span> serial_println <span class="op">{</span></span>
<span id="cb36-20"><a href="#cb36-20"></a>    () <span class="op">=&gt;</span> (<span class="op">$</span><span class="pp">crate::serial_print!</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>))<span class="op">;</span></span>
<span id="cb36-21"><a href="#cb36-21"></a>    (<span class="op">$</span>fmt<span class="op">:</span>expr) <span class="op">=&gt;</span> (<span class="op">$</span><span class="pp">crate::serial_print!</span>(<span class="pp">concat!</span>(<span class="op">$</span>fmt<span class="op">,</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)))<span class="op">;</span></span>
<span id="cb36-22"><a href="#cb36-22"></a>    (<span class="op">$</span>fmt<span class="op">:</span>expr<span class="op">,</span> <span class="op">$</span>(<span class="op">$</span>arg<span class="op">:</span>tt)<span class="op">*</span>) <span class="op">=&gt;</span> (<span class="op">$</span><span class="pp">crate::serial_print!</span>(</span>
<span id="cb36-23"><a href="#cb36-23"></a>        <span class="pp">concat!</span>(<span class="op">$</span>fmt<span class="op">,</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)<span class="op">,</span> <span class="op">$</span>(<span class="op">$</span>arg)<span class="op">*</span>))<span class="op">;</span></span>
<span id="cb36-24"><a href="#cb36-24"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The implementation is very similar to the implementation of our <code>print</code> and <code>println</code> macros. Since the <code>SerialPort</code> type already implements the <a href="https://doc.rust-lang.org/nightly/core/fmt/trait.Write.html"><code>fmt::Write</code></a> trait, we don’t need to provide our own implementation.</p>
<p>Now we can print to the serial interface instead of the VGA text buffer in our test code:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode numberSource rust number-lines code-with-copy"><code class="sourceCode rust"><span id="cb37-1"><a href="#cb37-1"></a><span class="co">// in src/main.rs</span></span>
<span id="cb37-2"><a href="#cb37-2"></a></span>
<span id="cb37-3"><a href="#cb37-3"></a><span class="at">#[</span>cfg<span class="at">(</span>test<span class="at">)]</span></span>
<span id="cb37-4"><a href="#cb37-4"></a><span class="kw">fn</span> test_runner(tests<span class="op">:</span> <span class="op">&amp;</span>[<span class="op">&amp;</span><span class="kw">dyn</span> <span class="bu">Fn</span>()]) <span class="op">{</span></span>
<span id="cb37-5"><a href="#cb37-5"></a>    <span class="pp">serial_println!</span>(<span class="st">"Running {} tests"</span><span class="op">,</span> tests<span class="op">.</span>len())<span class="op">;</span></span>
<span id="cb37-6"><a href="#cb37-6"></a>    […]</span>
<span id="cb37-7"><a href="#cb37-7"></a><span class="op">}</span></span>
<span id="cb37-8"><a href="#cb37-8"></a></span>
<span id="cb37-9"><a href="#cb37-9"></a><span class="at">#[</span>test_case<span class="at">]</span></span>
<span id="cb37-10"><a href="#cb37-10"></a><span class="kw">fn</span> trivial_assertion() <span class="op">{</span></span>
<span id="cb37-11"><a href="#cb37-11"></a>    <span class="pp">serial_print!</span>(<span class="st">"trivial assertion... "</span>)<span class="op">;</span></span>
<span id="cb37-12"><a href="#cb37-12"></a>    <span class="pp">assert_eq!</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb37-13"><a href="#cb37-13"></a>    <span class="pp">serial_println!</span>(<span class="st">"[ok]"</span>)<span class="op">;</span></span>
<span id="cb37-14"><a href="#cb37-14"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Note that the <code>serial_println</code> macro lives directly under the root namespace because we used the <code>#[macro_export]</code> attribute, so importing it through <code>use crate::serial::serial_println</code> will not work.</p>
</section>
<section id="qemu-arguments" class="level3">
<h3 class="anchored" data-anchor-id="qemu-arguments">QEMU Arguments</h3>
<p>To see the serial output from QEMU, we need to use the <code>-serial</code> argument to redirect the output to stdout:</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode numberSource toml number-lines code-with-copy"><code class="sourceCode toml"><span id="cb38-1"><a href="#cb38-1"></a><span class="co"># in Cargo.toml</span></span>
<span id="cb38-2"><a href="#cb38-2"></a></span>
<span id="cb38-3"><a href="#cb38-3"></a><span class="kw">[package.metadata.bootimage]</span></span>
<span id="cb38-4"><a href="#cb38-4"></a><span class="dt">test-args</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb38-5"><a href="#cb38-5"></a>    <span class="st">"-device"</span><span class="op">,</span> <span class="st">"isa-debug-exit,iobase=0xf4,iosize=0x04"</span><span class="op">,</span> <span class="st">"-serial"</span><span class="op">,</span> <span class="st">"stdio"</span></span>
<span id="cb38-6"><a href="#cb38-6"></a><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>When we run <code>cargo test</code> now, we see the test output directly in the console:</p>
<pre><code>&gt; cargo test
    Finished dev [unoptimized + debuginfo] target(s) in 0.02s
     Running target/x86_64-blog_os/debug/deps/blog_os-7b7c37b4ad62551a
Building bootloader
    Finished release [optimized + debuginfo] target(s) in 0.02s
Running: `qemu-system-x86_64 -drive format=raw,file=/…/target/x86_64-blog_os/debug/
    deps/bootimage-blog_os-7b7c37b4ad62551a.bin -device
    isa-debug-exit,iobase=0xf4,iosize=0x04 -serial stdio`
Running 1 tests
trivial assertion... [ok]</code></pre>
<p>However, when a test fails, we still see the output inside QEMU because our panic handler still uses <code>println</code>. To simulate this, we can change the assertion in our <code>trivial_assertion</code> test to <code>assert_eq!(0, 1)</code>:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="qemu-failed-test.png" class="img-fluid figure-img"></p>
<figcaption>QEMU printing “Hello World!” and “panicked at ‘assertion failed: <code>(left == right)</code> left: <code>0</code>, right: <code>1</code>’, src/main.rs:55:5</figcaption>
</figure>
</div>
<p>We see that the panic message is still printed to the VGA buffer, while the other test output is printed to the serial port. The panic message is quite useful, so it would be useful to see it in the console too.</p>
</section>
<section id="print-an-error-message-on-panic" class="level3">
<h3 class="anchored" data-anchor-id="print-an-error-message-on-panic">Print an Error Message on Panic</h3>
<p>To exit QEMU with an error message on a panic, we can use <a href="https://doc.rust-lang.org/1.30.0/book/first-edition/conditional-compilation.html">conditional compilation</a> to use a different panic handler in testing mode:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode numberSource rust number-lines code-with-copy"><code class="sourceCode rust"><span id="cb40-1"><a href="#cb40-1"></a><span class="co">// in src/main.rs</span></span>
<span id="cb40-2"><a href="#cb40-2"></a></span>
<span id="cb40-3"><a href="#cb40-3"></a><span class="co">// our existing panic handler</span></span>
<span id="cb40-4"><a href="#cb40-4"></a><span class="at">#[</span>cfg<span class="at">(</span>not<span class="at">(</span>test<span class="at">))]</span> <span class="co">// new attribute</span></span>
<span id="cb40-5"><a href="#cb40-5"></a><span class="at">#[</span>panic_handler<span class="at">]</span></span>
<span id="cb40-6"><a href="#cb40-6"></a><span class="kw">fn</span> panic(info<span class="op">:</span> <span class="op">&amp;</span>PanicInfo) <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb40-7"><a href="#cb40-7"></a>    <span class="pp">println!</span>(<span class="st">"{}"</span><span class="op">,</span> info)<span class="op">;</span></span>
<span id="cb40-8"><a href="#cb40-8"></a>    <span class="cf">loop</span> <span class="op">{}</span></span>
<span id="cb40-9"><a href="#cb40-9"></a><span class="op">}</span></span>
<span id="cb40-10"><a href="#cb40-10"></a></span>
<span id="cb40-11"><a href="#cb40-11"></a><span class="co">// our panic handler in test mode</span></span>
<span id="cb40-12"><a href="#cb40-12"></a><span class="at">#[</span>cfg<span class="at">(</span>test<span class="at">)]</span></span>
<span id="cb40-13"><a href="#cb40-13"></a><span class="at">#[</span>panic_handler<span class="at">]</span></span>
<span id="cb40-14"><a href="#cb40-14"></a><span class="kw">fn</span> panic(info<span class="op">:</span> <span class="op">&amp;</span>PanicInfo) <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb40-15"><a href="#cb40-15"></a>    <span class="pp">serial_println!</span>(<span class="st">"[failed]</span><span class="sc">\n</span><span class="st">"</span>)<span class="op">;</span></span>
<span id="cb40-16"><a href="#cb40-16"></a>    <span class="pp">serial_println!</span>(<span class="st">"Error: {}</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> info)<span class="op">;</span></span>
<span id="cb40-17"><a href="#cb40-17"></a>    exit_qemu(<span class="pp">QemuExitCode::</span>Failed)<span class="op">;</span></span>
<span id="cb40-18"><a href="#cb40-18"></a>    <span class="cf">loop</span> <span class="op">{}</span></span>
<span id="cb40-19"><a href="#cb40-19"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>For our test panic handler, we use <code>serial_println</code> instead of <code>println</code> and then exit QEMU with a failure exit code. Note that we still need an endless <code>loop</code> after the <code>exit_qemu</code> call because the compiler does not know that the <code>isa-debug-exit</code> device causes a program exit.</p>
<p>Now QEMU also exits for failed tests and prints a useful error message on the console:</p>
<pre><code>&gt; cargo test
    Finished dev [unoptimized + debuginfo] target(s) in 0.02s
     Running target/x86_64-blog_os/debug/deps/blog_os-7b7c37b4ad62551a
Building bootloader
    Finished release [optimized + debuginfo] target(s) in 0.02s
Running: `qemu-system-x86_64 -drive format=raw,file=/…/target/x86_64-blog_os/debug/
    deps/bootimage-blog_os-7b7c37b4ad62551a.bin -device
    isa-debug-exit,iobase=0xf4,iosize=0x04 -serial stdio`
Running 1 tests
trivial assertion... [failed]

Error: panicked at 'assertion failed: `(left == right)`
  left: `0`,
 right: `1`', src/main.rs:65:5</code></pre>
<p>Since we see all test output on the console now, we no longer need the QEMU window that pops up for a short time. So we can hide it completely.</p>
</section>
<section id="hiding-qemu" class="level3">
<h3 class="anchored" data-anchor-id="hiding-qemu">Hiding QEMU</h3>
<p>Since we report out the complete test results using the <code>isa-debug-exit</code> device and the serial port, we don’t need the QEMU window anymore. We can hide it by passing the <code>-display none</code> argument to QEMU:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode numberSource toml number-lines code-with-copy"><code class="sourceCode toml"><span id="cb42-1"><a href="#cb42-1"></a><span class="co"># in Cargo.toml</span></span>
<span id="cb42-2"><a href="#cb42-2"></a></span>
<span id="cb42-3"><a href="#cb42-3"></a><span class="kw">[package.metadata.bootimage]</span></span>
<span id="cb42-4"><a href="#cb42-4"></a><span class="dt">test-args</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb42-5"><a href="#cb42-5"></a>    <span class="st">"-device"</span><span class="op">,</span> <span class="st">"isa-debug-exit,iobase=0xf4,iosize=0x04"</span><span class="op">,</span> <span class="st">"-serial"</span><span class="op">,</span> <span class="st">"stdio"</span><span class="op">,</span></span>
<span id="cb42-6"><a href="#cb42-6"></a>    <span class="st">"-display"</span><span class="op">,</span> <span class="st">"none"</span></span>
<span id="cb42-7"><a href="#cb42-7"></a><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now QEMU runs completely in the background and no window gets opened anymore. This is not only less annoying, but also allows our test framework to run in environments without a graphical user interface, such as CI services or <a href="https://en.wikipedia.org/wiki/Secure_Shell">SSH</a> connections.</p>
</section>
<section id="timeouts" class="level3">
<h3 class="anchored" data-anchor-id="timeouts">Timeouts</h3>
<p>Since <code>cargo test</code> waits until the test runner exits, a test that never returns can block the test runner forever. That’s unfortunate, but not a big problem in practice since it’s usually easy to avoid endless loops. In our case, however, endless loops can occur in various situations:</p>
<ul>
<li>The bootloader fails to load our kernel, which causes the system to reboot endlessly.</li>
<li>The BIOS/UEFI firmware fails to load the bootloader, which causes the same endless rebooting.</li>
<li>The CPU enters a <code>loop {}</code> statement at the end of some of our functions, for example because the QEMU exit device doesn’t work properly.</li>
<li>The hardware causes a system reset, for example when a CPU exception is not caught (explained in a future post).</li>
</ul>
<p>Since endless loops can occur in so many situations, the <code>bootimage</code> tool sets a timeout of 5 minutes for each test executable by default. If the test does not finish within this time, it is marked as failed and a “Timed Out” error is printed to the console. This feature ensures that tests that are stuck in an endless loop don’t block <code>cargo test</code> forever.</p>
<p>You can try it yourself by adding a <code>loop {}</code> statement in the <code>trivial_assertion</code> test. When you run <code>cargo test</code>, you see that the test is marked as timed out after 5 minutes. The timeout duration is <a href="https://github.com/rust-osdev/bootimage#configuration">configurable</a> through a <code>test-timeout</code> key in the Cargo.toml:</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode numberSource toml number-lines code-with-copy"><code class="sourceCode toml"><span id="cb43-1"><a href="#cb43-1"></a><span class="co"># in Cargo.toml</span></span>
<span id="cb43-2"><a href="#cb43-2"></a></span>
<span id="cb43-3"><a href="#cb43-3"></a><span class="kw">[package.metadata.bootimage]</span></span>
<span id="cb43-4"><a href="#cb43-4"></a><span class="dt">test-timeout</span> <span class="op">=</span> <span class="dv">300</span>          <span class="co"># (in seconds)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If you don’t want to wait 5 minutes for the <code>trivial_assertion</code> test to time out, you can temporarily decrease the above value.</p>
</section>
<section id="insert-printing-automatically" class="level3">
<h3 class="anchored" data-anchor-id="insert-printing-automatically">Insert Printing Automatically</h3>
<p>Our <code>trivial_assertion</code> test currently needs to print its own status information using <code>serial_print!</code>/<code>serial_println!</code>:</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode numberSource rust number-lines code-with-copy"><code class="sourceCode rust"><span id="cb44-1"><a href="#cb44-1"></a><span class="at">#[</span>test_case<span class="at">]</span></span>
<span id="cb44-2"><a href="#cb44-2"></a><span class="kw">fn</span> trivial_assertion() <span class="op">{</span></span>
<span id="cb44-3"><a href="#cb44-3"></a>    <span class="pp">serial_print!</span>(<span class="st">"trivial assertion... "</span>)<span class="op">;</span></span>
<span id="cb44-4"><a href="#cb44-4"></a>    <span class="pp">assert_eq!</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb44-5"><a href="#cb44-5"></a>    <span class="pp">serial_println!</span>(<span class="st">"[ok]"</span>)<span class="op">;</span></span>
<span id="cb44-6"><a href="#cb44-6"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Manually adding these print statements for every test we write is cumbersome, so let’s update our <code>test_runner</code> to print these messages automatically. To do that, we need to create a new <code>Testable</code> trait:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode numberSource rust number-lines code-with-copy"><code class="sourceCode rust"><span id="cb45-1"><a href="#cb45-1"></a><span class="co">// in src/main.rs</span></span>
<span id="cb45-2"><a href="#cb45-2"></a></span>
<span id="cb45-3"><a href="#cb45-3"></a><span class="kw">pub</span> <span class="kw">trait</span> Testable <span class="op">{</span></span>
<span id="cb45-4"><a href="#cb45-4"></a>    <span class="kw">fn</span> run(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> ()<span class="op">;</span></span>
<span id="cb45-5"><a href="#cb45-5"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The trick now is to implement this trait for all types <code>T</code> that implement the <a href="https://doc.rust-lang.org/stable/core/ops/trait.Fn.html"><code>Fn()</code> trait</a>:</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode numberSource rust number-lines code-with-copy"><code class="sourceCode rust"><span id="cb46-1"><a href="#cb46-1"></a><span class="co">// in src/main.rs</span></span>
<span id="cb46-2"><a href="#cb46-2"></a></span>
<span id="cb46-3"><a href="#cb46-3"></a><span class="kw">impl</span><span class="op">&lt;</span>T<span class="op">&gt;</span> Testable <span class="cf">for</span> T</span>
<span id="cb46-4"><a href="#cb46-4"></a><span class="kw">where</span></span>
<span id="cb46-5"><a href="#cb46-5"></a>    T<span class="op">:</span> <span class="bu">Fn</span>()<span class="op">,</span></span>
<span id="cb46-6"><a href="#cb46-6"></a><span class="op">{</span></span>
<span id="cb46-7"><a href="#cb46-7"></a>    <span class="kw">fn</span> run(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">{</span></span>
<span id="cb46-8"><a href="#cb46-8"></a>        <span class="pp">serial_print!</span>(<span class="st">"{}...</span><span class="sc">\t</span><span class="st">"</span><span class="op">,</span> <span class="pp">core::any::type_name::</span><span class="op">&lt;</span>T<span class="op">&gt;</span>())<span class="op">;</span></span>
<span id="cb46-9"><a href="#cb46-9"></a>        <span class="kw">self</span>()<span class="op">;</span></span>
<span id="cb46-10"><a href="#cb46-10"></a>        <span class="pp">serial_println!</span>(<span class="st">"[ok]"</span>)<span class="op">;</span></span>
<span id="cb46-11"><a href="#cb46-11"></a>    <span class="op">}</span></span>
<span id="cb46-12"><a href="#cb46-12"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We implement the <code>run</code> function by first printing the function name using the <a href="https://doc.rust-lang.org/stable/core/any/fn.type_name.html"><code>any::type_name</code></a> function. This function is implemented directly in the compiler and returns a string description of every type. For functions, the type is their name, so this is exactly what we want in this case. The <code>\t</code> character is the <a href="https://en.wikipedia.org/wiki/Tab_character">tab character</a>, which adds some alignment to the <code>[ok]</code> messages.</p>
<p>After printing the function name, we invoke the test function through <code>self()</code>. This only works because we require that <code>self</code> implements the <code>Fn()</code> trait. After the test function returns, we print <code>[ok]</code> to indicate that the function did not panic.</p>
<p>The last step is to update our <code>test_runner</code> to use the new <code>Testable</code> trait:</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode numberSource rust number-lines code-with-copy"><code class="sourceCode rust"><span id="cb47-1"><a href="#cb47-1"></a><span class="co">// in src/main.rs</span></span>
<span id="cb47-2"><a href="#cb47-2"></a></span>
<span id="cb47-3"><a href="#cb47-3"></a><span class="at">#[</span>cfg<span class="at">(</span>test<span class="at">)]</span></span>
<span id="cb47-4"><a href="#cb47-4"></a><span class="kw">pub</span> <span class="kw">fn</span> test_runner(tests<span class="op">:</span> <span class="op">&amp;</span>[<span class="op">&amp;</span><span class="kw">dyn</span> Testable]) <span class="op">{</span> <span class="co">// new</span></span>
<span id="cb47-5"><a href="#cb47-5"></a>    <span class="pp">serial_println!</span>(<span class="st">"Running {} tests"</span><span class="op">,</span> tests<span class="op">.</span>len())<span class="op">;</span></span>
<span id="cb47-6"><a href="#cb47-6"></a>    <span class="cf">for</span> test <span class="kw">in</span> tests <span class="op">{</span></span>
<span id="cb47-7"><a href="#cb47-7"></a>        test<span class="op">.</span>run()<span class="op">;</span> <span class="co">// new</span></span>
<span id="cb47-8"><a href="#cb47-8"></a>    <span class="op">}</span></span>
<span id="cb47-9"><a href="#cb47-9"></a>    exit_qemu(<span class="pp">QemuExitCode::</span><span class="cn">Success</span>)<span class="op">;</span></span>
<span id="cb47-10"><a href="#cb47-10"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The only two changes are the type of the <code>tests</code> argument from <code>&amp;[&amp;dyn Fn()]</code> to <code>&amp;[&amp;dyn Testable]</code> and the fact that we now call <code>test.run()</code> instead of <code>test()</code>.</p>
<p>We can now remove the print statements from our <code>trivial_assertion</code> test since they’re now printed automatically:</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode numberSource rust number-lines code-with-copy"><code class="sourceCode rust"><span id="cb48-1"><a href="#cb48-1"></a><span class="co">// in src/main.rs</span></span>
<span id="cb48-2"><a href="#cb48-2"></a></span>
<span id="cb48-3"><a href="#cb48-3"></a><span class="at">#[</span>test_case<span class="at">]</span></span>
<span id="cb48-4"><a href="#cb48-4"></a><span class="kw">fn</span> trivial_assertion() <span class="op">{</span></span>
<span id="cb48-5"><a href="#cb48-5"></a>    <span class="pp">assert_eq!</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb48-6"><a href="#cb48-6"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>cargo test</code> output now looks like this:</p>
<pre><code>Running 1 tests
blog_os::trivial_assertion...   [ok]</code></pre>
<p>The function name now includes the full path to the function, which is useful when test functions in different modules have the same name. Otherwise, the output looks the same as before, but we no longer need to add print statements to our tests manually.</p>
</section>
</section>
<section id="testing-the-vga-buffer" class="level2">
<h2 class="anchored" data-anchor-id="testing-the-vga-buffer">Testing the VGA Buffer</h2>
<p>Now that we have a working test framework, we can create a few tests for our VGA buffer implementation. First, we create a very simple test to verify that <code>println</code> works without panicking:</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode numberSource rust number-lines code-with-copy"><code class="sourceCode rust"><span id="cb50-1"><a href="#cb50-1"></a><span class="co">// in src/vga_buffer.rs</span></span>
<span id="cb50-2"><a href="#cb50-2"></a></span>
<span id="cb50-3"><a href="#cb50-3"></a><span class="at">#[</span>test_case<span class="at">]</span></span>
<span id="cb50-4"><a href="#cb50-4"></a><span class="kw">fn</span> test_println_simple() <span class="op">{</span></span>
<span id="cb50-5"><a href="#cb50-5"></a>    <span class="pp">println!</span>(<span class="st">"test_println_simple output"</span>)<span class="op">;</span></span>
<span id="cb50-6"><a href="#cb50-6"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The test just prints something to the VGA buffer. If it finishes without panicking, it means that the <code>println</code> invocation did not panic either.</p>
<p>To ensure that no panic occurs even if many lines are printed and lines are shifted off the screen, we can create another test:</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode numberSource rust number-lines code-with-copy"><code class="sourceCode rust"><span id="cb51-1"><a href="#cb51-1"></a><span class="co">// in src/vga_buffer.rs</span></span>
<span id="cb51-2"><a href="#cb51-2"></a></span>
<span id="cb51-3"><a href="#cb51-3"></a><span class="at">#[</span>test_case<span class="at">]</span></span>
<span id="cb51-4"><a href="#cb51-4"></a><span class="kw">fn</span> test_println_many() <span class="op">{</span></span>
<span id="cb51-5"><a href="#cb51-5"></a>    <span class="cf">for</span> _ <span class="kw">in</span> <span class="dv">0</span><span class="op">..</span><span class="dv">200</span> <span class="op">{</span></span>
<span id="cb51-6"><a href="#cb51-6"></a>        <span class="pp">println!</span>(<span class="st">"test_println_many output"</span>)<span class="op">;</span></span>
<span id="cb51-7"><a href="#cb51-7"></a>    <span class="op">}</span></span>
<span id="cb51-8"><a href="#cb51-8"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We can also create a test function to verify that the printed lines really appear on the screen:</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode numberSource rust number-lines code-with-copy"><code class="sourceCode rust"><span id="cb52-1"><a href="#cb52-1"></a><span class="co">// in src/vga_buffer.rs</span></span>
<span id="cb52-2"><a href="#cb52-2"></a></span>
<span id="cb52-3"><a href="#cb52-3"></a><span class="at">#[</span>test_case<span class="at">]</span></span>
<span id="cb52-4"><a href="#cb52-4"></a><span class="kw">fn</span> test_println_output() <span class="op">{</span></span>
<span id="cb52-5"><a href="#cb52-5"></a>    <span class="kw">let</span> s <span class="op">=</span> <span class="st">"Some test string that fits on a single line"</span><span class="op">;</span></span>
<span id="cb52-6"><a href="#cb52-6"></a>    <span class="pp">println!</span>(<span class="st">"{}"</span><span class="op">,</span> s)<span class="op">;</span></span>
<span id="cb52-7"><a href="#cb52-7"></a>    <span class="cf">for</span> (i<span class="op">,</span> c) <span class="kw">in</span> s<span class="op">.</span>chars()<span class="op">.</span>enumerate() <span class="op">{</span></span>
<span id="cb52-8"><a href="#cb52-8"></a>        <span class="kw">let</span> screen_char <span class="op">=</span> WRITER<span class="op">.</span>lock()<span class="op">.</span>buffer<span class="op">.</span>chars[BUFFER_HEIGHT <span class="op">-</span> <span class="dv">2</span>][i]<span class="op">.</span>read()<span class="op">;</span></span>
<span id="cb52-9"><a href="#cb52-9"></a>        <span class="pp">assert_eq!</span>(<span class="dt">char</span><span class="pp">::</span>from(screen_char<span class="op">.</span>ascii_character)<span class="op">,</span> c)<span class="op">;</span></span>
<span id="cb52-10"><a href="#cb52-10"></a>    <span class="op">}</span></span>
<span id="cb52-11"><a href="#cb52-11"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The function defines a test string, prints it using <code>println</code>, and then iterates over the screen characters of the static <code>WRITER</code>, which represents the VGA text buffer. Since <code>println</code> prints to the last screen line and then immediately appends a newline, the string should appear on line <code>BUFFER_HEIGHT - 2</code>.</p>
<p>By using <a href="https://doc.rust-lang.org/core/iter/trait.Iterator.html#method.enumerate"><code>enumerate</code></a>, we count the number of iterations in the variable <code>i</code>, which we then use for loading the screen character corresponding to <code>c</code>. By comparing the <code>ascii_character</code> of the screen character with <code>c</code>, we ensure that each character of the string really appears in the VGA text buffer.</p>
<p>As you can imagine, we could create many more test functions. For example, a function that tests that no panic occurs when printing very long lines and that they’re wrapped correctly, or a function for testing that newlines, non-printable characters, and non-unicode characters are handled correctly.</p>
<p>For the rest of this post, however, we will explain how to create <em>integration tests</em> to test the interaction of different components together.</p>
</section>
<section id="integration-tests" class="level2">
<h2 class="anchored" data-anchor-id="integration-tests">Integration Tests</h2>
<p>The convention for <a href="https://doc.rust-lang.org/book/ch11-03-test-organization.html#integration-tests">integration tests</a> in Rust is to put them into a <code>tests</code> directory in the project root (i.e., next to the <code>src</code> directory). Both the default test framework and custom test frameworks will automatically pick up and execute all tests in that directory.</p>
<p>All integration tests are their own executables and completely separate from our <code>main.rs</code>. This means that each test needs to define its own entry point function. Let’s create an example integration test named <code>basic_boot</code> to see how it works in detail:</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode numberSource rust number-lines code-with-copy"><code class="sourceCode rust"><span id="cb53-1"><a href="#cb53-1"></a><span class="co">// in tests/basic_boot.rs</span></span>
<span id="cb53-2"><a href="#cb53-2"></a></span>
<span id="cb53-3"><a href="#cb53-3"></a><span class="at">#![</span>no_std<span class="at">]</span></span>
<span id="cb53-4"><a href="#cb53-4"></a><span class="at">#![</span>no_main<span class="at">]</span></span>
<span id="cb53-5"><a href="#cb53-5"></a><span class="at">#![</span>feature<span class="at">(</span>custom_test_frameworks<span class="at">)]</span></span>
<span id="cb53-6"><a href="#cb53-6"></a><span class="at">#![</span>test_runner<span class="at">(</span><span class="kw">crate</span><span class="pp">::</span>test_runner<span class="at">)]</span></span>
<span id="cb53-7"><a href="#cb53-7"></a><span class="at">#![</span>reexport_test_harness_main <span class="op">=</span> <span class="st">"test_main"</span><span class="at">]</span></span>
<span id="cb53-8"><a href="#cb53-8"></a></span>
<span id="cb53-9"><a href="#cb53-9"></a><span class="kw">use</span> <span class="pp">core::panic::</span>PanicInfo<span class="op">;</span></span>
<span id="cb53-10"><a href="#cb53-10"></a></span>
<span id="cb53-11"><a href="#cb53-11"></a><span class="at">#[</span><span class="kw">unsafe</span><span class="at">(</span>no_mangle<span class="at">)]</span> <span class="co">// don't mangle the name of this function</span></span>
<span id="cb53-12"><a href="#cb53-12"></a><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">"C"</span> <span class="kw">fn</span> _start() <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb53-13"><a href="#cb53-13"></a>    test_main()<span class="op">;</span></span>
<span id="cb53-14"><a href="#cb53-14"></a></span>
<span id="cb53-15"><a href="#cb53-15"></a>    <span class="cf">loop</span> <span class="op">{}</span></span>
<span id="cb53-16"><a href="#cb53-16"></a><span class="op">}</span></span>
<span id="cb53-17"><a href="#cb53-17"></a></span>
<span id="cb53-18"><a href="#cb53-18"></a><span class="kw">fn</span> test_runner(tests<span class="op">:</span> <span class="op">&amp;</span>[<span class="op">&amp;</span><span class="kw">dyn</span> <span class="bu">Fn</span>()]) <span class="op">{</span></span>
<span id="cb53-19"><a href="#cb53-19"></a>    <span class="pp">unimplemented!</span>()<span class="op">;</span></span>
<span id="cb53-20"><a href="#cb53-20"></a><span class="op">}</span></span>
<span id="cb53-21"><a href="#cb53-21"></a></span>
<span id="cb53-22"><a href="#cb53-22"></a><span class="at">#[</span>panic_handler<span class="at">]</span></span>
<span id="cb53-23"><a href="#cb53-23"></a><span class="kw">fn</span> panic(info<span class="op">:</span> <span class="op">&amp;</span>PanicInfo) <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb53-24"><a href="#cb53-24"></a>    <span class="cf">loop</span> <span class="op">{}</span></span>
<span id="cb53-25"><a href="#cb53-25"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Since integration tests are separate executables, we need to provide all the crate attributes (<code>no_std</code>, <code>no_main</code>, <code>test_runner</code>, etc.) again. We also need to create a new entry point function <code>_start</code>, which calls the test entry point function <code>test_main</code>. We don’t need any <code>cfg(test)</code> attributes because integration test executables are never built in non-test mode.</p>
<p>We use the <a href="https://doc.rust-lang.org/core/macro.unimplemented.html"><code>unimplemented</code></a> macro that always panics as a placeholder for the <code>test_runner</code> function and just <code>loop</code> in the <code>panic</code> handler for now. Ideally, we want to implement these functions exactly as we did in our <code>main.rs</code> using the <code>serial_println</code> macro and the <code>exit_qemu</code> function. The problem is that we don’t have access to these functions since tests are built completely separately from our <code>main.rs</code> executable.</p>
<p>If you run <code>cargo test</code> at this stage, you will get an endless loop because the panic handler loops endlessly. You need to use the <code>ctrl+c</code> keyboard shortcut for exiting QEMU.</p>
<section id="create-a-library" class="level3">
<h3 class="anchored" data-anchor-id="create-a-library">Create a Library</h3>
<p>To make the required functions available to our integration test, we need to split off a library from our <code>main.rs</code>, which can be included by other crates and integration test executables. To do this, we create a new <code>src/lib.rs</code> file:</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode numberSource rust number-lines code-with-copy"><code class="sourceCode rust"><span id="cb54-1"><a href="#cb54-1"></a><span class="co">// src/lib.rs</span></span>
<span id="cb54-2"><a href="#cb54-2"></a></span>
<span id="cb54-3"><a href="#cb54-3"></a><span class="at">#![</span>no_std<span class="at">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Like the <code>main.rs</code>, the <code>lib.rs</code> is a special file that is automatically recognized by cargo. The library is a separate compilation unit, so we need to specify the <code>#![no_std]</code> attribute again.</p>
<p>To make our library work with <code>cargo test</code>, we need to also move the test functions and attributes from <code>main.rs</code> to <code>lib.rs</code>:</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode numberSource rust number-lines code-with-copy"><code class="sourceCode rust"><span id="cb55-1"><a href="#cb55-1"></a><span class="co">// in src/lib.rs</span></span>
<span id="cb55-2"><a href="#cb55-2"></a></span>
<span id="cb55-3"><a href="#cb55-3"></a><span class="at">#![</span>cfg_attr<span class="at">(</span>test<span class="op">,</span> no_main<span class="at">)]</span></span>
<span id="cb55-4"><a href="#cb55-4"></a><span class="at">#![</span>feature<span class="at">(</span>custom_test_frameworks<span class="at">)]</span></span>
<span id="cb55-5"><a href="#cb55-5"></a><span class="at">#![</span>test_runner<span class="at">(</span><span class="kw">crate</span><span class="pp">::</span>test_runner<span class="at">)]</span></span>
<span id="cb55-6"><a href="#cb55-6"></a><span class="at">#![</span>reexport_test_harness_main <span class="op">=</span> <span class="st">"test_main"</span><span class="at">]</span></span>
<span id="cb55-7"><a href="#cb55-7"></a></span>
<span id="cb55-8"><a href="#cb55-8"></a><span class="kw">use</span> <span class="pp">core::panic::</span>PanicInfo<span class="op">;</span></span>
<span id="cb55-9"><a href="#cb55-9"></a></span>
<span id="cb55-10"><a href="#cb55-10"></a><span class="kw">pub</span> <span class="kw">trait</span> Testable <span class="op">{</span></span>
<span id="cb55-11"><a href="#cb55-11"></a>    <span class="kw">fn</span> run(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> ()<span class="op">;</span></span>
<span id="cb55-12"><a href="#cb55-12"></a><span class="op">}</span></span>
<span id="cb55-13"><a href="#cb55-13"></a></span>
<span id="cb55-14"><a href="#cb55-14"></a><span class="kw">impl</span><span class="op">&lt;</span>T<span class="op">&gt;</span> Testable <span class="cf">for</span> T</span>
<span id="cb55-15"><a href="#cb55-15"></a><span class="kw">where</span></span>
<span id="cb55-16"><a href="#cb55-16"></a>    T<span class="op">:</span> <span class="bu">Fn</span>()<span class="op">,</span></span>
<span id="cb55-17"><a href="#cb55-17"></a><span class="op">{</span></span>
<span id="cb55-18"><a href="#cb55-18"></a>    <span class="kw">fn</span> run(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">{</span></span>
<span id="cb55-19"><a href="#cb55-19"></a>        <span class="pp">serial_print!</span>(<span class="st">"{}...</span><span class="sc">\t</span><span class="st">"</span><span class="op">,</span> <span class="pp">core::any::type_name::</span><span class="op">&lt;</span>T<span class="op">&gt;</span>())<span class="op">;</span></span>
<span id="cb55-20"><a href="#cb55-20"></a>        <span class="kw">self</span>()<span class="op">;</span></span>
<span id="cb55-21"><a href="#cb55-21"></a>        <span class="pp">serial_println!</span>(<span class="st">"[ok]"</span>)<span class="op">;</span></span>
<span id="cb55-22"><a href="#cb55-22"></a>    <span class="op">}</span></span>
<span id="cb55-23"><a href="#cb55-23"></a><span class="op">}</span></span>
<span id="cb55-24"><a href="#cb55-24"></a></span>
<span id="cb55-25"><a href="#cb55-25"></a><span class="kw">pub</span> <span class="kw">fn</span> test_runner(tests<span class="op">:</span> <span class="op">&amp;</span>[<span class="op">&amp;</span><span class="kw">dyn</span> Testable]) <span class="op">{</span></span>
<span id="cb55-26"><a href="#cb55-26"></a>    <span class="pp">serial_println!</span>(<span class="st">"Running {} tests"</span><span class="op">,</span> tests<span class="op">.</span>len())<span class="op">;</span></span>
<span id="cb55-27"><a href="#cb55-27"></a>    <span class="cf">for</span> test <span class="kw">in</span> tests <span class="op">{</span></span>
<span id="cb55-28"><a href="#cb55-28"></a>        test<span class="op">.</span>run()<span class="op">;</span></span>
<span id="cb55-29"><a href="#cb55-29"></a>    <span class="op">}</span></span>
<span id="cb55-30"><a href="#cb55-30"></a>    exit_qemu(<span class="pp">QemuExitCode::</span><span class="cn">Success</span>)<span class="op">;</span></span>
<span id="cb55-31"><a href="#cb55-31"></a><span class="op">}</span></span>
<span id="cb55-32"><a href="#cb55-32"></a></span>
<span id="cb55-33"><a href="#cb55-33"></a><span class="kw">pub</span> <span class="kw">fn</span> test_panic_handler(info<span class="op">:</span> <span class="op">&amp;</span>PanicInfo) <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb55-34"><a href="#cb55-34"></a>    <span class="pp">serial_println!</span>(<span class="st">"[failed]</span><span class="sc">\n</span><span class="st">"</span>)<span class="op">;</span></span>
<span id="cb55-35"><a href="#cb55-35"></a>    <span class="pp">serial_println!</span>(<span class="st">"Error: {}</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> info)<span class="op">;</span></span>
<span id="cb55-36"><a href="#cb55-36"></a>    exit_qemu(<span class="pp">QemuExitCode::</span>Failed)<span class="op">;</span></span>
<span id="cb55-37"><a href="#cb55-37"></a>    <span class="cf">loop</span> <span class="op">{}</span></span>
<span id="cb55-38"><a href="#cb55-38"></a><span class="op">}</span></span>
<span id="cb55-39"><a href="#cb55-39"></a></span>
<span id="cb55-40"><a href="#cb55-40"></a><span class="co">/// Entry point for `cargo test`</span></span>
<span id="cb55-41"><a href="#cb55-41"></a><span class="at">#[</span>cfg<span class="at">(</span>test<span class="at">)]</span></span>
<span id="cb55-42"><a href="#cb55-42"></a><span class="at">#[</span><span class="kw">unsafe</span><span class="at">(</span>no_mangle<span class="at">)]</span></span>
<span id="cb55-43"><a href="#cb55-43"></a><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">"C"</span> <span class="kw">fn</span> _start() <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb55-44"><a href="#cb55-44"></a>    test_main()<span class="op">;</span></span>
<span id="cb55-45"><a href="#cb55-45"></a>    <span class="cf">loop</span> <span class="op">{}</span></span>
<span id="cb55-46"><a href="#cb55-46"></a><span class="op">}</span></span>
<span id="cb55-47"><a href="#cb55-47"></a></span>
<span id="cb55-48"><a href="#cb55-48"></a><span class="at">#[</span>cfg<span class="at">(</span>test<span class="at">)]</span></span>
<span id="cb55-49"><a href="#cb55-49"></a><span class="at">#[</span>panic_handler<span class="at">]</span></span>
<span id="cb55-50"><a href="#cb55-50"></a><span class="kw">fn</span> panic(info<span class="op">:</span> <span class="op">&amp;</span>PanicInfo) <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb55-51"><a href="#cb55-51"></a>    test_panic_handler(info)</span>
<span id="cb55-52"><a href="#cb55-52"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>To make our <code>test_runner</code> available to executables and integration tests, we make it public and don’t apply the <code>cfg(test)</code> attribute to it. We also factor out the implementation of our panic handler into a public <code>test_panic_handler</code> function, so that it is available for executables too.</p>
<p>Since our <code>lib.rs</code> is tested independently of our <code>main.rs</code>, we need to add a <code>_start</code> entry point and a panic handler when the library is compiled in test mode. By using the <a href="https://doc.rust-lang.org/reference/conditional-compilation.html#the-cfg_attr-attribute"><code>cfg_attr</code></a> crate attribute, we conditionally enable the <code>no_main</code> attribute in this case.</p>
<p>We also move over the <code>QemuExitCode</code> enum and the <code>exit_qemu</code> function and make them public:</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode numberSource rust number-lines code-with-copy"><code class="sourceCode rust"><span id="cb56-1"><a href="#cb56-1"></a><span class="co">// in src/lib.rs</span></span>
<span id="cb56-2"><a href="#cb56-2"></a></span>
<span id="cb56-3"><a href="#cb56-3"></a><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="op">,</span> <span class="bu">Clone</span><span class="op">,</span> <span class="bu">Copy</span><span class="op">,</span> <span class="bu">PartialEq</span><span class="op">,</span> <span class="bu">Eq</span><span class="at">)]</span></span>
<span id="cb56-4"><a href="#cb56-4"></a><span class="at">#[</span>repr<span class="at">(</span><span class="dt">u32</span><span class="at">)]</span></span>
<span id="cb56-5"><a href="#cb56-5"></a><span class="kw">pub</span> <span class="kw">enum</span> QemuExitCode <span class="op">{</span></span>
<span id="cb56-6"><a href="#cb56-6"></a>    <span class="cn">Success</span> <span class="op">=</span> <span class="dv">0x10</span><span class="op">,</span></span>
<span id="cb56-7"><a href="#cb56-7"></a>    Failed <span class="op">=</span> <span class="dv">0x11</span><span class="op">,</span></span>
<span id="cb56-8"><a href="#cb56-8"></a><span class="op">}</span></span>
<span id="cb56-9"><a href="#cb56-9"></a></span>
<span id="cb56-10"><a href="#cb56-10"></a><span class="kw">pub</span> <span class="kw">fn</span> exit_qemu(exit_code<span class="op">:</span> QemuExitCode) <span class="op">{</span></span>
<span id="cb56-11"><a href="#cb56-11"></a>    <span class="kw">use</span> <span class="pp">x86_64::instructions::port::</span>Port<span class="op">;</span></span>
<span id="cb56-12"><a href="#cb56-12"></a></span>
<span id="cb56-13"><a href="#cb56-13"></a>    <span class="kw">unsafe</span> <span class="op">{</span></span>
<span id="cb56-14"><a href="#cb56-14"></a>        <span class="kw">let</span> <span class="kw">mut</span> port <span class="op">=</span> <span class="pp">Port::</span>new(<span class="dv">0xf4</span>)<span class="op">;</span></span>
<span id="cb56-15"><a href="#cb56-15"></a>        port<span class="op">.</span>write(exit_code <span class="kw">as</span> <span class="dt">u32</span>)<span class="op">;</span></span>
<span id="cb56-16"><a href="#cb56-16"></a>    <span class="op">}</span></span>
<span id="cb56-17"><a href="#cb56-17"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now executables and integration tests can import these functions from the library and don’t need to define their own implementations. To also make <code>println</code> and <code>serial_println</code> available, we move the module declarations too:</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode numberSource rust number-lines code-with-copy"><code class="sourceCode rust"><span id="cb57-1"><a href="#cb57-1"></a><span class="co">// in src/lib.rs</span></span>
<span id="cb57-2"><a href="#cb57-2"></a></span>
<span id="cb57-3"><a href="#cb57-3"></a><span class="kw">pub</span> <span class="kw">mod</span> serial<span class="op">;</span></span>
<span id="cb57-4"><a href="#cb57-4"></a><span class="kw">pub</span> <span class="kw">mod</span> vga_buffer<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We make the modules public to make them usable outside of our library. This is also required for making our <code>println</code> and <code>serial_println</code> macros usable since they use the <code>_print</code> functions of the modules.</p>
<p>Now we can update our <code>main.rs</code> to use the library:</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode numberSource rust number-lines code-with-copy"><code class="sourceCode rust"><span id="cb58-1"><a href="#cb58-1"></a><span class="co">// in src/main.rs</span></span>
<span id="cb58-2"><a href="#cb58-2"></a></span>
<span id="cb58-3"><a href="#cb58-3"></a><span class="at">#![</span>no_std<span class="at">]</span></span>
<span id="cb58-4"><a href="#cb58-4"></a><span class="at">#![</span>no_main<span class="at">]</span></span>
<span id="cb58-5"><a href="#cb58-5"></a><span class="at">#![</span>feature<span class="at">(</span>custom_test_frameworks<span class="at">)]</span></span>
<span id="cb58-6"><a href="#cb58-6"></a><span class="at">#![</span>test_runner<span class="at">(</span><span class="pp">blog_os::</span>test_runner<span class="at">)]</span></span>
<span id="cb58-7"><a href="#cb58-7"></a><span class="at">#![</span>reexport_test_harness_main <span class="op">=</span> <span class="st">"test_main"</span><span class="at">]</span></span>
<span id="cb58-8"><a href="#cb58-8"></a></span>
<span id="cb58-9"><a href="#cb58-9"></a><span class="kw">use</span> <span class="pp">core::panic::</span>PanicInfo<span class="op">;</span></span>
<span id="cb58-10"><a href="#cb58-10"></a><span class="kw">use</span> <span class="pp">blog_os::</span>println<span class="op">;</span></span>
<span id="cb58-11"><a href="#cb58-11"></a></span>
<span id="cb58-12"><a href="#cb58-12"></a><span class="at">#[</span><span class="kw">unsafe</span><span class="at">(</span>no_mangle<span class="at">)]</span></span>
<span id="cb58-13"><a href="#cb58-13"></a><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">"C"</span> <span class="kw">fn</span> _start() <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb58-14"><a href="#cb58-14"></a>    <span class="pp">println!</span>(<span class="st">"Hello World{}"</span><span class="op">,</span> <span class="st">"!"</span>)<span class="op">;</span></span>
<span id="cb58-15"><a href="#cb58-15"></a></span>
<span id="cb58-16"><a href="#cb58-16"></a>    <span class="at">#[</span>cfg<span class="at">(</span>test<span class="at">)]</span></span>
<span id="cb58-17"><a href="#cb58-17"></a>    test_main()<span class="op">;</span></span>
<span id="cb58-18"><a href="#cb58-18"></a></span>
<span id="cb58-19"><a href="#cb58-19"></a>    <span class="cf">loop</span> <span class="op">{}</span></span>
<span id="cb58-20"><a href="#cb58-20"></a><span class="op">}</span></span>
<span id="cb58-21"><a href="#cb58-21"></a></span>
<span id="cb58-22"><a href="#cb58-22"></a><span class="co">/// This function is called on panic.</span></span>
<span id="cb58-23"><a href="#cb58-23"></a><span class="at">#[</span>cfg<span class="at">(</span>not<span class="at">(</span>test<span class="at">))]</span></span>
<span id="cb58-24"><a href="#cb58-24"></a><span class="at">#[</span>panic_handler<span class="at">]</span></span>
<span id="cb58-25"><a href="#cb58-25"></a><span class="kw">fn</span> panic(info<span class="op">:</span> <span class="op">&amp;</span>PanicInfo) <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb58-26"><a href="#cb58-26"></a>    <span class="pp">println!</span>(<span class="st">"{}"</span><span class="op">,</span> info)<span class="op">;</span></span>
<span id="cb58-27"><a href="#cb58-27"></a>    <span class="cf">loop</span> <span class="op">{}</span></span>
<span id="cb58-28"><a href="#cb58-28"></a><span class="op">}</span></span>
<span id="cb58-29"><a href="#cb58-29"></a></span>
<span id="cb58-30"><a href="#cb58-30"></a><span class="at">#[</span>cfg<span class="at">(</span>test<span class="at">)]</span></span>
<span id="cb58-31"><a href="#cb58-31"></a><span class="at">#[</span>panic_handler<span class="at">]</span></span>
<span id="cb58-32"><a href="#cb58-32"></a><span class="kw">fn</span> panic(info<span class="op">:</span> <span class="op">&amp;</span>PanicInfo) <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb58-33"><a href="#cb58-33"></a>    <span class="pp">blog_os::</span>test_panic_handler(info)</span>
<span id="cb58-34"><a href="#cb58-34"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The library is usable like a normal external crate. It is called <code>blog_os</code>, like our crate. The above code uses the <code>blog_os::test_runner</code> function in the <code>test_runner</code> attribute and the <code>blog_os::test_panic_handler</code> function in our <code>cfg(test)</code> panic handler. It also imports the <code>println</code> macro to make it available to our <code>_start</code> and <code>panic</code> functions.</p>
<p>At this point, <code>cargo run</code> and <code>cargo test</code> should work again. Of course, <code>cargo test</code> still loops endlessly (you can exit with <code>ctrl+c</code>). Let’s fix this by using the required library functions in our integration test.</p>
</section>
<section id="completing-the-integration-test" class="level3">
<h3 class="anchored" data-anchor-id="completing-the-integration-test">Completing the Integration Test</h3>
<p>Like our <code>src/main.rs</code>, our <code>tests/basic_boot.rs</code> executable can import types from our new library. This allows us to import the missing components to complete our test:</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode numberSource rust number-lines code-with-copy"><code class="sourceCode rust"><span id="cb59-1"><a href="#cb59-1"></a><span class="co">// in tests/basic_boot.rs</span></span>
<span id="cb59-2"><a href="#cb59-2"></a></span>
<span id="cb59-3"><a href="#cb59-3"></a><span class="at">#![</span>test_runner<span class="at">(</span><span class="pp">blog_os::</span>test_runner<span class="at">)]</span></span>
<span id="cb59-4"><a href="#cb59-4"></a></span>
<span id="cb59-5"><a href="#cb59-5"></a><span class="at">#[</span>panic_handler<span class="at">]</span></span>
<span id="cb59-6"><a href="#cb59-6"></a><span class="kw">fn</span> panic(info<span class="op">:</span> <span class="op">&amp;</span>PanicInfo) <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb59-7"><a href="#cb59-7"></a>    <span class="pp">blog_os::</span>test_panic_handler(info)</span>
<span id="cb59-8"><a href="#cb59-8"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Instead of reimplementing the test runner, we use the <code>test_runner</code> function from our library by changing the <code>#![test_runner(crate::test_runner)]</code> attribute to <code>#![test_runner(blog_os::test_runner)]</code>. We then don’t need the <code>test_runner</code> stub function in <code>basic_boot.rs</code> anymore, so we can remove it. For our <code>panic</code> handler, we call the <code>blog_os::test_panic_handler</code> function like we did in our <code>main.rs</code>.</p>
<p>Now <code>cargo test</code> exits normally again. When you run it, you will see that it builds and runs the tests for our <code>lib.rs</code>, <code>main.rs</code>, and <code>basic_boot.rs</code> separately after each other. For the <code>main.rs</code> and the <code>basic_boot</code> integration tests, it reports “Running 0 tests” since these files don’t have any functions annotated with <code>#[test_case]</code>.</p>
<p>We can now add tests to our <code>basic_boot.rs</code>. For example, we can test that <code>println</code> works without panicking, like we did in the VGA buffer tests:</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode numberSource rust number-lines code-with-copy"><code class="sourceCode rust"><span id="cb60-1"><a href="#cb60-1"></a><span class="co">// in tests/basic_boot.rs</span></span>
<span id="cb60-2"><a href="#cb60-2"></a></span>
<span id="cb60-3"><a href="#cb60-3"></a><span class="kw">use</span> <span class="pp">blog_os::</span>println<span class="op">;</span></span>
<span id="cb60-4"><a href="#cb60-4"></a></span>
<span id="cb60-5"><a href="#cb60-5"></a><span class="at">#[</span>test_case<span class="at">]</span></span>
<span id="cb60-6"><a href="#cb60-6"></a><span class="kw">fn</span> test_println() <span class="op">{</span></span>
<span id="cb60-7"><a href="#cb60-7"></a>    <span class="pp">println!</span>(<span class="st">"test_println output"</span>)<span class="op">;</span></span>
<span id="cb60-8"><a href="#cb60-8"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>When we run <code>cargo test</code> now, we see that it finds and executes the test function.</p>
<p>The test might seem a bit useless right now since it’s almost identical to one of the VGA buffer tests. However, in the future, the <code>_start</code> functions of our <code>main.rs</code> and <code>lib.rs</code> might grow and call various initialization routines before running the <code>test_main</code> function, so that the two tests are executed in very different environments.</p>
<p>By testing <code>println</code> in a <code>basic_boot</code> environment without calling any initialization routines in <code>_start</code>, we can ensure that <code>println</code> works right after booting. This is important because we rely on it, e.g., for printing panic messages.</p>
</section>
<section id="future-tests" class="level3">
<h3 class="anchored" data-anchor-id="future-tests">Future Tests</h3>
<p>The power of integration tests is that they’re treated as completely separate executables. This gives them complete control over the environment, which makes it possible to test that the code interacts correctly with the CPU or hardware devices.</p>
<p>Our <code>basic_boot</code> test is a very simple example of an integration test. In the future, our kernel will become much more featureful and interact with the hardware in various ways. By adding integration tests, we can ensure that these interactions work (and keep working) as expected. Some ideas for possible future tests are:</p>
<ul>
<li><strong>CPU Exceptions</strong>: When the code performs invalid operations (e.g., divides by zero), the CPU throws an exception. The kernel can register handler functions for such exceptions. An integration test could verify that the correct exception handler is called when a CPU exception occurs or that the execution continues correctly after a resolvable exception.</li>
<li><strong>Page Tables</strong>: Page tables define which memory regions are valid and accessible. By modifying the page tables, it is possible to allocate new memory regions, for example when launching programs. An integration test could modify the page tables in the <code>_start</code> function and verify that the modifications have the desired effects in <code>#[test_case]</code> functions.</li>
<li><strong>Userspace Programs</strong>: Userspace programs are programs with limited access to the system’s resources. For example, they don’t have access to kernel data structures or to the memory of other programs. An integration test could launch userspace programs that perform forbidden operations and verify that the kernel prevents them all.</li>
</ul>
<p>As you can imagine, many more tests are possible. By adding such tests, we can ensure that we don’t break them accidentally when we add new features to our kernel or refactor our code. This is especially important when our kernel becomes larger and more complex.</p>
</section>
<section id="tests-that-should-panic" class="level3">
<h3 class="anchored" data-anchor-id="tests-that-should-panic">Tests that Should Panic</h3>
<p>The test framework of the standard library supports a <a href="https://doc.rust-lang.org/rust-by-example/testing/unit_testing.html#testing-panics"><code>#[should_panic]</code> attribute</a> that allows constructing tests that should fail. This is useful, for example, to verify that a function fails when an invalid argument is passed. Unfortunately, this attribute isn’t supported in <code>#[no_std]</code> crates since it requires support from the standard library.</p>
<p>While we can’t use the <code>#[should_panic]</code> attribute in our kernel, we can get similar behavior by creating an integration test that exits with a success error code from the panic handler. Let’s start creating such a test with the name <code>should_panic</code>:</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode numberSource rust number-lines code-with-copy"><code class="sourceCode rust"><span id="cb61-1"><a href="#cb61-1"></a><span class="co">// in tests/should_panic.rs</span></span>
<span id="cb61-2"><a href="#cb61-2"></a></span>
<span id="cb61-3"><a href="#cb61-3"></a><span class="at">#![</span>no_std<span class="at">]</span></span>
<span id="cb61-4"><a href="#cb61-4"></a><span class="at">#![</span>no_main<span class="at">]</span></span>
<span id="cb61-5"><a href="#cb61-5"></a></span>
<span id="cb61-6"><a href="#cb61-6"></a><span class="kw">use</span> <span class="pp">core::panic::</span>PanicInfo<span class="op">;</span></span>
<span id="cb61-7"><a href="#cb61-7"></a><span class="kw">use</span> <span class="pp">blog_os::</span><span class="op">{</span>QemuExitCode<span class="op">,</span> exit_qemu<span class="op">,</span> serial_println<span class="op">};</span></span>
<span id="cb61-8"><a href="#cb61-8"></a></span>
<span id="cb61-9"><a href="#cb61-9"></a><span class="at">#[</span>panic_handler<span class="at">]</span></span>
<span id="cb61-10"><a href="#cb61-10"></a><span class="kw">fn</span> panic(_info<span class="op">:</span> <span class="op">&amp;</span>PanicInfo) <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb61-11"><a href="#cb61-11"></a>    <span class="pp">serial_println!</span>(<span class="st">"[ok]"</span>)<span class="op">;</span></span>
<span id="cb61-12"><a href="#cb61-12"></a>    exit_qemu(<span class="pp">QemuExitCode::</span><span class="cn">Success</span>)<span class="op">;</span></span>
<span id="cb61-13"><a href="#cb61-13"></a>    <span class="cf">loop</span> <span class="op">{}</span></span>
<span id="cb61-14"><a href="#cb61-14"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This test is still incomplete as it doesn’t define a <code>_start</code> function or any of the custom test runner attributes yet. Let’s add the missing parts:</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode numberSource rust number-lines code-with-copy"><code class="sourceCode rust"><span id="cb62-1"><a href="#cb62-1"></a><span class="co">// in tests/should_panic.rs</span></span>
<span id="cb62-2"><a href="#cb62-2"></a></span>
<span id="cb62-3"><a href="#cb62-3"></a><span class="at">#![</span>feature<span class="at">(</span>custom_test_frameworks<span class="at">)]</span></span>
<span id="cb62-4"><a href="#cb62-4"></a><span class="at">#![</span>test_runner<span class="at">(</span>test_runner<span class="at">)]</span></span>
<span id="cb62-5"><a href="#cb62-5"></a><span class="at">#![</span>reexport_test_harness_main <span class="op">=</span> <span class="st">"test_main"</span><span class="at">]</span></span>
<span id="cb62-6"><a href="#cb62-6"></a></span>
<span id="cb62-7"><a href="#cb62-7"></a><span class="at">#[</span><span class="kw">unsafe</span><span class="at">(</span>no_mangle<span class="at">)]</span></span>
<span id="cb62-8"><a href="#cb62-8"></a><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">"C"</span> <span class="kw">fn</span> _start() <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb62-9"><a href="#cb62-9"></a>    test_main()<span class="op">;</span></span>
<span id="cb62-10"><a href="#cb62-10"></a></span>
<span id="cb62-11"><a href="#cb62-11"></a>    <span class="cf">loop</span> <span class="op">{}</span></span>
<span id="cb62-12"><a href="#cb62-12"></a><span class="op">}</span></span>
<span id="cb62-13"><a href="#cb62-13"></a></span>
<span id="cb62-14"><a href="#cb62-14"></a><span class="kw">pub</span> <span class="kw">fn</span> test_runner(tests<span class="op">:</span> <span class="op">&amp;</span>[<span class="op">&amp;</span><span class="kw">dyn</span> <span class="bu">Fn</span>()]) <span class="op">{</span></span>
<span id="cb62-15"><a href="#cb62-15"></a>    <span class="pp">serial_println!</span>(<span class="st">"Running {} tests"</span><span class="op">,</span> tests<span class="op">.</span>len())<span class="op">;</span></span>
<span id="cb62-16"><a href="#cb62-16"></a>    <span class="cf">for</span> test <span class="kw">in</span> tests <span class="op">{</span></span>
<span id="cb62-17"><a href="#cb62-17"></a>        test()<span class="op">;</span></span>
<span id="cb62-18"><a href="#cb62-18"></a>        <span class="pp">serial_println!</span>(<span class="st">"[test did not panic]"</span>)<span class="op">;</span></span>
<span id="cb62-19"><a href="#cb62-19"></a>        exit_qemu(<span class="pp">QemuExitCode::</span>Failed)<span class="op">;</span></span>
<span id="cb62-20"><a href="#cb62-20"></a>    <span class="op">}</span></span>
<span id="cb62-21"><a href="#cb62-21"></a>    exit_qemu(<span class="pp">QemuExitCode::</span><span class="cn">Success</span>)<span class="op">;</span></span>
<span id="cb62-22"><a href="#cb62-22"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Instead of reusing the <code>test_runner</code> from our <code>lib.rs</code>, the test defines its own <code>test_runner</code> function that exits with a failure exit code when a test returns without panicking (we want our tests to panic). If no test function is defined, the runner exits with a success error code. Since the runner always exits after running a single test, it does not make sense to define more than one <code>#[test_case]</code> function.</p>
<p>Now we can create a test that should fail:</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode numberSource rust number-lines code-with-copy"><code class="sourceCode rust"><span id="cb63-1"><a href="#cb63-1"></a><span class="co">// in tests/should_panic.rs</span></span>
<span id="cb63-2"><a href="#cb63-2"></a></span>
<span id="cb63-3"><a href="#cb63-3"></a><span class="kw">use</span> <span class="pp">blog_os::</span>serial_print<span class="op">;</span></span>
<span id="cb63-4"><a href="#cb63-4"></a></span>
<span id="cb63-5"><a href="#cb63-5"></a><span class="at">#[</span>test_case<span class="at">]</span></span>
<span id="cb63-6"><a href="#cb63-6"></a><span class="kw">fn</span> should_fail() <span class="op">{</span></span>
<span id="cb63-7"><a href="#cb63-7"></a>    <span class="pp">serial_print!</span>(<span class="st">"should_panic::should_fail...</span><span class="sc">\t</span><span class="st">"</span>)<span class="op">;</span></span>
<span id="cb63-8"><a href="#cb63-8"></a>    <span class="pp">assert_eq!</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb63-9"><a href="#cb63-9"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The test uses <code>assert_eq</code> to assert that <code>0</code> and <code>1</code> are equal. Of course, this fails, so our test panics as desired. Note that we need to manually print the function name using <code>serial_print!</code> here because we don’t use the <code>Testable</code> trait.</p>
<p>When we run the test through <code>cargo test --test should_panic</code> we see that it is successful because the test panicked as expected. When we comment out the assertion and run the test again, we see that it indeed fails with the <em>“test did not panic”</em> message.</p>
<p>A significant drawback of this approach is that it only works for a single test function. With multiple <code>#[test_case]</code> functions, only the first function is executed because the execution cannot continue after the panic handler has been called. I currently don’t know of a good way to solve this problem, so let me know if you have an idea!</p>
</section>
<section id="no-harness-tests" class="level3">
<h3 class="anchored" data-anchor-id="no-harness-tests">No Harness Tests</h3>
<p>For integration tests that only have a single test function (like our <code>should_panic</code> test), the test runner isn’t really needed. For cases like this, we can disable the test runner completely and run our test directly in the <code>_start</code> function.</p>
<p>The key to this is to disable the <code>harness</code> flag for the test in the <code>Cargo.toml</code>, which defines whether a test runner is used for an integration test. When it’s set to <code>false</code>, both the default test runner and the custom test runner feature are disabled, so that the test is treated like a normal executable.</p>
<p>Let’s disable the <code>harness</code> flag for our <code>should_panic</code> test:</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode numberSource toml number-lines code-with-copy"><code class="sourceCode toml"><span id="cb64-1"><a href="#cb64-1"></a><span class="co"># in Cargo.toml</span></span>
<span id="cb64-2"><a href="#cb64-2"></a></span>
<span id="cb64-3"><a href="#cb64-3"></a><span class="kw">[[test]]</span></span>
<span id="cb64-4"><a href="#cb64-4"></a><span class="dt">name</span> <span class="op">=</span> <span class="st">"should_panic"</span></span>
<span id="cb64-5"><a href="#cb64-5"></a><span class="dt">harness</span> <span class="op">=</span> <span class="cn">false</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now we vastly simplify our <code>should_panic</code> test by removing the <code>test_runner</code>-related code. The result looks like this:</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode numberSource rust number-lines code-with-copy"><code class="sourceCode rust"><span id="cb65-1"><a href="#cb65-1"></a><span class="co">// in tests/should_panic.rs</span></span>
<span id="cb65-2"><a href="#cb65-2"></a></span>
<span id="cb65-3"><a href="#cb65-3"></a><span class="at">#![</span>no_std<span class="at">]</span></span>
<span id="cb65-4"><a href="#cb65-4"></a><span class="at">#![</span>no_main<span class="at">]</span></span>
<span id="cb65-5"><a href="#cb65-5"></a></span>
<span id="cb65-6"><a href="#cb65-6"></a><span class="kw">use</span> <span class="pp">core::panic::</span>PanicInfo<span class="op">;</span></span>
<span id="cb65-7"><a href="#cb65-7"></a><span class="kw">use</span> <span class="pp">blog_os::</span><span class="op">{</span>exit_qemu<span class="op">,</span> serial_print<span class="op">,</span> serial_println<span class="op">,</span> QemuExitCode<span class="op">};</span></span>
<span id="cb65-8"><a href="#cb65-8"></a></span>
<span id="cb65-9"><a href="#cb65-9"></a><span class="at">#[</span><span class="kw">unsafe</span><span class="at">(</span>no_mangle<span class="at">)]</span></span>
<span id="cb65-10"><a href="#cb65-10"></a><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">"C"</span> <span class="kw">fn</span> _start() <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb65-11"><a href="#cb65-11"></a>    should_fail()<span class="op">;</span></span>
<span id="cb65-12"><a href="#cb65-12"></a>    <span class="pp">serial_println!</span>(<span class="st">"[test did not panic]"</span>)<span class="op">;</span></span>
<span id="cb65-13"><a href="#cb65-13"></a>    exit_qemu(<span class="pp">QemuExitCode::</span>Failed)<span class="op">;</span></span>
<span id="cb65-14"><a href="#cb65-14"></a>    <span class="cf">loop</span><span class="op">{}</span></span>
<span id="cb65-15"><a href="#cb65-15"></a><span class="op">}</span></span>
<span id="cb65-16"><a href="#cb65-16"></a></span>
<span id="cb65-17"><a href="#cb65-17"></a><span class="kw">fn</span> should_fail() <span class="op">{</span></span>
<span id="cb65-18"><a href="#cb65-18"></a>    <span class="pp">serial_print!</span>(<span class="st">"should_panic::should_fail...</span><span class="sc">\t</span><span class="st">"</span>)<span class="op">;</span></span>
<span id="cb65-19"><a href="#cb65-19"></a>    <span class="pp">assert_eq!</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb65-20"><a href="#cb65-20"></a><span class="op">}</span></span>
<span id="cb65-21"><a href="#cb65-21"></a></span>
<span id="cb65-22"><a href="#cb65-22"></a><span class="at">#[</span>panic_handler<span class="at">]</span></span>
<span id="cb65-23"><a href="#cb65-23"></a><span class="kw">fn</span> panic(_info<span class="op">:</span> <span class="op">&amp;</span>PanicInfo) <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb65-24"><a href="#cb65-24"></a>    <span class="pp">serial_println!</span>(<span class="st">"[ok]"</span>)<span class="op">;</span></span>
<span id="cb65-25"><a href="#cb65-25"></a>    exit_qemu(<span class="pp">QemuExitCode::</span><span class="cn">Success</span>)<span class="op">;</span></span>
<span id="cb65-26"><a href="#cb65-26"></a>    <span class="cf">loop</span> <span class="op">{}</span></span>
<span id="cb65-27"><a href="#cb65-27"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We now call the <code>should_fail</code> function directly from our <code>_start</code> function and exit with a failure exit code if it returns. When we run <code>cargo test --test should_panic</code> now, we see that the test behaves exactly as before.</p>
<p>Apart from creating <code>should_panic</code> tests, disabling the <code>harness</code> attribute can also be useful for complex integration tests, for example, when the individual test functions have side effects and need to be run in a specified order.</p>
</section>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>Testing is a very useful technique to ensure that certain components have the desired behavior. Even if they cannot show the absence of bugs, they’re still a useful tool for finding them and especially for avoiding regressions.</p>
<p>This post explained how to set up a test framework for our Rust kernel. We used Rust’s custom test frameworks feature to implement support for a simple <code>#[test_case]</code> attribute in our bare-metal environment. Using the <code>isa-debug-exit</code> device of QEMU, our test runner can exit QEMU after running the tests and report the test status. To print error messages to the console instead of the VGA buffer, we created a basic driver for the serial port.</p>
<p>After creating some tests for our <code>println</code> macro, we explored integration tests in the second half of the post. We learned that they live in the <code>tests</code> directory and are treated as completely separate executables. To give them access to the <code>exit_qemu</code> function and the <code>serial_println</code> macro, we moved most of our code into a library that can be imported by all executables and integration tests. Since integration tests run in their own separate environment, they make it possible to test interactions with the hardware or to create tests that should panic.</p>
<p>We now have a test framework that runs in a realistic environment inside QEMU. By creating more tests in future posts, we can keep our kernel maintainable when it becomes more complex.</p>
</section>
<section id="whats-next" class="level2">
<h2 class="anchored" data-anchor-id="whats-next">What’s next?</h2>
<p>In the next post, we will explore <em>CPU exceptions</em>. These exceptions are thrown by the CPU when something illegal happens, such as a division by zero or an access to an unmapped memory page (a so-called “page fault”). Being able to catch and examine these exceptions is very important for debugging future errors. Exception handling is also very similar to the handling of hardware interrupts, which is required for keyboard support.</p>
</section>
</section>
<section id="fin" class="level1">
<h1>Fin</h1>
<section id="timeout" class="level2">
<h2 class="anchored" data-anchor-id="timeout">Timeout</h2>
<ul>
<li>This is 700 lines of markdown source which usually is enough.</li>
<li>Otherwise we proceed to “Format”.</li>
</ul>


<!-- -->

</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./52_graphics.html" class="pagination-link" aria-label="Graphics">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Graphics</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb66" data-shortcodes="false"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb66-1"><a href="#cb66-1"></a><span class="co">---</span></span>
<span id="cb66-2"><a href="#cb66-2"></a><span class="an">title:</span><span class="co"> Test</span></span>
<span id="cb66-3"><a href="#cb66-3"></a><span class="co">---</span></span>
<span id="cb66-4"><a href="#cb66-4"></a></span>
<span id="cb66-5"><a href="#cb66-5"></a><span class="fu">## Announcements</span></span>
<span id="cb66-6"><a href="#cb66-6"></a></span>
<span id="cb66-7"><a href="#cb66-7"></a><span class="ss">- </span>**Action Items**:</span>
<span id="cb66-8"><a href="#cb66-8"></a><span class="ss">  - </span>How is graphics?</span>
<span id="cb66-9"><a href="#cb66-9"></a><span class="ss">    - </span>Are you learning NumPy?</span>
<span id="cb66-10"><a href="#cb66-10"></a><span class="ss">    - </span>Anyone using CUDA?</span>
<span id="cb66-11"><a href="#cb66-11"></a></span>
<span id="cb66-12"><a href="#cb66-12"></a><span class="fu">## Citations</span></span>
<span id="cb66-13"><a href="#cb66-13"></a></span>
<span id="cb66-14"><a href="#cb66-14"></a><span class="ss">- </span>I am geniunely convinced of the usefulness of automated testing when developing a system.</span>
<span id="cb66-15"><a href="#cb66-15"></a><span class="ss">- </span>The most high profile case of this is the testing framework for <span class="co">[</span><span class="ot">`4096_t.c`</span><span class="co">](https://cd-public.github.io/crypto/qmd/bigadd.html)</span></span>
<span id="cb66-16"><a href="#cb66-16"></a><span class="ss">- </span>Hard to persuade students of the usefulness of this on small class assignments.</span>
<span id="cb66-17"><a href="#cb66-17"></a><span class="ss">- </span>$\therefore$ I've never written anything of any reasonable size in Rust, so</span>
<span id="cb66-18"><a href="#cb66-18"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Testing</span><span class="co">](https://os.phil-opp.com/testing/)</span></span>
<span id="cb66-19"><a href="#cb66-19"></a></span>
<span id="cb66-20"><a href="#cb66-20"></a><span class="fu">## Today</span></span>
<span id="cb66-21"><a href="#cb66-21"></a></span>
<span id="cb66-22"><a href="#cb66-22"></a><span class="ss">- </span>Testing under <span class="in">`no_std`</span></span>
<span id="cb66-23"><a href="#cb66-23"></a><span class="ss">- </span>QEMU</span>
<span id="cb66-24"><a href="#cb66-24"></a><span class="ss">- </span><span class="in">`bootimage`</span></span>
<span id="cb66-25"><a href="#cb66-25"></a><span class="ss">    - </span>Still not in love with this dependency, but we do what we can.</span>
<span id="cb66-26"><a href="#cb66-26"></a>    </span>
<span id="cb66-27"><a href="#cb66-27"></a><span class="fu">## Pre-work</span></span>
<span id="cb66-28"><a href="#cb66-28"></a></span>
<span id="cb66-29"><a href="#cb66-29"></a><span class="ss">- </span>Make sure you have a <span class="in">`.cargo/config.toml`</span></span>
<span id="cb66-30"><a href="#cb66-30"></a><span class="ss">- </span>No idea how you wouldn't have one of these yet!</span>
<span id="cb66-31"><a href="#cb66-31"></a><span class="ss">- </span>Just make sure you have it.</span>
<span id="cb66-32"><a href="#cb66-32"></a></span>
<span id="cb66-33"><a href="#cb66-33"></a><span class="fu">## Modern Language</span></span>
<span id="cb66-34"><a href="#cb66-34"></a></span>
<span id="cb66-35"><a href="#cb66-35"></a><span class="ss">- </span>Like Python with Pytest, and unlike the only other systems language, Rust has a testing framework.</span>
<span id="cb66-36"><a href="#cb66-36"></a><span class="ss">- </span>It's covered in <span class="co">[</span><span class="ot">Rust book</span><span class="co">](https://doc.rust-lang.org/book/ch11-00-testing.html)</span></span>
<span id="cb66-37"><a href="#cb66-37"></a><span class="ss">- </span>Naturally I skipped this chapter.</span>
<span id="cb66-38"><a href="#cb66-38"></a></span>
<span id="cb66-39"><a href="#cb66-39"></a><span class="fu">## Framework</span></span>
<span id="cb66-40"><a href="#cb66-40"></a></span>
<span id="cb66-41"><a href="#cb66-41"></a><span class="ss">- </span>Use the <span class="in">`#[test]`</span> attribute on some functions.</span>
<span id="cb66-42"><a href="#cb66-42"></a><span class="ss">- </span>Including *assertions* within those functions.</span>
<span id="cb66-43"><a href="#cb66-43"></a><span class="ss">- </span><span class="in">`cargo test`</span> or, if you see someone around, <span class="in">`cargo t`</span>, will check the assertions.</span>
<span id="cb66-44"><a href="#cb66-44"></a><span class="ss">- </span>The crate will otherwise be non-impacted.</span>
<span id="cb66-45"><a href="#cb66-45"></a></span>
<span id="cb66-46"><a href="#cb66-46"></a><span class="fu">## Review</span></span>
<span id="cb66-47"><a href="#cb66-47"></a></span>
<span id="cb66-48"><a href="#cb66-48"></a><span class="ss">- </span>To enable testing for our kernel binary, we can set the <span class="in">`test`</span> flag in the Cargo.toml to <span class="in">`true`</span>.</span>
<span id="cb66-49"><a href="#cb66-49"></a><span class="ss">- </span>We recall our <span class="in">`Cargo.toml`</span> - mine no longer has an allusions to panic with the introduction of a JSON target.</span>
<span id="cb66-50"><a href="#cb66-50"></a></span>
<span id="cb66-51"><a href="#cb66-51"></a><span class="in">```{.toml filename="Cargo.toml"}</span></span>
<span id="cb66-52"><a href="#cb66-52"></a><span class="in">[package]</span></span>
<span id="cb66-53"><a href="#cb66-53"></a><span class="in">name = "osirs"</span></span>
<span id="cb66-54"><a href="#cb66-54"></a><span class="in">version = "0.1.0"</span></span>
<span id="cb66-55"><a href="#cb66-55"></a><span class="in">edition = "2024"</span></span>
<span id="cb66-56"><a href="#cb66-56"></a></span>
<span id="cb66-57"><a href="#cb66-57"></a><span class="in">[dependencies]</span></span>
<span id="cb66-58"><a href="#cb66-58"></a><span class="in">bootloader = "0.9"</span></span>
<span id="cb66-59"><a href="#cb66-59"></a><span class="in">```</span></span>
<span id="cb66-60"><a href="#cb66-60"></a></span>
<span id="cb66-61"><a href="#cb66-61"></a><span class="fu">## Enable</span></span>
<span id="cb66-62"><a href="#cb66-62"></a></span>
<span id="cb66-63"><a href="#cb66-63"></a><span class="ss">- </span>This is necessary but not sufficient.</span>
<span id="cb66-64"><a href="#cb66-64"></a></span>
<span id="cb66-65"><a href="#cb66-65"></a><span class="in">```{.toml filename="Cargo.toml" code-line-numbers="9,10,11,12"}</span></span>
<span id="cb66-66"><a href="#cb66-66"></a><span class="in">[package]</span></span>
<span id="cb66-67"><a href="#cb66-67"></a><span class="in">name = "osirs"</span></span>
<span id="cb66-68"><a href="#cb66-68"></a><span class="in">version = "0.1.0"</span></span>
<span id="cb66-69"><a href="#cb66-69"></a><span class="in">edition = "2024"</span></span>
<span id="cb66-70"><a href="#cb66-70"></a></span>
<span id="cb66-71"><a href="#cb66-71"></a><span class="in">[dependencies]</span></span>
<span id="cb66-72"><a href="#cb66-72"></a><span class="in">bootloader = "0.9"</span></span>
<span id="cb66-73"><a href="#cb66-73"></a></span>
<span id="cb66-74"><a href="#cb66-74"></a><span class="in">[[bin]]</span></span>
<span id="cb66-75"><a href="#cb66-75"></a><span class="in">name = "osirs"</span></span>
<span id="cb66-76"><a href="#cb66-76"></a><span class="in">test = true</span></span>
<span id="cb66-77"><a href="#cb66-77"></a><span class="in">bench = false</span></span>
<span id="cb66-78"><a href="#cb66-78"></a><span class="in">```</span></span>
<span id="cb66-79"><a href="#cb66-79"></a></span>
<span id="cb66-80"><a href="#cb66-80"></a><span class="fu">## On `[[bin]]`</span></span>
<span id="cb66-81"><a href="#cb66-81"></a></span>
<span id="cb66-82"><a href="#cb66-82"></a><span class="at">&gt; </span><span class="co">[</span><span class="ot">The double-bracket sections like `[[bin]</span><span class="co">]</span><span class="in">` are array-of-table of TOML, which means you can write more than one `</span><span class="at">[</span><span class="co">[</span><span class="ot">bin</span><span class="co">]</span><span class="at">]` section to make several executables in your crate.](https://doc.rust-lang.org/cargo/reference/cargo-targets.html#configuring-a-target)</span></span>
<span id="cb66-83"><a href="#cb66-83"></a></span>
<span id="cb66-84"><a href="#cb66-84"></a><span class="ss">- </span>Just one for us for now.</span>
<span id="cb66-85"><a href="#cb66-85"></a></span>
<span id="cb66-86"><a href="#cb66-86"></a><span class="fu">## Working within `no_std`</span></span>
<span id="cb66-87"><a href="#cb66-87"></a></span>
<span id="cb66-88"><a href="#cb66-88"></a><span class="ss">- </span>Testing is complicated by <span class="in">`no_std`</span>. </span>
<span id="cb66-89"><a href="#cb66-89"></a><span class="ss">- </span>Rust implicitly uses the <span class="in">`test`</span> library, which depends on <span class="in">`std`</span></span>
<span id="cb66-90"><a href="#cb66-90"></a><span class="ss">    - </span><span class="co">[</span><span class="ot">More on `test`</span><span class="co">](https://doc.rust-lang.org/test/index.html)</span></span>
<span id="cb66-91"><a href="#cb66-91"></a>    </span>
<span id="cb66-92"><a href="#cb66-92"></a><span class="in">```{.sh}</span></span>
<span id="cb66-93"><a href="#cb66-93"></a><span class="in">$ cargo t</span></span>
<span id="cb66-94"><a href="#cb66-94"></a><span class="in">   Compiling bootloader v0.9.34</span></span>
<span id="cb66-95"><a href="#cb66-95"></a><span class="in">error[E0463]: can't find crate for `core`</span></span>
<span id="cb66-96"><a href="#cb66-96"></a><span class="in">  |</span></span>
<span id="cb66-97"><a href="#cb66-97"></a><span class="in">  = note: the `x86_64-osirs` target may not be installed</span></span>
<span id="cb66-98"><a href="#cb66-98"></a><span class="in">  = help: consider downloading the target with `rustup target add x86_64-osirs`</span></span>
<span id="cb66-99"><a href="#cb66-99"></a></span>
<span id="cb66-100"><a href="#cb66-100"></a><span class="in">For more information about this error, try `rustc --explain E0463`.</span></span>
<span id="cb66-101"><a href="#cb66-101"></a><span class="in">error: could not compile `bootloader` (lib) due to 1 previous error</span></span>
<span id="cb66-102"><a href="#cb66-102"></a><span class="in">```</span></span>
<span id="cb66-103"><a href="#cb66-103"></a></span>
<span id="cb66-104"><a href="#cb66-104"></a><span class="fu">## What We Lose</span></span>
<span id="cb66-105"><a href="#cb66-105"></a></span>
<span id="cb66-106"><a href="#cb66-106"></a><span class="ss">- </span>Vs. <span class="in">`std`</span>, we lose e.g. <span class="in">`should_panic`</span> tests.</span>
<span id="cb66-107"><a href="#cb66-107"></a><span class="ss">    - </span><span class="co">[</span><span class="ot">On those</span><span class="co">](https://doc.rust-lang.org/book/ch11-01-writing-tests.html#checking-for-panics-with-should_panic)</span></span>
<span id="cb66-108"><a href="#cb66-108"></a><span class="ss">- </span>That's okay, we are crafty (and wrote our own panic handler anyway).</span>
<span id="cb66-109"><a href="#cb66-109"></a></span>
<span id="cb66-110"><a href="#cb66-110"></a><span class="fu">## To Main</span></span>
<span id="cb66-111"><a href="#cb66-111"></a></span>
<span id="cb66-112"><a href="#cb66-112"></a><span class="ss">- </span>My main looks like this:</span>
<span id="cb66-113"><a href="#cb66-113"></a></span>
<span id="cb66-114"><a href="#cb66-114"></a><span class="in">```{.rs filename="src/main.rs"}</span></span>
<span id="cb66-115"><a href="#cb66-115"></a><span class="in">#![no_std]</span></span>
<span id="cb66-116"><a href="#cb66-116"></a><span class="in">#![no_main]</span></span>
<span id="cb66-117"><a href="#cb66-117"></a></span>
<span id="cb66-118"><a href="#cb66-118"></a><span class="in">mod colors;</span></span>
<span id="cb66-119"><a href="#cb66-119"></a><span class="in">mod vga;</span></span>
<span id="cb66-120"><a href="#cb66-120"></a></span>
<span id="cb66-121"><a href="#cb66-121"></a><span class="in">#[panic_handler]</span></span>
<span id="cb66-122"><a href="#cb66-122"></a><span class="in">fn panic(info: &amp;core::panic::PanicInfo) -&gt; ! {</span></span>
<span id="cb66-123"><a href="#cb66-123"></a><span class="in">    println!("{}", info);</span></span>
<span id="cb66-124"><a href="#cb66-124"></a><span class="in">    loop {}</span></span>
<span id="cb66-125"><a href="#cb66-125"></a><span class="in">}</span></span>
<span id="cb66-126"><a href="#cb66-126"></a></span>
<span id="cb66-127"><a href="#cb66-127"></a><span class="in">#[unsafe(no_mangle)]</span></span>
<span id="cb66-128"><a href="#cb66-128"></a><span class="in">pub extern "C" fn _start() -&gt; ! {</span></span>
<span id="cb66-129"><a href="#cb66-129"></a><span class="in">    colors::colors();</span></span>
<span id="cb66-130"><a href="#cb66-130"></a><span class="in">    colors::image();</span></span>
<span id="cb66-131"><a href="#cb66-131"></a><span class="in">    loop {}</span></span>
<span id="cb66-132"><a href="#cb66-132"></a><span class="in">}</span></span>
<span id="cb66-133"><a href="#cb66-133"></a><span class="in">```</span></span>
<span id="cb66-134"><a href="#cb66-134"></a></span>
<span id="cb66-135"><a href="#cb66-135"></a><span class="fu">## Just a note</span></span>
<span id="cb66-136"><a href="#cb66-136"></a></span>
<span id="cb66-137"><a href="#cb66-137"></a><span class="ss">- </span>When you make a new version for today (<span class="in">`60`</span>) </span>
<span id="cb66-138"><a href="#cb66-138"></a><span class="ss">    - </span>Probably leave out colors (<span class="in">`52`</span>) and </span>
<span id="cb66-139"><a href="#cb66-139"></a><span class="ss">    - </span>Instead start with something with <span class="in">`println!`</span> (likely <span class="in">`51`</span>)</span>
<span id="cb66-140"><a href="#cb66-140"></a></span>
<span id="cb66-141"><a href="#cb66-141"></a><span class="fu">## Today's Starting Point</span></span>
<span id="cb66-142"><a href="#cb66-142"></a></span>
<span id="cb66-143"><a href="#cb66-143"></a><span class="in">```{.rs filename="src/main.rs"}</span></span>
<span id="cb66-144"><a href="#cb66-144"></a><span class="in">#![no_std]</span></span>
<span id="cb66-145"><a href="#cb66-145"></a><span class="in">#![no_main]</span></span>
<span id="cb66-146"><a href="#cb66-146"></a></span>
<span id="cb66-147"><a href="#cb66-147"></a><span class="in">mod vga;</span></span>
<span id="cb66-148"><a href="#cb66-148"></a></span>
<span id="cb66-149"><a href="#cb66-149"></a><span class="in">#[panic_handler]</span></span>
<span id="cb66-150"><a href="#cb66-150"></a><span class="in">fn panic(info: &amp;core::panic::PanicInfo) -&gt; ! {</span></span>
<span id="cb66-151"><a href="#cb66-151"></a><span class="in">    println!("{}", info);</span></span>
<span id="cb66-152"><a href="#cb66-152"></a><span class="in">    loop {}</span></span>
<span id="cb66-153"><a href="#cb66-153"></a><span class="in">}</span></span>
<span id="cb66-154"><a href="#cb66-154"></a></span>
<span id="cb66-155"><a href="#cb66-155"></a><span class="in">#[unsafe(no_mangle)]</span></span>
<span id="cb66-156"><a href="#cb66-156"></a><span class="in">pub extern "C" fn _start() -&gt; ! {</span></span>
<span id="cb66-157"><a href="#cb66-157"></a><span class="in">    println!("Hello world!");</span></span>
<span id="cb66-158"><a href="#cb66-158"></a><span class="in">    loop {}</span></span>
<span id="cb66-159"><a href="#cb66-159"></a><span class="in">}</span></span>
<span id="cb66-160"><a href="#cb66-160"></a><span class="in">```</span></span>
<span id="cb66-161"><a href="#cb66-161"></a></span>
<span id="cb66-162"><a href="#cb66-162"></a><span class="fu">## Adding to Main</span></span>
<span id="cb66-163"><a href="#cb66-163"></a></span>
<span id="cb66-164"><a href="#cb66-164"></a><span class="in">```{.rs filename="src/main.rs" code-line-numbers="3,4,8-14"}</span></span>
<span id="cb66-165"><a href="#cb66-165"></a><span class="in">#![no_std]</span></span>
<span id="cb66-166"><a href="#cb66-166"></a><span class="in">#![no_main]</span></span>
<span id="cb66-167"><a href="#cb66-167"></a><span class="in">#![feature(custom_test_frameworks)]</span></span>
<span id="cb66-168"><a href="#cb66-168"></a><span class="in">#![test_runner(crate::test_runner)]</span></span>
<span id="cb66-169"><a href="#cb66-169"></a></span>
<span id="cb66-170"><a href="#cb66-170"></a><span class="in">mod vga;</span></span>
<span id="cb66-171"><a href="#cb66-171"></a></span>
<span id="cb66-172"><a href="#cb66-172"></a><span class="in">#[cfg(test)]</span></span>
<span id="cb66-173"><a href="#cb66-173"></a><span class="in">pub fn test_runner(tests: &amp;[&amp;dyn Fn()]) {</span></span>
<span id="cb66-174"><a href="#cb66-174"></a><span class="in">    println!("Running {} tests", tests.len());</span></span>
<span id="cb66-175"><a href="#cb66-175"></a><span class="in">    for test in tests {</span></span>
<span id="cb66-176"><a href="#cb66-176"></a><span class="in">        test();</span></span>
<span id="cb66-177"><a href="#cb66-177"></a><span class="in">    }</span></span>
<span id="cb66-178"><a href="#cb66-178"></a><span class="in">}</span></span>
<span id="cb66-179"><a href="#cb66-179"></a></span>
<span id="cb66-180"><a href="#cb66-180"></a><span class="in">#[panic_handler]</span></span>
<span id="cb66-181"><a href="#cb66-181"></a><span class="in">fn panic(info: &amp;core::panic::PanicInfo) -&gt; ! {</span></span>
<span id="cb66-182"><a href="#cb66-182"></a><span class="in">    println!("{}", info);</span></span>
<span id="cb66-183"><a href="#cb66-183"></a><span class="in">    loop {}</span></span>
<span id="cb66-184"><a href="#cb66-184"></a><span class="in">}</span></span>
<span id="cb66-185"><a href="#cb66-185"></a></span>
<span id="cb66-186"><a href="#cb66-186"></a><span class="in">#[unsafe(no_mangle)]</span></span>
<span id="cb66-187"><a href="#cb66-187"></a><span class="in">pub extern "C" fn _start() -&gt; ! {</span></span>
<span id="cb66-188"><a href="#cb66-188"></a><span class="in">    println!("Hello world!");</span></span>
<span id="cb66-189"><a href="#cb66-189"></a><span class="in">    loop {}</span></span>
<span id="cb66-190"><a href="#cb66-190"></a><span class="in">}</span></span>
<span id="cb66-191"><a href="#cb66-191"></a><span class="in">```</span></span>
<span id="cb66-192"><a href="#cb66-192"></a></span>
<span id="cb66-193"><a href="#cb66-193"></a><span class="fu">## Wait a minute</span></span>
<span id="cb66-194"><a href="#cb66-194"></a></span>
<span id="cb66-195"><a href="#cb66-195"></a><span class="ss">- </span>What is <span class="in">`&amp;dyn`</span>?</span>
<span id="cb66-196"><a href="#cb66-196"></a><span class="ss">- </span><span class="co">[</span><span class="ot">"Keyword `dyn`</span><span class="co">](https://doc.rust-lang.org/std/keyword.dyn.html)</span></span>
<span id="cb66-197"><a href="#cb66-197"></a></span>
<span id="cb66-198"><a href="#cb66-198"></a><span class="at">&gt; The </span><span class="in">`dyn`</span><span class="at"> keyword is used to highlight that calls to methods on the associated </span><span class="in">`Trait`</span><span class="at"> are dynamically dispatched.</span></span>
<span id="cb66-199"><a href="#cb66-199"></a></span>
<span id="cb66-200"><a href="#cb66-200"></a><span class="fu">## Dynamic Dispatch</span></span>
<span id="cb66-201"><a href="#cb66-201"></a></span>
<span id="cb66-202"><a href="#cb66-202"></a><span class="at">&gt; </span><span class="co">[</span><span class="ot">In computer science, **dynamic dispatch** is the process of selecting which implementation of a polymorphic operation (method or function) to call at run time. It is commonly employed in, and considered a prime characteristic of, object-oriented programming (OOP) languages and systems.</span><span class="co">](https://en.wikipedia.org/wiki/Dynamic_dispatch)</span></span>
<span id="cb66-203"><a href="#cb66-203"></a></span>
<span id="cb66-204"><a href="#cb66-204"></a><span class="fu">## OOP</span></span>
<span id="cb66-205"><a href="#cb66-205"></a></span>
<span id="cb66-206"><a href="#cb66-206"></a><span class="ss">- </span>Yeah I'm not doing that.</span>
<span id="cb66-207"><a href="#cb66-207"></a><span class="ss">- </span>We'll maintain a list of functions.</span>
<span id="cb66-208"><a href="#cb66-208"></a><span class="ss">- </span>If you want to learn about OOP, here is a tutorial on writing a Java app for Android.</span>
<span id="cb66-209"><a href="#cb66-209"></a><span class="ss">    - </span><span class="co">[</span><span class="ot">Create your first Android app</span><span class="co">](https://developer.android.com/codelabs/basic-android-kotlin-compose-first-app?continue=https%3A%2F%2Fdeveloper.android.com%2Fcourses%2Fpathways%2Fandroid-basics-compose-unit-1-pathway-2%23codelab-https%3A%2F%2Fdeveloper.android.com%2Fcodelabs%2Fbasic-android-kotlin-compose-first-app#0)</span></span>
<span id="cb66-210"><a href="#cb66-210"></a><span class="ss">    - </span>Whoops its Kotlin (multi-paradigm).</span>
<span id="cb66-211"><a href="#cb66-211"></a><span class="ss">    - </span>Yet more evidence of the correctness of OOP.</span>
<span id="cb66-212"><a href="#cb66-212"></a></span>
<span id="cb66-213"><a href="#cb66-213"></a><span class="fu">## Write Two Functions</span></span>
<span id="cb66-214"><a href="#cb66-214"></a></span>
<span id="cb66-215"><a href="#cb66-215"></a><span class="ss">- </span>Doesn't matter but nice to have externally observable functions.</span>
<span id="cb66-216"><a href="#cb66-216"></a></span>
<span id="cb66-217"><a href="#cb66-217"></a><span class="in">```{.rs filename="src/main.rs"}</span></span>
<span id="cb66-218"><a href="#cb66-218"></a><span class="in">fn hi() {</span></span>
<span id="cb66-219"><a href="#cb66-219"></a><span class="in">    println!("Hello world!");</span></span>
<span id="cb66-220"><a href="#cb66-220"></a><span class="in">    return;</span></span>
<span id="cb66-221"><a href="#cb66-221"></a><span class="in">}</span></span>
<span id="cb66-222"><a href="#cb66-222"></a></span>
<span id="cb66-223"><a href="#cb66-223"></a><span class="in">fn bye() {</span></span>
<span id="cb66-224"><a href="#cb66-224"></a><span class="in">    println!("Goodbye space!");</span></span>
<span id="cb66-225"><a href="#cb66-225"></a><span class="in">    return;</span></span>
<span id="cb66-226"><a href="#cb66-226"></a><span class="in">}</span></span>
<span id="cb66-227"><a href="#cb66-227"></a><span class="in">```</span></span>
<span id="cb66-228"><a href="#cb66-228"></a></span>
<span id="cb66-229"><a href="#cb66-229"></a><span class="fu">## Make an array</span></span>
<span id="cb66-230"><a href="#cb66-230"></a></span>
<span id="cb66-231"><a href="#cb66-231"></a><span class="ss">- </span>Just in <span class="in">`_start`</span> for now.</span>
<span id="cb66-232"><a href="#cb66-232"></a></span>
<span id="cb66-233"><a href="#cb66-233"></a><span class="in">```{.rs filename="src/main.rs"}</span></span>
<span id="cb66-234"><a href="#cb66-234"></a><span class="in">#[unsafe(no_mangle)]</span></span>
<span id="cb66-235"><a href="#cb66-235"></a><span class="in">pub extern "C" fn _start() -&gt; ! {</span></span>
<span id="cb66-236"><a href="#cb66-236"></a><span class="in">    let fs = [hi, bye];</span></span>
<span id="cb66-237"><a href="#cb66-237"></a><span class="in">```</span></span>
<span id="cb66-238"><a href="#cb66-238"></a></span>
<span id="cb66-239"><a href="#cb66-239"></a><span class="fu">## Loop over the array</span></span>
<span id="cb66-240"><a href="#cb66-240"></a></span>
<span id="cb66-241"><a href="#cb66-241"></a><span class="ss">- </span>Same as any other for each loop.</span>
<span id="cb66-242"><a href="#cb66-242"></a><span class="ss">    - </span>I am willing to use the for each loop, but still regard it with suspicion.</span>
<span id="cb66-243"><a href="#cb66-243"></a>    </span>
<span id="cb66-244"><a href="#cb66-244"></a><span class="in">```{.rs filename="src/main.rs"}</span></span>
<span id="cb66-245"><a href="#cb66-245"></a><span class="in">    let fs = [hi, bye];</span></span>
<span id="cb66-246"><a href="#cb66-246"></a><span class="in">    for f in fs {</span></span>
<span id="cb66-247"><a href="#cb66-247"></a><span class="in">        todo!();</span></span>
<span id="cb66-248"><a href="#cb66-248"></a><span class="in">    }</span></span>
<span id="cb66-249"><a href="#cb66-249"></a><span class="in">```</span></span>
<span id="cb66-250"><a href="#cb66-250"></a></span>
<span id="cb66-251"><a href="#cb66-251"></a><span class="fu">## Call each function</span></span>
<span id="cb66-252"><a href="#cb66-252"></a>  </span>
<span id="cb66-253"><a href="#cb66-253"></a><span class="ss">- </span>What do you see?</span>
<span id="cb66-254"><a href="#cb66-254"></a>    </span>
<span id="cb66-255"><a href="#cb66-255"></a><span class="in">```{.rs filename="src/main.rs"}</span></span>
<span id="cb66-256"><a href="#cb66-256"></a><span class="in">    let fs = [hi, bye];</span></span>
<span id="cb66-257"><a href="#cb66-257"></a><span class="in">    for f in fs {</span></span>
<span id="cb66-258"><a href="#cb66-258"></a><span class="in">        f();</span></span>
<span id="cb66-259"><a href="#cb66-259"></a><span class="in">    }</span></span>
<span id="cb66-260"><a href="#cb66-260"></a><span class="in">```</span>  </span>
<span id="cb66-261"><a href="#cb66-261"></a></span>
<span id="cb66-262"><a href="#cb66-262"></a><span class="fu">## Sample out</span></span>
<span id="cb66-263"><a href="#cb66-263"></a></span>
<span id="cb66-264"><a href="#cb66-264"></a>&lt;img src="data:image/png;base64, iVBORw0KGgoAAAANSUhEUgAAAtAAAAGQCAIAAAAIhcA6AAAFJ0lEQVR4nO3dyXaDIBQAUMzp//9y</span>
<span id="cb66-265"><a href="#cb66-265"></a>ujAlVgw+p4TovasaFKEb8DGlBAAAAPDtuvv9nlLquq6/Hl3W9TdP3l9JakS9hLNVa7ZeANCg25aH</span>
<span id="cb66-266"><a href="#cb66-266"></a>K41u++1xvYSvUnNHJP8BAMza1OEAAIj4qSePvuO3xy1WZFgOYQx/eZVhvmfF4I7oBQDs6xHhuP8Z</span>
<span id="cb66-267"><a href="#cb66-267"></a>puU2u5c2t8TvzHB4uehd9Ska+ff2x4wAoB2PCMcoMDD07Z/7i3oGJoQCwBFmhlRSS63vlt5AO7UA</span>
<span id="cb66-268"><a href="#cb66-268"></a>gAua73Awou8CAEstWKVSTvJ4p3bWo372/wAA32hm46/6opJhajBp3bKXcu7nbAkrZQuWMK9wmaya</span>
<span id="cb66-269"><a href="#cb66-269"></a>OAcAAAA0pKuMDviIBwB2YadRAAAAAAAAAIDPiy4iXaE8NW3FOWqnYTEtAFd2S/+PQEv77axVNq6X</span>
<span id="cb66-270"><a href="#cb66-270"></a>bW7b2bUMAD7iNvryvmyfAAA4zsRZKsGNQeObkJbK8YUtG57W31I+lTOfHOIJbp9aeSpeQgC4iNo+</span>
<span id="cb66-271"><a href="#cb66-271"></a>HMOhltFoSyUpBeYrLBq7qb9rxVP5cjLD2Uot/W8kASQALu8Z4dhr3mhwdmQfYOhb/Xi2caP84zUK</span>
<span id="cb66-272"><a href="#cb66-272"></a>vqjM0PwMAHjl2eHYd8bo7lb0gXKfI/54eUrcoSUEgIs4+dbmuy+92V4SALigWyPtcVwOWsRvO6KO</span>
<span id="cb66-273"><a href="#cb66-273"></a>lWJMJgWLDQCnNLEl13Bexbp1GaPchqnxDINPVXyw8K9meAhyAEBDjo4HiDcAwDu1OIdDMAAATqaV</span>
<span id="cb66-274"><a href="#cb66-274"></a>Rv2dG2cdcXAMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span>
<span id="cb66-275"><a href="#cb66-275"></a>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span>
<span id="cb66-276"><a href="#cb66-276"></a>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span>
<span id="cb66-277"><a href="#cb66-277"></a>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span>
<span id="cb66-278"><a href="#cb66-278"></a>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span>
<span id="cb66-279"><a href="#cb66-279"></a>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span>
<span id="cb66-280"><a href="#cb66-280"></a>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span>
<span id="cb66-281"><a href="#cb66-281"></a>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span>
<span id="cb66-282"><a href="#cb66-282"></a>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span>
<span id="cb66-283"><a href="#cb66-283"></a>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span>
<span id="cb66-284"><a href="#cb66-284"></a>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span>
<span id="cb66-285"><a href="#cb66-285"></a>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span>
<span id="cb66-286"><a href="#cb66-286"></a>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span>
<span id="cb66-287"><a href="#cb66-287"></a>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAZ/ULzGetS97yp6YAAAAA</span>
<span id="cb66-288"><a href="#cb66-288"></a>SUVORK5CYII="&gt;</span>
<span id="cb66-289"><a href="#cb66-289"></a></span>
<span id="cb66-290"><a href="#cb66-290"></a><span class="fu"># Aside: Bits</span></span>
<span id="cb66-291"><a href="#cb66-291"></a></span>
<span id="cb66-292"><a href="#cb66-292"></a><span class="fu">## Pulling back the curtain</span></span>
<span id="cb66-293"><a href="#cb66-293"></a></span>
<span id="cb66-294"><a href="#cb66-294"></a><span class="ss">- </span>I'm insane.</span>
<span id="cb66-295"><a href="#cb66-295"></a><span class="ss">- </span>I ran this then screendumped (in QEMU) to <span class="in">`fs.ppm`</span></span>
<span id="cb66-296"><a href="#cb66-296"></a><span class="ss">- </span>I converted to <span class="in">`.png`</span></span>
<span id="cb66-297"><a href="#cb66-297"></a><span class="in">```{.sh}</span></span>
<span id="cb66-298"><a href="#cb66-298"></a><span class="in">python3 -c "from PIL import Image; Image.open('fs.ppm').save('fs.png')"</span></span>
<span id="cb66-299"><a href="#cb66-299"></a><span class="in">```</span></span>
<span id="cb66-300"><a href="#cb66-300"></a><span class="ss">- </span>I <span class="in">`base64`</span> the PNG.</span>
<span id="cb66-301"><a href="#cb66-301"></a><span class="ss">    - </span>See next slide.</span>
<span id="cb66-302"><a href="#cb66-302"></a></span>
<span id="cb66-303"><a href="#cb66-303"></a><span class="fu">## It's tiny!</span></span>
<span id="cb66-304"><a href="#cb66-304"></a></span>
<span id="cb66-305"><a href="#cb66-305"></a><span class="in">```{.sh}</span></span>
<span id="cb66-306"><a href="#cb66-306"></a><span class="in">$ base64 fs.png | wc</span></span>
<span id="cb66-307"><a href="#cb66-307"></a><span class="in">     25      25    1861</span></span>
<span id="cb66-308"><a href="#cb66-308"></a><span class="in">$ base64 fs.png</span></span>
<span id="cb66-309"><a href="#cb66-309"></a><span class="in">iVBORw0KGgoAAAANSUhEUgAAAtAAAAGQCAIAAAAIhcA6AAAFJ0lEQVR4nO3dyXaDIBQAUMzp//9y</span></span>
<span id="cb66-310"><a href="#cb66-310"></a><span class="in">ujAlVgw+p4TovasaFKEb8DGlBAAAAPDtuvv9nlLquq6/Hl3W9TdP3l9JakS9hLNVa7ZeANCg25aH</span></span>
<span id="cb66-311"><a href="#cb66-311"></a><span class="in">K41u++1xvYSvUnNHJP8BAMza1OEAAIj4qSePvuO3xy1WZFgOYQx/eZVhvmfF4I7oBQDs6xHhuP8Z</span></span>
<span id="cb66-312"><a href="#cb66-312"></a><span class="in">puU2u5c2t8TvzHB4uehd9Ska+ff2x4wAoB2PCMcoMDD07Z/7i3oGJoQCwBFmhlRSS63vlt5AO7UA</span></span>
<span id="cb66-313"><a href="#cb66-313"></a><span class="in">gAua73Awou8CAEstWKVSTvJ4p3bWo372/wAA32hm46/6opJhajBp3bKXcu7nbAkrZQuWMK9wmaya</span></span>
<span id="cb66-314"><a href="#cb66-314"></a><span class="in">OAcAAAA0pKuMDviIBwB2YadRAAAAAAAAAIDPiy4iXaE8NW3FOWqnYTEtAFd2S/+PQEv77axVNq6X</span></span>
<span id="cb66-315"><a href="#cb66-315"></a><span class="in">bW7b2bUMAD7iNvryvmyfAAA4zsRZKsGNQeObkJbK8YUtG57W31I+lTOfHOIJbp9aeSpeQgC4iNo+</span></span>
<span id="cb66-316"><a href="#cb66-316"></a><span class="in">HMOhltFoSyUpBeYrLBq7qb9rxVP5cjLD2Uot/W8kASQALu8Z4dhr3mhwdmQfYOhb/Xi2caP84zUK</span></span>
<span id="cb66-317"><a href="#cb66-317"></a><span class="in">vqjM0PwMAHjl2eHYd8bo7lb0gXKfI/54eUrcoSUEgIs4+dbmuy+92V4SALigWyPtcVwOWsRvO6KO</span></span>
<span id="cb66-318"><a href="#cb66-318"></a><span class="in">lWJMJgWLDQCnNLEl13Bexbp1GaPchqnxDINPVXyw8K9meAhyAEBDjo4HiDcAwDu1OIdDMAAATqaV</span></span>
<span id="cb66-319"><a href="#cb66-319"></a><span class="in">Rv2dG2cdcXAMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span></span>
<span id="cb66-320"><a href="#cb66-320"></a><span class="in">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span></span>
<span id="cb66-321"><a href="#cb66-321"></a><span class="in">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span></span>
<span id="cb66-322"><a href="#cb66-322"></a><span class="in">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span></span>
<span id="cb66-323"><a href="#cb66-323"></a><span class="in">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span></span>
<span id="cb66-324"><a href="#cb66-324"></a><span class="in">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span></span>
<span id="cb66-325"><a href="#cb66-325"></a><span class="in">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span></span>
<span id="cb66-326"><a href="#cb66-326"></a><span class="in">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span></span>
<span id="cb66-327"><a href="#cb66-327"></a><span class="in">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span></span>
<span id="cb66-328"><a href="#cb66-328"></a><span class="in">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span></span>
<span id="cb66-329"><a href="#cb66-329"></a><span class="in">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span></span>
<span id="cb66-330"><a href="#cb66-330"></a><span class="in">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span></span>
<span id="cb66-331"><a href="#cb66-331"></a><span class="in">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span></span>
<span id="cb66-332"><a href="#cb66-332"></a><span class="in">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAZ/ULzGetS97yp6YAAAAA</span></span>
<span id="cb66-333"><a href="#cb66-333"></a><span class="in">SUVORK5CYII=</span></span>
<span id="cb66-334"><a href="#cb66-334"></a><span class="in">```</span></span>
<span id="cb66-335"><a href="#cb66-335"></a></span>
<span id="cb66-336"><a href="#cb66-336"></a><span class="fu">## To HTML</span></span>
<span id="cb66-337"><a href="#cb66-337"></a></span>
<span id="cb66-338"><a href="#cb66-338"></a><span class="ss">- </span>I read <span class="co">[</span><span class="ot">this stackoverflow answer</span><span class="co">](https://stackoverflow.com/a/8499716)</span></span>
<span id="cb66-339"><a href="#cb66-339"></a><span class="ss">- </span>It contains this snippet</span>
<span id="cb66-340"><a href="#cb66-340"></a><span class="in">```{.html}</span></span>
<span id="cb66-341"><a href="#cb66-341"></a><span class="in">&lt;div&gt;</span></span>
<span id="cb66-342"><a href="#cb66-342"></a><span class="in">  &lt;p&gt;Taken from wikpedia&lt;/p&gt;</span></span>
<span id="cb66-343"><a href="#cb66-343"></a><span class="in">  &lt;img src="data:image/png;base64, iVBORw0KGgoAAAANSUhEUgAAAAUA</span></span>
<span id="cb66-344"><a href="#cb66-344"></a><span class="in">    AAAFCAYAAACNbyblAAAAHElEQVQI12P4//8/w38GIAXDIBKE0DHxgljNBAAO</span></span>
<span id="cb66-345"><a href="#cb66-345"></a><span class="in">        9TXL0Y4OHwAAAABJRU5ErkJggg==" alt="Red dot" /&gt;</span></span>
<span id="cb66-346"><a href="#cb66-346"></a><span class="in">&lt;/div&gt;</span></span>
<span id="cb66-347"><a href="#cb66-347"></a><span class="in">```</span></span>
<span id="cb66-348"><a href="#cb66-348"></a><span class="ss">- </span>I only need this:</span>
<span id="cb66-349"><a href="#cb66-349"></a><span class="in">```{.html}</span></span>
<span id="cb66-350"><a href="#cb66-350"></a><span class="in">&lt;img src="data:image/png;base64, "&gt;</span></span>
<span id="cb66-351"><a href="#cb66-351"></a><span class="in">```</span></span>
<span id="cb66-352"><a href="#cb66-352"></a></span>
<span id="cb66-353"><a href="#cb66-353"></a><span class="fu">## Here it is</span></span>
<span id="cb66-354"><a href="#cb66-354"></a></span>
<span id="cb66-355"><a href="#cb66-355"></a><span class="ss">- </span>And then I placed that exact HTML within my Markdown.</span>
<span id="cb66-356"><a href="#cb66-356"></a><span class="ss">    - </span>With the <span class="in">`base64`</span> PNG data within.</span>
<span id="cb66-357"><a href="#cb66-357"></a></span>
<span id="cb66-358"><a href="#cb66-358"></a>&lt;img src="data:image/png;base64, iVBORw0KGgoAAAANSUhEUgAAAtAAAAGQCAIAAAAIhcA6AAAFJ0lEQVR4nO3dyXaDIBQAUMzp//9y</span>
<span id="cb66-359"><a href="#cb66-359"></a>ujAlVgw+p4TovasaFKEb8DGlBAAAAPDtuvv9nlLquq6/Hl3W9TdP3l9JakS9hLNVa7ZeANCg25aH</span>
<span id="cb66-360"><a href="#cb66-360"></a>K41u++1xvYSvUnNHJP8BAMza1OEAAIj4qSePvuO3xy1WZFgOYQx/eZVhvmfF4I7oBQDs6xHhuP8Z</span>
<span id="cb66-361"><a href="#cb66-361"></a>puU2u5c2t8TvzHB4uehd9Ska+ff2x4wAoB2PCMcoMDD07Z/7i3oGJoQCwBFmhlRSS63vlt5AO7UA</span>
<span id="cb66-362"><a href="#cb66-362"></a>gAua73Awou8CAEstWKVSTvJ4p3bWo372/wAA32hm46/6opJhajBp3bKXcu7nbAkrZQuWMK9wmaya</span>
<span id="cb66-363"><a href="#cb66-363"></a>OAcAAAA0pKuMDviIBwB2YadRAAAAAAAAAIDPiy4iXaE8NW3FOWqnYTEtAFd2S/+PQEv77axVNq6X</span>
<span id="cb66-364"><a href="#cb66-364"></a>bW7b2bUMAD7iNvryvmyfAAA4zsRZKsGNQeObkJbK8YUtG57W31I+lTOfHOIJbp9aeSpeQgC4iNo+</span>
<span id="cb66-365"><a href="#cb66-365"></a>HMOhltFoSyUpBeYrLBq7qb9rxVP5cjLD2Uot/W8kASQALu8Z4dhr3mhwdmQfYOhb/Xi2caP84zUK</span>
<span id="cb66-366"><a href="#cb66-366"></a>vqjM0PwMAHjl2eHYd8bo7lb0gXKfI/54eUrcoSUEgIs4+dbmuy+92V4SALigWyPtcVwOWsRvO6KO</span>
<span id="cb66-367"><a href="#cb66-367"></a>lWJMJgWLDQCnNLEl13Bexbp1GaPchqnxDINPVXyw8K9meAhyAEBDjo4HiDcAwDu1OIdDMAAATqaV</span>
<span id="cb66-368"><a href="#cb66-368"></a>Rv2dG2cdcXAMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span>
<span id="cb66-369"><a href="#cb66-369"></a>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span>
<span id="cb66-370"><a href="#cb66-370"></a>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span>
<span id="cb66-371"><a href="#cb66-371"></a>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span>
<span id="cb66-372"><a href="#cb66-372"></a>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span>
<span id="cb66-373"><a href="#cb66-373"></a>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span>
<span id="cb66-374"><a href="#cb66-374"></a>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span>
<span id="cb66-375"><a href="#cb66-375"></a>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span>
<span id="cb66-376"><a href="#cb66-376"></a>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span>
<span id="cb66-377"><a href="#cb66-377"></a>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span>
<span id="cb66-378"><a href="#cb66-378"></a>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span>
<span id="cb66-379"><a href="#cb66-379"></a>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span>
<span id="cb66-380"><a href="#cb66-380"></a>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span>
<span id="cb66-381"><a href="#cb66-381"></a>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAZ/ULzGetS97yp6YAAAAA</span>
<span id="cb66-382"><a href="#cb66-382"></a>SUVORK5CYII="&gt;</span>
<span id="cb66-383"><a href="#cb66-383"></a></span>
<span id="cb66-384"><a href="#cb66-384"></a><span class="fu">## By the way</span></span>
<span id="cb66-385"><a href="#cb66-385"></a></span>
<span id="cb66-386"><a href="#cb66-386"></a><span class="ss">- </span>You can use that as a URL.</span>
<span id="cb66-387"><a href="#cb66-387"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Click me</span><span class="co">]</span>(data:image/png;base64, iVBORw0KGgoAAAANSUhEUgAAAtAAAAGQCAIAAAAIhcA6AAAFJ0lEQVR4nO3dyXaDIBQAUMzp//9y</span>
<span id="cb66-388"><a href="#cb66-388"></a>ujAlVgw+p4TovasaFKEb8DGlBAAAAPDtuvv9nlLquq6/Hl3W9TdP3l9JakS9hLNVa7ZeANCg25aH</span>
<span id="cb66-389"><a href="#cb66-389"></a>K41u++1xvYSvUnNHJP8BAMza1OEAAIj4qSePvuO3xy1WZFgOYQx/eZVhvmfF4I7oBQDs6xHhuP8Z</span>
<span id="cb66-390"><a href="#cb66-390"></a>puU2u5c2t8TvzHB4uehd9Ska+ff2x4wAoB2PCMcoMDD07Z/7i3oGJoQCwBFmhlRSS63vlt5AO7UA</span>
<span id="cb66-391"><a href="#cb66-391"></a>gAua73Awou8CAEstWKVSTvJ4p3bWo372/wAA32hm46/6opJhajBp3bKXcu7nbAkrZQuWMK9wmaya</span>
<span id="cb66-392"><a href="#cb66-392"></a>OAcAAAA0pKuMDviIBwB2YadRAAAAAAAAAIDPiy4iXaE8NW3FOWqnYTEtAFd2S/+PQEv77axVNq6X</span>
<span id="cb66-393"><a href="#cb66-393"></a>bW7b2bUMAD7iNvryvmyfAAA4zsRZKsGNQeObkJbK8YUtG57W31I+lTOfHOIJbp9aeSpeQgC4iNo+</span>
<span id="cb66-394"><a href="#cb66-394"></a>HMOhltFoSyUpBeYrLBq7qb9rxVP5cjLD2Uot/W8kASQALu8Z4dhr3mhwdmQfYOhb/Xi2caP84zUK</span>
<span id="cb66-395"><a href="#cb66-395"></a>vqjM0PwMAHjl2eHYd8bo7lb0gXKfI/54eUrcoSUEgIs4+dbmuy+92V4SALigWyPtcVwOWsRvO6KO</span>
<span id="cb66-396"><a href="#cb66-396"></a>lWJMJgWLDQCnNLEl13Bexbp1GaPchqnxDINPVXyw8K9meAhyAEBDjo4HiDcAwDu1OIdDMAAATqaV</span>
<span id="cb66-397"><a href="#cb66-397"></a>Rv2dG2cdcXAMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span>
<span id="cb66-398"><a href="#cb66-398"></a>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span>
<span id="cb66-399"><a href="#cb66-399"></a>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span>
<span id="cb66-400"><a href="#cb66-400"></a>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span>
<span id="cb66-401"><a href="#cb66-401"></a>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span>
<span id="cb66-402"><a href="#cb66-402"></a>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span>
<span id="cb66-403"><a href="#cb66-403"></a>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span>
<span id="cb66-404"><a href="#cb66-404"></a>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span>
<span id="cb66-405"><a href="#cb66-405"></a>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span>
<span id="cb66-406"><a href="#cb66-406"></a>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span>
<span id="cb66-407"><a href="#cb66-407"></a>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span>
<span id="cb66-408"><a href="#cb66-408"></a>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span>
<span id="cb66-409"><a href="#cb66-409"></a>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span>
<span id="cb66-410"><a href="#cb66-410"></a>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAZ/ULzGetS97yp6YAAAAA</span>
<span id="cb66-411"><a href="#cb66-411"></a>SUVORK5CYII=)</span>
<span id="cb66-412"><a href="#cb66-412"></a><span class="ss">- </span>Okay back to work.</span>
<span id="cb66-413"><a href="#cb66-413"></a></span>
<span id="cb66-414"><a href="#cb66-414"></a><span class="fu">## Wait Just Kidding</span></span>
<span id="cb66-415"><a href="#cb66-415"></a></span>
<span id="cb66-416"><a href="#cb66-416"></a><span class="ss">- </span>Manually edit the data.</span>
<span id="cb66-417"><a href="#cb66-417"></a><span class="ss">- </span>Delete *exactly* 24 <span class="in">`A`</span> values in the big block.</span>
<span id="cb66-418"><a href="#cb66-418"></a><span class="ss">    - </span>24 values at 6 bits of information each yields 144 bits or 18 bytes.</span>
<span id="cb66-419"><a href="#cb66-419"></a><span class="ss">    - </span>What do you see?</span>
<span id="cb66-420"><a href="#cb66-420"></a><span class="ss">    - </span>What if you delete not a multiple of 24?</span>
<span id="cb66-421"><a href="#cb66-421"></a><span class="ss">    - </span>What if you delete a different 24?</span>
<span id="cb66-422"><a href="#cb66-422"></a>    </span>
<span id="cb66-423"><a href="#cb66-423"></a><span class="fu">## Quote Me</span></span>
<span id="cb66-424"><a href="#cb66-424"></a></span>
<span id="cb66-425"><a href="#cb66-425"></a><span class="at">&gt; "They're my bits, in my computer - let me use them!"</span></span>
<span id="cb66-426"><a href="#cb66-426"></a></span>
<span id="cb66-427"><a href="#cb66-427"></a><span class="fu"># Back to Work</span></span>
<span id="cb66-428"><a href="#cb66-428"></a></span>
<span id="cb66-429"><a href="#cb66-429"></a><span class="fu">## Recall</span></span>
<span id="cb66-430"><a href="#cb66-430"></a></span>
<span id="cb66-431"><a href="#cb66-431"></a><span class="ss">- </span>Rust is trying to get us to write Java instead of C.</span>
<span id="cb66-432"><a href="#cb66-432"></a></span>
<span id="cb66-433"><a href="#cb66-433"></a><span class="in">```{.rs filename="src/main.rs"}</span></span>
<span id="cb66-434"><a href="#cb66-434"></a><span class="in">#[cfg(test)]</span></span>
<span id="cb66-435"><a href="#cb66-435"></a><span class="in">pub fn test_runner(tests: &amp;[&amp;dyn Fn()]) {</span></span>
<span id="cb66-436"><a href="#cb66-436"></a><span class="in">    println!("Running {} tests", tests.len());</span></span>
<span id="cb66-437"><a href="#cb66-437"></a><span class="in">    for test in tests {</span></span>
<span id="cb66-438"><a href="#cb66-438"></a><span class="in">        test();</span></span>
<span id="cb66-439"><a href="#cb66-439"></a><span class="in">    }</span></span>
<span id="cb66-440"><a href="#cb66-440"></a><span class="in">}</span></span>
<span id="cb66-441"><a href="#cb66-441"></a><span class="in">```</span></span>
<span id="cb66-442"><a href="#cb66-442"></a></span>
<span id="cb66-443"><a href="#cb66-443"></a><span class="fu">## Outsmart Rust</span></span>
<span id="cb66-444"><a href="#cb66-444"></a></span>
<span id="cb66-445"><a href="#cb66-445"></a><span class="ss">- </span>Ignore the argument via <span class="in">`_`</span></span>
<span id="cb66-446"><a href="#cb66-446"></a><span class="ss">- </span>Include the stuff from inside <span class="in">`_start`</span>.</span>
<span id="cb66-447"><a href="#cb66-447"></a><span class="in">```{.rs filename="src/main.rs"}</span></span>
<span id="cb66-448"><a href="#cb66-448"></a><span class="in">#[cfg(test)]</span></span>
<span id="cb66-449"><a href="#cb66-449"></a><span class="in">pub fn test_runner(_tests: &amp;[&amp;dyn Fn()]) {</span></span>
<span id="cb66-450"><a href="#cb66-450"></a><span class="in">    let fs = [hi, bye];</span></span>
<span id="cb66-451"><a href="#cb66-451"></a><span class="in">    println!("Running {} tests", fs.len());</span></span>
<span id="cb66-452"><a href="#cb66-452"></a><span class="in">    for f in fs {</span></span>
<span id="cb66-453"><a href="#cb66-453"></a><span class="in">        f();</span></span>
<span id="cb66-454"><a href="#cb66-454"></a><span class="in">    }</span></span>
<span id="cb66-455"><a href="#cb66-455"></a><span class="in">}</span></span>
<span id="cb66-456"><a href="#cb66-456"></a><span class="in">```</span></span>
<span id="cb66-457"><a href="#cb66-457"></a><span class="ss">- </span>Probably change <span class="in">`main`</span> too so you know what is running, mine says "I'm main".</span>
<span id="cb66-458"><a href="#cb66-458"></a></span>
<span id="cb66-459"><a href="#cb66-459"></a><span class="fu">## Check it</span></span>
<span id="cb66-460"><a href="#cb66-460"></a></span>
<span id="cb66-461"><a href="#cb66-461"></a><span class="ss">- </span>You can run the tests via:</span>
<span id="cb66-462"><a href="#cb66-462"></a><span class="in">```{.sh}</span></span>
<span id="cb66-463"><a href="#cb66-463"></a><span class="in">cargo +nightly t</span></span>
<span id="cb66-464"><a href="#cb66-464"></a><span class="in">```</span></span>
<span id="cb66-465"><a href="#cb66-465"></a><span class="ss">- </span>Wow that <span class="in">`+nightly`</span> is getting annoying.</span>
<span id="cb66-466"><a href="#cb66-466"></a><span class="ss">    - </span>Time for an aside.</span>
<span id="cb66-467"><a href="#cb66-467"></a>    </span>
<span id="cb66-468"><a href="#cb66-468"></a><span class="fu"># Aside: Nightly</span></span>
<span id="cb66-469"><a href="#cb66-469"></a></span>
<span id="cb66-470"><a href="#cb66-470"></a><span class="fu">## Back to Stack</span></span>
<span id="cb66-471"><a href="#cb66-471"></a></span>
<span id="cb66-472"><a href="#cb66-472"></a><span class="ss">- </span>I love stackoverflow.</span>
<span id="cb66-473"><a href="#cb66-473"></a><span class="ss">    - </span>Too bad it is slowly being incinerated by generative AI</span>
<span id="cb66-474"><a href="#cb66-474"></a><span class="ss">    - </span>Surely this will lead to no long-term problems.</span>
<span id="cb66-475"><a href="#cb66-475"></a><span class="ss">- </span>Check out <span class="co">[</span><span class="ot">this answer</span><span class="co">](https://stackoverflow.com/questions/67094650/set-a-project-to-use-nightly-by-default)</span></span>
<span id="cb66-476"><a href="#cb66-476"></a></span>
<span id="cb66-477"><a href="#cb66-477"></a></span>
<span id="cb66-478"><a href="#cb66-478"></a><span class="fu">## It states</span></span>
<span id="cb66-479"><a href="#cb66-479"></a></span>
<span id="cb66-480"><a href="#cb66-480"></a><span class="at">&gt; you can add a rust-toolchain.toml file, for example</span></span>
<span id="cb66-481"><a href="#cb66-481"></a></span>
<span id="cb66-482"><a href="#cb66-482"></a><span class="in">```{.toml filename="rust-toolchain.toml"}</span></span>
<span id="cb66-483"><a href="#cb66-483"></a><span class="in">[toolchain]</span></span>
<span id="cb66-484"><a href="#cb66-484"></a><span class="in">channel = "nightly"</span></span>
<span id="cb66-485"><a href="#cb66-485"></a><span class="in">```</span></span>
<span id="cb66-486"><a href="#cb66-486"></a></span>
<span id="cb66-487"><a href="#cb66-487"></a><span class="ss">- </span>I am doing this now.</span>
<span id="cb66-488"><a href="#cb66-488"></a></span>
<span id="cb66-489"><a href="#cb66-489"></a><span class="fu">## What I see</span></span>
<span id="cb66-490"><a href="#cb66-490"></a></span>
<span id="cb66-491"><a href="#cb66-491"></a><span class="ss">- </span>I removed my <span class="in">`target`</span> for clarity.</span>
<span id="cb66-492"><a href="#cb66-492"></a></span>
<span id="cb66-493"><a href="#cb66-493"></a><span class="in">```{.sh}</span></span>
<span id="cb66-494"><a href="#cb66-494"></a><span class="in">$ rm -rf target/</span></span>
<span id="cb66-495"><a href="#cb66-495"></a><span class="in">$ tree</span></span>
<span id="cb66-496"><a href="#cb66-496"></a><span class="in">.</span></span>
<span id="cb66-497"><a href="#cb66-497"></a><span class="in">├── Cargo.lock</span></span>
<span id="cb66-498"><a href="#cb66-498"></a><span class="in">├── Cargo.toml</span></span>
<span id="cb66-499"><a href="#cb66-499"></a><span class="in">├── rust-toolchain.toml</span></span>
<span id="cb66-500"><a href="#cb66-500"></a><span class="in">├── src</span></span>
<span id="cb66-501"><a href="#cb66-501"></a><span class="in">│&nbsp;&nbsp; ├── main.rs</span></span>
<span id="cb66-502"><a href="#cb66-502"></a><span class="in">│&nbsp;&nbsp; └── vga.rs</span></span>
<span id="cb66-503"><a href="#cb66-503"></a><span class="in">└── x86_64-osirs.json</span></span>
<span id="cb66-504"><a href="#cb66-504"></a></span>
<span id="cb66-505"><a href="#cb66-505"></a><span class="in">1 directory, 6 files</span></span>
<span id="cb66-506"><a href="#cb66-506"></a><span class="in">```</span></span>
<span id="cb66-507"><a href="#cb66-507"></a></span>
<span id="cb66-508"><a href="#cb66-508"></a><span class="fu">## The other way</span></span>
<span id="cb66-509"><a href="#cb66-509"></a></span>
<span id="cb66-510"><a href="#cb66-510"></a><span class="ss">- </span>If you wish to use nightly in all projects, you can check <span class="co">[</span><span class="ot">this answer</span><span class="co">](https://stackoverflow.com/a/65644807)</span>.</span>
<span id="cb66-511"><a href="#cb66-511"></a><span class="ss">- </span>There are a variety of intermediate ways, of course.</span>
<span id="cb66-512"><a href="#cb66-512"></a><span class="ss">- </span>Okay back to work.</span>
<span id="cb66-513"><a href="#cb66-513"></a></span>
<span id="cb66-514"><a href="#cb66-514"></a><span class="fu"># Back to Work</span></span>
<span id="cb66-515"><a href="#cb66-515"></a></span>
<span id="cb66-516"><a href="#cb66-516"></a><span class="fu">## Recall</span></span>
<span id="cb66-517"><a href="#cb66-517"></a></span>
<span id="cb66-518"><a href="#cb66-518"></a><span class="ss">- </span>We were trying to run tests.</span>
<span id="cb66-519"><a href="#cb66-519"></a><span class="in">```{.sh}</span></span>
<span id="cb66-520"><a href="#cb66-520"></a><span class="in">cargo t # FINALLY</span></span>
<span id="cb66-521"><a href="#cb66-521"></a><span class="in">```</span></span>
<span id="cb66-522"><a href="#cb66-522"></a><span class="ss">- </span>You may notice this is just running <span class="in">`_start`</span>.</span>
<span id="cb66-523"><a href="#cb66-523"></a><span class="ss">- </span>That is because <span class="in">`src/main.rs`</span> is a fan of the Black Eyed Peas.</span>
<span id="cb66-524"><a href="#cb66-524"></a><span class="ss">    - </span><span class="co">[</span><span class="ot">Learn more</span><span class="co">](https://www.youtube.com/watch?v=IKqV7DB8Iwg)</span></span>
<span id="cb66-525"><a href="#cb66-525"></a><span class="ss">    - </span>Note to Calvin - do not click that in class.</span>
<span id="cb66-526"><a href="#cb66-526"></a>    </span>
<span id="cb66-527"><a href="#cb66-527"></a><span class="fu">## Surprise!</span></span>
<span id="cb66-528"><a href="#cb66-528"></a></span>
<span id="cb66-529"><a href="#cb66-529"></a><span class="ss">- </span>Something not going as planned on the first try?</span>
<span id="cb66-530"><a href="#cb66-530"></a><span class="ss">- </span>Our <span class="in">`_start`</span> function is still used as entry point.</span>
<span id="cb66-531"><a href="#cb66-531"></a><span class="ss">    - </span>It is, after all, the <span class="in">`_start`</span> function.</span>
<span id="cb66-532"><a href="#cb66-532"></a>    </span>
<span id="cb66-533"><a href="#cb66-533"></a><span class="fu">## The Problem</span></span>
<span id="cb66-534"><a href="#cb66-534"></a></span>
<span id="cb66-535"><a href="#cb66-535"></a><span class="ss">- </span>The custom test frameworks feature generates a <span class="in">`main`</span> function that calls <span class="in">`test_runner`</span></span>
<span id="cb66-536"><a href="#cb66-536"></a><span class="ss">    - </span>What is it for? Software?</span>
<span id="cb66-537"><a href="#cb66-537"></a><span class="ss">    - </span>Might as well use Kotlin!</span>
<span id="cb66-538"><a href="#cb66-538"></a><span class="ss">- </span>Our OS, of course, never calls <span class="in">`main`</span>.</span>
<span id="cb66-539"><a href="#cb66-539"></a>    </span>
<span id="cb66-540"><a href="#cb66-540"></a><span class="fu">## Maybe problem</span></span>
<span id="cb66-541"><a href="#cb66-541"></a></span>
<span id="cb66-542"><a href="#cb66-542"></a><span class="ss">- </span>If you see "duplicate lang item" expand:</span>
<span id="cb66-543"><a href="#cb66-543"></a></span>
<span id="cb66-544"><a href="#cb66-544"></a>&lt;details&gt;</span>
<span id="cb66-545"><a href="#cb66-545"></a></span>
<span id="cb66-546"><a href="#cb66-546"></a>**Note:** There is currently a bug in cargo that leads to "duplicate lang item" errors on <span class="in">`cargo test`</span> in some cases. It occurs when you have set <span class="in">`panic = "abort"`</span> for a profile in your <span class="in">`Cargo.toml`</span>. Try removing it, then <span class="in">`cargo test`</span> should work. Alternatively, if that doesn't work, then add <span class="in">`panic-abort-tests = true`</span> to the <span class="in">`[unstable]`</span> section of your <span class="in">`.cargo/config.toml`</span> file. See the <span class="co">[</span><span class="ot">cargo issue</span><span class="co">](https://github.com/rust-lang/cargo/issues/7359)</span> for more information on this.</span>
<span id="cb66-547"><a href="#cb66-547"></a></span>
<span id="cb66-548"><a href="#cb66-548"></a>&lt;/details&gt;</span>
<span id="cb66-549"><a href="#cb66-549"></a></span>
<span id="cb66-550"><a href="#cb66-550"></a><span class="fu">## Fine, I'll do it myself</span></span>
<span id="cb66-551"><a href="#cb66-551"></a></span>
<span id="cb66-552"><a href="#cb66-552"></a><span class="ss">- </span>Simply call <span class="in">`test_runner`</span> from <span class="in">`_start`</span></span>
<span id="cb66-553"><a href="#cb66-553"></a><span class="ss">    - </span>It needs a borrowed array of whatevers, so give it one.</span>
<span id="cb66-554"><a href="#cb66-554"></a></span>
<span id="cb66-555"><a href="#cb66-555"></a><span class="in">```{.rs filename="src/main.rs"}</span></span>
<span id="cb66-556"><a href="#cb66-556"></a><span class="in">#[unsafe(no_mangle)]</span></span>
<span id="cb66-557"><a href="#cb66-557"></a><span class="in">pub extern "C" fn _start() -&gt; ! {</span></span>
<span id="cb66-558"><a href="#cb66-558"></a><span class="in">    println!("I'm main.");</span></span>
<span id="cb66-559"><a href="#cb66-559"></a><span class="in">    test_runner(&amp;[]);</span></span>
<span id="cb66-560"><a href="#cb66-560"></a><span class="in">    loop {}</span></span>
<span id="cb66-561"><a href="#cb66-561"></a><span class="in">}</span></span>
<span id="cb66-562"><a href="#cb66-562"></a><span class="in">```</span></span>
<span id="cb66-563"><a href="#cb66-563"></a></span>
<span id="cb66-564"><a href="#cb66-564"></a><span class="fu">## Only problem</span></span>
<span id="cb66-565"><a href="#cb66-565"></a></span>
<span id="cb66-566"><a href="#cb66-566"></a></span>
<span id="cb66-567"><a href="#cb66-567"></a><span class="ss">- </span>What if we <span class="in">`run`</span> instead of <span class="in">`test`</span>?</span>
<span id="cb66-568"><a href="#cb66-568"></a></span>
<span id="cb66-569"><a href="#cb66-569"></a><span class="in">```{.sh}</span></span>
<span id="cb66-570"><a href="#cb66-570"></a><span class="in">$ cargo r</span></span>
<span id="cb66-571"><a href="#cb66-571"></a><span class="in">   Compiling osirs v0.1.0 (/home/user/tmp/work)</span></span>
<span id="cb66-572"><a href="#cb66-572"></a><span class="in">error[E0423]: expected function, found built-in attribute `test_runner`</span></span>
<span id="cb66-573"><a href="#cb66-573"></a><span class="in">  --&gt; src/main.rs:26:5</span></span>
<span id="cb66-574"><a href="#cb66-574"></a><span class="in">   |</span></span>
<span id="cb66-575"><a href="#cb66-575"></a><span class="in">26 |     test_runner(&amp;[]);</span></span>
<span id="cb66-576"><a href="#cb66-576"></a><span class="in">   |     ^^^^^^^^^^^ not a function</span></span>
<span id="cb66-577"><a href="#cb66-577"></a><span class="in">   |</span></span>
<span id="cb66-578"><a href="#cb66-578"></a><span class="in">note: found an item that was configured out</span></span>
<span id="cb66-579"><a href="#cb66-579"></a><span class="in">  --&gt; src/main.rs:9:4</span></span>
<span id="cb66-580"><a href="#cb66-580"></a><span class="in">   |</span></span>
<span id="cb66-581"><a href="#cb66-581"></a><span class="in"> 8 | #[cfg(test)]</span></span>
<span id="cb66-582"><a href="#cb66-582"></a><span class="in">   |       ---- the item is gated here</span></span>
<span id="cb66-583"><a href="#cb66-583"></a><span class="in"> 9 | fn test_runner(_tests: &amp;[&amp;dyn Fn()]) {</span></span>
<span id="cb66-584"><a href="#cb66-584"></a><span class="in">   |    ^^^^^^^^^^^</span></span>
<span id="cb66-585"><a href="#cb66-585"></a></span>
<span id="cb66-586"><a href="#cb66-586"></a><span class="in">For more information about this error, try `rustc --explain E0423`.</span></span>
<span id="cb66-587"><a href="#cb66-587"></a><span class="in">error: could not compile `osirs` (bin "osirs") due to 1 previous error</span></span>
<span id="cb66-588"><a href="#cb66-588"></a><span class="in">```</span></span>
<span id="cb66-589"><a href="#cb66-589"></a></span>
<span id="cb66-590"><a href="#cb66-590"></a><span class="fu">## Conditional Compilation</span></span>
<span id="cb66-591"><a href="#cb66-591"></a></span>
<span id="cb66-592"><a href="#cb66-592"></a><span class="ss">- </span>We need to *conditionally* compile <span class="in">`_start`</span> to either call <span class="in">`test_runner`</span> or not.</span>
<span id="cb66-593"><a href="#cb66-593"></a><span class="ss">- </span>No problem, we already know how to do this!</span>
<span id="cb66-594"><a href="#cb66-594"></a><span class="ss">- </span><span class="in">`#[cfg(test)]`</span></span>
<span id="cb66-595"><a href="#cb66-595"></a></span>
<span id="cb66-596"><a href="#cb66-596"></a><span class="in">```{.rs filename="src/main.rs"}</span></span>
<span id="cb66-597"><a href="#cb66-597"></a><span class="in">#[unsafe(no_mangle)]</span></span>
<span id="cb66-598"><a href="#cb66-598"></a><span class="in">pub extern "C" fn _start() -&gt; ! {</span></span>
<span id="cb66-599"><a href="#cb66-599"></a><span class="in">    println!("I'm main{}", ".");</span></span>
<span id="cb66-600"><a href="#cb66-600"></a></span>
<span id="cb66-601"><a href="#cb66-601"></a><span class="in">    #[cfg(test)]</span></span>
<span id="cb66-602"><a href="#cb66-602"></a><span class="in">    test_runner(&amp;[]);</span></span>
<span id="cb66-603"><a href="#cb66-603"></a></span>
<span id="cb66-604"><a href="#cb66-604"></a><span class="in">    loop {}</span></span>
<span id="cb66-605"><a href="#cb66-605"></a><span class="in">}</span></span>
<span id="cb66-606"><a href="#cb66-606"></a><span class="in">```</span></span>
<span id="cb66-607"><a href="#cb66-607"></a></span>
<span id="cb66-608"><a href="#cb66-608"></a></span>
<span id="cb66-609"><a href="#cb66-609"></a><span class="fu">## Only problem</span></span>
<span id="cb66-610"><a href="#cb66-610"></a></span>
<span id="cb66-611"><a href="#cb66-611"></a><span class="ss">- </span>What if we <span class="in">`run`</span> instead of <span class="in">`test`</span>?</span>
<span id="cb66-612"><a href="#cb66-612"></a></span>
<span id="cb66-613"><a href="#cb66-613"></a><span class="in">```{.sh}</span></span>
<span id="cb66-614"><a href="#cb66-614"></a><span class="in">$ cargo r</span></span>
<span id="cb66-615"><a href="#cb66-615"></a><span class="in">   Compiling osirs v0.1.0 (/home/user/tmp/work)</span></span>
<span id="cb66-616"><a href="#cb66-616"></a><span class="in">warning: function `hi` is never used</span></span>
<span id="cb66-617"><a href="#cb66-617"></a><span class="in">  --&gt; src/main.rs:32:4</span></span>
<span id="cb66-618"><a href="#cb66-618"></a><span class="in">   |</span></span>
<span id="cb66-619"><a href="#cb66-619"></a><span class="in">32 | fn hi() {</span></span>
<span id="cb66-620"><a href="#cb66-620"></a><span class="in">   |    ^^</span></span>
<span id="cb66-621"><a href="#cb66-621"></a><span class="in">   |</span></span>
<span id="cb66-622"><a href="#cb66-622"></a><span class="in">   = note: `#[warn(dead_code)]` (part of `#[warn(unused)]`) on by default</span></span>
<span id="cb66-623"><a href="#cb66-623"></a></span>
<span id="cb66-624"><a href="#cb66-624"></a><span class="in">warning: function `bye` is never used</span></span>
<span id="cb66-625"><a href="#cb66-625"></a><span class="in">  --&gt; src/main.rs:37:4</span></span>
<span id="cb66-626"><a href="#cb66-626"></a><span class="in">   |</span></span>
<span id="cb66-627"><a href="#cb66-627"></a><span class="in">37 | fn bye() {</span></span>
<span id="cb66-628"><a href="#cb66-628"></a><span class="in">   |    ^^^</span></span>
<span id="cb66-629"><a href="#cb66-629"></a><span class="in">```</span></span>
<span id="cb66-630"><a href="#cb66-630"></a></span>
<span id="cb66-631"><a href="#cb66-631"></a><span class="fu">## Correct Way</span></span>
<span id="cb66-632"><a href="#cb66-632"></a></span>
<span id="cb66-633"><a href="#cb66-633"></a><span class="ss">- </span>There is a correct way to solve this.</span>
<span id="cb66-634"><a href="#cb66-634"></a><span class="ss">- </span>Separately, there is the opposite: my way.</span>
<span id="cb66-635"><a href="#cb66-635"></a><span class="ss">- </span>I renamed them with a <span class="in">`_`</span> prefix.</span>
<span id="cb66-636"><a href="#cb66-636"></a><span class="in">```{.rs}</span></span>
<span id="cb66-637"><a href="#cb66-637"></a><span class="in">    for f in [_hi, _bye] {</span></span>
<span id="cb66-638"><a href="#cb66-638"></a><span class="in">        f();</span></span>
<span id="cb66-639"><a href="#cb66-639"></a><span class="in">    }</span></span>
<span id="cb66-640"><a href="#cb66-640"></a><span class="in">```</span></span>
<span id="cb66-641"><a href="#cb66-641"></a></span>
<span id="cb66-642"><a href="#cb66-642"></a></span>
<span id="cb66-643"><a href="#cb66-643"></a><span class="fu">## Todo</span></span>
<span id="cb66-644"><a href="#cb66-644"></a></span>
<span id="cb66-645"><a href="#cb66-645"></a>We are now ready to create our first test function:</span>
<span id="cb66-646"><a href="#cb66-646"></a></span>
<span id="cb66-647"><a href="#cb66-647"></a><span class="in">```rust</span></span>
<span id="cb66-648"><a href="#cb66-648"></a><span class="co">// in src/main.rs</span></span>
<span id="cb66-649"><a href="#cb66-649"></a></span>
<span id="cb66-650"><a href="#cb66-650"></a><span class="at">#[</span>test_case<span class="at">]</span></span>
<span id="cb66-651"><a href="#cb66-651"></a><span class="kw">fn</span> trivial_assertion() <span class="op">{</span></span>
<span id="cb66-652"><a href="#cb66-652"></a>    <span class="pp">print!</span>(<span class="st">"trivial assertion... "</span>)<span class="op">;</span></span>
<span id="cb66-653"><a href="#cb66-653"></a>    <span class="pp">assert_eq!</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb66-654"><a href="#cb66-654"></a>    <span class="pp">println!</span>(<span class="st">"[ok]"</span>)<span class="op">;</span></span>
<span id="cb66-655"><a href="#cb66-655"></a><span class="op">}</span></span>
<span id="cb66-656"><a href="#cb66-656"></a><span class="in">```</span></span>
<span id="cb66-657"><a href="#cb66-657"></a></span>
<span id="cb66-658"><a href="#cb66-658"></a>When we run <span class="in">`cargo test`</span> now, we see the following output:</span>
<span id="cb66-659"><a href="#cb66-659"></a></span>
<span id="cb66-660"><a href="#cb66-660"></a>!<span class="co">[</span><span class="ot">QEMU printing "Hello World!", "Running 1 tests", and "trivial assertion... [ok]"</span><span class="co">](qemu-test-runner-output.png)</span></span>
<span id="cb66-661"><a href="#cb66-661"></a></span>
<span id="cb66-662"><a href="#cb66-662"></a>The <span class="in">`tests`</span> slice passed to our <span class="in">`test_runner`</span> function now contains a reference to the <span class="in">`trivial_assertion`</span> function. From the <span class="in">`trivial assertion... [ok]`</span> output on the screen, we see that the test was called and that it succeeded.</span>
<span id="cb66-663"><a href="#cb66-663"></a></span>
<span id="cb66-664"><a href="#cb66-664"></a>After executing the tests, our <span class="in">`test_runner`</span> returns to the <span class="in">`test_main`</span> function, which in turn returns to our <span class="in">`_start`</span> entry point function. At the end of <span class="in">`_start`</span>, we enter an endless loop because the entry point function is not allowed to return. This is a problem, because we want <span class="in">`cargo test`</span> to exit after running all tests.</span>
<span id="cb66-665"><a href="#cb66-665"></a></span>
<span id="cb66-666"><a href="#cb66-666"></a><span class="fu">## Exiting QEMU</span></span>
<span id="cb66-667"><a href="#cb66-667"></a></span>
<span id="cb66-668"><a href="#cb66-668"></a>Right now, we have an endless loop at the end of our <span class="in">`_start`</span> function and need to close QEMU manually on each execution of <span class="in">`cargo test`</span>. This is unfortunate because we also want to run <span class="in">`cargo test`</span> in scripts without user interaction. The clean solution to this would be to implement a proper way to shutdown our OS. Unfortunately, this is relatively complex because it requires implementing support for either the <span class="co">[</span><span class="ot">APM</span><span class="co">]</span> or <span class="co">[</span><span class="ot">ACPI</span><span class="co">]</span> power management standard.</span>
<span id="cb66-669"><a href="#cb66-669"></a></span>
<span id="cb66-670"><a href="#cb66-670"></a><span class="ot">[APM]: https://wiki.osdev.org/APM</span></span>
<span id="cb66-671"><a href="#cb66-671"></a><span class="ot">[ACPI]: https://wiki.osdev.org/ACPI</span></span>
<span id="cb66-672"><a href="#cb66-672"></a></span>
<span id="cb66-673"><a href="#cb66-673"></a>Luckily, there is an escape hatch: QEMU supports a special <span class="in">`isa-debug-exit`</span> device, which provides an easy way to exit QEMU from the guest system. To enable it, we need to pass a <span class="in">`-device`</span> argument to QEMU. We can do so by adding a <span class="in">`package.metadata.bootimage.test-args`</span> configuration key in our <span class="in">`Cargo.toml`</span>:</span>
<span id="cb66-674"><a href="#cb66-674"></a></span>
<span id="cb66-675"><a href="#cb66-675"></a><span class="in">```toml</span></span>
<span id="cb66-676"><a href="#cb66-676"></a><span class="in"># in Cargo.toml</span></span>
<span id="cb66-677"><a href="#cb66-677"></a></span>
<span id="cb66-678"><a href="#cb66-678"></a><span class="in">[package.metadata.bootimage]</span></span>
<span id="cb66-679"><a href="#cb66-679"></a><span class="in">test-args = ["-device", "isa-debug-exit,iobase=0xf4,iosize=0x04"]</span></span>
<span id="cb66-680"><a href="#cb66-680"></a><span class="in">```</span></span>
<span id="cb66-681"><a href="#cb66-681"></a></span>
<span id="cb66-682"><a href="#cb66-682"></a>The <span class="in">`bootimage runner`</span> appends the <span class="in">`test-args`</span> to the default QEMU command for all test executables. For a normal <span class="in">`cargo run`</span>, the arguments are ignored.</span>
<span id="cb66-683"><a href="#cb66-683"></a></span>
<span id="cb66-684"><a href="#cb66-684"></a>Together with the device name (<span class="in">`isa-debug-exit`</span>), we pass the two parameters <span class="in">`iobase`</span> and <span class="in">`iosize`</span> that specify the _I/O port_ through which the device can be reached from our kernel.</span>
<span id="cb66-685"><a href="#cb66-685"></a></span>
<span id="cb66-686"><a href="#cb66-686"></a><span class="fu">### I/O Ports</span></span>
<span id="cb66-687"><a href="#cb66-687"></a></span>
<span id="cb66-688"><a href="#cb66-688"></a>There are two different approaches for communicating between the CPU and peripheral hardware on x86, **memory-mapped I/O** and **port-mapped I/O**. We already used memory-mapped I/O for accessing the <span class="co">[</span><span class="ot">VGA text buffer</span><span class="co">]</span> through the memory address <span class="in">`0xb8000`</span>. This address is not mapped to RAM but to some memory on the VGA device.</span>
<span id="cb66-689"><a href="#cb66-689"></a></span>
<span id="cb66-690"><a href="#cb66-690"></a><span class="ot">[VGA text buffer]: </span>@/edition-2/posts/03-vga-text-buffer/index.md</span>
<span id="cb66-691"><a href="#cb66-691"></a></span>
<span id="cb66-692"><a href="#cb66-692"></a>In contrast, port-mapped I/O uses a separate I/O bus for communication. Each connected peripheral has one or more port numbers. To communicate with such an I/O port, there are special CPU instructions called <span class="in">`in`</span> and <span class="in">`out`</span>, which take a port number and a data byte (there are also variations of these commands that allow sending a <span class="in">`u16`</span> or <span class="in">`u32`</span>).</span>
<span id="cb66-693"><a href="#cb66-693"></a></span>
<span id="cb66-694"><a href="#cb66-694"></a>The <span class="in">`isa-debug-exit`</span> device uses port-mapped I/O. The <span class="in">`iobase`</span> parameter specifies on which port address the device should live (<span class="in">`0xf4`</span> is a <span class="co">[</span><span class="ot">generally unused</span><span class="co">][list of x86 I/O ports]</span> port on the x86's IO bus) and the <span class="in">`iosize`</span> specifies the port size (<span class="in">`0x04`</span> means four bytes).</span>
<span id="cb66-695"><a href="#cb66-695"></a></span>
<span id="cb66-696"><a href="#cb66-696"></a><span class="ot">[list of x86 I/O ports]: https://wiki.osdev.org/I/O_Ports#The_list</span></span>
<span id="cb66-697"><a href="#cb66-697"></a></span>
<span id="cb66-698"><a href="#cb66-698"></a><span class="fu">### Using the Exit Device</span></span>
<span id="cb66-699"><a href="#cb66-699"></a></span>
<span id="cb66-700"><a href="#cb66-700"></a>The functionality of the <span class="in">`isa-debug-exit`</span> device is very simple. When a <span class="in">`value`</span> is written to the I/O port specified by <span class="in">`iobase`</span>, it causes QEMU to exit with <span class="co">[</span><span class="ot">exit status</span><span class="co">]</span> <span class="in">`(value &lt;&lt; 1) | 1`</span>. So when we write <span class="in">`0`</span> to the port, QEMU will exit with exit status <span class="in">`(0 &lt;&lt; 1) | 1 = 1`</span>, and when we write <span class="in">`1`</span> to the port, it will exit with exit status <span class="in">`(1 &lt;&lt; 1) | 1 = 3`</span>.</span>
<span id="cb66-701"><a href="#cb66-701"></a></span>
<span id="cb66-702"><a href="#cb66-702"></a><span class="ot">[exit status]: https://en.wikipedia.org/wiki/Exit_status</span></span>
<span id="cb66-703"><a href="#cb66-703"></a></span>
<span id="cb66-704"><a href="#cb66-704"></a>Instead of manually invoking the <span class="in">`in`</span> and <span class="in">`out`</span> assembly instructions, we use the abstractions provided by the <span class="co">[</span><span class="ot">`x86_64`</span><span class="co">]</span> crate. To add a dependency on that crate, we add it to the <span class="in">`dependencies`</span> section in our <span class="in">`Cargo.toml`</span>:</span>
<span id="cb66-705"><a href="#cb66-705"></a></span>
<span id="cb66-706"><a href="#cb66-706"></a><span class="ot">[`x86_64`]: https://docs.rs/x86_64/0.14.2/x86_64/</span></span>
<span id="cb66-707"><a href="#cb66-707"></a></span>
<span id="cb66-708"><a href="#cb66-708"></a><span class="in">```toml</span></span>
<span id="cb66-709"><a href="#cb66-709"></a><span class="in"># in Cargo.toml</span></span>
<span id="cb66-710"><a href="#cb66-710"></a></span>
<span id="cb66-711"><a href="#cb66-711"></a><span class="in">[dependencies]</span></span>
<span id="cb66-712"><a href="#cb66-712"></a><span class="in">x86_64 = "0.14.2"</span></span>
<span id="cb66-713"><a href="#cb66-713"></a><span class="in">```</span></span>
<span id="cb66-714"><a href="#cb66-714"></a></span>
<span id="cb66-715"><a href="#cb66-715"></a>Now we can use the <span class="co">[</span><span class="ot">`Port`</span><span class="co">]</span> type provided by the crate to create an <span class="in">`exit_qemu`</span> function:</span>
<span id="cb66-716"><a href="#cb66-716"></a></span>
<span id="cb66-717"><a href="#cb66-717"></a><span class="ot">[`Port`]: https://docs.rs/x86_64/0.14.2/x86_64/instructions/port/struct.Port.html</span></span>
<span id="cb66-718"><a href="#cb66-718"></a></span>
<span id="cb66-719"><a href="#cb66-719"></a><span class="in">```rust</span></span>
<span id="cb66-720"><a href="#cb66-720"></a><span class="co">// in src/main.rs</span></span>
<span id="cb66-721"><a href="#cb66-721"></a></span>
<span id="cb66-722"><a href="#cb66-722"></a><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="op">,</span> <span class="bu">Clone</span><span class="op">,</span> <span class="bu">Copy</span><span class="op">,</span> <span class="bu">PartialEq</span><span class="op">,</span> <span class="bu">Eq</span><span class="at">)]</span></span>
<span id="cb66-723"><a href="#cb66-723"></a><span class="at">#[</span>repr<span class="at">(</span><span class="dt">u32</span><span class="at">)]</span></span>
<span id="cb66-724"><a href="#cb66-724"></a><span class="kw">pub</span> <span class="kw">enum</span> QemuExitCode <span class="op">{</span></span>
<span id="cb66-725"><a href="#cb66-725"></a>    <span class="cn">Success</span> <span class="op">=</span> <span class="dv">0x10</span><span class="op">,</span></span>
<span id="cb66-726"><a href="#cb66-726"></a>    Failed <span class="op">=</span> <span class="dv">0x11</span><span class="op">,</span></span>
<span id="cb66-727"><a href="#cb66-727"></a><span class="op">}</span></span>
<span id="cb66-728"><a href="#cb66-728"></a></span>
<span id="cb66-729"><a href="#cb66-729"></a><span class="kw">pub</span> <span class="kw">fn</span> exit_qemu(exit_code<span class="op">:</span> QemuExitCode) <span class="op">{</span></span>
<span id="cb66-730"><a href="#cb66-730"></a>    <span class="kw">use</span> <span class="pp">x86_64::instructions::port::</span>Port<span class="op">;</span></span>
<span id="cb66-731"><a href="#cb66-731"></a></span>
<span id="cb66-732"><a href="#cb66-732"></a>    <span class="kw">unsafe</span> <span class="op">{</span></span>
<span id="cb66-733"><a href="#cb66-733"></a>        <span class="kw">let</span> <span class="kw">mut</span> port <span class="op">=</span> <span class="pp">Port::</span>new(<span class="dv">0xf4</span>)<span class="op">;</span></span>
<span id="cb66-734"><a href="#cb66-734"></a>        port<span class="op">.</span>write(exit_code <span class="kw">as</span> <span class="dt">u32</span>)<span class="op">;</span></span>
<span id="cb66-735"><a href="#cb66-735"></a>    <span class="op">}</span></span>
<span id="cb66-736"><a href="#cb66-736"></a><span class="op">}</span></span>
<span id="cb66-737"><a href="#cb66-737"></a><span class="in">```</span></span>
<span id="cb66-738"><a href="#cb66-738"></a></span>
<span id="cb66-739"><a href="#cb66-739"></a>The function creates a new <span class="co">[</span><span class="ot">`Port`</span><span class="co">]</span> at <span class="in">`0xf4`</span>, which is the <span class="in">`iobase`</span> of the <span class="in">`isa-debug-exit`</span> device. Then it writes the passed exit code to the port. We use <span class="in">`u32`</span> because we specified the <span class="in">`iosize`</span> of the <span class="in">`isa-debug-exit`</span> device as 4 bytes. Both operations are unsafe because writing to an I/O port can generally result in arbitrary behavior.</span>
<span id="cb66-740"><a href="#cb66-740"></a></span>
<span id="cb66-741"><a href="#cb66-741"></a>To specify the exit status, we create a <span class="in">`QemuExitCode`</span> enum. The idea is to exit with the success exit code if all tests succeeded and with the failure exit code otherwise. The enum is marked as <span class="in">`#[repr(u32)]`</span> to represent each variant by a <span class="in">`u32`</span> integer. We use the exit code <span class="in">`0x10`</span> for success and <span class="in">`0x11`</span> for failure. The actual exit codes don't matter much, as long as they don't clash with the default exit codes of QEMU. For example, using exit code <span class="in">`0`</span> for success is not a good idea because it becomes <span class="in">`(0 &lt;&lt; 1) | 1 = 1`</span> after the transformation, which is the default exit code when QEMU fails to run. So we could not differentiate a QEMU error from a successful test run.</span>
<span id="cb66-742"><a href="#cb66-742"></a></span>
<span id="cb66-743"><a href="#cb66-743"></a>We can now update our <span class="in">`test_runner`</span> to exit QEMU after all tests have run:</span>
<span id="cb66-744"><a href="#cb66-744"></a></span>
<span id="cb66-745"><a href="#cb66-745"></a><span class="in">```rust</span></span>
<span id="cb66-746"><a href="#cb66-746"></a><span class="co">// in src/main.rs</span></span>
<span id="cb66-747"><a href="#cb66-747"></a></span>
<span id="cb66-748"><a href="#cb66-748"></a><span class="kw">fn</span> test_runner(tests<span class="op">:</span> <span class="op">&amp;</span>[<span class="op">&amp;</span><span class="kw">dyn</span> <span class="bu">Fn</span>()]) <span class="op">{</span></span>
<span id="cb66-749"><a href="#cb66-749"></a>    <span class="pp">println!</span>(<span class="st">"Running {} tests"</span><span class="op">,</span> tests<span class="op">.</span>len())<span class="op">;</span></span>
<span id="cb66-750"><a href="#cb66-750"></a>    <span class="cf">for</span> test <span class="kw">in</span> tests <span class="op">{</span></span>
<span id="cb66-751"><a href="#cb66-751"></a>        test()<span class="op">;</span></span>
<span id="cb66-752"><a href="#cb66-752"></a>    <span class="op">}</span></span>
<span id="cb66-753"><a href="#cb66-753"></a>    <span class="co">/// new</span></span>
<span id="cb66-754"><a href="#cb66-754"></a>    exit_qemu(<span class="pp">QemuExitCode::</span><span class="cn">Success</span>)<span class="op">;</span></span>
<span id="cb66-755"><a href="#cb66-755"></a><span class="op">}</span></span>
<span id="cb66-756"><a href="#cb66-756"></a><span class="in">```</span></span>
<span id="cb66-757"><a href="#cb66-757"></a></span>
<span id="cb66-758"><a href="#cb66-758"></a>When we run <span class="in">`cargo test`</span> now, we see that QEMU immediately closes after executing the tests. The problem is that <span class="in">`cargo test`</span> interprets the test as failed even though we passed our <span class="in">`Success`</span> exit code:</span>
<span id="cb66-759"><a href="#cb66-759"></a></span>
<span id="cb66-760"><a href="#cb66-760"></a><span class="in">```</span></span>
<span id="cb66-761"><a href="#cb66-761"></a><span class="in">&gt; cargo test</span></span>
<span id="cb66-762"><a href="#cb66-762"></a><span class="in">    Finished dev [unoptimized + debuginfo] target(s) in 0.03s</span></span>
<span id="cb66-763"><a href="#cb66-763"></a><span class="in">     Running target/x86_64-blog_os/debug/deps/blog_os-5804fc7d2dd4c9be</span></span>
<span id="cb66-764"><a href="#cb66-764"></a><span class="in">Building bootloader</span></span>
<span id="cb66-765"><a href="#cb66-765"></a><span class="in">   Compiling bootloader v0.5.3 (/home/philipp/Documents/bootloader)</span></span>
<span id="cb66-766"><a href="#cb66-766"></a><span class="in">    Finished release [optimized + debuginfo] target(s) in 1.07s</span></span>
<span id="cb66-767"><a href="#cb66-767"></a><span class="in">Running: `qemu-system-x86_64 -drive format=raw,file=/…/target/x86_64-blog_os/debug/</span></span>
<span id="cb66-768"><a href="#cb66-768"></a><span class="in">    deps/bootimage-blog_os-5804fc7d2dd4c9be.bin -device isa-debug-exit,iobase=0xf4,</span></span>
<span id="cb66-769"><a href="#cb66-769"></a><span class="in">    iosize=0x04`</span></span>
<span id="cb66-770"><a href="#cb66-770"></a><span class="in">error: test failed, to rerun pass '--bin blog_os'</span></span>
<span id="cb66-771"><a href="#cb66-771"></a><span class="in">```</span></span>
<span id="cb66-772"><a href="#cb66-772"></a></span>
<span id="cb66-773"><a href="#cb66-773"></a>The problem is that <span class="in">`cargo test`</span> considers all error codes other than <span class="in">`0`</span> as failure.</span>
<span id="cb66-774"><a href="#cb66-774"></a></span>
<span id="cb66-775"><a href="#cb66-775"></a><span class="fu">### Success Exit Code</span></span>
<span id="cb66-776"><a href="#cb66-776"></a></span>
<span id="cb66-777"><a href="#cb66-777"></a>To work around this, <span class="in">`bootimage`</span> provides a <span class="in">`test-success-exit-code`</span> configuration key that maps a specified exit code to the exit code <span class="in">`0`</span>:</span>
<span id="cb66-778"><a href="#cb66-778"></a></span>
<span id="cb66-779"><a href="#cb66-779"></a><span class="in">```toml</span></span>
<span id="cb66-780"><a href="#cb66-780"></a><span class="in"># in Cargo.toml</span></span>
<span id="cb66-781"><a href="#cb66-781"></a></span>
<span id="cb66-782"><a href="#cb66-782"></a><span class="in">[package.metadata.bootimage]</span></span>
<span id="cb66-783"><a href="#cb66-783"></a><span class="in">test-args = […]</span></span>
<span id="cb66-784"><a href="#cb66-784"></a><span class="in">test-success-exit-code = 33         # (0x10 &lt;&lt; 1) | 1</span></span>
<span id="cb66-785"><a href="#cb66-785"></a><span class="in">```</span></span>
<span id="cb66-786"><a href="#cb66-786"></a></span>
<span id="cb66-787"><a href="#cb66-787"></a>With this configuration, <span class="in">`bootimage`</span> maps our success exit code to exit code 0, so that <span class="in">`cargo test`</span> correctly recognizes the success case and does not count the test as failed.</span>
<span id="cb66-788"><a href="#cb66-788"></a></span>
<span id="cb66-789"><a href="#cb66-789"></a>Our test runner now automatically closes QEMU and correctly reports the test results. We still see the QEMU window open for a very short time, but it does not suffice to read the results. It would be nice if we could print the test results to the console instead, so we can still see them after QEMU exits.</span>
<span id="cb66-790"><a href="#cb66-790"></a></span>
<span id="cb66-791"><a href="#cb66-791"></a><span class="fu">## Printing to the Console</span></span>
<span id="cb66-792"><a href="#cb66-792"></a></span>
<span id="cb66-793"><a href="#cb66-793"></a>To see the test output on the console, we need to send the data from our kernel to the host system somehow. There are various ways to achieve this, for example, by sending the data over a TCP network interface. However, setting up a networking stack is quite a complex task, so we will choose a simpler solution instead.</span>
<span id="cb66-794"><a href="#cb66-794"></a></span>
<span id="cb66-795"><a href="#cb66-795"></a><span class="fu">### Serial Port</span></span>
<span id="cb66-796"><a href="#cb66-796"></a></span>
<span id="cb66-797"><a href="#cb66-797"></a>A simple way to send the data is to use the <span class="co">[</span><span class="ot">serial port</span><span class="co">]</span>, an old interface standard which is no longer found in modern computers. It is easy to program and QEMU can redirect the bytes sent over serial to the host's standard output or a file.</span>
<span id="cb66-798"><a href="#cb66-798"></a></span>
<span id="cb66-799"><a href="#cb66-799"></a><span class="ot">[serial port]: https://en.wikipedia.org/wiki/Serial_port</span></span>
<span id="cb66-800"><a href="#cb66-800"></a></span>
<span id="cb66-801"><a href="#cb66-801"></a>The chips implementing a serial interface are called <span class="co">[</span><span class="ot">UARTs</span><span class="co">]</span>. There are <span class="co">[</span><span class="ot">lots of UART models</span><span class="co">]</span> on x86, but fortunately the only differences between them are some advanced features we don't need. The common UARTs today are all compatible with the <span class="co">[</span><span class="ot">16550 UART</span><span class="co">]</span>, so we will use that model for our testing framework.</span>
<span id="cb66-802"><a href="#cb66-802"></a></span>
<span id="cb66-803"><a href="#cb66-803"></a><span class="ot">[UARTs]: https://en.wikipedia.org/wiki/Universal_asynchronous_receiver-transmitter</span></span>
<span id="cb66-804"><a href="#cb66-804"></a><span class="ot">[lots of UART models]: https://en.wikipedia.org/wiki/Universal_asynchronous_receiver-transmitter#Models</span></span>
<span id="cb66-805"><a href="#cb66-805"></a><span class="ot">[16550 UART]: https://en.wikipedia.org/wiki/16550_UART</span></span>
<span id="cb66-806"><a href="#cb66-806"></a></span>
<span id="cb66-807"><a href="#cb66-807"></a>We will use the <span class="co">[</span><span class="ot">`uart_16550`</span><span class="co">]</span> crate to initialize the UART and send data over the serial port. To add it as a dependency, we update our <span class="in">`Cargo.toml`</span> and <span class="in">`main.rs`</span>:</span>
<span id="cb66-808"><a href="#cb66-808"></a></span>
<span id="cb66-809"><a href="#cb66-809"></a><span class="ot">[`uart_16550`]: https://docs.rs/uart_16550</span></span>
<span id="cb66-810"><a href="#cb66-810"></a></span>
<span id="cb66-811"><a href="#cb66-811"></a><span class="in">```toml</span></span>
<span id="cb66-812"><a href="#cb66-812"></a><span class="in"># in Cargo.toml</span></span>
<span id="cb66-813"><a href="#cb66-813"></a></span>
<span id="cb66-814"><a href="#cb66-814"></a><span class="in">[dependencies]</span></span>
<span id="cb66-815"><a href="#cb66-815"></a><span class="in">uart_16550 = "0.2.0"</span></span>
<span id="cb66-816"><a href="#cb66-816"></a><span class="in">```</span></span>
<span id="cb66-817"><a href="#cb66-817"></a></span>
<span id="cb66-818"><a href="#cb66-818"></a>The <span class="in">`uart_16550`</span> crate contains a <span class="in">`SerialPort`</span> struct that represents the UART registers, but we still need to construct an instance of it ourselves. For that, we create a new <span class="in">`serial`</span> module with the following content:</span>
<span id="cb66-819"><a href="#cb66-819"></a></span>
<span id="cb66-820"><a href="#cb66-820"></a><span class="in">```rust</span></span>
<span id="cb66-821"><a href="#cb66-821"></a><span class="co">// in src/main.rs</span></span>
<span id="cb66-822"><a href="#cb66-822"></a></span>
<span id="cb66-823"><a href="#cb66-823"></a><span class="kw">mod</span> serial<span class="op">;</span></span>
<span id="cb66-824"><a href="#cb66-824"></a><span class="in">```</span></span>
<span id="cb66-825"><a href="#cb66-825"></a></span>
<span id="cb66-826"><a href="#cb66-826"></a><span class="in">```rust</span></span>
<span id="cb66-827"><a href="#cb66-827"></a><span class="co">// in src/serial.rs</span></span>
<span id="cb66-828"><a href="#cb66-828"></a></span>
<span id="cb66-829"><a href="#cb66-829"></a><span class="kw">use</span> <span class="pp">uart_16550::</span>SerialPort<span class="op">;</span></span>
<span id="cb66-830"><a href="#cb66-830"></a><span class="kw">use</span> <span class="pp">spin::</span>Mutex<span class="op">;</span></span>
<span id="cb66-831"><a href="#cb66-831"></a><span class="kw">use</span> <span class="pp">lazy_static::</span>lazy_static<span class="op">;</span></span>
<span id="cb66-832"><a href="#cb66-832"></a></span>
<span id="cb66-833"><a href="#cb66-833"></a><span class="pp">lazy_static!</span> <span class="op">{</span></span>
<span id="cb66-834"><a href="#cb66-834"></a>    <span class="kw">pub</span> <span class="kw">static</span> <span class="kw">ref</span> SERIAL1<span class="op">:</span> Mutex<span class="op">&lt;</span>SerialPort<span class="op">&gt;</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb66-835"><a href="#cb66-835"></a>        <span class="kw">let</span> <span class="kw">mut</span> serial_port <span class="op">=</span> <span class="kw">unsafe</span> <span class="op">{</span> <span class="pp">SerialPort::</span>new(<span class="dv">0x3F8</span>) <span class="op">};</span></span>
<span id="cb66-836"><a href="#cb66-836"></a>        serial_port<span class="op">.</span>init()<span class="op">;</span></span>
<span id="cb66-837"><a href="#cb66-837"></a>        <span class="pp">Mutex::</span>new(serial_port)</span>
<span id="cb66-838"><a href="#cb66-838"></a>    <span class="op">};</span></span>
<span id="cb66-839"><a href="#cb66-839"></a><span class="op">}</span></span>
<span id="cb66-840"><a href="#cb66-840"></a><span class="in">```</span></span>
<span id="cb66-841"><a href="#cb66-841"></a></span>
<span id="cb66-842"><a href="#cb66-842"></a>Like with the <span class="co">[</span><span class="ot">VGA text buffer</span><span class="co">][vga lazy-static]</span>, we use <span class="in">`lazy_static`</span> and a spinlock to create a <span class="in">`static`</span> writer instance. By using <span class="in">`lazy_static`</span> we can ensure that the <span class="in">`init`</span> method is called exactly once on its first use.</span>
<span id="cb66-843"><a href="#cb66-843"></a></span>
<span id="cb66-844"><a href="#cb66-844"></a>Like the <span class="in">`isa-debug-exit`</span> device, the UART is programmed using port I/O. Since the UART is more complex, it uses multiple I/O ports for programming different device registers. The unsafe <span class="in">`SerialPort::new`</span> function expects the address of the first I/O port of the UART as an argument, from which it can calculate the addresses of all needed ports. We're passing the port address <span class="in">`0x3F8`</span>, which is the standard port number for the first serial interface.</span>
<span id="cb66-845"><a href="#cb66-845"></a></span>
<span id="cb66-846"><a href="#cb66-846"></a><span class="ot">[vga lazy-static]: </span>@/edition-2/posts/03-vga-text-buffer/index.md#lazy-statics</span>
<span id="cb66-847"><a href="#cb66-847"></a></span>
<span id="cb66-848"><a href="#cb66-848"></a>To make the serial port easily usable, we add <span class="in">`serial_print!`</span> and <span class="in">`serial_println!`</span> macros:</span>
<span id="cb66-849"><a href="#cb66-849"></a></span>
<span id="cb66-850"><a href="#cb66-850"></a><span class="in">```rust</span></span>
<span id="cb66-851"><a href="#cb66-851"></a><span class="co">// in src/serial.rs</span></span>
<span id="cb66-852"><a href="#cb66-852"></a></span>
<span id="cb66-853"><a href="#cb66-853"></a><span class="at">#[</span>doc<span class="at">(</span>hidden<span class="at">)]</span></span>
<span id="cb66-854"><a href="#cb66-854"></a><span class="kw">pub</span> <span class="kw">fn</span> _print(args<span class="op">:</span> <span class="pp">::core::fmt::</span>Arguments) <span class="op">{</span></span>
<span id="cb66-855"><a href="#cb66-855"></a>    <span class="kw">use</span> <span class="pp">core::fmt::</span><span class="bu">Write</span><span class="op">;</span></span>
<span id="cb66-856"><a href="#cb66-856"></a>    SERIAL1<span class="op">.</span>lock()<span class="op">.</span>write_fmt(args)<span class="op">.</span>expect(<span class="st">"Printing to serial failed"</span>)<span class="op">;</span></span>
<span id="cb66-857"><a href="#cb66-857"></a><span class="op">}</span></span>
<span id="cb66-858"><a href="#cb66-858"></a></span>
<span id="cb66-859"><a href="#cb66-859"></a><span class="co">/// Prints to the host through the serial interface.</span></span>
<span id="cb66-860"><a href="#cb66-860"></a><span class="at">#[</span>macro_export<span class="at">]</span></span>
<span id="cb66-861"><a href="#cb66-861"></a><span class="pp">macro_rules!</span> serial_print <span class="op">{</span></span>
<span id="cb66-862"><a href="#cb66-862"></a>    (<span class="op">$</span>(<span class="op">$</span>arg<span class="op">:</span>tt)<span class="op">*</span>) <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb66-863"><a href="#cb66-863"></a>        <span class="op">$</span><span class="pp">crate::serial::</span>_print(<span class="pp">format_args!</span>(<span class="op">$</span>(<span class="op">$</span>arg)<span class="op">*</span>))<span class="op">;</span></span>
<span id="cb66-864"><a href="#cb66-864"></a>    <span class="op">};</span></span>
<span id="cb66-865"><a href="#cb66-865"></a><span class="op">}</span></span>
<span id="cb66-866"><a href="#cb66-866"></a></span>
<span id="cb66-867"><a href="#cb66-867"></a><span class="co">/// Prints to the host through the serial interface, appending a newline.</span></span>
<span id="cb66-868"><a href="#cb66-868"></a><span class="at">#[</span>macro_export<span class="at">]</span></span>
<span id="cb66-869"><a href="#cb66-869"></a><span class="pp">macro_rules!</span> serial_println <span class="op">{</span></span>
<span id="cb66-870"><a href="#cb66-870"></a>    () <span class="op">=&gt;</span> (<span class="op">$</span><span class="pp">crate::serial_print!</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>))<span class="op">;</span></span>
<span id="cb66-871"><a href="#cb66-871"></a>    (<span class="op">$</span>fmt<span class="op">:</span>expr) <span class="op">=&gt;</span> (<span class="op">$</span><span class="pp">crate::serial_print!</span>(<span class="pp">concat!</span>(<span class="op">$</span>fmt<span class="op">,</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)))<span class="op">;</span></span>
<span id="cb66-872"><a href="#cb66-872"></a>    (<span class="op">$</span>fmt<span class="op">:</span>expr<span class="op">,</span> <span class="op">$</span>(<span class="op">$</span>arg<span class="op">:</span>tt)<span class="op">*</span>) <span class="op">=&gt;</span> (<span class="op">$</span><span class="pp">crate::serial_print!</span>(</span>
<span id="cb66-873"><a href="#cb66-873"></a>        <span class="pp">concat!</span>(<span class="op">$</span>fmt<span class="op">,</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)<span class="op">,</span> <span class="op">$</span>(<span class="op">$</span>arg)<span class="op">*</span>))<span class="op">;</span></span>
<span id="cb66-874"><a href="#cb66-874"></a><span class="op">}</span></span>
<span id="cb66-875"><a href="#cb66-875"></a><span class="in">```</span></span>
<span id="cb66-876"><a href="#cb66-876"></a></span>
<span id="cb66-877"><a href="#cb66-877"></a>The implementation is very similar to the implementation of our <span class="in">`print`</span> and <span class="in">`println`</span> macros. Since the <span class="in">`SerialPort`</span> type already implements the <span class="co">[</span><span class="ot">`fmt::Write`</span><span class="co">]</span> trait, we don't need to provide our own implementation.</span>
<span id="cb66-878"><a href="#cb66-878"></a></span>
<span id="cb66-879"><a href="#cb66-879"></a><span class="ot">[`fmt::Write`]: https://doc.rust-lang.org/nightly/core/fmt/trait.Write.html</span></span>
<span id="cb66-880"><a href="#cb66-880"></a></span>
<span id="cb66-881"><a href="#cb66-881"></a>Now we can print to the serial interface instead of the VGA text buffer in our test code:</span>
<span id="cb66-882"><a href="#cb66-882"></a></span>
<span id="cb66-883"><a href="#cb66-883"></a><span class="in">```rust</span></span>
<span id="cb66-884"><a href="#cb66-884"></a><span class="co">// in src/main.rs</span></span>
<span id="cb66-885"><a href="#cb66-885"></a></span>
<span id="cb66-886"><a href="#cb66-886"></a><span class="at">#[</span>cfg<span class="at">(</span>test<span class="at">)]</span></span>
<span id="cb66-887"><a href="#cb66-887"></a><span class="kw">fn</span> test_runner(tests<span class="op">:</span> <span class="op">&amp;</span>[<span class="op">&amp;</span><span class="kw">dyn</span> <span class="bu">Fn</span>()]) <span class="op">{</span></span>
<span id="cb66-888"><a href="#cb66-888"></a>    <span class="pp">serial_println!</span>(<span class="st">"Running {} tests"</span><span class="op">,</span> tests<span class="op">.</span>len())<span class="op">;</span></span>
<span id="cb66-889"><a href="#cb66-889"></a>    […]</span>
<span id="cb66-890"><a href="#cb66-890"></a><span class="op">}</span></span>
<span id="cb66-891"><a href="#cb66-891"></a></span>
<span id="cb66-892"><a href="#cb66-892"></a><span class="at">#[</span>test_case<span class="at">]</span></span>
<span id="cb66-893"><a href="#cb66-893"></a><span class="kw">fn</span> trivial_assertion() <span class="op">{</span></span>
<span id="cb66-894"><a href="#cb66-894"></a>    <span class="pp">serial_print!</span>(<span class="st">"trivial assertion... "</span>)<span class="op">;</span></span>
<span id="cb66-895"><a href="#cb66-895"></a>    <span class="pp">assert_eq!</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb66-896"><a href="#cb66-896"></a>    <span class="pp">serial_println!</span>(<span class="st">"[ok]"</span>)<span class="op">;</span></span>
<span id="cb66-897"><a href="#cb66-897"></a><span class="op">}</span></span>
<span id="cb66-898"><a href="#cb66-898"></a><span class="in">```</span></span>
<span id="cb66-899"><a href="#cb66-899"></a></span>
<span id="cb66-900"><a href="#cb66-900"></a>Note that the <span class="in">`serial_println`</span> macro lives directly under the root namespace because we used the <span class="in">`#[macro_export]`</span> attribute, so importing it through <span class="in">`use crate::serial::serial_println`</span> will not work.</span>
<span id="cb66-901"><a href="#cb66-901"></a></span>
<span id="cb66-902"><a href="#cb66-902"></a><span class="fu">### QEMU Arguments</span></span>
<span id="cb66-903"><a href="#cb66-903"></a></span>
<span id="cb66-904"><a href="#cb66-904"></a>To see the serial output from QEMU, we need to use the <span class="in">`-serial`</span> argument to redirect the output to stdout:</span>
<span id="cb66-905"><a href="#cb66-905"></a></span>
<span id="cb66-906"><a href="#cb66-906"></a><span class="in">```toml</span></span>
<span id="cb66-907"><a href="#cb66-907"></a><span class="in"># in Cargo.toml</span></span>
<span id="cb66-908"><a href="#cb66-908"></a></span>
<span id="cb66-909"><a href="#cb66-909"></a><span class="in">[package.metadata.bootimage]</span></span>
<span id="cb66-910"><a href="#cb66-910"></a><span class="in">test-args = [</span></span>
<span id="cb66-911"><a href="#cb66-911"></a><span class="in">    "-device", "isa-debug-exit,iobase=0xf4,iosize=0x04", "-serial", "stdio"</span></span>
<span id="cb66-912"><a href="#cb66-912"></a><span class="in">]</span></span>
<span id="cb66-913"><a href="#cb66-913"></a><span class="in">```</span></span>
<span id="cb66-914"><a href="#cb66-914"></a></span>
<span id="cb66-915"><a href="#cb66-915"></a>When we run <span class="in">`cargo test`</span> now, we see the test output directly in the console:</span>
<span id="cb66-916"><a href="#cb66-916"></a></span>
<span id="cb66-917"><a href="#cb66-917"></a><span class="in">```</span></span>
<span id="cb66-918"><a href="#cb66-918"></a><span class="in">&gt; cargo test</span></span>
<span id="cb66-919"><a href="#cb66-919"></a><span class="in">    Finished dev [unoptimized + debuginfo] target(s) in 0.02s</span></span>
<span id="cb66-920"><a href="#cb66-920"></a><span class="in">     Running target/x86_64-blog_os/debug/deps/blog_os-7b7c37b4ad62551a</span></span>
<span id="cb66-921"><a href="#cb66-921"></a><span class="in">Building bootloader</span></span>
<span id="cb66-922"><a href="#cb66-922"></a><span class="in">    Finished release [optimized + debuginfo] target(s) in 0.02s</span></span>
<span id="cb66-923"><a href="#cb66-923"></a><span class="in">Running: `qemu-system-x86_64 -drive format=raw,file=/…/target/x86_64-blog_os/debug/</span></span>
<span id="cb66-924"><a href="#cb66-924"></a><span class="in">    deps/bootimage-blog_os-7b7c37b4ad62551a.bin -device</span></span>
<span id="cb66-925"><a href="#cb66-925"></a><span class="in">    isa-debug-exit,iobase=0xf4,iosize=0x04 -serial stdio`</span></span>
<span id="cb66-926"><a href="#cb66-926"></a><span class="in">Running 1 tests</span></span>
<span id="cb66-927"><a href="#cb66-927"></a><span class="in">trivial assertion... [ok]</span></span>
<span id="cb66-928"><a href="#cb66-928"></a><span class="in">```</span></span>
<span id="cb66-929"><a href="#cb66-929"></a></span>
<span id="cb66-930"><a href="#cb66-930"></a>However, when a test fails, we still see the output inside QEMU because our panic handler still uses <span class="in">`println`</span>. To simulate this, we can change the assertion in our <span class="in">`trivial_assertion`</span> test to <span class="in">`assert_eq!(0, 1)`</span>:</span>
<span id="cb66-931"><a href="#cb66-931"></a></span>
<span id="cb66-932"><a href="#cb66-932"></a>![QEMU printing "Hello World!" and "panicked at 'assertion failed: <span class="in">`(left == right)`</span></span>
<span id="cb66-933"><a href="#cb66-933"></a>    left: <span class="in">`0`</span>, right: <span class="in">`1`</span>', src/main.rs:55:5](qemu-failed-test.png)</span>
<span id="cb66-934"><a href="#cb66-934"></a></span>
<span id="cb66-935"><a href="#cb66-935"></a>We see that the panic message is still printed to the VGA buffer, while the other test output is printed to the serial port. The panic message is quite useful, so it would be useful to see it in the console too.</span>
<span id="cb66-936"><a href="#cb66-936"></a></span>
<span id="cb66-937"><a href="#cb66-937"></a><span class="fu">### Print an Error Message on Panic</span></span>
<span id="cb66-938"><a href="#cb66-938"></a></span>
<span id="cb66-939"><a href="#cb66-939"></a>To exit QEMU with an error message on a panic, we can use <span class="co">[</span><span class="ot">conditional compilation</span><span class="co">]</span> to use a different panic handler in testing mode:</span>
<span id="cb66-940"><a href="#cb66-940"></a></span>
<span id="cb66-941"><a href="#cb66-941"></a><span class="ot">[conditional compilation]: https://doc.rust-lang.org/1.30.0/book/first-edition/conditional-compilation.html</span></span>
<span id="cb66-942"><a href="#cb66-942"></a></span>
<span id="cb66-943"><a href="#cb66-943"></a><span class="in">```rust</span></span>
<span id="cb66-944"><a href="#cb66-944"></a><span class="co">// in src/main.rs</span></span>
<span id="cb66-945"><a href="#cb66-945"></a></span>
<span id="cb66-946"><a href="#cb66-946"></a><span class="co">// our existing panic handler</span></span>
<span id="cb66-947"><a href="#cb66-947"></a><span class="at">#[</span>cfg<span class="at">(</span>not<span class="at">(</span>test<span class="at">))]</span> <span class="co">// new attribute</span></span>
<span id="cb66-948"><a href="#cb66-948"></a><span class="at">#[</span>panic_handler<span class="at">]</span></span>
<span id="cb66-949"><a href="#cb66-949"></a><span class="kw">fn</span> panic(info<span class="op">:</span> <span class="op">&amp;</span>PanicInfo) <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb66-950"><a href="#cb66-950"></a>    <span class="pp">println!</span>(<span class="st">"{}"</span><span class="op">,</span> info)<span class="op">;</span></span>
<span id="cb66-951"><a href="#cb66-951"></a>    <span class="cf">loop</span> <span class="op">{}</span></span>
<span id="cb66-952"><a href="#cb66-952"></a><span class="op">}</span></span>
<span id="cb66-953"><a href="#cb66-953"></a></span>
<span id="cb66-954"><a href="#cb66-954"></a><span class="co">// our panic handler in test mode</span></span>
<span id="cb66-955"><a href="#cb66-955"></a><span class="at">#[</span>cfg<span class="at">(</span>test<span class="at">)]</span></span>
<span id="cb66-956"><a href="#cb66-956"></a><span class="at">#[</span>panic_handler<span class="at">]</span></span>
<span id="cb66-957"><a href="#cb66-957"></a><span class="kw">fn</span> panic(info<span class="op">:</span> <span class="op">&amp;</span>PanicInfo) <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb66-958"><a href="#cb66-958"></a>    <span class="pp">serial_println!</span>(<span class="st">"[failed]</span><span class="sc">\n</span><span class="st">"</span>)<span class="op">;</span></span>
<span id="cb66-959"><a href="#cb66-959"></a>    <span class="pp">serial_println!</span>(<span class="st">"Error: {}</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> info)<span class="op">;</span></span>
<span id="cb66-960"><a href="#cb66-960"></a>    exit_qemu(<span class="pp">QemuExitCode::</span>Failed)<span class="op">;</span></span>
<span id="cb66-961"><a href="#cb66-961"></a>    <span class="cf">loop</span> <span class="op">{}</span></span>
<span id="cb66-962"><a href="#cb66-962"></a><span class="op">}</span></span>
<span id="cb66-963"><a href="#cb66-963"></a><span class="in">```</span></span>
<span id="cb66-964"><a href="#cb66-964"></a></span>
<span id="cb66-965"><a href="#cb66-965"></a>For our test panic handler, we use <span class="in">`serial_println`</span> instead of <span class="in">`println`</span> and then exit QEMU with a failure exit code. Note that we still need an endless <span class="in">`loop`</span> after the <span class="in">`exit_qemu`</span> call because the compiler does not know that the <span class="in">`isa-debug-exit`</span> device causes a program exit.</span>
<span id="cb66-966"><a href="#cb66-966"></a></span>
<span id="cb66-967"><a href="#cb66-967"></a>Now QEMU also exits for failed tests and prints a useful error message on the console:</span>
<span id="cb66-968"><a href="#cb66-968"></a></span>
<span id="cb66-969"><a href="#cb66-969"></a><span class="in">```</span></span>
<span id="cb66-970"><a href="#cb66-970"></a><span class="in">&gt; cargo test</span></span>
<span id="cb66-971"><a href="#cb66-971"></a><span class="in">    Finished dev [unoptimized + debuginfo] target(s) in 0.02s</span></span>
<span id="cb66-972"><a href="#cb66-972"></a><span class="in">     Running target/x86_64-blog_os/debug/deps/blog_os-7b7c37b4ad62551a</span></span>
<span id="cb66-973"><a href="#cb66-973"></a><span class="in">Building bootloader</span></span>
<span id="cb66-974"><a href="#cb66-974"></a><span class="in">    Finished release [optimized + debuginfo] target(s) in 0.02s</span></span>
<span id="cb66-975"><a href="#cb66-975"></a><span class="in">Running: `qemu-system-x86_64 -drive format=raw,file=/…/target/x86_64-blog_os/debug/</span></span>
<span id="cb66-976"><a href="#cb66-976"></a><span class="in">    deps/bootimage-blog_os-7b7c37b4ad62551a.bin -device</span></span>
<span id="cb66-977"><a href="#cb66-977"></a><span class="in">    isa-debug-exit,iobase=0xf4,iosize=0x04 -serial stdio`</span></span>
<span id="cb66-978"><a href="#cb66-978"></a><span class="in">Running 1 tests</span></span>
<span id="cb66-979"><a href="#cb66-979"></a><span class="in">trivial assertion... [failed]</span></span>
<span id="cb66-980"><a href="#cb66-980"></a></span>
<span id="cb66-981"><a href="#cb66-981"></a><span class="in">Error: panicked at 'assertion failed: `(left == right)`</span></span>
<span id="cb66-982"><a href="#cb66-982"></a><span class="in">  left: `0`,</span></span>
<span id="cb66-983"><a href="#cb66-983"></a><span class="in"> right: `1`', src/main.rs:65:5</span></span>
<span id="cb66-984"><a href="#cb66-984"></a><span class="in">```</span></span>
<span id="cb66-985"><a href="#cb66-985"></a></span>
<span id="cb66-986"><a href="#cb66-986"></a>Since we see all test output on the console now, we no longer need the QEMU window that pops up for a short time. So we can hide it completely.</span>
<span id="cb66-987"><a href="#cb66-987"></a></span>
<span id="cb66-988"><a href="#cb66-988"></a><span class="fu">### Hiding QEMU</span></span>
<span id="cb66-989"><a href="#cb66-989"></a></span>
<span id="cb66-990"><a href="#cb66-990"></a>Since we report out the complete test results using the <span class="in">`isa-debug-exit`</span> device and the serial port, we don't need the QEMU window anymore. We can hide it by passing the <span class="in">`-display none`</span> argument to QEMU:</span>
<span id="cb66-991"><a href="#cb66-991"></a></span>
<span id="cb66-992"><a href="#cb66-992"></a><span class="in">```toml</span></span>
<span id="cb66-993"><a href="#cb66-993"></a><span class="in"># in Cargo.toml</span></span>
<span id="cb66-994"><a href="#cb66-994"></a></span>
<span id="cb66-995"><a href="#cb66-995"></a><span class="in">[package.metadata.bootimage]</span></span>
<span id="cb66-996"><a href="#cb66-996"></a><span class="in">test-args = [</span></span>
<span id="cb66-997"><a href="#cb66-997"></a><span class="in">    "-device", "isa-debug-exit,iobase=0xf4,iosize=0x04", "-serial", "stdio",</span></span>
<span id="cb66-998"><a href="#cb66-998"></a><span class="in">    "-display", "none"</span></span>
<span id="cb66-999"><a href="#cb66-999"></a><span class="in">]</span></span>
<span id="cb66-1000"><a href="#cb66-1000"></a><span class="in">```</span></span>
<span id="cb66-1001"><a href="#cb66-1001"></a></span>
<span id="cb66-1002"><a href="#cb66-1002"></a>Now QEMU runs completely in the background and no window gets opened anymore. This is not only less annoying, but also allows our test framework to run in environments without a graphical user interface, such as CI services or <span class="co">[</span><span class="ot">SSH</span><span class="co">]</span> connections.</span>
<span id="cb66-1003"><a href="#cb66-1003"></a></span>
<span id="cb66-1004"><a href="#cb66-1004"></a><span class="ot">[SSH]: https://en.wikipedia.org/wiki/Secure_Shell</span></span>
<span id="cb66-1005"><a href="#cb66-1005"></a></span>
<span id="cb66-1006"><a href="#cb66-1006"></a><span class="fu">### Timeouts</span></span>
<span id="cb66-1007"><a href="#cb66-1007"></a></span>
<span id="cb66-1008"><a href="#cb66-1008"></a>Since <span class="in">`cargo test`</span> waits until the test runner exits, a test that never returns can block the test runner forever. That's unfortunate, but not a big problem in practice since it's usually easy to avoid endless loops. In our case, however, endless loops can occur in various situations:</span>
<span id="cb66-1009"><a href="#cb66-1009"></a></span>
<span id="cb66-1010"><a href="#cb66-1010"></a><span class="ss">- </span>The bootloader fails to load our kernel, which causes the system to reboot endlessly.</span>
<span id="cb66-1011"><a href="#cb66-1011"></a><span class="ss">- </span>The BIOS/UEFI firmware fails to load the bootloader, which causes the same endless rebooting.</span>
<span id="cb66-1012"><a href="#cb66-1012"></a><span class="ss">- </span>The CPU enters a <span class="in">`loop {}`</span> statement at the end of some of our functions, for example because the QEMU exit device doesn't work properly.</span>
<span id="cb66-1013"><a href="#cb66-1013"></a><span class="ss">- </span>The hardware causes a system reset, for example when a CPU exception is not caught (explained in a future post).</span>
<span id="cb66-1014"><a href="#cb66-1014"></a></span>
<span id="cb66-1015"><a href="#cb66-1015"></a>Since endless loops can occur in so many situations, the <span class="in">`bootimage`</span> tool sets a timeout of 5 minutes for each test executable by default. If the test does not finish within this time, it is marked as failed and a "Timed Out" error is printed to the console. This feature ensures that tests that are stuck in an endless loop don't block <span class="in">`cargo test`</span> forever.</span>
<span id="cb66-1016"><a href="#cb66-1016"></a></span>
<span id="cb66-1017"><a href="#cb66-1017"></a>You can try it yourself by adding a <span class="in">`loop {}`</span> statement in the <span class="in">`trivial_assertion`</span> test. When you run <span class="in">`cargo test`</span>, you see that the test is marked as timed out after 5 minutes. The timeout duration is <span class="co">[</span><span class="ot">configurable</span><span class="co">][bootimage config]</span> through a <span class="in">`test-timeout`</span> key in the Cargo.toml:</span>
<span id="cb66-1018"><a href="#cb66-1018"></a></span>
<span id="cb66-1019"><a href="#cb66-1019"></a><span class="ot">[bootimage config]: https://github.com/rust-osdev/bootimage#configuration</span></span>
<span id="cb66-1020"><a href="#cb66-1020"></a></span>
<span id="cb66-1021"><a href="#cb66-1021"></a><span class="in">```toml</span></span>
<span id="cb66-1022"><a href="#cb66-1022"></a><span class="in"># in Cargo.toml</span></span>
<span id="cb66-1023"><a href="#cb66-1023"></a></span>
<span id="cb66-1024"><a href="#cb66-1024"></a><span class="in">[package.metadata.bootimage]</span></span>
<span id="cb66-1025"><a href="#cb66-1025"></a><span class="in">test-timeout = 300          # (in seconds)</span></span>
<span id="cb66-1026"><a href="#cb66-1026"></a><span class="in">```</span></span>
<span id="cb66-1027"><a href="#cb66-1027"></a></span>
<span id="cb66-1028"><a href="#cb66-1028"></a>If you don't want to wait 5 minutes for the <span class="in">`trivial_assertion`</span> test to time out, you can temporarily decrease the above value.</span>
<span id="cb66-1029"><a href="#cb66-1029"></a></span>
<span id="cb66-1030"><a href="#cb66-1030"></a><span class="fu">### Insert Printing Automatically</span></span>
<span id="cb66-1031"><a href="#cb66-1031"></a></span>
<span id="cb66-1032"><a href="#cb66-1032"></a>Our <span class="in">`trivial_assertion`</span> test currently needs to print its own status information using <span class="in">`serial_print!`</span>/<span class="in">`serial_println!`</span>:</span>
<span id="cb66-1033"><a href="#cb66-1033"></a></span>
<span id="cb66-1034"><a href="#cb66-1034"></a><span class="in">```rust</span></span>
<span id="cb66-1035"><a href="#cb66-1035"></a><span class="at">#[</span>test_case<span class="at">]</span></span>
<span id="cb66-1036"><a href="#cb66-1036"></a><span class="kw">fn</span> trivial_assertion() <span class="op">{</span></span>
<span id="cb66-1037"><a href="#cb66-1037"></a>    <span class="pp">serial_print!</span>(<span class="st">"trivial assertion... "</span>)<span class="op">;</span></span>
<span id="cb66-1038"><a href="#cb66-1038"></a>    <span class="pp">assert_eq!</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb66-1039"><a href="#cb66-1039"></a>    <span class="pp">serial_println!</span>(<span class="st">"[ok]"</span>)<span class="op">;</span></span>
<span id="cb66-1040"><a href="#cb66-1040"></a><span class="op">}</span></span>
<span id="cb66-1041"><a href="#cb66-1041"></a><span class="in">```</span></span>
<span id="cb66-1042"><a href="#cb66-1042"></a></span>
<span id="cb66-1043"><a href="#cb66-1043"></a>Manually adding these print statements for every test we write is cumbersome, so let's update our <span class="in">`test_runner`</span> to print these messages automatically. To do that, we need to create a new <span class="in">`Testable`</span> trait:</span>
<span id="cb66-1044"><a href="#cb66-1044"></a></span>
<span id="cb66-1045"><a href="#cb66-1045"></a><span class="in">```rust</span></span>
<span id="cb66-1046"><a href="#cb66-1046"></a><span class="co">// in src/main.rs</span></span>
<span id="cb66-1047"><a href="#cb66-1047"></a></span>
<span id="cb66-1048"><a href="#cb66-1048"></a><span class="kw">pub</span> <span class="kw">trait</span> Testable <span class="op">{</span></span>
<span id="cb66-1049"><a href="#cb66-1049"></a>    <span class="kw">fn</span> run(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> ()<span class="op">;</span></span>
<span id="cb66-1050"><a href="#cb66-1050"></a><span class="op">}</span></span>
<span id="cb66-1051"><a href="#cb66-1051"></a><span class="in">```</span></span>
<span id="cb66-1052"><a href="#cb66-1052"></a></span>
<span id="cb66-1053"><a href="#cb66-1053"></a>The trick now is to implement this trait for all types <span class="in">`T`</span> that implement the <span class="co">[</span><span class="ot">`Fn()` trait</span><span class="co">]</span>:</span>
<span id="cb66-1054"><a href="#cb66-1054"></a></span>
<span id="cb66-1055"><a href="#cb66-1055"></a><span class="ot">[`Fn()` trait]: https://doc.rust-lang.org/stable/core/ops/trait.Fn.html</span></span>
<span id="cb66-1056"><a href="#cb66-1056"></a></span>
<span id="cb66-1057"><a href="#cb66-1057"></a><span class="in">```rust</span></span>
<span id="cb66-1058"><a href="#cb66-1058"></a><span class="co">// in src/main.rs</span></span>
<span id="cb66-1059"><a href="#cb66-1059"></a></span>
<span id="cb66-1060"><a href="#cb66-1060"></a><span class="kw">impl</span><span class="op">&lt;</span>T<span class="op">&gt;</span> Testable <span class="cf">for</span> T</span>
<span id="cb66-1061"><a href="#cb66-1061"></a><span class="kw">where</span></span>
<span id="cb66-1062"><a href="#cb66-1062"></a>    T<span class="op">:</span> <span class="bu">Fn</span>()<span class="op">,</span></span>
<span id="cb66-1063"><a href="#cb66-1063"></a><span class="op">{</span></span>
<span id="cb66-1064"><a href="#cb66-1064"></a>    <span class="kw">fn</span> run(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">{</span></span>
<span id="cb66-1065"><a href="#cb66-1065"></a>        <span class="pp">serial_print!</span>(<span class="st">"{}...</span><span class="sc">\t</span><span class="st">"</span><span class="op">,</span> <span class="pp">core::any::type_name::</span><span class="op">&lt;</span>T<span class="op">&gt;</span>())<span class="op">;</span></span>
<span id="cb66-1066"><a href="#cb66-1066"></a>        <span class="kw">self</span>()<span class="op">;</span></span>
<span id="cb66-1067"><a href="#cb66-1067"></a>        <span class="pp">serial_println!</span>(<span class="st">"[ok]"</span>)<span class="op">;</span></span>
<span id="cb66-1068"><a href="#cb66-1068"></a>    <span class="op">}</span></span>
<span id="cb66-1069"><a href="#cb66-1069"></a><span class="op">}</span></span>
<span id="cb66-1070"><a href="#cb66-1070"></a><span class="in">```</span></span>
<span id="cb66-1071"><a href="#cb66-1071"></a></span>
<span id="cb66-1072"><a href="#cb66-1072"></a>We implement the <span class="in">`run`</span> function by first printing the function name using the <span class="co">[</span><span class="ot">`any::type_name`</span><span class="co">]</span> function. This function is implemented directly in the compiler and returns a string description of every type. For functions, the type is their name, so this is exactly what we want in this case. The <span class="in">`\t`</span> character is the <span class="co">[</span><span class="ot">tab character</span><span class="co">]</span>, which adds some alignment to the <span class="in">`[ok]`</span> messages.</span>
<span id="cb66-1073"><a href="#cb66-1073"></a></span>
<span id="cb66-1074"><a href="#cb66-1074"></a><span class="ot">[`any::type_name`]: https://doc.rust-lang.org/stable/core/any/fn.type_name.html</span></span>
<span id="cb66-1075"><a href="#cb66-1075"></a><span class="ot">[tab character]: https://en.wikipedia.org/wiki/Tab_character</span></span>
<span id="cb66-1076"><a href="#cb66-1076"></a></span>
<span id="cb66-1077"><a href="#cb66-1077"></a>After printing the function name, we invoke the test function through <span class="in">`self()`</span>. This only works because we require that <span class="in">`self`</span> implements the <span class="in">`Fn()`</span> trait. After the test function returns, we print <span class="in">`[ok]`</span> to indicate that the function did not panic.</span>
<span id="cb66-1078"><a href="#cb66-1078"></a></span>
<span id="cb66-1079"><a href="#cb66-1079"></a>The last step is to update our <span class="in">`test_runner`</span> to use the new <span class="in">`Testable`</span> trait:</span>
<span id="cb66-1080"><a href="#cb66-1080"></a></span>
<span id="cb66-1081"><a href="#cb66-1081"></a><span class="in">```rust</span></span>
<span id="cb66-1082"><a href="#cb66-1082"></a><span class="co">// in src/main.rs</span></span>
<span id="cb66-1083"><a href="#cb66-1083"></a></span>
<span id="cb66-1084"><a href="#cb66-1084"></a><span class="at">#[</span>cfg<span class="at">(</span>test<span class="at">)]</span></span>
<span id="cb66-1085"><a href="#cb66-1085"></a><span class="kw">pub</span> <span class="kw">fn</span> test_runner(tests<span class="op">:</span> <span class="op">&amp;</span>[<span class="op">&amp;</span><span class="kw">dyn</span> Testable]) <span class="op">{</span> <span class="co">// new</span></span>
<span id="cb66-1086"><a href="#cb66-1086"></a>    <span class="pp">serial_println!</span>(<span class="st">"Running {} tests"</span><span class="op">,</span> tests<span class="op">.</span>len())<span class="op">;</span></span>
<span id="cb66-1087"><a href="#cb66-1087"></a>    <span class="cf">for</span> test <span class="kw">in</span> tests <span class="op">{</span></span>
<span id="cb66-1088"><a href="#cb66-1088"></a>        test<span class="op">.</span>run()<span class="op">;</span> <span class="co">// new</span></span>
<span id="cb66-1089"><a href="#cb66-1089"></a>    <span class="op">}</span></span>
<span id="cb66-1090"><a href="#cb66-1090"></a>    exit_qemu(<span class="pp">QemuExitCode::</span><span class="cn">Success</span>)<span class="op">;</span></span>
<span id="cb66-1091"><a href="#cb66-1091"></a><span class="op">}</span></span>
<span id="cb66-1092"><a href="#cb66-1092"></a><span class="in">```</span></span>
<span id="cb66-1093"><a href="#cb66-1093"></a></span>
<span id="cb66-1094"><a href="#cb66-1094"></a>The only two changes are the type of the <span class="in">`tests`</span> argument from <span class="in">`&amp;[&amp;dyn Fn()]`</span> to <span class="in">`&amp;[&amp;dyn Testable]`</span> and the fact that we now call <span class="in">`test.run()`</span> instead of <span class="in">`test()`</span>.</span>
<span id="cb66-1095"><a href="#cb66-1095"></a></span>
<span id="cb66-1096"><a href="#cb66-1096"></a>We can now remove the print statements from our <span class="in">`trivial_assertion`</span> test since they're now printed automatically:</span>
<span id="cb66-1097"><a href="#cb66-1097"></a></span>
<span id="cb66-1098"><a href="#cb66-1098"></a><span class="in">```rust</span></span>
<span id="cb66-1099"><a href="#cb66-1099"></a><span class="co">// in src/main.rs</span></span>
<span id="cb66-1100"><a href="#cb66-1100"></a></span>
<span id="cb66-1101"><a href="#cb66-1101"></a><span class="at">#[</span>test_case<span class="at">]</span></span>
<span id="cb66-1102"><a href="#cb66-1102"></a><span class="kw">fn</span> trivial_assertion() <span class="op">{</span></span>
<span id="cb66-1103"><a href="#cb66-1103"></a>    <span class="pp">assert_eq!</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb66-1104"><a href="#cb66-1104"></a><span class="op">}</span></span>
<span id="cb66-1105"><a href="#cb66-1105"></a><span class="in">```</span></span>
<span id="cb66-1106"><a href="#cb66-1106"></a></span>
<span id="cb66-1107"><a href="#cb66-1107"></a>The <span class="in">`cargo test`</span> output now looks like this:</span>
<span id="cb66-1108"><a href="#cb66-1108"></a></span>
<span id="cb66-1109"><a href="#cb66-1109"></a><span class="in">```</span></span>
<span id="cb66-1110"><a href="#cb66-1110"></a><span class="in">Running 1 tests</span></span>
<span id="cb66-1111"><a href="#cb66-1111"></a><span class="in">blog_os::trivial_assertion...   [ok]</span></span>
<span id="cb66-1112"><a href="#cb66-1112"></a><span class="in">```</span></span>
<span id="cb66-1113"><a href="#cb66-1113"></a></span>
<span id="cb66-1114"><a href="#cb66-1114"></a>The function name now includes the full path to the function, which is useful when test functions in different modules have the same name. Otherwise, the output looks the same as before, but we no longer need to add print statements to our tests manually.</span>
<span id="cb66-1115"><a href="#cb66-1115"></a></span>
<span id="cb66-1116"><a href="#cb66-1116"></a><span class="fu">## Testing the VGA Buffer</span></span>
<span id="cb66-1117"><a href="#cb66-1117"></a></span>
<span id="cb66-1118"><a href="#cb66-1118"></a>Now that we have a working test framework, we can create a few tests for our VGA buffer implementation. First, we create a very simple test to verify that <span class="in">`println`</span> works without panicking:</span>
<span id="cb66-1119"><a href="#cb66-1119"></a></span>
<span id="cb66-1120"><a href="#cb66-1120"></a><span class="in">```rust</span></span>
<span id="cb66-1121"><a href="#cb66-1121"></a><span class="co">// in src/vga_buffer.rs</span></span>
<span id="cb66-1122"><a href="#cb66-1122"></a></span>
<span id="cb66-1123"><a href="#cb66-1123"></a><span class="at">#[</span>test_case<span class="at">]</span></span>
<span id="cb66-1124"><a href="#cb66-1124"></a><span class="kw">fn</span> test_println_simple() <span class="op">{</span></span>
<span id="cb66-1125"><a href="#cb66-1125"></a>    <span class="pp">println!</span>(<span class="st">"test_println_simple output"</span>)<span class="op">;</span></span>
<span id="cb66-1126"><a href="#cb66-1126"></a><span class="op">}</span></span>
<span id="cb66-1127"><a href="#cb66-1127"></a><span class="in">```</span></span>
<span id="cb66-1128"><a href="#cb66-1128"></a></span>
<span id="cb66-1129"><a href="#cb66-1129"></a>The test just prints something to the VGA buffer. If it finishes without panicking, it means that the <span class="in">`println`</span> invocation did not panic either.</span>
<span id="cb66-1130"><a href="#cb66-1130"></a></span>
<span id="cb66-1131"><a href="#cb66-1131"></a>To ensure that no panic occurs even if many lines are printed and lines are shifted off the screen, we can create another test:</span>
<span id="cb66-1132"><a href="#cb66-1132"></a></span>
<span id="cb66-1133"><a href="#cb66-1133"></a><span class="in">```rust</span></span>
<span id="cb66-1134"><a href="#cb66-1134"></a><span class="co">// in src/vga_buffer.rs</span></span>
<span id="cb66-1135"><a href="#cb66-1135"></a></span>
<span id="cb66-1136"><a href="#cb66-1136"></a><span class="at">#[</span>test_case<span class="at">]</span></span>
<span id="cb66-1137"><a href="#cb66-1137"></a><span class="kw">fn</span> test_println_many() <span class="op">{</span></span>
<span id="cb66-1138"><a href="#cb66-1138"></a>    <span class="cf">for</span> _ <span class="kw">in</span> <span class="dv">0</span><span class="op">..</span><span class="dv">200</span> <span class="op">{</span></span>
<span id="cb66-1139"><a href="#cb66-1139"></a>        <span class="pp">println!</span>(<span class="st">"test_println_many output"</span>)<span class="op">;</span></span>
<span id="cb66-1140"><a href="#cb66-1140"></a>    <span class="op">}</span></span>
<span id="cb66-1141"><a href="#cb66-1141"></a><span class="op">}</span></span>
<span id="cb66-1142"><a href="#cb66-1142"></a><span class="in">```</span></span>
<span id="cb66-1143"><a href="#cb66-1143"></a></span>
<span id="cb66-1144"><a href="#cb66-1144"></a>We can also create a test function to verify that the printed lines really appear on the screen:</span>
<span id="cb66-1145"><a href="#cb66-1145"></a></span>
<span id="cb66-1146"><a href="#cb66-1146"></a><span class="in">```rust</span></span>
<span id="cb66-1147"><a href="#cb66-1147"></a><span class="co">// in src/vga_buffer.rs</span></span>
<span id="cb66-1148"><a href="#cb66-1148"></a></span>
<span id="cb66-1149"><a href="#cb66-1149"></a><span class="at">#[</span>test_case<span class="at">]</span></span>
<span id="cb66-1150"><a href="#cb66-1150"></a><span class="kw">fn</span> test_println_output() <span class="op">{</span></span>
<span id="cb66-1151"><a href="#cb66-1151"></a>    <span class="kw">let</span> s <span class="op">=</span> <span class="st">"Some test string that fits on a single line"</span><span class="op">;</span></span>
<span id="cb66-1152"><a href="#cb66-1152"></a>    <span class="pp">println!</span>(<span class="st">"{}"</span><span class="op">,</span> s)<span class="op">;</span></span>
<span id="cb66-1153"><a href="#cb66-1153"></a>    <span class="cf">for</span> (i<span class="op">,</span> c) <span class="kw">in</span> s<span class="op">.</span>chars()<span class="op">.</span>enumerate() <span class="op">{</span></span>
<span id="cb66-1154"><a href="#cb66-1154"></a>        <span class="kw">let</span> screen_char <span class="op">=</span> WRITER<span class="op">.</span>lock()<span class="op">.</span>buffer<span class="op">.</span>chars[BUFFER_HEIGHT <span class="op">-</span> <span class="dv">2</span>][i]<span class="op">.</span>read()<span class="op">;</span></span>
<span id="cb66-1155"><a href="#cb66-1155"></a>        <span class="pp">assert_eq!</span>(<span class="dt">char</span><span class="pp">::</span>from(screen_char<span class="op">.</span>ascii_character)<span class="op">,</span> c)<span class="op">;</span></span>
<span id="cb66-1156"><a href="#cb66-1156"></a>    <span class="op">}</span></span>
<span id="cb66-1157"><a href="#cb66-1157"></a><span class="op">}</span></span>
<span id="cb66-1158"><a href="#cb66-1158"></a><span class="in">```</span></span>
<span id="cb66-1159"><a href="#cb66-1159"></a></span>
<span id="cb66-1160"><a href="#cb66-1160"></a>The function defines a test string, prints it using <span class="in">`println`</span>, and then iterates over the screen characters of the static <span class="in">`WRITER`</span>, which represents the VGA text buffer. Since <span class="in">`println`</span> prints to the last screen line and then immediately appends a newline, the string should appear on line <span class="in">`BUFFER_HEIGHT - 2`</span>.</span>
<span id="cb66-1161"><a href="#cb66-1161"></a></span>
<span id="cb66-1162"><a href="#cb66-1162"></a>By using <span class="co">[</span><span class="ot">`enumerate`</span><span class="co">]</span>, we count the number of iterations in the variable <span class="in">`i`</span>, which we then use for loading the screen character corresponding to <span class="in">`c`</span>. By comparing the <span class="in">`ascii_character`</span> of the screen character with <span class="in">`c`</span>, we ensure that each character of the string really appears in the VGA text buffer.</span>
<span id="cb66-1163"><a href="#cb66-1163"></a></span>
<span id="cb66-1164"><a href="#cb66-1164"></a><span class="ot">[`enumerate`]: https://doc.rust-lang.org/core/iter/trait.Iterator.html#method.enumerate</span></span>
<span id="cb66-1165"><a href="#cb66-1165"></a></span>
<span id="cb66-1166"><a href="#cb66-1166"></a>As you can imagine, we could create many more test functions. For example, a function that tests that no panic occurs when printing very long lines and that they're wrapped correctly, or a function for testing that newlines, non-printable characters, and non-unicode characters are handled correctly.</span>
<span id="cb66-1167"><a href="#cb66-1167"></a></span>
<span id="cb66-1168"><a href="#cb66-1168"></a>For the rest of this post, however, we will explain how to create _integration tests_ to test the interaction of different components together.</span>
<span id="cb66-1169"><a href="#cb66-1169"></a></span>
<span id="cb66-1170"><a href="#cb66-1170"></a><span class="fu">## Integration Tests</span></span>
<span id="cb66-1171"><a href="#cb66-1171"></a></span>
<span id="cb66-1172"><a href="#cb66-1172"></a>The convention for <span class="co">[</span><span class="ot">integration tests</span><span class="co">]</span> in Rust is to put them into a <span class="in">`tests`</span> directory in the project root (i.e., next to the <span class="in">`src`</span> directory). Both the default test framework and custom test frameworks will automatically pick up and execute all tests in that directory.</span>
<span id="cb66-1173"><a href="#cb66-1173"></a></span>
<span id="cb66-1174"><a href="#cb66-1174"></a><span class="ot">[integration tests]: https://doc.rust-lang.org/book/ch11-03-test-organization.html#integration-tests</span></span>
<span id="cb66-1175"><a href="#cb66-1175"></a></span>
<span id="cb66-1176"><a href="#cb66-1176"></a>All integration tests are their own executables and completely separate from our <span class="in">`main.rs`</span>. This means that each test needs to define its own entry point function. Let's create an example integration test named <span class="in">`basic_boot`</span> to see how it works in detail:</span>
<span id="cb66-1177"><a href="#cb66-1177"></a></span>
<span id="cb66-1178"><a href="#cb66-1178"></a><span class="in">```rust</span></span>
<span id="cb66-1179"><a href="#cb66-1179"></a><span class="co">// in tests/basic_boot.rs</span></span>
<span id="cb66-1180"><a href="#cb66-1180"></a></span>
<span id="cb66-1181"><a href="#cb66-1181"></a><span class="at">#![</span>no_std<span class="at">]</span></span>
<span id="cb66-1182"><a href="#cb66-1182"></a><span class="at">#![</span>no_main<span class="at">]</span></span>
<span id="cb66-1183"><a href="#cb66-1183"></a><span class="at">#![</span>feature<span class="at">(</span>custom_test_frameworks<span class="at">)]</span></span>
<span id="cb66-1184"><a href="#cb66-1184"></a><span class="at">#![</span>test_runner<span class="at">(</span><span class="kw">crate</span><span class="pp">::</span>test_runner<span class="at">)]</span></span>
<span id="cb66-1185"><a href="#cb66-1185"></a><span class="at">#![</span>reexport_test_harness_main <span class="op">=</span> <span class="st">"test_main"</span><span class="at">]</span></span>
<span id="cb66-1186"><a href="#cb66-1186"></a></span>
<span id="cb66-1187"><a href="#cb66-1187"></a><span class="kw">use</span> <span class="pp">core::panic::</span>PanicInfo<span class="op">;</span></span>
<span id="cb66-1188"><a href="#cb66-1188"></a></span>
<span id="cb66-1189"><a href="#cb66-1189"></a><span class="at">#[</span><span class="kw">unsafe</span><span class="at">(</span>no_mangle<span class="at">)]</span> <span class="co">// don't mangle the name of this function</span></span>
<span id="cb66-1190"><a href="#cb66-1190"></a><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">"C"</span> <span class="kw">fn</span> _start() <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb66-1191"><a href="#cb66-1191"></a>    test_main()<span class="op">;</span></span>
<span id="cb66-1192"><a href="#cb66-1192"></a></span>
<span id="cb66-1193"><a href="#cb66-1193"></a>    <span class="cf">loop</span> <span class="op">{}</span></span>
<span id="cb66-1194"><a href="#cb66-1194"></a><span class="op">}</span></span>
<span id="cb66-1195"><a href="#cb66-1195"></a></span>
<span id="cb66-1196"><a href="#cb66-1196"></a><span class="kw">fn</span> test_runner(tests<span class="op">:</span> <span class="op">&amp;</span>[<span class="op">&amp;</span><span class="kw">dyn</span> <span class="bu">Fn</span>()]) <span class="op">{</span></span>
<span id="cb66-1197"><a href="#cb66-1197"></a>    <span class="pp">unimplemented!</span>()<span class="op">;</span></span>
<span id="cb66-1198"><a href="#cb66-1198"></a><span class="op">}</span></span>
<span id="cb66-1199"><a href="#cb66-1199"></a></span>
<span id="cb66-1200"><a href="#cb66-1200"></a><span class="at">#[</span>panic_handler<span class="at">]</span></span>
<span id="cb66-1201"><a href="#cb66-1201"></a><span class="kw">fn</span> panic(info<span class="op">:</span> <span class="op">&amp;</span>PanicInfo) <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb66-1202"><a href="#cb66-1202"></a>    <span class="cf">loop</span> <span class="op">{}</span></span>
<span id="cb66-1203"><a href="#cb66-1203"></a><span class="op">}</span></span>
<span id="cb66-1204"><a href="#cb66-1204"></a><span class="in">```</span></span>
<span id="cb66-1205"><a href="#cb66-1205"></a></span>
<span id="cb66-1206"><a href="#cb66-1206"></a>Since integration tests are separate executables, we need to provide all the crate attributes (<span class="in">`no_std`</span>, <span class="in">`no_main`</span>, <span class="in">`test_runner`</span>, etc.) again. We also need to create a new entry point function <span class="in">`_start`</span>, which calls the test entry point function <span class="in">`test_main`</span>. We don't need any <span class="in">`cfg(test)`</span> attributes because integration test executables are never built in non-test mode.</span>
<span id="cb66-1207"><a href="#cb66-1207"></a></span>
<span id="cb66-1208"><a href="#cb66-1208"></a>We use the <span class="co">[</span><span class="ot">`unimplemented`</span><span class="co">]</span> macro that always panics as a placeholder for the <span class="in">`test_runner`</span> function and just <span class="in">`loop`</span> in the <span class="in">`panic`</span> handler for now. Ideally, we want to implement these functions exactly as we did in our <span class="in">`main.rs`</span> using the <span class="in">`serial_println`</span> macro and the <span class="in">`exit_qemu`</span> function. The problem is that we don't have access to these functions since tests are built completely separately from our <span class="in">`main.rs`</span> executable.</span>
<span id="cb66-1209"><a href="#cb66-1209"></a></span>
<span id="cb66-1210"><a href="#cb66-1210"></a><span class="ot">[`unimplemented`]: https://doc.rust-lang.org/core/macro.unimplemented.html</span></span>
<span id="cb66-1211"><a href="#cb66-1211"></a></span>
<span id="cb66-1212"><a href="#cb66-1212"></a>If you run <span class="in">`cargo test`</span> at this stage, you will get an endless loop because the panic handler loops endlessly. You need to use the <span class="in">`ctrl+c`</span> keyboard shortcut for exiting QEMU.</span>
<span id="cb66-1213"><a href="#cb66-1213"></a></span>
<span id="cb66-1214"><a href="#cb66-1214"></a><span class="fu">### Create a Library</span></span>
<span id="cb66-1215"><a href="#cb66-1215"></a></span>
<span id="cb66-1216"><a href="#cb66-1216"></a>To make the required functions available to our integration test, we need to split off a library from our <span class="in">`main.rs`</span>, which can be included by other crates and integration test executables. To do this, we create a new <span class="in">`src/lib.rs`</span> file:</span>
<span id="cb66-1217"><a href="#cb66-1217"></a></span>
<span id="cb66-1218"><a href="#cb66-1218"></a><span class="in">```rust</span></span>
<span id="cb66-1219"><a href="#cb66-1219"></a><span class="co">// src/lib.rs</span></span>
<span id="cb66-1220"><a href="#cb66-1220"></a></span>
<span id="cb66-1221"><a href="#cb66-1221"></a><span class="at">#![</span>no_std<span class="at">]</span></span>
<span id="cb66-1222"><a href="#cb66-1222"></a></span>
<span id="cb66-1223"><a href="#cb66-1223"></a><span class="in">```</span></span>
<span id="cb66-1224"><a href="#cb66-1224"></a></span>
<span id="cb66-1225"><a href="#cb66-1225"></a>Like the <span class="in">`main.rs`</span>, the <span class="in">`lib.rs`</span> is a special file that is automatically recognized by cargo. The library is a separate compilation unit, so we need to specify the <span class="in">`#![no_std]`</span> attribute again.</span>
<span id="cb66-1226"><a href="#cb66-1226"></a></span>
<span id="cb66-1227"><a href="#cb66-1227"></a>To make our library work with <span class="in">`cargo test`</span>, we need to also move the test functions and attributes from <span class="in">`main.rs`</span>  to <span class="in">`lib.rs`</span>:</span>
<span id="cb66-1228"><a href="#cb66-1228"></a></span>
<span id="cb66-1229"><a href="#cb66-1229"></a><span class="in">```rust</span></span>
<span id="cb66-1230"><a href="#cb66-1230"></a><span class="co">// in src/lib.rs</span></span>
<span id="cb66-1231"><a href="#cb66-1231"></a></span>
<span id="cb66-1232"><a href="#cb66-1232"></a><span class="at">#![</span>cfg_attr<span class="at">(</span>test<span class="op">,</span> no_main<span class="at">)]</span></span>
<span id="cb66-1233"><a href="#cb66-1233"></a><span class="at">#![</span>feature<span class="at">(</span>custom_test_frameworks<span class="at">)]</span></span>
<span id="cb66-1234"><a href="#cb66-1234"></a><span class="at">#![</span>test_runner<span class="at">(</span><span class="kw">crate</span><span class="pp">::</span>test_runner<span class="at">)]</span></span>
<span id="cb66-1235"><a href="#cb66-1235"></a><span class="at">#![</span>reexport_test_harness_main <span class="op">=</span> <span class="st">"test_main"</span><span class="at">]</span></span>
<span id="cb66-1236"><a href="#cb66-1236"></a></span>
<span id="cb66-1237"><a href="#cb66-1237"></a><span class="kw">use</span> <span class="pp">core::panic::</span>PanicInfo<span class="op">;</span></span>
<span id="cb66-1238"><a href="#cb66-1238"></a></span>
<span id="cb66-1239"><a href="#cb66-1239"></a><span class="kw">pub</span> <span class="kw">trait</span> Testable <span class="op">{</span></span>
<span id="cb66-1240"><a href="#cb66-1240"></a>    <span class="kw">fn</span> run(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> ()<span class="op">;</span></span>
<span id="cb66-1241"><a href="#cb66-1241"></a><span class="op">}</span></span>
<span id="cb66-1242"><a href="#cb66-1242"></a></span>
<span id="cb66-1243"><a href="#cb66-1243"></a><span class="kw">impl</span><span class="op">&lt;</span>T<span class="op">&gt;</span> Testable <span class="cf">for</span> T</span>
<span id="cb66-1244"><a href="#cb66-1244"></a><span class="kw">where</span></span>
<span id="cb66-1245"><a href="#cb66-1245"></a>    T<span class="op">:</span> <span class="bu">Fn</span>()<span class="op">,</span></span>
<span id="cb66-1246"><a href="#cb66-1246"></a><span class="op">{</span></span>
<span id="cb66-1247"><a href="#cb66-1247"></a>    <span class="kw">fn</span> run(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">{</span></span>
<span id="cb66-1248"><a href="#cb66-1248"></a>        <span class="pp">serial_print!</span>(<span class="st">"{}...</span><span class="sc">\t</span><span class="st">"</span><span class="op">,</span> <span class="pp">core::any::type_name::</span><span class="op">&lt;</span>T<span class="op">&gt;</span>())<span class="op">;</span></span>
<span id="cb66-1249"><a href="#cb66-1249"></a>        <span class="kw">self</span>()<span class="op">;</span></span>
<span id="cb66-1250"><a href="#cb66-1250"></a>        <span class="pp">serial_println!</span>(<span class="st">"[ok]"</span>)<span class="op">;</span></span>
<span id="cb66-1251"><a href="#cb66-1251"></a>    <span class="op">}</span></span>
<span id="cb66-1252"><a href="#cb66-1252"></a><span class="op">}</span></span>
<span id="cb66-1253"><a href="#cb66-1253"></a></span>
<span id="cb66-1254"><a href="#cb66-1254"></a><span class="kw">pub</span> <span class="kw">fn</span> test_runner(tests<span class="op">:</span> <span class="op">&amp;</span>[<span class="op">&amp;</span><span class="kw">dyn</span> Testable]) <span class="op">{</span></span>
<span id="cb66-1255"><a href="#cb66-1255"></a>    <span class="pp">serial_println!</span>(<span class="st">"Running {} tests"</span><span class="op">,</span> tests<span class="op">.</span>len())<span class="op">;</span></span>
<span id="cb66-1256"><a href="#cb66-1256"></a>    <span class="cf">for</span> test <span class="kw">in</span> tests <span class="op">{</span></span>
<span id="cb66-1257"><a href="#cb66-1257"></a>        test<span class="op">.</span>run()<span class="op">;</span></span>
<span id="cb66-1258"><a href="#cb66-1258"></a>    <span class="op">}</span></span>
<span id="cb66-1259"><a href="#cb66-1259"></a>    exit_qemu(<span class="pp">QemuExitCode::</span><span class="cn">Success</span>)<span class="op">;</span></span>
<span id="cb66-1260"><a href="#cb66-1260"></a><span class="op">}</span></span>
<span id="cb66-1261"><a href="#cb66-1261"></a></span>
<span id="cb66-1262"><a href="#cb66-1262"></a><span class="kw">pub</span> <span class="kw">fn</span> test_panic_handler(info<span class="op">:</span> <span class="op">&amp;</span>PanicInfo) <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb66-1263"><a href="#cb66-1263"></a>    <span class="pp">serial_println!</span>(<span class="st">"[failed]</span><span class="sc">\n</span><span class="st">"</span>)<span class="op">;</span></span>
<span id="cb66-1264"><a href="#cb66-1264"></a>    <span class="pp">serial_println!</span>(<span class="st">"Error: {}</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> info)<span class="op">;</span></span>
<span id="cb66-1265"><a href="#cb66-1265"></a>    exit_qemu(<span class="pp">QemuExitCode::</span>Failed)<span class="op">;</span></span>
<span id="cb66-1266"><a href="#cb66-1266"></a>    <span class="cf">loop</span> <span class="op">{}</span></span>
<span id="cb66-1267"><a href="#cb66-1267"></a><span class="op">}</span></span>
<span id="cb66-1268"><a href="#cb66-1268"></a></span>
<span id="cb66-1269"><a href="#cb66-1269"></a><span class="co">/// Entry point for `cargo test`</span></span>
<span id="cb66-1270"><a href="#cb66-1270"></a><span class="at">#[</span>cfg<span class="at">(</span>test<span class="at">)]</span></span>
<span id="cb66-1271"><a href="#cb66-1271"></a><span class="at">#[</span><span class="kw">unsafe</span><span class="at">(</span>no_mangle<span class="at">)]</span></span>
<span id="cb66-1272"><a href="#cb66-1272"></a><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">"C"</span> <span class="kw">fn</span> _start() <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb66-1273"><a href="#cb66-1273"></a>    test_main()<span class="op">;</span></span>
<span id="cb66-1274"><a href="#cb66-1274"></a>    <span class="cf">loop</span> <span class="op">{}</span></span>
<span id="cb66-1275"><a href="#cb66-1275"></a><span class="op">}</span></span>
<span id="cb66-1276"><a href="#cb66-1276"></a></span>
<span id="cb66-1277"><a href="#cb66-1277"></a><span class="at">#[</span>cfg<span class="at">(</span>test<span class="at">)]</span></span>
<span id="cb66-1278"><a href="#cb66-1278"></a><span class="at">#[</span>panic_handler<span class="at">]</span></span>
<span id="cb66-1279"><a href="#cb66-1279"></a><span class="kw">fn</span> panic(info<span class="op">:</span> <span class="op">&amp;</span>PanicInfo) <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb66-1280"><a href="#cb66-1280"></a>    test_panic_handler(info)</span>
<span id="cb66-1281"><a href="#cb66-1281"></a><span class="op">}</span></span>
<span id="cb66-1282"><a href="#cb66-1282"></a><span class="in">```</span></span>
<span id="cb66-1283"><a href="#cb66-1283"></a></span>
<span id="cb66-1284"><a href="#cb66-1284"></a>To make our <span class="in">`test_runner`</span> available to executables and integration tests, we make it public and don't apply the <span class="in">`cfg(test)`</span> attribute to it. We also factor out the implementation of our panic handler into a public <span class="in">`test_panic_handler`</span> function, so that it is available for executables too.</span>
<span id="cb66-1285"><a href="#cb66-1285"></a></span>
<span id="cb66-1286"><a href="#cb66-1286"></a>Since our <span class="in">`lib.rs`</span> is tested independently of our <span class="in">`main.rs`</span>, we need to add a <span class="in">`_start`</span> entry point and a panic handler when the library is compiled in test mode. By using the <span class="co">[</span><span class="ot">`cfg_attr`</span><span class="co">]</span> crate attribute, we conditionally enable the <span class="in">`no_main`</span> attribute in this case.</span>
<span id="cb66-1287"><a href="#cb66-1287"></a></span>
<span id="cb66-1288"><a href="#cb66-1288"></a><span class="ot">[`cfg_attr`]: https://doc.rust-lang.org/reference/conditional-compilation.html#the-cfg_attr-attribute</span></span>
<span id="cb66-1289"><a href="#cb66-1289"></a></span>
<span id="cb66-1290"><a href="#cb66-1290"></a>We also move over the <span class="in">`QemuExitCode`</span> enum and the <span class="in">`exit_qemu`</span> function and make them public:</span>
<span id="cb66-1291"><a href="#cb66-1291"></a></span>
<span id="cb66-1292"><a href="#cb66-1292"></a><span class="in">```rust</span></span>
<span id="cb66-1293"><a href="#cb66-1293"></a><span class="co">// in src/lib.rs</span></span>
<span id="cb66-1294"><a href="#cb66-1294"></a></span>
<span id="cb66-1295"><a href="#cb66-1295"></a><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="op">,</span> <span class="bu">Clone</span><span class="op">,</span> <span class="bu">Copy</span><span class="op">,</span> <span class="bu">PartialEq</span><span class="op">,</span> <span class="bu">Eq</span><span class="at">)]</span></span>
<span id="cb66-1296"><a href="#cb66-1296"></a><span class="at">#[</span>repr<span class="at">(</span><span class="dt">u32</span><span class="at">)]</span></span>
<span id="cb66-1297"><a href="#cb66-1297"></a><span class="kw">pub</span> <span class="kw">enum</span> QemuExitCode <span class="op">{</span></span>
<span id="cb66-1298"><a href="#cb66-1298"></a>    <span class="cn">Success</span> <span class="op">=</span> <span class="dv">0x10</span><span class="op">,</span></span>
<span id="cb66-1299"><a href="#cb66-1299"></a>    Failed <span class="op">=</span> <span class="dv">0x11</span><span class="op">,</span></span>
<span id="cb66-1300"><a href="#cb66-1300"></a><span class="op">}</span></span>
<span id="cb66-1301"><a href="#cb66-1301"></a></span>
<span id="cb66-1302"><a href="#cb66-1302"></a><span class="kw">pub</span> <span class="kw">fn</span> exit_qemu(exit_code<span class="op">:</span> QemuExitCode) <span class="op">{</span></span>
<span id="cb66-1303"><a href="#cb66-1303"></a>    <span class="kw">use</span> <span class="pp">x86_64::instructions::port::</span>Port<span class="op">;</span></span>
<span id="cb66-1304"><a href="#cb66-1304"></a></span>
<span id="cb66-1305"><a href="#cb66-1305"></a>    <span class="kw">unsafe</span> <span class="op">{</span></span>
<span id="cb66-1306"><a href="#cb66-1306"></a>        <span class="kw">let</span> <span class="kw">mut</span> port <span class="op">=</span> <span class="pp">Port::</span>new(<span class="dv">0xf4</span>)<span class="op">;</span></span>
<span id="cb66-1307"><a href="#cb66-1307"></a>        port<span class="op">.</span>write(exit_code <span class="kw">as</span> <span class="dt">u32</span>)<span class="op">;</span></span>
<span id="cb66-1308"><a href="#cb66-1308"></a>    <span class="op">}</span></span>
<span id="cb66-1309"><a href="#cb66-1309"></a><span class="op">}</span></span>
<span id="cb66-1310"><a href="#cb66-1310"></a><span class="in">```</span></span>
<span id="cb66-1311"><a href="#cb66-1311"></a></span>
<span id="cb66-1312"><a href="#cb66-1312"></a>Now executables and integration tests can import these functions from the library and don't need to define their own implementations. To also make <span class="in">`println`</span> and <span class="in">`serial_println`</span> available, we move the module declarations too:</span>
<span id="cb66-1313"><a href="#cb66-1313"></a></span>
<span id="cb66-1314"><a href="#cb66-1314"></a><span class="in">```rust</span></span>
<span id="cb66-1315"><a href="#cb66-1315"></a><span class="co">// in src/lib.rs</span></span>
<span id="cb66-1316"><a href="#cb66-1316"></a></span>
<span id="cb66-1317"><a href="#cb66-1317"></a><span class="kw">pub</span> <span class="kw">mod</span> serial<span class="op">;</span></span>
<span id="cb66-1318"><a href="#cb66-1318"></a><span class="kw">pub</span> <span class="kw">mod</span> vga_buffer<span class="op">;</span></span>
<span id="cb66-1319"><a href="#cb66-1319"></a><span class="in">```</span></span>
<span id="cb66-1320"><a href="#cb66-1320"></a></span>
<span id="cb66-1321"><a href="#cb66-1321"></a>We make the modules public to make them usable outside of our library. This is also required for making our <span class="in">`println`</span> and <span class="in">`serial_println`</span> macros usable since they use the <span class="in">`_print`</span> functions of the modules.</span>
<span id="cb66-1322"><a href="#cb66-1322"></a></span>
<span id="cb66-1323"><a href="#cb66-1323"></a>Now we can update our <span class="in">`main.rs`</span> to use the library:</span>
<span id="cb66-1324"><a href="#cb66-1324"></a></span>
<span id="cb66-1325"><a href="#cb66-1325"></a><span class="in">```rust</span></span>
<span id="cb66-1326"><a href="#cb66-1326"></a><span class="co">// in src/main.rs</span></span>
<span id="cb66-1327"><a href="#cb66-1327"></a></span>
<span id="cb66-1328"><a href="#cb66-1328"></a><span class="at">#![</span>no_std<span class="at">]</span></span>
<span id="cb66-1329"><a href="#cb66-1329"></a><span class="at">#![</span>no_main<span class="at">]</span></span>
<span id="cb66-1330"><a href="#cb66-1330"></a><span class="at">#![</span>feature<span class="at">(</span>custom_test_frameworks<span class="at">)]</span></span>
<span id="cb66-1331"><a href="#cb66-1331"></a><span class="at">#![</span>test_runner<span class="at">(</span><span class="pp">blog_os::</span>test_runner<span class="at">)]</span></span>
<span id="cb66-1332"><a href="#cb66-1332"></a><span class="at">#![</span>reexport_test_harness_main <span class="op">=</span> <span class="st">"test_main"</span><span class="at">]</span></span>
<span id="cb66-1333"><a href="#cb66-1333"></a></span>
<span id="cb66-1334"><a href="#cb66-1334"></a><span class="kw">use</span> <span class="pp">core::panic::</span>PanicInfo<span class="op">;</span></span>
<span id="cb66-1335"><a href="#cb66-1335"></a><span class="kw">use</span> <span class="pp">blog_os::</span>println<span class="op">;</span></span>
<span id="cb66-1336"><a href="#cb66-1336"></a></span>
<span id="cb66-1337"><a href="#cb66-1337"></a><span class="at">#[</span><span class="kw">unsafe</span><span class="at">(</span>no_mangle<span class="at">)]</span></span>
<span id="cb66-1338"><a href="#cb66-1338"></a><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">"C"</span> <span class="kw">fn</span> _start() <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb66-1339"><a href="#cb66-1339"></a>    <span class="pp">println!</span>(<span class="st">"Hello World{}"</span><span class="op">,</span> <span class="st">"!"</span>)<span class="op">;</span></span>
<span id="cb66-1340"><a href="#cb66-1340"></a></span>
<span id="cb66-1341"><a href="#cb66-1341"></a>    <span class="at">#[</span>cfg<span class="at">(</span>test<span class="at">)]</span></span>
<span id="cb66-1342"><a href="#cb66-1342"></a>    test_main()<span class="op">;</span></span>
<span id="cb66-1343"><a href="#cb66-1343"></a></span>
<span id="cb66-1344"><a href="#cb66-1344"></a>    <span class="cf">loop</span> <span class="op">{}</span></span>
<span id="cb66-1345"><a href="#cb66-1345"></a><span class="op">}</span></span>
<span id="cb66-1346"><a href="#cb66-1346"></a></span>
<span id="cb66-1347"><a href="#cb66-1347"></a><span class="co">/// This function is called on panic.</span></span>
<span id="cb66-1348"><a href="#cb66-1348"></a><span class="at">#[</span>cfg<span class="at">(</span>not<span class="at">(</span>test<span class="at">))]</span></span>
<span id="cb66-1349"><a href="#cb66-1349"></a><span class="at">#[</span>panic_handler<span class="at">]</span></span>
<span id="cb66-1350"><a href="#cb66-1350"></a><span class="kw">fn</span> panic(info<span class="op">:</span> <span class="op">&amp;</span>PanicInfo) <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb66-1351"><a href="#cb66-1351"></a>    <span class="pp">println!</span>(<span class="st">"{}"</span><span class="op">,</span> info)<span class="op">;</span></span>
<span id="cb66-1352"><a href="#cb66-1352"></a>    <span class="cf">loop</span> <span class="op">{}</span></span>
<span id="cb66-1353"><a href="#cb66-1353"></a><span class="op">}</span></span>
<span id="cb66-1354"><a href="#cb66-1354"></a></span>
<span id="cb66-1355"><a href="#cb66-1355"></a><span class="at">#[</span>cfg<span class="at">(</span>test<span class="at">)]</span></span>
<span id="cb66-1356"><a href="#cb66-1356"></a><span class="at">#[</span>panic_handler<span class="at">]</span></span>
<span id="cb66-1357"><a href="#cb66-1357"></a><span class="kw">fn</span> panic(info<span class="op">:</span> <span class="op">&amp;</span>PanicInfo) <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb66-1358"><a href="#cb66-1358"></a>    <span class="pp">blog_os::</span>test_panic_handler(info)</span>
<span id="cb66-1359"><a href="#cb66-1359"></a><span class="op">}</span></span>
<span id="cb66-1360"><a href="#cb66-1360"></a><span class="in">```</span></span>
<span id="cb66-1361"><a href="#cb66-1361"></a></span>
<span id="cb66-1362"><a href="#cb66-1362"></a>The library is usable like a normal external crate. It is called <span class="in">`blog_os`</span>, like our crate. The above code uses the <span class="in">`blog_os::test_runner`</span> function in the <span class="in">`test_runner`</span> attribute and the <span class="in">`blog_os::test_panic_handler`</span> function in our <span class="in">`cfg(test)`</span> panic handler. It also imports the <span class="in">`println`</span> macro to make it available to our <span class="in">`_start`</span> and <span class="in">`panic`</span> functions.</span>
<span id="cb66-1363"><a href="#cb66-1363"></a></span>
<span id="cb66-1364"><a href="#cb66-1364"></a>At this point, <span class="in">`cargo run`</span> and <span class="in">`cargo test`</span> should work again. Of course, <span class="in">`cargo test`</span> still loops endlessly (you can exit with <span class="in">`ctrl+c`</span>). Let's fix this by using the required library functions in our integration test.</span>
<span id="cb66-1365"><a href="#cb66-1365"></a></span>
<span id="cb66-1366"><a href="#cb66-1366"></a><span class="fu">### Completing the Integration Test</span></span>
<span id="cb66-1367"><a href="#cb66-1367"></a></span>
<span id="cb66-1368"><a href="#cb66-1368"></a>Like our <span class="in">`src/main.rs`</span>, our <span class="in">`tests/basic_boot.rs`</span> executable can import types from our new library. This allows us to import the missing components to complete our test:</span>
<span id="cb66-1369"><a href="#cb66-1369"></a></span>
<span id="cb66-1370"><a href="#cb66-1370"></a><span class="in">```rust</span></span>
<span id="cb66-1371"><a href="#cb66-1371"></a><span class="co">// in tests/basic_boot.rs</span></span>
<span id="cb66-1372"><a href="#cb66-1372"></a></span>
<span id="cb66-1373"><a href="#cb66-1373"></a><span class="at">#![</span>test_runner<span class="at">(</span><span class="pp">blog_os::</span>test_runner<span class="at">)]</span></span>
<span id="cb66-1374"><a href="#cb66-1374"></a></span>
<span id="cb66-1375"><a href="#cb66-1375"></a><span class="at">#[</span>panic_handler<span class="at">]</span></span>
<span id="cb66-1376"><a href="#cb66-1376"></a><span class="kw">fn</span> panic(info<span class="op">:</span> <span class="op">&amp;</span>PanicInfo) <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb66-1377"><a href="#cb66-1377"></a>    <span class="pp">blog_os::</span>test_panic_handler(info)</span>
<span id="cb66-1378"><a href="#cb66-1378"></a><span class="op">}</span></span>
<span id="cb66-1379"><a href="#cb66-1379"></a><span class="in">```</span></span>
<span id="cb66-1380"><a href="#cb66-1380"></a></span>
<span id="cb66-1381"><a href="#cb66-1381"></a>Instead of reimplementing the test runner, we use the <span class="in">`test_runner`</span> function from our library by changing the <span class="in">`#![test_runner(crate::test_runner)]`</span> attribute to <span class="in">`#![test_runner(blog_os::test_runner)]`</span>. We then don't need the <span class="in">`test_runner`</span> stub function in <span class="in">`basic_boot.rs`</span> anymore, so we can remove it. For our <span class="in">`panic`</span> handler, we call the <span class="in">`blog_os::test_panic_handler`</span> function like we did in our <span class="in">`main.rs`</span>.</span>
<span id="cb66-1382"><a href="#cb66-1382"></a></span>
<span id="cb66-1383"><a href="#cb66-1383"></a>Now <span class="in">`cargo test`</span> exits normally again. When you run it, you will see that it builds and runs the tests for our <span class="in">`lib.rs`</span>, <span class="in">`main.rs`</span>, and <span class="in">`basic_boot.rs`</span> separately after each other. For the <span class="in">`main.rs`</span> and the <span class="in">`basic_boot`</span> integration tests, it reports "Running 0 tests" since these files don't have any functions annotated with <span class="in">`#[test_case]`</span>.</span>
<span id="cb66-1384"><a href="#cb66-1384"></a></span>
<span id="cb66-1385"><a href="#cb66-1385"></a>We can now add tests to our <span class="in">`basic_boot.rs`</span>. For example, we can test that <span class="in">`println`</span> works without panicking, like we did in the VGA buffer tests:</span>
<span id="cb66-1386"><a href="#cb66-1386"></a></span>
<span id="cb66-1387"><a href="#cb66-1387"></a><span class="in">```rust</span></span>
<span id="cb66-1388"><a href="#cb66-1388"></a><span class="co">// in tests/basic_boot.rs</span></span>
<span id="cb66-1389"><a href="#cb66-1389"></a></span>
<span id="cb66-1390"><a href="#cb66-1390"></a><span class="kw">use</span> <span class="pp">blog_os::</span>println<span class="op">;</span></span>
<span id="cb66-1391"><a href="#cb66-1391"></a></span>
<span id="cb66-1392"><a href="#cb66-1392"></a><span class="at">#[</span>test_case<span class="at">]</span></span>
<span id="cb66-1393"><a href="#cb66-1393"></a><span class="kw">fn</span> test_println() <span class="op">{</span></span>
<span id="cb66-1394"><a href="#cb66-1394"></a>    <span class="pp">println!</span>(<span class="st">"test_println output"</span>)<span class="op">;</span></span>
<span id="cb66-1395"><a href="#cb66-1395"></a><span class="op">}</span></span>
<span id="cb66-1396"><a href="#cb66-1396"></a><span class="in">```</span></span>
<span id="cb66-1397"><a href="#cb66-1397"></a></span>
<span id="cb66-1398"><a href="#cb66-1398"></a>When we run <span class="in">`cargo test`</span> now, we see that it finds and executes the test function.</span>
<span id="cb66-1399"><a href="#cb66-1399"></a></span>
<span id="cb66-1400"><a href="#cb66-1400"></a>The test might seem a bit useless right now since it's almost identical to one of the VGA buffer tests. However, in the future, the <span class="in">`_start`</span> functions of our <span class="in">`main.rs`</span> and <span class="in">`lib.rs`</span> might grow and call various initialization routines before running the <span class="in">`test_main`</span> function, so that the two tests are executed in very different environments.</span>
<span id="cb66-1401"><a href="#cb66-1401"></a></span>
<span id="cb66-1402"><a href="#cb66-1402"></a>By testing <span class="in">`println`</span> in a <span class="in">`basic_boot`</span> environment without calling any initialization routines in <span class="in">`_start`</span>, we can ensure that <span class="in">`println`</span> works right after booting. This is important because we rely on it, e.g., for printing panic messages.</span>
<span id="cb66-1403"><a href="#cb66-1403"></a></span>
<span id="cb66-1404"><a href="#cb66-1404"></a><span class="fu">### Future Tests</span></span>
<span id="cb66-1405"><a href="#cb66-1405"></a></span>
<span id="cb66-1406"><a href="#cb66-1406"></a>The power of integration tests is that they're treated as completely separate executables. This gives them complete control over the environment, which makes it possible to test that the code interacts correctly with the CPU or hardware devices.</span>
<span id="cb66-1407"><a href="#cb66-1407"></a></span>
<span id="cb66-1408"><a href="#cb66-1408"></a>Our <span class="in">`basic_boot`</span> test is a very simple example of an integration test. In the future, our kernel will become much more featureful and interact with the hardware in various ways. By adding integration tests, we can ensure that these interactions work (and keep working) as expected. Some ideas for possible future tests are:</span>
<span id="cb66-1409"><a href="#cb66-1409"></a></span>
<span id="cb66-1410"><a href="#cb66-1410"></a><span class="ss">- </span>**CPU Exceptions**: When the code performs invalid operations (e.g., divides by zero), the CPU throws an exception. The kernel can register handler functions for such exceptions. An integration test could verify that the correct exception handler is called when a CPU exception occurs or that the execution continues correctly after a resolvable exception.</span>
<span id="cb66-1411"><a href="#cb66-1411"></a><span class="ss">- </span>**Page Tables**: Page tables define which memory regions are valid and accessible. By modifying the page tables, it is possible to allocate new memory regions, for example when launching programs. An integration test could modify the page tables in the <span class="in">`_start`</span> function and verify that the modifications have the desired effects in <span class="in">`#[test_case]`</span> functions.</span>
<span id="cb66-1412"><a href="#cb66-1412"></a><span class="ss">- </span>**Userspace Programs**: Userspace programs are programs with limited access to the system's resources. For example, they don't have access to kernel data structures or to the memory of other programs. An integration test could launch userspace programs that perform forbidden operations and verify that the kernel prevents them all.</span>
<span id="cb66-1413"><a href="#cb66-1413"></a></span>
<span id="cb66-1414"><a href="#cb66-1414"></a>As you can imagine, many more tests are possible. By adding such tests, we can ensure that we don't break them accidentally when we add new features to our kernel or refactor our code. This is especially important when our kernel becomes larger and more complex.</span>
<span id="cb66-1415"><a href="#cb66-1415"></a></span>
<span id="cb66-1416"><a href="#cb66-1416"></a><span class="fu">### Tests that Should Panic</span></span>
<span id="cb66-1417"><a href="#cb66-1417"></a></span>
<span id="cb66-1418"><a href="#cb66-1418"></a>The test framework of the standard library supports a <span class="co">[</span><span class="ot">`#[should_panic]` attribute</span><span class="co">][should_panic]</span> that allows constructing tests that should fail. This is useful, for example, to verify that a function fails when an invalid argument is passed. Unfortunately, this attribute isn't supported in <span class="in">`#[no_std]`</span> crates since it requires support from the standard library.</span>
<span id="cb66-1419"><a href="#cb66-1419"></a></span>
<span id="cb66-1420"><a href="#cb66-1420"></a><span class="ot">[should_panic]: https://doc.rust-lang.org/rust-by-example/testing/unit_testing.html#testing-panics</span></span>
<span id="cb66-1421"><a href="#cb66-1421"></a></span>
<span id="cb66-1422"><a href="#cb66-1422"></a>While we can't use the <span class="in">`#[should_panic]`</span> attribute in our kernel, we can get similar behavior by creating an integration test that exits with a success error code from the panic handler. Let's start creating such a test with the name <span class="in">`should_panic`</span>:</span>
<span id="cb66-1423"><a href="#cb66-1423"></a></span>
<span id="cb66-1424"><a href="#cb66-1424"></a><span class="in">```rust</span></span>
<span id="cb66-1425"><a href="#cb66-1425"></a><span class="co">// in tests/should_panic.rs</span></span>
<span id="cb66-1426"><a href="#cb66-1426"></a></span>
<span id="cb66-1427"><a href="#cb66-1427"></a><span class="at">#![</span>no_std<span class="at">]</span></span>
<span id="cb66-1428"><a href="#cb66-1428"></a><span class="at">#![</span>no_main<span class="at">]</span></span>
<span id="cb66-1429"><a href="#cb66-1429"></a></span>
<span id="cb66-1430"><a href="#cb66-1430"></a><span class="kw">use</span> <span class="pp">core::panic::</span>PanicInfo<span class="op">;</span></span>
<span id="cb66-1431"><a href="#cb66-1431"></a><span class="kw">use</span> <span class="pp">blog_os::</span><span class="op">{</span>QemuExitCode<span class="op">,</span> exit_qemu<span class="op">,</span> serial_println<span class="op">};</span></span>
<span id="cb66-1432"><a href="#cb66-1432"></a></span>
<span id="cb66-1433"><a href="#cb66-1433"></a><span class="at">#[</span>panic_handler<span class="at">]</span></span>
<span id="cb66-1434"><a href="#cb66-1434"></a><span class="kw">fn</span> panic(_info<span class="op">:</span> <span class="op">&amp;</span>PanicInfo) <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb66-1435"><a href="#cb66-1435"></a>    <span class="pp">serial_println!</span>(<span class="st">"[ok]"</span>)<span class="op">;</span></span>
<span id="cb66-1436"><a href="#cb66-1436"></a>    exit_qemu(<span class="pp">QemuExitCode::</span><span class="cn">Success</span>)<span class="op">;</span></span>
<span id="cb66-1437"><a href="#cb66-1437"></a>    <span class="cf">loop</span> <span class="op">{}</span></span>
<span id="cb66-1438"><a href="#cb66-1438"></a><span class="op">}</span></span>
<span id="cb66-1439"><a href="#cb66-1439"></a><span class="in">```</span></span>
<span id="cb66-1440"><a href="#cb66-1440"></a></span>
<span id="cb66-1441"><a href="#cb66-1441"></a>This test is still incomplete as it doesn't define a <span class="in">`_start`</span> function or any of the custom test runner attributes yet. Let's add the missing parts:</span>
<span id="cb66-1442"><a href="#cb66-1442"></a></span>
<span id="cb66-1443"><a href="#cb66-1443"></a><span class="in">```rust</span></span>
<span id="cb66-1444"><a href="#cb66-1444"></a><span class="co">// in tests/should_panic.rs</span></span>
<span id="cb66-1445"><a href="#cb66-1445"></a></span>
<span id="cb66-1446"><a href="#cb66-1446"></a><span class="at">#![</span>feature<span class="at">(</span>custom_test_frameworks<span class="at">)]</span></span>
<span id="cb66-1447"><a href="#cb66-1447"></a><span class="at">#![</span>test_runner<span class="at">(</span>test_runner<span class="at">)]</span></span>
<span id="cb66-1448"><a href="#cb66-1448"></a><span class="at">#![</span>reexport_test_harness_main <span class="op">=</span> <span class="st">"test_main"</span><span class="at">]</span></span>
<span id="cb66-1449"><a href="#cb66-1449"></a></span>
<span id="cb66-1450"><a href="#cb66-1450"></a><span class="at">#[</span><span class="kw">unsafe</span><span class="at">(</span>no_mangle<span class="at">)]</span></span>
<span id="cb66-1451"><a href="#cb66-1451"></a><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">"C"</span> <span class="kw">fn</span> _start() <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb66-1452"><a href="#cb66-1452"></a>    test_main()<span class="op">;</span></span>
<span id="cb66-1453"><a href="#cb66-1453"></a></span>
<span id="cb66-1454"><a href="#cb66-1454"></a>    <span class="cf">loop</span> <span class="op">{}</span></span>
<span id="cb66-1455"><a href="#cb66-1455"></a><span class="op">}</span></span>
<span id="cb66-1456"><a href="#cb66-1456"></a></span>
<span id="cb66-1457"><a href="#cb66-1457"></a><span class="kw">pub</span> <span class="kw">fn</span> test_runner(tests<span class="op">:</span> <span class="op">&amp;</span>[<span class="op">&amp;</span><span class="kw">dyn</span> <span class="bu">Fn</span>()]) <span class="op">{</span></span>
<span id="cb66-1458"><a href="#cb66-1458"></a>    <span class="pp">serial_println!</span>(<span class="st">"Running {} tests"</span><span class="op">,</span> tests<span class="op">.</span>len())<span class="op">;</span></span>
<span id="cb66-1459"><a href="#cb66-1459"></a>    <span class="cf">for</span> test <span class="kw">in</span> tests <span class="op">{</span></span>
<span id="cb66-1460"><a href="#cb66-1460"></a>        test()<span class="op">;</span></span>
<span id="cb66-1461"><a href="#cb66-1461"></a>        <span class="pp">serial_println!</span>(<span class="st">"[test did not panic]"</span>)<span class="op">;</span></span>
<span id="cb66-1462"><a href="#cb66-1462"></a>        exit_qemu(<span class="pp">QemuExitCode::</span>Failed)<span class="op">;</span></span>
<span id="cb66-1463"><a href="#cb66-1463"></a>    <span class="op">}</span></span>
<span id="cb66-1464"><a href="#cb66-1464"></a>    exit_qemu(<span class="pp">QemuExitCode::</span><span class="cn">Success</span>)<span class="op">;</span></span>
<span id="cb66-1465"><a href="#cb66-1465"></a><span class="op">}</span></span>
<span id="cb66-1466"><a href="#cb66-1466"></a><span class="in">```</span></span>
<span id="cb66-1467"><a href="#cb66-1467"></a></span>
<span id="cb66-1468"><a href="#cb66-1468"></a>Instead of reusing the <span class="in">`test_runner`</span> from our <span class="in">`lib.rs`</span>, the test defines its own <span class="in">`test_runner`</span> function that exits with a failure exit code when a test returns without panicking (we want our tests to panic). If no test function is defined, the runner exits with a success error code. Since the runner always exits after running a single test, it does not make sense to define more than one <span class="in">`#[test_case]`</span> function.</span>
<span id="cb66-1469"><a href="#cb66-1469"></a></span>
<span id="cb66-1470"><a href="#cb66-1470"></a>Now we can create a test that should fail:</span>
<span id="cb66-1471"><a href="#cb66-1471"></a></span>
<span id="cb66-1472"><a href="#cb66-1472"></a><span class="in">```rust</span></span>
<span id="cb66-1473"><a href="#cb66-1473"></a><span class="co">// in tests/should_panic.rs</span></span>
<span id="cb66-1474"><a href="#cb66-1474"></a></span>
<span id="cb66-1475"><a href="#cb66-1475"></a><span class="kw">use</span> <span class="pp">blog_os::</span>serial_print<span class="op">;</span></span>
<span id="cb66-1476"><a href="#cb66-1476"></a></span>
<span id="cb66-1477"><a href="#cb66-1477"></a><span class="at">#[</span>test_case<span class="at">]</span></span>
<span id="cb66-1478"><a href="#cb66-1478"></a><span class="kw">fn</span> should_fail() <span class="op">{</span></span>
<span id="cb66-1479"><a href="#cb66-1479"></a>    <span class="pp">serial_print!</span>(<span class="st">"should_panic::should_fail...</span><span class="sc">\t</span><span class="st">"</span>)<span class="op">;</span></span>
<span id="cb66-1480"><a href="#cb66-1480"></a>    <span class="pp">assert_eq!</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb66-1481"><a href="#cb66-1481"></a><span class="op">}</span></span>
<span id="cb66-1482"><a href="#cb66-1482"></a><span class="in">```</span></span>
<span id="cb66-1483"><a href="#cb66-1483"></a></span>
<span id="cb66-1484"><a href="#cb66-1484"></a>The test uses <span class="in">`assert_eq`</span> to assert that <span class="in">`0`</span> and <span class="in">`1`</span> are equal. Of course, this fails, so our test panics as desired. Note that we need to manually print the function name using <span class="in">`serial_print!`</span> here because we don't use the <span class="in">`Testable`</span> trait.</span>
<span id="cb66-1485"><a href="#cb66-1485"></a></span>
<span id="cb66-1486"><a href="#cb66-1486"></a>When we run the test through <span class="in">`cargo test --test should_panic`</span> we see that it is successful because the test panicked as expected. When we comment out the assertion and run the test again, we see that it indeed fails with the _"test did not panic"_ message.</span>
<span id="cb66-1487"><a href="#cb66-1487"></a></span>
<span id="cb66-1488"><a href="#cb66-1488"></a>A significant drawback of this approach is that it only works for a single test function. With multiple <span class="in">`#[test_case]`</span> functions, only the first function is executed because the execution cannot continue after the panic handler has been called. I currently don't know of a good way to solve this problem, so let me know if you have an idea!</span>
<span id="cb66-1489"><a href="#cb66-1489"></a></span>
<span id="cb66-1490"><a href="#cb66-1490"></a><span class="fu">### No Harness Tests</span></span>
<span id="cb66-1491"><a href="#cb66-1491"></a></span>
<span id="cb66-1492"><a href="#cb66-1492"></a>For integration tests that only have a single test function (like our <span class="in">`should_panic`</span> test), the test runner isn't really needed. For cases like this, we can disable the test runner completely and run our test directly in the <span class="in">`_start`</span> function.</span>
<span id="cb66-1493"><a href="#cb66-1493"></a></span>
<span id="cb66-1494"><a href="#cb66-1494"></a>The key to this is to disable the <span class="in">`harness`</span> flag for the test in the <span class="in">`Cargo.toml`</span>, which defines whether a test runner is used for an integration test. When it's set to <span class="in">`false`</span>, both the default test runner and the custom test runner feature are disabled, so that the test is treated like a normal executable.</span>
<span id="cb66-1495"><a href="#cb66-1495"></a></span>
<span id="cb66-1496"><a href="#cb66-1496"></a>Let's disable the <span class="in">`harness`</span> flag for our <span class="in">`should_panic`</span> test:</span>
<span id="cb66-1497"><a href="#cb66-1497"></a></span>
<span id="cb66-1498"><a href="#cb66-1498"></a><span class="in">```toml</span></span>
<span id="cb66-1499"><a href="#cb66-1499"></a><span class="in"># in Cargo.toml</span></span>
<span id="cb66-1500"><a href="#cb66-1500"></a></span>
<span id="cb66-1501"><a href="#cb66-1501"></a><span class="in">[[test]]</span></span>
<span id="cb66-1502"><a href="#cb66-1502"></a><span class="in">name = "should_panic"</span></span>
<span id="cb66-1503"><a href="#cb66-1503"></a><span class="in">harness = false</span></span>
<span id="cb66-1504"><a href="#cb66-1504"></a><span class="in">```</span></span>
<span id="cb66-1505"><a href="#cb66-1505"></a></span>
<span id="cb66-1506"><a href="#cb66-1506"></a>Now we vastly simplify our <span class="in">`should_panic`</span> test by removing the <span class="in">`test_runner`</span>-related code. The result looks like this:</span>
<span id="cb66-1507"><a href="#cb66-1507"></a></span>
<span id="cb66-1508"><a href="#cb66-1508"></a><span class="in">```rust</span></span>
<span id="cb66-1509"><a href="#cb66-1509"></a><span class="co">// in tests/should_panic.rs</span></span>
<span id="cb66-1510"><a href="#cb66-1510"></a></span>
<span id="cb66-1511"><a href="#cb66-1511"></a><span class="at">#![</span>no_std<span class="at">]</span></span>
<span id="cb66-1512"><a href="#cb66-1512"></a><span class="at">#![</span>no_main<span class="at">]</span></span>
<span id="cb66-1513"><a href="#cb66-1513"></a></span>
<span id="cb66-1514"><a href="#cb66-1514"></a><span class="kw">use</span> <span class="pp">core::panic::</span>PanicInfo<span class="op">;</span></span>
<span id="cb66-1515"><a href="#cb66-1515"></a><span class="kw">use</span> <span class="pp">blog_os::</span><span class="op">{</span>exit_qemu<span class="op">,</span> serial_print<span class="op">,</span> serial_println<span class="op">,</span> QemuExitCode<span class="op">};</span></span>
<span id="cb66-1516"><a href="#cb66-1516"></a></span>
<span id="cb66-1517"><a href="#cb66-1517"></a><span class="at">#[</span><span class="kw">unsafe</span><span class="at">(</span>no_mangle<span class="at">)]</span></span>
<span id="cb66-1518"><a href="#cb66-1518"></a><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">"C"</span> <span class="kw">fn</span> _start() <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb66-1519"><a href="#cb66-1519"></a>    should_fail()<span class="op">;</span></span>
<span id="cb66-1520"><a href="#cb66-1520"></a>    <span class="pp">serial_println!</span>(<span class="st">"[test did not panic]"</span>)<span class="op">;</span></span>
<span id="cb66-1521"><a href="#cb66-1521"></a>    exit_qemu(<span class="pp">QemuExitCode::</span>Failed)<span class="op">;</span></span>
<span id="cb66-1522"><a href="#cb66-1522"></a>    <span class="cf">loop</span><span class="op">{}</span></span>
<span id="cb66-1523"><a href="#cb66-1523"></a><span class="op">}</span></span>
<span id="cb66-1524"><a href="#cb66-1524"></a></span>
<span id="cb66-1525"><a href="#cb66-1525"></a><span class="kw">fn</span> should_fail() <span class="op">{</span></span>
<span id="cb66-1526"><a href="#cb66-1526"></a>    <span class="pp">serial_print!</span>(<span class="st">"should_panic::should_fail...</span><span class="sc">\t</span><span class="st">"</span>)<span class="op">;</span></span>
<span id="cb66-1527"><a href="#cb66-1527"></a>    <span class="pp">assert_eq!</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb66-1528"><a href="#cb66-1528"></a><span class="op">}</span></span>
<span id="cb66-1529"><a href="#cb66-1529"></a></span>
<span id="cb66-1530"><a href="#cb66-1530"></a><span class="at">#[</span>panic_handler<span class="at">]</span></span>
<span id="cb66-1531"><a href="#cb66-1531"></a><span class="kw">fn</span> panic(_info<span class="op">:</span> <span class="op">&amp;</span>PanicInfo) <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb66-1532"><a href="#cb66-1532"></a>    <span class="pp">serial_println!</span>(<span class="st">"[ok]"</span>)<span class="op">;</span></span>
<span id="cb66-1533"><a href="#cb66-1533"></a>    exit_qemu(<span class="pp">QemuExitCode::</span><span class="cn">Success</span>)<span class="op">;</span></span>
<span id="cb66-1534"><a href="#cb66-1534"></a>    <span class="cf">loop</span> <span class="op">{}</span></span>
<span id="cb66-1535"><a href="#cb66-1535"></a><span class="op">}</span></span>
<span id="cb66-1536"><a href="#cb66-1536"></a><span class="in">```</span></span>
<span id="cb66-1537"><a href="#cb66-1537"></a></span>
<span id="cb66-1538"><a href="#cb66-1538"></a>We now call the <span class="in">`should_fail`</span> function directly from our <span class="in">`_start`</span> function and exit with a failure exit code if it returns. When we run <span class="in">`cargo test --test should_panic`</span> now, we see that the test behaves exactly as before.</span>
<span id="cb66-1539"><a href="#cb66-1539"></a></span>
<span id="cb66-1540"><a href="#cb66-1540"></a>Apart from creating <span class="in">`should_panic`</span> tests, disabling the <span class="in">`harness`</span> attribute can also be useful for complex integration tests, for example, when the individual test functions have side effects and need to be run in a specified order.</span>
<span id="cb66-1541"><a href="#cb66-1541"></a></span>
<span id="cb66-1542"><a href="#cb66-1542"></a><span class="fu">## Summary</span></span>
<span id="cb66-1543"><a href="#cb66-1543"></a></span>
<span id="cb66-1544"><a href="#cb66-1544"></a>Testing is a very useful technique to ensure that certain components have the desired behavior. Even if they cannot show the absence of bugs, they're still a useful tool for finding them and especially for avoiding regressions.</span>
<span id="cb66-1545"><a href="#cb66-1545"></a></span>
<span id="cb66-1546"><a href="#cb66-1546"></a>This post explained how to set up a test framework for our Rust kernel. We used Rust's custom test frameworks feature to implement support for a simple <span class="in">`#[test_case]`</span> attribute in our bare-metal environment. Using the <span class="in">`isa-debug-exit`</span> device of QEMU, our test runner can exit QEMU after running the tests and report the test status. To print error messages to the console instead of the VGA buffer, we created a basic driver for the serial port.</span>
<span id="cb66-1547"><a href="#cb66-1547"></a></span>
<span id="cb66-1548"><a href="#cb66-1548"></a>After creating some tests for our <span class="in">`println`</span> macro, we explored integration tests in the second half of the post. We learned that they live in the <span class="in">`tests`</span> directory and are treated as completely separate executables. To give them access to the <span class="in">`exit_qemu`</span> function and the <span class="in">`serial_println`</span> macro, we moved most of our code into a library that can be imported by all executables and integration tests. Since integration tests run in their own separate environment, they make it possible to test interactions with the hardware or to create tests that should panic.</span>
<span id="cb66-1549"><a href="#cb66-1549"></a></span>
<span id="cb66-1550"><a href="#cb66-1550"></a>We now have a test framework that runs in a realistic environment inside QEMU. By creating more tests in future posts, we can keep our kernel maintainable when it becomes more complex.</span>
<span id="cb66-1551"><a href="#cb66-1551"></a></span>
<span id="cb66-1552"><a href="#cb66-1552"></a><span class="fu">## What's next?</span></span>
<span id="cb66-1553"><a href="#cb66-1553"></a></span>
<span id="cb66-1554"><a href="#cb66-1554"></a>In the next post, we will explore _CPU exceptions_. These exceptions are thrown by the CPU when something illegal happens, such as a division by zero or an access to an unmapped memory page (a so-called “page fault”). Being able to catch and examine these exceptions is very important for debugging future errors. Exception handling is also very similar to the handling of hardware interrupts, which is required for keyboard support.</span>
<span id="cb66-1555"><a href="#cb66-1555"></a></span>
<span id="cb66-1556"><a href="#cb66-1556"></a></span>
<span id="cb66-1557"><a href="#cb66-1557"></a><span class="fu"># Fin</span></span>
<span id="cb66-1558"><a href="#cb66-1558"></a></span>
<span id="cb66-1559"><a href="#cb66-1559"></a><span class="fu">## Timeout</span></span>
<span id="cb66-1560"><a href="#cb66-1560"></a></span>
<span id="cb66-1561"><a href="#cb66-1561"></a><span class="ss">- </span>This is 700 lines of markdown source which usually is enough.</span>
<span id="cb66-1562"><a href="#cb66-1562"></a><span class="ss">- </span>Otherwise we proceed to "Format".</span></code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>