<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.30">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Bare Metal ‚Äì OS in Rust</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./31_linker.html" rel="next">
<link href="./22_malloc.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-a4a11d514c7d463668e07712114998e6.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-fc9c1a4fc1048689359919db0170c3de.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./30_metal.html">Bare Metal</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">OS in Rust</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./00_derust.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Derust</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_wc.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">wc</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_cli.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">CLI</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11_unsafe.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Unsafe</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12_split_at.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Splits</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./20_os.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">OS</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./21_xmute.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Transmute</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./22_malloc.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">malloc</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./30_metal.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Bare Metal</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./31_linker.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Linker</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#announcements" id="toc-announcements" class="nav-link active" data-scroll-target="#announcements">Announcements</a></li>
  <li><a href="#today" id="toc-today" class="nav-link" data-scroll-target="#today">Today</a></li>
  <li><a href="#citations" id="toc-citations" class="nav-link" data-scroll-target="#citations">Citations</a></li>
  <li><a href="#motivation" id="toc-motivation" class="nav-link" data-scroll-target="#motivation">Motivation</a>
  <ul class="collapse">
  <li><a href="#throwback-thmonday" id="toc-throwback-thmonday" class="nav-link" data-scroll-target="#throwback-thmonday">Throwback ThMonday</a></li>
  <li><a href="#bare-metal" id="toc-bare-metal" class="nav-link" data-scroll-target="#bare-metal">Bare Metal</a></li>
  <li><a href="#some-terms" id="toc-some-terms" class="nav-link" data-scroll-target="#some-terms">Some Terms</a></li>
  <li><a href="#simulation" id="toc-simulation" class="nav-link" data-scroll-target="#simulation">Simulation</a></li>
  <li><a href="#emulation" id="toc-emulation" class="nav-link" data-scroll-target="#emulation">Emulation</a></li>
  <li><a href="#example" id="toc-example" class="nav-link" data-scroll-target="#example">Example</a></li>
  <li><a href="#context" id="toc-context" class="nav-link" data-scroll-target="#context">Context</a></li>
  <li><a href="#cross-compiling" id="toc-cross-compiling" class="nav-link" data-scroll-target="#cross-compiling">Cross-Compiling</a></li>
  <li><a href="#considerations" id="toc-considerations" class="nav-link" data-scroll-target="#considerations">Considerations</a></li>
  <li><a href="#qemu" id="toc-qemu" class="nav-link" data-scroll-target="#qemu">QEMU</a></li>
  </ul></li>
  <li><a href="#binary" id="toc-binary" class="nav-link" data-scroll-target="#binary">Binary</a>
  <ul class="collapse">
  <li><a href="#first-steps" id="toc-first-steps" class="nav-link" data-scroll-target="#first-steps">First Steps</a></li>
  <li><a href="#introduction" id="toc-introduction" class="nav-link" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#on-std" id="toc-on-std" class="nav-link" data-scroll-target="#on-std">On <code>std</code></a></li>
  <li><a href="#on-std-1" id="toc-on-std-1" class="nav-link" data-scroll-target="#on-std-1">On <code>std</code></a></li>
  <li><a href="#quoth-the-blog" id="toc-quoth-the-blog" class="nav-link" data-scroll-target="#quoth-the-blog">Quoth The Blog</a></li>
  <li><a href="#we-keep" id="toc-we-keep" class="nav-link" data-scroll-target="#we-keep">We keep</a></li>
  <li><a href="#onward" id="toc-onward" class="nav-link" data-scroll-target="#onward">Onward!</a></li>
  <li><a href="#no_std" id="toc-no_std" class="nav-link" data-scroll-target="#no_std"><code>no_std</code></a></li>
  <li><a href="#no_std-1" id="toc-no_std-1" class="nav-link" data-scroll-target="#no_std-1"><code>no_std</code></a></li>
  <li><a href="#to-begin" id="toc-to-begin" class="nav-link" data-scroll-target="#to-begin">To begin</a></li>
  <li><a href="#invoke-as" id="toc-invoke-as" class="nav-link" data-scroll-target="#invoke-as">Invoke as</a></li>
  <li><a href="#example-1" id="toc-example-1" class="nav-link" data-scroll-target="#example-1">Example</a></li>
  <li><a href="#branches" id="toc-branches" class="nav-link" data-scroll-target="#branches">Branches</a></li>
  <li><a href="#name" id="toc-name" class="nav-link" data-scroll-target="#name">Name</a></li>
  <li><a href="#refresh" id="toc-refresh" class="nav-link" data-scroll-target="#refresh">Refresh</a></li>
  <li><a href="#recall" id="toc-recall" class="nav-link" data-scroll-target="#recall">Recall</a></li>
  <li><a href="#blah-blah-blah" id="toc-blah-blah-blah" class="nav-link" data-scroll-target="#blah-blah-blah">Blah blah blah</a></li>
  <li><a href="#running" id="toc-running" class="nav-link" data-scroll-target="#running">Running</a></li>
  <li><a href="#the-no_std-attribute" id="toc-the-no_std-attribute" class="nav-link" data-scroll-target="#the-no_std-attribute">The <code>no_std</code> Attribute</a></li>
  <li><a href="#we-can-rebuild" id="toc-we-can-rebuild" class="nav-link" data-scroll-target="#we-can-rebuild">We Can Rebuild</a></li>
  <li><a href="#enhance" id="toc-enhance" class="nav-link" data-scroll-target="#enhance">Enhance!</a></li>
  <li><a href="#background" id="toc-background" class="nav-link" data-scroll-target="#background">Background</a></li>
  <li><a href="#rip-it" id="toc-rip-it" class="nav-link" data-scroll-target="#rip-it">Rip it</a></li>
  <li><a href="#problems-remain" id="toc-problems-remain" class="nav-link" data-scroll-target="#problems-remain">Problems remain</a></li>
  <li><a href="#enhance-1" id="toc-enhance-1" class="nav-link" data-scroll-target="#enhance-1">Enhance!</a></li>
  <li><a href="#panic" id="toc-panic" class="nav-link" data-scroll-target="#panic">Panic</a></li>
  <li><a href="#our-approach" id="toc-our-approach" class="nav-link" data-scroll-target="#our-approach">Our Approach</a></li>
  <li><a href="#panics" id="toc-panics" class="nav-link" data-scroll-target="#panics">Panics</a></li>
  <li><a href="#read-more" id="toc-read-more" class="nav-link" data-scroll-target="#read-more">Read more‚Ä¶</a></li>
  <li><a href="#retry" id="toc-retry" class="nav-link" data-scroll-target="#retry">Retry</a></li>
  <li><a href="#panic-abort" id="toc-panic-abort" class="nav-link" data-scroll-target="#panic-abort">Panic abort</a></li>
  <li><a href="#panic-abort-1" id="toc-panic-abort-1" class="nav-link" data-scroll-target="#panic-abort-1">Panic abort</a></li>
  <li><a href="#quoth-stallman" id="toc-quoth-stallman" class="nav-link" data-scroll-target="#quoth-stallman">Quoth Stallman</a></li>
  <li><a href="#now-in-rust" id="toc-now-in-rust" class="nav-link" data-scroll-target="#now-in-rust">Now in Rust</a></li>
  <li><a href="#how" id="toc-how" class="nav-link" data-scroll-target="#how">How?</a></li>
  <li><a href="#toml" id="toc-toml" class="nav-link" data-scroll-target="#toml">TOML</a></li>
  <li><a href="#crate-options" id="toc-crate-options" class="nav-link" data-scroll-target="#crate-options">Crate options</a></li>
  <li><a href="#update-cargo.toml" id="toc-update-cargo.toml" class="nav-link" data-scroll-target="#update-cargo.toml">Update <code>Cargo.toml</code></a></li>
  <li><a href="#now" id="toc-now" class="nav-link" data-scroll-target="#now">Now‚Ä¶</a></li>
  <li><a href="#whoops" id="toc-whoops" class="nav-link" data-scroll-target="#whoops">Whoops!</a></li>
  <li><a href="#the-start-attribute" id="toc-the-start-attribute" class="nav-link" data-scroll-target="#the-start-attribute">The <code>start</code> attribute</a></li>
  <li><a href="#c-again" id="toc-c-again" class="nav-link" data-scroll-target="#c-again">C, again</a></li>
  <li><a href="#back-to-rust" id="toc-back-to-rust" class="nav-link" data-scroll-target="#back-to-rust">Back to Rust</a></li>
  <li><a href="#crt0-is-cheating" id="toc-crt0-is-cheating" class="nav-link" data-scroll-target="#crt0-is-cheating"><code>crt0</code> is cheating</a>
  <ul class="collapse">
  <li><a href="#overwriting" id="toc-overwriting" class="nav-link" data-scroll-target="#overwriting">Overwriting</a></li>
  </ul></li>
  <li><a href="#no-main-in-main" id="toc-no-main-in-main" class="nav-link" data-scroll-target="#no-main-in-main">No main in main</a></li>
  <li><a href="#start-in-main" id="toc-start-in-main" class="nav-link" data-scroll-target="#start-in-main">Start in main</a></li>
  <li><a href="#manglin" id="toc-manglin" class="nav-link" data-scroll-target="#manglin">Manglin‚Äô</a></li>
  <li><a href="#c-you-again" id="toc-c-you-again" class="nav-link" data-scroll-target="#c-you-again">C you again</a></li>
  <li><a href="#read-more-1" id="toc-read-more-1" class="nav-link" data-scroll-target="#read-more-1">Read more</a></li>
  <li><a href="#divergence" id="toc-divergence" class="nav-link" data-scroll-target="#divergence">Divergence</a></li>
  <li><a href="#exit" id="toc-exit" class="nav-link" data-scroll-target="#exit">Exit</a></li>
  <li><a href="#now-it-works" id="toc-now-it-works" class="nav-link" data-scroll-target="#now-it-works">Now it works!</a></li>
  <li><a href="#to-be-continued" id="toc-to-be-continued" class="nav-link" data-scroll-target="#to-be-continued">To be continued</a></li>
  </ul></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="30_metal.rjs.html"><i class="bi bi-file-slides"></i>RevealJS</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Bare Metal</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i></button></div></div>
<p class="subtitle lead">OS in Rust</p>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="announcements" class="level2">
<h2 class="anchored" data-anchor-id="announcements">Announcements</h2>
<ul>
<li><strong>Action Items</strong>:
<ul>
<li><code>malloc</code> stands eternal
<ul>
<li>Possibly the coolest assignment ever</li>
<li>I‚Äôm glad you all love it</li>
</ul></li>
<li>Homework this week is more complicated but also more supported.
<ul>
<li>Prioritize <code>malloc</code> I think.</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="today" class="level2">
<h2 class="anchored" data-anchor-id="today">Today</h2>
<ul>
<li>Bare metal
<ul>
<li>Bare metal</li>
<li>Ranting about how cool this is</li>
<li>Simulation</li>
<li>Emulation</li>
</ul></li>
<li>A bare metal binary
<ul>
<li>Runtimes</li>
<li><code>std</code></li>
</ul></li>
</ul>
</section>
<section id="citations" class="level2">
<h2 class="anchored" data-anchor-id="citations">Citations</h2>
<ul>
<li>Outright theft:
<ul>
<li><a href="https://google.github.io/comprehensive-rust/bare-metal.html">Welcome to Bare Metal Rust</a></li>
<li><a href="https://os.phil-opp.com/freestanding-rust-binary/">A Freestanding Rust Binary</a></li>
</ul></li>
</ul>
</section>
<section id="motivation" class="level1">
<h1>Motivation</h1>
<section id="throwback-thmonday" class="level2">
<h2 class="anchored" data-anchor-id="throwback-thmonday">Throwback ThMonday</h2>
<ul>
<li>I did this in grad school.
<ul>
<li><a href="https://medium.com/@rz2285/simulating-c-program-on-bare-metal-or1200-af67e2886fb8">RTL Simulation of C-Program on Bare-metal OR1200</a></li>
</ul></li>
<li>My researcher (Juni) did this in ‚Äô22
<ul>
<li><a href="https://cd-public.github.io/research/students/aphrodite.pdf">Bare-Metal Programs on RISC-V</a></li>
</ul></li>
<li>I did this‚Ä¶ last week.
<ul>
<li><a href="https://vcd2df.github.io/pnsqc/#/demonstration">Slides including bare-metal execution in Verilog</a></li>
</ul></li>
</ul>
</section>
<section id="bare-metal" class="level2">
<h2 class="anchored" data-anchor-id="bare-metal">Bare Metal</h2>
<blockquote class="blockquote">
<p><a href="https://en.wikipedia.org/wiki/Bare_machine">A computer which has no operating system. The software executed by a bare machine, commonly called a ‚Äúbare metal program‚Äù or ‚Äúbare metal application‚Äù, is designed to interact directly with hardware. Bare machines are widely used in embedded systems, particularly in cases where resources are limited or high performance is required.</a></p>
</blockquote>
</section>
<section id="some-terms" class="level2">
<h2 class="anchored" data-anchor-id="some-terms">Some Terms</h2>
<ul>
<li>Should introduce a few terms.
<ul>
<li>Not required for OS but useful to know.</li>
</ul></li>
<li>Terms
<ul>
<li>Simulation</li>
<li>Emulation</li>
<li>Cross-compilation</li>
<li>QEMU</li>
</ul></li>
</ul>
</section>
<section id="simulation" class="level2">
<h2 class="anchored" data-anchor-id="simulation">Simulation</h2>
<ul>
<li>Models a system‚Äôs behavior</li>
<li>Focuses on high-level results, not internal logic</li>
<li>‚ÄúClose enough‚Äù for performance or logic testing</li>
<li>Simulating hardware components in software</li>
<li>Faster but less precise</li>
</ul>
</section>
<section id="emulation" class="level2">
<h2 class="anchored" data-anchor-id="emulation">Emulation</h2>
<ul>
<li>Replicating exact internal behavior of hardware</li>
<li>Software acting as hardware (CPU, registers, memory)</li>
<li><strong>Accuracy vs.&nbsp;Speed</strong>:
<ul>
<li>Much slower than simulation‚Ä¶ unless?</li>
<li>Goal: Guest software doesn‚Äôt know it‚Äôs not on actual silicon</li>
</ul></li>
</ul>
</section>
<section id="example" class="level2">
<h2 class="anchored" data-anchor-id="example">Example</h2>
<ul>
<li><code>x86-64</code> - the Intel/AMD architecture common for Linux and Windows - supports a ‚Äúlong double‚Äù float with 80 bits of precision.</li>
<li><code>ARM64</code> - a competing formulation most popularized as ‚ÄúApple silicon‚Äù with the M1 - lacks long doubles.</li>
</ul>
</section>
<section id="context" class="level2">
<h2 class="anchored" data-anchor-id="context">Context</h2>
<ul>
<li>It is trivial to implement a float in software‚Ä¶
<ul>
<li><a href="https://cd-c89.github.io/rs/51_f16.html"><code>f16</code></a></li>
</ul></li>
<li>It is relatively not-trivial to implement <em>an architecture</em> in software, though possible.
<ul>
<li>Here‚Äôs the smallest example I know:</li>
<li><a href="https://github.com/YosysHQ/picorv32">PicoRV32</a></li>
</ul></li>
</ul>
</section>
<section id="cross-compiling" class="level2">
<h2 class="anchored" data-anchor-id="cross-compiling">Cross-Compiling</h2>
<ul>
<li>Example:‚Äù compiling code <em>on</em> an x86 laptop <em>for</em> an ARM chip
<ul>
<li>Common in embedded applications (e.g.&nbsp;program a thermostat)</li>
</ul></li>
<li>Compiler runs on Host A, produces binary for Target B
<ul>
<li>Essential for ‚Äúbare metal‚Äù development</li>
<li>Transmit the binary over wires (the bus!) to another device‚Äôs memory.</li>
</ul></li>
</ul>
</section>
<section id="considerations" class="level2">
<h2 class="anchored" data-anchor-id="considerations">Considerations</h2>
<ul>
<li>We must:
<ul>
<li><strong>Target</strong> a specific architecture</li>
<li><strong>Link</strong> against specific hardware memory maps</li>
</ul></li>
<li>Somehow you also need the actual hardware, unless‚Ä¶</li>
</ul>
</section>
<section id="qemu" class="level2">
<h2 class="anchored" data-anchor-id="qemu">QEMU</h2>
<ul>
<li>I used this a lot in grad school; less now.
<ul>
<li>Supports both emulation and virtualization
<ul>
<li>Virtualization emulates a device rather than a binary.</li>
<li>Used in cloud; can be fast; huge research area.</li>
</ul></li>
</ul></li>
<li>Let‚Äôs us run bare metal binaries without physical chips (which would cost $)</li>
<li>Write locally <span class="math inline">\(\rightarrow\)</span> Cross-compile <span class="math inline">\(\rightarrow\)</span> Run in QEMU</li>
</ul>
</section>
</section>
<section id="binary" class="level1">
<h1>Binary</h1>
<section id="first-steps" class="level2">
<h2 class="anchored" data-anchor-id="first-steps">First Steps</h2>
<ul>
<li>The first step in creating our own operating system kernel is to create a Rust executable that does not link the standard library.</li>
<li>This makes it possible to run Rust code on the ‚Äúbare metal‚Äù without an underlying operating system.</li>
</ul>
</section>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<ul>
<li>To write an operating system kernel, we need code that does not depend on any operating system features.</li>
<li>This means that we can‚Äôt use files, the heap, networks, random numbers, standard output, etc.</li>
<li>We‚Äôre trying to write our own OS!</li>
</ul>
</section>
<section id="on-std" class="level2">
<h2 class="anchored" data-anchor-id="on-std">On <code>std</code></h2>
<ul>
<li>We can‚Äôt use most of the Rust standard library, but‚Ä¶</li>
<li>‚Ä¶there are a lot of Rust features that we <em>can</em> use.</li>
<li>For example, we can use iterators, closures, pattern matching, <code>option</code> and <code>result</code>
<ul>
<li>Recall the official Calvin Deutschbein position on <code>option</code> and <code>result</code>:</li>
<li>‚ÄúIt‚Äôs why Rust is good.‚Äù - me</li>
</ul></li>
</ul>
</section>
<section id="on-std-1" class="level2">
<h2 class="anchored" data-anchor-id="on-std-1">On <code>std</code></h2>
<ul>
<li>While not initially helpful, we can use string formatting, and‚Ä¶</li>
<li>‚Ä¶ the ownership system.
<ul>
<li>Beats <code>malloc</code>!</li>
</ul></li>
</ul>
</section>
<section id="quoth-the-blog" class="level2">
<h2 class="anchored" data-anchor-id="quoth-the-blog">Quoth The Blog</h2>
<blockquote class="blockquote">
<p>These features make it possible to write a kernel in a very expressive, high level way without worrying about undefined behavior or memory safety.</p>
</blockquote>
<ul>
<li>Well, we‚Äôll see.</li>
</ul>
</section>
<section id="we-keep" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="we-keep">We keep</h2>
<ul>
<li><a href="https://doc.rust-lang.org/core/option/">option</a></li>
<li><a href="https://doc.rust-lang.org/core/result/">result</a></li>
<li><a href="https://doc.rust-lang.org/std/">Rust standard library</a></li>
<li><a href="https://doc.rust-lang.org/book/ch13-02-iterators.html">iterators</a></li>
<li><a href="https://doc.rust-lang.org/book/ch13-01-closures.html">closures</a></li>
<li><a href="https://doc.rust-lang.org/book/ch06-00-enums.html">pattern matching</a></li>
<li><a href="https://doc.rust-lang.org/core/macro.write.html">string formatting</a></li>
<li><a href="https://doc.rust-lang.org/book/ch04-00-understanding-ownership.html">ownership system</a></li>
<li><a href="https://www.nayuki.io/page/undefined-behavior-in-c-and-cplusplus-programs">undefined behavior</a></li>
<li><a href="https://tonyarcieri.com/it-s-time-for-a-memory-safety-intervention">memory safety</a></li>
</ul>
</section>
<section id="onward" class="level2">
<h2 class="anchored" data-anchor-id="onward">Onward!</h2>
<ul>
<li>We now enumerate the necessary steps to create a freestanding Rust binary‚Ä¶</li>
<li>‚Ä¶and explains why the steps are needed.</li>
</ul>
</section>
<section id="no_std" class="level2">
<h2 class="anchored" data-anchor-id="no_std"><code>no_std</code></h2>
<ul>
<li>By default, all Rust crates link the standard library.
<ul>
<li>It depends on the operating system for features such as threads, files, or networking.</li>
<li>It also depends on the C standard library <code>libc</code>, which closely interacts with OS services.
<ul>
<li>That is, part of GNU but not part of Linux.</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="no_std-1" class="level2">
<h2 class="anchored" data-anchor-id="no_std-1"><code>no_std</code></h2>
<ul>
<li>Since our plan is to write an operating system, we can‚Äôt use any OS-dependent libraries.
<ul>
<li>That would be recursive, which is only good sometimes!</li>
</ul></li>
<li>So we have to disable the automatic inclusion of the standard library through the <code>no_std</code> attribute.
<ul>
<li><a href="https://doc.rust-lang.org/std/">standard library</a></li>
<li><a href="https://doc.rust-lang.org/1.30.0/book/first-edition/using-rust-without-the-standard-library.html"><code>no_std</code> attribute</a></li>
</ul></li>
</ul>
</section>
<section id="to-begin" class="level2">
<h2 class="anchored" data-anchor-id="to-begin">To begin</h2>
<ul>
<li>We can start creation the same way we make anything else in Rust‚Ä¶</li>
<li><em>Cargo</em> (sighs heavily)</li>
<li>We will introduce only two wrinkles.
<ul>
<li><code>--bin</code>: we want to create an executable binary (in contrast to a library)</li>
<li><code>--edition 2024</code>: to maintain consistency across years and with the working example.</li>
</ul></li>
</ul>
</section>
<section id="invoke-as" class="level2">
<h2 class="anchored" data-anchor-id="invoke-as">Invoke as</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1"></a><span class="ex">cargo</span> new <span class="pp">????</span> <span class="at">--bin</span> <span class="at">--edition</span> 2024</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="example-1" class="level2">
<h2 class="anchored" data-anchor-id="example-1">Example</h2>
<ul>
<li>Personally, I would expect you to maintain different OS versions with same crate name but within distinctly named directories (<code>32</code>,<code>42</code> etc.)</li>
</ul>
<div class="sourceCode" id="cb2"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1"></a><span class="ex">cargo</span> new 32 <span class="at">--name</span> osirs <span class="at">--vcs</span> none <span class="at">--bin</span> <span class="at">--edition</span> 2024</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="branches" class="level2">
<h2 class="anchored" data-anchor-id="branches">Branches</h2>
<ul>
<li>A competing formulation would be to use <code>git branch</code> to create different developmental branches.</li>
<li>This is the industry standard and I wanted to introduce it but felt a time crunch.</li>
<li>If you are looking for something to do, figure it out.
<ul>
<li>Don‚Äôt worry about me finding things; its worth it to me for you to learn.</li>
</ul></li>
</ul>
</section>
<section id="name" class="level2">
<h2 class="anchored" data-anchor-id="name">Name</h2>
<div class="columns">
<div class="column" style="width:50%;">
<ul>
<li>You don‚Äôt have to name your OS anything in particular, I just thought <code>osirs</code> (OS in Rust) sounded heckin‚Äô rad.</li>
<li><a href="https://en.wikipedia.org/wiki/Osiris"> ô·¥è·¥° ·¥Ö·¥è·¥°…¥  ô·¥á“ì·¥è Ä·¥á ·¥õ ú·¥á …¢·¥è·¥Ö ·¥è“ì ·¥Ö·¥á·¥Ä·¥õ ú</a></li>
<li>Also a cringe AI real estate firm!</li>
</ul>
</div><div class="column" style="width:50%;">
<p><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/8b/Standing_Osiris.svg/330px-Standing_Osiris.svg.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="refresh" class="level2">
<h2 class="anchored" data-anchor-id="refresh">Refresh</h2>
<ul>
<li>When we run the command, cargo creates the following directory structure for us:</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1"></a><span class="ex">$</span> tree</span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="bu">.</span></span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="ex">‚îú‚îÄ‚îÄ</span> Cargo.toml</span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="ex">‚îî‚îÄ‚îÄ</span> src</span>
<span id="cb3-5"><a href="#cb3-5"></a>    <span class="ex">‚îî‚îÄ‚îÄ</span> main.rs</span>
<span id="cb3-6"><a href="#cb3-6"></a></span>
<span id="cb3-7"><a href="#cb3-7"></a><span class="ex">1</span> directory, 2 files</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="recall" class="level2">
<h2 class="anchored" data-anchor-id="recall">Recall</h2>
<ul>
<li><code>Cargo.toml</code> contains the crate configuration
<ul>
<li>Crate name</li>
<li>Crate author</li>
<li>Crate version</li>
</ul></li>
<li><code>src/main.rs</code> file contains our <code>main</code> function.</li>
<li>After <code>cargo build</code>, find the compiled <code>osirs</code> binary in the <code>target/debug</code> subfolder.</li>
</ul>
</section>
<section id="blah-blah-blah" class="level2">
<h2 class="anchored" data-anchor-id="blah-blah-blah">Blah blah blah</h2>
<div class="sourceCode" id="cb4"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1"></a><span class="ex">$</span> cargo build <span class="kw">;</span> <span class="ex">tree</span></span>
<span id="cb4-2"><a href="#cb4-2"></a>   <span class="ex">Compiling</span> osirs v0.1.0 <span class="er">(</span><span class="ex">/home/user/tmp/32</span><span class="kw">)</span></span>
<span id="cb4-3"><a href="#cb4-3"></a>    <span class="ex">Finished</span> <span class="kw">`</span><span class="ex">dev</span><span class="kw">`</span> profile [unoptimized + debuginfo] target<span class="er">(</span><span class="ex">s</span><span class="kw">)</span> <span class="er">in</span> <span class="ex">0.54s</span></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="bu">.</span></span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="ex">‚îú‚îÄ‚îÄ</span> Cargo.lock</span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="ex">‚îú‚îÄ‚îÄ</span> Cargo.toml</span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="ex">‚îú‚îÄ‚îÄ</span> src</span>
<span id="cb4-8"><a href="#cb4-8"></a><span class="ex">‚îÇ&nbsp;&nbsp;</span> ‚îî‚îÄ‚îÄ main.rs</span>
<span id="cb4-9"><a href="#cb4-9"></a><span class="ex">‚îî‚îÄ‚îÄ</span> target</span>
<span id="cb4-10"><a href="#cb4-10"></a>    <span class="ex">‚îú‚îÄ‚îÄ</span> CACHEDIR.TAG</span>
<span id="cb4-11"><a href="#cb4-11"></a>    <span class="ex">‚îî‚îÄ‚îÄ</span> debug</span>
<span id="cb4-12"><a href="#cb4-12"></a>        <span class="ex">‚îú‚îÄ‚îÄ</span> build</span>
<span id="cb4-13"><a href="#cb4-13"></a>        <span class="ex">‚îú‚îÄ‚îÄ</span> deps</span>
<span id="cb4-14"><a href="#cb4-14"></a>        <span class="ex">‚îÇ&nbsp;&nbsp;</span> ‚îú‚îÄ‚îÄ osirs-43412975b38d059d</span>
<span id="cb4-15"><a href="#cb4-15"></a>        <span class="ex">‚îÇ&nbsp;&nbsp;</span> ‚îî‚îÄ‚îÄ osirs-43412975b38d059d.d</span>
<span id="cb4-16"><a href="#cb4-16"></a>        <span class="ex">‚îú‚îÄ‚îÄ</span> examples</span>
<span id="cb4-17"><a href="#cb4-17"></a>        <span class="ex">‚îú‚îÄ‚îÄ</span> incremental</span>
<span id="cb4-18"><a href="#cb4-18"></a>        <span class="ex">‚îÇ&nbsp;&nbsp;</span> ‚îî‚îÄ‚îÄ osirs-3gae52yq1943v</span>
<span id="cb4-19"><a href="#cb4-19"></a>        <span class="ex">‚îÇ&nbsp;&nbsp;</span>     ‚îú‚îÄ‚îÄ s-hfeunnoewq-0c8luu5-5dmhke08rl6h5l09ku3va3gkx</span>
<span id="cb4-20"><a href="#cb4-20"></a>        <span class="ex">‚îÇ&nbsp;&nbsp;</span>     ‚îÇ&nbsp;&nbsp; ‚îú‚îÄ‚îÄ 1tq3ts5gahvv7j1hzrmfdrzi6.o</span>
<span id="cb4-21"><a href="#cb4-21"></a>        <span class="ex">‚îÇ&nbsp;&nbsp;</span>     ‚îÇ&nbsp;&nbsp; ‚îú‚îÄ‚îÄ 6zk3flo890c0qhh6fykb6746g.o</span>
<span id="cb4-22"><a href="#cb4-22"></a>        <span class="ex">‚îÇ&nbsp;&nbsp;</span>     ‚îÇ&nbsp;&nbsp; ‚îú‚îÄ‚îÄ 8z45o15v3gxm5hydv3o63x07l.o</span>
<span id="cb4-23"><a href="#cb4-23"></a>        <span class="ex">‚îÇ&nbsp;&nbsp;</span>     ‚îÇ&nbsp;&nbsp; ‚îú‚îÄ‚îÄ 9itjtn00r7d8c6mknmav20oex.o</span>
<span id="cb4-24"><a href="#cb4-24"></a>        <span class="ex">‚îÇ&nbsp;&nbsp;</span>     ‚îÇ&nbsp;&nbsp; ‚îú‚îÄ‚îÄ bh9pj42wzikjd1ilqutnjbrx7.o</span>
<span id="cb4-25"><a href="#cb4-25"></a>        <span class="ex">‚îÇ&nbsp;&nbsp;</span>     ‚îÇ&nbsp;&nbsp; ‚îú‚îÄ‚îÄ dep-graph.bin</span>
<span id="cb4-26"><a href="#cb4-26"></a>        <span class="ex">‚îÇ&nbsp;&nbsp;</span>     ‚îÇ&nbsp;&nbsp; ‚îú‚îÄ‚îÄ eymyqxruzdb24suchgzd8ygxb.o</span>
<span id="cb4-27"><a href="#cb4-27"></a>        <span class="ex">‚îÇ&nbsp;&nbsp;</span>     ‚îÇ&nbsp;&nbsp; ‚îú‚îÄ‚îÄ query-cache.bin</span>
<span id="cb4-28"><a href="#cb4-28"></a>        <span class="ex">‚îÇ&nbsp;&nbsp;</span>     ‚îÇ&nbsp;&nbsp; ‚îî‚îÄ‚îÄ work-products.bin</span>
<span id="cb4-29"><a href="#cb4-29"></a>        <span class="ex">‚îÇ&nbsp;&nbsp;</span>     ‚îî‚îÄ‚îÄ s-hfeunnoewq-0c8luu5.lock</span>
<span id="cb4-30"><a href="#cb4-30"></a>        <span class="ex">‚îú‚îÄ‚îÄ</span> osirs</span>
<span id="cb4-31"><a href="#cb4-31"></a>        <span class="ex">‚îî‚îÄ‚îÄ</span> osirs.d</span>
<span id="cb4-32"><a href="#cb4-32"></a></span>
<span id="cb4-33"><a href="#cb4-33"></a><span class="ex">9</span> directories, 18 files</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="running" class="level2">
<h2 class="anchored" data-anchor-id="running">Running</h2>
<ul>
<li>Technically no one can stop you from using <code>cargo run</code> or even <code>cargo run --release</code></li>
<li>But you can also just <code>build</code> and then <em>directly</em> run the executable.</li>
</ul>
<div class="sourceCode" id="cb5"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1"></a><span class="ex">$</span> ./target/debug/osirs</span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="ex">Hello,</span> world!</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="the-no_std-attribute" class="level2">
<h2 class="anchored" data-anchor-id="the-no_std-attribute">The <code>no_std</code> Attribute</h2>
<ul>
<li>Initially, the crate implicitly links the standard library.</li>
<li>We can prepend the <code>no_std</code> attribute to <code>src/main.rs</code> to get the version of Rust that builds character!</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/main.rs</strong></pre>
</div>
<div class="sourceCode" id="cb6" data-filename="src/main.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb6-1"><a href="#cb6-1"></a><span class="co">// main.rs</span></span>
<span id="cb6-2"><a href="#cb6-2"></a></span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="at">#![</span>no_std<span class="at">]</span></span>
<span id="cb6-4"><a href="#cb6-4"></a></span>
<span id="cb6-5"><a href="#cb6-5"></a><span class="kw">fn</span> main() <span class="op">{</span></span>
<span id="cb6-6"><a href="#cb6-6"></a>    <span class="pp">println!</span>(<span class="st">" ô·¥è·¥° ·¥Ö·¥è·¥°…¥  ô·¥á“ì·¥è Ä·¥á ·¥õ ú·¥á …¢·¥è·¥Ö ·¥è“ì ·¥Ö·¥á·¥Ä·¥õ ú"</span>)<span class="op">;</span></span>
<span id="cb6-7"><a href="#cb6-7"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="we-can-rebuild" class="level2">
<h2 class="anchored" data-anchor-id="we-can-rebuild">We Can Rebuild</h2>
<ul>
<li>Actually we can‚Äôt.</li>
</ul>
<div class="sourceCode" id="cb7"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1"></a><span class="ex">$</span> cargo build</span>
<span id="cb7-2"><a href="#cb7-2"></a>   <span class="ex">Compiling</span> osirs v0.1.0 <span class="er">(</span><span class="ex">/home/user/tmp/32</span><span class="kw">)</span></span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="ex">error:</span> cannot find macro <span class="kw">`</span><span class="ex">println</span><span class="kw">`</span> in this scope</span>
<span id="cb7-4"><a href="#cb7-4"></a> <span class="ex">--</span><span class="op">&gt;</span> src/main.rs:6:5</span>
<span id="cb7-5"><a href="#cb7-5"></a>  <span class="kw">|</span></span>
<span id="cb7-6"><a href="#cb7-6"></a><span class="ex">6</span> <span class="kw">|</span>     <span class="ex">println!</span><span class="er">(</span><span class="st">" ô·¥è·¥° ·¥Ö·¥è·¥°…¥  ô·¥á“ì·¥è Ä·¥á ·¥õ ú·¥á …¢·¥è·¥Ö ·¥è“ì ·¥Ö·¥á·¥Ä·¥õ ú"</span><span class="kw">);</span></span>
<span id="cb7-7"><a href="#cb7-7"></a>  <span class="kw">|</span>     <span class="ex">^^^^^^^</span></span>
<span id="cb7-8"><a href="#cb7-8"></a></span>
<span id="cb7-9"><a href="#cb7-9"></a><span class="ex">error:</span> <span class="kw">`</span><span class="co">#[panic_handler]</span><span class="kw">`</span> function required, but not found</span>
<span id="cb7-10"><a href="#cb7-10"></a></span>
<span id="cb7-11"><a href="#cb7-11"></a><span class="ex">error:</span> unwinding panics are not supported without std</span>
<span id="cb7-12"><a href="#cb7-12"></a>  <span class="kw">|</span></span>
<span id="cb7-13"><a href="#cb7-13"></a>  <span class="ex">=</span> help: using nightly cargo, use <span class="at">-Zbuild-std</span> with panic=<span class="st">"abort"</span> to avoid unwinding</span>
<span id="cb7-14"><a href="#cb7-14"></a>  <span class="ex">=</span> note: since the core library is usually precompiled with panic=<span class="st">"unwind"</span>, rebuilding your crate with panic=<span class="st">"abort"</span> may not be enough to fix the problem</span>
<span id="cb7-15"><a href="#cb7-15"></a></span>
<span id="cb7-16"><a href="#cb7-16"></a><span class="ex">error:</span> could not compile <span class="kw">`</span><span class="ex">osirs</span><span class="kw">`</span> <span class="er">(</span><span class="ex">bin</span> <span class="st">"osirs"</span><span class="kw">)</span> <span class="ex">due</span> to 3 previous errors    ^^^^^^^</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="enhance" class="level2">
<h2 class="anchored" data-anchor-id="enhance">Enhance!</h2>
<div class="sourceCode" id="cb8"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1"></a><span class="ex">error:</span> cannot find macro <span class="kw">`</span><span class="ex">println</span><span class="kw">`</span> in this scope</span>
<span id="cb8-2"><a href="#cb8-2"></a> <span class="ex">--</span><span class="op">&gt;</span> src/main.rs:6:5</span>
<span id="cb8-3"><a href="#cb8-3"></a>  <span class="kw">|</span></span>
<span id="cb8-4"><a href="#cb8-4"></a><span class="ex">6</span> <span class="kw">|</span>     <span class="ex">println!</span><span class="er">(</span><span class="st">" ô·¥è·¥° ·¥Ö·¥è·¥°…¥  ô·¥á“ì·¥è Ä·¥á ·¥õ ú·¥á …¢·¥è·¥Ö ·¥è“ì ·¥Ö·¥á·¥Ä·¥õ ú"</span><span class="kw">);</span></span>
<span id="cb8-5"><a href="#cb8-5"></a>  <span class="kw">|</span>     <span class="ex">^^^^^^^</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Oh right, we can‚Äôt print without an OS.</li>
</ul>
</section>
<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<ul>
<li>The <code>println</code> macro is part of the standard library <code>std</code>.</li>
<li>We said <code>no_std</code>.</li>
<li>So we can no longer print things.</li>
<li>I hope it is clear how this is character-building!</li>
<li>Read more:
<ul>
<li><a href="https://doc.rust-lang.org/std/macro.println.html"><code>println</code> macro</a></li>
<li><a href="https://en.wikipedia.org/wiki/Standard_streams#Standard_output_.28stdout.29">standard output</a></li>
</ul></li>
</ul>
</section>
<section id="rip-it" class="level2">
<h2 class="anchored" data-anchor-id="rip-it">Rip it</h2>
<ul>
<li>Remove the printing and try again:</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/main.rs</strong></pre>
</div>
<div class="sourceCode" id="cb9" data-filename="src/main.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb9-1"><a href="#cb9-1"></a><span class="co">// main.rs</span></span>
<span id="cb9-2"><a href="#cb9-2"></a></span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="at">#![</span>no_std<span class="at">]</span></span>
<span id="cb9-4"><a href="#cb9-4"></a></span>
<span id="cb9-5"><a href="#cb9-5"></a><span class="kw">fn</span> main() <span class="op">{</span></span>
<span id="cb9-6"><a href="#cb9-6"></a>    <span class="co">// println!(" ô·¥è·¥° ·¥Ö·¥è·¥°…¥  ô·¥á“ì·¥è Ä·¥á ·¥õ ú·¥á …¢·¥è·¥Ö ·¥è“ì ·¥Ö·¥á·¥Ä·¥õ ú");</span></span>
<span id="cb9-7"><a href="#cb9-7"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="problems-remain" class="level2">
<h2 class="anchored" data-anchor-id="problems-remain">Problems remain</h2>
<div class="sourceCode" id="cb10"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1"></a><span class="ex">$</span> cargo build</span>
<span id="cb10-2"><a href="#cb10-2"></a>   <span class="ex">Compiling</span> osirs v0.1.0 <span class="er">(</span><span class="ex">/home/user/tmp/32</span><span class="kw">)</span></span>
<span id="cb10-3"><a href="#cb10-3"></a><span class="ex">error:</span> <span class="kw">`</span><span class="co">#[panic_handler]</span><span class="kw">`</span> function required, but not found</span>
<span id="cb10-4"><a href="#cb10-4"></a></span>
<span id="cb10-5"><a href="#cb10-5"></a><span class="ex">error:</span> unwinding panics are not supported without std</span>
<span id="cb10-6"><a href="#cb10-6"></a>  <span class="kw">|</span></span>
<span id="cb10-7"><a href="#cb10-7"></a>  <span class="ex">=</span> help: using nightly cargo, use <span class="at">-Zbuild-std</span> with panic=<span class="st">"abort"</span> to avoid unwinding</span>
<span id="cb10-8"><a href="#cb10-8"></a>  <span class="ex">=</span> note: since the core library is usually precompiled with panic=<span class="st">"unwind"</span>, rebuilding your crate with panic=<span class="st">"abort"</span> may not be enough to fix the problem</span>
<span id="cb10-9"><a href="#cb10-9"></a></span>
<span id="cb10-10"><a href="#cb10-10"></a><span class="ex">error:</span> could not compile <span class="kw">`</span><span class="ex">osirs</span><span class="kw">`</span> <span class="er">(</span><span class="ex">bin</span> <span class="st">"osirs"</span><span class="kw">)</span> <span class="ex">due</span> to 2 previous errors</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="enhance-1" class="level2">
<h2 class="anchored" data-anchor-id="enhance-1">Enhance!</h2>
<div class="sourceCode" id="cb11"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1"></a><span class="ex">error:</span> cannot find macro <span class="kw">`</span><span class="ex">println</span><span class="kw">`</span> in this scope</span>
<span id="cb11-2"><a href="#cb11-2"></a> <span class="ex">--</span><span class="op">&gt;</span> src/main.rs:6:5</span>
<span id="cb11-3"><a href="#cb11-3"></a>  <span class="kw">|</span></span>
<span id="cb11-4"><a href="#cb11-4"></a><span class="ex">6</span> <span class="kw">|</span>     <span class="ex">println!</span><span class="er">(</span><span class="st">" ô·¥è·¥° ·¥Ö·¥è·¥°…¥  ô·¥á“ì·¥è Ä·¥á ·¥õ ú·¥á …¢·¥è·¥Ö ·¥è“ì ·¥Ö·¥á·¥Ä·¥õ ú"</span><span class="kw">);</span></span>
<span id="cb11-5"><a href="#cb11-5"></a>  <span class="kw">|</span>     <span class="ex">^^^^^^^</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Sometimes, Rust explodes and calls the OS (written in C!) for help.</li>
<li>It can‚Äôt do that without <code>std</code> and is sad üò≠</li>
</ul>
</section>
<section id="panic" class="level2">
<h2 class="anchored" data-anchor-id="panic">Panic</h2>
<ul>
<li>The <code>panic_handler</code> attribute defines the function that the compiler should invoke when a panic occurs.</li>
<li><code>std</code> provides its own panic handler function, but in a <code>no_std</code> environment we need to define it ourselves:</li>
<li><a href="https://doc.rust-lang.org/stable/book/ch09-01-unrecoverable-errors-with-panic.html">panic</a></li>
</ul>
</section>
<section id="our-approach" class="level2">
<h2 class="anchored" data-anchor-id="our-approach">Our Approach</h2>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/main.rs</strong></pre>
</div>
<div class="sourceCode" id="cb12" data-filename="src/main.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb12-1"><a href="#cb12-1"></a><span class="co">// main.rs</span></span>
<span id="cb12-2"><a href="#cb12-2"></a></span>
<span id="cb12-3"><a href="#cb12-3"></a><span class="co">/// This function is called on panic.</span></span>
<span id="cb12-4"><a href="#cb12-4"></a><span class="at">#[</span>panic_handler<span class="at">]</span></span>
<span id="cb12-5"><a href="#cb12-5"></a><span class="kw">fn</span> panic(_info<span class="op">:</span> <span class="op">&amp;</span><span class="pp">core::panic::</span>PanicInfo) <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb12-6"><a href="#cb12-6"></a>    <span class="cf">loop</span> <span class="op">{}</span></span>
<span id="cb12-7"><a href="#cb12-7"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="panics" class="level2">
<h2 class="anchored" data-anchor-id="panics">Panics</h2>
<ul>
<li>The <code>PanicInfo</code> parameter contains:
<ul>
<li><em>file</em> and <em>line</em> where the panic happened</li>
<li>panic message (e.g.&nbsp;<code>panic!("YOLO")</code></li>
</ul></li>
<li>The function should never return.
<ul>
<li>So it is marked as a ‚Äúdiverging function‚Äù</li>
<li>It returns the ‚Äúnever‚Äù type <code>!</code>.</li>
</ul></li>
<li>Not much we can do in this function for now, so just <code>loop()</code> to prevent a return.</li>
</ul>
</section>
<section id="read-more" class="level2">
<h2 class="anchored" data-anchor-id="read-more">Read more‚Ä¶</h2>
<ul>
<li>I had never heard of or used these but to me it was clear why they would have to exist in a type safe language.
<ul>
<li><a href="https://doc.rust-lang.org/nightly/core/panic/struct.PanicInfo.html">PanicInfo</a></li>
<li><a href="https://doc.rust-lang.org/1.30.0/book/first-edition/functions.html#diverging-functions">diverging function</a></li>
<li><a href="https://doc.rust-lang.org/nightly/std/primitive.never.html">‚Äúnever‚Äù type</a></li>
</ul></li>
</ul>
<!--

## The `eh_personality` Language Item

Language items are special functions and types that are required internally by the compiler. For example, the [`Copy`] trait is a language item that tells the compiler which types have [_copy semantics_][`Copy`]. When we look at the [implementation][copy code], we see it has the special `#[lang = "copy"]` attribute that defines it as a language item.

[`Copy`]: https://doc.rust-lang.org/nightly/core/marker/trait.Copy.html
[copy code]: https://github.com/rust-lang/rust/blob/485397e49a02a3b7ff77c17e4a3f16c653925cb3/src/libcore/marker.rs#L296-L299

While providing custom implementations of language items is possible, it should only be done as a last resort. The reason is that language items are highly unstable implementation details and not even type checked (so the compiler doesn't even check if a function has the right argument types). Fortunately, there is a more stable way to fix the above language item error.

The [`eh_personality` language item] marks a function that is used for implementing [stack unwinding]. By default, Rust uses unwinding to run the destructors of all live stack variables in case of a [panic]. This ensures that all used memory is freed and allows the parent thread to catch the panic and continue execution. Unwinding, however, is a complicated process and requires some OS-specific libraries (e.g. [libunwind] on Linux or [structured exception handling] on Windows), so we don't want to use it for our operating system.

[`eh_personality` language item]: https://github.com/rust-lang/rust/blob/edb368491551a77d77a48446d4ee88b35490c565/src/libpanic_unwind/gcc.rs#L11-L45
[stack unwinding]: https://www.bogotobogo.com/cplusplus/stackunwinding.php
[libunwind]: https://www.nongnu.org/libunwind/
[structured exception handling]: https://docs.microsoft.com/en-us/windows/win32/debug/structured-exception-handling

-->
</section>
<section id="retry" class="level2">
<h2 class="anchored" data-anchor-id="retry">Retry</h2>
<ul>
<li>I bet it works now!</li>
</ul>
<div class="sourceCode" id="cb13"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1"></a><span class="ex">$</span> cargo build</span>
<span id="cb13-2"><a href="#cb13-2"></a>   <span class="ex">Compiling</span> osirs v0.1.0 <span class="er">(</span><span class="ex">/home/user/tmp/32</span><span class="kw">)</span></span>
<span id="cb13-3"><a href="#cb13-3"></a><span class="ex">error:</span> unwinding panics are not supported without std</span>
<span id="cb13-4"><a href="#cb13-4"></a>  <span class="kw">|</span></span>
<span id="cb13-5"><a href="#cb13-5"></a>  <span class="ex">=</span> help: using nightly cargo, use <span class="at">-Zbuild-std</span> with panic=<span class="st">"abort"</span> to avoid unwinding</span>
<span id="cb13-6"><a href="#cb13-6"></a>  <span class="ex">=</span> note: since the core library is usually precompiled with panic=<span class="st">"unwind"</span>, rebuilding your crate with panic=<span class="st">"abort"</span> may not be enough to fix the problem</span>
<span id="cb13-7"><a href="#cb13-7"></a></span>
<span id="cb13-8"><a href="#cb13-8"></a><span class="ex">error:</span> could not compile <span class="kw">`</span><span class="ex">osirs</span><span class="kw">`</span> <span class="er">(</span><span class="ex">bin</span> <span class="st">"osirs"</span><span class="kw">)</span> <span class="ex">due</span> to 1 previous error</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>They should make a version of the OS class that is easy.
<ul>
<li>(They did - this class)</li>
</ul></li>
</ul>
</section>
<section id="panic-abort" class="level2">
<h2 class="anchored" data-anchor-id="panic-abort">Panic abort</h2>
<div class="columns">
<div class="column" style="width:50%;">
<ul>
<li>Fun fact - back when I was an OS engineer slash rocket scientist my first launch was <a href="https://en.wikipedia.org/wiki/Pad_Abort-1">‚ÄúPA-1‚Äù for ‚ÄúPad Abort 1‚Äù</a>
<ul>
<li>Blew up a rocket on the launch pad to make sure it was safe for humans.</li>
</ul></li>
</ul>
</div><div class="column" style="width:50%;">
<p><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/d/d6/450775main_wstf0510e04493_hires.jpg/330px-450775main_wstf0510e04493_hires.jpg" class="img-fluid"></p>
</div>
</div>
</section>
<section id="panic-abort-1" class="level2">
<h2 class="anchored" data-anchor-id="panic-abort-1">Panic abort</h2>
<ul>
<li>The use of the term ‚Äúabort‚Äù which in some nation-states is a hot-button political issue has come up from time-to-time in the discourse.</li>
<li><a href="https://www.theregister.com/2018/05/09/gnu_glic_abort_stallman/">Read more from 2018</a></li>
</ul>
<div class="sourceCode" id="cb14"><pre class="sourceCode numberSource email number-lines code-with-copy"><code class="sourceCode email"><span id="cb14-1"><a href="#cb14-1"></a></span>
<span id="cb14-2"><a href="#cb14-2"></a>25.7.4 Aborting a Program</span>
<span id="cb14-3"><a href="#cb14-3"></a></span>
<span id="cb14-4"><a href="#cb14-4"></a>...</span>
<span id="cb14-5"><a href="#cb14-5"></a></span>
<span id="cb14-6"><a href="#cb14-6"></a>Future Change Warning: Proposed Federal censorship regulations may prohibit us from giving you information about the possibility of calling this function. We would be required to say that this is not an acceptable way of terminating a program.</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="quoth-stallman" class="level2">
<h2 class="anchored" data-anchor-id="quoth-stallman">Quoth Stallman</h2>
<blockquote class="blockquote">
<p>‚ÄúThe point of this joke is even more important now than it was when I first wrote it,‚Äù [Free Software Foundation president] Stallman wrote in a note posted to project mailing list, in reference to today‚Äôs political climate. ‚ÄúPlease do not remove it. GNU is not a purely technical project, so the fact that this is not strictly and grimly technical is not a reason to remove this.‚Äù</p>
</blockquote>
</section>
<section id="now-in-rust" class="level2">
<h2 class="anchored" data-anchor-id="now-in-rust">Now in Rust</h2>
<ul>
<li>We can oppose fascism <em>and</em>
<ul>
<li>(looks into the history of NASA and Lockheed Martin)</li>
<li>(clears throat)</li>
<li>Moving on!<br>
</li>
</ul></li>
<li>We can abort programs‚Ä¶ <em>in Rust</em></li>
</ul>
</section>
<section id="how" class="level2">
<h2 class="anchored" data-anchor-id="how">How?</h2>
<ul>
<li>Read carefully:</li>
</ul>
<div class="sourceCode" id="cb15"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1"></a><span class="ex">=</span> help: using nightly cargo, use <span class="at">-Zbuild-std</span> with panic=<span class="st">"abort"</span> to avoid unwinding</span>
<span id="cb15-2"><a href="#cb15-2"></a><span class="ex">=</span> note: since the core library is usually precompiled with panic=<span class="st">"unwind"</span>, rebuilding your crate with panic=<span class="st">"abort"</span> may not be enough to fix the problem</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Geniuses will recognize <code>panic="abort"</code> syntax</li>
</ul>
</section>
<section id="toml" class="level2">
<h2 class="anchored" data-anchor-id="toml">TOML</h2>
<ul>
<li>It‚Äôs <code>.toml</code></li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Cargo.toml</strong></pre>
</div>
<div class="sourceCode" id="cb16" data-filename="Cargo.toml"><pre class="sourceCode numberSource toml number-lines code-with-copy"><code class="sourceCode toml"><span id="cb16-1"><a href="#cb16-1"></a><span class="kw">[package]</span></span>
<span id="cb16-2"><a href="#cb16-2"></a><span class="dt">name</span> <span class="op">=</span> <span class="st">"osirs"</span></span>
<span id="cb16-3"><a href="#cb16-3"></a><span class="dt">version</span> <span class="op">=</span> <span class="st">"0.1.0"</span></span>
<span id="cb16-4"><a href="#cb16-4"></a><span class="dt">edition</span> <span class="op">=</span> <span class="st">"2024"</span></span>
<span id="cb16-5"><a href="#cb16-5"></a></span>
<span id="cb16-6"><a href="#cb16-6"></a><span class="kw">[dependencies]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="crate-options" class="level2">
<h2 class="anchored" data-anchor-id="crate-options">Crate options</h2>
<ul>
<li>Nominally there are use cases for which unwinding is undesirable
<ul>
<li>My take: All cases.</li>
</ul></li>
<li>So Rust provides an option to ‚Äúabort on panic‚Äù instead.</li>
<li>This disables the generation of unwinding symbol information and thus considerably reduces binary size.
<ul>
<li>This seems obviously good to me.</li>
</ul></li>
</ul>
</section>
<section id="update-cargo.toml" class="level2">
<h2 class="anchored" data-anchor-id="update-cargo.toml">Update <code>Cargo.toml</code></h2>
<ul>
<li>Add the following:</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Cargo.toml</strong></pre>
</div>
<div class="sourceCode" id="cb17" data-filename="Cargo.toml"><pre class="sourceCode numberSource toml number-lines code-with-copy"><code class="sourceCode toml"><span id="cb17-1"><a href="#cb17-1"></a><span class="kw">[package]</span></span>
<span id="cb17-2"><a href="#cb17-2"></a><span class="dt">name</span> <span class="op">=</span> <span class="st">"osirs"</span></span>
<span id="cb17-3"><a href="#cb17-3"></a><span class="dt">version</span> <span class="op">=</span> <span class="st">"0.1.0"</span></span>
<span id="cb17-4"><a href="#cb17-4"></a><span class="dt">edition</span> <span class="op">=</span> <span class="st">"2024"</span></span>
<span id="cb17-5"><a href="#cb17-5"></a></span>
<span id="cb17-6"><a href="#cb17-6"></a><span class="kw">[dependencies]</span></span>
<span id="cb17-7"><a href="#cb17-7"></a></span>
<span id="cb17-8"><a href="#cb17-8"></a><span class="kw">[profile.dev]</span></span>
<span id="cb17-9"><a href="#cb17-9"></a><span class="dt">panic</span> <span class="op">=</span> <span class="st">"abort"</span></span>
<span id="cb17-10"><a href="#cb17-10"></a></span>
<span id="cb17-11"><a href="#cb17-11"></a><span class="kw">[profile.release]</span></span>
<span id="cb17-12"><a href="#cb17-12"></a><span class="dt">panic</span> <span class="op">=</span> <span class="st">"abort"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="now" class="level2">
<h2 class="anchored" data-anchor-id="now">Now‚Ä¶</h2>
<ul>
<li><p>This sets the panic strategy to <code>abort</code> for both the <code>dev</code> profile (used for <code>cargo build</code>) and the <code>release</code> profile (used for <code>cargo build --release</code>).</p></li>
<li><p><a href="https://github.com/rust-lang/rust/pull/32900">abort on panic</a></p></li>
<li><p>I bet it will work now.</p></li>
</ul>
</section>
<section id="whoops" class="level2">
<h2 class="anchored" data-anchor-id="whoops">Whoops!</h2>
<div class="sourceCode" id="cb18"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1"></a><span class="ex">$</span> cargo build</span>
<span id="cb18-2"><a href="#cb18-2"></a>   <span class="ex">Compiling</span> osirs v0.1.0 <span class="er">(</span><span class="ex">/home/user/tmp/32</span><span class="kw">)</span></span>
<span id="cb18-3"><a href="#cb18-3"></a><span class="ex">error:</span> using <span class="kw">`</span><span class="ex">fn</span> main<span class="kw">`</span> requires the standard library</span>
<span id="cb18-4"><a href="#cb18-4"></a>  <span class="kw">|</span></span>
<span id="cb18-5"><a href="#cb18-5"></a>  <span class="ex">=</span> help: use <span class="kw">`</span><span class="co">#![no_main]</span><span class="kw">`</span> to bypass the Rust generated entrypoint and declare a platform specific entrypoint yourself, usually with <span class="kw">`</span><span class="co">#[no_mangle]</span><span class="kw">`</span></span>
<span id="cb18-6"><a href="#cb18-6"></a></span>
<span id="cb18-7"><a href="#cb18-7"></a><span class="ex">error:</span> could not compile <span class="kw">`</span><span class="ex">osirs</span><span class="kw">`</span> <span class="er">(</span><span class="ex">bin</span> <span class="st">"osirs"</span><span class="kw">)</span> <span class="ex">due</span> to 1 previous error</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Our program is missing the <code>start</code> language item, which defines the entry point.</li>
</ul>
</section>
<section id="the-start-attribute" class="level2">
<h2 class="anchored" data-anchor-id="the-start-attribute">The <code>start</code> attribute</h2>
<ul>
<li>One might think that the <code>main</code> function is the first function called when you run a program.</li>
<li>However, most languages have a ‚Äú<a href="https://en.wikipedia.org/wiki/Runtime_system">runtime system</a>‚Äù
<ul>
<li>For e.g.&nbsp;Java garbage collection (e.g.&nbsp;in Java)</li>
<li>For e.g.&nbsp;Go software threads (goroutines)</li>
</ul></li>
<li>This runtime needs to be called before <code>main</code>, since it needs to initialize itself.</li>
</ul>
</section>
<section id="c-again" class="level2">
<h2 class="anchored" data-anchor-id="c-again">C, again</h2>
<ul>
<li>In a typical Rust binary that links the standard library, execution starts in a C runtime library
<ul>
<li><code>crt0</code> for ‚ÄúC runtime zero‚Äù</li>
</ul></li>
<li>This creates a stack and places the arguments in the right hardware registers.</li>
<li>The C runtime then invokes the entry point of the Rust runtime, which is marked by the <code>start</code> language item.</li>
</ul>
</section>
<section id="back-to-rust" class="level2">
<h2 class="anchored" data-anchor-id="back-to-rust">Back to Rust</h2>
<ul>
<li>Rust only has a very minimal runtime, which takes care of some small things such as setting up stack overflow guards or printing a backtrace on panic.</li>
<li>The runtime then finally calls the <code>main</code> function.</li>
</ul>
</section>
<section id="crt0-is-cheating" class="level2">
<h2 class="anchored" data-anchor-id="crt0-is-cheating"><code>crt0</code> is cheating</h2>
<ul>
<li>Our freestanding executable does not have access to the Rust runtime and <code>crt0</code></li>
<li>We need to define our own entry point. = Implementing the <code>start</code> language item wouldn‚Äôt help, since it would still require <code>crt0</code>.</li>
<li>Instead, we need to overwrite the <code>crt0</code> entry point directly.</li>
</ul>
<section id="overwriting" class="level3">
<h3 class="anchored" data-anchor-id="overwriting">Overwriting</h3>
<ul>
<li>To tell the Rust compiler that we don‚Äôt want to use the normal entry point chain, we add the <code>#![no_main]</code> attribute.</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/main.rs</strong></pre>
</div>
<div class="sourceCode" id="cb19" data-filename="src/main.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb19-1"><a href="#cb19-1"></a><span class="co">// main.rs</span></span>
<span id="cb19-2"><a href="#cb19-2"></a></span>
<span id="cb19-3"><a href="#cb19-3"></a><span class="at">#![</span>no_std<span class="at">]</span></span>
<span id="cb19-4"><a href="#cb19-4"></a><span class="at">#![</span>no_main<span class="at">]</span></span>
<span id="cb19-5"><a href="#cb19-5"></a></span>
<span id="cb19-6"><a href="#cb19-6"></a><span class="co">/// This function is called on panic.</span></span>
<span id="cb19-7"><a href="#cb19-7"></a><span class="at">#[</span>panic_handler<span class="at">]</span></span>
<span id="cb19-8"><a href="#cb19-8"></a><span class="kw">fn</span> panic(_info<span class="op">:</span> <span class="op">&amp;</span><span class="pp">core::panic::</span>PanicInfo) <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb19-9"><a href="#cb19-9"></a>    <span class="cf">loop</span> <span class="op">{}</span></span>
<span id="cb19-10"><a href="#cb19-10"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="no-main-in-main" class="level2">
<h2 class="anchored" data-anchor-id="no-main-in-main">No main in main</h2>
<ul>
<li>At this point we can also remove the <code>main</code> function.</li>
<li>Absent a compatible runtime, <code>main</code> is meaningless!</li>
<li>If you <code>cargo build</code> at this point, by the way, you will get some fun errors.</li>
</ul>
</section>
<section id="start-in-main" class="level2">
<h2 class="anchored" data-anchor-id="start-in-main">Start in main</h2>
<ul>
<li>Instead, overwrite the entry point with our own <code>_start</code> function:</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/main.rs</strong></pre>
</div>
<div class="sourceCode" id="cb20" data-filename="src/main.rs"><pre class="sourceCode numberSource rs number-lines code-with-copy"><code class="sourceCode rust"><span id="cb20-1"><a href="#cb20-1"></a><span class="at">#[</span><span class="kw">unsafe</span><span class="at">(</span>no_mangle<span class="at">)]</span></span>
<span id="cb20-2"><a href="#cb20-2"></a><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">"C"</span> <span class="kw">fn</span> _start() <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb20-3"><a href="#cb20-3"></a>    <span class="cf">loop</span> <span class="op">{}</span></span>
<span id="cb20-4"><a href="#cb20-4"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="manglin" class="level2">
<h2 class="anchored" data-anchor-id="manglin">Manglin‚Äô</h2>
<ul>
<li>By using the <code>#[unsafe(no_mangle)]</code> attribute, we disable ‚Äúname mangling‚Äù
<ul>
<li>The function <strong>must</strong> be named <code>_start</code>.</li>
</ul></li>
<li>Otherwise, compiler generates unique symbols like <code>_start_imarandomstr_1234</code> to avoid namespace collisons.
<ul>
<li>Folks‚Ä¶ it‚Äôs key-value storage.</li>
</ul></li>
<li>The attribute is required for the <em>linker</em> in the next step.</li>
</ul>
</section>
<section id="c-you-again" class="level2">
<h2 class="anchored" data-anchor-id="c-you-again">C you again</h2>
<ul>
<li>Mark the function as <code>extern "C"</code> to tell the compiler that it should use the ‚ÄúC calling convention‚Äù</li>
<li>The reason for naming the function <code>_start</code> is that this is the default entry point name for most systems.</li>
</ul>
</section>
<section id="read-more-1" class="level2">
<h2 class="anchored" data-anchor-id="read-more-1">Read more</h2>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Name_mangling">name mangling</a></li>
<li><a href="https://en.wikipedia.org/wiki/Calling_convention">C calling convention</a></li>
</ul>
</section>
<section id="divergence" class="level2">
<h2 class="anchored" data-anchor-id="divergence">Divergence</h2>
<ul>
<li>The <code>!</code> return type returns!</li>
<li>This is required because the entry point is not called by any function, but invoked directly by the operating system or bootloader.
<ul>
<li>It can‚Äôt return anywhere!</li>
</ul></li>
</ul>
</section>
<section id="exit" class="level2">
<h2 class="anchored" data-anchor-id="exit">Exit</h2>
<ul>
<li>Before I go out to the clubs I always ‚ÄúX it up‚Äù (put X‚Äôs on my hands) because I‚Äôm straight edge.</li>
<li>Operating systems are similar.</li>
<li>So instead of returning, the entry point should e.g.&nbsp;invoke the <code>exit</code> system call of the operating system.</li>
<li>For now, we fulfill the requirement by looping endlessly.</li>
<li><a href="https://en.wikipedia.org/wiki/Exit_(system_call)"><code>exit</code> system call</a></li>
</ul>
</section>
<section id="now-it-works" class="level2">
<h2 class="anchored" data-anchor-id="now-it-works">Now it works!</h2>
<ul>
<li>It doesn‚Äôt.</li>
</ul>
<div class="sourceCode" id="cb21"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1"></a><span class="ex">$</span> cargo build</span>
<span id="cb21-2"><a href="#cb21-2"></a>   <span class="ex">Compiling</span> osirs v0.1.0 <span class="er">(</span><span class="ex">/home/user/tmp/32</span><span class="kw">)</span></span>
<span id="cb21-3"><a href="#cb21-3"></a><span class="ex">error:</span> linking with <span class="kw">`</span><span class="fu">cc</span><span class="kw">`</span> failed: exit status: 1</span>
<span id="cb21-4"><a href="#cb21-4"></a>  <span class="kw">|</span></span>
<span id="cb21-5"><a href="#cb21-5"></a>  <span class="ex">=</span> note:  <span class="st">"cc"</span> <span class="st">"-m64"</span> <span class="st">"/tmp/rustcheyGtM/symbols.o"</span> <span class="st">"&lt;1 object files omitted&gt;"</span> <span class="st">"-Wl,--as-needed"</span> <span class="st">"-Wl,-Bstatic"</span> <span class="st">"&lt;sysroot&gt;/lib/rustlib/x86_64-unknown-linux-gnu/lib/{librustc_std_workspace_core-*,libcore-*,libcompiler_builtins-*}.rlib"</span> <span class="st">"-L"</span> <span class="st">"/tmp/rustcheyGtM/raw-dylibs"</span> <span class="st">"-Wl,-Bdynamic"</span> <span class="st">"-Wl,--eh-frame-hdr"</span> <span class="st">"-Wl,-z,noexecstack"</span> <span class="st">"-L"</span> <span class="st">"&lt;sysroot&gt;/lib/rustlib/x86_64-unknown-linux-gnu/lib"</span> <span class="st">"-o"</span> <span class="st">"/home/user/tmp/32/target/debug/deps/osirs-80f8eb3240ba748e"</span> <span class="st">"-Wl,--gc-sections"</span> <span class="st">"-pie"</span> <span class="st">"-Wl,-z,relro,-z,now"</span> <span class="st">"-nodefaultlibs"</span></span>
<span id="cb21-6"><a href="#cb21-6"></a>  <span class="ex">=</span> note: some arguments are omitted. use <span class="kw">`</span><span class="ex">--verbose</span><span class="kw">`</span> to show all linker arguments</span>
<span id="cb21-7"><a href="#cb21-7"></a>  <span class="ex">=</span> note: /usr/bin/ld: /home/user/tmp/32/target/debug/deps/osirs-80f8eb3240ba748e.9chdw59nqscmfe0ef1hrxy2nb.rcgu.o: in function <span class="kw">`</span><span class="ex">_start</span><span class="st">':</span></span>
<span id="cb21-8"><a href="#cb21-8"></a><span class="st">          /home/user/tmp/32/src/main.rs:14: multiple definition of `_start'</span><span class="kw">;</span> <span class="ex">/usr/lib/gcc/x86_64-linux-gnu/11/../../../x86_64-linux-gnu/Scrt1.o:</span><span class="er">(</span><span class="ex">.text+0x0</span><span class="kw">)</span><span class="bu">:</span> first defined here</span>
<span id="cb21-9"><a href="#cb21-9"></a>          <span class="ex">/usr/bin/ld:</span> /usr/lib/gcc/x86_64-linux-gnu/11/../../../x86_64-linux-gnu/Scrt1.o: in function <span class="kw">`</span>_start<span class="st">':</span></span>
<span id="cb21-10"><a href="#cb21-10"></a><span class="st">          (.text+0x1b): undefined reference to `main'</span></span>
<span id="cb21-11"><a href="#cb21-11"></a>          <span class="ex">/usr/bin/ld:</span> <span class="er">(</span><span class="ex">.text+0x21</span><span class="kw">)</span><span class="bu">:</span> undefined reference to <span class="kw">`</span><span class="ex">__libc_start_main</span><span class="st">'</span></span>
<span id="cb21-12"><a href="#cb21-12"></a><span class="st">          collect2: error: ld returned 1 exit status</span></span>
<span id="cb21-13"><a href="#cb21-13"></a></span>
<span id="cb21-14"><a href="#cb21-14"></a><span class="st">  = note: some `extern` functions couldn'</span><span class="ex">t</span> be found<span class="kw">;</span> <span class="ex">some</span> native libraries may need to be installed or have their path specified</span>
<span id="cb21-15"><a href="#cb21-15"></a>  <span class="ex">=</span> note: use the <span class="kw">`</span><span class="at">-l</span><span class="kw">`</span> <span class="ex">flag</span> to specify native libraries to link</span>
<span id="cb21-16"><a href="#cb21-16"></a>  <span class="ex">=</span> note: use the <span class="kw">`</span>cargo:rustc-link-lib<span class="kw">`</span> <span class="ex">directive</span> to specify the native libraries to link with Cargo <span class="er">(</span><span class="ex">see</span> https://doc.rust-lang.org/cargo/reference/build-scripts.html#rustc-link-lib<span class="kw">)</span></span>
<span id="cb21-17"><a href="#cb21-17"></a></span>
<span id="cb21-18"><a href="#cb21-18"></a><span class="ex">error:</span> could not compile <span class="kw">`</span>osirs<span class="kw">`</span> <span class="kw">(</span><span class="ex">bin</span> <span class="st">"osirs"</span><span class="kw">)</span> <span class="ex">due</span> to 1 previous error</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="to-be-continued" class="level2">
<h2 class="anchored" data-anchor-id="to-be-continued">To be continued</h2>
<ul>
<li>I am 99% sure we run out of time here‚Ä¶</li>
<li>And will continue with the lab on linker errors!</li>
</ul>
<!--

## Linker Errors

- The linker is a program that combines the generated code into an executable. 
- Since the executable format differs between Linux, Windows, and macOS, each system has its own linker that throws a different error. 
- The fundamental cause of the errors is the same: the default configuration of the linker assumes that our program depends on the C runtime, which it does not.

## Solution

- To solve the errors, we need to tell the linker that it should not include the C runtime. 
- We can do this either by passing a certain set of arguments to the linker or by building for a bare metal target.

### Building for a Bare Metal Target

By default Rust tries to build an executable that is able to run in your current system environment. For example, if you're using Windows on `x86_64`, Rust tries to build an `.exe` Windows executable that uses `x86_64` instructions. This environment is called your "host" system.

To describe different environments, Rust uses a string called [_target triple_]. You can see the target triple for your host system by running `rustc --version --verbose`:

[_target triple_]: https://clang.llvm.org/docs/CrossCompilation.html#target-triple

```
rustc 1.35.0-nightly (474e7a648 2019-04-07)
binary: rustc
commit-hash: 474e7a6486758ea6fc761893b1a49cd9076fb0ab
commit-date: 2019-04-07
host: x86_64-unknown-linux-gnu
release: 1.35.0-nightly
LLVM version: 8.0
```

The above output is from a `x86_64` Linux system. We see that the `host` triple is `x86_64-unknown-linux-gnu`, which includes the CPU architecture (`x86_64`), the vendor (`unknown`), the operating system (`linux`), and the [ABI] (`gnu`).

[ABI]: https://en.wikipedia.org/wiki/Application_binary_interface

By compiling for our host triple, the Rust compiler and the linker assume that there is an underlying operating system such as Linux or Windows that uses the C runtime by default, which causes the linker errors. So, to avoid the linker errors, we can compile for a different environment with no underlying operating system.

An example of such a bare metal environment is the `thumbv7em-none-eabihf` target triple, which describes an [embedded] [ARM] system. The details are not important, all that matters is that the target triple has no underlying operating system, which is indicated by the `none` in the target triple. To be able to compile for this target, we need to add it in rustup:

[embedded]: https://en.wikipedia.org/wiki/Embedded_system
[ARM]: https://en.wikipedia.org/wiki/ARM_architecture

```
rustup target add thumbv7em-none-eabihf
```

This downloads a copy of the standard (and core) library for the system. Now we can build our freestanding executable for this target:

```
cargo build --target thumbv7em-none-eabihf
```

By passing a `--target` argument we [cross compile] our executable for a bare metal target system. Since the target system has no operating system, the linker does not try to link the C runtime and our build succeeds without any linker errors.

[cross compile]: https://en.wikipedia.org/wiki/Cross_compiler

This is the approach that we will use for building our OS kernel. Instead of `thumbv7em-none-eabihf`, we will use a [custom target] that describes a `x86_64` bare metal environment. The details will be explained in the next post.

[custom target]: https://doc.rust-lang.org/rustc/targets/custom.html

### Linker Arguments

Instead of compiling for a bare metal system, it is also possible to resolve the linker errors by passing a certain set of arguments to the linker. This will be the subject of the lab this week.


## Summary

A minimal freestanding Rust binary looks like this:

`src/main.rs`:

```rust
#![no_std] // don't link the Rust standard library
#![no_main] // disable all Rust-level entry points

#[unsafe(no_mangle)] // don't mangle the name of this function
pub extern "C" fn _start() -> ! {
    // this function is the entry point, since the linker looks for a function
    // named `_start` by default
    loop {}
}

/// This function is called on panic.
#[panic_handler]
fn panic(_info: &core::panic::PanicInfo) -> ! {
    loop {}
}
```

`Cargo.toml`:

```toml
[package]
name = "crate_name"
version = "0.1.0"
authors = ["Author Name <author@example.com>"]

# the profile used for `cargo build`
[profile.dev]
panic = "abort" # disable stack unwinding on panic

# the profile used for `cargo build --release`
[profile.release]
panic = "abort" # disable stack unwinding on panic
```

To build this binary, we need to compile for a bare metal target such as `thumbv7em-none-eabihf`:

```
cargo build --target thumbv7em-none-eabihf
```

Alternatively, we can compile it for the host system by passing additional linker arguments:

```bash
# Linux
cargo rustc -- -C link-arg=-nostartfiles
# Windows
cargo rustc -- -C link-args="/ENTRY:_start /SUBSYSTEM:console"
# macOS
cargo rustc -- -C link-args="-e __start -static -nostartfiles"
```

Note that this is just a minimal example of a freestanding Rust binary. This binary expects various things, for example, that a stack is initialized when the `_start` function is called. **So for any real use of such a binary, more steps are required**.

## Making `rust-analyzer` happy

The [`rust-analyzer`](https://rust-analyzer.github.io/) project is a great way to get code completion and "go to definition" support (and many other features) for Rust code in your editor.
It works really well for `#![no_std]` projects too, so I recommend using it for kernel development!

If you're using the [`checkOnSave`](https://rust-analyzer.github.io/book/configuration.html#checkOnSave) feature of `rust-analyzer` (enabled by default), it might report an error for the panic function of our kernel:

```
found duplicate lang item `panic_impl`
```

The reason for this error is that `rust-analyzer` invokes `cargo check --all-targets` by default, which also tries to build the binary in [test](https://doc.rust-lang.org/book/ch11-01-writing-tests.html) and [benchmark](https://doc.rust-lang.org/rustc/tests/index.html#benchmarks) mode.

<div class="note">

### The two meanings of "target"

The `--all-targets` flag is completely unrelated to the `--target` argument.
There are two different meanings of the term "target" in `cargo`:

- The `--target` flag specifies the **[_compilation target_]** that should be passed to the `rustc` compiler. This should be set to the [target triple] of the machine that should run our code.
- The `--all-targets` flag references the **[_package target_]** of Cargo. Cargo packages can be a library and binary at the same time, so you can specify in which way you like to build your crate. In addition, Cargo also has package targets for [examples](https://doc.rust-lang.org/cargo/reference/cargo-targets.html#examples), [tests](https://doc.rust-lang.org/cargo/reference/cargo-targets.html#tests), and [benchmarks](https://doc.rust-lang.org/cargo/reference/cargo-targets.html#benchmarks). These package targets can co-exist, so you can build/check the same crate in e.g. library or test mode.

[_compilation target_]: https://doc.rust-lang.org/rustc/targets/index.html
[target triple]: https://clang.llvm.org/docs/CrossCompilation.html#target-triple
[_package target_]: https://doc.rust-lang.org/cargo/reference/cargo-targets.html

</div>

By default, `cargo check` only builds the _library_ and _binary_ package targets.
However, `rust-analyzer` chooses to check all package targets by default when [`checkOnSave`](https://rust-analyzer.github.io/book/configuration.html#checkOnSave) is enabled.
This is the reason that `rust-analyzer` reports the above `lang item` error that we don't see in `cargo check`.
If we run `cargo check --all-targets`, we see the error too:

```
error[E0152]: found duplicate lang item `panic_impl`
  -->
<p>src/main.rs:13:1 | 13 | / fn panic(<em>info: &amp;PanicInfo) -&gt; ! { 14 | | loop {} 15 | | } | |</em>^ | = note: the lang item is first defined in crate <code>std</code> (which <code>test</code> depends on) = note: first definition in <code>std</code> loaded from /home/[‚Ä¶]/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib/libstd-8df6be531efb3fd0.rlib = note: second definition in the local crate (<code>blog_os</code>)</p>
<pre><code>
The first `note` tells us that the panic language item is already defined in the `std` crate, which is a dependency of the `test` crate.
The `test` crate is automatically included when building a crate in [test mode](https://doc.rust-lang.org/cargo/reference/cargo-targets.html#tests).
This does not make sense for our `#![no_std]` kernel as there is no way to support the standard library on bare metal.
So this error is not relevant to our project and we can safely ignore it.

The proper way to avoid this error is to specify in our `Cargo.toml` that our binary does not support building in `test` and `bench` modes.
We can do that by adding a `[[bin]]` section to our `Cargo.toml` to [configure the build](https://doc.rust-lang.org/cargo/reference/cargo-targets.html#configuring-a-target) of our binary:

```toml
# in Cargo.toml

[[bin]]
name = "blog_os"
test = false
bench = false</code></pre>
<p>The double-brackets around <code>bin</code> are not a mistake, this is how the TOML format defines keys that can appear multiple times. Since a crate can have multiple binaries, the <code>[[bin]]</code> section can appear multiple times in the <code>Cargo.toml</code> as well. This is also the reason for the mandatory <code>name</code> field, which needs to match the name of the binary (so that <code>cargo</code> knows which settings should be applied to which binary).</p>
<p>By setting the <a href="https://doc.rust-lang.org/cargo/reference/cargo-targets.html#the-test-field"><code>test</code></a> and <a href="https://doc.rust-lang.org/cargo/reference/cargo-targets.html#the-bench-field"><code>bench</code></a> fields to <code>false</code>, we instruct <code>cargo</code> to not build our binary in test or benchmark mode. Now <code>cargo check --all-targets</code> should not throw any errors anymore, and the <code>checkOnSave</code> implementation of <code>rust-analyzer</code> should be happy too.</p>
<p>‚Äì&gt;</p>


<!-- -->

</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "Óßã";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./22_malloc.html" class="pagination-link" aria-label="malloc">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">malloc</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./31_linker.html" class="pagination-link" aria-label="Linker">
        <span class="nav-page-text">Linker</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb23" data-shortcodes="false"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb23-1"><a href="#cb23-1"></a><span class="co">---</span></span>
<span id="cb23-2"><a href="#cb23-2"></a><span class="an">title:</span><span class="co"> Bare Metal</span></span>
<span id="cb23-3"><a href="#cb23-3"></a><span class="co">---</span></span>
<span id="cb23-4"><a href="#cb23-4"></a></span>
<span id="cb23-5"><a href="#cb23-5"></a><span class="fu">## Announcements</span></span>
<span id="cb23-6"><a href="#cb23-6"></a></span>
<span id="cb23-7"><a href="#cb23-7"></a><span class="ss">- </span>**Action Items**:</span>
<span id="cb23-8"><a href="#cb23-8"></a><span class="ss">  - </span><span class="in">`malloc`</span> stands eternal</span>
<span id="cb23-9"><a href="#cb23-9"></a><span class="ss">    - </span>Possibly the coolest assignment ever</span>
<span id="cb23-10"><a href="#cb23-10"></a><span class="ss">    - </span>I'm glad you all love it</span>
<span id="cb23-11"><a href="#cb23-11"></a><span class="ss">  - </span>Homework this week is more complicated but also more supported.</span>
<span id="cb23-12"><a href="#cb23-12"></a><span class="ss">    - </span>Prioritize <span class="in">`malloc`</span> I think.</span>
<span id="cb23-13"><a href="#cb23-13"></a></span>
<span id="cb23-14"><a href="#cb23-14"></a></span>
<span id="cb23-15"><a href="#cb23-15"></a><span class="fu">## Today</span></span>
<span id="cb23-16"><a href="#cb23-16"></a></span>
<span id="cb23-17"><a href="#cb23-17"></a><span class="ss">- </span>Bare metal</span>
<span id="cb23-18"><a href="#cb23-18"></a><span class="ss">    - </span>Bare metal</span>
<span id="cb23-19"><a href="#cb23-19"></a><span class="ss">    - </span>Ranting about how cool this is</span>
<span id="cb23-20"><a href="#cb23-20"></a><span class="ss">    - </span>Simulation</span>
<span id="cb23-21"><a href="#cb23-21"></a><span class="ss">    - </span>Emulation</span>
<span id="cb23-22"><a href="#cb23-22"></a><span class="ss">- </span>A bare metal binary</span>
<span id="cb23-23"><a href="#cb23-23"></a><span class="ss">    - </span>Runtimes</span>
<span id="cb23-24"><a href="#cb23-24"></a><span class="ss">    - </span><span class="in">`std`</span></span>
<span id="cb23-25"><a href="#cb23-25"></a>    </span>
<span id="cb23-26"><a href="#cb23-26"></a><span class="fu">## Citations</span></span>
<span id="cb23-27"><a href="#cb23-27"></a></span>
<span id="cb23-28"><a href="#cb23-28"></a><span class="ss">- </span>Outright theft:</span>
<span id="cb23-29"><a href="#cb23-29"></a><span class="ss">    - </span><span class="co">[</span><span class="ot">Welcome to Bare Metal Rust</span><span class="co">](https://google.github.io/comprehensive-rust/bare-metal.html)</span></span>
<span id="cb23-30"><a href="#cb23-30"></a><span class="ss">    - </span><span class="co">[</span><span class="ot">A Freestanding Rust Binary</span><span class="co">](https://os.phil-opp.com/freestanding-rust-binary/)</span></span>
<span id="cb23-31"><a href="#cb23-31"></a></span>
<span id="cb23-32"><a href="#cb23-32"></a><span class="fu"># Motivation</span></span>
<span id="cb23-33"><a href="#cb23-33"></a></span>
<span id="cb23-34"><a href="#cb23-34"></a><span class="fu">## Throwback ThMonday</span></span>
<span id="cb23-35"><a href="#cb23-35"></a></span>
<span id="cb23-36"><a href="#cb23-36"></a><span class="ss">- </span>I did this in grad school.</span>
<span id="cb23-37"><a href="#cb23-37"></a><span class="ss">    - </span><span class="co">[</span><span class="ot">RTL Simulation of C-Program on Bare-metal OR1200</span><span class="co">](https://medium.com/@rz2285/simulating-c-program-on-bare-metal-or1200-af67e2886fb8)</span></span>
<span id="cb23-38"><a href="#cb23-38"></a><span class="ss">- </span>My researcher (Juni) did this in '22</span>
<span id="cb23-39"><a href="#cb23-39"></a><span class="ss">    - </span><span class="co">[</span><span class="ot">Bare-Metal Programs on RISC-V</span><span class="co">](https://cd-public.github.io/research/students/aphrodite.pdf)</span></span>
<span id="cb23-40"><a href="#cb23-40"></a><span class="ss">- </span>I did this... last week.</span>
<span id="cb23-41"><a href="#cb23-41"></a><span class="ss">    - </span><span class="co">[</span><span class="ot">Slides including bare-metal execution in Verilog</span><span class="co">](https://vcd2df.github.io/pnsqc/#/demonstration)</span></span>
<span id="cb23-42"><a href="#cb23-42"></a>    </span>
<span id="cb23-43"><a href="#cb23-43"></a><span class="fu">## Bare Metal</span></span>
<span id="cb23-44"><a href="#cb23-44"></a></span>
<span id="cb23-45"><a href="#cb23-45"></a><span class="at">&gt; </span><span class="co">[</span><span class="ot">A computer which has no operating system. The software executed by a bare machine, commonly called a "bare metal program" or "bare metal application", is designed to interact directly with hardware. Bare machines are widely used in embedded systems, particularly in cases where resources are limited or high performance is required.</span><span class="co">](https://en.wikipedia.org/wiki/Bare_machine)</span></span>
<span id="cb23-46"><a href="#cb23-46"></a></span>
<span id="cb23-47"><a href="#cb23-47"></a><span class="fu">## Some Terms</span></span>
<span id="cb23-48"><a href="#cb23-48"></a></span>
<span id="cb23-49"><a href="#cb23-49"></a><span class="ss">- </span>Should introduce a few terms.</span>
<span id="cb23-50"><a href="#cb23-50"></a><span class="ss">    - </span>Not required for OS but useful to know.</span>
<span id="cb23-51"><a href="#cb23-51"></a><span class="ss">- </span>Terms</span>
<span id="cb23-52"><a href="#cb23-52"></a><span class="ss">    - </span>Simulation</span>
<span id="cb23-53"><a href="#cb23-53"></a><span class="ss">    - </span>Emulation</span>
<span id="cb23-54"><a href="#cb23-54"></a><span class="ss">    - </span>Cross-compilation</span>
<span id="cb23-55"><a href="#cb23-55"></a><span class="ss">    - </span>QEMU</span>
<span id="cb23-56"><a href="#cb23-56"></a>    </span>
<span id="cb23-57"><a href="#cb23-57"></a><span class="fu">## Simulation</span></span>
<span id="cb23-58"><a href="#cb23-58"></a></span>
<span id="cb23-59"><a href="#cb23-59"></a><span class="ss">- </span>Models a system's behavior</span>
<span id="cb23-60"><a href="#cb23-60"></a><span class="ss">- </span>Focuses on high-level results, not internal logic</span>
<span id="cb23-61"><a href="#cb23-61"></a><span class="ss">- </span>"Close enough" for performance or logic testing</span>
<span id="cb23-62"><a href="#cb23-62"></a><span class="ss">- </span>Simulating hardware components in software</span>
<span id="cb23-63"><a href="#cb23-63"></a><span class="ss">- </span>Faster but less precise</span>
<span id="cb23-64"><a href="#cb23-64"></a></span>
<span id="cb23-65"><a href="#cb23-65"></a><span class="fu">## Emulation</span></span>
<span id="cb23-66"><a href="#cb23-66"></a></span>
<span id="cb23-67"><a href="#cb23-67"></a><span class="ss">- </span>Replicating exact internal behavior of hardware</span>
<span id="cb23-68"><a href="#cb23-68"></a><span class="ss">- </span>Software acting as hardware (CPU, registers, memory)</span>
<span id="cb23-69"><a href="#cb23-69"></a><span class="ss">- </span>**Accuracy vs. Speed**:</span>
<span id="cb23-70"><a href="#cb23-70"></a><span class="ss">  - </span>Much slower than simulation... unless?</span>
<span id="cb23-71"><a href="#cb23-71"></a><span class="ss">  - </span>Goal: Guest software doesn't know it's not on actual silicon</span>
<span id="cb23-72"><a href="#cb23-72"></a>  </span>
<span id="cb23-73"><a href="#cb23-73"></a><span class="fu">## Example</span></span>
<span id="cb23-74"><a href="#cb23-74"></a></span>
<span id="cb23-75"><a href="#cb23-75"></a><span class="ss">- </span><span class="in">`x86-64`</span> - the Intel/AMD architecture common for Linux and Windows - supports a "long double" float with 80 bits of precision.</span>
<span id="cb23-76"><a href="#cb23-76"></a><span class="ss">- </span><span class="in">`ARM64`</span> - a competing formulation most popularized as "Apple silicon" with the M1 - lacks long doubles.</span>
<span id="cb23-77"><a href="#cb23-77"></a></span>
<span id="cb23-78"><a href="#cb23-78"></a><span class="fu">## Context</span></span>
<span id="cb23-79"><a href="#cb23-79"></a></span>
<span id="cb23-80"><a href="#cb23-80"></a><span class="ss">- </span>It is trivial to implement a float in software...</span>
<span id="cb23-81"><a href="#cb23-81"></a><span class="ss">    - </span><span class="co">[</span><span class="ot">`f16`</span><span class="co">](https://cd-c89.github.io/rs/51_f16.html)</span></span>
<span id="cb23-82"><a href="#cb23-82"></a><span class="ss">- </span>It is relatively not-trivial to implement *an architecture* in software, though possible.</span>
<span id="cb23-83"><a href="#cb23-83"></a><span class="ss">    - </span>Here's the smallest example I know: </span>
<span id="cb23-84"><a href="#cb23-84"></a><span class="ss">    - </span><span class="co">[</span><span class="ot">PicoRV32</span><span class="co">](https://github.com/YosysHQ/picorv32)</span></span>
<span id="cb23-85"><a href="#cb23-85"></a></span>
<span id="cb23-86"><a href="#cb23-86"></a><span class="fu">## Cross-Compiling</span></span>
<span id="cb23-87"><a href="#cb23-87"></a></span>
<span id="cb23-88"><a href="#cb23-88"></a><span class="ss">- </span>Example:" compiling code *on* an x86 laptop *for* an ARM chip</span>
<span id="cb23-89"><a href="#cb23-89"></a><span class="ss">    - </span>Common in embedded applications (e.g. program a thermostat)</span>
<span id="cb23-90"><a href="#cb23-90"></a><span class="ss">- </span>Compiler runs on Host A, produces binary for Target B</span>
<span id="cb23-91"><a href="#cb23-91"></a><span class="ss">  - </span>Essential for "bare metal" development</span>
<span id="cb23-92"><a href="#cb23-92"></a><span class="ss">  - </span>Transmit the binary over wires (the bus!) to another device's memory.</span>
<span id="cb23-93"><a href="#cb23-93"></a>  </span>
<span id="cb23-94"><a href="#cb23-94"></a><span class="fu">## Considerations</span></span>
<span id="cb23-95"><a href="#cb23-95"></a>  </span>
<span id="cb23-96"><a href="#cb23-96"></a><span class="ss">- </span>We must:</span>
<span id="cb23-97"><a href="#cb23-97"></a><span class="ss">  - </span>**Target** a specific architecture</span>
<span id="cb23-98"><a href="#cb23-98"></a><span class="ss">  - </span>**Link** against specific hardware memory maps</span>
<span id="cb23-99"><a href="#cb23-99"></a><span class="ss">- </span>Somehow you also need the actual hardware, unless...</span>
<span id="cb23-100"><a href="#cb23-100"></a></span>
<span id="cb23-101"><a href="#cb23-101"></a><span class="fu">## QEMU</span></span>
<span id="cb23-102"><a href="#cb23-102"></a></span>
<span id="cb23-103"><a href="#cb23-103"></a><span class="ss">- </span>I used this a lot in grad school; less now.</span>
<span id="cb23-104"><a href="#cb23-104"></a><span class="ss">  - </span>Supports both emulation and virtualization</span>
<span id="cb23-105"><a href="#cb23-105"></a><span class="ss">    - </span>Virtualization emulates a device rather than a binary.</span>
<span id="cb23-106"><a href="#cb23-106"></a><span class="ss">    - </span>Used in cloud; can be fast; huge research area.</span>
<span id="cb23-107"><a href="#cb23-107"></a><span class="ss">- </span>Let's us run bare metal binaries without physical chips (which would cost $)</span>
<span id="cb23-108"><a href="#cb23-108"></a><span class="ss">- </span>Write locally $\rightarrow$ Cross-compile $\rightarrow$ Run in QEMU</span>
<span id="cb23-109"><a href="#cb23-109"></a></span>
<span id="cb23-110"><a href="#cb23-110"></a><span class="fu"># Binary</span></span>
<span id="cb23-111"><a href="#cb23-111"></a></span>
<span id="cb23-112"><a href="#cb23-112"></a><span class="fu">## First Steps</span></span>
<span id="cb23-113"><a href="#cb23-113"></a></span>
<span id="cb23-114"><a href="#cb23-114"></a><span class="ss">- </span>The first step in creating our own operating system kernel is to create a Rust executable that does not link the standard library. </span>
<span id="cb23-115"><a href="#cb23-115"></a><span class="ss">- </span>This makes it possible to run Rust code on the "bare metal" without an underlying operating system.</span>
<span id="cb23-116"><a href="#cb23-116"></a></span>
<span id="cb23-117"><a href="#cb23-117"></a><span class="fu">## Introduction</span></span>
<span id="cb23-118"><a href="#cb23-118"></a></span>
<span id="cb23-119"><a href="#cb23-119"></a><span class="ss">- </span>To write an operating system kernel, we need code that does not depend on any operating system features. </span>
<span id="cb23-120"><a href="#cb23-120"></a><span class="ss">- </span>This means that we can't use files, the heap, networks, random numbers, standard output, etc. </span>
<span id="cb23-121"><a href="#cb23-121"></a><span class="ss">- </span>We're trying to write our own OS!</span>
<span id="cb23-122"><a href="#cb23-122"></a></span>
<span id="cb23-123"><a href="#cb23-123"></a><span class="fu">## On `std`</span></span>
<span id="cb23-124"><a href="#cb23-124"></a></span>
<span id="cb23-125"><a href="#cb23-125"></a><span class="ss">- </span>We can't use most of the Rust standard library, but... </span>
<span id="cb23-126"><a href="#cb23-126"></a><span class="ss">- </span>...there are a lot of Rust features that we _can_ use. </span>
<span id="cb23-127"><a href="#cb23-127"></a><span class="ss">- </span>For example, we can use iterators, closures, pattern matching, <span class="in">`option`</span> and <span class="in">`result`</span></span>
<span id="cb23-128"><a href="#cb23-128"></a><span class="ss">    - </span>Recall the official Calvin Deutschbein position on <span class="in">`option`</span> and <span class="in">`result`</span>:</span>
<span id="cb23-129"><a href="#cb23-129"></a><span class="ss">    - </span>"It's why Rust is good." - me</span>
<span id="cb23-130"><a href="#cb23-130"></a>   </span>
<span id="cb23-131"><a href="#cb23-131"></a><span class="fu">## On `std`</span></span>
<span id="cb23-132"><a href="#cb23-132"></a>    </span>
<span id="cb23-133"><a href="#cb23-133"></a><span class="ss">- </span>While not initially helpful, we can use string formatting, and...</span>
<span id="cb23-134"><a href="#cb23-134"></a><span class="ss">- </span>... the ownership system.</span>
<span id="cb23-135"><a href="#cb23-135"></a><span class="ss">    - </span>Beats <span class="in">`malloc`</span>!</span>
<span id="cb23-136"><a href="#cb23-136"></a>    </span>
<span id="cb23-137"><a href="#cb23-137"></a><span class="fu">## Quoth The Blog</span></span>
<span id="cb23-138"><a href="#cb23-138"></a>    </span>
<span id="cb23-139"><a href="#cb23-139"></a><span class="at">&gt; These features make it possible to write a kernel in a very expressive, high level way without worrying about undefined behavior or memory safety.</span></span>
<span id="cb23-140"><a href="#cb23-140"></a></span>
<span id="cb23-141"><a href="#cb23-141"></a><span class="ss">- </span>Well, we'll see.</span>
<span id="cb23-142"><a href="#cb23-142"></a></span>
<span id="cb23-143"><a href="#cb23-143"></a><span class="fu">## We keep {.smaller}</span></span>
<span id="cb23-144"><a href="#cb23-144"></a></span>
<span id="cb23-145"><a href="#cb23-145"></a><span class="ss">- </span><span class="co">[</span><span class="ot">option</span><span class="co">](https://doc.rust-lang.org/core/option/)</span></span>
<span id="cb23-146"><a href="#cb23-146"></a><span class="ss">- </span><span class="co">[</span><span class="ot">result</span><span class="co">](https://doc.rust-lang.org/core/result/)</span></span>
<span id="cb23-147"><a href="#cb23-147"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Rust standard library</span><span class="co">](https://doc.rust-lang.org/std/)</span></span>
<span id="cb23-148"><a href="#cb23-148"></a><span class="ss">- </span><span class="co">[</span><span class="ot">iterators</span><span class="co">](https://doc.rust-lang.org/book/ch13-02-iterators.html)</span></span>
<span id="cb23-149"><a href="#cb23-149"></a><span class="ss">- </span><span class="co">[</span><span class="ot">closures</span><span class="co">](https://doc.rust-lang.org/book/ch13-01-closures.html)</span></span>
<span id="cb23-150"><a href="#cb23-150"></a><span class="ss">- </span><span class="co">[</span><span class="ot">pattern matching</span><span class="co">](https://doc.rust-lang.org/book/ch06-00-enums.html)</span></span>
<span id="cb23-151"><a href="#cb23-151"></a><span class="ss">- </span><span class="co">[</span><span class="ot">string formatting</span><span class="co">](https://doc.rust-lang.org/core/macro.write.html)</span></span>
<span id="cb23-152"><a href="#cb23-152"></a><span class="ss">- </span><span class="co">[</span><span class="ot">ownership system</span><span class="co">](https://doc.rust-lang.org/book/ch04-00-understanding-ownership.html)</span></span>
<span id="cb23-153"><a href="#cb23-153"></a><span class="ss">- </span><span class="co">[</span><span class="ot">undefined behavior</span><span class="co">](https://www.nayuki.io/page/undefined-behavior-in-c-and-cplusplus-programs)</span></span>
<span id="cb23-154"><a href="#cb23-154"></a><span class="ss">- </span><span class="co">[</span><span class="ot">memory safety</span><span class="co">](https://tonyarcieri.com/it-s-time-for-a-memory-safety-intervention)</span></span>
<span id="cb23-155"><a href="#cb23-155"></a></span>
<span id="cb23-156"><a href="#cb23-156"></a></span>
<span id="cb23-157"><a href="#cb23-157"></a><span class="fu">## Onward!</span></span>
<span id="cb23-158"><a href="#cb23-158"></a></span>
<span id="cb23-159"><a href="#cb23-159"></a><span class="ss">- </span>We now enumerate the necessary steps to create a freestanding Rust binary...</span>
<span id="cb23-160"><a href="#cb23-160"></a><span class="ss">- </span>...and explains why the steps are needed.</span>
<span id="cb23-161"><a href="#cb23-161"></a></span>
<span id="cb23-162"><a href="#cb23-162"></a><span class="fu">## `no_std`</span></span>
<span id="cb23-163"><a href="#cb23-163"></a></span>
<span id="cb23-164"><a href="#cb23-164"></a><span class="ss">- </span>By default, all Rust crates link the standard library.</span>
<span id="cb23-165"><a href="#cb23-165"></a><span class="ss">    - </span>It depends on the operating system for features such as threads, files, or networking. </span>
<span id="cb23-166"><a href="#cb23-166"></a><span class="ss">    - </span>It also depends on the C standard library <span class="in">`libc`</span>, which closely interacts with OS services. </span>
<span id="cb23-167"><a href="#cb23-167"></a><span class="ss">        - </span>That is, part of GNU but not part of Linux.</span>
<span id="cb23-168"><a href="#cb23-168"></a></span>
<span id="cb23-169"><a href="#cb23-169"></a><span class="fu">## `no_std`</span></span>
<span id="cb23-170"><a href="#cb23-170"></a></span>
<span id="cb23-171"><a href="#cb23-171"></a><span class="ss">- </span>Since our plan is to write an operating system, we can't use any OS-dependent libraries. </span>
<span id="cb23-172"><a href="#cb23-172"></a><span class="ss">    - </span>That would be recursive, which is only good sometimes!</span>
<span id="cb23-173"><a href="#cb23-173"></a><span class="ss">- </span>So we have to disable the automatic inclusion of the standard library through the <span class="in">`no_std`</span> attribute.</span>
<span id="cb23-174"><a href="#cb23-174"></a><span class="ss">    - </span><span class="co">[</span><span class="ot">standard library</span><span class="co">](https://doc.rust-lang.org/std/)</span></span>
<span id="cb23-175"><a href="#cb23-175"></a><span class="ss">    - </span><span class="co">[</span><span class="ot">`no_std` attribute</span><span class="co">](https://doc.rust-lang.org/1.30.0/book/first-edition/using-rust-without-the-standard-library.html)</span></span>
<span id="cb23-176"><a href="#cb23-176"></a></span>
<span id="cb23-177"><a href="#cb23-177"></a><span class="fu">## To begin</span></span>
<span id="cb23-178"><a href="#cb23-178"></a></span>
<span id="cb23-179"><a href="#cb23-179"></a><span class="ss">- </span>We can start creation the same way we make anything else in Rust...</span>
<span id="cb23-180"><a href="#cb23-180"></a><span class="ss">- </span>*Cargo* (sighs heavily)</span>
<span id="cb23-181"><a href="#cb23-181"></a><span class="ss">- </span>We will introduce only two wrinkles.</span>
<span id="cb23-182"><a href="#cb23-182"></a><span class="ss">    - </span><span class="in">`--bin`</span>: we want to create an executable binary (in contrast to a library) </span>
<span id="cb23-183"><a href="#cb23-183"></a><span class="ss">    - </span><span class="in">`--edition 2024`</span>: to maintain consistency across years and with the working example.</span>
<span id="cb23-184"><a href="#cb23-184"></a>    </span>
<span id="cb23-185"><a href="#cb23-185"></a><span class="fu">## Invoke as</span></span>
<span id="cb23-186"><a href="#cb23-186"></a></span>
<span id="cb23-187"><a href="#cb23-187"></a><span class="in">```{.sh}</span></span>
<span id="cb23-188"><a href="#cb23-188"></a><span class="in">cargo new ???? --bin --edition 2024</span></span>
<span id="cb23-189"><a href="#cb23-189"></a><span class="in">```</span></span>
<span id="cb23-190"><a href="#cb23-190"></a></span>
<span id="cb23-191"><a href="#cb23-191"></a><span class="fu">## Example</span></span>
<span id="cb23-192"><a href="#cb23-192"></a></span>
<span id="cb23-193"><a href="#cb23-193"></a><span class="ss">- </span>Personally, I would expect you to maintain different OS versions with same crate name but within distinctly named directories (<span class="in">`32`</span>,<span class="in">`42`</span> etc.)</span>
<span id="cb23-194"><a href="#cb23-194"></a></span>
<span id="cb23-195"><a href="#cb23-195"></a><span class="in">```{.sh}</span></span>
<span id="cb23-196"><a href="#cb23-196"></a><span class="in">cargo new 32 --name osirs --vcs none --bin --edition 2024</span></span>
<span id="cb23-197"><a href="#cb23-197"></a><span class="in">```</span></span>
<span id="cb23-198"><a href="#cb23-198"></a></span>
<span id="cb23-199"><a href="#cb23-199"></a><span class="fu">## Branches</span></span>
<span id="cb23-200"><a href="#cb23-200"></a></span>
<span id="cb23-201"><a href="#cb23-201"></a><span class="ss">- </span>A competing formulation would be to use <span class="in">`git branch`</span> to create different developmental branches.</span>
<span id="cb23-202"><a href="#cb23-202"></a><span class="ss">- </span>This is the industry standard and I wanted to introduce it but felt a time crunch.</span>
<span id="cb23-203"><a href="#cb23-203"></a><span class="ss">- </span>If you are looking for something to do, figure it out.</span>
<span id="cb23-204"><a href="#cb23-204"></a><span class="ss">    - </span>Don't worry about me finding things; its worth it to me for you to learn.</span>
<span id="cb23-205"><a href="#cb23-205"></a>    </span>
<span id="cb23-206"><a href="#cb23-206"></a><span class="fu">## Name</span></span>
<span id="cb23-207"><a href="#cb23-207"></a></span>
<span id="cb23-208"><a href="#cb23-208"></a></span>
<span id="cb23-209"><a href="#cb23-209"></a>:::: {.columns}</span>
<span id="cb23-210"><a href="#cb23-210"></a></span>
<span id="cb23-211"><a href="#cb23-211"></a>::: {.column width="50%"}</span>
<span id="cb23-212"><a href="#cb23-212"></a></span>
<span id="cb23-213"><a href="#cb23-213"></a><span class="ss">- </span>You don't have to name your OS anything in particular, I just thought <span class="in">`osirs`</span> (OS in Rust) sounded heckin' rad.</span>
<span id="cb23-214"><a href="#cb23-214"></a><span class="ss">- </span><span class="co">[</span><span class="ot"> ô·¥è·¥° ·¥Ö·¥è·¥°…¥  ô·¥á“ì·¥è Ä·¥á ·¥õ ú·¥á …¢·¥è·¥Ö ·¥è“ì ·¥Ö·¥á·¥Ä·¥õ ú</span><span class="co">](https://en.wikipedia.org/wiki/Osiris)</span></span>
<span id="cb23-215"><a href="#cb23-215"></a><span class="ss">- </span>Also a cringe AI real estate firm!</span>
<span id="cb23-216"><a href="#cb23-216"></a></span>
<span id="cb23-217"><a href="#cb23-217"></a>:::</span>
<span id="cb23-218"><a href="#cb23-218"></a></span>
<span id="cb23-219"><a href="#cb23-219"></a>::: {.column width="50%"}</span>
<span id="cb23-220"><a href="#cb23-220"></a></span>
<span id="cb23-221"><a href="#cb23-221"></a></span>
<span id="cb23-222"><a href="#cb23-222"></a><span class="al">![](https://upload.wikimedia.org/wikipedia/commons/thumb/8/8b/Standing_Osiris.svg/330px-Standing_Osiris.svg.png)</span></span>
<span id="cb23-223"><a href="#cb23-223"></a></span>
<span id="cb23-224"><a href="#cb23-224"></a>:::</span>
<span id="cb23-225"><a href="#cb23-225"></a></span>
<span id="cb23-226"><a href="#cb23-226"></a>::::</span>
<span id="cb23-227"><a href="#cb23-227"></a></span>
<span id="cb23-228"><a href="#cb23-228"></a><span class="fu">## Refresh</span></span>
<span id="cb23-229"><a href="#cb23-229"></a></span>
<span id="cb23-230"><a href="#cb23-230"></a><span class="ss">- </span>When we run the command, cargo creates the following directory structure for us:</span>
<span id="cb23-231"><a href="#cb23-231"></a></span>
<span id="cb23-232"><a href="#cb23-232"></a></span>
<span id="cb23-233"><a href="#cb23-233"></a><span class="in">```{.sh}</span></span>
<span id="cb23-234"><a href="#cb23-234"></a><span class="in">$ tree</span></span>
<span id="cb23-235"><a href="#cb23-235"></a><span class="in">.</span></span>
<span id="cb23-236"><a href="#cb23-236"></a><span class="in">‚îú‚îÄ‚îÄ Cargo.toml</span></span>
<span id="cb23-237"><a href="#cb23-237"></a><span class="in">‚îî‚îÄ‚îÄ src</span></span>
<span id="cb23-238"><a href="#cb23-238"></a><span class="in">    ‚îî‚îÄ‚îÄ main.rs</span></span>
<span id="cb23-239"><a href="#cb23-239"></a></span>
<span id="cb23-240"><a href="#cb23-240"></a><span class="in">1 directory, 2 files</span></span>
<span id="cb23-241"><a href="#cb23-241"></a><span class="in">```</span></span>
<span id="cb23-242"><a href="#cb23-242"></a></span>
<span id="cb23-243"><a href="#cb23-243"></a><span class="fu">## Recall</span></span>
<span id="cb23-244"><a href="#cb23-244"></a></span>
<span id="cb23-245"><a href="#cb23-245"></a><span class="ss">- </span><span class="in">`Cargo.toml`</span> contains the crate configuration</span>
<span id="cb23-246"><a href="#cb23-246"></a><span class="ss">    - </span>Crate name</span>
<span id="cb23-247"><a href="#cb23-247"></a><span class="ss">    - </span>Crate author</span>
<span id="cb23-248"><a href="#cb23-248"></a><span class="ss">    - </span>Crate version</span>
<span id="cb23-249"><a href="#cb23-249"></a><span class="ss">- </span><span class="in">`src/main.rs`</span> file contains our <span class="in">`main`</span> function. </span>
<span id="cb23-250"><a href="#cb23-250"></a><span class="ss">- </span>After <span class="in">`cargo build`</span>, find the compiled <span class="in">`osirs`</span> binary in the <span class="in">`target/debug`</span> subfolder.</span>
<span id="cb23-251"><a href="#cb23-251"></a></span>
<span id="cb23-252"><a href="#cb23-252"></a><span class="fu">## Blah blah blah</span></span>
<span id="cb23-253"><a href="#cb23-253"></a></span>
<span id="cb23-254"><a href="#cb23-254"></a><span class="in">```{.sh}</span></span>
<span id="cb23-255"><a href="#cb23-255"></a><span class="in">$ cargo build ; tree</span></span>
<span id="cb23-256"><a href="#cb23-256"></a><span class="in">   Compiling osirs v0.1.0 (/home/user/tmp/32)</span></span>
<span id="cb23-257"><a href="#cb23-257"></a><span class="in">    Finished `dev` profile [unoptimized + debuginfo] target(s) in 0.54s</span></span>
<span id="cb23-258"><a href="#cb23-258"></a><span class="in">.</span></span>
<span id="cb23-259"><a href="#cb23-259"></a><span class="in">‚îú‚îÄ‚îÄ Cargo.lock</span></span>
<span id="cb23-260"><a href="#cb23-260"></a><span class="in">‚îú‚îÄ‚îÄ Cargo.toml</span></span>
<span id="cb23-261"><a href="#cb23-261"></a><span class="in">‚îú‚îÄ‚îÄ src</span></span>
<span id="cb23-262"><a href="#cb23-262"></a><span class="in">‚îÇ&nbsp;&nbsp; ‚îî‚îÄ‚îÄ main.rs</span></span>
<span id="cb23-263"><a href="#cb23-263"></a><span class="in">‚îî‚îÄ‚îÄ target</span></span>
<span id="cb23-264"><a href="#cb23-264"></a><span class="in">    ‚îú‚îÄ‚îÄ CACHEDIR.TAG</span></span>
<span id="cb23-265"><a href="#cb23-265"></a><span class="in">    ‚îî‚îÄ‚îÄ debug</span></span>
<span id="cb23-266"><a href="#cb23-266"></a><span class="in">        ‚îú‚îÄ‚îÄ build</span></span>
<span id="cb23-267"><a href="#cb23-267"></a><span class="in">        ‚îú‚îÄ‚îÄ deps</span></span>
<span id="cb23-268"><a href="#cb23-268"></a><span class="in">        ‚îÇ&nbsp;&nbsp; ‚îú‚îÄ‚îÄ osirs-43412975b38d059d</span></span>
<span id="cb23-269"><a href="#cb23-269"></a><span class="in">        ‚îÇ&nbsp;&nbsp; ‚îî‚îÄ‚îÄ osirs-43412975b38d059d.d</span></span>
<span id="cb23-270"><a href="#cb23-270"></a><span class="in">        ‚îú‚îÄ‚îÄ examples</span></span>
<span id="cb23-271"><a href="#cb23-271"></a><span class="in">        ‚îú‚îÄ‚îÄ incremental</span></span>
<span id="cb23-272"><a href="#cb23-272"></a><span class="in">        ‚îÇ&nbsp;&nbsp; ‚îî‚îÄ‚îÄ osirs-3gae52yq1943v</span></span>
<span id="cb23-273"><a href="#cb23-273"></a><span class="in">        ‚îÇ&nbsp;&nbsp;     ‚îú‚îÄ‚îÄ s-hfeunnoewq-0c8luu5-5dmhke08rl6h5l09ku3va3gkx</span></span>
<span id="cb23-274"><a href="#cb23-274"></a><span class="in">        ‚îÇ&nbsp;&nbsp;     ‚îÇ&nbsp;&nbsp; ‚îú‚îÄ‚îÄ 1tq3ts5gahvv7j1hzrmfdrzi6.o</span></span>
<span id="cb23-275"><a href="#cb23-275"></a><span class="in">        ‚îÇ&nbsp;&nbsp;     ‚îÇ&nbsp;&nbsp; ‚îú‚îÄ‚îÄ 6zk3flo890c0qhh6fykb6746g.o</span></span>
<span id="cb23-276"><a href="#cb23-276"></a><span class="in">        ‚îÇ&nbsp;&nbsp;     ‚îÇ&nbsp;&nbsp; ‚îú‚îÄ‚îÄ 8z45o15v3gxm5hydv3o63x07l.o</span></span>
<span id="cb23-277"><a href="#cb23-277"></a><span class="in">        ‚îÇ&nbsp;&nbsp;     ‚îÇ&nbsp;&nbsp; ‚îú‚îÄ‚îÄ 9itjtn00r7d8c6mknmav20oex.o</span></span>
<span id="cb23-278"><a href="#cb23-278"></a><span class="in">        ‚îÇ&nbsp;&nbsp;     ‚îÇ&nbsp;&nbsp; ‚îú‚îÄ‚îÄ bh9pj42wzikjd1ilqutnjbrx7.o</span></span>
<span id="cb23-279"><a href="#cb23-279"></a><span class="in">        ‚îÇ&nbsp;&nbsp;     ‚îÇ&nbsp;&nbsp; ‚îú‚îÄ‚îÄ dep-graph.bin</span></span>
<span id="cb23-280"><a href="#cb23-280"></a><span class="in">        ‚îÇ&nbsp;&nbsp;     ‚îÇ&nbsp;&nbsp; ‚îú‚îÄ‚îÄ eymyqxruzdb24suchgzd8ygxb.o</span></span>
<span id="cb23-281"><a href="#cb23-281"></a><span class="in">        ‚îÇ&nbsp;&nbsp;     ‚îÇ&nbsp;&nbsp; ‚îú‚îÄ‚îÄ query-cache.bin</span></span>
<span id="cb23-282"><a href="#cb23-282"></a><span class="in">        ‚îÇ&nbsp;&nbsp;     ‚îÇ&nbsp;&nbsp; ‚îî‚îÄ‚îÄ work-products.bin</span></span>
<span id="cb23-283"><a href="#cb23-283"></a><span class="in">        ‚îÇ&nbsp;&nbsp;     ‚îî‚îÄ‚îÄ s-hfeunnoewq-0c8luu5.lock</span></span>
<span id="cb23-284"><a href="#cb23-284"></a><span class="in">        ‚îú‚îÄ‚îÄ osirs</span></span>
<span id="cb23-285"><a href="#cb23-285"></a><span class="in">        ‚îî‚îÄ‚îÄ osirs.d</span></span>
<span id="cb23-286"><a href="#cb23-286"></a></span>
<span id="cb23-287"><a href="#cb23-287"></a><span class="in">9 directories, 18 files</span></span>
<span id="cb23-288"><a href="#cb23-288"></a><span class="in">```</span></span>
<span id="cb23-289"><a href="#cb23-289"></a></span>
<span id="cb23-290"><a href="#cb23-290"></a><span class="fu">## Running</span></span>
<span id="cb23-291"><a href="#cb23-291"></a></span>
<span id="cb23-292"><a href="#cb23-292"></a><span class="ss">- </span>Technically no one can stop you from using <span class="in">`cargo run`</span> or even <span class="in">`cargo run --release`</span></span>
<span id="cb23-293"><a href="#cb23-293"></a><span class="ss">- </span>But you can also just <span class="in">`build`</span> and then *directly* run the executable.</span>
<span id="cb23-294"><a href="#cb23-294"></a></span>
<span id="cb23-295"><a href="#cb23-295"></a><span class="in">```{.sh}</span></span>
<span id="cb23-296"><a href="#cb23-296"></a><span class="in">$ ./target/debug/osirs</span></span>
<span id="cb23-297"><a href="#cb23-297"></a><span class="in">Hello, world!</span></span>
<span id="cb23-298"><a href="#cb23-298"></a><span class="in">```</span></span>
<span id="cb23-299"><a href="#cb23-299"></a></span>
<span id="cb23-300"><a href="#cb23-300"></a><span class="fu">## The `no_std` Attribute</span></span>
<span id="cb23-301"><a href="#cb23-301"></a></span>
<span id="cb23-302"><a href="#cb23-302"></a><span class="ss">- </span>Initially, the crate implicitly links the standard library. </span>
<span id="cb23-303"><a href="#cb23-303"></a><span class="ss">- </span>We can prepend the <span class="in">`no_std`</span> attribute to <span class="in">`src/main.rs`</span> to get the version of Rust that builds character!</span>
<span id="cb23-304"><a href="#cb23-304"></a></span>
<span id="cb23-305"><a href="#cb23-305"></a><span class="in">```{.rs filename="src/main.rs"}</span></span>
<span id="cb23-306"><a href="#cb23-306"></a><span class="in">// main.rs</span></span>
<span id="cb23-307"><a href="#cb23-307"></a></span>
<span id="cb23-308"><a href="#cb23-308"></a><span class="in">#![no_std]</span></span>
<span id="cb23-309"><a href="#cb23-309"></a></span>
<span id="cb23-310"><a href="#cb23-310"></a><span class="in">fn main() {</span></span>
<span id="cb23-311"><a href="#cb23-311"></a><span class="in">    println!(" ô·¥è·¥° ·¥Ö·¥è·¥°…¥  ô·¥á“ì·¥è Ä·¥á ·¥õ ú·¥á …¢·¥è·¥Ö ·¥è“ì ·¥Ö·¥á·¥Ä·¥õ ú");</span></span>
<span id="cb23-312"><a href="#cb23-312"></a><span class="in">}</span></span>
<span id="cb23-313"><a href="#cb23-313"></a><span class="in">```</span></span>
<span id="cb23-314"><a href="#cb23-314"></a></span>
<span id="cb23-315"><a href="#cb23-315"></a><span class="fu">## We Can Rebuild</span></span>
<span id="cb23-316"><a href="#cb23-316"></a></span>
<span id="cb23-317"><a href="#cb23-317"></a><span class="ss">- </span>Actually we can't.</span>
<span id="cb23-318"><a href="#cb23-318"></a></span>
<span id="cb23-319"><a href="#cb23-319"></a><span class="in">```{.sh}</span></span>
<span id="cb23-320"><a href="#cb23-320"></a><span class="in">$ cargo build</span></span>
<span id="cb23-321"><a href="#cb23-321"></a><span class="in">   Compiling osirs v0.1.0 (/home/user/tmp/32)</span></span>
<span id="cb23-322"><a href="#cb23-322"></a><span class="in">error: cannot find macro `println` in this scope</span></span>
<span id="cb23-323"><a href="#cb23-323"></a><span class="in"> --&gt; src/main.rs:6:5</span></span>
<span id="cb23-324"><a href="#cb23-324"></a><span class="in">  |</span></span>
<span id="cb23-325"><a href="#cb23-325"></a><span class="in">6 |     println!(" ô·¥è·¥° ·¥Ö·¥è·¥°…¥  ô·¥á“ì·¥è Ä·¥á ·¥õ ú·¥á …¢·¥è·¥Ö ·¥è“ì ·¥Ö·¥á·¥Ä·¥õ ú");</span></span>
<span id="cb23-326"><a href="#cb23-326"></a><span class="in">  |     ^^^^^^^</span></span>
<span id="cb23-327"><a href="#cb23-327"></a></span>
<span id="cb23-328"><a href="#cb23-328"></a><span class="in">error: `#[panic_handler]` function required, but not found</span></span>
<span id="cb23-329"><a href="#cb23-329"></a></span>
<span id="cb23-330"><a href="#cb23-330"></a><span class="in">error: unwinding panics are not supported without std</span></span>
<span id="cb23-331"><a href="#cb23-331"></a><span class="in">  |</span></span>
<span id="cb23-332"><a href="#cb23-332"></a><span class="in">  = help: using nightly cargo, use -Zbuild-std with panic="abort" to avoid unwinding</span></span>
<span id="cb23-333"><a href="#cb23-333"></a><span class="in">  = note: since the core library is usually precompiled with panic="unwind", rebuilding your crate with panic="abort" may not be enough to fix the problem</span></span>
<span id="cb23-334"><a href="#cb23-334"></a></span>
<span id="cb23-335"><a href="#cb23-335"></a><span class="in">error: could not compile `osirs` (bin "osirs") due to 3 previous errors    ^^^^^^^</span></span>
<span id="cb23-336"><a href="#cb23-336"></a><span class="in">```</span></span>
<span id="cb23-337"><a href="#cb23-337"></a></span>
<span id="cb23-338"><a href="#cb23-338"></a><span class="fu">## Enhance!</span></span>
<span id="cb23-339"><a href="#cb23-339"></a></span>
<span id="cb23-340"><a href="#cb23-340"></a><span class="in">```{.sh}</span></span>
<span id="cb23-341"><a href="#cb23-341"></a><span class="in">error: cannot find macro `println` in this scope</span></span>
<span id="cb23-342"><a href="#cb23-342"></a><span class="in"> --&gt; src/main.rs:6:5</span></span>
<span id="cb23-343"><a href="#cb23-343"></a><span class="in">  |</span></span>
<span id="cb23-344"><a href="#cb23-344"></a><span class="in">6 |     println!(" ô·¥è·¥° ·¥Ö·¥è·¥°…¥  ô·¥á“ì·¥è Ä·¥á ·¥õ ú·¥á …¢·¥è·¥Ö ·¥è“ì ·¥Ö·¥á·¥Ä·¥õ ú");</span></span>
<span id="cb23-345"><a href="#cb23-345"></a><span class="in">  |     ^^^^^^^</span></span>
<span id="cb23-346"><a href="#cb23-346"></a><span class="in">```</span></span>
<span id="cb23-347"><a href="#cb23-347"></a></span>
<span id="cb23-348"><a href="#cb23-348"></a><span class="ss">- </span>Oh right, we can't print without an OS.</span>
<span id="cb23-349"><a href="#cb23-349"></a></span>
<span id="cb23-350"><a href="#cb23-350"></a><span class="fu">## Background</span></span>
<span id="cb23-351"><a href="#cb23-351"></a></span>
<span id="cb23-352"><a href="#cb23-352"></a><span class="ss">- </span>The <span class="in">`println`</span> macro is part of the standard library <span class="in">`std`</span>.</span>
<span id="cb23-353"><a href="#cb23-353"></a><span class="ss">- </span>We said <span class="in">`no_std`</span>.</span>
<span id="cb23-354"><a href="#cb23-354"></a><span class="ss">- </span>So we can no longer print things.</span>
<span id="cb23-355"><a href="#cb23-355"></a><span class="ss">- </span>I hope it is clear how this is character-building!</span>
<span id="cb23-356"><a href="#cb23-356"></a><span class="ss">- </span>Read more:</span>
<span id="cb23-357"><a href="#cb23-357"></a><span class="ss">    - </span><span class="co">[</span><span class="ot">`println` macro</span><span class="co">](https://doc.rust-lang.org/std/macro.println.html)</span></span>
<span id="cb23-358"><a href="#cb23-358"></a><span class="ss">    - </span><span class="co">[</span><span class="ot">standard output</span><span class="co">](https://en.wikipedia.org/wiki/Standard_streams#Standard_output_.28stdout.29)</span></span>
<span id="cb23-359"><a href="#cb23-359"></a></span>
<span id="cb23-360"><a href="#cb23-360"></a><span class="fu">## Rip it</span></span>
<span id="cb23-361"><a href="#cb23-361"></a></span>
<span id="cb23-362"><a href="#cb23-362"></a><span class="ss">- </span>Remove the printing and try again:</span>
<span id="cb23-363"><a href="#cb23-363"></a></span>
<span id="cb23-364"><a href="#cb23-364"></a><span class="in">```{.rs filename="src/main.rs"}</span></span>
<span id="cb23-365"><a href="#cb23-365"></a><span class="in">// main.rs</span></span>
<span id="cb23-366"><a href="#cb23-366"></a></span>
<span id="cb23-367"><a href="#cb23-367"></a><span class="in">#![no_std]</span></span>
<span id="cb23-368"><a href="#cb23-368"></a></span>
<span id="cb23-369"><a href="#cb23-369"></a><span class="in">fn main() {</span></span>
<span id="cb23-370"><a href="#cb23-370"></a><span class="in">    // println!(" ô·¥è·¥° ·¥Ö·¥è·¥°…¥  ô·¥á“ì·¥è Ä·¥á ·¥õ ú·¥á …¢·¥è·¥Ö ·¥è“ì ·¥Ö·¥á·¥Ä·¥õ ú");</span></span>
<span id="cb23-371"><a href="#cb23-371"></a><span class="in">}</span></span>
<span id="cb23-372"><a href="#cb23-372"></a><span class="in">```</span></span>
<span id="cb23-373"><a href="#cb23-373"></a></span>
<span id="cb23-374"><a href="#cb23-374"></a><span class="fu">## Problems remain</span></span>
<span id="cb23-375"><a href="#cb23-375"></a></span>
<span id="cb23-376"><a href="#cb23-376"></a><span class="in">```{.sh}</span></span>
<span id="cb23-377"><a href="#cb23-377"></a><span class="in">$ cargo build</span></span>
<span id="cb23-378"><a href="#cb23-378"></a><span class="in">   Compiling osirs v0.1.0 (/home/user/tmp/32)</span></span>
<span id="cb23-379"><a href="#cb23-379"></a><span class="in">error: `#[panic_handler]` function required, but not found</span></span>
<span id="cb23-380"><a href="#cb23-380"></a></span>
<span id="cb23-381"><a href="#cb23-381"></a><span class="in">error: unwinding panics are not supported without std</span></span>
<span id="cb23-382"><a href="#cb23-382"></a><span class="in">  |</span></span>
<span id="cb23-383"><a href="#cb23-383"></a><span class="in">  = help: using nightly cargo, use -Zbuild-std with panic="abort" to avoid unwinding</span></span>
<span id="cb23-384"><a href="#cb23-384"></a><span class="in">  = note: since the core library is usually precompiled with panic="unwind", rebuilding your crate with panic="abort" may not be enough to fix the problem</span></span>
<span id="cb23-385"><a href="#cb23-385"></a></span>
<span id="cb23-386"><a href="#cb23-386"></a><span class="in">error: could not compile `osirs` (bin "osirs") due to 2 previous errors</span></span>
<span id="cb23-387"><a href="#cb23-387"></a><span class="in">```</span></span>
<span id="cb23-388"><a href="#cb23-388"></a></span>
<span id="cb23-389"><a href="#cb23-389"></a><span class="fu">## Enhance!</span></span>
<span id="cb23-390"><a href="#cb23-390"></a></span>
<span id="cb23-391"><a href="#cb23-391"></a><span class="in">```{.sh}</span></span>
<span id="cb23-392"><a href="#cb23-392"></a><span class="in">error: cannot find macro `println` in this scope</span></span>
<span id="cb23-393"><a href="#cb23-393"></a><span class="in"> --&gt; src/main.rs:6:5</span></span>
<span id="cb23-394"><a href="#cb23-394"></a><span class="in">  |</span></span>
<span id="cb23-395"><a href="#cb23-395"></a><span class="in">6 |     println!(" ô·¥è·¥° ·¥Ö·¥è·¥°…¥  ô·¥á“ì·¥è Ä·¥á ·¥õ ú·¥á …¢·¥è·¥Ö ·¥è“ì ·¥Ö·¥á·¥Ä·¥õ ú");</span></span>
<span id="cb23-396"><a href="#cb23-396"></a><span class="in">  |     ^^^^^^^</span></span>
<span id="cb23-397"><a href="#cb23-397"></a><span class="in">```</span></span>
<span id="cb23-398"><a href="#cb23-398"></a></span>
<span id="cb23-399"><a href="#cb23-399"></a><span class="ss">- </span>Sometimes, Rust explodes and calls the OS (written in C!) for help.</span>
<span id="cb23-400"><a href="#cb23-400"></a><span class="ss">- </span>It can't do that without <span class="in">`std`</span> and is sad üò≠</span>
<span id="cb23-401"><a href="#cb23-401"></a></span>
<span id="cb23-402"><a href="#cb23-402"></a></span>
<span id="cb23-403"><a href="#cb23-403"></a><span class="fu">## Panic</span></span>
<span id="cb23-404"><a href="#cb23-404"></a></span>
<span id="cb23-405"><a href="#cb23-405"></a><span class="ss">- </span>The <span class="in">`panic_handler`</span> attribute defines the function that the compiler should invoke when a panic occurs. </span>
<span id="cb23-406"><a href="#cb23-406"></a><span class="ss">- </span><span class="in">`std`</span> provides its own panic handler function, but in a <span class="in">`no_std`</span> environment we need to define it ourselves:</span>
<span id="cb23-407"><a href="#cb23-407"></a><span class="ss">- </span><span class="co">[</span><span class="ot">panic</span><span class="co">](https://doc.rust-lang.org/stable/book/ch09-01-unrecoverable-errors-with-panic.html)</span></span>
<span id="cb23-408"><a href="#cb23-408"></a></span>
<span id="cb23-409"><a href="#cb23-409"></a><span class="fu">## Our Approach</span></span>
<span id="cb23-410"><a href="#cb23-410"></a></span>
<span id="cb23-411"><a href="#cb23-411"></a><span class="in">```{.rs filename="src/main.rs"}</span></span>
<span id="cb23-412"><a href="#cb23-412"></a><span class="in">// main.rs</span></span>
<span id="cb23-413"><a href="#cb23-413"></a></span>
<span id="cb23-414"><a href="#cb23-414"></a><span class="in">/// This function is called on panic.</span></span>
<span id="cb23-415"><a href="#cb23-415"></a><span class="in">#[panic_handler]</span></span>
<span id="cb23-416"><a href="#cb23-416"></a><span class="in">fn panic(_info: &amp;core::panic::PanicInfo) -&gt; ! {</span></span>
<span id="cb23-417"><a href="#cb23-417"></a><span class="in">    loop {}</span></span>
<span id="cb23-418"><a href="#cb23-418"></a><span class="in">}</span></span>
<span id="cb23-419"><a href="#cb23-419"></a><span class="in">```</span></span>
<span id="cb23-420"><a href="#cb23-420"></a></span>
<span id="cb23-421"><a href="#cb23-421"></a><span class="fu">## Panics</span></span>
<span id="cb23-422"><a href="#cb23-422"></a></span>
<span id="cb23-423"><a href="#cb23-423"></a><span class="ss">- </span>The <span class="in">`PanicInfo`</span> parameter contains:</span>
<span id="cb23-424"><a href="#cb23-424"></a><span class="ss">    - </span>*file* and *line* where the panic happened</span>
<span id="cb23-425"><a href="#cb23-425"></a><span class="ss">    - </span>panic message (e.g. <span class="in">`panic!("YOLO")`</span></span>
<span id="cb23-426"><a href="#cb23-426"></a><span class="ss">- </span>The function should never return.</span>
<span id="cb23-427"><a href="#cb23-427"></a><span class="ss">    - </span>So it is marked as a "diverging function" </span>
<span id="cb23-428"><a href="#cb23-428"></a><span class="ss">    - </span>It returns the ‚Äúnever‚Äù type <span class="in">`!`</span>. </span>
<span id="cb23-429"><a href="#cb23-429"></a><span class="ss">- </span>Not much we can do in this function for now, so just <span class="in">`loop()`</span> to prevent a return.</span>
<span id="cb23-430"><a href="#cb23-430"></a></span>
<span id="cb23-431"><a href="#cb23-431"></a><span class="fu">## Read more...</span></span>
<span id="cb23-432"><a href="#cb23-432"></a></span>
<span id="cb23-433"><a href="#cb23-433"></a><span class="ss">- </span>I had never heard of or used these but to me it was clear why they would have to exist in a type safe language.</span>
<span id="cb23-434"><a href="#cb23-434"></a><span class="ss">    - </span><span class="co">[</span><span class="ot">PanicInfo</span><span class="co">](https://doc.rust-lang.org/nightly/core/panic/struct.PanicInfo.html)</span></span>
<span id="cb23-435"><a href="#cb23-435"></a><span class="ss">    - </span><span class="co">[</span><span class="ot">diverging function</span><span class="co">](https://doc.rust-lang.org/1.30.0/book/first-edition/functions.html#diverging-functions)</span></span>
<span id="cb23-436"><a href="#cb23-436"></a><span class="ss">    - </span><span class="co">[</span><span class="ot">‚Äúnever‚Äù type</span><span class="co">](https://doc.rust-lang.org/nightly/std/primitive.never.html)</span></span>
<span id="cb23-437"><a href="#cb23-437"></a></span>
<span id="cb23-438"><a href="#cb23-438"></a><span class="co">&lt;!--</span></span>
<span id="cb23-439"><a href="#cb23-439"></a></span>
<span id="cb23-440"><a href="#cb23-440"></a><span class="co">## The `eh_personality` Language Item</span></span>
<span id="cb23-441"><a href="#cb23-441"></a></span>
<span id="cb23-442"><a href="#cb23-442"></a><span class="co">Language items are special functions and types that are required internally by the compiler. For example, the [`Copy`] trait is a language item that tells the compiler which types have [_copy semantics_][`Copy`]. When we look at the [implementation][copy code], we see it has the special `#[lang = "copy"]` attribute that defines it as a language item.</span></span>
<span id="cb23-443"><a href="#cb23-443"></a></span>
<span id="cb23-444"><a href="#cb23-444"></a><span class="co">[`Copy`]: https://doc.rust-lang.org/nightly/core/marker/trait.Copy.html</span></span>
<span id="cb23-445"><a href="#cb23-445"></a><span class="co">[copy code]: https://github.com/rust-lang/rust/blob/485397e49a02a3b7ff77c17e4a3f16c653925cb3/src/libcore/marker.rs#L296-L299</span></span>
<span id="cb23-446"><a href="#cb23-446"></a></span>
<span id="cb23-447"><a href="#cb23-447"></a><span class="co">While providing custom implementations of language items is possible, it should only be done as a last resort. The reason is that language items are highly unstable implementation details and not even type checked (so the compiler doesn't even check if a function has the right argument types). Fortunately, there is a more stable way to fix the above language item error.</span></span>
<span id="cb23-448"><a href="#cb23-448"></a></span>
<span id="cb23-449"><a href="#cb23-449"></a><span class="co">The [`eh_personality` language item] marks a function that is used for implementing [stack unwinding]. By default, Rust uses unwinding to run the destructors of all live stack variables in case of a [panic]. This ensures that all used memory is freed and allows the parent thread to catch the panic and continue execution. Unwinding, however, is a complicated process and requires some OS-specific libraries (e.g. [libunwind] on Linux or [structured exception handling] on Windows), so we don't want to use it for our operating system.</span></span>
<span id="cb23-450"><a href="#cb23-450"></a></span>
<span id="cb23-451"><a href="#cb23-451"></a><span class="co">[`eh_personality` language item]: https://github.com/rust-lang/rust/blob/edb368491551a77d77a48446d4ee88b35490c565/src/libpanic_unwind/gcc.rs#L11-L45</span></span>
<span id="cb23-452"><a href="#cb23-452"></a><span class="co">[stack unwinding]: https://www.bogotobogo.com/cplusplus/stackunwinding.php</span></span>
<span id="cb23-453"><a href="#cb23-453"></a><span class="co">[libunwind]: https://www.nongnu.org/libunwind/</span></span>
<span id="cb23-454"><a href="#cb23-454"></a><span class="co">[structured exception handling]: https://docs.microsoft.com/en-us/windows/win32/debug/structured-exception-handling</span></span>
<span id="cb23-455"><a href="#cb23-455"></a></span>
<span id="cb23-456"><a href="#cb23-456"></a><span class="co">--&gt;</span></span>
<span id="cb23-457"><a href="#cb23-457"></a></span>
<span id="cb23-458"><a href="#cb23-458"></a><span class="fu">## Retry</span></span>
<span id="cb23-459"><a href="#cb23-459"></a></span>
<span id="cb23-460"><a href="#cb23-460"></a><span class="ss">- </span>I bet it works now!</span>
<span id="cb23-461"><a href="#cb23-461"></a></span>
<span id="cb23-462"><a href="#cb23-462"></a><span class="in">```{.sh}</span></span>
<span id="cb23-463"><a href="#cb23-463"></a><span class="in">$ cargo build</span></span>
<span id="cb23-464"><a href="#cb23-464"></a><span class="in">   Compiling osirs v0.1.0 (/home/user/tmp/32)</span></span>
<span id="cb23-465"><a href="#cb23-465"></a><span class="in">error: unwinding panics are not supported without std</span></span>
<span id="cb23-466"><a href="#cb23-466"></a><span class="in">  |</span></span>
<span id="cb23-467"><a href="#cb23-467"></a><span class="in">  = help: using nightly cargo, use -Zbuild-std with panic="abort" to avoid unwinding</span></span>
<span id="cb23-468"><a href="#cb23-468"></a><span class="in">  = note: since the core library is usually precompiled with panic="unwind", rebuilding your crate with panic="abort" may not be enough to fix the problem</span></span>
<span id="cb23-469"><a href="#cb23-469"></a></span>
<span id="cb23-470"><a href="#cb23-470"></a><span class="in">error: could not compile `osirs` (bin "osirs") due to 1 previous error</span></span>
<span id="cb23-471"><a href="#cb23-471"></a><span class="in">```</span></span>
<span id="cb23-472"><a href="#cb23-472"></a></span>
<span id="cb23-473"><a href="#cb23-473"></a><span class="ss">- </span>They should make a version of the OS class that is easy.</span>
<span id="cb23-474"><a href="#cb23-474"></a><span class="ss">    - </span>(They did - this class)</span>
<span id="cb23-475"><a href="#cb23-475"></a></span>
<span id="cb23-476"><a href="#cb23-476"></a><span class="fu">## Panic abort</span></span>
<span id="cb23-477"><a href="#cb23-477"></a></span>
<span id="cb23-478"><a href="#cb23-478"></a>:::: {.columns}</span>
<span id="cb23-479"><a href="#cb23-479"></a></span>
<span id="cb23-480"><a href="#cb23-480"></a>::: {.column width="50%"}</span>
<span id="cb23-481"><a href="#cb23-481"></a></span>
<span id="cb23-482"><a href="#cb23-482"></a><span class="ss">- </span>Fun fact - back when I was an OS engineer slash rocket scientist my first launch was <span class="co">[</span><span class="ot">"PA-1" for "Pad Abort 1"</span><span class="co">](https://en.wikipedia.org/wiki/Pad_Abort-1)</span></span>
<span id="cb23-483"><a href="#cb23-483"></a><span class="ss">    - </span>Blew up a rocket on the launch pad to make sure it was safe for humans.</span>
<span id="cb23-484"><a href="#cb23-484"></a></span>
<span id="cb23-485"><a href="#cb23-485"></a>:::</span>
<span id="cb23-486"><a href="#cb23-486"></a></span>
<span id="cb23-487"><a href="#cb23-487"></a>::: {.column width="50%"}</span>
<span id="cb23-488"><a href="#cb23-488"></a></span>
<span id="cb23-489"><a href="#cb23-489"></a></span>
<span id="cb23-490"><a href="#cb23-490"></a><span class="al">![](https://upload.wikimedia.org/wikipedia/commons/thumb/d/d6/450775main_wstf0510e04493_hires.jpg/330px-450775main_wstf0510e04493_hires.jpg)</span></span>
<span id="cb23-491"><a href="#cb23-491"></a></span>
<span id="cb23-492"><a href="#cb23-492"></a>:::</span>
<span id="cb23-493"><a href="#cb23-493"></a></span>
<span id="cb23-494"><a href="#cb23-494"></a>::::</span>
<span id="cb23-495"><a href="#cb23-495"></a>    </span>
<span id="cb23-496"><a href="#cb23-496"></a><span class="fu">## Panic abort</span></span>
<span id="cb23-497"><a href="#cb23-497"></a></span>
<span id="cb23-498"><a href="#cb23-498"></a><span class="ss">- </span>The use of the term "abort" which in some nation-states is a hot-button political issue has come up from time-to-time in the discourse.</span>
<span id="cb23-499"><a href="#cb23-499"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Read more from 2018</span><span class="co">](https://www.theregister.com/2018/05/09/gnu_glic_abort_stallman/)</span></span>
<span id="cb23-500"><a href="#cb23-500"></a></span>
<span id="cb23-501"><a href="#cb23-501"></a><span class="in">```email</span></span>
<span id="cb23-502"><a href="#cb23-502"></a></span>
<span id="cb23-503"><a href="#cb23-503"></a>25.7.4 Aborting a Program</span>
<span id="cb23-504"><a href="#cb23-504"></a></span>
<span id="cb23-505"><a href="#cb23-505"></a>...</span>
<span id="cb23-506"><a href="#cb23-506"></a></span>
<span id="cb23-507"><a href="#cb23-507"></a>Future Change Warning: Proposed Federal censorship regulations may prohibit us from giving you information about the possibility of calling this function. We would be required to say that this is not an acceptable way of terminating a program.</span>
<span id="cb23-508"><a href="#cb23-508"></a></span>
<span id="cb23-509"><a href="#cb23-509"></a><span class="in">```</span></span>
<span id="cb23-510"><a href="#cb23-510"></a></span>
<span id="cb23-511"><a href="#cb23-511"></a><span class="fu">## Quoth Stallman</span></span>
<span id="cb23-512"><a href="#cb23-512"></a></span>
<span id="cb23-513"><a href="#cb23-513"></a><span class="at">&gt; "The point of this joke is even more important now than it was when I first wrote it," </span><span class="co">[</span><span class="ot">Free Software Foundation president</span><span class="co">]</span><span class="at"> Stallman wrote in a note posted to project mailing list, in reference to today's political climate. "Please do not remove it. GNU is not a purely technical project, so the fact that this is not strictly and grimly technical is not a reason to remove this."</span></span>
<span id="cb23-514"><a href="#cb23-514"></a></span>
<span id="cb23-515"><a href="#cb23-515"></a><span class="fu">## Now in Rust</span></span>
<span id="cb23-516"><a href="#cb23-516"></a></span>
<span id="cb23-517"><a href="#cb23-517"></a><span class="ss">- </span>We can oppose fascism *and* </span>
<span id="cb23-518"><a href="#cb23-518"></a><span class="ss">    - </span>(looks into the history of NASA and Lockheed Martin)</span>
<span id="cb23-519"><a href="#cb23-519"></a><span class="ss">    - </span>(clears throat)</span>
<span id="cb23-520"><a href="#cb23-520"></a><span class="ss">    - </span>Moving on!    </span>
<span id="cb23-521"><a href="#cb23-521"></a><span class="ss">- </span>We can abort programs... *in Rust*</span>
<span id="cb23-522"><a href="#cb23-522"></a></span>
<span id="cb23-523"><a href="#cb23-523"></a><span class="fu">## How?</span></span>
<span id="cb23-524"><a href="#cb23-524"></a></span>
<span id="cb23-525"><a href="#cb23-525"></a><span class="ss">- </span>Read carefully:</span>
<span id="cb23-526"><a href="#cb23-526"></a></span>
<span id="cb23-527"><a href="#cb23-527"></a><span class="in">```{.sh}</span></span>
<span id="cb23-528"><a href="#cb23-528"></a><span class="in">= help: using nightly cargo, use -Zbuild-std with panic="abort" to avoid unwinding</span></span>
<span id="cb23-529"><a href="#cb23-529"></a><span class="in">= note: since the core library is usually precompiled with panic="unwind", rebuilding your crate with panic="abort" may not be enough to fix the problem</span></span>
<span id="cb23-530"><a href="#cb23-530"></a><span class="in">```</span></span>
<span id="cb23-531"><a href="#cb23-531"></a></span>
<span id="cb23-532"><a href="#cb23-532"></a><span class="ss">- </span>Geniuses will recognize <span class="in">`panic="abort"`</span> syntax</span>
<span id="cb23-533"><a href="#cb23-533"></a></span>
<span id="cb23-534"><a href="#cb23-534"></a><span class="fu">## TOML</span></span>
<span id="cb23-535"><a href="#cb23-535"></a></span>
<span id="cb23-536"><a href="#cb23-536"></a><span class="ss">- </span>It's <span class="in">`.toml`</span></span>
<span id="cb23-537"><a href="#cb23-537"></a></span>
<span id="cb23-538"><a href="#cb23-538"></a><span class="in">```{.toml filename="Cargo.toml"}</span></span>
<span id="cb23-539"><a href="#cb23-539"></a><span class="in">[package]</span></span>
<span id="cb23-540"><a href="#cb23-540"></a><span class="in">name = "osirs"</span></span>
<span id="cb23-541"><a href="#cb23-541"></a><span class="in">version = "0.1.0"</span></span>
<span id="cb23-542"><a href="#cb23-542"></a><span class="in">edition = "2024"</span></span>
<span id="cb23-543"><a href="#cb23-543"></a></span>
<span id="cb23-544"><a href="#cb23-544"></a><span class="in">[dependencies]</span></span>
<span id="cb23-545"><a href="#cb23-545"></a><span class="in">```</span></span>
<span id="cb23-546"><a href="#cb23-546"></a></span>
<span id="cb23-547"><a href="#cb23-547"></a><span class="fu">## Crate options</span></span>
<span id="cb23-548"><a href="#cb23-548"></a></span>
<span id="cb23-549"><a href="#cb23-549"></a><span class="ss">- </span>Nominally there are use cases for which unwinding is undesirable</span>
<span id="cb23-550"><a href="#cb23-550"></a><span class="ss">    - </span>My take: All cases.</span>
<span id="cb23-551"><a href="#cb23-551"></a><span class="ss">- </span>So Rust provides an option to "abort on panic" instead. </span>
<span id="cb23-552"><a href="#cb23-552"></a><span class="ss">- </span>This disables the generation of unwinding symbol information and thus considerably reduces binary size. </span>
<span id="cb23-553"><a href="#cb23-553"></a><span class="ss">    - </span>This seems obviously good to me.</span>
<span id="cb23-554"><a href="#cb23-554"></a></span>
<span id="cb23-555"><a href="#cb23-555"></a><span class="fu">## Update `Cargo.toml`</span></span>
<span id="cb23-556"><a href="#cb23-556"></a></span>
<span id="cb23-557"><a href="#cb23-557"></a><span class="ss">- </span>Add the following:</span>
<span id="cb23-558"><a href="#cb23-558"></a></span>
<span id="cb23-559"><a href="#cb23-559"></a><span class="in">```{.toml code-line-numbers="8-12" filename="Cargo.toml"}</span></span>
<span id="cb23-560"><a href="#cb23-560"></a><span class="in">[package]</span></span>
<span id="cb23-561"><a href="#cb23-561"></a><span class="in">name = "osirs"</span></span>
<span id="cb23-562"><a href="#cb23-562"></a><span class="in">version = "0.1.0"</span></span>
<span id="cb23-563"><a href="#cb23-563"></a><span class="in">edition = "2024"</span></span>
<span id="cb23-564"><a href="#cb23-564"></a></span>
<span id="cb23-565"><a href="#cb23-565"></a><span class="in">[dependencies]</span></span>
<span id="cb23-566"><a href="#cb23-566"></a></span>
<span id="cb23-567"><a href="#cb23-567"></a><span class="in">[profile.dev]</span></span>
<span id="cb23-568"><a href="#cb23-568"></a><span class="in">panic = "abort"</span></span>
<span id="cb23-569"><a href="#cb23-569"></a></span>
<span id="cb23-570"><a href="#cb23-570"></a><span class="in">[profile.release]</span></span>
<span id="cb23-571"><a href="#cb23-571"></a><span class="in">panic = "abort"</span></span>
<span id="cb23-572"><a href="#cb23-572"></a><span class="in">```</span></span>
<span id="cb23-573"><a href="#cb23-573"></a></span>
<span id="cb23-574"><a href="#cb23-574"></a><span class="fu">## Now...</span></span>
<span id="cb23-575"><a href="#cb23-575"></a></span>
<span id="cb23-576"><a href="#cb23-576"></a><span class="ss">- </span>This sets the panic strategy to <span class="in">`abort`</span> for both the <span class="in">`dev`</span> profile (used for <span class="in">`cargo build`</span>) and the <span class="in">`release`</span> profile (used for <span class="in">`cargo build --release`</span>).</span>
<span id="cb23-577"><a href="#cb23-577"></a></span>
<span id="cb23-578"><a href="#cb23-578"></a><span class="ss">- </span><span class="co">[</span><span class="ot">abort on panic</span><span class="co">](https://github.com/rust-lang/rust/pull/32900)</span></span>
<span id="cb23-579"><a href="#cb23-579"></a><span class="ss">- </span>I bet it will work now.</span>
<span id="cb23-580"><a href="#cb23-580"></a></span>
<span id="cb23-581"><a href="#cb23-581"></a><span class="fu">## Whoops!</span></span>
<span id="cb23-582"><a href="#cb23-582"></a></span>
<span id="cb23-583"><a href="#cb23-583"></a><span class="in">```{.sh}</span></span>
<span id="cb23-584"><a href="#cb23-584"></a><span class="in">$ cargo build</span></span>
<span id="cb23-585"><a href="#cb23-585"></a><span class="in">   Compiling osirs v0.1.0 (/home/user/tmp/32)</span></span>
<span id="cb23-586"><a href="#cb23-586"></a><span class="in">error: using `fn main` requires the standard library</span></span>
<span id="cb23-587"><a href="#cb23-587"></a><span class="in">  |</span></span>
<span id="cb23-588"><a href="#cb23-588"></a><span class="in">  = help: use `#![no_main]` to bypass the Rust generated entrypoint and declare a platform specific entrypoint yourself, usually with `#[no_mangle]`</span></span>
<span id="cb23-589"><a href="#cb23-589"></a></span>
<span id="cb23-590"><a href="#cb23-590"></a><span class="in">error: could not compile `osirs` (bin "osirs") due to 1 previous error</span></span>
<span id="cb23-591"><a href="#cb23-591"></a><span class="in">```</span></span>
<span id="cb23-592"><a href="#cb23-592"></a></span>
<span id="cb23-593"><a href="#cb23-593"></a><span class="ss">- </span>Our program is missing the <span class="in">`start`</span> language item, which defines the entry point.</span>
<span id="cb23-594"><a href="#cb23-594"></a></span>
<span id="cb23-595"><a href="#cb23-595"></a><span class="fu">## The `start` attribute</span></span>
<span id="cb23-596"><a href="#cb23-596"></a></span>
<span id="cb23-597"><a href="#cb23-597"></a><span class="ss">- </span>One might think that the <span class="in">`main`</span> function is the first function called when you run a program. </span>
<span id="cb23-598"><a href="#cb23-598"></a><span class="ss">- </span>However, most languages have a "<span class="co">[</span><span class="ot">runtime system</span><span class="co">](https://en.wikipedia.org/wiki/Runtime_system)</span>"</span>
<span id="cb23-599"><a href="#cb23-599"></a><span class="ss">    - </span>For e.g. Java garbage collection (e.g. in Java)</span>
<span id="cb23-600"><a href="#cb23-600"></a><span class="ss">    - </span>For e.g. Go software threads (goroutines)</span>
<span id="cb23-601"><a href="#cb23-601"></a><span class="ss">- </span>This runtime needs to be called before <span class="in">`main`</span>, since it needs to initialize itself.</span>
<span id="cb23-602"><a href="#cb23-602"></a></span>
<span id="cb23-603"><a href="#cb23-603"></a><span class="fu">## C, again</span></span>
<span id="cb23-604"><a href="#cb23-604"></a></span>
<span id="cb23-605"><a href="#cb23-605"></a><span class="ss">- </span>In a typical Rust binary that links the standard library, execution starts in a C runtime library </span>
<span id="cb23-606"><a href="#cb23-606"></a><span class="ss">    - </span><span class="in">`crt0`</span> for ‚ÄúC runtime zero‚Äù </span>
<span id="cb23-607"><a href="#cb23-607"></a><span class="ss">- </span>This creates a stack and places the arguments in the right hardware registers. </span>
<span id="cb23-608"><a href="#cb23-608"></a><span class="ss">- </span>The C runtime then invokes the entry point of the Rust runtime, which is marked by the <span class="in">`start`</span> language item. </span>
<span id="cb23-609"><a href="#cb23-609"></a></span>
<span id="cb23-610"><a href="#cb23-610"></a><span class="fu">## Back to Rust</span></span>
<span id="cb23-611"><a href="#cb23-611"></a></span>
<span id="cb23-612"><a href="#cb23-612"></a><span class="ss">- </span>Rust only has a very minimal runtime, which takes care of some small things such as setting up stack overflow guards or printing a backtrace on panic. </span>
<span id="cb23-613"><a href="#cb23-613"></a><span class="ss">- </span>The runtime then finally calls the <span class="in">`main`</span> function.</span>
<span id="cb23-614"><a href="#cb23-614"></a></span>
<span id="cb23-615"><a href="#cb23-615"></a><span class="fu">## `crt0` is cheating</span></span>
<span id="cb23-616"><a href="#cb23-616"></a></span>
<span id="cb23-617"><a href="#cb23-617"></a><span class="ss">- </span>Our freestanding executable does not have access to the Rust runtime and <span class="in">`crt0`</span></span>
<span id="cb23-618"><a href="#cb23-618"></a><span class="ss">- </span>We need to define our own entry point. </span>
<span id="cb23-619"><a href="#cb23-619"></a>= Implementing the <span class="in">`start`</span> language item wouldn't help, since it would still require <span class="in">`crt0`</span>. </span>
<span id="cb23-620"><a href="#cb23-620"></a><span class="ss">- </span>Instead, we need to overwrite the <span class="in">`crt0`</span> entry point directly.</span>
<span id="cb23-621"><a href="#cb23-621"></a></span>
<span id="cb23-622"><a href="#cb23-622"></a><span class="fu">### Overwriting</span></span>
<span id="cb23-623"><a href="#cb23-623"></a></span>
<span id="cb23-624"><a href="#cb23-624"></a><span class="ss">- </span>To tell the Rust compiler that we don't want to use the normal entry point chain, we add the <span class="in">`#![no_main]`</span> attribute.</span>
<span id="cb23-625"><a href="#cb23-625"></a></span>
<span id="cb23-626"><a href="#cb23-626"></a><span class="in">```{.rs filename="src/main.rs"}</span></span>
<span id="cb23-627"><a href="#cb23-627"></a><span class="in">// main.rs</span></span>
<span id="cb23-628"><a href="#cb23-628"></a></span>
<span id="cb23-629"><a href="#cb23-629"></a><span class="in">#![no_std]</span></span>
<span id="cb23-630"><a href="#cb23-630"></a><span class="in">#![no_main]</span></span>
<span id="cb23-631"><a href="#cb23-631"></a></span>
<span id="cb23-632"><a href="#cb23-632"></a><span class="in">/// This function is called on panic.</span></span>
<span id="cb23-633"><a href="#cb23-633"></a><span class="in">#[panic_handler]</span></span>
<span id="cb23-634"><a href="#cb23-634"></a><span class="in">fn panic(_info: &amp;core::panic::PanicInfo) -&gt; ! {</span></span>
<span id="cb23-635"><a href="#cb23-635"></a><span class="in">    loop {}</span></span>
<span id="cb23-636"><a href="#cb23-636"></a><span class="in">}</span></span>
<span id="cb23-637"><a href="#cb23-637"></a><span class="in">```</span></span>
<span id="cb23-638"><a href="#cb23-638"></a></span>
<span id="cb23-639"><a href="#cb23-639"></a><span class="fu">## No main in main</span></span>
<span id="cb23-640"><a href="#cb23-640"></a></span>
<span id="cb23-641"><a href="#cb23-641"></a><span class="ss">- </span>At this point we can also remove the <span class="in">`main`</span> function. </span>
<span id="cb23-642"><a href="#cb23-642"></a><span class="ss">- </span>Absent a compatible runtime, <span class="in">`main`</span> is meaningless!</span>
<span id="cb23-643"><a href="#cb23-643"></a><span class="ss">- </span>If you <span class="in">`cargo build`</span> at this point, by the way, you will get some fun errors.</span>
<span id="cb23-644"><a href="#cb23-644"></a></span>
<span id="cb23-645"><a href="#cb23-645"></a><span class="fu">## Start in main</span></span>
<span id="cb23-646"><a href="#cb23-646"></a></span>
<span id="cb23-647"><a href="#cb23-647"></a><span class="ss">- </span>Instead, overwrite the entry point with our own <span class="in">`_start`</span> function:</span>
<span id="cb23-648"><a href="#cb23-648"></a></span>
<span id="cb23-649"><a href="#cb23-649"></a><span class="in">```{.rs filename="src/main.rs"}</span></span>
<span id="cb23-650"><a href="#cb23-650"></a><span class="in">#[unsafe(no_mangle)]</span></span>
<span id="cb23-651"><a href="#cb23-651"></a><span class="in">pub extern "C" fn _start() -&gt; ! {</span></span>
<span id="cb23-652"><a href="#cb23-652"></a><span class="in">    loop {}</span></span>
<span id="cb23-653"><a href="#cb23-653"></a><span class="in">}</span></span>
<span id="cb23-654"><a href="#cb23-654"></a><span class="in">```</span></span>
<span id="cb23-655"><a href="#cb23-655"></a></span>
<span id="cb23-656"><a href="#cb23-656"></a><span class="fu">## Manglin'</span></span>
<span id="cb23-657"><a href="#cb23-657"></a></span>
<span id="cb23-658"><a href="#cb23-658"></a><span class="ss">- </span>By using the <span class="in">`#[unsafe(no_mangle)]`</span> attribute, we disable "name mangling"</span>
<span id="cb23-659"><a href="#cb23-659"></a><span class="ss">    - </span>The function **must** be named <span class="in">`_start`</span>. </span>
<span id="cb23-660"><a href="#cb23-660"></a><span class="ss">- </span>Otherwise, compiler generates unique symbols like <span class="in">`_start_imarandomstr_1234`</span> to avoid namespace collisons.</span>
<span id="cb23-661"><a href="#cb23-661"></a><span class="ss">    - </span>Folks... it's key-value storage.</span>
<span id="cb23-662"><a href="#cb23-662"></a><span class="ss">- </span>The attribute is required for the *linker* in the next step.</span>
<span id="cb23-663"><a href="#cb23-663"></a></span>
<span id="cb23-664"><a href="#cb23-664"></a><span class="fu">## C you again</span></span>
<span id="cb23-665"><a href="#cb23-665"></a></span>
<span id="cb23-666"><a href="#cb23-666"></a><span class="ss">- </span>Mark the function as <span class="in">`extern "C"`</span> to tell the compiler that it should use the "C calling convention"</span>
<span id="cb23-667"><a href="#cb23-667"></a><span class="ss">- </span>The reason for naming the function <span class="in">`_start`</span> is that this is the default entry point name for most systems.</span>
<span id="cb23-668"><a href="#cb23-668"></a></span>
<span id="cb23-669"><a href="#cb23-669"></a><span class="fu">## Read more</span></span>
<span id="cb23-670"><a href="#cb23-670"></a></span>
<span id="cb23-671"><a href="#cb23-671"></a><span class="ss">- </span><span class="co">[</span><span class="ot">name mangling</span><span class="co">](https://en.wikipedia.org/wiki/Name_mangling)</span></span>
<span id="cb23-672"><a href="#cb23-672"></a><span class="ss">- </span><span class="co">[</span><span class="ot">C calling convention</span><span class="co">](https://en.wikipedia.org/wiki/Calling_convention)</span></span>
<span id="cb23-673"><a href="#cb23-673"></a></span>
<span id="cb23-674"><a href="#cb23-674"></a><span class="fu">## Divergence</span></span>
<span id="cb23-675"><a href="#cb23-675"></a></span>
<span id="cb23-676"><a href="#cb23-676"></a><span class="ss">- </span>The <span class="in">`!`</span> return type returns!</span>
<span id="cb23-677"><a href="#cb23-677"></a><span class="ss">- </span>This is required because the entry point is not called by any function, but invoked directly by the operating system or bootloader. </span>
<span id="cb23-678"><a href="#cb23-678"></a><span class="ss">    - </span>It can't return anywhere!</span>
<span id="cb23-679"><a href="#cb23-679"></a>    </span>
<span id="cb23-680"><a href="#cb23-680"></a><span class="fu">## Exit</span></span>
<span id="cb23-681"><a href="#cb23-681"></a></span>
<span id="cb23-682"><a href="#cb23-682"></a><span class="ss">- </span>Before I go out to the clubs I always "X it up" (put X's on my hands) because I'm straight edge.</span>
<span id="cb23-683"><a href="#cb23-683"></a><span class="ss">- </span>Operating systems are similar.</span>
<span id="cb23-684"><a href="#cb23-684"></a><span class="ss">- </span>So instead of returning, the entry point should e.g. invoke the <span class="in">`exit`</span> system call of the operating system.</span>
<span id="cb23-685"><a href="#cb23-685"></a><span class="ss">- </span>For now, we fulfill the requirement by looping endlessly.</span>
<span id="cb23-686"><a href="#cb23-686"></a><span class="ss">- </span><span class="co">[</span><span class="ot">`exit` system call</span><span class="co">]</span>(https://en.wikipedia.org/wiki/Exit_(system_call))</span>
<span id="cb23-687"><a href="#cb23-687"></a></span>
<span id="cb23-688"><a href="#cb23-688"></a><span class="fu">## Now it works!</span></span>
<span id="cb23-689"><a href="#cb23-689"></a></span>
<span id="cb23-690"><a href="#cb23-690"></a><span class="ss">- </span>It doesn't.</span>
<span id="cb23-691"><a href="#cb23-691"></a><span class="in">```{.sh}</span></span>
<span id="cb23-692"><a href="#cb23-692"></a><span class="in">$ cargo build</span></span>
<span id="cb23-693"><a href="#cb23-693"></a><span class="in">   Compiling osirs v0.1.0 (/home/user/tmp/32)</span></span>
<span id="cb23-694"><a href="#cb23-694"></a><span class="in">error: linking with `cc` failed: exit status: 1</span></span>
<span id="cb23-695"><a href="#cb23-695"></a><span class="in">  |</span></span>
<span id="cb23-696"><a href="#cb23-696"></a><span class="in">  = note:  "cc" "-m64" "/tmp/rustcheyGtM/symbols.o" "&lt;1 object files omitted&gt;" "-Wl,--as-needed" "-Wl,-Bstatic" "&lt;sysroot&gt;/lib/rustlib/x86_64-unknown-linux-gnu/lib/{librustc_std_workspace_core-*,libcore-*,libcompiler_builtins-*}.rlib" "-L" "/tmp/rustcheyGtM/raw-dylibs" "-Wl,-Bdynamic" "-Wl,--eh-frame-hdr" "-Wl,-z,noexecstack" "-L" "&lt;sysroot&gt;/lib/rustlib/x86_64-unknown-linux-gnu/lib" "-o" "/home/user/tmp/32/target/debug/deps/osirs-80f8eb3240ba748e" "-Wl,--gc-sections" "-pie" "-Wl,-z,relro,-z,now" "-nodefaultlibs"</span></span>
<span id="cb23-697"><a href="#cb23-697"></a><span class="in">  = note: some arguments are omitted. use `--verbose` to show all linker arguments</span></span>
<span id="cb23-698"><a href="#cb23-698"></a><span class="in">  = note: /usr/bin/ld: /home/user/tmp/32/target/debug/deps/osirs-80f8eb3240ba748e.9chdw59nqscmfe0ef1hrxy2nb.rcgu.o: in function `_start':</span></span>
<span id="cb23-699"><a href="#cb23-699"></a><span class="in">          /home/user/tmp/32/src/main.rs:14: multiple definition of `_start'; /usr/lib/gcc/x86_64-linux-gnu/11/../../../x86_64-linux-gnu/Scrt1.o:(.text+0x0): first defined here</span></span>
<span id="cb23-700"><a href="#cb23-700"></a><span class="in">          /usr/bin/ld: /usr/lib/gcc/x86_64-linux-gnu/11/../../../x86_64-linux-gnu/Scrt1.o: in function `_start':</span></span>
<span id="cb23-701"><a href="#cb23-701"></a><span class="in">          (.text+0x1b): undefined reference to `main'</span></span>
<span id="cb23-702"><a href="#cb23-702"></a><span class="in">          /usr/bin/ld: (.text+0x21): undefined reference to `__libc_start_main'</span></span>
<span id="cb23-703"><a href="#cb23-703"></a><span class="in">          collect2: error: ld returned 1 exit status</span></span>
<span id="cb23-704"><a href="#cb23-704"></a></span>
<span id="cb23-705"><a href="#cb23-705"></a><span class="in">  = note: some `extern` functions couldn't be found; some native libraries may need to be installed or have their path specified</span></span>
<span id="cb23-706"><a href="#cb23-706"></a><span class="in">  = note: use the `-l` flag to specify native libraries to link</span></span>
<span id="cb23-707"><a href="#cb23-707"></a><span class="in">  = note: use the `cargo:rustc-link-lib` directive to specify the native libraries to link with Cargo (see https://doc.rust-lang.org/cargo/reference/build-scripts.html#rustc-link-lib)</span></span>
<span id="cb23-708"><a href="#cb23-708"></a></span>
<span id="cb23-709"><a href="#cb23-709"></a><span class="in">error: could not compile `osirs` (bin "osirs") due to 1 previous error</span></span>
<span id="cb23-710"><a href="#cb23-710"></a><span class="in">```</span></span>
<span id="cb23-711"><a href="#cb23-711"></a></span>
<span id="cb23-712"><a href="#cb23-712"></a><span class="fu">## To be continued</span></span>
<span id="cb23-713"><a href="#cb23-713"></a></span>
<span id="cb23-714"><a href="#cb23-714"></a><span class="ss">- </span>I am 99% sure we run out of time here...</span>
<span id="cb23-715"><a href="#cb23-715"></a><span class="ss">- </span>And will continue with the lab on linker errors!</span>
<span id="cb23-716"><a href="#cb23-716"></a></span>
<span id="cb23-717"><a href="#cb23-717"></a><span class="co">&lt;!--</span></span>
<span id="cb23-718"><a href="#cb23-718"></a></span>
<span id="cb23-719"><a href="#cb23-719"></a><span class="co">## Linker Errors</span></span>
<span id="cb23-720"><a href="#cb23-720"></a></span>
<span id="cb23-721"><a href="#cb23-721"></a><span class="co">- The linker is a program that combines the generated code into an executable. </span></span>
<span id="cb23-722"><a href="#cb23-722"></a><span class="co">- Since the executable format differs between Linux, Windows, and macOS, each system has its own linker that throws a different error. </span></span>
<span id="cb23-723"><a href="#cb23-723"></a><span class="co">- The fundamental cause of the errors is the same: the default configuration of the linker assumes that our program depends on the C runtime, which it does not.</span></span>
<span id="cb23-724"><a href="#cb23-724"></a></span>
<span id="cb23-725"><a href="#cb23-725"></a><span class="co">## Solution</span></span>
<span id="cb23-726"><a href="#cb23-726"></a></span>
<span id="cb23-727"><a href="#cb23-727"></a><span class="co">- To solve the errors, we need to tell the linker that it should not include the C runtime. </span></span>
<span id="cb23-728"><a href="#cb23-728"></a><span class="co">- We can do this either by passing a certain set of arguments to the linker or by building for a bare metal target.</span></span>
<span id="cb23-729"><a href="#cb23-729"></a></span>
<span id="cb23-730"><a href="#cb23-730"></a><span class="al">###</span><span class="co"> Building for a Bare Metal Target</span></span>
<span id="cb23-731"><a href="#cb23-731"></a></span>
<span id="cb23-732"><a href="#cb23-732"></a><span class="co">By default Rust tries to build an executable that is able to run in your current system environment. For example, if you're using Windows on `x86_64`, Rust tries to build an `.exe` Windows executable that uses `x86_64` instructions. This environment is called your "host" system.</span></span>
<span id="cb23-733"><a href="#cb23-733"></a></span>
<span id="cb23-734"><a href="#cb23-734"></a><span class="co">To describe different environments, Rust uses a string called [_target triple_]. You can see the target triple for your host system by running `rustc --version --verbose`:</span></span>
<span id="cb23-735"><a href="#cb23-735"></a></span>
<span id="cb23-736"><a href="#cb23-736"></a><span class="co">[_target triple_]: https://clang.llvm.org/docs/CrossCompilation.html#target-triple</span></span>
<span id="cb23-737"><a href="#cb23-737"></a></span>
<span id="cb23-738"><a href="#cb23-738"></a><span class="co">```</span></span>
<span id="cb23-739"><a href="#cb23-739"></a><span class="co">rustc 1.35.0-nightly (474e7a648 2019-04-07)</span></span>
<span id="cb23-740"><a href="#cb23-740"></a><span class="co">binary: rustc</span></span>
<span id="cb23-741"><a href="#cb23-741"></a><span class="co">commit-hash: 474e7a6486758ea6fc761893b1a49cd9076fb0ab</span></span>
<span id="cb23-742"><a href="#cb23-742"></a><span class="co">commit-date: 2019-04-07</span></span>
<span id="cb23-743"><a href="#cb23-743"></a><span class="co">host: x86_64-unknown-linux-gnu</span></span>
<span id="cb23-744"><a href="#cb23-744"></a><span class="co">release: 1.35.0-nightly</span></span>
<span id="cb23-745"><a href="#cb23-745"></a><span class="co">LLVM version: 8.0</span></span>
<span id="cb23-746"><a href="#cb23-746"></a><span class="co">```</span></span>
<span id="cb23-747"><a href="#cb23-747"></a></span>
<span id="cb23-748"><a href="#cb23-748"></a><span class="co">The above output is from a `x86_64` Linux system. We see that the `host` triple is `x86_64-unknown-linux-gnu`, which includes the CPU architecture (`x86_64`), the vendor (`unknown`), the operating system (`linux`), and the [ABI] (`gnu`).</span></span>
<span id="cb23-749"><a href="#cb23-749"></a></span>
<span id="cb23-750"><a href="#cb23-750"></a><span class="co">[ABI]: https://en.wikipedia.org/wiki/Application_binary_interface</span></span>
<span id="cb23-751"><a href="#cb23-751"></a></span>
<span id="cb23-752"><a href="#cb23-752"></a><span class="co">By compiling for our host triple, the Rust compiler and the linker assume that there is an underlying operating system such as Linux or Windows that uses the C runtime by default, which causes the linker errors. So, to avoid the linker errors, we can compile for a different environment with no underlying operating system.</span></span>
<span id="cb23-753"><a href="#cb23-753"></a></span>
<span id="cb23-754"><a href="#cb23-754"></a><span class="co">An example of such a bare metal environment is the `thumbv7em-none-eabihf` target triple, which describes an [embedded] [ARM] system. The details are not important, all that matters is that the target triple has no underlying operating system, which is indicated by the `none` in the target triple. To be able to compile for this target, we need to add it in rustup:</span></span>
<span id="cb23-755"><a href="#cb23-755"></a></span>
<span id="cb23-756"><a href="#cb23-756"></a><span class="co">[embedded]: https://en.wikipedia.org/wiki/Embedded_system</span></span>
<span id="cb23-757"><a href="#cb23-757"></a><span class="co">[ARM]: https://en.wikipedia.org/wiki/ARM_architecture</span></span>
<span id="cb23-758"><a href="#cb23-758"></a></span>
<span id="cb23-759"><a href="#cb23-759"></a><span class="co">```</span></span>
<span id="cb23-760"><a href="#cb23-760"></a><span class="co">rustup target add thumbv7em-none-eabihf</span></span>
<span id="cb23-761"><a href="#cb23-761"></a><span class="co">```</span></span>
<span id="cb23-762"><a href="#cb23-762"></a></span>
<span id="cb23-763"><a href="#cb23-763"></a><span class="co">This downloads a copy of the standard (and core) library for the system. Now we can build our freestanding executable for this target:</span></span>
<span id="cb23-764"><a href="#cb23-764"></a></span>
<span id="cb23-765"><a href="#cb23-765"></a><span class="co">```</span></span>
<span id="cb23-766"><a href="#cb23-766"></a><span class="co">cargo build --target thumbv7em-none-eabihf</span></span>
<span id="cb23-767"><a href="#cb23-767"></a><span class="co">```</span></span>
<span id="cb23-768"><a href="#cb23-768"></a></span>
<span id="cb23-769"><a href="#cb23-769"></a><span class="co">By passing a `--target` argument we [cross compile] our executable for a bare metal target system. Since the target system has no operating system, the linker does not try to link the C runtime and our build succeeds without any linker errors.</span></span>
<span id="cb23-770"><a href="#cb23-770"></a></span>
<span id="cb23-771"><a href="#cb23-771"></a><span class="co">[cross compile]: https://en.wikipedia.org/wiki/Cross_compiler</span></span>
<span id="cb23-772"><a href="#cb23-772"></a></span>
<span id="cb23-773"><a href="#cb23-773"></a><span class="co">This is the approach that we will use for building our OS kernel. Instead of `thumbv7em-none-eabihf`, we will use a [custom target] that describes a `x86_64` bare metal environment. The details will be explained in the next post.</span></span>
<span id="cb23-774"><a href="#cb23-774"></a></span>
<span id="cb23-775"><a href="#cb23-775"></a><span class="co">[custom target]: https://doc.rust-lang.org/rustc/targets/custom.html</span></span>
<span id="cb23-776"><a href="#cb23-776"></a></span>
<span id="cb23-777"><a href="#cb23-777"></a><span class="al">###</span><span class="co"> Linker Arguments</span></span>
<span id="cb23-778"><a href="#cb23-778"></a></span>
<span id="cb23-779"><a href="#cb23-779"></a><span class="co">Instead of compiling for a bare metal system, it is also possible to resolve the linker errors by passing a certain set of arguments to the linker. This will be the subject of the lab this week.</span></span>
<span id="cb23-780"><a href="#cb23-780"></a></span>
<span id="cb23-781"><a href="#cb23-781"></a></span>
<span id="cb23-782"><a href="#cb23-782"></a><span class="co">## Summary</span></span>
<span id="cb23-783"><a href="#cb23-783"></a></span>
<span id="cb23-784"><a href="#cb23-784"></a><span class="co">A minimal freestanding Rust binary looks like this:</span></span>
<span id="cb23-785"><a href="#cb23-785"></a></span>
<span id="cb23-786"><a href="#cb23-786"></a><span class="co">`src/main.rs`:</span></span>
<span id="cb23-787"><a href="#cb23-787"></a></span>
<span id="cb23-788"><a href="#cb23-788"></a><span class="co">```rust</span></span>
<span id="cb23-789"><a href="#cb23-789"></a><span class="co">#![no_std] // don't link the Rust standard library</span></span>
<span id="cb23-790"><a href="#cb23-790"></a><span class="co">#![no_main] // disable all Rust-level entry points</span></span>
<span id="cb23-791"><a href="#cb23-791"></a></span>
<span id="cb23-792"><a href="#cb23-792"></a><span class="co">#[unsafe(no_mangle)] // don't mangle the name of this function</span></span>
<span id="cb23-793"><a href="#cb23-793"></a><span class="co">pub extern "C" fn _start() -&gt; ! {</span></span>
<span id="cb23-794"><a href="#cb23-794"></a><span class="co">    // this function is the entry point, since the linker looks for a function</span></span>
<span id="cb23-795"><a href="#cb23-795"></a><span class="co">    // named `_start` by default</span></span>
<span id="cb23-796"><a href="#cb23-796"></a><span class="co">    loop {}</span></span>
<span id="cb23-797"><a href="#cb23-797"></a><span class="co">}</span></span>
<span id="cb23-798"><a href="#cb23-798"></a></span>
<span id="cb23-799"><a href="#cb23-799"></a><span class="co">/// This function is called on panic.</span></span>
<span id="cb23-800"><a href="#cb23-800"></a><span class="co">#[panic_handler]</span></span>
<span id="cb23-801"><a href="#cb23-801"></a><span class="co">fn panic(_info: &amp;core::panic::PanicInfo) -&gt; ! {</span></span>
<span id="cb23-802"><a href="#cb23-802"></a><span class="co">    loop {}</span></span>
<span id="cb23-803"><a href="#cb23-803"></a><span class="co">}</span></span>
<span id="cb23-804"><a href="#cb23-804"></a><span class="co">```</span></span>
<span id="cb23-805"><a href="#cb23-805"></a></span>
<span id="cb23-806"><a href="#cb23-806"></a><span class="co">`Cargo.toml`:</span></span>
<span id="cb23-807"><a href="#cb23-807"></a></span>
<span id="cb23-808"><a href="#cb23-808"></a><span class="co">```toml</span></span>
<span id="cb23-809"><a href="#cb23-809"></a><span class="co">[package]</span></span>
<span id="cb23-810"><a href="#cb23-810"></a><span class="co">name = "crate_name"</span></span>
<span id="cb23-811"><a href="#cb23-811"></a><span class="co">version = "0.1.0"</span></span>
<span id="cb23-812"><a href="#cb23-812"></a><span class="co">authors = ["Author Name &lt;author@example.com&gt;"]</span></span>
<span id="cb23-813"><a href="#cb23-813"></a></span>
<span id="cb23-814"><a href="#cb23-814"></a><span class="co"># the profile used for `cargo build`</span></span>
<span id="cb23-815"><a href="#cb23-815"></a><span class="co">[profile.dev]</span></span>
<span id="cb23-816"><a href="#cb23-816"></a><span class="co">panic = "abort" # disable stack unwinding on panic</span></span>
<span id="cb23-817"><a href="#cb23-817"></a></span>
<span id="cb23-818"><a href="#cb23-818"></a><span class="co"># the profile used for `cargo build --release`</span></span>
<span id="cb23-819"><a href="#cb23-819"></a><span class="co">[profile.release]</span></span>
<span id="cb23-820"><a href="#cb23-820"></a><span class="co">panic = "abort" # disable stack unwinding on panic</span></span>
<span id="cb23-821"><a href="#cb23-821"></a><span class="co">```</span></span>
<span id="cb23-822"><a href="#cb23-822"></a></span>
<span id="cb23-823"><a href="#cb23-823"></a><span class="co">To build this binary, we need to compile for a bare metal target such as `thumbv7em-none-eabihf`:</span></span>
<span id="cb23-824"><a href="#cb23-824"></a></span>
<span id="cb23-825"><a href="#cb23-825"></a><span class="co">```</span></span>
<span id="cb23-826"><a href="#cb23-826"></a><span class="co">cargo build --target thumbv7em-none-eabihf</span></span>
<span id="cb23-827"><a href="#cb23-827"></a><span class="co">```</span></span>
<span id="cb23-828"><a href="#cb23-828"></a></span>
<span id="cb23-829"><a href="#cb23-829"></a><span class="co">Alternatively, we can compile it for the host system by passing additional linker arguments:</span></span>
<span id="cb23-830"><a href="#cb23-830"></a></span>
<span id="cb23-831"><a href="#cb23-831"></a><span class="co">```bash</span></span>
<span id="cb23-832"><a href="#cb23-832"></a><span class="co"># Linux</span></span>
<span id="cb23-833"><a href="#cb23-833"></a><span class="co">cargo rustc -- -C link-arg=-nostartfiles</span></span>
<span id="cb23-834"><a href="#cb23-834"></a><span class="co"># Windows</span></span>
<span id="cb23-835"><a href="#cb23-835"></a><span class="co">cargo rustc -- -C link-args="/ENTRY:_start /SUBSYSTEM:console"</span></span>
<span id="cb23-836"><a href="#cb23-836"></a><span class="co"># macOS</span></span>
<span id="cb23-837"><a href="#cb23-837"></a><span class="co">cargo rustc -- -C link-args="-e __start -static -nostartfiles"</span></span>
<span id="cb23-838"><a href="#cb23-838"></a><span class="co">```</span></span>
<span id="cb23-839"><a href="#cb23-839"></a></span>
<span id="cb23-840"><a href="#cb23-840"></a><span class="co">Note that this is just a minimal example of a freestanding Rust binary. This binary expects various things, for example, that a stack is initialized when the `_start` function is called. **So for any real use of such a binary, more steps are required**.</span></span>
<span id="cb23-841"><a href="#cb23-841"></a></span>
<span id="cb23-842"><a href="#cb23-842"></a><span class="co">## Making `rust-analyzer` happy</span></span>
<span id="cb23-843"><a href="#cb23-843"></a></span>
<span id="cb23-844"><a href="#cb23-844"></a><span class="co">The [`rust-analyzer`](https://rust-analyzer.github.io/) project is a great way to get code completion and "go to definition" support (and many other features) for Rust code in your editor.</span></span>
<span id="cb23-845"><a href="#cb23-845"></a><span class="co">It works really well for `#![no_std]` projects too, so I recommend using it for kernel development!</span></span>
<span id="cb23-846"><a href="#cb23-846"></a></span>
<span id="cb23-847"><a href="#cb23-847"></a><span class="co">If you're using the [`checkOnSave`](https://rust-analyzer.github.io/book/configuration.html#checkOnSave) feature of `rust-analyzer` (enabled by default), it might report an error for the panic function of our kernel:</span></span>
<span id="cb23-848"><a href="#cb23-848"></a></span>
<span id="cb23-849"><a href="#cb23-849"></a><span class="co">```</span></span>
<span id="cb23-850"><a href="#cb23-850"></a><span class="co">found duplicate lang item `panic_impl`</span></span>
<span id="cb23-851"><a href="#cb23-851"></a><span class="co">```</span></span>
<span id="cb23-852"><a href="#cb23-852"></a></span>
<span id="cb23-853"><a href="#cb23-853"></a><span class="co">The reason for this error is that `rust-analyzer` invokes `cargo check --all-targets` by default, which also tries to build the binary in [test](https://doc.rust-lang.org/book/ch11-01-writing-tests.html) and [benchmark](https://doc.rust-lang.org/rustc/tests/index.html#benchmarks) mode.</span></span>
<span id="cb23-854"><a href="#cb23-854"></a></span>
<span id="cb23-855"><a href="#cb23-855"></a><span class="co">&lt;div class="note"&gt;</span></span>
<span id="cb23-856"><a href="#cb23-856"></a></span>
<span id="cb23-857"><a href="#cb23-857"></a><span class="al">###</span><span class="co"> The two meanings of "target"</span></span>
<span id="cb23-858"><a href="#cb23-858"></a></span>
<span id="cb23-859"><a href="#cb23-859"></a><span class="co">The `--all-targets` flag is completely unrelated to the `--target` argument.</span></span>
<span id="cb23-860"><a href="#cb23-860"></a><span class="co">There are two different meanings of the term "target" in `cargo`:</span></span>
<span id="cb23-861"><a href="#cb23-861"></a></span>
<span id="cb23-862"><a href="#cb23-862"></a><span class="co">- The `--target` flag specifies the **[_compilation target_]** that should be passed to the `rustc` compiler. This should be set to the [target triple] of the machine that should run our code.</span></span>
<span id="cb23-863"><a href="#cb23-863"></a><span class="co">- The `--all-targets` flag references the **[_package target_]** of Cargo. Cargo packages can be a library and binary at the same time, so you can specify in which way you like to build your crate. In addition, Cargo also has package targets for [examples](https://doc.rust-lang.org/cargo/reference/cargo-targets.html#examples), [tests](https://doc.rust-lang.org/cargo/reference/cargo-targets.html#tests), and [benchmarks](https://doc.rust-lang.org/cargo/reference/cargo-targets.html#benchmarks). These package targets can co-exist, so you can build/check the same crate in e.g. library or test mode.</span></span>
<span id="cb23-864"><a href="#cb23-864"></a></span>
<span id="cb23-865"><a href="#cb23-865"></a><span class="co">[_compilation target_]: https://doc.rust-lang.org/rustc/targets/index.html</span></span>
<span id="cb23-866"><a href="#cb23-866"></a><span class="co">[target triple]: https://clang.llvm.org/docs/CrossCompilation.html#target-triple</span></span>
<span id="cb23-867"><a href="#cb23-867"></a><span class="co">[_package target_]: https://doc.rust-lang.org/cargo/reference/cargo-targets.html</span></span>
<span id="cb23-868"><a href="#cb23-868"></a></span>
<span id="cb23-869"><a href="#cb23-869"></a><span class="co">&lt;/div&gt;</span></span>
<span id="cb23-870"><a href="#cb23-870"></a></span>
<span id="cb23-871"><a href="#cb23-871"></a><span class="co">By default, `cargo check` only builds the _library_ and _binary_ package targets.</span></span>
<span id="cb23-872"><a href="#cb23-872"></a><span class="co">However, `rust-analyzer` chooses to check all package targets by default when [`checkOnSave`](https://rust-analyzer.github.io/book/configuration.html#checkOnSave) is enabled.</span></span>
<span id="cb23-873"><a href="#cb23-873"></a><span class="co">This is the reason that `rust-analyzer` reports the above `lang item` error that we don't see in `cargo check`.</span></span>
<span id="cb23-874"><a href="#cb23-874"></a><span class="co">If we run `cargo check --all-targets`, we see the error too:</span></span>
<span id="cb23-875"><a href="#cb23-875"></a></span>
<span id="cb23-876"><a href="#cb23-876"></a><span class="co">```</span></span>
<span id="cb23-877"><a href="#cb23-877"></a><span class="co">error[E0152]: found duplicate lang item `panic_impl`</span></span>
<span id="cb23-878"><a href="#cb23-878"></a><span class="co">  --&gt;</span> src/main.rs:13:1</span>
<span id="cb23-879"><a href="#cb23-879"></a>   |</span>
<span id="cb23-880"><a href="#cb23-880"></a>13 | / fn panic(_info: &amp;PanicInfo) -&gt; ! {</span>
<span id="cb23-881"><a href="#cb23-881"></a>14 | |     loop {}</span>
<span id="cb23-882"><a href="#cb23-882"></a>15 | | }</span>
<span id="cb23-883"><a href="#cb23-883"></a>   | |_^</span>
<span id="cb23-884"><a href="#cb23-884"></a>   |</span>
<span id="cb23-885"><a href="#cb23-885"></a>   = note: the lang item is first defined in crate <span class="in">`std`</span> (which <span class="in">`test`</span> depends on)</span>
<span id="cb23-886"><a href="#cb23-886"></a>   = note: first definition in <span class="in">`std`</span> loaded from /home/<span class="co">[</span><span class="ot">...</span><span class="co">]</span>/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib/libstd-8df6be531efb3fd0.rlib</span>
<span id="cb23-887"><a href="#cb23-887"></a>   = note: second definition in the local crate (<span class="in">`blog_os`</span>)</span>
<span id="cb23-888"><a href="#cb23-888"></a><span class="in">```</span></span>
<span id="cb23-889"><a href="#cb23-889"></a></span>
<span id="cb23-890"><a href="#cb23-890"></a><span class="in">The first `note` tells us that the panic language item is already defined in the `std` crate, which is a dependency of the `test` crate.</span></span>
<span id="cb23-891"><a href="#cb23-891"></a><span class="in">The `test` crate is automatically included when building a crate in [test mode](https://doc.rust-lang.org/cargo/reference/cargo-targets.html#tests).</span></span>
<span id="cb23-892"><a href="#cb23-892"></a><span class="in">This does not make sense for our `#![no_std]` kernel as there is no way to support the standard library on bare metal.</span></span>
<span id="cb23-893"><a href="#cb23-893"></a><span class="in">So this error is not relevant to our project and we can safely ignore it.</span></span>
<span id="cb23-894"><a href="#cb23-894"></a></span>
<span id="cb23-895"><a href="#cb23-895"></a><span class="in">The proper way to avoid this error is to specify in our `Cargo.toml` that our binary does not support building in `test` and `bench` modes.</span></span>
<span id="cb23-896"><a href="#cb23-896"></a><span class="in">We can do that by adding a `[[bin]]` section to our `Cargo.toml` to [configure the build](https://doc.rust-lang.org/cargo/reference/cargo-targets.html#configuring-a-target) of our binary:</span></span>
<span id="cb23-897"><a href="#cb23-897"></a></span>
<span id="cb23-898"><a href="#cb23-898"></a><span class="in">```toml</span></span>
<span id="cb23-899"><a href="#cb23-899"></a><span class="in"># in Cargo.toml</span></span>
<span id="cb23-900"><a href="#cb23-900"></a></span>
<span id="cb23-901"><a href="#cb23-901"></a><span class="in">[[bin]]</span></span>
<span id="cb23-902"><a href="#cb23-902"></a><span class="in">name = "blog_os"</span></span>
<span id="cb23-903"><a href="#cb23-903"></a><span class="in">test = false</span></span>
<span id="cb23-904"><a href="#cb23-904"></a><span class="in">bench = false</span></span>
<span id="cb23-905"><a href="#cb23-905"></a><span class="in">```</span></span>
<span id="cb23-906"><a href="#cb23-906"></a></span>
<span id="cb23-907"><a href="#cb23-907"></a>The double-brackets around <span class="in">`bin`</span> are not a mistake, this is how the TOML format defines keys that can appear multiple times.</span>
<span id="cb23-908"><a href="#cb23-908"></a>Since a crate can have multiple binaries, the <span class="in">`[[bin]]`</span> section can appear multiple times in the <span class="in">`Cargo.toml`</span> as well.</span>
<span id="cb23-909"><a href="#cb23-909"></a>This is also the reason for the mandatory <span class="in">`name`</span> field, which needs to match the name of the binary (so that <span class="in">`cargo`</span> knows which settings should be applied to which binary).</span>
<span id="cb23-910"><a href="#cb23-910"></a></span>
<span id="cb23-911"><a href="#cb23-911"></a>By setting the <span class="co">[</span><span class="ot">`test`</span><span class="co">](https://doc.rust-lang.org/cargo/reference/cargo-targets.html#the-test-field)</span> and <span class="co">[</span><span class="ot">`bench` </span><span class="co">](https://doc.rust-lang.org/cargo/reference/cargo-targets.html#the-bench-field)</span> fields to <span class="in">`false`</span>, we instruct <span class="in">`cargo`</span> to not build our binary in test or benchmark mode.</span>
<span id="cb23-912"><a href="#cb23-912"></a>Now <span class="in">`cargo check --all-targets`</span> should not throw any errors anymore, and the <span class="in">`checkOnSave`</span> implementation of <span class="in">`rust-analyzer`</span> should be happy too.</span>
<span id="cb23-913"><a href="#cb23-913"></a></span>
<span id="cb23-914"><a href="#cb23-914"></a>--&gt;</span></code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>